<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>优雅的获取动态数据</title>
      <link href="/post/pa-chong/you-ya-de-huo-qu-dong-tai-shu-ju/"/>
      <url>/post/pa-chong/you-ya-de-huo-qu-dong-tai-shu-ju/</url>
      
        <content type="html"><![CDATA[<h1 id="获取动态加载数据的方法"><a href="#获取动态加载数据的方法" class="headerlink" title="获取动态加载数据的方法"></a>获取动态加载数据的方法</h1><p>现在越来越多的网页都已经演变为 SPA 页面，而且越来越多的网站采用了各种 JavaScript 混淆和加密技术，</p><p>这使得 JavaScript 逆向难度变得很大，Ajax 接口模拟爬取也变得越发困难，因此模拟浏览器爬取不失为一个不错的爬取方案。</p><p>Selenium、Pyppeteer、Puppeteer 等可以模拟浏览器来进行爬取，也可以使用 Scrapy + Selenium 和 Pyppeteer 来实现动态爬取。</p><p>Scrapy 2.0+ 中支持了异步 <code>async</code> 的特性，在 Scrapy 中我们已经可以定义异步方法来实现数据爬取和处理了，而 Pyppeteer 同样也是一个支持异步的浏览器渲染库。</p><p>我们本节课就来介绍一下 Scrapy 和 Pyppeteer 的正确对接方式。</p><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><p>本节我们就用实例来讲解一下 Scrapy 和 Pyppeteer 实现 JavaScript 渲染页面抓取的流程。</p><p>本节使用的实例网站为 <a href="https://dynamic5.scrape.center/%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA">https://dynamic5.scrape.center/，这是一个</a> JavaScript 渲染页面，其内容是一本本的图书信息。</p><p>同时这个网站的页面带有分页功能，只需要在 URL 加上 /page/ 和页码就可以跳转到下一页，</p><p>如 <a href="https://dynamic5.scrape.center/page/2">https://dynamic5.scrape.center/page/2</a> 就是第二页内容，<a href="https://dynamic5.scrape.center/page/3">https://dynamic5.scrape.center/page/3</a> 就是第三页内容。</p><p>那我们这个案例就来试着爬取一下前十页的图书信息吧。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>首先我们来新建一个项目，叫做 scrapypyppeteer，命令如下：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">scrapy startproject scrapypyppeteer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>接着进入项目，然后新建一个 Spider，名称为 book，命令如下：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">cd scrapypyppeteerscrapy genspider book dynamic5.scrape.center<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这时候可以发现在项目的 spiders 文件夹下就出现了一个名为 spider.py 的文件，内容如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># spider.py</span><span class="token keyword">import</span> scrapy  <span class="token keyword">class</span> <span class="token class-name">BookSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>    name <span class="token operator">=</span> <span class="token string">'book'</span>    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'dynamic5.scrape.center'</span><span class="token punctuation">]</span>    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'http://dynamic5.scrape.center/'</span><span class="token punctuation">]</span>      <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首先我们构造一下列表页的初始请求，实现一个 start_requests 方法如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># spider.py</span><span class="token keyword">from</span> scrapy <span class="token keyword">import</span> Request<span class="token punctuation">,</span> Spider  <span class="token keyword">class</span> <span class="token class-name">BookSpider</span><span class="token punctuation">(</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>    name <span class="token operator">=</span> <span class="token string">'book'</span>    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'dynamic5.scrape.center'</span><span class="token punctuation">]</span>      base_url <span class="token operator">=</span> <span class="token string">'https://dynamic5.scrape.center/page/&#123;page&#125;'</span>    max_page <span class="token operator">=</span> <span class="token number">10</span>      <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> page <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_page <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            url <span class="token operator">=</span> self<span class="token punctuation">.</span>base_url<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>page<span class="token operator">=</span>page<span class="token punctuation">)</span>            <span class="token keyword">yield</span> Request<span class="token punctuation">(</span>url<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse_index<span class="token punctuation">)</span>      <span class="token keyword">def</span> <span class="token function">parse_index</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这时候如果我们直接运行这个 Spider，在 parse_index 方法里面打印输出 Response 的内容，结果如下：</p><p>这时候我们可以发现我们所得到的内容并不是页面渲染后的真正 HTML 代码。</p><p>此时如果我们想要获取 HTML 渲染结果的话就得使用 Downloader Middleware 来实现了。</p><p>这里我们直接拿一个我已经写好的组件来演示了，组件的名称叫做 GerapyPyppeteer，这里面已经写好了 Scrapy 和 Pyppeteer 结合的中间件，下面我们来介绍下。</p><p>我们可以借助于 pip3 来安装，命令如下：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">pip3 install gerapy-pyppeteer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>GerapyPyppeteer 提供了两部分内容，一部分是 Downloader Middleware，一部分是 Request。</p><p>首先我们需要开启中间件，在 settings 里面开启 PyppeteerMiddleware，配置如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">DOWNLOADER_MIDDLEWARES <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'gerapy_pyppeteer.downloadermiddlewares.PyppeteerMiddleware'</span><span class="token punctuation">:</span> <span class="token number">543</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后我们把上文定义的 Request 修改为 PyppeteerRequest 即可：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> gerapy_pyppeteer <span class="token keyword">import</span> PyppeteerRequest<span class="token keyword">from</span> scrapy <span class="token keyword">import</span> Request<span class="token punctuation">,</span> Spider  <span class="token keyword">class</span> <span class="token class-name">BookSpider</span><span class="token punctuation">(</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>    name <span class="token operator">=</span> <span class="token string">'book'</span>    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'dynamic5.scrape.center'</span><span class="token punctuation">]</span>      base_url <span class="token operator">=</span> <span class="token string">'https://dynamic5.scrape.center/page/&#123;page&#125;'</span>    max_page <span class="token operator">=</span> <span class="token number">10</span>      <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> page <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_page <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            url <span class="token operator">=</span> self<span class="token punctuation">.</span>base_url<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>page<span class="token operator">=</span>page<span class="token punctuation">)</span>            <span class="token keyword">yield</span> PyppeteerRequest<span class="token punctuation">(</span>url<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse_index<span class="token punctuation">,</span> wait_for<span class="token operator">=</span><span class="token string">'.item .name'</span><span class="token punctuation">)</span>      <span class="token keyword">def</span> <span class="token function">parse_index</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样其实就完成了 Pyppeteer 的对接了，非常简单。</p><p>这里 PyppeteerRequest 和原本的 Request 多提供了一个参数，就是 wait_for，通过这个参数我们可以指定 Pyppeteer 需要等待特定的内容加载出来才算结束，然后才返回对应的结果。</p><p>为了方便观察效果，我们把并发限制修改得小一点，然后把 Pyppeteer 的 Headless 模式设置为 False：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">CONCURRENT_REQUESTS <span class="token operator">=</span> <span class="token number">3</span>GERAPY_PYPPETEER_HEADLESS <span class="token operator">=</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这时候我们重新运行下 Spider，这时候我们就可以看到在爬取的过程中，Pyppeteer 对应的 Chromium 浏览器就弹出来了，并逐个加载对应的页面内容，加载完成之后浏览器关闭。</p><p>另外观察下控制台，我们发现对应的结果也就被提取出来了，如图所示：</p><p>这时候我们再重新修改下 parse_index 方法，提取对应的每本书的名称和作者即可：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_index</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> item <span class="token keyword">in</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">'.item'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        name <span class="token operator">=</span> item<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">'.name::text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>        authors <span class="token operator">=</span> item<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">'.authors::text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>        name <span class="token operator">=</span> name<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> name <span class="token keyword">else</span> <span class="token boolean">None</span>        authors <span class="token operator">=</span> authors<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> authors <span class="token keyword">else</span> <span class="token boolean">None</span>        <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>            <span class="token string">'name'</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span>            <span class="token string">'authors'</span><span class="token punctuation">:</span> authors        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重新运行，即可发现对应的名称和作者就被提取出来了，运行结果如下：</p><p>这样我们就借助于 GerapyPyppeteer 完成了 JavaScript 渲染页面的爬取。</p><h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p>但上面仅仅是我们借助于 GerapyPyppeteer 实现了 Scrapy 和 Pyppeteer 的对接，但其背后的原理是怎样的呢？</p><p>我们可以分析下它的源码来看一下。</p><p>其 GitHub 地址为 <a href="https://github.com/Gerapy/GerapyPyppeteer%EF%BC%8C%E6%88%91%E4%BB%AC%E4%B8%8B%E8%BD%BD%E4%B8%8B%E6%9D%A5%E7%9C%8B%E4%B8%8B%E3%80%82">https://github.com/Gerapy/GerapyPyppeteer，我们下载下来看下。</a></p><p>首先分析发现其最核心的内容就是实现了一个 PyppeteerMiddleware，这是一个 Downloader Middleware，这里最主要的就是 process_request 的实现，核心代码如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'processing request %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span>      <span class="token keyword">return</span> as_deferred<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_process_request<span class="token punctuation">(</span>request<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这里其实就是调用了一个 _process_request 方法，这个方法的返回结果被 as_deferred 方法调用了。</p><p>这个 as_deferred 是怎么定义的呢？代码如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> twisted<span class="token punctuation">.</span>internet<span class="token punctuation">.</span>defer <span class="token keyword">import</span> Deferred  <span class="token keyword">def</span> <span class="token function">as_deferred</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> Deferred<span class="token punctuation">.</span>fromFuture<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个方法接受的就是一个 asyncio 库的 Future 对象，然后通过 fromFuture 方法转化成了 twisted 里面的 Deferred 对象。这个的原因是 Scrapy 本身的异步是借助于 twisted 的实现的，一个个的异步任务对应的对象就是 Deferred 对象，而 Pyppeteer 又是基于 asyncio 的，它的异步任务是 Future 对象，所以这里我们需要借助 Deferred 的 fromFuture 方法将 Future 转为 Deferred 对象。</p><p>另外为了支持这个功能，我们还需要在 Scrapy 中修改 reactor 对象，修改为 AsyncioSelectorReactor，实现如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> sys<span class="token keyword">from</span> twisted<span class="token punctuation">.</span>internet<span class="token punctuation">.</span>asyncioreactor <span class="token keyword">import</span> AsyncioSelectorReactor<span class="token keyword">import</span> twisted<span class="token punctuation">.</span>internet  reactor <span class="token operator">=</span> AsyncioSelectorReactor<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># install AsyncioSelectorReactor</span>twisted<span class="token punctuation">.</span>internet<span class="token punctuation">.</span>reactor <span class="token operator">=</span> reactorsys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'twisted.internet.reactor'</span><span class="token punctuation">]</span> <span class="token operator">=</span> reactor<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这段代码已经在 PyppeteerMiddleware 里面定义好了，在 Scrapy 正式开始爬取之前这段代码就会被执行，将 Scrapy 中的的 reactor 修改为 AsyncioSelectorReactor，从而实现 Future 的调度。</p><p>接下来我们再来看下 _process_request 方法，实现如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> PyppeteerRequest<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    use pyppeteer to process spider    :param request:    :param spider:    :return:    """</span>    options <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">'headless'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>headless<span class="token punctuation">,</span>        <span class="token string">'dumpio'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>dumpio<span class="token punctuation">,</span>        <span class="token string">'devtools'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>devtools<span class="token punctuation">,</span>        <span class="token string">'args'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token string-interpolation"><span class="token string">f'--window-size=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>window_width<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>window_height<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>executable_path<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'executable_path'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>executable_path    <span class="token keyword">if</span> self<span class="token punctuation">.</span>disable_extensions<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--disable-extensions'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>hide_scrollbars<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--hide-scrollbars'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>mute_audio<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--mute-audio'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>no_sandbox<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>disable_setuid_sandbox<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--disable-setuid-sandbox'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>disable_gpu<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--disable-gpu'</span><span class="token punctuation">)</span>      <span class="token comment"># set proxy</span>    proxy <span class="token operator">=</span> request<span class="token punctuation">.</span>proxy    <span class="token keyword">if</span> <span class="token keyword">not</span> proxy<span class="token punctuation">:</span>        proxy <span class="token operator">=</span> request<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'proxy'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> proxy<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'--proxy-server=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>proxy<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>      logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'set options %s'</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>      browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span>options<span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setViewport<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'width'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>window_width<span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>window_height<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>      <span class="token comment"># set cookies</span>    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span>setCookie<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> k<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">:</span> v<span class="token punctuation">&#125;</span>            <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span>setCookie<span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span>      <span class="token comment"># the headers must be set using request interception</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setRequestInterception<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>      <span class="token decorator annotation punctuation">@page<span class="token punctuation">.</span>on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">)</span>    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_handle_interception</span><span class="token punctuation">(</span>pu_request<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># handle headers</span>        overrides <span class="token operator">=</span> <span class="token punctuation">&#123;</span>            <span class="token string">'headers'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>                k<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> v<span class="token punctuation">:</span> v<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment"># handle resource types</span>        _ignore_resource_types <span class="token operator">=</span> self<span class="token punctuation">.</span>ignore_resource_types        <span class="token keyword">if</span> request<span class="token punctuation">.</span>ignore_resource_types <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            _ignore_resource_types <span class="token operator">=</span> request<span class="token punctuation">.</span>ignore_resource_types        <span class="token keyword">if</span> pu_request<span class="token punctuation">.</span>resourceType <span class="token keyword">in</span> _ignore_resource_types<span class="token punctuation">:</span>            <span class="token keyword">await</span> pu_request<span class="token punctuation">.</span>abort<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">await</span> pu_request<span class="token punctuation">.</span>continue_<span class="token punctuation">(</span>overrides<span class="token punctuation">)</span>      timeout <span class="token operator">=</span> self<span class="token punctuation">.</span>download_timeout    <span class="token keyword">if</span> request<span class="token punctuation">.</span>timeout <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        timeout <span class="token operator">=</span> request<span class="token punctuation">.</span>timeout      logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'crawling %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>      response <span class="token operator">=</span> <span class="token boolean">None</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        options <span class="token operator">=</span> <span class="token punctuation">&#123;</span>            <span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">1000</span> <span class="token operator">*</span> timeout<span class="token punctuation">,</span>            <span class="token string">'waitUntil'</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>wait_until        <span class="token punctuation">&#125;</span>        logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'request %s with options %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span>        response <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>            request<span class="token punctuation">.</span>url<span class="token punctuation">,</span>            options<span class="token operator">=</span>options        <span class="token punctuation">)</span>    <span class="token keyword">except</span> <span class="token punctuation">(</span>PageError<span class="token punctuation">,</span> TimeoutError<span class="token punctuation">)</span><span class="token punctuation">:</span>        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'error rendering url %s using pyppeteer'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_retry<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">504</span><span class="token punctuation">,</span> spider<span class="token punctuation">)</span>      <span class="token keyword">if</span> request<span class="token punctuation">.</span>wait_for<span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'waiting for %s finished'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>wait_for<span class="token punctuation">)</span>            <span class="token keyword">await</span> page<span class="token punctuation">.</span>waitFor<span class="token punctuation">(</span>request<span class="token punctuation">.</span>wait_for<span class="token punctuation">)</span>        <span class="token keyword">except</span> TimeoutError<span class="token punctuation">:</span>            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'error waiting for %s of %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>wait_for<span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>            <span class="token keyword">await</span> page<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_retry<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">504</span><span class="token punctuation">,</span> spider<span class="token punctuation">)</span>      <span class="token comment"># evaluate script</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>script<span class="token punctuation">:</span>        logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'evaluating %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>script<span class="token punctuation">)</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>request<span class="token punctuation">.</span>script<span class="token punctuation">)</span>      <span class="token comment"># sleep</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>sleep <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'sleep for %ss'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>sleep<span class="token punctuation">)</span>        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>request<span class="token punctuation">.</span>sleep<span class="token punctuation">)</span>      content <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span>content<span class="token punctuation">(</span><span class="token punctuation">)</span>    body <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>content<span class="token punctuation">)</span>      <span class="token comment"># close page and browser</span>    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'close pyppeteer'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token keyword">not</span> response<span class="token punctuation">:</span>        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'get null response by pyppeteer of url %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>      <span class="token comment"># Necessary to bypass the compression middleware (?)</span>    response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'content-encoding'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>    response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'Content-Encoding'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> HtmlResponse<span class="token punctuation">(</span>        page<span class="token punctuation">.</span>url<span class="token punctuation">,</span>        status<span class="token operator">=</span>response<span class="token punctuation">.</span>status<span class="token punctuation">,</span>        headers<span class="token operator">=</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">,</span>        body<span class="token operator">=</span>body<span class="token punctuation">,</span>        encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>        request<span class="token operator">=</span>request    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码内容比较多，我们慢慢来说。</p><p>首先最开始的部分是定义 Pyppeteer 的一些启动参数：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">options <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'headless'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>headless<span class="token punctuation">,</span>    <span class="token string">'dumpio'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>dumpio<span class="token punctuation">,</span>    <span class="token string">'devtools'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>devtools<span class="token punctuation">,</span>    <span class="token string">'args'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token string-interpolation"><span class="token string">f'--window-size=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>window_width<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>window_height<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> self<span class="token punctuation">.</span>executable_path<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'executable_path'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>executable_path<span class="token keyword">if</span> self<span class="token punctuation">.</span>disable_extensions<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--disable-extensions'</span><span class="token punctuation">)</span><span class="token keyword">if</span> self<span class="token punctuation">.</span>hide_scrollbars<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--hide-scrollbars'</span><span class="token punctuation">)</span><span class="token keyword">if</span> self<span class="token punctuation">.</span>mute_audio<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--mute-audio'</span><span class="token punctuation">)</span><span class="token keyword">if</span> self<span class="token punctuation">.</span>no_sandbox<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">)</span><span class="token keyword">if</span> self<span class="token punctuation">.</span>disable_setuid_sandbox<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--disable-setuid-sandbox'</span><span class="token punctuation">)</span><span class="token keyword">if</span> self<span class="token punctuation">.</span>disable_gpu<span class="token punctuation">:</span> options<span class="token punctuation">[</span><span class="token string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--disable-gpu'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这些参数来自于 from_crawler 里面读取项目 settings 的内容，如配置 Pyppeteer 对应浏览器的无头模式、窗口大小、是否隐藏滚动条、是否弃用沙箱等等。</p><p>紧接着就是利用 options 来启动 Pyppeteer：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span>options<span class="token punctuation">)</span>page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">await</span> page<span class="token punctuation">.</span>setViewport<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'width'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>window_width<span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>window_height<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这里启动了 Pyppeteer 对应的浏览器，将其赋值为 browser，然后新建了一个选项卡，赋值为 page，然后通过</p><p>setViewport 方法设定了窗口的宽高。</p><p>接下来就是对一些 Cookies 进行处理，如果 Request 带有 Cookies 的话会被赋值到 Pyppeteer 中：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># set cookies</span><span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setCookie<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> k<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">:</span> v<span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setCookie<span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再然后关键的部分就是进行页面的加载了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>    options <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">1000</span> <span class="token operator">*</span> timeout<span class="token punctuation">,</span>        <span class="token string">'waitUntil'</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>wait_until    <span class="token punctuation">&#125;</span>    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'request %s with options %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    response <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>        request<span class="token punctuation">.</span>url<span class="token punctuation">,</span>        options<span class="token operator">=</span>options    <span class="token punctuation">)</span><span class="token keyword">except</span> <span class="token punctuation">(</span>PageError<span class="token punctuation">,</span> TimeoutError<span class="token punctuation">)</span><span class="token punctuation">:</span>    logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'error rendering url %s using pyppeteer'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_retry<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">504</span><span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里我们首先制定了加载超时时间 timeout 还有要等待完成的事件 waitUntil，接着调用 page 的 goto 方法访问对应的页面，同时进行了异常检测，如果发生错误就关闭浏览器并重新发起一次重试请求。</p><p>在页面加载出来之后，我们还需要判定我们期望的结果是不是加载出来了，所以这里又增加了 waitFor 的调用：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> request<span class="token punctuation">.</span>wait_for<span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'waiting for %s finished'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>wait_for<span class="token punctuation">)</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span>waitFor<span class="token punctuation">(</span>request<span class="token punctuation">.</span>wait_for<span class="token punctuation">)</span>    <span class="token keyword">except</span> TimeoutError<span class="token punctuation">:</span>        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'error waiting for %s of %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>wait_for<span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_retry<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">504</span><span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里 request 有个 wait_for 属性，这里就可以定义想要加载的节点的选择器，如 .item .name 等，这样如果页面在规定时间内加载出来就会继续向下执行，否则就会触发 TimeoutError 并被捕获，关闭浏览器并重新发起一次重试请求。</p><p>等想要的结果加载出来之后，我们还可以执行一些自定义的 JavaScript 代码完成我们想要自定义的功能：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># evaluate script</span><span class="token keyword">if</span> request<span class="token punctuation">.</span>script<span class="token punctuation">:</span>    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'evaluating %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>script<span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>request<span class="token punctuation">.</span>script<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>最后关键的一步就是将当前页面的源代码打印出来，然后构造一个 HtmlResponse 返回即可：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> PyppeteerRequest<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    content <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span>content<span class="token punctuation">(</span><span class="token punctuation">)</span>    body <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>content<span class="token punctuation">)</span>              <span class="token comment"># close page and browser</span>    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'close pyppeteer'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token keyword">if</span> <span class="token keyword">not</span> response<span class="token punctuation">:</span>        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'get null response by pyppeteer of url %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>              <span class="token comment"># Necessary to bypass the compression middleware (?)</span>    response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'content-encoding'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>    response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'Content-Encoding'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>              <span class="token keyword">return</span> HtmlResponse<span class="token punctuation">(</span>        page<span class="token punctuation">.</span>url<span class="token punctuation">,</span>        status<span class="token operator">=</span>response<span class="token punctuation">.</span>status<span class="token punctuation">,</span>        headers<span class="token operator">=</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">,</span>        body<span class="token operator">=</span>body<span class="token punctuation">,</span>        encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>        request<span class="token operator">=</span>request    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所以，如果代码可以执行到最后，返回到就是一个 Response 对象，这个 Resposne 对象的 body 就是 Pyppeteer 渲染页面后的结果，因此这个 Response 对象再传给 Spider 解析，就是 JavaScript 渲染后的页面结果了。</p><p>这样我们就通过 Downloader Middleware 通过对接 Pyppeteer 完成了 JavaScript 动态渲染页面的抓取了。</p>]]></content>
      
      
      <categories>
          
          <category> 爬虫 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> scrapy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python实现十大常用排序算法</title>
      <link href="/post/algorithm/python-shi-xian-shi-da-chang-yong-pai-xu-suan-fa/"/>
      <url>/post/algorithm/python-shi-xian-shi-da-chang-yong-pai-xu-suan-fa/</url>
      
        <content type="html"><![CDATA[<h1 id="排序算法基本内容"><a href="#排序算法基本内容" class="headerlink" title="排序算法基本内容"></a>排序算法基本内容</h1><h2 id="算法分类"><a href="#算法分类" class="headerlink" title="算法分类"></a>算法分类</h2><h3 id="比较分类"><a href="#比较分类" class="headerlink" title="比较分类"></a>比较分类</h3><ul><li><p>非线性时间比较类排序：通过比较来决定元素间的相对次序，</p><p>由于其时间复杂度不能突破O(nlogn)，因此称为非线性时间比较类排序。</p></li><li><p>线性时间非比较类排序：不通过比较来决定元素间的相对次序，</p><p>它可以突破基于比较排序的时间下界，以线性时间运行，因此称为线性时间非比较类排序</p></li></ul><p><img src="/markdownImages/sort_category.png" class="lazyload placeholder" data-srcset="/markdownImages/sort_category.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="算法分类分析"></p><h3 id="以是否访问内存分类"><a href="#以是否访问内存分类" class="headerlink" title="以是否访问内存分类"></a>以是否访问内存分类</h3><ul><li><p>内部排序是数据记录在内存中进行排序，</p></li><li><p>而外部排序是因排序的数据很大，一次不能容纳全部的排序记录，在排序过程中需要访问外存。</p></li></ul><p>常见的内部排序算法有：插入排序、希尔排序、选择排序、冒泡排序、归并排序、快速排序、堆排序、基数排序等。</p><h2 id="算法复杂度分析"><a href="#算法复杂度分析" class="headerlink" title="算法复杂度分析"></a>算法复杂度分析</h2><p>主要从：过程图解、算法思想、代码实现、算法分析这四个方面讲解<br><img src="/markdownImages/sort_method_description.png" class="lazyload placeholder" data-srcset="/markdownImages/sort_method_description.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="排序方法分析"></p><h3 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h3><blockquote><p>   n：数据规模<br>   k：“桶”的个数<br>   In-place：占用常数内存，不占用额外内存<br>   Out-place：占用额外内存</p></blockquote><ul><li>稳定：如果a原本在b前面，而a=b，排序之后a仍然在b的前面。</li><li>不稳定：如果a原本在b的前面，而a=b，排序之后 a 可能会出现在 b 的后面。 </li><li>时间复杂度：对排序数据的总的操作次数。反映当n变化时，操作次数呈现什么规律。</li><li>空间复杂度：是指算法在计算机内执行时所需存储空间的度量，它也是数据规模n的函数。 </li></ul><h3 id="关于时间复杂度"><a href="#关于时间复杂度" class="headerlink" title="关于时间复杂度"></a>关于时间复杂度</h3><ul><li>1.平方阶 (O(n2)) 排序 各类简单排序：直接插入、直接选择和冒泡排序。</li><li>2.线性对数阶 (O(nlog2n)) 排序 快速排序、堆排序和归并排序。</li><li>3.O(n1+§)) 排序，§ 是介于 0 和 1 之间的常数。希尔排序。</li><li>4.线性阶 (O(n)) 排序 基数排序，此外还有桶、箱排序。</li></ul><h3 id="关于稳定性"><a href="#关于稳定性" class="headerlink" title="关于稳定性"></a>关于稳定性</h3><ul><li><p>稳定的排序算法：冒泡排序、插入排序、归并排序和基数排序。</p></li><li><p>不是稳定的排序算法：选择排序、快速排序、希尔排序、堆排序。</p></li></ul><h1 id="排序算法分析与实现"><a href="#排序算法分析与实现" class="headerlink" title="排序算法分析与实现"></a>排序算法分析与实现</h1><p>常用的十大排序算法中最简单的五种（冒泡、选择、插入、希尔、归并）</p><h2 id="1-交换排序"><a href="#1-交换排序" class="headerlink" title="1. 交换排序"></a>1. 交换排序</h2><h3 id="1、冒泡排序（Bubble-Sort）【前后比较-交换】"><a href="#1、冒泡排序（Bubble-Sort）【前后比较-交换】" class="headerlink" title="1、冒泡排序（Bubble Sort）【前后比较-交换】"></a>1、冒泡排序（Bubble Sort）【前后比较-交换】</h3><p>冒泡排序是最简单也是最容易理解的排序方法，其原理就是重复地走访过要排序的数列，</p><p>一次比较两个元素，如果他们的顺序错误就把他们交换过来。</p><p>走访数列的工作是重复地进行直到没有再需要交换，也就是说该数列已经排序完成。</p><blockquote><p>这个算法的名字由来是因为越小的元素会经由交换慢慢“浮”到数列的顶端（升序或降序排列），</p><p>就如同碳酸饮料中二氧化碳的气泡最终会上浮到顶端一样，故名<code>冒泡排序</code>。</p></blockquote><h4 id="1-过程图解"><a href="#1-过程图解" class="headerlink" title="1.过程图解"></a>1.过程图解</h4><p><img src="/markdownImages/bubblesort.gif" class="lazyload placeholder" data-srcset="/markdownImages/bubblesort.gif" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="冒泡排序图形展示"></p><h4 id="2-算法思想"><a href="#2-算法思想" class="headerlink" title="2.算法思想"></a>2.算法思想</h4><ul><li>从第一个和第二个开始比较，如果第一个比第二个大，则交换位置，然后比较第二个和第三个，逐渐往后</li><li>经过第一轮后最大的元素已经排在最后，所以重复上述操作的话第二大的则会排在倒数第二的位置。</li><li>那重复上述操作n-1次即可完成排序，因为最后一次只有一个元素所以不需要比较</li></ul><h4 id="3-代码实现"><a href="#3-代码实现" class="headerlink" title="3.代码实现"></a>3.代码实现</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 冒泡排序</span><span class="token keyword">def</span> <span class="token function">bubbleSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""冒泡排序"""</span>    <span class="token comment"># 第一层for表示循环的遍数</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 第二层for表示具体比较哪两个元素</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">></span> arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                <span class="token comment"># 如果前面的大于后面的，则交换这两个元素的位置</span>                arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span>    <span class="token keyword">return</span> arr<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    li <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>bubbleSort<span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-算法分析"><a href="#4-算法分析" class="headerlink" title="4.算法分析"></a>4.算法分析</h4><p>冒泡排序是一种简单直接暴力的排序算法。</p><p>为什么说它暴力？因为每一轮比较可能多个元素移动位置，而元素位置的互换是需要消耗资源的，</p><p>所以这是一种偏慢的排序算法，仅适用于对于含有<code>较少元素</code>的数列进行排序。</p><ul><li>稳定性：我们从代码中可以看出只有前一个元素大于后一个元素才可能交换位置，所以相同元素的相对顺序不可能改变，所以它是<code>稳定排序</code></li><li>比较性：因为排序时元素之间需要比较，所以是<code>比较排序</code></li><li>时间复杂度：因为它需要双层循环n*(n-1))，所以平均时间复杂度为O(n^2)</li><li>空间复杂度：只需要常数个辅助单元，所以空间复杂度为O(1)，我们把空间复杂度为O(1)的排序成为<code>原地排序（in-place）</code></li><li>记忆方法：想象成气泡，一层一层的往上变大</li></ul><h3 id="2、快速排序（Quick-Sort）【选取一个基准值，小数在左大数在在右】"><a href="#2、快速排序（Quick-Sort）【选取一个基准值，小数在左大数在在右】" class="headerlink" title="2、快速排序（Quick Sort）【选取一个基准值，小数在左大数在在右】"></a>2、快速排序（Quick Sort）【选取一个基准值，小数在左大数在在右】</h3><p>快速排序是由东尼·霍尔所发展的一种排序算法。在平均状况下，排序 n 个项目要 Ο(nlogn) 次比较。</p><p>在最坏状况下则需要 Ο(n2) 次比较，但这种状况并不常见。</p><p>事实上，快速排序通常明显比其他 Ο(nlogn) 算法更快，因为它的内部循环（inner loop）可以在大部分的架构上很有效率地被实现出来。</p><p>快速排序使用分治法（Divide and conquer）策略来把一个串行（list）分为两个子串行（sub-lists）。</p><p>快速排序又是一种分而治之思想在排序算法上的典型应用。本质上来看，快速排序应该算是在冒泡排序基础上的递归分治法。</p><p>快速排序的名字起的是简单粗暴，因为一听到这个名字你就知道它存在的意义，就是快，而且效率高！它是处理大数据最快的排序算法之一了。</p><p>虽然 Worst Case 的时间复杂度达到了 O(n²)，但是人家就是优秀，在大多数情况下都比平均时间复杂度为 O(n logn) 的排序算法表现要更好，</p><p>可是这是为什么呢，我也不知道。好在我的强迫症又犯了，查了 N 多资料终于在《算法艺术与信息学竞赛》上找到了满意的答案：</p><p>快速排序的最坏运行情况是 O(n²)，比如说顺序数列的快排。但它的平摊期望时间是 O(nlogn)，且 O(nlogn) 记号中隐含的常数因子很小，</p><p>比复杂度稳定等于 O(nlogn) 的归并排序要小很多。所以，对绝大多数顺序性较弱的随机数列而言，快速排序总是优于归并排序。</p><h4 id="1-过程图解-1"><a href="#1-过程图解-1" class="headerlink" title="1.过程图解"></a>1.过程图解</h4><p><img src="/markdownImages/quicksort.gif" class="lazyload placeholder" data-srcset="/markdownImages/quicksort.gif" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="快速排序图形展示"></p><h4 id="2-算法思想-1"><a href="#2-算法思想-1" class="headerlink" title="2.算法思想"></a>2.算法思想</h4><ul><li>从数列中挑出一个元素，称为 “基准”（pivot）;</li><li>重新排序数列，所有元素比基准值小的摆放在基准前面，所有元素比基准值大的摆在基准的后面（相同的数可以到任一边）。</li><li>在这个分区退出之后，该基准就处于数列的中间位置。这个称为分区（partition）操作；</li><li>递归地（recursive）把小于基准值元素的子数列和大于基准值元素的子数列排序；</li></ul><p>递归的最底部情形，是数列的大小是零或一，也就是永远都已经被排序好了。</p><p>虽然一直递归下去，但是这个算法总会退出，因为在每次的迭代（iteration）中，它至少会把一个元素摆到它最后的位置去。</p><h4 id="3-代码实现-1"><a href="#3-代码实现-1" class="headerlink" title="3.代码实现"></a>3.代码实现</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 快速排序：最快的n*logN</span><span class="token keyword">def</span> <span class="token function">quickSort</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> lst    pivot <span class="token operator">=</span> lst<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    left <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> lst<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">if</span> i <span class="token operator">&lt;=</span> pivot<span class="token punctuation">]</span>    right <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> lst<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">if</span> i <span class="token operator">></span> pivot<span class="token punctuation">]</span>    arr <span class="token operator">=</span> quickSort<span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">[</span>pivot<span class="token punctuation">]</span> <span class="token operator">+</span> quickSort<span class="token punctuation">(</span>right<span class="token punctuation">)</span>    <span class="token keyword">return</span> arr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-算法分析-1"><a href="#4-算法分析-1" class="headerlink" title="4.算法分析"></a>4.算法分析</h4><ul><li><p>1.比较性：排序时元素之间需要比较，所以为<code>比较排序</code></p></li><li><p>2.稳定性：我们从代码中可以看到当剩余数列中元素小于等于基准元素的，就把他们放到基准元素前面重新排列，</p><p>  剩余数列中元素大于基准元素的，就把他们放到基准元素后面面重新排列，故为<code>不稳定排序</code></p></li><li><p>3.时间复杂度： 复杂度为<code>O(n*logN)</code></p></li><li><p>4.空间复杂度：复杂度为<code>O(n)</code></p></li><li><p>5.记忆方法：比我大的往前站，比我小的往后站，你们自己再按照我的规矩重新排一下， 有点像军训排队</p></li></ul><h2 id="2-插入排序"><a href="#2-插入排序" class="headerlink" title="2. 插入排序"></a>2. 插入排序</h2><h3 id="3、插入排序-Insert-Sort-【逐个插入到前面的有序数中】"><a href="#3、插入排序-Insert-Sort-【逐个插入到前面的有序数中】" class="headerlink" title="3、插入排序(Insert Sort)【逐个插入到前面的有序数中】"></a>3、插入排序(Insert Sort)【逐个插入到前面的有序数中】</h3><p>插入排序（Insertion-Sort）的算法描述是一种简单直观的排序算法。</p><p>它的工作原理是通过构建有序序列，对于未排序数据，在已排序序列中从后向前扫描，找到相应位置并插入。</p><p>代码实现虽然没有冒泡排序和选择排序那么简单粗暴，但它的原理应该是最容易理解的了，因为只要联想到打扑克时的排序就好了</p><h4 id="1-过程图解-2"><a href="#1-过程图解-2" class="headerlink" title="1.过程图解"></a>1.过程图解</h4><p><img src="/markdownImages/insertsort.gif" class="lazyload placeholder" data-srcset="/markdownImages/insertsort.gif" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="插入排序图形展示"></p><h4 id="2-算法思想-2"><a href="#2-算法思想-2" class="headerlink" title="2.算法思想"></a>2.算法思想</h4><ul><li>1.从第二个元素开始和前面的元素进行比较，如果前面的元素比当前元素大，则将前面元素 后移，当前元素依次往前，直到找到比它小或等于它的元素插入在其后面然后</li><li>2.选择第三个元素，重复上述操作，进行插入</li><li>3.依次选择到最后一个元素，插入后即完成所有排序</li></ul><h4 id="3-代码实现-2"><a href="#3-代码实现-2" class="headerlink" title="3.代码实现"></a>3.代码实现</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">insert_sort</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""插入排序"""</span>    <span class="token comment"># 第一层for表示循环插入的遍数</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">## 倒序取从下标i的元素开始到下标0</span>                <span class="token keyword">if</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> arr<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                    arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span>                <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token comment">## 如果当前数值大于前一个数值，退出</span>                    <span class="token keyword">break</span>    <span class="token keyword">return</span> arr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-算法分析-2"><a href="#4-算法分析-2" class="headerlink" title="4.算法分析"></a>4.算法分析</h4><blockquote><p>插入排序的适用场景：一个新元素需要插入到一组已经是有序的数组中，或者是一组基本有序的数组排序.</p></blockquote><ul><li><ol><li>比较性：排序时元素之间需要比较，所以为<code>比较排序</code></li></ol></li><li><ol start="2"><li>稳定性：从代码我们可以看出只有比较元素大于当前元素，比较元素才会往后移动，所以相同元素是不会改变相对顺序</li></ol></li><li><ol start="3"><li>时间复杂度：插入排序同样需要两次循坏一个一个比较，故时间复杂度也为<code>O(n^2)</code></li></ol></li><li><ol start="4"><li>空间复杂度：只需要常数个辅助单元，所以空间复杂度也为<code>O(1)</code></li></ol></li><li><ol start="5"><li>记忆方法：想象成在书架中插书：先找到相应位置，将后面的书往后推，再将书插入</li></ol></li></ul><h3 id="4、希尔排序（Shell-Sort）【从大范围到小范围进行比较-交换】类似冒泡和插入的联合"><a href="#4、希尔排序（Shell-Sort）【从大范围到小范围进行比较-交换】类似冒泡和插入的联合" class="headerlink" title="4、希尔排序（Shell Sort）【从大范围到小范围进行比较-交换】类似冒泡和插入的联合"></a>4、希尔排序（Shell Sort）【从大范围到小范围进行比较-交换】类似冒泡和插入的联合</h3><p>希尔排序(Shell’s Sort)是插入排序的一种又称“缩小增量(间隔)排序”（Diminishing Increment Sort），</p><p>是<code>插入排序</code>算法的一种更高效的改进版本，基于·插入排序·的以下两点性质而提出改进方法的：</p><ul><li>插入排序在对几乎已经排好序的数据操作时，效率高，即可以达到线性排序的效率；</li><li>但插入排序一般来说是低效的，因为插入排序每次只能将数据移动一位</li></ul><p>它与插入排序的不同之处在于，它会优先比较距离较远的元素，该方法因D.L.Shell于1959年提出而得名。</p><p>希尔排序的基本思想是：</p><p>先将整个待排序的记录序列分割成为若干子序列分别进行直接插入排序，</p><p>待整个序列中的记录“基本有序”时，再对全体记录进行依次直接插入排序。</p><h4 id="1-过程图解-3"><a href="#1-过程图解-3" class="headerlink" title="1.过程图解"></a>1.过程图解</h4><p><img src="/markdownImages/shellsort.jpg" class="lazyload placeholder" data-srcset="/markdownImages/shellsort.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="希尔排序图形展示"></p><h4 id="2-算法思想-3"><a href="#2-算法思想-3" class="headerlink" title="2.算法思想"></a>2.算法思想</h4><p>希尔排序的整体思想是将固定间隔的几个元素之间排序，然后再缩小这个间隔。这样到最后数列就成为了<code>基本有序数列</code>，</p><p>而前面我们讲过<code>插入排序</code>对基本有序数列排序效果较好。</p><ul><li><ol><li>计算一个增量（间隔）值 </li></ol></li><li><ol start="2"><li>对元素进行增量元素进行比较，比如增量值为7，那么就对0,7,14,21…个元素进行插入排序</li></ol></li><li><ol start="3"><li>然后对1,8,15…进行排序，依次递增进行排序 </li></ol></li><li><ol start="4"><li>所有元素排序完后，缩小增量比如为3，然后又重复上述第2，3步 </li></ol></li><li><ol start="5"><li>最后缩小增量至1时，数列已经基本有序，最后一遍普通插入即可</li></ol></li></ul><p>已知的最增量式是由 <code>Sedgewick</code> 提出的 (1, 5, 19, 41, 109,…)，</p><p>该步长的项来自 9 * 4^i - 9 * 2^i + 1 和 4^i - 3 * 2^i + 1 这两个算式。</p><p>这项研究也表明 <code>比较</code> 在希尔排序中是最主要的操作，而不是交换。</p><p>用这样增量式的<code>希尔排序</code>比<code>插入排序</code>和<code>堆排序</code>都要快，甚至在小数组中比<code>快速排序</code>还快，</p><p>但是在涉及大量数据时<code>希尔排序</code>还是比<code>快速排序</code>慢。</p><h4 id="3-代码实现-3"><a href="#3-代码实现-3" class="headerlink" title="3.代码实现"></a>3.代码实现</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">shell_sort</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""希尔排序"""</span>    <span class="token comment"># 取整计算增量（间隔）值</span>    gap <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>    <span class="token keyword">while</span> gap <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token comment"># 从增量值开始遍历比较</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>gap<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            j <span class="token operator">=</span> i            current <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>            <span class="token comment"># 元素与他同列的前面的每个元素比较，如果比前面的小则互换</span>            <span class="token keyword">while</span> j <span class="token operator">-</span> gap <span class="token operator">>=</span> <span class="token number">0</span> <span class="token keyword">and</span> current <span class="token operator">&lt;</span> arr<span class="token punctuation">[</span>j <span class="token operator">-</span> gap<span class="token punctuation">]</span><span class="token punctuation">:</span>                arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j <span class="token operator">-</span> gap<span class="token punctuation">]</span>                j <span class="token operator">-=</span> gap            arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> current        <span class="token comment"># 缩小增量（间隔）值</span>        gap <span class="token operator">//=</span> <span class="token number">2</span>    <span class="token keyword">return</span> arr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-算法分析-3"><a href="#4-算法分析-3" class="headerlink" title="4.算法分析"></a>4.算法分析</h4><ul><li><p>1.比较性：排序时元素之间需要比较，所以为<code>比较排序</code></p></li><li><p>2.稳定性：因为希尔排序是间隔的插入，所以存在相同元素相对顺序被打乱，所以是<code>不稳定排序</code></p></li><li><p>3.时间复杂度： 最坏时间复杂度O(n^2)平均复杂度为<code>O(n^1.3)</code></p></li><li><p>4.空间复杂度：只需要常数个辅助单元，所以空间复杂度也为<code>O(1)</code></p></li><li><p>5.记忆方法：插入排序是每轮都是一小步，希尔排序是先大步后小步，它第一个突破O(n2)的排序算法。</p><p>联想起阿姆斯特朗登月之后说：这是我个人一小步，却是人类迈出的一大步。</p></li></ul><h2 id="3-选择排序"><a href="#3-选择排序" class="headerlink" title="3. 选择排序"></a>3. 选择排序</h2><h3 id="5、选择排序（Selection-sort）【选择最小的数据放在前面】"><a href="#5、选择排序（Selection-sort）【选择最小的数据放在前面】" class="headerlink" title="5、选择排序（Selection sort）【选择最小的数据放在前面】"></a>5、选择排序（Selection sort）【选择最小的数据放在前面】</h3><p>选择排序（Selection sort）是一种简单直观的排序算法。</p><p>无论什么数据进去都是 O(n²) 的时间复杂度。</p><p>所以用到它的时候，数据规模越小越好。唯一的好处可能就是不占用额外的内存空间了吧。</p><p>它的工作原理是每一次从待排序的数据元素中选出最小（或最大）的一个元素，</p><p>存放在序列的起始位置，所以称为：<code>选择排序</code></p><h4 id="1-过程图解-4"><a href="#1-过程图解-4" class="headerlink" title="1.过程图解"></a>1.过程图解</h4><p><img src="/markdownImages/selectsort.gif" class="lazyload placeholder" data-srcset="/markdownImages/selectsort.gif" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="选择排序图形展示"></p><h4 id="2-算法思想-4"><a href="#2-算法思想-4" class="headerlink" title="2.算法思想"></a>2.算法思想</h4><ul><li>设第一个元素为比较元素，依次和后面的元素比较，比较完所有元素找到最小（大）的元素，将它和第一个元素互换</li><li>重复上述操作，我们找出第二小（大）的元素和第二个位置的元素互换，以此类推找出剩余最小元素将它换到前面，即完成排序</li></ul><h4 id="3-代码实现-4"><a href="#3-代码实现-4" class="headerlink" title="3.代码实现"></a>3.代码实现</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">selection_sort</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""选择排序"""</span>    <span class="token comment"># 第一层for表示循环选择的遍数</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 将起始元素设为最小元素</span>        min_index <span class="token operator">=</span> i        <span class="token comment"># 第二层for表示最小元素和后面的元素逐个比较</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> arr<span class="token punctuation">[</span>min_index<span class="token punctuation">]</span><span class="token punctuation">:</span>                <span class="token comment"># 如果当前元素比最小元素小，则把当前元素角标记为最小元素角标</span>                min_index <span class="token operator">=</span> j        <span class="token comment"># 查找一遍后将最小元素与起始元素互换</span>        arr<span class="token punctuation">[</span>min_index<span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>min_index<span class="token punctuation">]</span>    <span class="token keyword">return</span> arr<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    li <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">]</span>    selection_sort<span class="token punctuation">(</span>li<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>另外一种写法,它和冒泡法类似</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 选择排序</span><span class="token keyword">def</span> <span class="token function">selectSort</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">></span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>                nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">]</span>    selectSort<span class="token punctuation">(</span>nums<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-算法分析-4"><a href="#4-算法分析-4" class="headerlink" title="4.算法分析"></a>4.算法分析</h4><p><code>选择排序</code>和<code>冒泡排序</code>很类似，但是选择排序每轮比较只会有一次交换，</p><p>而冒泡排序会有多次交换，交换次数比冒泡排序少，就减少cpu的消耗，</p><p>所以在数据量小的时候可以用选择排序，实际适用的场合非常少。</p><ul><li>比较性：因为排序时元素之间需要比较，所以是<code>比较排序</code></li><li>稳定性：因为存在任意位置的两个元素交换，比如[5, 8, 5, 2]，<br>第一个5会和2交换位置，所以改变了两个5原来的相对顺序，所以为<code>不稳定排序</code>。</li><li>时间复杂度：我们看到选择排序同样是双层循环n*(n-1))，所以时间复杂度也为：O(n^2)</li><li>空间复杂度：只需要常数个辅助单元，所以空间复杂度也为O(1)</li><li>记忆方法：选择对象要先选最小的</li></ul><h3 id="6、堆排序-Heap-Sort-【利用最大堆和最小堆的特性】"><a href="#6、堆排序-Heap-Sort-【利用最大堆和最小堆的特性】" class="headerlink" title="6、堆排序(Heap Sort)【利用最大堆和最小堆的特性】"></a>6、堆排序(Heap Sort)【利用最大堆和最小堆的特性】</h3><p><code>堆排序（Heapsort）</code>是指利用堆这种数据结构所设计的一种排序算法。</p><p>堆积是一个近似完全二叉树的结构，并同时满足堆积的性质：即子结点的键值或索引总是小于（或者大于）它的父节点。</p><h4 id="1-过程图解-5"><a href="#1-过程图解-5" class="headerlink" title="1.过程图解"></a>1.过程图解</h4><p><img src="/markdownImages/heapsort.gif" class="lazyload placeholder" data-srcset="/markdownImages/heapsort.gif" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="堆排序图形展示"></p><h4 id="2-算法思想-5"><a href="#2-算法思想-5" class="headerlink" title="2.算法思想"></a>2.算法思想</h4><blockquote><ul><li><p>将初始待排序关键字序列(R1,R2….Rn)构建成大顶堆，此堆为初始的无序区；</p></li><li><p>将堆顶元素R[1]与最后一个元素R[n]交换，此时得到新的无序区(R1,R2,……Rn-1)和新的有序区(Rn),且满足R[1,2…n-1]&lt;=R[n]；</p></li><li><p>由于交换后新的堆顶R[1]可能违反堆的性质，因此需要对当前无序区(R1,R2,……Rn-1)调整为新堆，</p><p>然后再次将R[1]与无序区最后一个元素交换，得到新的无序区(R1,R2….Rn-2)和新的有序区(Rn-1,Rn)。</p><p>不断重复此过程直到有序区的元素个数为n-1，则整个排序过程完成。</p></li></ul></blockquote><h4 id="3-代码实现-5"><a href="#3-代码实现-5" class="headerlink" title="3.代码实现"></a>3.代码实现</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span>  <span class="token function">HeapSort</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">heap_adjust</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> start<span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">#将以start为根节点的堆调整为大顶堆</span>        temp<span class="token operator">=</span>arr<span class="token punctuation">[</span>start<span class="token punctuation">]</span>        son<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>start<span class="token operator">+</span><span class="token number">1</span>        <span class="token keyword">while</span> son<span class="token operator">&lt;=</span>end<span class="token punctuation">:</span>            <span class="token keyword">if</span> son<span class="token operator">&lt;</span>end <span class="token keyword">and</span> arr<span class="token punctuation">[</span>son<span class="token punctuation">]</span><span class="token operator">&lt;</span>arr<span class="token punctuation">[</span>son<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>  <span class="token comment">#找出左右孩子节点较大的</span>                son<span class="token operator">+=</span><span class="token number">1</span>            <span class="token keyword">if</span> temp<span class="token operator">>=</span>arr<span class="token punctuation">[</span>son<span class="token punctuation">]</span><span class="token punctuation">:</span>       <span class="token comment">#判断是否为大顶堆</span>                <span class="token keyword">break</span>            arr<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token operator">=</span>arr<span class="token punctuation">[</span>son<span class="token punctuation">]</span>     <span class="token comment">#子节点上移</span>            start<span class="token operator">=</span>son                     <span class="token comment">#继续向下比较</span>            son<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>son<span class="token operator">+</span><span class="token number">1</span>        arr<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token operator">=</span>temp             <span class="token comment">#将原堆顶插入正确位置</span>    n<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span>    <span class="token keyword">if</span> n<span class="token operator">&lt;=</span><span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> lst    <span class="token comment">#建立大顶堆</span>    root<span class="token operator">=</span>n<span class="token operator">//</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span>    <span class="token comment">#最后一个非叶节点（完全二叉树中）</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>root <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        heap_adjust<span class="token punctuation">(</span>lst<span class="token punctuation">,</span> root<span class="token punctuation">,</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        root<span class="token operator">-=</span><span class="token number">1</span>    <span class="token comment">#掐掉堆顶后调整堆</span>    i<span class="token operator">=</span>n<span class="token operator">-</span><span class="token number">1</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token punctuation">(</span>lst<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lst<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span>lst<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>lst<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">#将大顶堆堆顶数放到最后</span>        heap_adjust<span class="token punctuation">(</span>lst<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment">#调整剩余数组成的堆</span>        i<span class="token operator">-=</span><span class="token number">1</span>    <span class="token keyword">return</span> lst<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="算法分析"><a href="#算法分析" class="headerlink" title="算法分析"></a>算法分析</h4><p>堆排序的初始建堆过程比价复杂，对O(n)级别个非叶子节点进行堆调整操作O(logn)，时间复杂度O(nlogn)；</p><p>之后每一次堆调整操作确定一个数的次序，时间复杂度O(nlogn)。合起来时间复杂度O(nlogn)</p><p>额外空间开销出在调整堆过程，根节点下移交换时一个暂存空间，空间复杂度O(1)</p><pre><code>比较性：因为排序时元素之间需要比较，所以是比较排序稳定性：因为存在任意位置的两个元素交换，所以为不稳定排序。时间复杂度：时间复杂度为：O(nlogn)空间复杂度：空间复杂度也为O(1)记忆方法：</code></pre><h2 id="4-归并排序"><a href="#4-归并排序" class="headerlink" title="4. 归并排序"></a>4. 归并排序</h2><h3 id="7、归并排序-Merge-Sort-【分治法-2-4-8插入排序】"><a href="#7、归并排序-Merge-Sort-【分治法-2-4-8插入排序】" class="headerlink" title="7、归并排序 (Merge Sort)【分治法-2-4-8插入排序】"></a>7、归并排序 (Merge Sort)【分治法-2-4-8插入排序】</h3><p>归并排序（MERGE-SORT）是建立在归并操作上的一种有效的排序算法,</p><p>该算法是采用分治法（Divide and Conquer）的一个非常典型的应用。</p><blockquote><p>归并排序适用于子序列有序的数据排序。</p></blockquote><h4 id="1-过程图解-6"><a href="#1-过程图解-6" class="headerlink" title="1.过程图解"></a>1.过程图解</h4><p><img src="/markdownImages/mergesort.gif" class="lazyload placeholder" data-srcset="/markdownImages/mergesort.gif" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="归并排序动画展示"></p><h4 id="2-算法思想-6"><a href="#2-算法思想-6" class="headerlink" title="2.算法思想"></a>2.算法思想</h4><p><img src="/markdownImages/mergesort.jpg" class="lazyload placeholder" data-srcset="/markdownImages/mergesort.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="归并排序图形展示"><br>从上图看分解后的数列很像一个二叉树。</p><ul><li>使用递归将源数列使用二分法分成多个子列</li><li>申请空间将两个子列排序合并然后返回</li><li>将所有子列一步一步合并最后完成排序</li></ul><h4 id="3-代码实现-6"><a href="#3-代码实现-6" class="headerlink" title="3.代码实现"></a>3.代码实现</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">merge_sort</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""归并排序"""</span>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> arr    <span class="token comment"># 使用二分法将数列分两个</span>    mid <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>    left <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token punctuation">:</span>mid<span class="token punctuation">]</span>    right <span class="token operator">=</span> arr<span class="token punctuation">[</span>mid<span class="token punctuation">:</span><span class="token punctuation">]</span>    <span class="token comment"># 使用递归运算</span>    <span class="token keyword">return</span> marge<span class="token punctuation">(</span>merge_sort<span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> merge_sort<span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">marge</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""排序合并两个数列"""</span>    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment"># 两个数列都有值</span>    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token comment"># 左右两个数列第一个最小放前面</span>        <span class="token keyword">if</span> left<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> right<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>            result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>left<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>right<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 只有一个数列中还有值，直接添加</span>    result <span class="token operator">+=</span> left    result <span class="token operator">+=</span> right    <span class="token keyword">return</span> result<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-算法分析-5"><a href="#4-算法分析-5" class="headerlink" title="4.算法分析"></a>4.算法分析</h4><blockquote><p>归并排序是一种稳定的排序方法。和选择排序一样，归并排序的性能不受输入数据的影响，</p><p>但表现比选择排序好的多，因为始终都是O(nlogn）的时间复杂度。代价是需要额外的内存空间。</p></blockquote><ul><li><p>1.比较性：排序时元素之间需要比较，所以为<code>比较排序</code></p></li><li><p>2.稳定性：我们从代码中可以看到当左边的元素小于等于右边的元素就把左边的排前面，</p><p>  而原本左边的就是在前面，所以相同元素的相对顺序不变，故为<code>稳定排序</code></p></li><li><p>3.时间复杂度： 复杂度为<code>O(nlog^n)</code></p></li><li><p>4.空间复杂度：在合并子列时需要申请临时空间，而且空间大小随数列的大小而变化，所以空间复杂度为<code>O(n)</code></p></li><li><p>5.记忆方法：所谓归并肯定是要先分解，再合并</p></li></ul><h2 id="5-线性时间非比较类排序"><a href="#5-线性时间非比较类排序" class="headerlink" title="5. 线性时间非比较类排序"></a>5. 线性时间非比较类排序</h2><p>这三种排序算法都利用了桶的概念，但对桶的使用方法上有明显差异：</p><ul><li><p>   基数排序：根据键值的每位数字来分配桶；</p></li><li><p>   计数排序：每个桶只存储单一键值；</p></li><li><p>   桶排序：每个桶存储一定范围的数值；</p></li></ul><h3 id="8、计数排序（Counting-Sort）【字典计数-还原】"><a href="#8、计数排序（Counting-Sort）【字典计数-还原】" class="headerlink" title="8、计数排序（Counting Sort）【字典计数-还原】"></a>8、计数排序（Counting Sort）【字典计数-还原】</h3><p>计数排序用待排序的数值作为计数数组（列表）的下标，统计每个数值的个数，然后依次输出即可。</p><p>计数数组的大小取决于待排数据取值范围，所以对数据有一定要求，否则空间开销无法承受。</p><h4 id="1-过程图解-7"><a href="#1-过程图解-7" class="headerlink" title="1.过程图解"></a>1.过程图解</h4><p><img src="/markdownImages/countingsort.gif" class="lazyload placeholder" data-srcset="/markdownImages/countingsort.gif" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="计数排序图形展示"></p><h4 id="2-算法思想-7"><a href="#2-算法思想-7" class="headerlink" title="2.算法思想"></a>2.算法思想</h4><ul><li>找出待排序的数组中最大和最小的元素；</li><li>统计数组中每个值为i的元素出现的次数，存入数组C的第i项；</li><li>对所有的计数累加（从C中的第一个元素开始，每一项和前一项相加）；</li><li>反向填充目标数组：将每个元素i放在新数组的第C(i)项，每放一个元素就将C(i)减去1。</li></ul><h4 id="3-代码实现-7"><a href="#3-代码实现-7" class="headerlink" title="3.代码实现"></a>3.代码实现</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">CountSort</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span><span class="token punctuation">:</span>    n<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span>    num<span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span>    count<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>num<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>        count<span class="token punctuation">[</span>lst<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+=</span><span class="token number">1</span>    arr<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>num<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>count<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            arr<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    <span class="token keyword">return</span> arr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-算法分析-6"><a href="#4-算法分析-6" class="headerlink" title="4. 算法分析"></a>4. 算法分析</h4><blockquote><p>计数排序是一个稳定的排序算法。<br>当输入的元素是 n 个 0到 k 之间的整数时，时间复杂度是O(n+k)，空间复杂度也是O(n+k)，其排序速度快于任何比较排序算法。<br>当k不是很大并且序列比较集中时，计数排序是一个很有效的排序算法。</p></blockquote><ul><li>时间复杂度:计数排序只需遍历一次数据，在计数数组中记录，输出计数数组中有记录的下标，时间复杂度为O(n+k)。</li><li>空间复杂度:空间复杂度O(n+k)。</li></ul><h3 id="9、桶排序（Bucket-Sort）【链表】"><a href="#9、桶排序（Bucket-Sort）【链表】" class="headerlink" title="9、桶排序（Bucket Sort）【链表】"></a>9、桶排序（Bucket Sort）【链表】</h3><p>桶排序实际上是计数排序的推广，但实现上要复杂许多。</p><p>桶排序先用一定的函数关系将数据划分到不同有序的区域（桶）内，然后子数据分别在桶内排序，之后顺次输出。</p><p>当每一个不同数据分配一个桶时，也就相当于计数排序。</p><p>假设n个数据，划分为k个桶，桶内采用快速排序，时间复杂度为O(n)+O(k * n/k<em>log(n/k))=O(n)+O(n</em>(log(n)-log(k))),</p><p>显然，k越大，时间复杂度越接近O(n)，当然空间复杂度O(n+k)会越大，这是空间与时间的平衡。</p><h4 id="2-算法分析"><a href="#2-算法分析" class="headerlink" title="2.算法分析"></a>2.算法分析</h4><ul><li>设置一个定量的数组当作空桶；</li><li>遍历输入数据，并且把数据一个一个放到对应的桶里去；</li><li>对每个不是空的桶进行排序；</li><li>从不是空的桶里把排好序的数据拼接起来。 </li></ul><h4 id="3-代码实现-8"><a href="#3-代码实现-8" class="headerlink" title="3.代码实现"></a>3.代码实现</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">BucketSort</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 桶内使用快速排序</span>    <span class="token keyword">def</span> <span class="token function">QuickSort</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">def</span> <span class="token function">partition</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span>left<span class="token punctuation">,</span>right<span class="token punctuation">)</span><span class="token punctuation">:</span>            key<span class="token operator">=</span>left         <span class="token comment">#划分参考数索引,默认为第一个数，可优化</span>            <span class="token keyword">while</span> left<span class="token operator">&lt;</span>right<span class="token punctuation">:</span>                <span class="token keyword">while</span> left<span class="token operator">&lt;</span>right <span class="token keyword">and</span> arr<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token operator">>=</span>arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">:</span>                    right<span class="token operator">-=</span><span class="token number">1</span>                <span class="token keyword">while</span> left<span class="token operator">&lt;</span>right <span class="token keyword">and</span> arr<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token operator">&lt;=</span>arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">:</span>                    left<span class="token operator">+=</span><span class="token number">1</span>                <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">,</span>arr<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">,</span>arr<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">)</span>            <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">,</span>arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>arr<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> left         <span class="token keyword">def</span> <span class="token function">quicksort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span>left<span class="token punctuation">,</span>right<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment">#递归调用</span>            <span class="token keyword">if</span> left<span class="token operator">>=</span>right<span class="token punctuation">:</span>                <span class="token keyword">return</span>            mid<span class="token operator">=</span>partition<span class="token punctuation">(</span>arr<span class="token punctuation">,</span>left<span class="token punctuation">,</span>right<span class="token punctuation">)</span>            quicksort<span class="token punctuation">(</span>arr<span class="token punctuation">,</span>left<span class="token punctuation">,</span>mid<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            quicksort<span class="token punctuation">(</span>arr<span class="token punctuation">,</span>mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>right<span class="token punctuation">)</span>        <span class="token comment">#主函数</span>        n<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span>        <span class="token keyword">if</span> n<span class="token operator">&lt;=</span><span class="token number">1</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> lst        quicksort<span class="token punctuation">(</span>lst<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> lst    n<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span>    big<span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span>    num<span class="token operator">=</span>big<span class="token operator">//</span><span class="token number">10</span><span class="token operator">+</span><span class="token number">1</span>    bucket<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>    buckets<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> lst<span class="token punctuation">:</span>        buckets<span class="token punctuation">[</span>i<span class="token operator">//</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>     <span class="token comment">#划分桶</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> buckets<span class="token punctuation">:</span>                       <span class="token comment">#桶内排序</span>        bucket<span class="token operator">=</span>QuickSort<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    arr<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> buckets<span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> j <span class="token keyword">in</span> i<span class="token punctuation">:</span>                arr<span class="token punctuation">.</span>append<span class="token punctuation">(</span>j<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            arr<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>        lst<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>    <span class="token keyword">return</span> lst<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-算法分析-7"><a href="#4-算法分析-7" class="headerlink" title="4.算法分析"></a>4.算法分析</h4><p>桶排序最好情况下使用线性时间O(n)，桶排序的时间复杂度，</p><p>取决与对各个桶之间数据进行排序的时间复杂度，因为其它部分的时间复杂度都为O(n)。</p><p>很显然，桶划分的越小，各个桶之间的数据越少，排序所用的时间也会越少。但相应的空间消耗就会增大。</p><h3 id="10、基数排序（Radix-Sort）"><a href="#10、基数排序（Radix-Sort）" class="headerlink" title="10、基数排序（Radix Sort）"></a>10、基数排序（Radix Sort）</h3><p><code>基数排序</code>是一种<code>非比较型整数排序</code>算法，其原理是将整数按位数切割成不同的数字，</p><p>然后按每个位数分别比较。由于整数也可以表达字符串（比如名字或日期）和特定格式的浮点数，</p><p>所以基数排序也不是只能使用于整数。</p><h4 id="1-过程图解-8"><a href="#1-过程图解-8" class="headerlink" title="1.过程图解"></a>1.过程图解</h4><p><img src="/markdownImages/radixsort.gif" class="lazyload placeholder" data-srcset="/markdownImages/radixsort.gif" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="基数排序图形展示"></p><h4 id="2-算法分析-1"><a href="#2-算法分析-1" class="headerlink" title="2.算法分析"></a>2.算法分析</h4><ul><li>取得数组中的最大数，并取得位数；</li><li>arr为原始数组，从最低位开始取每个位组成radix数组；</li><li>对radix进行计数排序（利用计数排序适用于小范围数的特点）；</li></ul><h4 id="3、代码实现"><a href="#3、代码实现" class="headerlink" title="3、代码实现"></a>3、代码实现</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> math<span class="token keyword">def</span> <span class="token function">RadixSort</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">getbit</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>       <span class="token comment">#返回x的第i位（从右向左，个位为0）数值</span>        y<span class="token operator">=</span>x<span class="token operator">//</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span>        z<span class="token operator">=</span>y<span class="token operator">%</span><span class="token number">10</span>        <span class="token keyword">return</span> z    <span class="token keyword">def</span> <span class="token function">CountSort</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span><span class="token punctuation">:</span>        n<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span>        num<span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span>        count<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>num<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>            count<span class="token punctuation">[</span>lst<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+=</span><span class="token number">1</span>        arr<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>num<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>count<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                arr<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>        <span class="token keyword">return</span> arr    Max<span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span>    <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>log10<span class="token punctuation">(</span>Max<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>             <span class="token comment">#对k位数排k次,每次按某一位来排</span>        arr<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> lst<span class="token punctuation">:</span>                 <span class="token comment">#将ls（待排数列）中每个数按某一位分类（0-9共10类）存到arr[][]二维数组（列表）中</span>            arr<span class="token punctuation">[</span>getbit<span class="token punctuation">(</span>i<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>         <span class="token comment">#对arr[]中每一类（一个列表）  按计数排序排好</span>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">:</span>                arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>CountSort<span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        j<span class="token operator">=</span><span class="token number">9</span>        n<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>     <span class="token comment">#顺序输出arr[][]中数到ls中，即按第k位排好</span>            <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>                j<span class="token operator">-=</span><span class="token number">1</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                lst<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token operator">=</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token keyword">return</span> lst    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-算法分析-8"><a href="#4-算法分析-8" class="headerlink" title="4 算法分析"></a>4 算法分析</h4><p>基数排序基于分别排序，分别收集，所以是稳定的。但基数排序的性能比桶排序要略差，每一次关键字的桶分配都需要O(n)的时间复杂度，<br>而且分配之后得到新的关键字序列又需要O(n)的时间复杂度。假如待排数据可以分为d个关键字，则基数排序的时间复杂度将是O(d*2n) ，<br>当然d要远远小于n，因此基本上还是线性级别的。</p><p>基数排序的空间复杂度为O(n+k)，其中k为桶的数量。一般来说n&gt;&gt;k，因此额外空间需要大概n个左右。</p><h2 id="补充：外部排序"><a href="#补充：外部排序" class="headerlink" title="补充：外部排序"></a>补充：外部排序</h2><p>外部排序是指大文件排序，即待排序的数据记录以文件的形式存储在外存储器上。</p><p>由于文件中的记录很多、信息容量庞大，所以整个文件所占据的存储单元往往会超过了计算机的内存量，</p><p>因此，无法将整个文件调入内存中进行排序。于是，在排序过程中需进行多次的内外存之间的交换。</p><p>在实际应用中，由于使用的外设不一致，通常可以分为磁盘文件排序和磁带文件排序两大类。</p><p>外部排序基本上由两个相对独立的阶段组成。</p><p>首先，按可用内存大小，将外存上含 N 个记录的文件分成若干长度为 L(&lt;N) 的子文件，</p><p>依次读入内存，利用内部排序算法进行排序。然后，将排序后的文件写入外存，</p><p>通常将这些文件称为归并段（Run）或“顺串”；对这些归并段进行逐步归并，</p><p>最终得到整个有序文件。可见外部排序的基本方法是归并排序法，下面的例子给出了一个简单的外部排序解决过程。</p><p>【例子】给定磁盘上有6大块记录需要排序，而计算机内存最多只能对3个记录块进行内排序，则外部排序的过程如下图所示。<br><img src="/markdownImages/outsort_example.png" class="lazyload placeholder" data-srcset="/markdownImages/outsort_example.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="基数排序图形展示"><br>【解析】首先将连续的3大块记录读入内存，用任何一种内部排序算法完成排序，再写回磁盘。</p><p>经过2次3大块记录的内部排序，得到上图（a）的结果。然后另用一个可容纳6大块记录的周转盘，辅助最后的归并。</p><p>方法是将内存分成3块，其中2块用于输入，1块用于输出，指定一个输入块只负责读取一个归并段中的记录，如上图（b）所示。<br>归并步骤为：</p><ul><li>当任一输入块为空时，归并暂停，将相应归并段中的一块信息写入内存</li><li>将内存中2个输入块中的记录逐一归并入输出块</li><li>当输出块写满时，归并暂停，将输出块中的记录写入周转盘<br>如此可将2个归并段在周转盘上归并成一个有序的归并段。</li></ul><p>上例的解决方法是最简单的归并法，事实上外部排序的效率还可以进一步提高。要提高外排的效率，关键要解决以下4个问题：</p><ul><li>   如何减少归并轮数</li><li>   如何有效安排内存中的输入、输出块，使得机器的并行处理能力被最大限度利用</li><li>   如何有效生成归并段</li><li>   如何将归并段进行有效归并</li></ul><p>针对这四大问题，人们设计了多种解决方案，例如釆用多路归并取代简单的二路归并，就可以减少归并轮数；</p><p>例如在内存中划分出2个输出块，而不是只用一个，就可以设计算法使得归并排序不会因为磁盘的写操作而暂停，</p><p>达到归并和写周转盘同时并行的效果；例如通过一种“败者树”的数据结构，可以一次生成2倍于内存容量的归并段；</p><p>例如利用哈夫曼树的贪心策略选择归并次序，可以耗费最少的磁盘读写时间等</p><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>各种算法重要的时理解&amp;记住它们的算法原理，因为代码是永远记不住的，只要记住原理你就能用伪代码实现。</p>]]></content>
      
      
      <categories>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 排序 </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>主题介绍-侧边栏功能</title>
      <link href="/post/ben-zhan-jie-shao/zhu-ti-jie-shao-ce-bian-lan-gong-neng/"/>
      <url>/post/ben-zhan-jie-shao/zhu-ti-jie-shao-ce-bian-lan-gong-neng/</url>
      
        <content type="html"><![CDATA[<blockquote><p>首页侧边栏支持的版本为 v2.6.0+</p></blockquote><h1 id="默认的侧边栏"><a href="#默认的侧边栏" class="headerlink" title="默认的侧边栏"></a>默认的侧边栏</h1><p>在主题的<code>config.yml</code>文件中配置</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># sidebar侧边栏</span><span class="token key atrule">sidebar</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">position</span><span class="token punctuation">:</span> left <span class="token comment"># left right</span>  <span class="token key atrule">widget_library</span><span class="token punctuation">:</span>    <span class="token key atrule">side_blogger</span><span class="token punctuation">:</span>      <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">avatar</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//api.btstu.cn/sjtx/api.php<span class="token punctuation">?</span>lx=c1<span class="token important">&amp;format=images</span>      <span class="token key atrule">shape</span><span class="token punctuation">:</span> rectangle <span class="token comment"># circle, rectangle</span>      <span class="token key atrule">url</span><span class="token punctuation">:</span> /about/      <span class="token key atrule">title</span><span class="token punctuation">:</span> 青墨书晚风      <span class="token key atrule">subtitle</span><span class="token punctuation">:</span> 我是副标题      <span class="token key atrule">jinrishici</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># Poetry Today. You can set a string, and it will be displayed when loading fails.</span>      <span class="token key atrule">fontFammily</span><span class="token punctuation">:</span> Long Cang<span class="token punctuation">,</span>cursive      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>      <span class="token key atrule">order</span><span class="token punctuation">:</span>  <span class="token comment"># 卡片排序, 数值越小，越在上面</span>      <span class="token key atrule">social</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>rss          <span class="token key atrule">url</span><span class="token punctuation">:</span> /atom.xml        <span class="token punctuation">-</span> <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>envelope          <span class="token key atrule">url</span><span class="token punctuation">:</span> mailto<span class="token punctuation">:</span>me@xxx.com        <span class="token punctuation">-</span> <span class="token key atrule">icon</span><span class="token punctuation">:</span> fab fa<span class="token punctuation">-</span>github          <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/yuang01/hexo<span class="token punctuation">-</span>theme<span class="token punctuation">-</span>bamboo        <span class="token punctuation">-</span> <span class="token key atrule">icon</span><span class="token punctuation">:</span> fab fa<span class="token punctuation">-</span>qq          <span class="token key atrule">url</span><span class="token punctuation">:</span> tencent<span class="token punctuation">:</span>//AddContact/<span class="token punctuation">?</span>fromId=50<span class="token important">&amp;fromSubId=1&amp;subcmd=all&amp;uin=你的qq号码</span>    <span class="token comment"># ---------------------------------------</span>    <span class="token comment"># category widget</span>    <span class="token key atrule">side_category</span><span class="token punctuation">:</span>      <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>      <span class="token key atrule">order</span><span class="token punctuation">:</span>  <span class="token comment"># 卡片排序(widget都有)，任意数字，数字小的在上面</span>      <span class="token key atrule">header</span><span class="token punctuation">:</span>        <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>folder<span class="token punctuation">-</span>open        <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> <span class="token comment"># 标题字体颜色</span>        <span class="token key atrule">title</span><span class="token punctuation">:</span> 文章分类        <span class="token key atrule">url</span><span class="token punctuation">:</span> /blog/categories/    <span class="token comment"># ---------------------------------------</span>    <span class="token comment"># tagcloud widget</span>    <span class="token key atrule">side_tagcloud</span><span class="token punctuation">:</span>      <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>      <span class="token key atrule">order</span><span class="token punctuation">:</span>       <span class="token key atrule">header</span><span class="token punctuation">:</span>        <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>tags        <span class="token key atrule">icon_color</span><span class="token punctuation">:</span>         <span class="token key atrule">title</span><span class="token punctuation">:</span> 热门标签        <span class="token key atrule">url</span><span class="token punctuation">:</span> /tags/      <span class="token key atrule">min_font</span><span class="token punctuation">:</span> <span class="token number">14</span>      <span class="token key atrule">max_font</span><span class="token punctuation">:</span> <span class="token number">24</span>      <span class="token key atrule">color</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">start_color</span><span class="token punctuation">:</span> <span class="token string">'#999'</span>      <span class="token key atrule">end_color</span><span class="token punctuation">:</span> <span class="token string">'#555'</span>    <span class="token comment"># ---------------------------------------</span>    <span class="token comment"># recent_post widget</span>    <span class="token key atrule">side_recent_post</span><span class="token punctuation">:</span>      <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>      <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token number">5</span>      <span class="token key atrule">sort</span><span class="token punctuation">:</span> update <span class="token comment"># date</span>      <span class="token key atrule">order</span><span class="token punctuation">:</span>       <span class="token key atrule">header</span><span class="token punctuation">:</span>        <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>book        <span class="token key atrule">icon_color</span><span class="token punctuation">:</span>         <span class="token key atrule">title</span><span class="token punctuation">:</span> 最新文章        <span class="token key atrule">url</span><span class="token punctuation">:</span> /tags/    <span class="token comment"># ---------------------------------------</span>    <span class="token comment"># side_archives widget</span>    <span class="token key atrule">side_archives</span><span class="token punctuation">:</span>      <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> monthly <span class="token comment"># yearly or monthly      or yearly</span>      <span class="token key atrule">format</span><span class="token punctuation">:</span> MMMM YYYY <span class="token comment"># eg: YYYY年MM月     or YYYY</span>      <span class="token key atrule">timeOrder</span><span class="token punctuation">:</span> <span class="token number">-1</span> <span class="token comment"># Sort of order. 1, asc for ascending; -1, desc for descending 时间排序</span>      <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token number">8</span> <span class="token comment"># if set 0 will show all</span>      <span class="token key atrule">order</span><span class="token punctuation">:</span>  <span class="token comment"># widget order 卡片排序</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>      <span class="token key atrule">header</span><span class="token punctuation">:</span>         <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>archive        <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> red        <span class="token key atrule">title</span><span class="token punctuation">:</span> 归档    <span class="token comment"># ---------------------------------------</span>    <span class="token comment"># side_webinfo widget</span>    <span class="token key atrule">side_webinfo</span><span class="token punctuation">:</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>      <span class="token key atrule">order</span><span class="token punctuation">:</span>       <span class="token key atrule">header</span><span class="token punctuation">:</span>         <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>chart<span class="token punctuation">-</span>line        <span class="token key atrule">title</span><span class="token punctuation">:</span> 站点信息      <span class="token key atrule">type</span><span class="token punctuation">:</span>        <span class="token key atrule">article</span><span class="token punctuation">:</span>          <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">text</span><span class="token punctuation">:</span> <span class="token string">'文章数目：'</span>          <span class="token key atrule">unit</span><span class="token punctuation">:</span> <span class="token string">'篇'</span>        <span class="token key atrule">runtime</span><span class="token punctuation">:</span>          <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">data</span><span class="token punctuation">:</span> <span class="token string">'2020/01/01'</span>    <span class="token comment"># 填写建站日期</span>          <span class="token key atrule">text</span><span class="token punctuation">:</span> <span class="token string">'已运行时间：'</span>          <span class="token key atrule">unit</span><span class="token punctuation">:</span> <span class="token string">'天'</span>        <span class="token key atrule">wordcount</span><span class="token punctuation">:</span>          <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">text</span><span class="token punctuation">:</span> <span class="token string">'本站总字数：'</span>   <span class="token comment"># 需要启用 wordcount</span>          <span class="token key atrule">unit</span><span class="token punctuation">:</span> <span class="token string">'字'</span>        <span class="token key atrule">visitcounter</span><span class="token punctuation">:</span>          <span class="token key atrule">service</span><span class="token punctuation">:</span> busuanzi <span class="token comment"># only busuanzi</span>          <span class="token key atrule">siteuv</span><span class="token punctuation">:</span>            <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>            <span class="token key atrule">text</span><span class="token punctuation">:</span> <span class="token string">'本站访客数：'</span>            <span class="token key atrule">unit</span><span class="token punctuation">:</span> <span class="token string">'人'</span>          <span class="token key atrule">sitepv</span><span class="token punctuation">:</span>            <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>            <span class="token key atrule">text</span><span class="token punctuation">:</span> <span class="token string">'本站总访问量：'</span>            <span class="token key atrule">unit</span><span class="token punctuation">:</span> <span class="token string">'次'</span>        <span class="token key atrule">lastupd</span><span class="token punctuation">:</span>          <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">friendlyShow</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token comment"># 更友好的时间显示</span>          <span class="token key atrule">text</span><span class="token punctuation">:</span> <span class="token string">'最后活动时间：'</span>          <span class="token key atrule">unit</span><span class="token punctuation">:</span> <span class="token string">'日'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="widget-排序"><a href="#widget-排序" class="headerlink" title="widget 排序"></a>widget 排序</h1><p>只需要配置 <code>order</code> 就行。（使用了 Flex 佈局的 order 屬性)，值越小越靠前(靠上)</p><h1 id="自定义侧边栏"><a href="#自定义侧边栏" class="headerlink" title="自定义侧边栏"></a>自定义侧边栏</h1><h2 id="创建-widget-yml"><a href="#创建-widget-yml" class="headerlink" title="创建 widget.yml"></a>创建 widget.yml</h2><p>在Hexo博客目录中的<code>source/_data</code>（如果沒有 _data 文件夾，请自行创建），创建一个文件 widget.yml</p><h2 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># widget_library 里面的不会出现在sticky区域，也就是不会粘贴在左侧 </span><span class="token key atrule">widget_library</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> test_a  <span class="token key atrule">id_name</span><span class="token punctuation">:</span> test_a  <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">0</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> 这个widget不会粘贴  <span class="token key atrule">icon</span><span class="token punctuation">:</span> fab fa<span class="token punctuation">-</span>weibo  <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> <span class="token string">'#d63130'</span>  <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com  <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>  <span class="token key atrule">html</span><span class="token punctuation">:</span> <span class="token string">'haha'</span><span class="token comment"># widget_library_sticky 里面的会出现在sticky区域，会粘贴在左侧</span><span class="token key atrule">widget_library_sticky</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> testWidget    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> testWidget    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 微博热搜    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fab fa<span class="token punctuation">-</span>weibo    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> <span class="token string">'#d63130'</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> <span class="token string">'xixi'</span><span class="token comment"># home_widget里面的内容会出现在座右铭那一个栏目里面</span><span class="token key atrule">home_widget</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> welcome    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> welcome    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 欢迎    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>envelope    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> blue    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> <span class="token string">'针不戳'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参数解释"><a href="#参数解释" class="headerlink" title="参数解释"></a>参数解释</h2><table><thead><tr><th>参数</th><th>解释</th></tr></thead><tbody><tr><td>class_name</td><td>所创建的 widget 父类 class 名</td></tr><tr><td>id_name</td><td>所创建的 widget 父类 id 名</td></tr><tr><td>order</td><td>所创建的 widget 排序 （可选）</td></tr><tr><td>name</td><td>所创建的 widget 名称</td></tr><tr><td>icon</td><td>所创建的 widget 头部的字体图标</td></tr><tr><td>icon_color</td><td>所创建的 widget 头部的字体图标的颜色</td></tr><tr><td>url</td><td>所创建的 widget 头部点击跳转的链接</td></tr><tr><td>background</td><td>所创建的 widget 的背景颜色</td></tr><tr><td>html</td><td>所创建的 widget 的相关代码</td></tr></tbody></table><p>生成的代码为</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>widget test_a<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_a<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">order</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span> #fff</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> #d63130</span><span class="token punctuation">"</span></span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>noopener<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://baidu.com<span class="token punctuation">"</span></span> <span class="token attr-name">data-pjax-state</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fab fa-weibo fa-fw<span class="token punctuation">"</span></span> <span class="token attr-name">aria-hidden</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>这个widget不会粘贴<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    haha  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你需要对添加的 widget 进行 UI 调整，请自行添加 css 到 inject 去。</p><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><h3 id="首页添加github日历"><a href="#首页添加github日历" class="headerlink" title="首页添加github日历"></a>首页添加github日历</h3><p>例如我在``里添加一个github日历，首先我在source文件夹下创建一个js文件<code>/githubcalendar/index.js</code>, js代码如下:</p><details cyan><summary pointer> github日历js </summary>              <div class='content'>              <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">var github_canlendar = (git_user<span class="token punctuation">,</span> git_color) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>    var git_githubapiurl = "https<span class="token punctuation">:</span>//python<span class="token punctuation">-</span>github<span class="token punctuation">-</span>calendar<span class="token punctuation">-</span>api.vercel.app/api<span class="token punctuation">?</span>" + git_user;    var git_fixed = 'fixed';    var git_px = 'px';    var git_month = <span class="token punctuation">[</span><span class="token string">'一月'</span><span class="token punctuation">,</span> <span class="token string">'二月'</span><span class="token punctuation">,</span> <span class="token string">'三月'</span><span class="token punctuation">,</span> <span class="token string">'四月'</span><span class="token punctuation">,</span> <span class="token string">'五月'</span><span class="token punctuation">,</span> <span class="token string">'六月'</span><span class="token punctuation">,</span> <span class="token string">'七月'</span><span class="token punctuation">,</span> <span class="token string">'八月'</span><span class="token punctuation">,</span> <span class="token string">'九月'</span><span class="token punctuation">,</span> <span class="token string">'十月'</span><span class="token punctuation">,</span> <span class="token string">'十一月'</span><span class="token punctuation">,</span> <span class="token string">'十二月'</span><span class="token punctuation">]</span>;    var git_monthchange = <span class="token punctuation">[</span><span class="token punctuation">]</span>;    var git_oneyearbeforeday = '';    var git_thisday = '';    var git_amonthago = '';    var git_aweekago = '';    var git_weekdatacore = 0;    var git_datacore = 0;    var git_total = 0;    var git_datadate = '';    var git_git_data = <span class="token punctuation">[</span><span class="token punctuation">]</span>;    var git_positionplusdata = <span class="token punctuation">[</span><span class="token punctuation">]</span>;    var git_firstweek = <span class="token punctuation">[</span><span class="token punctuation">]</span>;    var git_lastweek = <span class="token punctuation">[</span><span class="token punctuation">]</span>;    var git_beforeweek = <span class="token punctuation">[</span><span class="token punctuation">]</span>;    var git_thisweekdatacore = 0;    var git_mounthbeforeday = 0;    var git_mounthfirstindex = 0;    var git_crispedges = 'crispedges';    var git_thisdayindex = 0;    var git_amonthagoindex = 0;    var git_amonthagoweek = <span class="token punctuation">[</span><span class="token punctuation">]</span>;    var git_firstdate = <span class="token punctuation">[</span><span class="token punctuation">]</span>;    var git_first2date = <span class="token punctuation">[</span><span class="token punctuation">]</span>;    var git_montharrbefore = <span class="token punctuation">[</span><span class="token punctuation">]</span>;    var git_monthindex = 0;    var retinaCanvas = (canvas<span class="token punctuation">,</span> context<span class="token punctuation">,</span> ratio) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>        if (ratio <span class="token punctuation">></span> 1) <span class="token punctuation">&#123;</span>            var canvasWidth = canvas.width;            var canvasHeight = canvas.height;            canvas.width = canvasWidth * ratio;            canvas.height = canvasHeight * ratio;            canvas.style.width = '100%';            canvas.style.height = canvasHeight + 'px';            context.scale(ratio<span class="token punctuation">,</span> ratio);        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>;    function responsiveChart() <span class="token punctuation">&#123;</span>        var ratio = window.devicePixelRatio <span class="token punctuation">|</span><span class="token punctuation">|</span> 1        var git_tooltip_container = document.getElementById('git_tooltip_container');        var git_x = '';        var git_y = '';        var git_span1 = '';        var git_span2 = '';        var c = document.getElementById("gitcanvas");        c.style.width = '100%';        c.style.height = '';        var cmessage = document.getElementById("gitmessage");        var ctx = c.getContext("2d");        width = c.width = document.getElementById("gitcalendarcanvasbox").offsetWidth;        height = c.height = 9 * 0.96 * c.width / git_data.length;        retinaCanvas(c<span class="token punctuation">,</span>ctx<span class="token punctuation">,</span> ratio)        var linemaxwitdh = height/ 9;        var lineminwitdh = 0.8 * linemaxwitdh;        var setposition = <span class="token punctuation">&#123;</span><span class="token key atrule">x</span><span class="token punctuation">:</span> 0.02 * width<span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> 0.025 * width<span class="token punctuation">&#125;</span>;        for (var week in git_data) <span class="token punctuation">&#123;</span>            weekdata = git_data<span class="token punctuation">[</span>week<span class="token punctuation">]</span>;            for (var day in weekdata) <span class="token punctuation">&#123;</span>                var dataitem = <span class="token punctuation">&#123;</span><span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token key atrule">count</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token key atrule">x</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">&#125;</span>;                git_positionplusdata.push(dataitem);                ctx.fillStyle = git_thiscolor(git_color<span class="token punctuation">,</span> weekdata<span class="token punctuation">[</span>day<span class="token punctuation">]</span>.count);                setposition.y = Math.round(setposition.y * 100) / 100;                dataitem.date = weekdata<span class="token punctuation">[</span>day<span class="token punctuation">]</span>.date;                dataitem.count = weekdata<span class="token punctuation">[</span>day<span class="token punctuation">]</span>.count;                dataitem.x = setposition.x;                dataitem.y = setposition.y;                ctx.fillRect(setposition.x<span class="token punctuation">,</span> setposition.y<span class="token punctuation">,</span> lineminwitdh<span class="token punctuation">,</span> lineminwitdh);                setposition.y = setposition.y + linemaxwitdh            <span class="token punctuation">&#125;</span>            setposition.y = 0.025 * width;            setposition.x = setposition.x + linemaxwitdh        <span class="token punctuation">&#125;</span>        if (document.body.clientWidth <span class="token punctuation">></span> 700) <span class="token punctuation">&#123;</span>            ctx.font = "600  Arial";            ctx.fillStyle = '<span class="token comment">#aaa';</span>            ctx.fillText("日"<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 1.9 * linemaxwitdh);            ctx.fillText("二"<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 3.9 * linemaxwitdh);            ctx.fillText("四"<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 5.9 * linemaxwitdh);            ctx.fillText("六"<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 7.9 * linemaxwitdh);            var monthindexlist = width / 24;            for (var index in git_monthchange) <span class="token punctuation">&#123;</span>                ctx.fillText(git_monthchange<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> monthindexlist<span class="token punctuation">,</span> 0.7 * linemaxwitdh);                monthindexlist = monthindexlist + width / 12            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        c.onmousemove = function (event) <span class="token punctuation">&#123;</span>            if (document.querySelector('.gitmessage')) <span class="token punctuation">&#123;</span>                git_tooltip_container.innerHTML = ""            <span class="token punctuation">&#125;</span>            getMousePos(c<span class="token punctuation">,</span> event)        <span class="token punctuation">&#125;</span>;        git_tooltip_container.onmousemove = function (event) <span class="token punctuation">&#123;</span>            if (document.querySelector('.gitmessage')) <span class="token punctuation">&#123;</span>                git_tooltip_container.innerHTML = ""            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>;        function getMousePos(canvas<span class="token punctuation">,</span> event) <span class="token punctuation">&#123;</span>            var rect = canvas.getBoundingClientRect();            var x = event.clientX <span class="token punctuation">-</span> rect.left * (canvas.width / rect.width);            var y = event.clientY <span class="token punctuation">-</span> rect.top * (canvas.height / rect.height);            for (var item of git_positionplusdata) <span class="token punctuation">&#123;</span>                var lenthx = x <span class="token punctuation">-</span> item.x;                var lenthy = y <span class="token punctuation">-</span> item.y;                if (0 &lt; lenthx <span class="token important">&amp;&amp;</span> lenthx &lt; lineminwitdh) <span class="token punctuation">&#123;</span>                    if (0 &lt; lenthy <span class="token important">&amp;&amp;</span> lenthy &lt; lineminwitdh) <span class="token punctuation">&#123;</span>                        git_span1 = item.date;                        git_span2 = item.count;                        git_x = event.clientX <span class="token punctuation">-</span> 100;                        git_y = event.clientY <span class="token punctuation">-</span> 60;                        html = tooltip_html(git_x<span class="token punctuation">,</span> git_y<span class="token punctuation">,</span> git_span1<span class="token punctuation">,</span> git_span2);                        append_div_gitcalendar(git_tooltip_container<span class="token punctuation">,</span> html)                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    function addlastmonth() <span class="token punctuation">&#123;</span>        if (git_thisdayindex === 0) <span class="token punctuation">&#123;</span>            thisweekcore(52);            thisweekcore(51);            thisweekcore(50);            thisweekcore(49);            thisweekcore(48);            git_thisweekdatacore += git_firstdate<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>.count;            git_amonthago = git_firstdate<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>.date        <span class="token punctuation">&#125;</span> else <span class="token punctuation">&#123;</span>            thisweekcore(52);            thisweekcore(51);            thisweekcore(50);            thisweekcore(49);            thisweek2core();            git_amonthago = git_first2date<span class="token punctuation">[</span>git_thisdayindex <span class="token punctuation">-</span> <span class="token number">1</span><span class="token punctuation">]</span>.date        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    function thisweek2core() <span class="token punctuation">&#123;</span>        for (var i = git_thisdayindex <span class="token punctuation">-</span> 1; i &lt; git_first2date.length; i++) <span class="token punctuation">&#123;</span>            git_thisweekdatacore += git_first2date<span class="token punctuation">[</span>i<span class="token punctuation">]</span>.count        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    function thisweekcore(index) <span class="token punctuation">&#123;</span>        for (var item of git_data<span class="token punctuation">[</span>index<span class="token punctuation">]</span>) <span class="token punctuation">&#123;</span>            git_thisweekdatacore += item.count        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    function addlastweek() <span class="token punctuation">&#123;</span>        for (var item of git_lastweek) <span class="token punctuation">&#123;</span>            git_weekdatacore += item.count        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    function addbeforeweek() <span class="token punctuation">&#123;</span>        for (var i = git_thisdayindex; i &lt; git_beforeweek.length; i++) <span class="token punctuation">&#123;</span>            git_weekdatacore += git_beforeweek<span class="token punctuation">[</span>i<span class="token punctuation">]</span>.count        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    function addweek(data) <span class="token punctuation">&#123;</span>        if (git_thisdayindex === 6) <span class="token punctuation">&#123;</span>            git_aweekago = git_lastweek<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.date;            addlastweek()        <span class="token punctuation">&#125;</span> else <span class="token punctuation">&#123;</span>            lastweek = data.contributions<span class="token punctuation">[</span><span class="token number">51</span><span class="token punctuation">]</span>;            git_aweekago = lastweek<span class="token punctuation">[</span>git_thisdayindex + 1<span class="token punctuation">]</span>.date;            addlastweek();            addbeforeweek()        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    fetch(git_githubapiurl).then(data =<span class="token punctuation">></span> data.json()).then(data =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>        git_data = data.contributions;        git_total = data.total;        git_first2date = git_data<span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span>;        git_firstdate = git_data<span class="token punctuation">[</span><span class="token number">47</span><span class="token punctuation">]</span>;        git_firstweek = data.contributions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>;        git_lastweek = data.contributions<span class="token punctuation">[</span><span class="token number">52</span><span class="token punctuation">]</span>;        git_beforeweek = data.contributions<span class="token punctuation">[</span><span class="token number">51</span><span class="token punctuation">]</span>;        git_thisdayindex = git_lastweek.length <span class="token punctuation">-</span> 1;        git_thisday = git_lastweek<span class="token punctuation">[</span>git_thisdayindex<span class="token punctuation">]</span>.date;        git_oneyearbeforeday = git_firstweek<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.date;        git_monthindex = git_thisday.substring(5<span class="token punctuation">,</span> 7) * 1;        git_montharrbefore = git_month.splice(git_monthindex<span class="token punctuation">,</span> 12 <span class="token punctuation">-</span> git_monthindex);        git_monthchange = git_montharrbefore.concat(git_month);        addweek(data);        addlastmonth();        var html = github_main_box(git_monthchange<span class="token punctuation">,</span> git_data<span class="token punctuation">,</span> git_user<span class="token punctuation">,</span> git_color<span class="token punctuation">,</span> git_total<span class="token punctuation">,</span> git_thisweekdatacore<span class="token punctuation">,</span> git_weekdatacore<span class="token punctuation">,</span> git_oneyearbeforeday<span class="token punctuation">,</span> git_thisday<span class="token punctuation">,</span> git_aweekago<span class="token punctuation">,</span> git_amonthago);        append_div_gitcalendar(github_container<span class="token punctuation">,</span> html);        if(document.getElementById('github_loading'))<span class="token punctuation">&#123;</span>            document.getElementById('github_loading').remove()<span class="token punctuation">&#125;</span>;        responsiveChart()    <span class="token punctuation">&#125;</span>).catch(function (error) <span class="token punctuation">&#123;</span>        console.log(error)    <span class="token punctuation">&#125;</span>);      window.addEventListener('resize'<span class="token punctuation">,</span> function () <span class="token punctuation">&#123;</span>        responsiveChart()    <span class="token punctuation">&#125;</span>)    window.addEventListener('scroll'<span class="token punctuation">,</span> function () <span class="token punctuation">&#123;</span>      if (document.querySelector('.gitmessage')) <span class="token punctuation">&#123;</span>        git_tooltip_container.innerHTML = ""    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>)    var git_thiscolor = (color<span class="token punctuation">,</span> x) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>        if (x === 0) <span class="token punctuation">&#123;</span>            var i = parseInt(x / 2);            return color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span> else if (x &lt; 2) <span class="token punctuation">&#123;</span>            return color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span> else if (x &lt; 20) <span class="token punctuation">&#123;</span>            var i = parseInt(x / 2);            return color<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span> else <span class="token punctuation">&#123;</span>            return color<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>;    var tooltip_html = (x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> span1<span class="token punctuation">,</span> span2) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>        var html = '';        <span class="token key atrule">html += '&lt;div class="gitmessage" style="top:' + y + 'px;left:' + x + 'px;position</span><span class="token punctuation">:</span> fixed;z<span class="token punctuation">-</span>index<span class="token punctuation">:</span>9999"<span class="token punctuation">></span>&lt;div class="angle<span class="token punctuation">-</span>wrapper" style="display<span class="token punctuation">:</span>block;"<span class="token punctuation">></span>&lt;span<span class="token punctuation">></span>' + span1 + '<span class="token important">&amp;nbsp;&lt;/span>&lt;span>'</span> + span2 + ' 次上传&lt;/span<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>';        return html    <span class="token punctuation">&#125;</span>;    var github_canvas_box = () =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>        <span class="token key atrule">var html = '&lt;div id="gitcalendarcanvasbox"> &lt;canvas id="gitcanvas" style="animation</span><span class="token punctuation">:</span> none;"<span class="token punctuation">></span>&lt;/canvas<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>';        return html    <span class="token punctuation">&#125;</span>;    var github_info_box = (user<span class="token punctuation">,</span> color) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>        var html = '';        html += '&lt;div id="git_tooltip_container"<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>&lt;div class="contrib<span class="token punctuation">-</span>footer clearfix mt<span class="token punctuation">-</span>1 mx<span class="token punctuation">-</span>3 px<span class="token punctuation">-</span>3 pb<span class="token punctuation">-</span>1"<span class="token punctuation">></span>&lt;div class="float<span class="token punctuation">-</span>left text<span class="token punctuation">-</span>gray"<span class="token punctuation">></span>数据来源 &lt;a href="https<span class="token punctuation">:</span>//github.com/' + user + '" target="blank"<span class="token punctuation">></span>@' + user + '&lt;/a<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>&lt;div class="contrib<span class="token punctuation">-</span>legend text<span class="token punctuation">-</span>gray"<span class="token punctuation">></span>Less &lt;ul class="legend"<span class="token punctuation">></span>&lt;li style="background<span class="token punctuation">-</span>color<span class="token punctuation">:</span>' + color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> + '"<span class="token punctuation">></span>&lt;/li<span class="token punctuation">></span>&lt;li style="background<span class="token punctuation">-</span>color<span class="token punctuation">:</span>' + color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> + '"<span class="token punctuation">></span>&lt;/li<span class="token punctuation">></span>&lt;li style="background<span class="token punctuation">-</span>color<span class="token punctuation">:</span>' + color<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> + '"<span class="token punctuation">></span>&lt;/li<span class="token punctuation">></span>&lt;li style="background<span class="token punctuation">-</span>color<span class="token punctuation">:</span>' + color<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> + '"<span class="token punctuation">></span>&lt;/li<span class="token punctuation">></span>&lt;li style="background<span class="token punctuation">-</span>color<span class="token punctuation">:</span>' + color<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> + '"<span class="token punctuation">></span>&lt;/li<span class="token punctuation">></span>&lt;/ul<span class="token punctuation">></span>More &lt;/div<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>';        return html    <span class="token punctuation">&#125;</span>;    var github_main_box = (monthchange<span class="token punctuation">,</span> git_data<span class="token punctuation">,</span> user<span class="token punctuation">,</span> color<span class="token punctuation">,</span> total<span class="token punctuation">,</span> thisweekdatacore<span class="token punctuation">,</span> weekdatacore<span class="token punctuation">,</span> oneyearbeforeday<span class="token punctuation">,</span> thisday<span class="token punctuation">,</span> aweekago<span class="token punctuation">,</span> amonthago) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>        var html = '';        var canvasbox = github_canvas_box();        var infobox = github_info_box(user<span class="token punctuation">,</span> color);        var style = github_main_style();        html += '&lt;div class="position<span class="token punctuation">-</span>relative"<span class="token punctuation">></span>&lt;div class="border py<span class="token punctuation">-</span>2 graph<span class="token punctuation">-</span>before<span class="token punctuation">-</span>activity<span class="token punctuation">-</span>overview"<span class="token punctuation">></span>&lt;div class="js<span class="token punctuation">-</span>gitcalendar<span class="token punctuation">-</span>graph mx<span class="token punctuation">-</span>md<span class="token punctuation">-</span>2 mx<span class="token punctuation">-</span>3 d<span class="token punctuation">-</span>flex flex<span class="token punctuation">-</span>column flex<span class="token punctuation">-</span>items<span class="token punctuation">-</span>end flex<span class="token punctuation">-</span>xl<span class="token punctuation">-</span>items<span class="token punctuation">-</span>center overflow<span class="token punctuation">-</span>hidden pt<span class="token punctuation">-</span>1 is<span class="token punctuation">-</span>graph<span class="token punctuation">-</span>loading graph<span class="token punctuation">-</span>canvas gitcalendar<span class="token punctuation">-</span>graph height<span class="token punctuation">-</span>full text<span class="token punctuation">-</span>center"<span class="token punctuation">></span>' + canvasbox + '&lt;/div<span class="token punctuation">></span>' + infobox + '&lt;/div<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>';        html += '&lt;div style="display<span class="token punctuation">:</span>flex;width<span class="token punctuation">:</span>100%"<span class="token punctuation">></span>&lt;div class="contrib<span class="token punctuation">-</span>column contrib<span class="token punctuation">-</span>column<span class="token punctuation">-</span>first table<span class="token punctuation">-</span>column"<span class="token punctuation">></span>&lt;span class="text<span class="token punctuation">-</span>muted"<span class="token punctuation">></span>过去一年提交&lt;/span<span class="token punctuation">></span>&lt;span class="contrib<span class="token punctuation">-</span>number"<span class="token punctuation">></span>' + total + '&lt;/span<span class="token punctuation">></span>&lt;span class="text<span class="token punctuation">-</span>muted"<span class="token punctuation">></span>' + oneyearbeforeday + '<span class="token important">&amp;nbsp;-&amp;nbsp;'</span> + thisday + '&lt;/span<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>&lt;div class="contrib<span class="token punctuation">-</span>column table<span class="token punctuation">-</span>column"<span class="token punctuation">></span>&lt;span class="text<span class="token punctuation">-</span>muted"<span class="token punctuation">></span>最近一月提交&lt;/span<span class="token punctuation">></span>&lt;span class="contrib<span class="token punctuation">-</span>number"<span class="token punctuation">></span>' + thisweekdatacore + '&lt;/span<span class="token punctuation">></span>&lt;span class="text<span class="token punctuation">-</span>muted"<span class="token punctuation">></span>' + amonthago + '<span class="token important">&amp;nbsp;-&amp;nbsp;'</span> + thisday + '&lt;/span<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>&lt;div class="contrib<span class="token punctuation">-</span>column table<span class="token punctuation">-</span>column"<span class="token punctuation">></span>&lt;span class="text<span class="token punctuation">-</span>muted"<span class="token punctuation">></span>最近一周提交&lt;/span<span class="token punctuation">></span>&lt;span class="contrib<span class="token punctuation">-</span>number"<span class="token punctuation">></span>' + weekdatacore + '&lt;/span<span class="token punctuation">></span>&lt;span class="text<span class="token punctuation">-</span>muted"<span class="token punctuation">></span>' + aweekago + '<span class="token important">&amp;nbsp;-&amp;nbsp;'</span> + thisday + '&lt;/span<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>' + style;        return html    <span class="token punctuation">&#125;</span>;    var github_main_style = () =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>        style = '&lt;style<span class="token punctuation">></span><span class="token comment">#github_container&#123;text-align:center;margin:0 auto;width:100%;display:flex;display:-webkit-flex;justify-content:center;align-items:center;flex-wrap:wrap;&#125;.gitcalendar-graph text.wday,.gitcalendar-graph text.month&#123;font-size:10px;fill:#aaa;&#125;.contrib-legend&#123;text-align:right;padding:0 14px 10px 0;display:inline-block;float:right;&#125;.contrib-legend .legend&#123;display:inline-block;list-style:none;margin:0 5px;position:relative;bottom:-1px;padding:0;&#125;.contrib-legend .legend li&#123;display:inline-block;width:10px;height:10px;&#125;.text-small&#123;font-size:12px;color:#767676;&#125;.gitcalendar-graph&#123;padding:15px 0 0;text-align:center;&#125;.contrib-column&#123;text-align:center;border-left:1px solid #ddd;border-top:1px solid #ddd;font-size:11px;&#125;.contrib-column-first&#123;border-left:0;&#125;.table-column&#123;padding:10px;display:table-cell;flex:1;vertical-align:top;&#125;.contrib-number&#123;font-weight:300;line-height:1.3em;font-size:24px;display:block;&#125;.gitcalendar img.spinner&#123;width:70px;margin-top:50px;min-height:70px;&#125;.monospace&#123;text-align:center;color:#000;font-family:monospace;&#125;.monospace a&#123;color:#1D75AB;text-decoration:none;&#125;.contrib-footer&#123;font-size:11px;padding:0 10px 12px;text-align:left;width:100%;box-sizing:border-box;height:26px;&#125;.left.text-muted&#123;float:left;margin-left:9px;color:#767676;&#125;.left.text-muted a&#123;color:#4078c0;text-decoration:none;&#125;.left.text-muted a:hover,.monospace a:hover&#123;text-decoration:underline;&#125;h2.f4.text-normal.mb-3&#123;display:none;&#125;.float-left.text-gray&#123;float:left;&#125;#user-activity-overview&#123;display:none;&#125;.day-tooltip&#123;white-space:nowrap;position:absolute;z-index:99999;padding:10px;font-size:12px;color:#959da5;text-align:center;background:rgba(0,0,0,.85);border-radius:3px;display:none;pointer-events:none;&#125;.day-tooltip strong&#123;color:#dfe2e5;&#125;.day-tooltip.is-visible&#123;display:block;&#125;.day-tooltip:after&#123;position:absolute;bottom:-10px;left:50%;width:5px;height:5px;box-sizing:border-box;margin:0 0 0 -5px;content:" ";border:5px solid transparent;border-top-color:rgba(0,0,0,.85)&#125;.position-relative&#123;width:100%;&#125;@media screen and (max-width:650px)&#123;.contrib-column&#123;display:none&#125;&#125;.angle-wrapper&#123;z-index:9999;display:inline;width:200px;height:40px;position:relative;padding:5px 0;background:rgba(0,0,0,0.8);border-radius:8px;text-align:center;color:white;&#125;.angle-box&#123;position:fixed;padding:10px&#125;.angle-wrapper span&#123;padding-bottom:1em;&#125;.angle-wrapper:before&#123;content:"";width:0;height:0;border:10px solid transparent;border-top-color:rgba(0,0,0,0.8);position:absolute;left:47.5%;top:100%;&#125;&lt;/style>';</span>        return style    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>;var append_div_gitcalendar = (parent<span class="token punctuation">,</span> text) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>    if (typeof text === 'string') <span class="token punctuation">&#123;</span>        var temp = document.createElement('div');        temp.innerHTML = text;        var frag = document.createDocumentFragment();        while (temp.firstChild) <span class="token punctuation">&#123;</span>            frag.appendChild(temp.firstChild)        <span class="token punctuation">&#125;</span>        parent.appendChild(frag)    <span class="token punctuation">&#125;</span> else <span class="token punctuation">&#123;</span>        parent.appendChild(text)    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>;var loading_git = (color) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>    <span class="token key atrule">loading = '&lt;div id="github_loading" style="width:10%;height:100%;margin:0 auto;display</span><span class="token punctuation">:</span> block"<span class="token punctuation">></span>&lt;svg xmlns="http<span class="token punctuation">:</span>//www.w3.org/2000/svg" xmlns<span class="token punctuation">:</span>xlink="http<span class="token punctuation">:</span>//www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable<span class="token punctuation">-</span>background<span class="token punctuation">:</span>new 0 0 50 50" xml<span class="token punctuation">:</span>space="preserve"<span class="token punctuation">></span>&lt;path fill="' + color + '" d="M25.251<span class="token punctuation">,</span>6.461c<span class="token punctuation">-</span><span class="token number">10.318</span><span class="token punctuation">,</span>0<span class="token punctuation">-</span><span class="token number">18.683</span><span class="token punctuation">,</span>8.365<span class="token punctuation">-</span><span class="token number">18.683</span><span class="token punctuation">,</span>18.683h4.068c0<span class="token punctuation">-</span><span class="token number">8.071</span><span class="token punctuation">,</span>6.543<span class="token punctuation">-</span><span class="token number">14.615</span><span class="token punctuation">,</span>14.615<span class="token punctuation">-</span>14.615V6.461z" transform="rotate(275.098 25 25)"<span class="token punctuation">></span>&lt;animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"<span class="token punctuation">></span>&lt;/animateTransform<span class="token punctuation">></span>&lt;/path<span class="token punctuation">></span>&lt;/svg<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>';    return loading<span class="token punctuation">&#125;</span>;(function()<span class="token punctuation">&#123;</span>    var git_user = 'yuang01'; // 这里更改为你的github 用户名    var github_container = document.getElementById('github_container');    var github_loading = document.getElementById('github_loading');    var git_purple = <span class="token punctuation">[</span><span class="token string">'#ebedf0'</span><span class="token punctuation">,</span> <span class="token string">'#fdcdec'</span><span class="token punctuation">,</span> <span class="token string">'#fc9bd9'</span><span class="token punctuation">,</span> <span class="token string">'#fa6ac5'</span><span class="token punctuation">,</span> <span class="token string">'#f838b2'</span><span class="token punctuation">,</span> <span class="token string">'#f5089f'</span><span class="token punctuation">,</span> <span class="token string">'#c4067e'</span><span class="token punctuation">,</span> <span class="token string">'#92055e'</span><span class="token punctuation">,</span> <span class="token string">'#540336'</span><span class="token punctuation">,</span> <span class="token string">'#48022f'</span><span class="token punctuation">,</span> <span class="token string">'#30021f'</span><span class="token punctuation">,</span><span class="token punctuation">]</span>;    var git_green = <span class="token punctuation">[</span><span class="token string">'#ebedf0'</span><span class="token punctuation">,</span> <span class="token string">'#f0fff4'</span><span class="token punctuation">,</span> <span class="token string">'#dcffe4'</span><span class="token punctuation">,</span> <span class="token string">'#bef5cb'</span><span class="token punctuation">,</span> <span class="token string">'#85e89d'</span><span class="token punctuation">,</span> <span class="token string">'#34d058'</span><span class="token punctuation">,</span> <span class="token string">'#28a745'</span><span class="token punctuation">,</span> <span class="token string">'#22863a'</span><span class="token punctuation">,</span> <span class="token string">'#176f2c'</span><span class="token punctuation">,</span> <span class="token string">'#165c26'</span><span class="token punctuation">,</span> <span class="token string">'#144620'</span><span class="token punctuation">]</span>;    var git_blue = <span class="token punctuation">[</span><span class="token string">'#ebedf0'</span><span class="token punctuation">,</span> <span class="token string">'#f1f8ff'</span><span class="token punctuation">,</span> <span class="token string">'#dbedff'</span><span class="token punctuation">,</span> <span class="token string">'#c8e1ff'</span><span class="token punctuation">,</span> <span class="token string">'#79b8ff'</span><span class="token punctuation">,</span> <span class="token string">'#2188ff'</span><span class="token punctuation">,</span> <span class="token string">'#0366d6'</span><span class="token punctuation">,</span> <span class="token string">'#005cc5'</span><span class="token punctuation">,</span> <span class="token string">'#044289'</span><span class="token punctuation">,</span> <span class="token string">'#032f62'</span><span class="token punctuation">,</span> <span class="token string">'#05264c'</span><span class="token punctuation">,</span><span class="token punctuation">]</span>;    var git_color = git_green;    if (github_container) <span class="token punctuation">&#123;</span>      append_div_gitcalendar(github_container<span class="token punctuation">,</span> loading_git(git_color<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>));      github_canlendar(git_user<span class="token punctuation">,</span> git_color)    <span class="token punctuation">&#125;</span> else <span class="token punctuation">&#123;</span>      console.log('nonono');    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>)()    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><p>将 270行的<code>git_user</code>改为你自己的用户名<br>然后在 自定义侧边栏的home_widget(_data/widget.yaml文件)中写入以下内容:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">home_widget</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> my_github_container    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> my_github_container    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 测试日历    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>envelope    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> blue    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '      &lt;div id="github_container"<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>      &lt;script data<span class="token punctuation">-</span>pjax src="/githubcalendar/index.js"<span class="token punctuation">></span>&lt;/script<span class="token punctuation">></span>    '<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后就会在首页出现github日历图</p><h3 id="添加IP签名档"><a href="#添加IP签名档" class="headerlink" title="添加IP签名档"></a>添加IP签名档</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">home_widget</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> welcome    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> welcome    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 欢迎    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>envelope    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> blue    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> <span class="token string">'&lt;img src="https://api.amogu.cn/api/ipimg/" style="width:100%">'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="添加轮播图"><a href="#添加轮播图" class="headerlink" title="添加轮播图"></a>添加轮播图</h3><p>同样在<code>source</code>文件夹下创建<code>mySwiper/index.js</code>和<code>mySwiper/index.css</code>文件，然后创建<code>mySwiper/img</code>文件夹，用于存放图片，轮播图嘛，肯定要图片。</p><details green><summary pointer> mySwiper/index.js </summary>              <div class='content'>              <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">// 如果想变换轮播方式等，进阶的话，可以看这个 https<span class="token punctuation">:</span>//github.surmon.me/vue<span class="token punctuation">-</span>awesome<span class="token punctuation">-</span>swiper/// 当然你也可以引入jquery插件，都可以的<span class="token punctuation">,</span> 不只是轮播图，其他特效也可以new Vue(<span class="token punctuation">&#123;</span>  <span class="token key atrule">el</span><span class="token punctuation">:</span> <span class="token string">"#mySwiper"</span><span class="token punctuation">,</span>  <span class="token key atrule">data</span><span class="token punctuation">:</span> function () <span class="token punctuation">&#123;</span>    return <span class="token punctuation">&#123;</span>      <span class="token key atrule">swiperOption</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token key atrule">direction</span><span class="token punctuation">:</span> <span class="token string">"vertical"</span><span class="token punctuation">,</span> // 这个是竖着的        <span class="token key atrule">slidesPerView</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token key atrule">spaceBetween</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>        <span class="token key atrule">mousewheel</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>        // 注释上面的四个，则水平方向轮播        <span class="token key atrule">pagination</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>          <span class="token key atrule">el</span><span class="token punctuation">:</span> <span class="token string">".swiper-pagination"</span><span class="token punctuation">,</span>          <span class="token key atrule">clickable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        // 注释掉上面这个，则不显示小点点        <span class="token key atrule">loop</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span> // 循环        <span class="token key atrule">autoplay</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>          <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token number">2500</span><span class="token punctuation">,</span>          <span class="token key atrule">disableOnInteraction</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> // 自动播放<span class="token punctuation">,</span>注释掉则不自动播放        <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>          <span class="token key atrule">init</span><span class="token punctuation">:</span> function () <span class="token punctuation">&#123;</span>            swiperAnimateCache(this); //隐藏动画元素            swiperAnimate(this); //初始化完成开始动画          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token key atrule">slideChangeTransitionEnd</span><span class="token punctuation">:</span> function () <span class="token punctuation">&#123;</span>            swiperAnimate(this); //每个slide切换结束时也运行当前slide动画          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        // or data<span class="token punctuation">-</span>swiper<span class="token punctuation">-</span>parallax="<span class="token punctuation">-</span>100"        // 上面是文字动画效果，注释则取消文字动画，动画效果参见 https<span class="token punctuation">:</span>//www.swiper.com.cn/usage/animate/index.html      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>;  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token key atrule">computed</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>    swiper() <span class="token punctuation">&#123;</span>      return this.$refs.myswiper.$swiper;    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token key atrule">methods</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>    // 鼠标移入停止轮播    stopAutoPlay() <span class="token punctuation">&#123;</span>      this.swiperOption.autoplay <span class="token important">&amp;&amp;</span> this.swiper.autoplay.stop();    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    // 鼠标移出开始轮播    startAutoPlay() <span class="token punctuation">&#123;</span>      this.swiperOption.autoplay <span class="token important">&amp;&amp;</span> this.swiper.autoplay.start();    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><details cyan><summary pointer> mySwiper/index.css </summary>              <div class='content'>              <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">.myswiper .swiper<span class="token punctuation">-</span>slide <span class="token punctuation">&#123;</span>    <span class="token key atrule">position</span><span class="token punctuation">:</span> relative;<span class="token punctuation">&#125;</span>.myswiper .swiper<span class="token punctuation">-</span>slide p <span class="token punctuation">&#123;</span>    <span class="token key atrule">position</span><span class="token punctuation">:</span> absolute;    <span class="token key atrule">font-size</span><span class="token punctuation">:</span> 18px;    <span class="token key atrule">top</span><span class="token punctuation">:</span> 50px;    <span class="token key atrule">left</span><span class="token punctuation">:</span> 10px;    <span class="token key atrule">z-index</span><span class="token punctuation">:</span> 9999;    <span class="token key atrule">color</span><span class="token punctuation">:</span> <span class="token comment">#fff;</span><span class="token punctuation">&#125;</span>.myswiper .swiper<span class="token punctuation">-</span>slide a.toPath <span class="token punctuation">&#123;</span>    <span class="token key atrule">display</span><span class="token punctuation">:</span> block;    <span class="token key atrule">width</span><span class="token punctuation">:</span> 100%;    <span class="token key atrule">height</span><span class="token punctuation">:</span> 100%;<span class="token punctuation">&#125;</span>.myswiper .swiper<span class="token punctuation">-</span>slide h2 <span class="token punctuation">&#123;</span>    <span class="token key atrule">position</span><span class="token punctuation">:</span> absolute;    <span class="token key atrule">top</span><span class="token punctuation">:</span> 10px;    <span class="token key atrule">left</span><span class="token punctuation">:</span> 10px;    <span class="token key atrule">z-index</span><span class="token punctuation">:</span> 9999;    <span class="token key atrule">color</span><span class="token punctuation">:</span> <span class="token comment">#fff;</span>    <span class="token key atrule">font-size</span><span class="token punctuation">:</span> 24px;<span class="token punctuation">&#125;</span>.myswiper .swiper<span class="token punctuation">-</span>slide img <span class="token punctuation">&#123;</span>    <span class="token key atrule">filter</span><span class="token punctuation">:</span> brightness(0.8); /* 图片变暗 <span class="token punctuation">,</span>字体看得清 <span class="token important">*/</span><span class="token punctuation">&#125;</span>.myswiper.swiper<span class="token punctuation">-</span>container<span class="token punctuation">-</span>vertical .swiper<span class="token punctuation">-</span>pagination<span class="token punctuation">-</span>bullet<span class="token punctuation">-</span>active <span class="token punctuation">&#123;</span>    <span class="token key atrule">height</span><span class="token punctuation">:</span> 30px;    <span class="token key atrule">border-radius</span><span class="token punctuation">:</span> 10px;    <span class="token key atrule">transition</span><span class="token punctuation">:</span> all 0.3s;<span class="token punctuation">&#125;</span>/* 暗黑模式样式在  .darkModel <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>  类下 <span class="token important">*/</span>/* 例如     .darkModel .aaa <span class="token punctuation">&#123;</span>        <span class="token key atrule">color</span><span class="token punctuation">:</span> <span class="token comment">#c9d1d9;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token important">*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><p>最后在自定义侧边栏的<code>home_widget</code>写上</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">home_widget</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> test2_swiper    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> test2_swiper    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 测试轮播图    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>envelope    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> blue    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '    &lt;div id="mySwiper" @mouseenter="stopAutoPlay()" @mouseleave="startAutoPlay()"<span class="token punctuation">></span>      &lt;swiper class="myswiper" ref="myswiper" style="height<span class="token punctuation">:</span>350px;" <span class="token punctuation">:</span>options="swiperOption"<span class="token punctuation">></span>        &lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>          &lt;a href="http<span class="token punctuation">:</span>//baidu.com" class="toPath"<span class="token punctuation">></span>            <span class="token key atrule">&lt;img class="no-lazy" src="/mySwiper/img/2.jpg" style="width:100%;height:100%;object-fit</span><span class="token punctuation">:</span> cover;"<span class="token punctuation">></span>            &lt;h2 class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是标题&lt;/h2<span class="token punctuation">></span>            &lt;p class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是描述哦&lt;/p<span class="token punctuation">></span>          &lt;/a<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>          &lt;a href="http<span class="token punctuation">:</span>//baidu.com" class="toPath"<span class="token punctuation">></span>            <span class="token key atrule">&lt;img class="no-lazy" src="/mySwiper/img/3.jpg" style="width:100%;height:100%;object-fit</span><span class="token punctuation">:</span> cover;"<span class="token punctuation">></span>            &lt;h2 class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是标题2&lt;/h2<span class="token punctuation">></span>            &lt;p class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是描述2&lt;/p<span class="token punctuation">></span>          &lt;/a<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>          &lt;a href="http<span class="token punctuation">:</span>//baidu.com" class="toPath"<span class="token punctuation">></span>            <span class="token key atrule">&lt;img class="no-lazy" src="/mySwiper/img/4.jpg" style="width:100%;height:100%;object-fit</span><span class="token punctuation">:</span> cover;"<span class="token punctuation">></span>            &lt;h2 class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是标题3&lt;/h2<span class="token punctuation">></span>            &lt;p class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是描述3&lt;/p<span class="token punctuation">></span>          &lt;/a<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>          &lt;a href="http<span class="token punctuation">:</span>//baidu.com" class="toPath"<span class="token punctuation">></span>            <span class="token key atrule">&lt;img class="no-lazy" src="/mySwiper/img/5.jpg" style="width:100%;height:100%;object-fit</span><span class="token punctuation">:</span> cover;"<span class="token punctuation">></span>            &lt;h2 class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是标题4&lt;/h2<span class="token punctuation">></span>            &lt;p class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是描述4&lt;/p<span class="token punctuation">></span>          &lt;/a<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>          &lt;a href="http<span class="token punctuation">:</span>//baidu.com" class="toPath"<span class="token punctuation">></span>            <span class="token key atrule">&lt;img class="no-lazy" src="https://api.dujin.org/pic/ghibli/" style="width:100%;height:100%;object-fit</span><span class="token punctuation">:</span> cover;"<span class="token punctuation">></span>            &lt;h2 class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是标题5&lt;/h2<span class="token punctuation">></span>            &lt;p class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是描述5&lt;/p<span class="token punctuation">></span>          &lt;/a<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>          &lt;a href="http<span class="token punctuation">:</span>//baidu.com" class="toPath"<span class="token punctuation">></span>            <span class="token key atrule">&lt;img class="no-lazy" src="/mySwiper/img/7.jpg" style="width:100%;height:100%;object-fit</span><span class="token punctuation">:</span> cover;"<span class="token punctuation">></span>            &lt;h2 class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是标题6&lt;/h2<span class="token punctuation">></span>            &lt;p class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是描述6&lt;/p<span class="token punctuation">></span>          &lt;/a<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;<span class="token tag">!--</span> 如果你想继续增加轮播图，继续在下面写&lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>我是内容&lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>就行了 <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span><span class="token scalar string">        &lt;div class="swiper-pagination" slot="pagination">&lt;/div></span>      &lt;/swiper<span class="token punctuation">></span>    &lt;/div<span class="token punctuation">></span>    &lt;script src="/mySwiper/index.js"<span class="token punctuation">></span>&lt;/script<span class="token punctuation">></span>    &lt;link href="/mySwiper/index.css" rel="stylesheet"<span class="token punctuation">></span>    '<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意，请自行修改a链接地址和图片地址和标题名称和描述</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>swiper-slide</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://baidu.com<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>toPath<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token comment">&lt;!-- a链接地址 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>no-lazy<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/mySwiper/img/2.jpg<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">object-fit</span><span class="token punctuation">:</span> cover<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>  <span class="token comment">&lt;!-- 图片地址 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ani<span class="token punctuation">"</span></span> <span class="token attr-name">swiper-animate-effect</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fadeInDown<span class="token punctuation">"</span></span> <span class="token attr-name">swiper-animate-duration</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.5s<span class="token punctuation">"</span></span> <span class="token attr-name">swiper-animate-delay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.3s<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>我是标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!-- 修改标题名称 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ani<span class="token punctuation">"</span></span> <span class="token attr-name">swiper-animate-effect</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fadeInDown<span class="token punctuation">"</span></span> <span class="token attr-name">swiper-animate-duration</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.5s<span class="token punctuation">"</span></span> <span class="token attr-name">swiper-animate-delay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.3s<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>我是描述哦<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!-- 修改描述 --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>swiper-slide</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你想加轮播图或者删除轮播图，则增加或者删除上面这个模块就行了，这样，一个轮播图就放在了首页。</p><h3 id="横向滚动特效"><a href="#横向滚动特效" class="headerlink" title="横向滚动特效"></a>横向滚动特效</h3><p>首先需要在source文件夹下创建bli/index.js和bli/index.css文件</p><details green><summary pointer> bli/index.js </summary>              <div class='content'>              <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">// 主题已经默认cdn引入了vue<span class="token punctuation">-</span>seamless<span class="token punctuation">-</span>scroll插件// https<span class="token punctuation">:</span>//chenxuan0000.github.io/vue<span class="token punctuation">-</span>seamless<span class="token punctuation">-</span>scroll/zh/guide/01<span class="token punctuation">-</span>basic.htmlnew Vue(<span class="token punctuation">&#123;</span>  <span class="token key atrule">el</span><span class="token punctuation">:</span> <span class="token string">"#myBli"</span><span class="token punctuation">,</span> <span class="token key atrule">// el不要是最外面的id_name，应该是html</span><span class="token punctuation">:</span> ''里的div的id  <span class="token key atrule">data</span><span class="token punctuation">:</span> function () <span class="token punctuation">&#123;</span>    return <span class="token punctuation">&#123;</span>      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token key atrule">listData</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token key atrule">classOption</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token key atrule">limitMoveNum</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>        <span class="token key atrule">direction</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>;  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token key atrule">methods</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><details green><summary pointer> bli/index.css </summary>              <div class='content'>              <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#myBli .warp &#123;</span>  <span class="token key atrule">width</span><span class="token punctuation">:</span> 100%;  <span class="token key atrule">height</span><span class="token punctuation">:</span> 120px;  <span class="token key atrule">margin</span><span class="token punctuation">:</span> 0 auto;  <span class="token key atrule">overflow</span><span class="token punctuation">:</span> hidden;<span class="token punctuation">&#125;</span><span class="token comment">#myBli .warp ul &#123;</span>  <span class="token key atrule">list-style</span><span class="token punctuation">:</span> none;  <span class="token key atrule">padding</span><span class="token punctuation">:</span> 0;  <span class="token key atrule">margin</span><span class="token punctuation">:</span> 0 auto;<span class="token punctuation">&#125;</span><span class="token comment">#myBli .warp ul.ul-item &#123;</span>  <span class="token key atrule">display</span><span class="token punctuation">:</span> flex;<span class="token punctuation">&#125;</span><span class="token comment">#myBli .warp ul.ul-item .li-item &#123;</span>  <span class="token key atrule">width</span><span class="token punctuation">:</span> 120px;  <span class="token key atrule">display</span><span class="token punctuation">:</span> block;  <span class="token key atrule">height</span><span class="token punctuation">:</span> 120px;  <span class="token key atrule">margin-right</span><span class="token punctuation">:</span> 10px;  <span class="token key atrule">line-height</span><span class="token punctuation">:</span> 120px;  <span class="token key atrule">background-color</span><span class="token punctuation">:</span> <span class="token comment">#999;</span>  <span class="token key atrule">color</span><span class="token punctuation">:</span> <span class="token comment">#fff;</span>  <span class="token key atrule">text-align</span><span class="token punctuation">:</span> center;  <span class="token key atrule">font-size</span><span class="token punctuation">:</span> 30px;<span class="token punctuation">&#125;</span><span class="token comment">#myBli .warp ul.ul-item img &#123;</span>  <span class="token key atrule">width</span><span class="token punctuation">:</span> 100%;  <span class="token key atrule">height</span><span class="token punctuation">:</span> 100%;  <span class="token key atrule">object-fit</span><span class="token punctuation">:</span> cover;<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><p>最后在自定义侧边栏的home_widget中加入以下内容:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">home_widget</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> mybilibili    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> mybilibili    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 测试bli    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>envelope    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> blue    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '      &lt;div id="myBli"<span class="token punctuation">></span>        &lt;vue<span class="token punctuation">-</span>seamless<span class="token punctuation">-</span>scroll          <span class="token punctuation">:</span>data="listData"          <span class="token punctuation">:</span>class<span class="token punctuation">-</span>option="classOption"          class="warp"        <span class="token punctuation">></span>          &lt;ul class="ul<span class="token punctuation">-</span>item" style="width<span class="token punctuation">:</span>720px;"<span class="token punctuation">></span>            &lt;<span class="token tag">!--</span> 在这里改<span class="token punctuation">,</span> 手动修改a连接的href值和img的src值<span class="token punctuation">,</span> 如果你会进阶，你可以使用v<span class="token punctuation">-</span>for<span class="token punctuation">,</span> 或者数据使用动态数据<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span>                        &lt;li class="li<span class="token punctuation">-</span>item"<span class="token punctuation">></span>              &lt;a href="http<span class="token punctuation">:</span>//baidu.com"<span class="token punctuation">></span>                &lt;img class="no<span class="token punctuation">-</span>lazy" src="https<span class="token punctuation">:</span>//pic4.zhimg.com/80/v2<span class="token punctuation">-</span>f549722dac8f777693c090a92498de0f_1440w.jpg"<span class="token punctuation">></span>              &lt;/a<span class="token punctuation">></span>            &lt;/li<span class="token punctuation">></span>            &lt;li class="li<span class="token punctuation">-</span>item"<span class="token punctuation">></span>              &lt;a href="http<span class="token punctuation">:</span>//baidu.com"<span class="token punctuation">></span>                &lt;img class="no<span class="token punctuation">-</span>lazy" src="https<span class="token punctuation">:</span>//pic4.zhimg.com/80/v2<span class="token punctuation">-</span>f549722dac8f777693c090a92498de0f_1440w.jpg"<span class="token punctuation">></span>              &lt;/a<span class="token punctuation">></span>            &lt;/li<span class="token punctuation">></span>            &lt;li class="li<span class="token punctuation">-</span>item"<span class="token punctuation">></span>              &lt;a href="http<span class="token punctuation">:</span>//baidu.com"<span class="token punctuation">></span>                &lt;img class="no<span class="token punctuation">-</span>lazy" src="https<span class="token punctuation">:</span>//pic4.zhimg.com/80/v2<span class="token punctuation">-</span>f549722dac8f777693c090a92498de0f_1440w.jpg"<span class="token punctuation">></span>              &lt;/a<span class="token punctuation">></span>            &lt;/li<span class="token punctuation">></span>            &lt;li class="li<span class="token punctuation">-</span>item"<span class="token punctuation">></span>              &lt;a href="http<span class="token punctuation">:</span>//baidu.com"<span class="token punctuation">></span>                &lt;img class="no<span class="token punctuation">-</span>lazy" src="https<span class="token punctuation">:</span>//pic4.zhimg.com/80/v2<span class="token punctuation">-</span>f549722dac8f777693c090a92498de0f_1440w.jpg"<span class="token punctuation">></span>              &lt;/a<span class="token punctuation">></span>            &lt;/li<span class="token punctuation">></span>            &lt;li class="li<span class="token punctuation">-</span>item"<span class="token punctuation">></span>              &lt;a href="http<span class="token punctuation">:</span>//baidu.com"<span class="token punctuation">></span>                &lt;img class="no<span class="token punctuation">-</span>lazy" src="https<span class="token punctuation">:</span>//pic4.zhimg.com/80/v2<span class="token punctuation">-</span>f549722dac8f777693c090a92498de0f_1440w.jpg"<span class="token punctuation">></span>              &lt;/a<span class="token punctuation">></span>            &lt;/li<span class="token punctuation">></span>            &lt;li class="li<span class="token punctuation">-</span>item"<span class="token punctuation">></span>              &lt;a href="http<span class="token punctuation">:</span>//baidu.com"<span class="token punctuation">></span>                &lt;img class="no<span class="token punctuation">-</span>lazy" src="https<span class="token punctuation">:</span>//pic4.zhimg.com/80/v2<span class="token punctuation">-</span>f549722dac8f777693c090a92498de0f_1440w.jpg"<span class="token punctuation">></span>              &lt;/a<span class="token punctuation">></span>            &lt;/li<span class="token punctuation">></span>            &lt;<span class="token tag">!--</span> 在这里结束 <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span><span class="token scalar string">          &lt;/ul></span>        &lt;/vue<span class="token punctuation">-</span>seamless<span class="token punctuation">-</span>scroll<span class="token punctuation">></span>      &lt;/div<span class="token punctuation">></span>      &lt;script src="/bli/index.js"<span class="token punctuation">></span>&lt;/script<span class="token punctuation">></span>      &lt;link href="/bli/index.css" rel="stylesheet"<span class="token punctuation">></span>    '<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同样，自行修改上面a标签的链接和图片地址，至此横向滚动特效完成。</p><blockquote><p>注意，使用vue写法的话，图片需要带上class=”no-lazy”，否则可能加载不出来，，js原生或者jquery不需要带</p></blockquote><h3 id="侧边栏增加微博热搜"><a href="#侧边栏增加微博热搜" class="headerlink" title="侧边栏增加微博热搜"></a>侧边栏增加微博热搜</h3><p>同样同样，在source文件夹下创建weibo/index.js和weibo/index.css文件</p><details green><summary pointer> weibo/index.js </summary>              <div class='content'>              <pre class="line-numbers language-html" data-language="html"><code class="language-html">new Vue(&#123;  el: "#myWeibo", // el不要是最外面的id_name，应该是html: ''里的div的id  data: function () &#123;    return &#123;      content: [],      classOption: &#123;        singleHeight: 30,      &#125;,    &#125;;  &#125;,  created() &#123;    this.getWeiboList();  &#125;,  methods: &#123;    // 请求开源api, 获取历史上的今天数据    getWeiboList() &#123;      fetch("https://tenapi.cn/resou/", &#123;        method: "GET", // *GET, POST, PUT, DELETE, etc.      &#125;)        .then((res) => &#123;          return res.json();        &#125;)        .then((data) => &#123;          this.content = data.list;        &#125;)        .catch((err) => &#123;          console.log("err", err);        &#125;);    &#125;,  &#125;,&#125;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><details green><summary pointer> weibo/index.css </summary>              <div class='content'>              <pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.weibo-container</span> <span class="token punctuation">&#123;</span>    <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>    <span class="token property">line-height</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>    <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>    <span class="token property">justify-content</span><span class="token punctuation">:</span> space-between<span class="token punctuation">;</span>    <span class="token property">font-size</span><span class="token punctuation">:</span> 12px<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.weibo-container .left</span> <span class="token punctuation">&#123;</span>    <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.weibo-container .name</span> <span class="token punctuation">&#123;</span>    <span class="token property">margin-left</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>    <span class="token property">display</span><span class="token punctuation">:</span> -webkit-box<span class="token punctuation">;</span>    <span class="token property">-webkit-box-orient</span><span class="token punctuation">:</span> vertical<span class="token punctuation">;</span>    <span class="token property">-webkit-line-clamp</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>    <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">#myWeibo .warp</span> <span class="token punctuation">&#123;</span>    <span class="token property">height</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>    <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>    <span class="token property">margin</span><span class="token punctuation">:</span> 0 auto<span class="token punctuation">;</span>    <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.weibo-container .order</span> <span class="token punctuation">&#123;</span>    <span class="token property">color</span><span class="token punctuation">:</span> #fe962e<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.weibo-container .name a</span><span class="token punctuation">&#123;</span>    <span class="token property">color</span><span class="token punctuation">:</span> black<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.weibo-container .name a:hover</span> <span class="token punctuation">&#123;</span>    <span class="token property">text-decoration</span><span class="token punctuation">:</span> underline<span class="token punctuation">;</span>    <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.weibo-container .red</span> <span class="token punctuation">&#123;</span>    <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><p>最后在自定义侧边栏的widget_library_sticky或者widget_library中加入html,</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">widget_library_sticky</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> testWidget    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> testWidget    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 微博热搜    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fab fa<span class="token punctuation">-</span>weibo    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> <span class="token string">'#d63130'</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '      &lt;div id="myWeibo"<span class="token punctuation">></span>      &lt;<span class="token tag">!--</span> 如果不要滚动，则去掉 vue<span class="token punctuation">-</span>seamless<span class="token punctuation">-</span>scroll标签就行了，这个插件使用cdn向左向右滚动好像有问题 <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span>        &lt;vue<span class="token punctuation">-</span>seamless<span class="token punctuation">-</span>scroll          <span class="token punctuation">:</span>data="content"          <span class="token punctuation">:</span>class<span class="token punctuation">-</span>option="classOption"          class="warp"        <span class="token punctuation">></span>          &lt;div class="weibo<span class="token punctuation">-</span>container" v<span class="token punctuation">-</span>for="(item<span class="token punctuation">,</span> index) in content" <span class="token punctuation">:</span>key="index"<span class="token punctuation">></span>            &lt;div class="left"<span class="token punctuation">></span>              &lt;div class="order" <span class="token punctuation">:</span>class="<span class="token punctuation">&#123;</span> <span class="token key atrule">red</span><span class="token punctuation">:</span> index&lt;=2 <span class="token punctuation">&#125;</span>"<span class="token punctuation">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>index + 1<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>&lt;/div<span class="token punctuation">></span>              &lt;div class="name"<span class="token punctuation">></span>&lt;a <span class="token punctuation">:</span>href="item.url" target="_blank"<span class="token punctuation">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>item.name<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>&lt;/a<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>            &lt;/div<span class="token punctuation">></span>            &lt;div class="hot"<span class="token punctuation">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>item.hot<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>&lt;/div<span class="token punctuation">></span>          &lt;/div<span class="token punctuation">></span>        &lt;/vue<span class="token punctuation">-</span>seamless<span class="token punctuation">-</span>scroll<span class="token punctuation">></span>      &lt;/div<span class="token punctuation">></span>      &lt;script src="/weibo/index.js"<span class="token punctuation">></span>&lt;/script<span class="token punctuation">></span>      &lt;link href="/weibo/index.css" rel="stylesheet"<span class="token punctuation">></span>    '<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样，热搜侧边栏也弄好了，如果不要热搜榜滚动的话，自己去掉<vue-seamless-scroll></vue-seamless-scroll>这个html标签就行了</p><h3 id="历史上的今天"><a href="#历史上的今天" class="headerlink" title="历史上的今天"></a>历史上的今天</h3><p>嘿嘿，同样要在source文件夹下创建historyToday/index.js文件</p><details ><summary pointer> historyToday/index.js </summary>              <div class='content'>              <p>又是vue.js写的，无所谓，不需要看懂, 复制粘贴就行</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">// 如果想变换轮播方式等，进阶的话，可以看这个 https<span class="token punctuation">:</span>//github.surmon.me/vue<span class="token punctuation">-</span>awesome<span class="token punctuation">-</span>swiper/// 当然你也可以引入jquery插件，都可以的<span class="token punctuation">,</span> 不只是轮播图，其他特效也可以new Vue(<span class="token punctuation">&#123;</span>  <span class="token key atrule">el</span><span class="token punctuation">:</span> <span class="token string">"#myHistorySwiper"</span><span class="token punctuation">,</span> <span class="token key atrule">// el不要是最外面的id_name，应该是html</span><span class="token punctuation">:</span> ''里的div的id  <span class="token key atrule">data</span><span class="token punctuation">:</span> function () <span class="token punctuation">&#123;</span>    return <span class="token punctuation">&#123;</span>      <span class="token key atrule">swiperOption</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"cube"</span><span class="token punctuation">,</span> // 轮播特效        <span class="token key atrule">loop</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span> // 循环        <span class="token key atrule">autoplay</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>          <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token number">2500</span><span class="token punctuation">,</span>          <span class="token key atrule">disableOnInteraction</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>;  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token key atrule">computed</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>    swiper() <span class="token punctuation">&#123;</span>      return this.$refs.myhistoryswiper.$swiper;    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  created() <span class="token punctuation">&#123;</span>    this.getHistoryList();  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token key atrule">methods</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>    // 鼠标移入停止轮播    stopAutoPlay() <span class="token punctuation">&#123;</span>      this.swiperOption.autoplay <span class="token important">&amp;&amp;</span> this.swiper.autoplay.stop();    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    // 鼠标移出开始轮播    startAutoPlay() <span class="token punctuation">&#123;</span>      this.swiperOption.autoplay <span class="token important">&amp;&amp;</span> this.swiper.autoplay.start();    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    // 请求开源api<span class="token punctuation">,</span> 获取历史上的今天数据    getHistoryList() <span class="token punctuation">&#123;</span>      fetch("https<span class="token punctuation">:</span>//tenapi.cn/lishi/<span class="token punctuation">?</span>format=json"<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token key atrule">method</span><span class="token punctuation">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span> // <span class="token important">*GET</span><span class="token punctuation">,</span> POST<span class="token punctuation">,</span> PUT<span class="token punctuation">,</span> DELETE<span class="token punctuation">,</span> etc.      <span class="token punctuation">&#125;</span>)        .then((res) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>          return res.json();        <span class="token punctuation">&#125;</span>)        .then((data) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>          this.content = data.content;        <span class="token punctuation">&#125;</span>)        .catch((err) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span>          console.log("err"<span class="token punctuation">,</span> err);        <span class="token punctuation">&#125;</span>);    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><p>最后在自定义侧边栏的widget_library_sticky或者widget_library中加入html,</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">widget_library_sticky</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> historyToday    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> historyToday    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 历史上的今天    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>calendar<span class="token punctuation">-</span>week    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> <span class="token string">'#d63130'</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '      &lt;div id="myHistorySwiper" @mouseenter="stopAutoPlay()" @mouseleave="startAutoPlay()"<span class="token punctuation">></span>        &lt;swiper class="myhistoryswiper" ref="myhistoryswiper" style="height<span class="token punctuation">:</span>80px;" <span class="token punctuation">:</span>options="swiperOption"<span class="token punctuation">></span>          &lt;swiper<span class="token punctuation">-</span>slide v<span class="token punctuation">-</span>for="(item<span class="token punctuation">,</span> index) in content" <span class="token punctuation">:</span>key="index"<span class="token punctuation">></span>            <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>item<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>          &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">></span>      &lt;/div<span class="token punctuation">></span>      &lt;script src="/historyToday/index.js"<span class="token punctuation">></span>&lt;/script<span class="token punctuation">></span>    '<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样历史上的今天就完成了</p><h3 id="恋爱墙"><a href="#恋爱墙" class="headerlink" title="恋爱墙"></a>恋爱墙</h3><p>在source文件夹下创建love/index.js文件</p><details ><summary pointer> love/index.js </summary>              <div class='content'>              <p>love/index.js</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">var htmer_time = document.getElementById("htmer_time");var htmer_time_time = null;function setTime() <span class="token punctuation">&#123;</span>  var create_time = Math.round(    new Date(Date.UTC(2018<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> 0)).getTime() / 1000  );  var timestamp = Math.round(    (new Date().getTime() + 8 * 60 * 60 * 1000) / 1000  );  currentTime = secondToDate(timestamp <span class="token punctuation">-</span> create_time);  currentTimeHtml =    currentTime<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> +    " 年 " +    currentTime<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> +    " 天 " +    currentTime<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> +    " 时 " +    currentTime<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> +    " 分 " +    currentTime<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> +    " 秒";  htmer_time.innerHTML = currentTimeHtml;<span class="token punctuation">&#125;</span>function secondToDate(second) <span class="token punctuation">&#123;</span>  if (<span class="token tag">!second)</span> <span class="token punctuation">&#123;</span>    return 0;  <span class="token punctuation">&#125;</span>  var time = new Array(0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 0);  if (second <span class="token punctuation">></span>= 365 * 24 * 3600) <span class="token punctuation">&#123;</span>    time<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> = parseInt(second / (365 * 24 * 3600));    second %= 365 * 24 * 3600;  <span class="token punctuation">&#125;</span>  if (second <span class="token punctuation">></span>= 24 * 3600) <span class="token punctuation">&#123;</span>    time<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> = parseInt(second / (24 * 3600));    second %= 24 * 3600;  <span class="token punctuation">&#125;</span>  if (second <span class="token punctuation">></span>= 3600) <span class="token punctuation">&#123;</span>    time<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> = parseInt(second / 3600);    second %= 3600;  <span class="token punctuation">&#125;</span>  if (second <span class="token punctuation">></span>= 60) <span class="token punctuation">&#123;</span>    time<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> = parseInt(second / 60);    second %= 60;  <span class="token punctuation">&#125;</span>  if (second <span class="token punctuation">></span> 0) <span class="token punctuation">&#123;</span>    time<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> = second;  <span class="token punctuation">&#125;</span>  return time;<span class="token punctuation">&#125;</span>if (htmer_time) <span class="token punctuation">&#123;</span>  htmer_time_time = setInterval(setTime<span class="token punctuation">,</span> 1000);<span class="token punctuation">&#125;</span> else <span class="token punctuation">&#123;</span>  clearInterval(htmer_time_time);<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><p>在第6行修改时间就行了，改成你自己想要开始的时间，这里是2018年10月26号开始的<br>最后在自定义侧边栏的widget_library_sticky或者widget_library中加入html</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">widget_library_sticky</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> testLove    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> testLove    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 恋爱墙    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>heart    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> <span class="token string">'#d63130'</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '          <span class="token key atrule">&lt;div style="text-align</span><span class="token punctuation">:</span> center;"<span class="token punctuation">></span>        &lt;img src="https<span class="token punctuation">:</span>//a<span class="token punctuation">-</span>oss.zmki.cn/20190601/img_9879.jpg"          <span class="token key atrule">style="width</span><span class="token punctuation">:</span> <span class="token key atrule">50px;height</span><span class="token punctuation">:</span> <span class="token key atrule">50px;vertical-align</span><span class="token punctuation">:</span> <span class="token key atrule">-20px;border-radius</span><span class="token punctuation">:</span> <span class="token key atrule">50%;margin-right</span><span class="token punctuation">:</span> <span class="token key atrule">5px;margin-bottom</span><span class="token punctuation">:</span> <span class="token key atrule">5px;-webkit-box-shadow</span><span class="token punctuation">:</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>0.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token key atrule">0.1);box-shadow</span><span class="token punctuation">:</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>0.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token key atrule">0.1);border</span><span class="token punctuation">:</span> 2px solid <span class="token comment">#fff;" /></span>        <span class="token key atrule">&lt;svg viewbox="0 0 1024 1024" style="margin-left</span><span class="token punctuation">:</span> <span class="token key atrule">5px;margin-right</span><span class="token punctuation">:</span> 5px;" version="1.0" width="15" height="15"          class="my<span class="token punctuation">-</span>face"<span class="token punctuation">></span>          &lt;path            d="M863.597631 513.574282l<span class="token punctuation">-</span>271.33965<span class="token punctuation">-</span>140.213484L729.783667 81.926656c3.583731<span class="token punctuation">-</span>7.87141 7.167462<span class="token punctuation">-</span>15.742819 7.167462<span class="token punctuation">-</span>25.214109C736.887134 25.226908 708.345275 0.012799 672.635953 0.012799a63.611229 63.611229 0 0 0<span class="token punctuation">-</span>39.293053 12.607055c<span class="token punctuation">-</span>1.791866 1.59988<span class="token punctuation">-</span>3.519736 3.19976<span class="token punctuation">-</span>5.311602 3.19976L147.87531 418.925381a55.547834 55.547834 0 0 0<span class="token punctuation">-</span>19.646527 47.356448c1.791866 17.278704 14.27093 33.021523 32.125591 42.492813l271.33965 141.749369L292.504463 945.221908c<span class="token punctuation">-</span>12.479064 25.214109<span class="token punctuation">-</span>1.791866 53.563983 23.166262 69.306802 10.751194 6.335525 23.230258 9.47129 35.709322 9.47129 16.062795 0 32.125591<span class="token punctuation">-</span>4.735645 44.604655<span class="token punctuation">-</span>15.742819l480.091993<span class="token punctuation">-</span>403.297753a55.547834 55.547834 0 0 0 19.646526<span class="token punctuation">-</span>47.228458 61.243407 61.243407 0 0 0<span class="token punctuation">-</span>32.12559<span class="token punctuation">-</span>44.156688z"            fill="<span class="token comment">#515151" /></span>        &lt;/svg<span class="token punctuation">></span>        &lt;img src="https<span class="token punctuation">:</span>//a<span class="token punctuation">-</span>oss.zmki.cn/20190601/img_9878.jpg"          <span class="token key atrule">style="width</span><span class="token punctuation">:</span> <span class="token key atrule">50px;height</span><span class="token punctuation">:</span> <span class="token key atrule">50px;vertical-align</span><span class="token punctuation">:</span> <span class="token key atrule">-20px;border-radius</span><span class="token punctuation">:</span> <span class="token key atrule">50%;margin-left</span><span class="token punctuation">:</span> <span class="token key atrule">5px;margin-bottom</span><span class="token punctuation">:</span> <span class="token key atrule">5px;-webkit-box-shadow</span><span class="token punctuation">:</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>0.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token key atrule">0.1);box-shadow</span><span class="token punctuation">:</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>0.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token key atrule">0.1);border</span><span class="token punctuation">:</span> 2px solid <span class="token comment">#fff;" />&lt;br /></span>        &lt;span id="htmer_time"<span class="token punctuation">></span>&lt;/span<span class="token punctuation">></span>      &lt;/div<span class="token punctuation">></span>      &lt;script data<span class="token punctuation">-</span>pjax src="/love/index.js"<span class="token punctuation">></span>&lt;/script<span class="token punctuation">></span>    '<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样，恋爱墙就完成了，但是，除了修改时间，你还可以把两张图片地址也修改成你自己的图片地址</p><p>这几个模块就相当于给你一个容器，你可以自己往里面方html，然后放js，css，放一些自己的插件，vue.js,jquery.js，原生js都可以，只是提供一个容器，你可以自己搞更好看更好玩的扩展，如果你懒得折腾，用我上面写的扩展（自定义侧边栏）也挺好的。</p><p>最后我将我的source/_data/widget.yml写法贴下来,如下所示</p><details ><summary pointer> source/_data/widget.yml </summary>              <div class='content'>              <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">widget_library</span><span class="token punctuation">:</span><span class="token key atrule">widget_library_sticky</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> testWidget    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> testWidget    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 微博热搜    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fab fa<span class="token punctuation">-</span>weibo    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> <span class="token string">'#d63130'</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '      &lt;div id="myWeibo"<span class="token punctuation">></span>      &lt;<span class="token tag">!--</span> 如果不要滚动，则去掉 vue<span class="token punctuation">-</span>seamless<span class="token punctuation">-</span>scroll标签就行了，这个插件使用cdn向左向右滚动好像有问题 <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span>        &lt;vue<span class="token punctuation">-</span>seamless<span class="token punctuation">-</span>scroll          <span class="token punctuation">:</span>data="content"          <span class="token punctuation">:</span>class<span class="token punctuation">-</span>option="classOption"          class="warp"        <span class="token punctuation">></span>          &lt;div class="weibo<span class="token punctuation">-</span>container" v<span class="token punctuation">-</span>for="(item<span class="token punctuation">,</span> index) in content" <span class="token punctuation">:</span>key="index"<span class="token punctuation">></span>            &lt;div class="left"<span class="token punctuation">></span>              &lt;div class="order" <span class="token punctuation">:</span>class="<span class="token punctuation">&#123;</span> <span class="token key atrule">red</span><span class="token punctuation">:</span> index&lt;=2 <span class="token punctuation">&#125;</span>"<span class="token punctuation">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>index + 1<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>&lt;/div<span class="token punctuation">></span>              &lt;div class="name"<span class="token punctuation">></span>&lt;a <span class="token punctuation">:</span>href="item.url" target="_blank"<span class="token punctuation">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>item.name<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>&lt;/a<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>            &lt;/div<span class="token punctuation">></span>            &lt;div class="hot"<span class="token punctuation">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>item.hot<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>&lt;/div<span class="token punctuation">></span>          &lt;/div<span class="token punctuation">></span>        &lt;/vue<span class="token punctuation">-</span>seamless<span class="token punctuation">-</span>scroll<span class="token punctuation">></span>      &lt;/div<span class="token punctuation">></span>      &lt;script src="/weibo/index.js"<span class="token punctuation">></span>&lt;/script<span class="token punctuation">></span>      &lt;link href="/weibo/index.css" rel="stylesheet"<span class="token punctuation">></span>    '  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> historyToday    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> historyToday    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 历史上的今天    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>calendar<span class="token punctuation">-</span>week    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> <span class="token string">'#d63130'</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '      &lt;div id="myHistorySwiper" @mouseenter="stopAutoPlay()" @mouseleave="startAutoPlay()"<span class="token punctuation">></span>        &lt;swiper class="myhistoryswiper" ref="myhistoryswiper" style="height<span class="token punctuation">:</span>80px;" <span class="token punctuation">:</span>options="swiperOption"<span class="token punctuation">></span>          &lt;swiper<span class="token punctuation">-</span>slide v<span class="token punctuation">-</span>for="(item<span class="token punctuation">,</span> index) in content" <span class="token punctuation">:</span>key="index"<span class="token punctuation">></span>            <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>item<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>          &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">></span>      &lt;/div<span class="token punctuation">></span>      &lt;script src="/historyToday/index.js"<span class="token punctuation">></span>&lt;/script<span class="token punctuation">></span>    '  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> testLove    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> testLove    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 恋爱墙    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>heart    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> <span class="token string">'#d63130'</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '          <span class="token key atrule">&lt;div style="text-align</span><span class="token punctuation">:</span> center;"<span class="token punctuation">></span>        &lt;img src="https<span class="token punctuation">:</span>//a<span class="token punctuation">-</span>oss.zmki.cn/20190601/img_9879.jpg"          <span class="token key atrule">style="width</span><span class="token punctuation">:</span> <span class="token key atrule">50px;height</span><span class="token punctuation">:</span> <span class="token key atrule">50px;vertical-align</span><span class="token punctuation">:</span> <span class="token key atrule">-20px;border-radius</span><span class="token punctuation">:</span> <span class="token key atrule">50%;margin-right</span><span class="token punctuation">:</span> <span class="token key atrule">5px;margin-bottom</span><span class="token punctuation">:</span> <span class="token key atrule">5px;-webkit-box-shadow</span><span class="token punctuation">:</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>0.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token key atrule">0.1);box-shadow</span><span class="token punctuation">:</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>0.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token key atrule">0.1);border</span><span class="token punctuation">:</span> 2px solid <span class="token comment">#fff;" /></span>        <span class="token key atrule">&lt;svg viewbox="0 0 1024 1024" style="margin-left</span><span class="token punctuation">:</span> <span class="token key atrule">5px;margin-right</span><span class="token punctuation">:</span> 5px;" version="1.0" width="15" height="15"          class="my<span class="token punctuation">-</span>face"<span class="token punctuation">></span>          &lt;path            d="M863.597631 513.574282l<span class="token punctuation">-</span>271.33965<span class="token punctuation">-</span>140.213484L729.783667 81.926656c3.583731<span class="token punctuation">-</span>7.87141 7.167462<span class="token punctuation">-</span>15.742819 7.167462<span class="token punctuation">-</span>25.214109C736.887134 25.226908 708.345275 0.012799 672.635953 0.012799a63.611229 63.611229 0 0 0<span class="token punctuation">-</span>39.293053 12.607055c<span class="token punctuation">-</span>1.791866 1.59988<span class="token punctuation">-</span>3.519736 3.19976<span class="token punctuation">-</span>5.311602 3.19976L147.87531 418.925381a55.547834 55.547834 0 0 0<span class="token punctuation">-</span>19.646527 47.356448c1.791866 17.278704 14.27093 33.021523 32.125591 42.492813l271.33965 141.749369L292.504463 945.221908c<span class="token punctuation">-</span>12.479064 25.214109<span class="token punctuation">-</span>1.791866 53.563983 23.166262 69.306802 10.751194 6.335525 23.230258 9.47129 35.709322 9.47129 16.062795 0 32.125591<span class="token punctuation">-</span>4.735645 44.604655<span class="token punctuation">-</span>15.742819l480.091993<span class="token punctuation">-</span>403.297753a55.547834 55.547834 0 0 0 19.646526<span class="token punctuation">-</span>47.228458 61.243407 61.243407 0 0 0<span class="token punctuation">-</span>32.12559<span class="token punctuation">-</span>44.156688z"            fill="<span class="token comment">#515151" /></span>        &lt;/svg<span class="token punctuation">></span>        &lt;img src="https<span class="token punctuation">:</span>//a<span class="token punctuation">-</span>oss.zmki.cn/20190601/img_9878.jpg"          <span class="token key atrule">style="width</span><span class="token punctuation">:</span> <span class="token key atrule">50px;height</span><span class="token punctuation">:</span> <span class="token key atrule">50px;vertical-align</span><span class="token punctuation">:</span> <span class="token key atrule">-20px;border-radius</span><span class="token punctuation">:</span> <span class="token key atrule">50%;margin-left</span><span class="token punctuation">:</span> <span class="token key atrule">5px;margin-bottom</span><span class="token punctuation">:</span> <span class="token key atrule">5px;-webkit-box-shadow</span><span class="token punctuation">:</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>0.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token key atrule">0.1);box-shadow</span><span class="token punctuation">:</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>0.1)<span class="token punctuation">,</span> 1px 1px 1px rgba(0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token key atrule">0.1);border</span><span class="token punctuation">:</span> 2px solid <span class="token comment">#fff;" />&lt;br /></span>        &lt;span id="htmer_time"<span class="token punctuation">></span>&lt;/span<span class="token punctuation">></span>      &lt;/div<span class="token punctuation">></span>      &lt;script data<span class="token punctuation">-</span>pjax src="/love/index.js"<span class="token punctuation">></span>&lt;/script<span class="token punctuation">></span>    '<span class="token key atrule">home_widget</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> welcome    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> welcome    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 欢迎    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>envelope    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> blue    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> <span class="token string">'&lt;img src="https://api.amogu.cn/api/ipimg/" style="width:100%">'</span>  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> my_github_container    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> my_github_container    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 测试日历    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>envelope    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> blue    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '      &lt;div id="github_container"<span class="token punctuation">></span>&lt;/div<span class="token punctuation">></span>      &lt;script data<span class="token punctuation">-</span>pjax src="/githubcalendar/index.js"<span class="token punctuation">></span>&lt;/script<span class="token punctuation">></span>    '  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> test2    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> test2    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 测试轮播图    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>envelope    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> blue    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '    &lt;div id="mySwiper" @mouseenter="stopAutoPlay()" @mouseleave="startAutoPlay()"<span class="token punctuation">></span>      &lt;swiper class="myswiper" ref="myswiper" style="height<span class="token punctuation">:</span>350px;" <span class="token punctuation">:</span>options="swiperOption"<span class="token punctuation">></span>        &lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>          &lt;a href="http<span class="token punctuation">:</span>//baidu.com" class="toPath"<span class="token punctuation">></span>            <span class="token key atrule">&lt;img class="no-lazy" src="/mySwiper/img/2.jpg" style="width:100%;height:100%;object-fit</span><span class="token punctuation">:</span> cover;"<span class="token punctuation">></span>            &lt;h2 class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是标题&lt;/h2<span class="token punctuation">></span>            &lt;p class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是描述哦&lt;/p<span class="token punctuation">></span>          &lt;/a<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>          &lt;a href="http<span class="token punctuation">:</span>//baidu.com" class="toPath"<span class="token punctuation">></span>            <span class="token key atrule">&lt;img class="no-lazy" src="/mySwiper/img/3.jpg" style="width:100%;height:100%;object-fit</span><span class="token punctuation">:</span> cover;"<span class="token punctuation">></span>            &lt;h2 class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是标题2&lt;/h2<span class="token punctuation">></span>            &lt;p class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是描述2&lt;/p<span class="token punctuation">></span>          &lt;/a<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>          &lt;a href="http<span class="token punctuation">:</span>//baidu.com" class="toPath"<span class="token punctuation">></span>            <span class="token key atrule">&lt;img class="no-lazy" src="/mySwiper/img/4.jpg" style="width:100%;height:100%;object-fit</span><span class="token punctuation">:</span> cover;"<span class="token punctuation">></span>            &lt;h2 class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是标题3&lt;/h2<span class="token punctuation">></span>            &lt;p class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是描述3&lt;/p<span class="token punctuation">></span>          &lt;/a<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>          &lt;a href="http<span class="token punctuation">:</span>//baidu.com" class="toPath"<span class="token punctuation">></span>            <span class="token key atrule">&lt;img class="no-lazy" src="/mySwiper/img/5.jpg" style="width:100%;height:100%;object-fit</span><span class="token punctuation">:</span> cover;"<span class="token punctuation">></span>            &lt;h2 class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是标题4&lt;/h2<span class="token punctuation">></span>            &lt;p class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是描述4&lt;/p<span class="token punctuation">></span>          &lt;/a<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>          &lt;a href="http<span class="token punctuation">:</span>//baidu.com" class="toPath"<span class="token punctuation">></span>            <span class="token key atrule">&lt;img class="no-lazy" src="https://api.dujin.org/pic/ghibli/" style="width:100%;height:100%;object-fit</span><span class="token punctuation">:</span> cover;"<span class="token punctuation">></span>            &lt;h2 class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是标题5&lt;/h2<span class="token punctuation">></span>            &lt;p class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是描述5&lt;/p<span class="token punctuation">></span>          &lt;/a<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>          &lt;a href="http<span class="token punctuation">:</span>//baidu.com" class="toPath"<span class="token punctuation">></span>            <span class="token key atrule">&lt;img class="no-lazy" src="/mySwiper/img/7.jpg" style="width:100%;height:100%;object-fit</span><span class="token punctuation">:</span> cover;"<span class="token punctuation">></span>            &lt;h2 class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是标题6&lt;/h2<span class="token punctuation">></span>            &lt;p class="ani" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>effect="fadeInDown" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>duration="0.5s" swiper<span class="token punctuation">-</span>animate<span class="token punctuation">-</span>delay="0.3s"<span class="token punctuation">></span>我是描述6&lt;/p<span class="token punctuation">></span>          &lt;/a<span class="token punctuation">></span>        &lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>        &lt;<span class="token tag">!--</span> 如果你想继续增加轮播图，继续在下面写&lt;swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>我是内容&lt;/swiper<span class="token punctuation">-</span>slide<span class="token punctuation">></span>就行了 <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span><span class="token scalar string">        &lt;div class="swiper-pagination" slot="pagination">&lt;/div></span>      &lt;/swiper<span class="token punctuation">></span>    &lt;/div<span class="token punctuation">></span>    &lt;script src="/mySwiper/index.js"<span class="token punctuation">></span>&lt;/script<span class="token punctuation">></span>    &lt;link href="/mySwiper/index.css" rel="stylesheet"<span class="token punctuation">></span>    '  <span class="token punctuation">-</span> <span class="token key atrule">class_name</span><span class="token punctuation">:</span> mybilibili    <span class="token key atrule">id_name</span><span class="token punctuation">:</span> mybilibili    <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">-1</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> 测试bli    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>envelope    <span class="token key atrule">icon_color</span><span class="token punctuation">:</span> blue    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//baidu.com    <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#fff'</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '      &lt;div id="myBli"<span class="token punctuation">></span>        &lt;vue<span class="token punctuation">-</span>seamless<span class="token punctuation">-</span>scroll          <span class="token punctuation">:</span>data="listData"          <span class="token punctuation">:</span>class<span class="token punctuation">-</span>option="classOption"          class="warp"        <span class="token punctuation">></span>          &lt;ul class="ul<span class="token punctuation">-</span>item" style="width<span class="token punctuation">:</span>720px;"<span class="token punctuation">></span>            &lt;<span class="token tag">!--</span> 在这里改<span class="token punctuation">,</span> 手动修改a连接的href值和img的src值<span class="token punctuation">,</span> 如果你会进阶，你可以使用v<span class="token punctuation">-</span>for<span class="token punctuation">,</span> 或者数据使用动态数据<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span>                        &lt;li class="li<span class="token punctuation">-</span>item"<span class="token punctuation">></span>              &lt;a href="http<span class="token punctuation">:</span>//baidu.com"<span class="token punctuation">></span>                &lt;img class="no<span class="token punctuation">-</span>lazy" src="https<span class="token punctuation">:</span>//pic4.zhimg.com/80/v2<span class="token punctuation">-</span>f549722dac8f777693c090a92498de0f_1440w.jpg"<span class="token punctuation">></span>              &lt;/a<span class="token punctuation">></span>            &lt;/li<span class="token punctuation">></span>            &lt;li class="li<span class="token punctuation">-</span>item"<span class="token punctuation">></span>              &lt;a href="http<span class="token punctuation">:</span>//baidu.com"<span class="token punctuation">></span>                &lt;img class="no<span class="token punctuation">-</span>lazy" src="https<span class="token punctuation">:</span>//pic4.zhimg.com/80/v2<span class="token punctuation">-</span>f549722dac8f777693c090a92498de0f_1440w.jpg"<span class="token punctuation">></span>              &lt;/a<span class="token punctuation">></span>            &lt;/li<span class="token punctuation">></span>            &lt;li class="li<span class="token punctuation">-</span>item"<span class="token punctuation">></span>              &lt;a href="http<span class="token punctuation">:</span>//baidu.com"<span class="token punctuation">></span>                &lt;img class="no<span class="token punctuation">-</span>lazy" src="https<span class="token punctuation">:</span>//pic4.zhimg.com/80/v2<span class="token punctuation">-</span>f549722dac8f777693c090a92498de0f_1440w.jpg"<span class="token punctuation">></span>              &lt;/a<span class="token punctuation">></span>            &lt;/li<span class="token punctuation">></span>            &lt;li class="li<span class="token punctuation">-</span>item"<span class="token punctuation">></span>              &lt;a href="http<span class="token punctuation">:</span>//baidu.com"<span class="token punctuation">></span>                &lt;img class="no<span class="token punctuation">-</span>lazy" src="https<span class="token punctuation">:</span>//pic4.zhimg.com/80/v2<span class="token punctuation">-</span>f549722dac8f777693c090a92498de0f_1440w.jpg"<span class="token punctuation">></span>              &lt;/a<span class="token punctuation">></span>            &lt;/li<span class="token punctuation">></span>            &lt;li class="li<span class="token punctuation">-</span>item"<span class="token punctuation">></span>              &lt;a href="http<span class="token punctuation">:</span>//baidu.com"<span class="token punctuation">></span>                &lt;img class="no<span class="token punctuation">-</span>lazy" src="https<span class="token punctuation">:</span>//pic4.zhimg.com/80/v2<span class="token punctuation">-</span>f549722dac8f777693c090a92498de0f_1440w.jpg"<span class="token punctuation">></span>              &lt;/a<span class="token punctuation">></span>            &lt;/li<span class="token punctuation">></span>            &lt;li class="li<span class="token punctuation">-</span>item"<span class="token punctuation">></span>              &lt;a href="http<span class="token punctuation">:</span>//baidu.com"<span class="token punctuation">></span>                &lt;img class="no<span class="token punctuation">-</span>lazy" src="https<span class="token punctuation">:</span>//pic4.zhimg.com/80/v2<span class="token punctuation">-</span>f549722dac8f777693c090a92498de0f_1440w.jpg"<span class="token punctuation">></span>              &lt;/a<span class="token punctuation">></span>            &lt;/li<span class="token punctuation">></span>            &lt;<span class="token tag">!--</span> 在这里结束 <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span><span class="token scalar string">          &lt;/ul></span>        &lt;/vue<span class="token punctuation">-</span>seamless<span class="token punctuation">-</span>scroll<span class="token punctuation">></span>      &lt;/div<span class="token punctuation">></span>      &lt;script src="/bli/index.js"<span class="token punctuation">></span>&lt;/script<span class="token punctuation">></span>      &lt;link href="/bli/index.css" rel="stylesheet"<span class="token punctuation">></span>    '<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details>]]></content>
      
      
      <categories>
          
          <category> 本站介绍 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> 热搜榜 </tag>
            
            <tag> widget </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>主题介绍-文章Front-matter</title>
      <link href="/post/ben-zhan-jie-shao/zhu-ti-jie-shao-wen-zhang-front-matter/"/>
      <url>/post/ben-zhan-jie-shao/zhu-ti-jie-shao-wen-zhang-front-matter/</url>
      
        <content type="html"><![CDATA[<h2 id="文章-Front-matter-介绍"><a href="#文章-Front-matter-介绍" class="headerlink" title="文章 Front-matter 介绍"></a>文章 Front-matter 介绍</h2><p>这个指的是你在你的文章页面里面写的参数，针对的是这一篇文章，例如</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> Hexo主题<span class="token punctuation">-</span><span class="token punctuation">-</span>Bamboo介绍<span class="token key atrule">date</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>24 14<span class="token punctuation">:</span><span class="token number">06</span><span class="token key atrule">swiper</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 将改文章放入轮播图中</span><span class="token key atrule">swiperImg</span><span class="token punctuation">:</span> <span class="token string">'/medias/1.jpg'</span> <span class="token comment"># 该文章在轮播图中的图片，可以是本地目录下图片也可以是http://xxx图片</span><span class="token key atrule">img</span><span class="token punctuation">:</span> <span class="token string">'/medias/1.jpg'</span> <span class="token comment"># 该文章图片，可以是本地目录下图片也可以是http://xxx图片</span><span class="token key atrule">categories</span><span class="token punctuation">:</span> 前端<span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>Hexo<span class="token punctuation">,</span> hexo<span class="token punctuation">-</span>theme<span class="token punctuation">-</span>bamboo<span class="token punctuation">]</span><span class="token key atrule">top</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Front-matter</code> 选项中的所有内容均为<strong>非必填</strong>的。但我仍然建议至少填写 <code>title</code> 和 <code>date</code> 的值。</p><table><thead><tr><th>配置选项</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>title</td><td><code>Markdown</code> 的文件标题</td><td>文章标题，强烈建议填写此选项</td></tr><tr><td>date</td><td>文件创建时的日期时间</td><td>发布时间，强烈建议填写此选项，且最好保证全局唯一</td></tr><tr><td>author</td><td>Fengqi</td><td>文章作者，没有设置默认是Fengqi</td></tr><tr><td>categories</td><td>无</td><td>文章分类，本主题的分类表示宏观上大的分类，只建议一篇文章一个分类</td></tr><tr><td>tags</td><td>无</td><td>文章标签，一篇文章可以多个标签</td></tr><tr><td>top</td><td>false</td><td>将该值设为true，则将该篇文章显示在首页的置顶栏目中</td></tr><tr><td>toc</td><td>true</td><td>将该值设为false，则该篇文章不显示右侧目录</td></tr><tr><td>tocOpen</td><td>true</td><td>将该值设为false，则该篇文章右侧目录默认收缩</td></tr><tr><td>onlyTitle</td><td>false</td><td>文章详情页头部是否只显示标题，不显示日期等信息</td></tr><tr><td>excerpt</td><td>无</td><td>文章描述（摘要），该文章在首页的描述文字，如果没有，则取swiperDesc,如果swiperDesc也没有，则取文章内容（优先取 <code>&lt;!-- more --&gt; &quot;</code>上面的内容）</td></tr><tr><td>swiper</td><td>false</td><td>表示该文章是否需要加入到首页轮播封面中</td></tr><tr><td>swiperImg</td><td>无</td><td>表示该文章在首页轮播封面需要显示的图片路径，如果没有，则默认使用文章的特色图片</td></tr><tr><td>swiperDesc</td><td>无</td><td>表示该文章在首页轮播封面需要显示的文字描述（摘要），如果没有，则使用excerpt，如果excerpt也没有，则取文章内容</td></tr><tr><td>img</td><td>无</td><td>文章特征图，该文章显示的图片，没有则默认使用文章的特色图片</td></tr><tr><td>bgImg</td><td>-</td><td>单独为这篇文章设置背景图片或者背景颜色，可以是数组，数组里面放图片链接，可以是字符串，字符串里面是颜色值，空值则背景颜色透明</td></tr><tr><td>bgImgTransition</td><td>fade</td><td>该篇文章的bgImg设置为数组,该值表示背景图片切换的动画, 有三种值（fade, scale, translate-fade）</td></tr><tr><td>bgImgDelay</td><td>180000(三分钟)</td><td>该篇文章的bgImg设置为数组,该值表示背景图片切换的延迟时间</td></tr><tr><td>comments</td><td>true</td><td>将该值设为false，则该篇文章不显示评论</td></tr><tr><td>share</td><td>true</td><td>将该值设为false，则该篇文章不显示分享按钮</td></tr><tr><td>copyright</td><td>true</td><td>将该值设为false，则该篇文章不显示版权声明</td></tr><tr><td>donate</td><td>true</td><td>将该值设为false，则该篇文章不显示打赏按钮</td></tr><tr><td>prismjs</td><td>无</td><td>如果使用的是hexo自带的prismjs代码高亮，通过设置该值为该篇文章设置不同的代码高亮主题（default, coy, dark, funky, okaidia, solarizedlight, tomorrow, twilight）</td></tr><tr><td>mathjax</td><td>false</td><td>mathjax公式</td></tr></tbody></table><p>以上基本就是所有的配置项了</p>]]></content>
      
      
      <categories>
          
          <category> 本站介绍 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>主题介绍-媒体文件书写功能</title>
      <link href="/post/ben-zhan-jie-shao/zhu-ti-jie-shao-mei-ti-wen-jian-shu-xie-gong-neng/"/>
      <url>/post/ben-zhan-jie-shao/zhu-ti-jie-shao-mei-ti-wen-jian-shu-xie-gong-neng/</url>
      
        <content type="html"><![CDATA[<h1 class="bamboo-h " id="getFile文件写法">getFile文件写法</h1><br/><h2 id="getFile文件功能"><a href="#getFile文件功能" class="headerlink" title="getFile文件功能"></a>getFile文件功能</h2><p>会把某个文件夹下的文件显示在页面上。<br>例如我在source文件夹下，创建了一个叫做img的文件夹，把img的文件夹下的文件显示在页面上。</p><blockquote><p>  注意： 必须要在source文件夹下，文件夹名称可以随便取，下面事例中文件夹名称叫img<br>    该标签需要主题版本为 2.3.6+</p></blockquote><h2 id="getFile文件写法示例如下"><a href="#getFile文件写法示例如下" class="headerlink" title="getFile文件写法示例如下"></a>getFile文件写法示例如下</h2><h3 id="获取img文件夹下的-txt-pdf文件"><a href="#获取img文件夹下的-txt-pdf文件" class="headerlink" title="获取img文件夹下的.txt .pdf文件"></a>获取<code>img</code>文件夹下的.txt .pdf文件</h3><div class="link-group"><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gougou .txt" href="/img/gougou .txt"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" class="lazyload placeholder" data-srcset="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gougou .txt</p><p class="url">/img/gougou .txt</p></div></a></div><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gougou.pdf" href="/img/gougou.pdf"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" class="lazyload placeholder" data-srcset="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gougou.pdf</p><p class="url">/img/gougou.pdf</p></div></a></div></div><h3 id="获取img文件夹下的-png文件"><a href="#获取img文件夹下的-png文件" class="headerlink" title="获取img文件夹下的.png文件"></a>获取<code>img</code>文件夹下的.png文件</h3><div class="link-group"><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gougou.png" href="/img/gougou.png"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" class="lazyload placeholder" data-srcset="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gougou.png</p><p class="url">/img/gougou.png</p></div></a></div></div><h3 id="获取img文件夹下的-gif文件"><a href="#获取img文件夹下的-gif文件" class="headerlink" title="获取img文件夹下的.gif文件"></a>获取<code>img</code>文件夹下的.gif文件</h3><div class="link-group"><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gougou.gif" href="/img/gougou.gif"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" class="lazyload placeholder" data-srcset="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gougou.gif</p><p class="url">/img/gougou.gif</p></div></a></div></div><h3 id="获取img文件夹下的所有文件"><a href="#获取img文件夹下的所有文件" class="headerlink" title="获取img文件夹下的所有文件"></a>获取<code>img</code>文件夹下的所有文件</h3><div class="link-group"><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gou.jpg" href="/img/gou.jpg"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" class="lazyload placeholder" data-srcset="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gou.jpg</p><p class="url">/img/gou.jpg</p></div></a></div><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gougou .txt" href="/img/gougou .txt"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" class="lazyload placeholder" data-srcset="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gougou .txt</p><p class="url">/img/gougou .txt</p></div></a></div><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gougou.gif" href="/img/gougou.gif"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" class="lazyload placeholder" data-srcset="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gougou.gif</p><p class="url">/img/gougou.gif</p></div></a></div><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gougou.pdf" href="/img/gougou.pdf"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" class="lazyload placeholder" data-srcset="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gougou.pdf</p><p class="url">/img/gougou.pdf</p></div></a></div><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gougou.png" href="/img/gougou.png"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" class="lazyload placeholder" data-srcset="https://img.51miz.com/Element/00/37/79/59/10df0417_E377959_b7bb9dfa.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gougou.png</p><p class="url">/img/gougou.png</p></div></a></div></div><h3 id="获取img文件夹下的所有文件，并指定左侧图片"><a href="#获取img文件夹下的所有文件，并指定左侧图片" class="headerlink" title="获取img文件夹下的所有文件，并指定左侧图片"></a>获取<code>img</code>文件夹下的所有文件，并指定左侧图片</h3><div class="link-group"><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gou.jpg" href="/img/gou.jpg"><span class="link-card-backdrop" style="background-image: url(https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7)"></span><div class="left"><img src="https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7" class="lazyload placeholder" data-srcset="https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gou.jpg</p><p class="url">/img/gou.jpg</p></div></a></div><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gougou .txt" href="/img/gougou .txt"><span class="link-card-backdrop" style="background-image: url(https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7)"></span><div class="left"><img src="https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7" class="lazyload placeholder" data-srcset="https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gougou .txt</p><p class="url">/img/gougou .txt</p></div></a></div><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gougou.gif" href="/img/gougou.gif"><span class="link-card-backdrop" style="background-image: url(https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7)"></span><div class="left"><img src="https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7" class="lazyload placeholder" data-srcset="https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gougou.gif</p><p class="url">/img/gougou.gif</p></div></a></div><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gougou.pdf" href="/img/gougou.pdf"><span class="link-card-backdrop" style="background-image: url(https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7)"></span><div class="left"><img src="https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7" class="lazyload placeholder" data-srcset="https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gougou.pdf</p><p class="url">/img/gougou.pdf</p></div></a></div><div class="tagLink"><a class="link-card" no-pjax target="_blank" title="gougou.png" href="/img/gougou.png"><span class="link-card-backdrop" style="background-image: url(https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7)"></span><div class="left"><img src="https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7" class="lazyload placeholder" data-srcset="https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&h=188&c=7&o=5&dpr=1.24&pid=1.7" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">gougou.png</p><p class="url">/img/gougou.png</p></div></a></div></div><h3 id="上述代码示例"><a href="#上述代码示例" class="headerlink" title="上述代码示例"></a>上述代码示例</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">###</span> 获取`img`文件夹下的.txt .pdf文件</span>&#123;% getFiles img, txt pdf  %&#125;<span class="token title important"><span class="token punctuation">###</span> 获取`img`文件夹下的.png文件</span>&#123;% getFiles img, png %&#125;<span class="token title important"><span class="token punctuation">###</span> 获取`img`文件夹下的.gif文件</span>&#123;% getFiles img, gif %&#125;<span class="token title important"><span class="token punctuation">###</span> 获取`img`文件夹下的所有文件</span>&#123;% getFiles img %&#125;<span class="token title important"><span class="token punctuation">###</span> 获取`img`文件夹下的所有文件，并指定左侧图片</span>&#123;% getFiles img, '', https://tse3-mm.cn.bing.net/th/id/OIP-C.oGbjgWNX4DBXyKf0P_xOmwHaHa?w=212&amp;h=188&amp;c=7&amp;o=5&amp;dpr=1.24&amp;pid=1.7 %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="inlineimage效果">inlineimage效果</h1><br/><p>这是 <img no-lazy class="inline" src="http://img.doutula.com/production/uploads/image/2019/08/15/20190815849485_fKMqYD.gif" style="height:1.5em"/> 一段话。</p><p>这又是 <img no-lazy class="inline" src="http://img.doutula.com/production/uploads/image/2019/08/15/20190815849485_fKMqYD.gif" style="height:40px;"/> 一段话。</p><p>这又是 <img no-lazy class="inline" src="http://img.doutula.com/production/uploads/image/2019/08/15/20190815849485_fKMqYD.gif" style="height:100px;"/> 一段话。</p><h3 id="上述事例代码"><a href="#上述事例代码" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">这是 &#123;% inlineimage http://img.doutula.com/production/uploads/image/2019/08/15/20190815849485_fKMqYD.gif %&#125; 一段话。这又是 &#123;% inlineimage http://img.doutula.com/production/uploads/image/2019/08/15/20190815849485_fKMqYD.gif, height=40px %&#125; 一段话。这又是 &#123;% inlineimage http://img.doutula.com/production/uploads/image/2019/08/15/20190815849485_fKMqYD.gif, height=100px %&#125; 一段话。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="自定义图片并添加描述">自定义图片并添加描述</h1><br/><h2 id="自定义图片"><a href="#自定义图片" class="headerlink" title="自定义图片"></a>自定义图片</h2><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="https://pic2.zhimg.com/80/v2-cc93c338d57783702bea4506aee7007d_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-cc93c338d57783702bea4506aee7007d_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="自定义图片"/></div><span class="image-caption">自定义图片</span></div><h3 id="上述事例代码-1"><a href="#上述事例代码-1" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% image https://pic2.zhimg.com/80/v2-cc93c338d57783702bea4506aee7007d_1440w.jpg?source=1940ef5c, alt=自定义图片 %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="指定宽度"><a href="#指定宽度" class="headerlink" title="指定宽度"></a>指定宽度</h2><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="https://api.ixiaowai.cn/gqapi/gqapi.php" class="lazyload placeholder" data-srcset="https://api.ixiaowai.cn/gqapi/gqapi.php" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="随机生成风景（alt描述可有可无）" style="width:400px;"/></div><span class="image-caption">随机生成风景（alt描述可有可无）</span></div><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="https://api.ixiaowai.cn/api/api.php" class="lazyload placeholder" data-srcset="https://api.ixiaowai.cn/api/api.php" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="随机生成二次元壁纸" style="width:400px;"/></div><span class="image-caption">随机生成二次元壁纸</span></div><h3 id="上述事例代码-2"><a href="#上述事例代码-2" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% image https://api.ixiaowai.cn/gqapi/gqapi.php, width=400px, alt=随机生成风景（alt描述可有可无） %&#125;&#123;% image https://api.ixiaowai.cn/api/api.php, width=400px, alt=随机生成二次元壁纸 %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="设置占位背景色"><a href="#设置占位背景色" class="headerlink" title="设置占位背景色"></a>设置占位背景色</h2><div class="img-wrap"><div class="img-bg" style="background:#1D0C04"><img class="img lazyload placeholder" src="https://api.ixiaowai.cn/mcapi/mcapi.php" class="lazyload placeholder" data-srcset="https://api.ixiaowai.cn/mcapi/mcapi.php" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="随机生成呆萌酱" style="width:400px;"/></div><span class="image-caption">随机生成呆萌酱</span></div><h3 id="上述事例代码-3"><a href="#上述事例代码-3" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% image  https://api.ixiaowai.cn/mcapi/mcapi.php, width=400px, bg=#1D0C04, alt=随机生成呆萌酱 %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 class="bamboo-h " id="gallery图片">gallery图片</h1><br/><blockquote><p>使用该标签请先将主题下的_config.yml中的fancybox设置为true</p></blockquote><h2 id="一行一个图片"><a href="#一行一个图片" class="headerlink" title="一行一个图片"></a>一行一个图片</h2><div class="gallery ">              <p><img src="https://pic4.zhimg.com/80/v2-515859a54d7c9b89c070c6132dff4527_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-515859a54d7c9b89c070c6132dff4527_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"></p>            </div><h3 id="上述事例代码-4"><a href="#上述事例代码-4" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% gallery %&#125;<span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic4.zhimg.com/80/v2-515859a54d7c9b89c070c6132dff4527_1440w.jpg?source=1940ef5c</span>)</span>&#123;% endgallery %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="一行多个图片（不换行）"><a href="#一行多个图片（不换行）" class="headerlink" title="一行多个图片（不换行）"></a>一行多个图片（不换行）</h2><div class="gallery ">              <p><img src="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"></p>            </div><h3 id="上述事例代码-5"><a href="#上述事例代码-5" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% gallery %&#125;<span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c</span>)</span>&#123;% endgallery %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="多行多个图片（每行2～8个图片）"><a href="#多行多个图片（每行2～8个图片）" class="headerlink" title="多行多个图片（每行2～8个图片）"></a>多行多个图片（每行2～8个图片）</h2><div class="gallery stretch" col='4'>              <p><img src="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"></p>            </div><h3 id="上述事例代码-6"><a href="#上述事例代码-6" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% gallery stretch, 4 %&#125;<span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c</span>)</span>&#123;% endgallery %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="多行多个图片（每行2～8个图片）-1"><a href="#多行多个图片（每行2～8个图片）-1" class="headerlink" title="多行多个图片（每行2～8个图片）"></a>多行多个图片（每行2～8个图片）</h2><div class="gallery stretch" col='8'>              <p><img src="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-d0fe3a2cc79628c6a017f0066d4dee63_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-d0fe3a2cc79628c6a017f0066d4dee63_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic4.zhimg.com/80/v2-f7d6c7021cff3e23d8481faec2048890_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-f7d6c7021cff3e23d8481faec2048890_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic4.zhimg.com/80/v2-d191b620ff97a55b634786528206002a_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-d191b620ff97a55b634786528206002a_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-d0fe3a2cc79628c6a017f0066d4dee63_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-d0fe3a2cc79628c6a017f0066d4dee63_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic4.zhimg.com/80/v2-f7d6c7021cff3e23d8481faec2048890_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-f7d6c7021cff3e23d8481faec2048890_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic4.zhimg.com/80/v2-d191b620ff97a55b634786528206002a_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-d191b620ff97a55b634786528206002a_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-d0fe3a2cc79628c6a017f0066d4dee63_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-d0fe3a2cc79628c6a017f0066d4dee63_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic4.zhimg.com/80/v2-f7d6c7021cff3e23d8481faec2048890_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-f7d6c7021cff3e23d8481faec2048890_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"></p>            </div><h3 id="上述事例代码-7"><a href="#上述事例代码-7" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><p>多行多个图片（每行2～8个图片）</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% gallery stretch, 8 %&#125;<span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-d0fe3a2cc79628c6a017f0066d4dee63_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic4.zhimg.com/80/v2-f7d6c7021cff3e23d8481faec2048890_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic4.zhimg.com/80/v2-d191b620ff97a55b634786528206002a_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-d0fe3a2cc79628c6a017f0066d4dee63_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic4.zhimg.com/80/v2-f7d6c7021cff3e23d8481faec2048890_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic4.zhimg.com/80/v2-d191b620ff97a55b634786528206002a_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-d0fe3a2cc79628c6a017f0066d4dee63_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic4.zhimg.com/80/v2-f7d6c7021cff3e23d8481faec2048890_1440w.jpg?source=1940ef5c</span>)</span>&#123;% endgallery %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="组合使用"><a href="#组合使用" class="headerlink" title="组合使用"></a>组合使用</h2><div class="gallery ">              <p><img src="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"></p>            </div><div class="gallery ">              <p><img src="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"></p>            </div><div class="gallery ">              <p><img src="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"><br><img src="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="图片描述"></p>            </div><h3 id="上述事例代码-8"><a href="#上述事例代码-8" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% gallery %&#125;<span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c</span>)</span>&#123;% endgallery %&#125;&#123;% gallery %&#125;<span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-c513cb0d2eff43b5391ea682f1ba07c6_1440w.jpg?source=1940ef5c</span>)</span>&#123;% endgallery %&#125;&#123;% gallery %&#125;<span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-bcb819edb98e081817066eb6b0e6a2ef_1440w.jpg?source=1940ef5c</span>)</span><span class="token url"><span class="token operator">!</span>[<span class="token content">图片描述</span>](<span class="token url">https://pic2.zhimg.com/80/v2-f1b467abef1caeb5537f399da4ddbc9d_1440w.jpg?source=1940ef5c</span>)</span>&#123;% endgallery %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="galleryGroup图片">galleryGroup图片</h1><br/> <blockquote><p>提示:使用该标签请先将主题下的_config.yml中的fancybox设置为true</p></blockquote><h2 id="galleryGroup图片示例"><a href="#galleryGroup图片示例" class="headerlink" title="galleryGroup图片示例"></a>galleryGroup图片示例</h2><div class="gallery-group-main">      <figure class="gallery-group">  <img class="gallery-group-img" src='https://pic1.zhimg.com/80/v2-23c3820e8abfb1cef689531af2dc6d09_1440w.jpg?source=1940ef5c' alt="Group Image Gallery">  <figcaption>  <div class="gallery-group-name">壁纸</div>  <p>收藏的一些壁纸</p>  <a href='/gallery/bizhi'></a>  </figcaption>  </figure>        <figure class="gallery-group">  <img class="gallery-group-img" src='https://pic1.zhimg.com/80/v2-8d542d68cbbf0e5f503da9e3f72b8447_1440w.jpg?source=1940ef5c' alt="Group Image Gallery">  <figcaption>  <div class="gallery-group-name">古典图片</div>  <p>中国古典图片</p>  <a href='/gallery/gudian'></a>  </figcaption>  </figure>        <figure class="gallery-group">  <img class="gallery-group-img" src='https://pic1.zhimg.com/80/v2-56164ef0695767475935c9e019c594ae_1440w.jpg?source=1940ef5c' alt="Group Image Gallery">  <figcaption>  <div class="gallery-group-name">风景</div>  <p>风景图片</p>  <a href='/gallery/fengjing'></a>  </figcaption>  </figure>  </div><h3 id="上述示例代码"><a href="#上述示例代码" class="headerlink" title="上述示例代码"></a>上述示例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>gallery-group-main<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    &#123;% galleryGroup '壁纸' '收藏的一些壁纸' '/gallery/bizhi' https://pic1.zhimg.com/80/v2-23c3820e8abfb1cef689531af2dc6d09_1440w.jpg?source=1940ef5c %&#125;    &#123;% galleryGroup '古典图片' '中国古典图片' '/gallery/gudian' https://pic1.zhimg.com/80/v2-8d542d68cbbf0e5f503da9e3f72b8447_1440w.jpg?source=1940ef5c %&#125;    &#123;% galleryGroup '风景' '风景图片' '/gallery/fengjing' https://pic1.zhimg.com/80/v2-56164ef0695767475935c9e019c594ae_1440w.jpg?source=1940ef5c %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="audio音频效果展示">audio音频效果展示</h1><br/><div class="audio"><audio controls preload><source src='http://qiniu.cunzhuang.top/%E5%85%AD%E5%93%B2%20-%20%E4%BD%A0%E7%9A%84%E5%BF%83%E6%98%AF%E5%90%A6%E4%B9%9F%E6%9C%89%E6%88%91%E7%9A%84%E5%90%8D.mp3' type='audio/mp3'>Your browser does not support the audio tag.</audio></div><h3 id="上述示例代码-1"><a href="#上述示例代码-1" class="headerlink" title="上述示例代码"></a>上述示例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% title h1, audio音频效果展示 %&#125;&#123;% audio http://qiniu.cunzhuang.top/%E5%85%AD%E5%93%B2%20-%20%E4%BD%A0%E7%9A%84%E5%BF%83%E6%98%AF%E5%90%A6%E4%B9%9F%E6%9C%89%E6%88%91%E7%9A%84%E5%90%8D.mp3 %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="video演示">video演示</h1><br/><p>100%宽度</p><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div><p>50%宽度</p><div class="videos" col='2'><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div></div><p>25%宽度</p><div class="videos" col='4'><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div><div class="video"><video controls preload><source src='https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4' type='video/mp4'>Your browser does not support the video tag.</video></div></div><h3 id="上述事例代码-9"><a href="#上述事例代码-9" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% title h1, video演示 %&#125;100%宽度&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;50%宽度&#123;% videos, 2 %&#125;&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;&#123;% endvideos %&#125;25%宽度&#123;% videos, 4 %&#125;&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;&#123;% video  https://assets.mixkit.co/videos/preview/mixkit-down-the-river-in-a-bamboo-canoe-6804-large.mp4 %&#125;&#123;% endvideos %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 本站介绍 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> markdown </tag>
            
            <tag> media </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>主题介绍-github书写功能</title>
      <link href="/post/ben-zhan-jie-shao/zhu-ti-jie-shao-github-shu-xie-gong-neng/"/>
      <url>/post/ben-zhan-jie-shao/zhu-ti-jie-shao-github-shu-xie-gong-neng/</url>
      
        <content type="html"><![CDATA[<h1 class="bamboo-h " id="Github用户卡片">Github用户卡片</h1><br/><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi"><img src="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a><h3 id="上述示例代码"><a href="#上述示例代码" class="headerlink" title="上述示例代码"></a>上述示例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% ghcard jimyfengqi %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="表格中加入用户卡片"><a href="#表格中加入用户卡片" class="headerlink" title="表格中加入用户卡片"></a>表格中加入用户卡片</h2><table><thead><tr><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi"><img src="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></th><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi"><img src="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=vue&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=vue&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></th></tr></thead><tbody><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi"><img src="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=buefy&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=buefy&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi"><img src="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=solarized-light&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=solarized-light&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi"><img src="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=onedark&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=onedark&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi"><img src="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=solarized-dark&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=solarized-dark&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi"><img src="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=algolia&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=algolia&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi"><img src="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=calm&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/?username=jimyfengqi&theme=calm&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></td></tr></tbody></table><h3 id="上述示例代码-1"><a href="#上述示例代码-1" class="headerlink" title="上述示例代码"></a>上述示例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">| &#123;% ghcard jimyfengqi %&#125; | &#123;% ghcard jimyfengqi, theme=vue %&#125; || -- | -- || &#123;% ghcard jimyfengqi, theme=buefy %&#125; | &#123;% ghcard jimyfengqi, theme=solarized-light %&#125; || &#123;% ghcard jimyfengqi, theme=onedark %&#125; | &#123;% ghcard jimyfengqi, theme=solarized-dark %&#125; || &#123;% ghcard jimyfengqi, theme=algolia %&#125; | &#123;% ghcard jimyfengqi, theme=calm %&#125; |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="单个项目卡片"><a href="#单个项目卡片" class="headerlink" title="单个项目卡片"></a>单个项目卡片</h2><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi/hexo-theme-bomboo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi/hexo-theme-bomboo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi/hexo-theme-bomboo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi/hexo-theme-bomboo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a><h3 id="上述事例代码"><a href="#上述事例代码" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% ghcard jimyfengqi/hexo-theme-bomboo %&#125;&#123;% ghcard jimyfengqi/hexo-theme-bomboo %&#125;&#123;% ghcard jimyfengqi/hexo-theme-bomboo %&#125;&#123;% ghcard jimyfengqi/hexo-theme-bomboo %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="表格中加入单个项目卡片"><a href="#表格中加入单个项目卡片" class="headerlink" title="表格中加入单个项目卡片"></a>表格中加入单个项目卡片</h2><table><thead><tr><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi/hexo-theme-bomboo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></th><th><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi/hexo-theme-bomboo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=vue&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=vue&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></th></tr></thead><tbody><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi/hexo-theme-bomboo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=buefy&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=buefy&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi/hexo-theme-bomboo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=solarized-light&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=solarized-light&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi/hexo-theme-bomboo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=onedark&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=onedark&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi/hexo-theme-bomboo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=solarized-dark&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=solarized-dark&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></td></tr><tr><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi/hexo-theme-bomboo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=algolia&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=algolia&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></td><td><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/jimyfengqi/hexo-theme-bomboo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=calm&show_owner=true" class="lazyload placeholder" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=jimyfengqi&repo=hexo-theme-bomboo&theme=calm&show_owner=true" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></a></td></tr></tbody></table><h3 id="上述事例代码-1"><a href="#上述事例代码-1" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">| &#123;% ghcard jimyfengqi/hexo-theme-bomboo %&#125; | &#123;% ghcard jimyfengqi/hexo-theme-bomboo, theme=vue %&#125; || -- | -- || &#123;% ghcard jimyfengqi/hexo-theme-bomboo, theme=buefy %&#125; | &#123;% ghcard jimyfengqi/hexo-theme-bomboo, theme=solarized-light %&#125; || &#123;% ghcard jimyfengqi/hexo-theme-bomboo, theme=onedark %&#125; | &#123;% ghcard jimyfengqi/hexo-theme-bomboo, theme=solarized-dark %&#125; || &#123;% ghcard jimyfengqi/hexo-theme-bomboo, theme=algolia %&#125; | &#123;% ghcard jimyfengqi/hexo-theme-bomboo, theme=calm %&#125; |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="issues-sites标签">issues-sites标签</h1><br/><p>该标签会去拿到某个repo仓库的issue内容，用sites标签的形式显示出来，可以用做网站的友链功能<br>该标签和issues-timeline标签都适用于github和gitee</p><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>issue里面需要有JSON代码块：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token property">"screenshot"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Github写法"><a href="#Github写法" class="headerlink" title="Github写法"></a>Github写法</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% issues sites | api=https://api.github.com/repos/jimyfengqi/friends/issues?sort=updated&amp;state=open&amp;page=1&amp;per_page=100&amp;labels=active %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Gitee写法"><a href="#Gitee写法" class="headerlink" title="Gitee写法"></a>Gitee写法</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% issues sites | api=https://gitee.com/api/v5/repos/jimyfengqi/friends/issues?sort=updated&amp;state=open&amp;page=1&amp;per_page=100&amp;labels=active %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>yuang01: 用户名，friends: 仓库名<br>上例中的 labels=active 参数可以控制默认的 issue 不显示，只有自己审核通过添加了 active 标签之后才会显示。<br>当然label也是自己设置的，你可以自己选择一个好识别的标签<br>上述示例对应的仓库链接：<br><a href="https://github.com/jimyfengqi/friends">github</a><br><a href="https://gitee.com/jimyfengqi/friends">gitee</a></p><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>可以点击 <a href="https://jimyfengqi.github.io/friends/">友链</a> 查看</p><h1 class="bamboo-h " id="issues-timeline标签">issues-timeline标签</h1><br/> <p>该标签会去拿到某个repo仓库的issue内容，用timeline标签的形式显示出来</p><h3 id="github写法"><a href="#github写法" class="headerlink" title="github写法"></a>github写法</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% issues timeline | api=https://api.github.com/repos/jimyfengqi/hexo-theme-bomboo/issues?sort=updated&amp;state=closed&amp;page=1&amp;per_page=100 %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre><code>api=xxx:jimyfengqi是我的github用户名，hexo-theme-bomboo是我的仓库名，state=closed，表示拿到状态为close的issue，根据自己实际情况更改</code></pre><h3 id="Gitee写法-1"><a href="#Gitee写法-1" class="headerlink" title="Gitee写法"></a>Gitee写法</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% issues timeline | api=https://gitee.com/api/v5/repos/jimyfengqi/friends/issues %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre><code>api=xxx:jimyfengqi是我的gitee用户名，friends是我gitee的仓库名，其他参数请见文档</code></pre><h2 id="issue-api"><a href="#issue-api" class="headerlink" title="issue api"></a>issue api</h2><p><a href="https://docs.github.com/cn/rest/overview/resources-in-the-rest-api">github的开放api</a><br><a href="https://gitee.com/api/v5/swagger#/getV5ReposOwnerRepoIssues">gitee的开放api</a></p><h2 id="repo仓库效果"><a href="#repo仓库效果" class="headerlink" title="repo仓库效果"></a>repo仓库效果</h2><p>下面的效果是来自于这这两个仓库的issue</p><p>hexo-theme-bomboo (Github)</p><p><a href="https://github.com/jimyfengqi/hexo-theme-bomboo/issues?q=is:issue+is:closed+sort:updated-desc">https://github.com/jimyfengqi/hexo-theme-bomboo/issues?q=is%3Aissue+is%3Aclosed+sort%3Aupdated-desc</a></p><p>friends (Gitee)</p><p><a href="https://gitee.com/jimyfengqi/friends/issues">https://gitee.com/jimyfengqi/friends/issues</a></p><h3 id="Github效果-example"><a href="#Github效果-example" class="headerlink" title="Github效果(example)"></a>Github效果(example)</h3><div class="issues-api timeline"api="https://api.github.com/repos/jimyfengqi/hexo-theme-bomboo/issues?sort=updated&state=closed&page=1&per_page=100"></div><h3 id="Gitee效果-example"><a href="#Gitee效果-example" class="headerlink" title="Gitee效果(example)"></a>Gitee效果(example)</h3><div class="issues-api timeline"api="https://gitee.com/api/v5/repos/jimyfengqi/friends/issues"></div>]]></content>
      
      
      <categories>
          
          <category> 本站介绍 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>主题介绍-文档书写功能</title>
      <link href="/post/ben-zhan-jie-shao/zhu-ti-jie-shao-wen-dang-shu-xie-gong-neng/"/>
      <url>/post/ben-zhan-jie-shao/zhu-ti-jie-shao-wen-dang-shu-xie-gong-neng/</url>
      
        <content type="html"><![CDATA[<h1 class="bamboo-h-b" id="我是标题，1级标题" style="color:!important">我是标题，1级标题</h1><div></div><h2 class="bamboo-h-b" id="我是标题， 2级标题" style="color:#895546!important">我是标题， 2级标题</h2><div></div><h3 class="bamboo-h-b" id="我是标题， 3级标题" style="color:red!important">我是标题， 3级标题</h3><div></div><h3 id="上述事例代码"><a href="#上述事例代码" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% titleB h1, 我是标题， 1级标题 %&#125;&#123;% titleB h2, 我是标题， 2级标题, #895546 %&#125;&#123;% titleB h3, 我是标题， 3级标题, red %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="段落文本标签演示效果">段落文本标签演示效果</h1><br/><p class='p yellow'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p '>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p primary'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p info'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p warning'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p danger'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p success'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p red'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p green'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p blue'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p center'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p center large danger'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p center large info'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><p class='p center small'>我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多</p><h3 id="上述事例代码-1"><a href="#上述事例代码-1" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% p yellow, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p primary, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p info, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p warning, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p danger, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p success, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p red, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p green, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p blue, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p center, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p center large danger, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p center large info, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;&#123;% p center small, 我是一个文本高亮大萨达所多撒多撒多撒大多多撒多撒多撒大所多撒大多 %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="文本高亮标签演示效果">文本高亮标签演示效果</h1><br/><p>这是一个简单的文字<span class='pbg yellow'>我是一个文本高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='pbg '>我是一个文本高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='pbg info'>我是一个文本高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='pbg warning'>我是一个文本高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='pbg danger'>我是一个文本高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='pbg success'>我是一个文本高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='pbg red'>我是一个文本高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='pbg green'>我是一个文本高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='pbg blue'>我是一个文本高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='pbg cyan'>我是一个文本高亮</span>，唱着我们心肠的曲折</p><h3 id="上述事例代码-2"><a href="#上述事例代码-2" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">这是一个简单的文字&#123;% pbg yellow, 我是一个文本高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% pbg, 我是一个文本高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% pbg info, 我是一个文本高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% pbg warning, 我是一个文本高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% pbg danger, 我是一个文本高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% pbg success, 我是一个文本高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% pbg red, 我是一个文本高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% pbg green, 我是一个文本高亮 %&#125;，唱着我们心肠的曲折 这是一个简单的文字&#123;% pbg blue, 我是一个文本高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% pbg cyan, 我是一个文本高亮 %&#125;，唱着我们心肠的曲折<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="文字颜色标签演示效果">文字颜色标签演示效果</h1><br/><p>这是一个简单的文字<span class='p yellow'>我是一个文字高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='p '>我是一个文字高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='p primary'>我是一个文字高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='p info'>我是一个文字高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='p warning'>我是一个文字高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='p danger'>我是一个文字高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='p success'>我是一个文字高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='p red'>我是一个文字高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='p green'>我是一个文字高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='p blue'>我是一个文字高亮</span>，唱着我们心肠的曲折</p><span class='p center green'>我是一个居中文字高亮</span><p>这是一个简单的文字<span class='p large'>我是一个文字高亮</span>，唱着我们心肠的曲折<br>这是一个简单的文字<span class='p small danger'>我是一个文字高亮</span>，唱着我们心肠的曲折</p><h3 id="上述事例代码-3"><a href="#上述事例代码-3" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">这是一个简单的文字&#123;% span yellow, 我是一个文字高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% span, 我是一个文字高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% span primary, 我是一个文字高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% span info, 我是一个文字高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% span warning, 我是一个文字高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% span danger, 我是一个文字高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% span success, 我是一个文字高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% span red, 我是一个文字高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% span green, 我是一个文字高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% span blue, 我是一个文字高亮 %&#125;，唱着我们心肠的曲折&#123;% span center green, 我是一个居中文字高亮 %&#125;这是一个简单的文字&#123;% span large, 我是一个文字高亮 %&#125;，唱着我们心肠的曲折这是一个简单的文字&#123;% span small danger, 我是一个文字高亮 %&#125;，唱着我们心肠的曲折<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="Text文本样式标签演示">Text文本样式标签演示</h1><br/><p>带 <u>下划线</u> 的文本</p><p>带 <emp>着重号</emp> 的文本</p><p>带 <wavy>波浪线</wavy> 的文本</p><p>带 <del>删除线</del> 的文本</p><p>键盘样式的文本 <kbd>command</kbd> + <kbd>D</kbd></p><p>密码样式的文本：<psw>这里没有验证码</psw></p><h3 id="上述事例代码-4"><a href="#上述事例代码-4" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% title h2, Text文本样式标签演示 %&#125;带 &#123;% u 下划线 %&#125; 的文本带 &#123;% emp 着重号 %&#125; 的文本带 &#123;% wavy 波浪线 %&#125; 的文本带 &#123;% del 删除线 %&#125; 的文本键盘样式的文本 &#123;% kbd command %&#125; + &#123;% kbd D %&#125;密码样式的文本：&#123;% psw 这里没有验证码 %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="Note标签演示效果">Note标签演示效果</h1><br/><blockquote><p>markdown默认写法，左边框颜色，随着主题色改变</p></blockquote><div class="note "><p>我有一只小毛驴，我从来都不骑。</p></div><div class="note quote"><p>适合引用一段话</p></div><div class="note warning"><p>这是一个警告</p></div><div class="note danger"><p>这是一个错误</p></div><div class="note success"><p>这是一个成功</p></div><div class="note info"><p>这是一个信息</p></div><h3 id="上述事例代码-5"><a href="#上述事例代码-5" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token blockquote punctuation">></span> markdown默认写法，左边框颜色，随着主题色改变&#123;% note, 我有一只小毛驴，我从来都不骑。 %&#125;&#123;% note quote, 适合引用一段话 %&#125;&#123;% note warning, 这是一个警告 %&#125;&#123;% note danger, 这是一个错误 %&#125;&#123;% note success, 这是一个成功 %&#125;&#123;% note info, 这是一个信息 %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="NoteBlock标签演示效果">NoteBlock标签演示效果</h1><br/><div class="note base"><p><strong>标题（可选）</strong></p><p>asdsd</p></div><div class="note quote"><p><strong>标题（可选）</strong></p><p>asdsd</p></div><div class="note warning"><p><strong>标题（可选）</strong></p><p>asdsd</p></div><div class="note success"><p><strong>标题（可选）</strong></p><p>asdsd</p></div><div class="note danger"><p><strong>标题（可选）</strong></p><p>asdsd</p></div><div class="note info"><p><strong>标题（可选）</strong></p><p>asdsd</p></div><h3 id="上述事例代码-6"><a href="#上述事例代码-6" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% noteblock base, 标题（可选） %&#125;    asdsd&#123;% endnoteblock %&#125;&#123;% noteblock quote, 标题（可选） %&#125;    asdsd&#123;% endnoteblock %&#125;&#123;% noteblock warning, 标题（可选） %&#125;    asdsd&#123;% endnoteblock %&#125;&#123;% noteblock success, 标题（可选） %&#125;    asdsd&#123;% endnoteblock %&#125;&#123;% noteblock danger, 标题（可选） %&#125;    asdsd&#123;% endnoteblock %&#125;&#123;% noteblock info, 标题（可选） %&#125;    asdsd&#123;% endnoteblock %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="进度条示例">进度条示例</h1><br/> <blockquote><p>该标签适用版本为1.8.1及以上</p></blockquote><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-danger"  style="width: 70%" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"><p>进度条测试</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-info"  style="width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"><p>进度条测试</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-success"  style="width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"><p>进度条测试</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-warning"  style="width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"><p>进度条测试</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped bg-primary"  style="width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"><p>进度条测试</p></div></div><p>自定义颜色(Custom colors)</p><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped" style="background-color: #000!important; width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"><p>进度条测试</p></div></div><div class="progress"><div class="progress-bar-animated progress-bar progress-bar-striped" style="background-color: #2f54eb!important; width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"><p>进度条测试</p></div></div><h3 id="上述示例代码"><a href="#上述示例代码" class="headerlink" title="上述示例代码"></a>上述示例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% progress 70 danger 进度条测试 %&#125;&#123;% progress 60 info 进度条测试 %&#125;&#123;% progress 60 success 进度条测试 %&#125;&#123;% progress 60 warning 进度条测试 %&#125;&#123;% progress 60 primary 进度条测试 %&#125;自定义颜色(Custom colors)&#123;% progress 60 #000 进度条测试 %&#125;&#123;% progress 60 #2f54eb 进度条测试 %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="Link效果">Link效果</h1><br/><div class="tagLink"><a class="link-card" title="点击跳转到百度" href="http://www.baidu.com"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" class="lazyload placeholder" data-srcset="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">点击跳转到百度</p><p class="url">http://www.baidu.com</p></div></a></div><div class="tagLink"><a class="link-card" title="点击跳转到百度" href="http://www.baidu.com"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" class="lazyload placeholder" data-srcset="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">点击跳转到百度</p><p class="url">http://www.baidu.com</p></div></a></div><h3 id="上述事例代码-7"><a href="#上述事例代码-7" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% link 点击跳转到百度, http://www.baidu.com, https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg %&#125;&#123;% link 点击跳转到百度, http://www.baidu.com, https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="多行链接"><a href="#多行链接" class="headerlink" title="多行链接"></a>多行链接</h2><div class="link-group"><div class="tagLink"><a class="link-card" title="点击跳转到百度" href="http://www.baidu.com"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" class="lazyload placeholder" data-srcset="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">点击跳转到百度</p><p class="url">http://www.baidu.com</p></div></a></div><div class="tagLink"><a class="link-card" title="点击跳转到百度" href="http://www.baidu.com"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" class="lazyload placeholder" data-srcset="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">点击跳转到百度</p><p class="url">http://www.baidu.com</p></div></a></div><div class="tagLink"><a class="link-card" title="点击跳转到百度" href="http://www.baidu.com"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" class="lazyload placeholder" data-srcset="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">点击跳转到百度</p><p class="url">http://www.baidu.com</p></div></a></div><div class="tagLink"><a class="link-card" title="点击跳转到百度" href="http://www.baidu.com"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" class="lazyload placeholder" data-srcset="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">点击跳转到百度</p><p class="url">http://www.baidu.com</p></div></a></div></div><h3 id="上述事例代码-8"><a href="#上述事例代码-8" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% linkgroup %&#125;&#123;% link 点击跳转到百度, http://www.baidu.com, https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg %&#125;&#123;% link 点击跳转到百度, http://www.baidu.com, https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg %&#125;&#123;% link 点击跳转到百度, http://www.baidu.com, https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg %&#125;&#123;% link 点击跳转到百度, http://www.baidu.com, https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg %&#125;&#123;% endlinkgroup %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="圆形进度条示例">圆形进度条示例</h1><br/> <blockquote><p>该标签适用版本为2.0.7+及以上</p></blockquote>    <div class="bamboo-circle" style="height: 136px;">      <svg width="136" height="136" viewBox="0 0 272 272">        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke="#f3f3f3" stroke-width="12" fill-opacity="0"></path>        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke-linecap="round" stroke="#f66" stroke-width="12" fill-opacity="0" style="stroke-dasharray: 816.8140899333462px 816.8140899333462px; stroke-dashoffset: 245.04422698000383px; transition:stroke-dashoffset 0.6s ease 0s, stroke 0.6s ease;"></path>      </svg>      <div class="bamboo-circle-content bamboo-circle-danger">        <p>进度条测试</p>      </div>    </div>    <div class="bamboo-circle" style="height: 136px;">      <svg width="136" height="136" viewBox="0 0 272 272">        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke="#f3f3f3" stroke-width="12" fill-opacity="0"></path>        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke-linecap="round" stroke="#409eff" stroke-width="12" fill-opacity="0" style="stroke-dasharray: 816.8140899333462px 816.8140899333462px; stroke-dashoffset: 163.36281798666926px; transition:stroke-dashoffset 0.6s ease 0s, stroke 0.6s ease;"></path>      </svg>      <div class="bamboo-circle-content bamboo-circle-info">        <p>进度条测试</p>      </div>    </div>    <div class="bamboo-circle" style="height: 136px;">      <svg width="136" height="136" viewBox="0 0 272 272">        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke="#f3f3f3" stroke-width="12" fill-opacity="0"></path>        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke-linecap="round" stroke="#67c23a" stroke-width="12" fill-opacity="0" style="stroke-dasharray: 816.8140899333462px 816.8140899333462px; stroke-dashoffset: 326.7256359733385px; transition:stroke-dashoffset 0.6s ease 0s, stroke 0.6s ease;"></path>      </svg>      <div class="bamboo-circle-content bamboo-circle-success">        <p>进度条测试</p>      </div>    </div>    <div class="bamboo-circle" style="height: 136px;">      <svg width="136" height="136" viewBox="0 0 272 272">        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke="#f3f3f3" stroke-width="12" fill-opacity="0"></path>        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke-linecap="round" stroke="#e6a23c" stroke-width="12" fill-opacity="0" style="stroke-dasharray: 816.8140899333462px 816.8140899333462px; stroke-dashoffset: 408.4070449666731px; transition:stroke-dashoffset 0.6s ease 0s, stroke 0.6s ease;"></path>      </svg>      <div class="bamboo-circle-content bamboo-circle-warning">        <p>进度条测试</p>      </div>    </div>    <div class="bamboo-circle" style="height: 136px;">      <svg width="136" height="136" viewBox="0 0 272 272">        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke="#f3f3f3" stroke-width="12" fill-opacity="0"></path>        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke-linecap="round" stroke="#42b983" stroke-width="12" fill-opacity="0" style="stroke-dasharray: 816.8140899333462px 816.8140899333462px; stroke-dashoffset: 81.68140899333463px; transition:stroke-dashoffset 0.6s ease 0s, stroke 0.6s ease;"></path>      </svg>      <div class="bamboo-circle-content bamboo-circle-primary">        <p>进度条测试</p>      </div>    </div><p>自定义颜色(Custom colors)</p>    <div class="bamboo-circle" style="height: 136px;">      <svg width="136" height="136" viewBox="0 0 272 272">        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke="#f3f3f3" stroke-width="12" fill-opacity="0"></path>        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke-linecap="round" stroke="#12e9e9" stroke-width="12" fill-opacity="0" style="stroke-dasharray: 816.8140899333462px 816.8140899333462px; stroke-dashoffset: 245.04422698000383px; transition:stroke-dashoffset 0.6s ease 0s, stroke 0.6s ease;"></path>      </svg>      <div class="bamboo-circle-content bamboo-circle-#12e9e9">        <p>70%</p>      </div>    </div>    <div class="bamboo-circle" style="height: 136px;">      <svg width="136" height="136" viewBox="0 0 272 272">        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke="#f3f3f3" stroke-width="12" fill-opacity="0"></path>        <path d="M 136,136 m 0,-130    a 130,130 0 1 1 0,260    a 130,130 0 1 1 0,-260" stroke-linecap="round" stroke="skyblue" stroke-width="12" fill-opacity="0" style="stroke-dasharray: 816.8140899333462px 816.8140899333462px; stroke-dashoffset: 245.04422698000383px; transition:stroke-dashoffset 0.6s ease 0s, stroke 0.6s ease;"></path>      </svg>      <div class="bamboo-circle-content bamboo-circle-skyblue">        <p>70%</p>      </div>    </div><h3 id="上述示例代码-1"><a href="#上述示例代码-1" class="headerlink" title="上述示例代码"></a>上述示例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% progressCircle 70 danger 进度条测试 %&#125;&#123;% progressCircle 80 info 进度条测试 %&#125;&#123;% progressCircle 60 success 进度条测试 %&#125;&#123;% progressCircle 50 warning 进度条测试 %&#125;&#123;% progressCircle 90 primary 进度条测试 %&#125;自定义颜色(Custom colors)&#123;% progressCircle 70 #12e9e9 70% %&#125;&#123;% progressCircle 70 skyblue 70% %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="按钮">按钮</h1><br/> <h2 id="融入段落中按钮"><a href="#融入段落中按钮" class="headerlink" title="融入段落中按钮"></a>融入段落中按钮</h2><p>不设置任何参数的 <span class='btn'><a class="button" href='/' title='按钮'>按钮</a></span> 适合融入段落中。</p><p>不设置任何参数的 <span class='btn warning'><a class="button" href='/' title='按钮'>按钮</a></span> 适合融入段落中。</p><p>不设置任何参数的 <span class='btn info'><a class="button" href='/' title='按钮'>按钮</a></span> 适合融入段落中。</p><p>不设置任何参数的 <span class='btn success'><a class="button" href='/' title='按钮'>按钮</a></span> 适合融入段落中。</p><p>不设置任何参数的 <span class='btn danger'><a class="button" href='/' title='按钮'>按钮</a></span> 适合融入段落中。</p><h3 id="上述实例源码"><a href="#上述实例源码" class="headerlink" title="上述实例源码"></a>上述实例源码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">不设置任何参数的 &#123;% btn 按钮, / %&#125; 适合融入段落中。不设置任何参数的 &#123;% btn warning, 按钮, / %&#125; 适合融入段落中。不设置任何参数的 &#123;% btn info, 按钮, / %&#125; 适合融入段落中。不设置任何参数的 &#123;% btn success, 按钮, / %&#125; 适合融入段落中。不设置任何参数的 &#123;% btn danger, 按钮, / %&#125; 适合融入段落中。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="空心和实心按钮"><a href="#空心和实心按钮" class="headerlink" title="空心和实心按钮"></a>空心和实心按钮</h2><span class='btn hollow'><a class="button" href='https://baidu.com' title='示例博客'><i class='fab fa-qq'></i>示例博客</a></span><span class='btn solid'><a class="button" href='https://baidu.com' title='示例博客'><i class='fab fa-weixin'></i>示例博客</a></span><h3 id="上述实例源码-1"><a href="#上述实例源码-1" class="headerlink" title="上述实例源码"></a>上述实例源码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btn hollow, 示例博客, https://baidu.com, fab fa-qq %&#125;&#123;% btn solid, 示例博客, https://baidu.com, fab fa-weixin %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="大点的按钮和样式"><a href="#大点的按钮和样式" class="headerlink" title="大点的按钮和样式"></a>大点的按钮和样式</h2><span class='btn center large'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><h3 id="上述实例源码-2"><a href="#上述实例源码-2" class="headerlink" title="上述实例源码"></a>上述实例源码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btn center large, 开始使用, https://baidu.com, fa fa-download %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 class="bamboo-h " id="环形按钮">环形按钮</h1><br/><span class='btn center large round solid'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><h3 id="上述实例源码-3"><a href="#上述实例源码-3" class="headerlink" title="上述实例源码"></a>上述实例源码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btn center large round solid, 开始使用, https://baidu.com, fa fa-download %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="warning等颜色按钮"><a href="#warning等颜色按钮" class="headerlink" title="warning等颜色按钮"></a>warning等颜色按钮</h2><span class='btn large round solid warning'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><span class='btn large round solid info'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><span class='btn large round solid success'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><span class='btn large round solid danger'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><span class='btn large solid success'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><h3 id="上述实例源码-4"><a href="#上述实例源码-4" class="headerlink" title="上述实例源码"></a>上述实例源码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btn large round solid warning, 开始使用, https://baidu.com, fa fa-download %&#125;&#123;% btn large round solid info, 开始使用, https://baidu.com, fa fa-download %&#125;&#123;% btn large round solid success, 开始使用, https://baidu.com, fa fa-download %&#125;&#123;% btn large round solid danger, 开始使用, https://baidu.com, fa fa-download %&#125;&#123;% btn large solid success, 开始使用, https://baidu.com, fa fa-download %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="warning等颜色空心按钮"><a href="#warning等颜色空心按钮" class="headerlink" title="warning等颜色空心按钮"></a>warning等颜色空心按钮</h2><span class='btn large warning hollow'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><span class='btn large info hollow'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><span class='btn large success hollow'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><span class='btn large danger hollow'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><span class='btn success hollow'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><h3 id="上述实例源码-5"><a href="#上述实例源码-5" class="headerlink" title="上述实例源码"></a>上述实例源码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btn large warning hollow, 开始使用, https://baidu.com, fa fa-download %&#125;&#123;% btn large info hollow, 开始使用, https://baidu.com, fa fa-download %&#125;&#123;% btn large success hollow, 开始使用, https://baidu.com, fa fa-download %&#125;&#123;% btn large danger hollow, 开始使用, https://baidu.com, fa fa-download %&#125;&#123;% btn success hollow, 开始使用, https://baidu.com, fa fa-download %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="warning等颜色空心环形居中按钮"><a href="#warning等颜色空心环形居中按钮" class="headerlink" title="warning等颜色空心环形居中按钮"></a>warning等颜色空心环形居中按钮</h2><span class='btn large danger hollow center round'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><span class='btn danger hollow center round'><a class="button" href='https://baidu.com' title='开始使用'><i class='fa fa-download'></i>开始使用</a></span><h3 id="上述实例源码-6"><a href="#上述实例源码-6" class="headerlink" title="上述实例源码"></a>上述实例源码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btn large danger hollow center round, 开始使用, https://baidu.com, fa fa-download %&#125;&#123;% btn danger hollow center round, 开始使用, https://baidu.com, fa fa-download %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="带有头像和名称的按钮"><a href="#带有头像和名称的按钮" class="headerlink" title="带有头像和名称的按钮"></a>带有头像和名称的按钮</h2><div class="btns circle grid2">            <a class="button" href='https://baidu.com' title='草帽海贼团'><img src='https://img2.woyaogexing.com/2021/01/30/007e3777e7e64c4aae95ae812708a7bf!400x400.jpeg'>草帽海贼团</a><a class="button" href='https://baidu.com' title='小绵羊'><img src='https://img2.woyaogexing.com/2021/01/30/4c59f9dd4aae421fae21344aec8c7b60!400x400.jpeg'>小绵羊</a><a class="button" href='https://baidu.com' title='沫兮'><img src='https://img2.woyaogexing.com/2021/01/30/1b2aec116f0b49c682badc5befd43905!400x400.jpeg'>沫兮</a><a class="button" href='https://baidu.com' title='凯爹'><img src='https://p.qqan.com/up/2021-1/16112058848478910.jpg'>凯爹</a><a class="button" href='https://baidu.com' title='阿离'><img src='https://p.qqan.com/up/2021-1/16118869719896010.jpg'>阿离</a><a class="button" href='https://baidu.com' title='韩信'><img src='https://p.qqan.com/up/2021-1/16118869704182020.jpg'>韩信</a>          </div><h3 id="上述实例源码-7"><a href="#上述实例源码-7" class="headerlink" title="上述实例源码"></a>上述实例源码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btns circle grid2 %&#125;  &#123;% cell 草帽海贼团, https://baidu.com, https://img2.woyaogexing.com/2021/01/30/007e3777e7e64c4aae95ae812708a7bf!400x400.jpeg %&#125;  &#123;% cell 小绵羊, https://baidu.com, https://img2.woyaogexing.com/2021/01/30/4c59f9dd4aae421fae21344aec8c7b60!400x400.jpeg %&#125;  &#123;% cell 沫兮, https://baidu.com, https://img2.woyaogexing.com/2021/01/30/1b2aec116f0b49c682badc5befd43905!400x400.jpeg %&#125;  &#123;% cell 凯爹, https://baidu.com, https://p.qqan.com/up/2021-1/16112058848478910.jpg %&#125;  &#123;% cell 阿离, https://baidu.com, https://p.qqan.com/up/2021-1/16118869719896010.jpg %&#125;  &#123;% cell 韩信, https://baidu.com, https://p.qqan.com/up/2021-1/16118869704182020.jpg %&#125;&#123;% endbtns %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="一行三个带有头像和名称的按钮"><a href="#一行三个带有头像和名称的按钮" class="headerlink" title="一行三个带有头像和名称的按钮"></a>一行三个带有头像和名称的按钮</h2><div class="btns circle grid3">            <a class="button" href='https://baidu.com' title='QQ头像'><img src='http://q1.qlogo.cn/g?b=qq&nk=1730241541&s=640'>QQ头像</a><a class="button" href='https://baidu.com' title='随机动漫头像'><img src='http://api.btstu.cn/sjtx/api.php?lx=c1&format=images'>随机动漫头像</a><a class="button" href='https://baidu.com' title='随机男生头像'><img src='http://api.btstu.cn/sjtx/api.php?lx=a1&format=images'>随机男生头像</a><a class="button" href='https://baidu.com' title='随机女生头像'><img src='http://api.btstu.cn/sjtx/api.php?lx=b1&format=images'>随机女生头像</a><a class="button" href='https://baidu.com' title='随机动漫女头像'><img src='http://api.btstu.cn/sjtx/api.php?lx=c2&format=images'>随机动漫女头像</a><a class="button" href='https://baidu.com' title='随机动漫男头像'><img src='http://api.btstu.cn/sjtx/api.php?lx=c3&format=images'>随机动漫男头像</a>          </div><h3 id="上述实例源码-8"><a href="#上述实例源码-8" class="headerlink" title="上述实例源码"></a>上述实例源码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btns circle grid3 %&#125;  &#123;% cell QQ头像, https://baidu.com, http://q1.qlogo.cn/g?b=qq&amp;nk=1730241541&amp;s=640 %&#125;  &#123;% cell 随机动漫头像, https://baidu.com, http://api.btstu.cn/sjtx/api.php?lx=c1&amp;format=images %&#125;  &#123;% cell 随机男生头像, https://baidu.com, http://api.btstu.cn/sjtx/api.php?lx=a1&amp;format=images %&#125;  &#123;% cell 随机女生头像, https://baidu.com, http://api.btstu.cn/sjtx/api.php?lx=b1&amp;format=images %&#125;  &#123;% cell 随机动漫女头像, https://baidu.com, http://api.btstu.cn/sjtx/api.php?lx=c2&amp;format=images %&#125;  &#123;% cell 随机动漫男头像, https://baidu.com, http://api.btstu.cn/sjtx/api.php?lx=c3&amp;format=images %&#125;&#123;% endbtns %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="一行四个带有头像和名称的按钮"><a href="#一行四个带有头像和名称的按钮" class="headerlink" title="一行四个带有头像和名称的按钮"></a>一行四个带有头像和名称的按钮</h2><div class="btns circle grid4">            <a class="button" href='https://baidu.com' title='随机Github头像'><img src='https://api.prodless.com/avatar.png'>随机Github头像</a><a class="button" href='https://baidu.com' title='随机Github头像'><img src='https://api.prodless.com/avatar.png'>随机Github头像</a><a class="button" href='https://baidu.com' title='随机Github头像'><img src='https://api.prodless.com/avatar.png'>随机Github头像</a><a class="button" href='https://baidu.com' title='随机Github头像'><img src='https://api.prodless.com/avatar.png'>随机Github头像</a><a class="button" href='https://baidu.com' title='随机Github头像'><img src='https://api.prodless.com/avatar.png'>随机Github头像</a>          </div><h3 id="上述实例源码-9"><a href="#上述实例源码-9" class="headerlink" title="上述实例源码"></a>上述实例源码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btns circle grid4 %&#125;  &#123;% cell 随机Github头像, https://baidu.com, https://api.prodless.com/avatar.png %&#125;  &#123;% cell 随机Github头像, https://baidu.com, https://api.prodless.com/avatar.png %&#125;  &#123;% cell 随机Github头像, https://baidu.com, https://api.prodless.com/avatar.png %&#125;  &#123;% cell 随机Github头像, https://baidu.com, https://api.prodless.com/avatar.png %&#125;  &#123;% cell 随机Github头像, https://baidu.com, https://api.prodless.com/avatar.png %&#125;&#123;% endbtns %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="一行五个带有头像和名称的按钮"><a href="#一行五个带有头像和名称的按钮" class="headerlink" title="一行五个带有头像和名称的按钮"></a>一行五个带有头像和名称的按钮</h2><div class="btns circle grid5">            <a class="button" href='https://baidu.com' title='随机头像'><img src='https://picsum.photos/200'>随机头像</a><a class="button" href='https://baidu.com' title='随机头像id'><img src='https://picsum.photos/id/1/200'>随机头像id</a><a class="button" href='https://baidu.com' title='随机头像id'><img src='https://picsum.photos/id/2/200'>随机头像id</a><a class="button" href='https://baidu.com' title='随机头像id'><img src='https://picsum.photos/id/3/200'>随机头像id</a><a class="button" href='https://baidu.com' title='随机头像id'><img src='https://picsum.photos/id/4/200'>随机头像id</a>          </div><div class="btns circle grid5">            <a class="button" href='https://baidu.com' title='随机风景'><img src='https://api.ixiaowai.cn/gqapi/gqapi.php'>随机风景</a><a class="button" href='https://baidu.com' title='随机风景'><img src='https://api.ixiaowai.cn/gqapi/gqapi.php'>随机风景</a><a class="button" href='https://baidu.com' title='随机风景'><img src='https://api.ixiaowai.cn/gqapi/gqapi.php'>随机风景</a><a class="button" href='https://baidu.com' title='随机风景'><img src='https://api.ixiaowai.cn/gqapi/gqapi.php'>随机风景</a><a class="button" href='https://baidu.com' title='随机风景'><img src='https://api.ixiaowai.cn/gqapi/gqapi.php'>随机风景</a>          </div><h3 id="上述实例源码-10"><a href="#上述实例源码-10" class="headerlink" title="上述实例源码"></a>上述实例源码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btns circle grid5 %&#125;  &#123;% cell 随机头像, https://baidu.com, https://picsum.photos/200 %&#125;  &#123;% cell 随机头像id, https://baidu.com, https://picsum.photos/id/1/200 %&#125;  &#123;% cell 随机头像id, https://baidu.com, https://picsum.photos/id/2/200 %&#125;  &#123;% cell 随机头像id, https://baidu.com, https://picsum.photos/id/3/200 %&#125;  &#123;% cell 随机头像id, https://baidu.com, https://picsum.photos/id/4/200 %&#125;&#123;% endbtns %&#125;&#123;% btns circle grid5 %&#125;  &#123;% cell 随机风景, https://baidu.com,   https://api.ixiaowai.cn/gqapi/gqapi.php %&#125;  &#123;% cell 随机风景, https://baidu.com,   https://api.ixiaowai.cn/gqapi/gqapi.php %&#125;  &#123;% cell 随机风景, https://baidu.com,   https://api.ixiaowai.cn/gqapi/gqapi.php %&#125;  &#123;% cell 随机风景, https://baidu.com,   https://api.ixiaowai.cn/gqapi/gqapi.php %&#125;  &#123;% cell 随机风景, https://baidu.com,   https://api.ixiaowai.cn/gqapi/gqapi.php %&#125;&#123;% endbtns %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="环形图标按钮">环形图标按钮</h1><br/><h2 id="环形图标按钮"><a href="#环形图标按钮" class="headerlink" title="环形图标按钮"></a>环形图标按钮</h2><div class="btns rounded grid5">            <a class="button" href='/' title='下载源码'><i class='fa fa-download'></i>下载源码</a><a class="button" href='/' title='查看文档'><i class='fa fa-book'></i>查看文档</a>          </div><h3 id="上述事例代码-9"><a href="#上述事例代码-9" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btns rounded grid5 %&#125;  &#123;% cell 下载源码, /, fa fa-download %&#125;  &#123;% cell 查看文档, /, fa fa-book %&#125;&#123;% endbtns %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="环形图标填充按钮"><a href="#环形图标填充按钮" class="headerlink" title="环形图标填充按钮"></a>环形图标填充按钮</h2><div class="btns rounded grid5 center">            <a class="button" href='/' title='下载源码'><i class='fa fa-download'></i>下载源码</a><a class="button" href='/' title='查看文档'><i class='fa fa-book'></i>查看文档</a>          </div><h3 id="上述事例代码-10"><a href="#上述事例代码-10" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btns rounded grid5 center %&#125;  &#123;% cell 下载源码, /, fa fa-download %&#125;  &#123;% cell 查看文档, /, fa fa-book %&#125;&#123;% endbtns %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="环形图标填充按钮-1"><a href="#环形图标填充按钮-1" class="headerlink" title="环形图标填充按钮"></a>环形图标填充按钮</h2><div class="btns rounded grid5 fill">            <a class="button" href='/' title='下载源码'><i class='fa fa-download'></i>下载源码</a><a class="button" href='/' title='查看文档'><i class='fa fa-book'></i>查看文档</a>          </div><h3 id="上述事例代码-11"><a href="#上述事例代码-11" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btns rounded grid5 fill %&#125;  &#123;% cell 下载源码, /, fa fa-download %&#125;  &#123;% cell 查看文档, /, fa fa-book %&#125;&#123;% endbtns %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="圆形图标按钮">圆形图标按钮</h1><br/><div class="btns circle center grid5">            <a href='/medias/reward/wechat.bmp'>  <i class='fa fa-apple'></i>  <b>这个是微信</b>  <p class='p red'>微信</p>  <img src='/medias/reward/wechat.bmp'></a><a href='https://apps.apple.com/cn/app/heart-mate-lite-hrm-utility/id1475747930?ls=1'>  <i class='fa fa-apple'></i>  <b>这个是支付宝</b>  <p class='p green'>支付宝</p>  <img src='/medias/reward/alipay.bmp'></a>          </div><h3 id="上述示例代码-2"><a href="#上述示例代码-2" class="headerlink" title="上述示例代码"></a>上述示例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% btns circle center grid5 %&#125;  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/medias/reward/wechat.bmp<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>fa fa-apple<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span>这个是微信<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span>    &#123;% p red, 微信 %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/medias/reward/wechat.bmp<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>https://apps.apple.com/cn/app/heart-mate-lite-hrm-utility/id1475747930?ls=1<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>fa fa-apple<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span>这个是支付宝<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span>    &#123;% p green, 支付宝 %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/medias/reward/alipay.bmp<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>&#123;% endbtns %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="radio标签演示效果">radio标签演示效果</h1><br/><div class='checkbox'><input type="radio" />            <p>纯文本测试</p>            </div><div class='checkbox checked'><input type="radio" checked="checked"/>            <p>支持简单的 <a href="https://guides.github.com/features/mastering-markdown/">markdown</a> 语法</p>            </div><div class='checkbox red'><input type="radio" />            <p>支持自定义颜色</p>            </div><div class='checkbox green'><input type="radio" />            <p>绿色</p>            </div><div class='checkbox yellow'><input type="radio" />            <p>黄色</p>            </div><div class='checkbox cyan'><input type="radio" />            <p>青色</p>            </div><div class='checkbox blue'><input type="radio" />            <p>蓝色</p>            </div><div class='checkbox warning'><input type="radio" />            <p>warning色</p>            </div><div class='checkbox success'><input type="radio" />            <p>success色</p>            </div><div class='checkbox danger'><input type="radio" />            <p>danger色</p>            </div><div class='checkbox info'><input type="radio" />            <p>info色</p>            </div><h3 id="上述事例代码-12"><a href="#上述事例代码-12" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% radio 纯文本测试 %&#125;&#123;% radio checked, 支持简单的 <span class="token url">[<span class="token content">markdown</span>](<span class="token url">https://guides.github.com/features/mastering-markdown/</span>)</span> 语法 %&#125;&#123;% radio red, 支持自定义颜色 %&#125;&#123;% radio green, 绿色 %&#125;&#123;% radio yellow, 黄色 %&#125;&#123;% radio cyan, 青色 %&#125;&#123;% radio blue, 蓝色 %&#125;&#123;% radio warning, warning色 %&#125;&#123;% radio success, success色 %&#125;&#123;% radio danger, danger色 %&#125;&#123;% radio info, info色 %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="CheckBox图形示例">CheckBox图形示例</h1><br/><div class='checkbox'><input type="checkbox" />            <p>纯文本测试</p>            </div><div class='checkbox checked'><input type="checkbox" checked="checked"/>            <p>支持简单的 <a href="https://guides.github.com/features/mastering-markdown/">markdown</a> 语法</p>            </div><div class='checkbox red'><input type="checkbox" />            <p>支持自定义颜色</p>            </div><div class='checkbox green checked'><input type="checkbox" checked="checked"/>            <p>绿色 + 默认选中</p>            </div><div class='checkbox yellow checked'><input type="checkbox" checked="checked"/>            <p>黄色 + 默认选中</p>            </div><div class='checkbox cyan checked'><input type="checkbox" checked="checked"/>            <p>青色 + 默认选中</p>            </div><div class='checkbox blue checked'><input type="checkbox" checked="checked"/>            <p>蓝色 + 默认选中</p>            </div><div class='checkbox plus green checked'><input type="checkbox" checked="checked"/>            <p>增加</p>            </div><div class='checkbox minus yellow checked'><input type="checkbox" checked="checked"/>            <p>减少</p>            </div><div class='checkbox times red checked'><input type="checkbox" checked="checked"/>            <p>叉</p>            </div><h3 id="上述示例代码-3"><a href="#上述示例代码-3" class="headerlink" title="上述示例代码"></a>上述示例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% checkbox 纯文本测试 %&#125;&#123;% checkbox checked, 支持简单的 <span class="token url">[<span class="token content">markdown</span>](<span class="token url">https://guides.github.com/features/mastering-markdown/</span>)</span> 语法 %&#125;&#123;% checkbox red, 支持自定义颜色 %&#125;&#123;% checkbox green checked, 绿色 + 默认选中 %&#125;&#123;% checkbox yellow checked, 黄色 + 默认选中 %&#125;&#123;% checkbox cyan checked, 青色 + 默认选中 %&#125;&#123;% checkbox blue checked, 蓝色 + 默认选中 %&#125;&#123;% checkbox plus green checked, 增加 %&#125;&#123;% checkbox minus yellow checked, 减少 %&#125;&#123;% checkbox times red checked, 叉 %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="tab示例">tab示例</h1><br/><h2 id="tab标签示例如下"><a href="#tab标签示例如下" class="headerlink" title="tab标签示例如下"></a>tab标签示例如下</h2><div class="tabs" id="tab-id"><ul class="nav-tabs"><li class="tab active"><a class="#tab-id-1">栏目1</a></li><li class="tab"><a class="#tab-id-2">栏目2</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-id-1"><p>这是栏目1的内容</p></div><div class="tab-pane" id="tab-id-2"><p>这是栏目2的内容，以后要记得怎么写</p></div></div></div><h3 id="上述示例代码-4"><a href="#上述示例代码-4" class="headerlink" title="上述示例代码"></a>上述示例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% tabs tab-id %&#125;<span class="token comment">&lt;!-- tab 栏目1 --></span>这是栏目1的内容<span class="token comment">&lt;!-- endtab --></span><span class="token comment">&lt;!-- tab 栏目2 --></span>这是栏目2的内容，以后要记得怎么写<span class="token comment">&lt;!-- endtab --></span>&#123;% endtabs %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="folding效果">folding效果</h1><br/><h2 id="图片折叠"><a href="#图片折叠" class="headerlink" title="图片折叠"></a>图片折叠</h2><details ><summary pointer> 查看图片测试 </summary>              <div class='content'>              <p><img src="https://pic4.zhimg.com/80/v2-5e0b1aaa1994f6d7cb9aac94a6f4e0b3_1440w.jpg" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-5e0b1aaa1994f6d7cb9aac94a6f4e0b3_1440w.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>              </div>            </details><h3 id="上述事例代码-13"><a href="#上述事例代码-13" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% folding 查看图片测试 %&#125;  ![](https://pic4.zhimg.com/80/v2-5e0b1aaa1994f6d7cb9aac94a6f4e0b3_1440w.jpg)&#123;% endfolding %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="默认打开的折叠框"><a href="#默认打开的折叠框" class="headerlink" title="默认打开的折叠框"></a>默认打开的折叠框</h2><details cyan open><summary pointer> 查看默认打开的折叠框 </summary>              <div class='content'>              <p>这是一个默认打开的折叠框。</p>              </div>            </details><h3 id="上述事例代码-14"><a href="#上述事例代码-14" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% folding cyan open, 查看默认打开的折叠框 %&#125;  这是一个默认打开的折叠框。&#123;% endfolding %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="代码折叠"><a href="#代码折叠" class="headerlink" title="代码折叠"></a>代码折叠</h2><details green><summary pointer> 查看代码测试 </summary>              <div class='content'>              <p>这里写代码高亮部分</p>              </div>            </details><p>###上述事例代码</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% folding green, 查看代码测试 %&#125;这里写代码高亮部分&#123;% endfolding %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="列表折叠"><a href="#列表折叠" class="headerlink" title="列表折叠"></a>列表折叠</h2><details yellow><summary pointer> 查看列表测试 </summary>              <div class='content'>              <ul><li>haha</li><li>hehe</li></ul>              </div>            </details><p>###上述事例代码</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% folding yellow, 查看列表测试 %&#125;  <span class="token list punctuation">-</span> haha  <span class="token list punctuation">-</span> hehe&#123;% endfolding %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="嵌套折叠"><a href="#嵌套折叠" class="headerlink" title="嵌套折叠"></a>嵌套折叠</h2><details red><summary pointer> 查看嵌套测试 </summary>              <div class='content'>              <details blue><summary pointer> 查看嵌套测试2 </summary>              <div class='content'>              <details ><summary pointer> 查看嵌套测试3 </summary>              <div class='content'>              <p>hahaha <span><img src='https://image.dbbqb.com/202101221115/7cdd741907c2ea150d054d24c4da6594/4d0G' ></span></p>              </div>            </details>              </div>            </details>              </div>            </details><h3 id="上述事例代码-15"><a href="#上述事例代码-15" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% folding red, 查看嵌套测试 %&#125;&#123;% folding blue, 查看嵌套测试2 %&#125;&#123;% folding 查看嵌套测试3 %&#125;hahaha <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>https://image.dbbqb.com/202101221115/7cdd741907c2ea150d054d24c4da6594/4d0G<span class="token punctuation">'</span></span> <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>&#123;% endfolding %&#125;&#123;% endfolding %&#125;&#123;% endfolding %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="site-card标签演示效果">site-card标签演示效果</h1><br/><div class="site-card-group"><a class="site-card" href="http://www.baidu.com"><div class="img"><img src="https://pic4.zhimg.com/v2-7fcb0d73e1d90788ccf136e22ba7b1bd_r.jpg" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/v2-7fcb0d73e1d90788ccf136e22ba7b1bd_r.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="info style="background: rgb(0, 0, 0) center center""><img src="https://pic4.zhimg.com/80/v2-45eb5749949e7f90a5c788f9bc5721ef_1440w.jpg" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-45eb5749949e7f90a5c788f9bc5721ef_1440w.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/><span class="title">木兮</span><span class="desc">这是描述</span></div></a><a class="site-card" href="https://yuang01.gitee.io/"><div class="img"><img src="https://pic4.zhimg.com/80/v2-f549722dac8f777693c090a92498de0f_1440w.jpg" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-f549722dac8f777693c090a92498de0f_1440w.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="info style="background: rgb(0, 0, 0) center center""><img src="https://pic3.zhimg.com/80/v2-8bb491487280587026cd576b224ca91e_1440w.jpg" class="lazyload placeholder" data-srcset="https://pic3.zhimg.com/80/v2-8bb491487280587026cd576b224ca91e_1440w.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/><span class="title">yuang01</span><span class="desc">这是描述哦</span></div></a><a class="site-card" href="http://www.baidu.com"><div class="img"><img src="https://pic4.zhimg.com/v2-7fcb0d73e1d90788ccf136e22ba7b1bd_r.jpg" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/v2-7fcb0d73e1d90788ccf136e22ba7b1bd_r.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="info style="background: rgb(0, 0, 0) center center""><img src="https://pic4.zhimg.com/80/v2-45eb5749949e7f90a5c788f9bc5721ef_1440w.jpg" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-45eb5749949e7f90a5c788f9bc5721ef_1440w.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/><span class="title">木兮</span><span class="desc">这是描述</span></div></a><a class="site-card" href="https://yuang01.gitee.io/"><div class="img"><img src="https://pic4.zhimg.com/80/v2-f549722dac8f777693c090a92498de0f_1440w.jpg" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-f549722dac8f777693c090a92498de0f_1440w.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="info style="background: rgb(0, 0, 0) center center""><img src="https://pic3.zhimg.com/80/v2-8bb491487280587026cd576b224ca91e_1440w.jpg" class="lazyload placeholder" data-srcset="https://pic3.zhimg.com/80/v2-8bb491487280587026cd576b224ca91e_1440w.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/><span class="title">yuang01</span><span class="desc">这是描述哦</span></div></a><a class="site-card" href="http://www.baidu.com"><div class="img"><img src="https://pic4.zhimg.com/v2-7fcb0d73e1d90788ccf136e22ba7b1bd_r.jpg" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/v2-7fcb0d73e1d90788ccf136e22ba7b1bd_r.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="info style="background: rgb(0, 0, 0) center center""><img src="https://pic4.zhimg.com/80/v2-45eb5749949e7f90a5c788f9bc5721ef_1440w.jpg" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-45eb5749949e7f90a5c788f9bc5721ef_1440w.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/><span class="title">木兮</span><span class="desc">这是描述</span></div></a></div><h3 id="上述事例代码-16"><a href="#上述事例代码-16" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% sitegroup %&#125;    &#123;% site 木兮, url=http://www.baidu.com, screenshot=https://pic4.zhimg.com/v2-7fcb0d73e1d90788ccf136e22ba7b1bd_r.jpg, avatar=https://pic4.zhimg.com/80/v2-45eb5749949e7f90a5c788f9bc5721ef_1440w.jpg, description=这是描述 %&#125;    &#123;% site yuang01, url=https://yuang01.gitee.io/, screenshot=https://pic4.zhimg.com/80/v2-f549722dac8f777693c090a92498de0f_1440w.jpg, avatar=https://pic3.zhimg.com/80/v2-8bb491487280587026cd576b224ca91e_1440w.jpg, description=这是描述哦 %&#125;    &#123;% site 木兮, url=http://www.baidu.com, screenshot=https://pic4.zhimg.com/v2-7fcb0d73e1d90788ccf136e22ba7b1bd_r.jpg, avatar=https://pic4.zhimg.com/80/v2-45eb5749949e7f90a5c788f9bc5721ef_1440w.jpg, description=这是描述 %&#125;    &#123;% site yuang01, url=https://yuang01.gitee.io/, screenshot=https://pic4.zhimg.com/80/v2-f549722dac8f777693c090a92498de0f_1440w.jpg, avatar=https://pic3.zhimg.com/80/v2-8bb491487280587026cd576b224ca91e_1440w.jpg, description=这是描述哦 %&#125;    &#123;% site 木兮, url=http://www.baidu.com, screenshot=https://pic4.zhimg.com/v2-7fcb0d73e1d90788ccf136e22ba7b1bd_r.jpg, avatar=https://pic4.zhimg.com/80/v2-45eb5749949e7f90a5c788f9bc5721ef_1440w.jpg, description=这是描述 %&#125;&#123;% endsitegroup %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 class="bamboo-h " id="timeline时间线标签演示效果">timeline时间线标签演示效果</h1><br/><div class="timeline">    <div class="timenode"><div class="meta"><p><p>2021-01-01 <a href="https://github.com/yuang01/hexo-theme-bamboo">1.0.3 -&gt; 1.0.3</a></p></p></div><div class="body"><ol><li>我是一个测试文字<code>ghghgh</code>。</li><li>我是一个测试问题二’qweqw’，请问企鹅请问请问佛挡杀<code>fgfgf</code>佛第三节课。</li><li>我是一个测试问题三’fgfgfg’，请问企鹅请问请问佛挡杀<code>trtrtr</code>佛第三节课。</li></ol></div></div>    <div class="timenode"><div class="meta"><p><p>2020-08-15 <a href="https://github.com/yuang01/hexo-theme-bamboo">1.0.2 -&gt; 1.0.2</a></p></p></div><div class="body"><p>这是一段测试文字    </p></div></div>    <div class="timenode"><div class="meta"><p><p>2020-08-08 <a href="https://github.com/yuang01/hexo-theme-bamboo">1.0.0 -&gt; 1.0.0</a></p></p></div><div class="body"><ol><li>我是一个测试文字<code>ghghgh</code>。</li><li>我是一个测试问题二’qweqw’，请问企鹅请问请问佛挡杀<code>fgfgf</code>佛第三节课。</li><li>我是一个测试问题三’fgfgfg’，请问企鹅请问请问佛挡杀<code>trtrtr</code>佛第三节课。</li></ol></div></div></div><h3 id="上述事例代码-17"><a href="#上述事例代码-17" class="headerlink" title="上述事例代码"></a>上述事例代码</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">&#123;% timeline %&#125;<span class="token code keyword">    &#123;% timenode 2021-01-01 [1.0.3 -> 1.0.3](https://github.com/yuang01/hexo-theme-bamboo) %&#125;        1. 我是一个测试文字`ghghgh`。        2. 我是一个测试问题二'qweqw'，请问企鹅请问请问佛挡杀`fgfgf`佛第三节课。        2. 我是一个测试问题三'fgfgfg'，请问企鹅请问请问佛挡杀`trtrtr`佛第三节课。    &#123;% endtimenode %&#125;</span><span class="token code keyword">    &#123;% timenode 2020-08-15 [1.0.2 -> 1.0.2](https://github.com/yuang01/hexo-theme-bamboo) %&#125;        这是一段测试文字    &#123;% endtimenode %&#125;</span><span class="token code keyword">    &#123;% timenode 2020-08-08 [1.0.0 -> 1.0.0](https://github.com/yuang01/hexo-theme-bamboo) %&#125;        1. 我是一个测试文字`ghghgh`。        2. 我是一个测试问题二'qweqw'，请问企鹅请问请问佛挡杀`fgfgf`佛第三节课。        2. 我是一个测试问题三'fgfgfg'，请问企鹅请问请问佛挡杀`trtrtr`佛第三节课。    &#123;% endtimenode %&#125;</span>&#123;% endtimeline %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 本站介绍 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>主题介绍-页面配置</title>
      <link href="/post/ben-zhan-jie-shao/zhu-ti-jie-shao-ye-mian-pei-zhi/"/>
      <url>/post/ben-zhan-jie-shao/zhu-ti-jie-shao-ye-mian-pei-zhi/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>注意</strong>: icon使用的 <a href="https://fontawesome.dashgame.com/">Font Awesome</a> 版本为 <code>5.15.3</code>。</p></blockquote><h1 class="bamboo-h " id="页面基本功能">页面基本功能</h1><br/><h2 id="首页轮播图"><a href="#首页轮播图" class="headerlink" title="首页轮播图"></a>首页轮播图</h2><p>首页轮播图在<code>source/_posts/xxx.md</code>也就是文章页面配置，如果你想让某个文章放在首页轮播中，只用设置<code>swiper: true</code>即可，可以通过<code>swiperImg: xxx</code>来配置轮播图片，如下所示</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> Hello world<span class="token key atrule">date</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>20 21<span class="token punctuation">:</span><span class="token number">11</span><span class="token key atrule">swiper</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">swiperImg</span><span class="token punctuation">:</span> <span class="token string">'https://ssyerv1.oss-cn-hangzhou.aliyuncs.com/picture/c080ff4434354e35af9dab0a3ee1b9f7.jpg!sswm'</span><span class="token key atrule">swiperDesc</span><span class="token punctuation">:</span> <span class="token string">'我是文章在轮播图中的摘要'</span><span class="token punctuation">---</span>我是文章内容<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>swiperImg</code>可以是cdn地址，也可以是本地地址，例如<code>/medias/4.png</code><br>可以通过主题文件夹下的<code>_config.yml</code>文件中的<code>swiper</code>属性对轮播进行调整</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 首页轮播图设置</span><span class="token key atrule">swiper</span><span class="token punctuation">:</span>  <span class="token comment"># 当在.md文件中，设置swiper:true，会将该文章放到轮播中，</span>  <span class="token key atrule">showPrevNext</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否显示左右切换按钮</span>  <span class="token key atrule">showIndicators</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 是否显示指示器</span>  <span class="token key atrule">autoplay</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 是否自动轮播</span>  <span class="token key atrule">loop</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 让轮播看起来是循环的, 例如false的话，到达最后一个轮播图的时候，右按钮不能点击</span>  <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token number">5000</span> <span class="token comment"># 切换延迟时间</span>  <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">'slide'</span> <span class="token comment"># 'fade': 淡入淡出效果</span>  <span class="token key atrule">textAnimated</span><span class="token punctuation">:</span> <span class="token string">'fadeInDown'</span> <span class="token comment"># 文字动画，属性使用 animate.css, https://daneden.github.io/animate.css/</span>  <span class="token key atrule">textDuration</span><span class="token punctuation">:</span> <span class="token string">'0.2s'</span> <span class="token comment"># 文字动画持续时间（单位秒）</span>  <span class="token key atrule">textDelay</span><span class="token punctuation">:</span> <span class="token string">'0.1s'</span> <span class="token comment"># 文字动画延迟时间（单位秒）</span>  <span class="token key atrule">readMoreBtn</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 阅读更多按钮是否显示</span>  <span class="token key atrule">readMoreBtnBackgroundColor</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token comment"># 阅读更多按钮背景颜色,空字符串则默认使用主题颜色</span>  <span class="token key atrule">bubble</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 轮播图是否显示气泡,也可以打开底下的花瓣或者雪花特效 sakura（花瓣）: true snow(雪花): true</span>  <span class="token comment"># 当没有文章设置swiper: true时候，轮播图会显示以下default默认内容，可自行切换对应内容</span>  <span class="token key atrule">defaultImg</span><span class="token punctuation">:</span> <span class="token string">'https://w.wallhaven.cc/full/eo/wallhaven-eo678l.jpg'</span> <span class="token comment"># 图片，没有则随机选取</span>  <span class="token key atrule">defaultVideo</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token comment"># video，min-width:992px show</span>  <span class="token key atrule">defaultVideoLoadingImg</span><span class="token punctuation">:</span> <span class="token string">'https://img14.360buyimg.com/ddimg/jfs/t1/150557/6/19578/249564/60320406Ed5c42418/0d18299f505e4268.gif'</span> <span class="token comment"># video loading img -- use .gif img, 视频预加载动画，使用gif图片作为loading，为空则视频没有预加载动画</span>  <span class="token key atrule">defaultTile</span><span class="token punctuation">:</span> <span class="token string">'青墨书晚风'</span> <span class="token comment"># 标题</span>  <span class="token key atrule">defaultDesc</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'煮酒洗净尘嚣，论知交'</span><span class="token punctuation">,</span> <span class="token string">'万般付之一笑，共偕老'</span><span class="token punctuation">]</span> <span class="token comment">#描 述，例如 ['煮酒洗净尘嚣，论知交', '万般付之一笑，共偕老']</span>  <span class="token key atrule">defaultLeftBtnText</span><span class="token punctuation">:</span> <span class="token string">'阅读文档'</span> <span class="token comment"># 左边按钮文字, 空字符串则不显示</span>  <span class="token key atrule">defaultLeftBtnLink</span><span class="token punctuation">:</span> <span class="token string">'https://yuang01.gitee.io/2021/02/08/hexo-theme-bamboo-new/'</span> <span class="token comment"># 左边按钮链接 </span>  <span class="token key atrule">defaultRightBtnText</span><span class="token punctuation">:</span> <span class="token string">'下载主题'</span> <span class="token comment"># 右边按钮的文字，空字符串则不显示</span>  <span class="token key atrule">defaultRightBtnLink</span><span class="token punctuation">:</span> <span class="token string">'https://gitee.com/yuang01/hexo-theme-bamboo/repository/archive/dev.zip'</span> <span class="token comment"># 右边的按钮的链接</span>  <span class="token key atrule">defaultDescTyped</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># defaultDesc文字是否开启打字特效  is typed</span>  <span class="token key atrule">defaultDescTypedSpeed</span><span class="token punctuation">:</span> <span class="token number">100</span> <span class="token comment"># defaultDesc 打字速度, typed typeSpeed</span>  <span class="token key atrule">defaultDescTypedBackSpeed</span><span class="token punctuation">:</span> <span class="token number">50</span> <span class="token comment"># defaultDesc 打字返回速度 typed backSpeed</span>  <span class="token key atrule">defaultDescTypedLoop</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># defaultDesc文字的打字特效是否循环  typed loop</span>  <span class="token comment"># defaultAddToSwiper表示：当有文章设置了swiper: true的时候，将上面的 默认内容 放在轮播图的第一页</span>  <span class="token key atrule">defaultAddToSwiper</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启这个，则loop默认为false</span>  <span class="token key atrule">bothSideBlur</span><span class="token punctuation">:</span> <span class="token string">'300000px'</span> <span class="token comment"># 轮播图两边模糊程度，px越大越模糊，针对下面的imgwidthFull、full为false的时候</span>  <span class="token comment">## 轮播图样式更改</span>  <span class="token comment"># 轮播图的文字和按钮居中显示 (针对 imgwidthFull和 full都是false的时候)</span>  <span class="token key atrule">textCenter</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 图片宽度为100% (轮播图的文字和按钮只能居中显示)</span>  <span class="token key atrule">imgwidthFull</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 整个轮播图宽高都是100%  (轮播图的文字和按钮只能居中显示)</span>  <span class="token key atrule">full</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># full 优先级大于 imgwidthFull</span>  <span class="token comment"># 两边透明，imgwidthFull/full: false的时候，设置该值为true，则两边的模糊效果为透明</span>  <span class="token key atrule">bothSideTransparent</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>defaultAddToSwiper表示，当有文章设置了swiper:true的时候，将default默认轮播图作为第一张轮播图</li><li>通过textCenter控制轮播图的文字和按钮是否居中显示, imgwidthFull设置轮播图是否宽度为100%，但是高度不为100%，full表示轮播图宽高都是100%</li><li>还可以通过设置defaultVideo参数将默认轮播图的背景设置为视频，视频在屏幕大于992px的时候显示，小于992px则显示图片。</li><li>如果你不想导航透明，则可以设置底下的color_scheme.common.headerMenuTransparent为false</li></ul><blockquote><p>那免费的视频从哪里找呢，我推荐下面两个免费视频网站，直接右键复制网站视频链接就行了，不用下载下来</p></blockquote><div class="tagLink"><a class="link-card" title="mixkit视频网站" href="https://mixkit.co/"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" class="lazyload placeholder" data-srcset="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">mixkit视频网站</p><p class="url">https://mixkit.co/</p></div></a></div><div class="tagLink"><a class="link-card" title="coverr免费视频网站" href="https://coverr.co/"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" class="lazyload placeholder" data-srcset="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">coverr免费视频网站</p><p class="url">https://coverr.co/</p></div></a></div><h2 id="首页座右铭"><a href="#首页座右铭" class="headerlink" title="首页座右铭"></a>首页座右铭</h2><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">motto:  on: true  title: '座右铭'  content: '沉淀后我愿意做个温暖的人，有自己的喜好，有自己的原则，有自己的信仰，不急功近利，不浮夸轻薄。宠辱不惊，淡定安逸，心静如水，不忘初心，方得始终。——凌茜'  background: 'url("https://img10.360buyimg.com/ddimg/jfs/t1/166587/8/21344/72069/6088c24fEda5fdeb6/f9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="首页公告"><a href="#首页公告" class="headerlink" title="首页公告"></a>首页公告</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">notice</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">seamless</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 为true时，则无缝不停止滚动，false是会停一下的滚动</span>  <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">'公告'</span>  <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'url("https://img10.360buyimg.com/ddimg/jfs/t1/166587/8/21344/72069/6088c24fEda5fdeb6/f9730ab637b7ca47.png")'</span> <span class="token comment"># url("xxx") or red or #000 or rgba() ..</span>  <span class="token key atrule">list</span><span class="token punctuation">:</span> <span class="token comment"># list相当于数组对象，[&#123;title:'xx',date: 'xx', url: 'xxx', color: 'red'&#125;]根据自己实际情况，增加或者删除</span>    <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">'#博客更新到2.0了'</span>      <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token string">'2021-04-28'</span>      <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">'http://baidu.com'</span>   <span class="token comment"># 可以为空, 也可以是本地页面地址如 '/archives'</span>      <span class="token key atrule">color</span><span class="token punctuation">:</span> red   <span class="token comment"># 字体颜色</span>    <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">'#新增 轮播图支持三种模式了，功能也增强了 ~'</span>      <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token string">'2021-04-28'</span>      <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">'http://baidu.com'</span>      <span class="token key atrule">color</span><span class="token punctuation">:</span> red    <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">'#新增 支持二级导航'</span>      <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token string">'2021-04-28'</span>      <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">'http://baidu.com'</span>      <span class="token key atrule">color</span><span class="token punctuation">:</span> blue    <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">'#新增 归档，分类等页面头部图片位置可以设置为视频 ~'</span>      <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token string">'2021-04-28'</span>      <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">'http://baidu.com'</span>      <span class="token key atrule">color</span><span class="token punctuation">:</span> <span class="token string">'#42b983'</span>    <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">'#新增 头部导航可以设置为在顶部透明，并且可以任意设置背景颜色了 ~'</span>      <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token string">'2021-04-28'</span>      <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">'http://baidu.com'</span>    <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">'#新增 首页增加了座右铭和公告栏目 ~'</span>      <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token string">'2021-04-28'</span>      <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">'http://baidu.com'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="github地址"><a href="#github地址" class="headerlink" title="github地址"></a>github地址</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># github地址, 头部导航右上角的github链接</span><span class="token key atrule">Github</span><span class="token punctuation">:</span>   <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/yuang01/hexo<span class="token punctuation">-</span>theme<span class="token punctuation">-</span>bamboo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="网站favicon和logo"><a href="#网站favicon和logo" class="headerlink" title="网站favicon和logo"></a>网站favicon和logo</h2><p>设置主题文件夹下的<code>_config.yml</code>文件中的<code>favicon</code>和logo属性即可</p><h2 id="页面刷新时预加载动画"><a href="#页面刷新时预加载动画" class="headerlink" title="页面刷新时预加载动画"></a>页面刷新时预加载动画</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">preloader</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="回到顶部"><a href="#回到顶部" class="headerlink" title="回到顶部"></a>回到顶部</h2><p>设置主题文件夹下的<code>_config.yml</code>文件中的<code>goTop</code>属性即可控制隐藏显示</p><h2 id="文章详情页图片放大功能"><a href="#文章详情页图片放大功能" class="headerlink" title="文章详情页图片放大功能"></a>文章详情页图片放大功能</h2><p>设置主题文件夹下的<code>_config.yml</code>文件中的<code>fancybox</code>属性即可</p><h2 id="修改页脚"><a href="#修改页脚" class="headerlink" title="修改页脚"></a>修改页脚</h2><p>页脚底部的网站统计功能，使用的是<a href="http://busuanzi.ibruce.info/">不蒜子</a>，设置主题文件夹下的<code>_config.yml</code>文件中的<code>busuanzi</code>属性即可控制隐藏显示<br>页脚信息可以在<code>/layout/_partial/footer.ejs</code> 文件中进行手动修改。本主题使用<a href="http://www.fontawesome.com.cn/faicons/">Font Awesome图标</a></p><blockquote><p><strong>注意</strong>: 本主题中使用的 <code>Font Awesome</code> 版本为 <code>5.15.3</code>。</p></blockquote><h2 id="修改打赏的二维码图片"><a href="#修改打赏的二维码图片" class="headerlink" title="修改打赏的二维码图片"></a>修改打赏的二维码图片</h2><p>设置主题文件夹下的<code>_config.yml</code>文件中的<code>donate</code>属性为true，然后更改<code>Alipay</code>和<code>WeChatpay</code>图片路径即可</p><h2 id="文章详情页分享功能"><a href="#文章详情页分享功能" class="headerlink" title="文章详情页分享功能"></a>文章详情页分享功能</h2><p>设置主题文件夹下的<code>_config.yml</code>文件中的<code>sharejs</code>属性true或者false即可</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 分享功能</span><span class="token key atrule">sharejs</span><span class="token punctuation">:</span>   <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">sites</span><span class="token punctuation">:</span> twitter<span class="token punctuation">,</span>facebook<span class="token punctuation">,</span>google<span class="token punctuation">,</span>qq<span class="token punctuation">,</span>qzone<span class="token punctuation">,</span>wechat<span class="token punctuation">,</span>weibo<span class="token punctuation">,</span>douban<span class="token punctuation">,</span>linkedin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="鼠标点击特效"><a href="#鼠标点击特效" class="headerlink" title="鼠标点击特效"></a>鼠标点击特效</h2><p>设置主题文件夹下的<code>_config.yml</code>文件中的<code>cursor_effect</code>属性true或者false即可</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 鼠标点击特效</span><span class="token key atrule">cursor_effect</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> explosion  <span class="token comment"># fireworks: 礼花 | explosion: 爆炸 | love: 浮出爱心 | text: 浮出文字</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="复制成功提醒"><a href="#复制成功提醒" class="headerlink" title="复制成功提醒"></a>复制成功提醒</h2><p>当复制内容时候，是否显示复制成功提示,提示语可以自己修改<br>设置主题文件夹下的<code>_config.yml</code>文件中的<code>copy</code>属性true或者false即可</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 复制成功提示</span><span class="token key atrule">copy</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">'成功'</span>  <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token string">'复制成功了哦'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="雪花飘落和花瓣飘落特效"><a href="#雪花飘落和花瓣飘落特效" class="headerlink" title="雪花飘落和花瓣飘落特效"></a>雪花飘落和花瓣飘落特效</h2><p>设置主题文件夹下的<code>_config.yml</code>文件中的<code>snow</code>或者<code>sakura</code>属性true或者false即可</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 首页雪花飘落效果--冬天</span><span class="token key atrule">snow</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">onlyPc</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 设为true，只有pc端显示雪花特效</span><span class="token comment"># 首页花瓣飘落效果--春天</span><span class="token key atrule">sakura</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">onlyPc</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 设为true，只有pc端显示花瓣特效</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="文章详情页的标题显示位置"><a href="#文章详情页的标题显示位置" class="headerlink" title="文章详情页的标题显示位置"></a>文章详情页的标题显示位置</h2><p>设置主题文件夹下的<code>_config.yml</code>文件中的<code>postTitleTop</code>属性true或者false即可，true的时候，显示在上方的图片中，false显示在文章内容上面</p><h2 id="输入框打字特效"><a href="#输入框打字特效" class="headerlink" title="输入框打字特效"></a>输入框打字特效</h2><p>搜索弹框中的输入框打字特效，设置主题文件夹下的<code>_config.yml</code>文件中的<code>inputEffects</code>属性为true或者false即可。</p><h2 id="live-2d人物"><a href="#live-2d人物" class="headerlink" title="live-2d人物"></a>live-2d人物</h2><p>设置主题文件夹下的<code>_config.yml</code>文件中的<code>live2d</code>属性为true或者false，可以通过<code>modelId</code>属性选择模型，注意，live-2d人物只有在屏幕宽度最小为992px的时候才显示</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">modelId</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token comment"># 0 or 1 or 2 or 3 or 4 or 5 or 6</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="滚动动画"><a href="#滚动动画" class="headerlink" title="滚动动画"></a>滚动动画</h2><blockquote><p>设置主题文件夹下的<code>_config.yml</code>文件中的<code>aos</code>属性对首页中的文章列表动画进行控制，具体参考官网<a href="https://github.com/michalsnik/aos#animations">aos.js</a><br>目前使用的另一个动画特效</p></blockquote><h2 id="文章详情页目录"><a href="#文章详情页目录" class="headerlink" title="文章详情页目录"></a>文章详情页目录</h2><p>设置主题文件夹下的_config.yml文件中的toc的on属性，控制所有文章是否显示，还可以在在单个文章md页面里通过toc属性控制该文章的目录是否显示。</p><p>toc下的open参数控制所有的文章默认是否展开或者收缩，还可以在单个文章md页面里通过tocOpen参数控制该文章(具体某个文章)的目录默认是否展开收缩,参数如下:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 主题文件夹下的`_config.yml`文件中的`toc`属性</span><span class="token comment"># 文章目录</span><span class="token key atrule">toc</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否显示</span>  <span class="token key atrule">heading</span><span class="token punctuation">:</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">,</span> h4  <span class="token key atrule">open</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否展开，false则收缩</span>  <span class="token key atrule">showBtn</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否显示展开收缩按钮</span>  <span class="token key atrule">showOrderNumber</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否显示序号</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 单个文章里控制显示和隐藏，展开和收缩</span><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> 我是文章标题<span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token string">'html'</span><span class="token punctuation">]</span><span class="token key atrule">categories</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'前端'</span><span class="token punctuation">,</span> <span class="token string">'运维'</span><span class="token punctuation">,</span> <span class="token string">'攻城狮'</span><span class="token punctuation">]</span><span class="token key atrule">toc</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 该文章目录不显示</span><span class="token key atrule">tocOpen</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 该文章目录收缩</span><span class="token punctuation">---</span>我是文章内容<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="音乐"><a href="#音乐" class="headerlink" title="音乐"></a>音乐</h2><p>设置主题文件夹下的<code>_config.yml</code>文件中的<code>music</code>属性，控制其显示隐藏和其他一些调整, <code>music</code>中的<code>fixed</code>属性建议使用<code>true</code><br>可以添加多个音乐源</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">music</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">autoHide</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token comment"># hide automaticaly</span>  <span class="token comment">#  server: tencent   #requiremusic platform: netease, tencent, kugou, xiami, baidu</span>  <span class="token comment">#  type: playlist    #require song, playlist, album, search, artist</span>  <span class="token comment">#  id: 8062553743     #requiresong id / playlist id / album id / search keyword</span>  <span class="token key atrule">source</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span> netease     <span class="token comment"># 歌手-张卫-脱胎换骨</span>      <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">1365053719</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> song    <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span> netease     <span class="token comment"># 专辑-许嵩单曲集-许嵩</span>      <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">16959</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> album    <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span> netease     <span class="token comment">#个人歌单</span>      <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">4888271555</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> playlist    <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span> tencent     <span class="token comment"># 歌手-张卫-机器灵砍菜刀</span>      <span class="token key atrule">id</span><span class="token punctuation">:</span> 003FaEB64D0QIa      <span class="token key atrule">type</span><span class="token punctuation">:</span> song    <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span> tencent     <span class="token comment"># 歌手-陈奕迅</span>      <span class="token key atrule">id</span><span class="token punctuation">:</span> 003Nz2So3XXYek      <span class="token key atrule">type</span><span class="token punctuation">:</span> artist    <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span> tencent     <span class="token comment"># 专辑-认了吧-陈奕迅</span>      <span class="token key atrule">id</span><span class="token punctuation">:</span> 003yQidc3s7P65      <span class="token key atrule">type</span><span class="token punctuation">:</span> album    <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span> tencent     <span class="token comment">#个人歌单</span>      <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">8197627936</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> playlist    <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span> kugou           <span class="token comment"># 歌手-Gai-兰花草</span>      <span class="token key atrule">id</span><span class="token punctuation">:</span> 0127069EBDBCF0AD6BF0B60CE873835D      <span class="token key atrule">type</span><span class="token punctuation">:</span> song    <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span> kugou           <span class="token comment"># 歌手-Gai</span>      <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">718960</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> artist    <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span> kugou         <span class="token comment"># 专辑-一万个理由-郑源</span>      <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">1787575</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> album    <span class="token punctuation">-</span> <span class="token key atrule">server</span><span class="token punctuation">:</span> kugou         <span class="token comment">#个人歌单</span>      <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">3947753</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> playlist  <span class="token key atrule">fixed</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>       <span class="token comment"># 开启吸底模式，建议开启</span>  <span class="token key atrule">autoplay</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>   <span class="token comment"># 是否自动播放</span>  <span class="token key atrule">theme</span><span class="token punctuation">:</span> <span class="token string">'#42b983'</span>  <span class="token key atrule">loop</span><span class="token punctuation">:</span> <span class="token string">'all'</span>       <span class="token comment"># 音频循环播放, 可选值: 'all', 'one', 'none'</span>  <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token string">'random'</span>   <span class="token comment"># 音频循环顺序, 可选值: 'list', 'random'</span>  <span class="token key atrule">preload</span><span class="token punctuation">:</span> <span class="token string">'auto'</span>   <span class="token comment"># 预加载，可选值: 'none', 'metadata', 'auto'</span>  <span class="token key atrule">volume</span><span class="token punctuation">:</span> <span class="token number">0.7</span>       <span class="token comment"># 默认音量，请注意播放器会记忆用户设置，用户手动设置音量后默认音量即失效</span>  <span class="token key atrule">listFolded</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 列表默认折叠</span>  <span class="token key atrule">hideLrc</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>     <span class="token comment"># 隐藏歌词</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="版权信息"><a href="#版权信息" class="headerlink" title="版权信息"></a>版权信息</h2><p>可以在<code>source/_posts/xxx.md</code>文件中设置<code>copyright</code>true或者false，单独设置某个文章的版权信息是否显示，也可以在主题文件夹下的<code>_config.yml</code>文件中的<code>copyright</code>属性设置true或者false对所有文章的版权信息进行显示隐藏控制</p><h2 id="文章置顶"><a href="#文章置顶" class="headerlink" title="文章置顶"></a>文章置顶</h2><p>可以在<code>source/_posts/xxx.md</code>文件中设置<code>top: true</code>，将该文章放在首页的文章置顶栏目中，可以在主题文件夹下的<code>_config.yml</code>文件中的<code>topArticle</code>属性设置true或者false控制首页的文章置顶栏目显示和隐藏。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> Hello World<span class="token key atrule">date</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>21 21<span class="token punctuation">:</span><span class="token number">11</span><span class="token key atrule">top</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">---</span>我是文章内容<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="评论"><a href="#评论" class="headerlink" title="评论"></a>评论</h2><p>主题中内置了<code>valine</code>, <code>miniValine</code>, <code>livere</code>, <code>gitment</code>, <code>gitalk</code>, <code>changyan</code>评论<br>通过主题文件夹下的<code>_config.yml</code>文件中的相应属性进行设置<br>推荐使用<code>valine</code>和<code>livere</code><br>这里重点说一下<code>valine</code>评论配置</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">valine</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否启用</span>  <span class="token key atrule">appid</span><span class="token punctuation">:</span> <span class="token comment"># 你的appid --> https://valine.js.org/quickstart.html，请阅读这个获取appid和appkey</span>  <span class="token key atrule">appkey</span><span class="token punctuation">:</span> <span class="token comment"># 你的key</span>  <span class="token key atrule">avatar</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token comment"># 匿名者头像选项 https://valine.js.org/avatar.html 访客的头像,最好启用下面的`requiredFields`中的邮箱必填，填写qq邮箱，头像会变成qq头像</span>  <span class="token key atrule">placeholder</span><span class="token punctuation">:</span> <span class="token string">'客官，说点什么吧'</span> <span class="token comment"># 评论内容输入框的 placeholder</span>  <span class="token key atrule">master</span><span class="token punctuation">:</span> <span class="token string">'xxxxxx'</span> <span class="token comment"># 博主标签识别，博主邮箱md5 可以去md5加密网站，例如 https://md5jiami.51240.com/ ，将自己的邮箱输入， 得到 32位小写 的字符串填入这里</span>  <span class="token key atrule">friends</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'xxxxxxx'</span><span class="token punctuation">,</span> <span class="token string">'xxxxxx'</span><span class="token punctuation">]</span> <span class="token comment"># 小伙伴的 邮箱md5， 是个数组</span>  <span class="token key atrule">requiredFields</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'nick'</span><span class="token punctuation">,</span> <span class="token string">'mail'</span><span class="token punctuation">]</span> <span class="token comment"># 设置必填项 ['nick', 'mail'] nick为昵称必填， mail为邮箱必填, 空数组，则不校验</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="鼠标手势"><a href="#鼠标手势" class="headerlink" title="鼠标手势"></a>鼠标手势</h2><p>设置主题文件夹下的_config.yml文件中的cursor属性，可自行替换链接，参数如下:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 鼠标手势</span><span class="token key atrule">cursor</span><span class="token punctuation">:</span>  <span class="token key atrule">pointer</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//zhutix.com/wp<span class="token punctuation">-</span>content/themes/b2/x2.cur  <span class="token key atrule">default</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//zhutix.com/wp<span class="token punctuation">-</span>content/themes/b2/x1.cur  <span class="token key atrule">text</span><span class="token punctuation">:</span>   <span class="token key atrule">zoom-in</span><span class="token punctuation">:</span>   <span class="token key atrule">zoom-out</span><span class="token punctuation">:</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="字数统计"><a href="#字数统计" class="headerlink" title="字数统计"></a>字数统计</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># wordcount字数统计, 需要 npm i hexo-wordcount 安装</span><span class="token key atrule">wordcount</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="天气"><a href="#天气" class="headerlink" title="天气"></a>天气</h2><p>设置主题文件夹<code>_config.yml</code>的weather属性true或者false，控制显示和隐藏</p><h2 id="背影彩带"><a href="#背影彩带" class="headerlink" title="背影彩带"></a>背影彩带</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 背影彩带</span><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="图片懒加载"><a href="#图片懒加载" class="headerlink" title="图片懒加载"></a>图片懒加载</h2><p>设置主题文件夹下的<code>_config.yml</code>文件中的loadingImg属性，可自行修改预加载图片链接</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 图片懒加载</span><span class="token comment"># https://www.npmjs.com/package/vanilla-lazyload</span><span class="token key atrule">lazyload</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">js</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//cdn.jsdelivr.net/npm/vanilla<span class="token punctuation">-</span>lazyload@17.1.0/dist/lazyload.min.js  <span class="token key atrule">onlypost</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">loadingImg</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//img2.baidu.com/it/u=2037979560<span class="token punctuation">,</span>2772131037<span class="token important">&amp;fm=26&amp;fmt=auto&amp;gp=0.jpg</span>  <span class="token key atrule">blurIn</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 模糊加载效果 （loadingImg为空时有效）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="关灯"><a href="#关灯" class="headerlink" title="关灯"></a>关灯</h2><p>设置主题文件夹下的<code>_config.yml</code>文件中的dark属性，控制头部导航的开关灯按钮是否显示，控制是否默认显示关灯, 具体如下</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 黑夜模式, 关灯</span><span class="token key atrule">dark</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否在头部导航上显示开关灯</span>  <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># true为默认关灯状态（刷新页面和跳转页面都是关灯状态），false为默认开灯状态(网页第一次打开的时候为开灯状态)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="弹幕"><a href="#弹幕" class="headerlink" title="弹幕"></a>弹幕</h2><p>显示当前页面的弹幕</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 弹幕 只对valine评论有效，需要开启valine评论</span><span class="token key atrule">danmu</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">loop</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 设为true，则弹幕完了之后，继续查询评论接口，将该篇文章的评论再显示在弹幕里</span>  <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token number">5000</span> <span class="token comment"># 每条弹幕之间出现的间隔时间</span>  <span class="token key atrule">speed</span><span class="token punctuation">:</span> <span class="token number">20</span> <span class="token comment"># 弹幕运行的速度, 越小越快</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="灯笼"><a href="#灯笼" class="headerlink" title="灯笼"></a>灯笼</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">lantern</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">left</span><span class="token punctuation">:</span> <span class="token string">'春'</span> <span class="token comment"># 左边灯笼的文字， 空字符串则没有文字</span>  <span class="token key atrule">right</span><span class="token punctuation">:</span> <span class="token string">'节'</span> <span class="token comment"># 右边灯笼的文字</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="文章标题打字特效"><a href="#文章标题打字特效" class="headerlink" title="文章标题打字特效"></a>文章标题打字特效</h2><p>文章详情页上的标题打字效果</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 文章详情页图片上的标题打字效果</span><span class="token key atrule">typed</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">loop</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 是否循环</span>  <span class="token key atrule">showCursor</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 是否显示光标</span>  <span class="token key atrule">startDelay</span><span class="token punctuation">:</span> <span class="token number">100</span> <span class="token comment"># 开始延迟</span>  <span class="token key atrule">typeSpeed</span><span class="token punctuation">:</span> <span class="token number">100</span> <span class="token comment"># 打字速度</span>  <span class="token key atrule">backSpeed</span><span class="token punctuation">:</span> <span class="token number">50</span> <span class="token comment"># 删除速度</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="文章头部气泡显示"><a href="#文章头部气泡显示" class="headerlink" title="文章头部气泡显示"></a>文章头部气泡显示</h2><p>文章详情页头部气泡效果</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 文章详情页图片上的气泡效果</span><span class="token key atrule">bubble</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="首页文章图片显示位置"><a href="#首页文章图片显示位置" class="headerlink" title="首页文章图片显示位置"></a>首页文章图片显示位置</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 首页文章图片是否一左一右交错显示</span><span class="token key atrule">homePostImgsPosition</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">left</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 当上面的on设置为false（不交叉显示），则指定left为true的时候，图片在左边显示</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="归档、标签、分类、关于我、友情链接页面图片自定义"><a href="#归档、标签、分类、关于我、友情链接页面图片自定义" class="headerlink" title="归档、标签、分类、关于我、友情链接页面图片自定义"></a>归档、标签、分类、关于我、友情链接页面图片自定义</h2><p>通过主题文件夹下的<code>_config.yml</code>文件中的相应属性进行设置，属性如下：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 归档页面图片 or 'http://xxx'</span><span class="token key atrule">archiveImg</span><span class="token punctuation">:</span> <span class="token string">'/medias/archive.jpg'</span><span class="token comment"># 标签页面图片</span><span class="token key atrule">tagImg</span><span class="token punctuation">:</span> <span class="token string">'/medias/tag.jpg'</span><span class="token comment"># 标签详情页面图片</span><span class="token key atrule">tagDetailImg</span><span class="token punctuation">:</span> <span class="token string">'/medias/tagDetail.jpg'</span><span class="token comment"># 分类页面图片</span><span class="token key atrule">categoriesImg</span><span class="token punctuation">:</span> <span class="token string">'/medias/categories.jpg'</span><span class="token comment">#分类详情页面图片</span><span class="token key atrule">categoryDetailImg</span><span class="token punctuation">:</span> <span class="token string">'/medias/categoryDetail.jpg'</span><span class="token comment"># 关于我页面图片</span><span class="token key atrule">aboutImg</span><span class="token punctuation">:</span> <span class="token string">'/medias/about.jpg'</span><span class="token comment"># 友情链接页面图片</span><span class="token key atrule">friendsImg</span><span class="token punctuation">:</span> <span class="token string">'/medias/friend.jpg'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="更改主题颜色"><a href="#更改主题颜色" class="headerlink" title="更改主题颜色"></a>更改主题颜色</h2><p>默认主题颜色是绿色(#42b983)，可以通过更改主题文件夹<code>hexo-theme-bamboo</code>下的文件：<code>source/css/_partial/custom.styl</code>,将文件中的所有(#42b983)颜色值替换成你想要的颜色，然后更改该文件下的<code>blockquote</code>背景颜色，代码如下:</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">// 文章详情页的blockquote，md中的 > 标签的左边框和背景颜色.post-detail</span> <span class="token punctuation">&#123;</span>  <span class="token selector">blockquote</span> <span class="token punctuation">&#123;</span>      <span class="token property">border-left</span><span class="token punctuation">:</span> 4px solid #42b983<span class="token punctuation">;</span>      <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span>66<span class="token punctuation">,</span> 185<span class="token punctuation">,</span> 131<span class="token punctuation">,</span> .1<span class="token punctuation">)</span><span class="token punctuation">;</span> // 更改这个背景颜色为你想要的的颜色值  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>blockquote样式指的是下面这个</p><blockquote><p>我是blockquote</p></blockquote><p>例如，我将该文件下的所有颜色设置为<code>skyblue</code>，显示效果如下<br><img src="https://img13.360buyimg.com/ddimg/jfs/t1/120336/2/13322/273081/5f69b8d1E737e6277/8fdc796d2d3a82b3.png" class="lazyload placeholder" data-srcset="https://img13.360buyimg.com/ddimg/jfs/t1/120336/2/13322/273081/5f69b8d1E737e6277/8fdc796d2d3a82b3.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="theme-color"></p><p>代码高亮颜色，可以通过之前介绍的代码高亮进行更改</p><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><p>代码高亮如遇到花括号变成了<code>&amp;#123;&amp;#125;</code>这样的字符串，在根目录下输入npm install <a href="mailto:&#x68;&#101;&#x78;&#x6f;&#64;&#x34;&#x2e;&#50;&#x2e;&#49;">&#x68;&#101;&#x78;&#x6f;&#64;&#x34;&#x2e;&#50;&#x2e;&#49;</a>即可。</p>]]></content>
      
      
      <categories>
          
          <category> 本站介绍 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>主题介绍-基本配置</title>
      <link href="/post/ben-zhan-jie-shao/zhu-ti-jie-shao-ji-ben-pei-zhi/"/>
      <url>/post/ben-zhan-jie-shao/zhu-ti-jie-shao-ji-ben-pei-zhi/</url>
      
        <content type="html"><![CDATA[<p>这是一款<span class='p large red'>H</span><span class='p large green'>E</span><span class='p large blue'>X</span><span class='p large info'>O</span>主题</p><blockquote><p><strong>注意</strong>: icon使用的 <a href="https://fontawesome.dashgame.com/">Font Awesome</a> 版本为 <code>5.15.3</code>。</p></blockquote><h2 class="bamboo-h " id="下载">下载</h2><br/><p>首先你需要有一个 <a href="https://hexo.io/zh-cn/">Hexo</a> ，按照官网的指导做法，很容易的就能创建一个hexo博客。</p><div class="tabs" id="tab-id"><ul class="nav-tabs"><li class="tab active"><a class="#tab-id-1">Github安装</a></li><li class="tab"><a class="#tab-id-2">Gitee安装</a></li><li class="tab"><a class="#tab-id-3">npm安装</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-id-1"><p>当你有了hexo博客之后，进入<code>themes</code>文件夹下使用 <code>Git clone</code> 命令来下载:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/jimyfengqi/hexo-theme-bomboo.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="tagLink"><a class="link-card" title="hexo-theme-bamboo" href="https://gitub.com/yuang01/hexo-theme-bamboo"><span class="link-card-backdrop" style="background-image: url(https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg)"></span><div class="left"><img src="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" class="lazyload placeholder" data-srcset="https://cdn.pixabay.com/photo/2018/12/05/13/41/panda-3857754__340.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">hexo-theme-bamboo</p><p class="url">https://gitub.com/yuang01/hexo-theme-bamboo</p></div></a></div><p>或者点击下载zip包，解压放入themes文件夹下</p><p><span class='btn center large'><a class="button" href='https://github.com/jimyfengqi/hexo-theme-bomboo/archive/dev.zip' title='开始下载'><i class='fa fa-download'></i>开始下载</a></span></p></div><div class="tab-pane" id="tab-id-2"><p>当你有了hexo博客之后，进入<code>themes</code>文件夹下使用 <code>Git clone</code> 命令来下载:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://gitee.com/yuang01/hexo-theme-bamboo.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="tagLink"><a class="link-card" title="hexo-theme-bamboo" href="https://gitee.com/yuang01/hexo-theme-bamboo"><span class="link-card-backdrop" style="background-image: url(https://img10.360buyimg.com/ddimg/jfs/t1/154000/26/17136/4231/601cb685E622bcee5/1a923dacb1d98f64.jpg)"></span><div class="left"><img src="https://img10.360buyimg.com/ddimg/jfs/t1/154000/26/17136/4231/601cb685E622bcee5/1a923dacb1d98f64.jpg" class="lazyload placeholder" data-srcset="https://img10.360buyimg.com/ddimg/jfs/t1/154000/26/17136/4231/601cb685E622bcee5/1a923dacb1d98f64.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"/></div><div class="right"><p class="text">hexo-theme-bamboo</p><p class="url">https://gitee.com/yuang01/hexo-theme-bamboo</p></div></a></div><p>或者点击下载zip包，解压放入themes文件夹下</p><p><span class='btn center large'><a class="button" href='https://gitee.com/yuang01/hexo-theme-bamboo/repository/archive/dev.zip' title='开始下载'><i class='fa fa-download'></i>开始下载</a></span></p></div><div class="tab-pane" id="tab-id-3"><blockquote><p>此方法只支持Hexo在5.0.0版本以上<br>通过 npm 安装并不会在 themes 里生成主题文件夹，而是在 node_modules 里生成</p></blockquote><p>在你的博客根目录里</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i hexo-theme-bamboo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>升级方法：在博客根目录下，运行 npm update hexo-theme-bamboo</p></blockquote><h3 id="应用主题"><a href="#应用主题" class="headerlink" title="应用主题"></a>应用主题</h3><p>修改hexo根目录下的站点配置文件_config.yml，把主题改为bamboo</p><p>接着在hexo根目录下新建文件_config.bamboo.yml,从node_modules文件夹下找到hexo-theme-bamboo文件夹下的_config.yml，将里面的内容复制到_config.bamboo.yml文件中即可，在_config.bamboo.yml文件中对主题进行配置</p></div></div></div><h2 class="bamboo-h " id="基本配置">基本配置</h2><br/> <h3 id="切换主题"><a href="#切换主题" class="headerlink" title="切换主题"></a>切换主题</h3><p>修改 Hexo 根目录下的 <code>_config.yml</code> 的  <code>theme</code> 的值：<code>theme: hexo-theme-bamboo</code></p><h4 id="config-yml-文件的其它修改建议"><a href="#config-yml-文件的其它修改建议" class="headerlink" title="_config.yml 文件的其它修改建议:"></a><code>_config.yml</code> 文件的其它修改建议:</h4><ul><li>请修改 <code>_config.yml</code> 的 <code>url</code> 的值为你的网站主 <code>URL</code>（如：<code>http://xxx.github.io</code>）。<code>author</code>值改为你的名称（如：yuang），<code>description</code>值随便写一段描述（如：千磨万击还坚劲，任尔东西南北风）</li><li>如果你是中文用户，则建议修改 <code>language</code> 的值为 <code>zh-CN</code>。</li></ul><h3 id="代码高亮"><a href="#代码高亮" class="headerlink" title="代码高亮"></a>代码高亮</h3><p>本主题支持三种代码高亮方式，前两种是hexo内置的highlight和prismjs，后一种是使用的插件hexo-prism-plugin。三种方式看个人喜好选择一种作为高亮</p><div class="tabs" id="tab-2"><ul class="nav-tabs"><li class="tab active"><a class="#tab-2-1">highlight主题默认</a></li><li class="tab"><a class="#tab-2-2">prismjs(推荐)</a></li><li class="tab"><a class="#tab-2-3">hexo-prismjs-plugin</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-2-1"><p>首先需要在根目录下的_config.yml 文件中，将highlight的enable设置为true，这样就开启了highlight的代码高亮，默认这个是开启的。然后你可以在本主题目录下的_config.yml 文件中通过highlight参数，自定义代码高亮颜色，如下所示</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># https://github.com/chriskempson/tomorrow-theme</span><span class="token key atrule">highlight</span><span class="token punctuation">:</span>  <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#2d2d2d'</span>  <span class="token key atrule">currentLine</span><span class="token punctuation">:</span> <span class="token string">'#393939'</span>  <span class="token key atrule">selection</span><span class="token punctuation">:</span> <span class="token string">'#515151'</span>  <span class="token key atrule">foreground</span><span class="token punctuation">:</span> <span class="token string">'#cccccc'</span>  <span class="token key atrule">comment</span><span class="token punctuation">:</span> <span class="token string">'#999999'</span>  <span class="token key atrule">red</span><span class="token punctuation">:</span> <span class="token string">'#f2777a'</span>  <span class="token key atrule">orange</span><span class="token punctuation">:</span> <span class="token string">'#f99157'</span>  <span class="token key atrule">yellow</span><span class="token punctuation">:</span> <span class="token string">'#ffcc66'</span>  <span class="token key atrule">green</span><span class="token punctuation">:</span> <span class="token string">'#99cc99'</span>  <span class="token key atrule">aqua</span><span class="token punctuation">:</span> <span class="token string">'#66cccc'</span>  <span class="token key atrule">blue</span><span class="token punctuation">:</span> <span class="token string">'#6699cc'</span>  <span class="token key atrule">purple</span><span class="token punctuation">:</span> <span class="token string">'#cc99cc'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><div class="tab-pane" id="tab-2-2"><p>请先确保你的<span class='p red'>hexo版本为5.0</span> 以上,在根目录下的package.json中可以查看hexo的版本。<br>如果不是5.0.以上，请先升级，例如在根目录下使用如下命令，这个下载的版本号是5.3.0版本，你可以指定下载最新的版本</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo@5.3.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>首先需要在根目录下的_config.yml 文件中，将highlight的enable设置为false，然后<br>将prismjs的enable设置为true，如下所示</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">prismjs</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">preprocess</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">tab_replace</span><span class="token punctuation">:</span> <span class="token string">''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后可以通过本主题目录下的_config.yml 文件中prismjs参数来选择主题<br>例如:</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">prismjs</span><span class="token punctuation">:</span>  <span class="token key atrule">theme</span><span class="token punctuation">:</span> <span class="token string">'default'</span> <span class="token comment"># default, coy, dark, funky, okaidia, solarizedlight, tomorrow, twilight</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>另外，当你使用的是prismjs作为代码高亮的话,你还可以在单独的文章中设置代码高亮主题，这样可以实现不同的页面，有不同的代码高亮主题，文章中设置代码如下</p><p>title: Hexo主题–Bamboo介绍<br>date: 2021-01-5 23:28<br>swiper: true<br>swiperImg: ‘/medias/11.jpg’<br>img: ‘/medias/7.jpg’<br>categories: 前端<br>tags: [Hexo, hexo-theme-bamboo]<br>top: true<br>prismjs: dark # 设置该篇文章的代码高亮主题为dark</p></div><div class="tab-pane" id="tab-2-3"><p>如果使用hexo-prism-plugin这个Hexo插件来做代码高亮，安装命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i -S hexo-prism-plugin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后，修改 Hexo 根目录下的_config.yml 文件中的 highlight.enable 的值为 false，prismjs.enable值为false, 并新增该插件相关的配置，主要配置如下：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">highlight</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">prismjs</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">preprocess</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">tab_replace</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">prism_plugin</span><span class="token punctuation">:</span>  <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">'preprocess'</span>    <span class="token comment"># realtime/preprocess</span>  <span class="token key atrule">theme</span><span class="token punctuation">:</span> <span class="token string">'tomorrow'</span>    <span class="token comment"># 这里可以选择不同样式的主题</span>  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token comment"># default false</span>  custom_css<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个插件目前渲染有点小问题，代码高亮如遇到花括号变成了&#123;&#125;这样的字符串，以下方式可解决：<br>将node_modules\hexo-prism-plugin\src\index.js中的map改为如下</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token string">'&amp;#39;'</span><span class="token operator">:</span> <span class="token string">'\''</span><span class="token punctuation">,</span>  <span class="token string">'&amp;amp;'</span><span class="token operator">:</span> <span class="token string">'&amp;'</span><span class="token punctuation">,</span>  <span class="token string">'&amp;gt;'</span><span class="token operator">:</span> <span class="token string">'>'</span><span class="token punctuation">,</span>  <span class="token string">'&amp;lt;'</span><span class="token operator">:</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span>  <span class="token string">'&amp;quot;'</span><span class="token operator">:</span> <span class="token string">'"'</span><span class="token punctuation">,</span>  <span class="token string">'&amp;#123;'</span><span class="token operator">:</span> <span class="token string">'&#123;'</span><span class="token punctuation">,</span>  <span class="token string">'&amp;#125;'</span><span class="token operator">:</span> <span class="token string">'&#125;'</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后重启服务，hexo clean &amp;&amp; hexo s即可<br>卸载命令如下，如果你安装了此插件，后来想使用前两种高亮，请先卸载此插件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> un hexo-install prism-plugin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></div></div><p>这个主题采用的是<a href="https://github.com/ele828/hexo-prism-plugin">hexo-prism-plugin</a>这个Hexo插件来做代码高亮，安装命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i -S hexo-prism-plugin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后，修改 Hexo 根目录下 <code>_config.yml</code> 文件中 <code>highlight.enable</code> 的值为 <code>false</code>，并新增 <code>prism</code> 插件相关的配置，主要配置如下：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">highlight</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">prism_plugin</span><span class="token punctuation">:</span>  <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">'preprocess'</span>    <span class="token comment"># realtime/preprocess</span>  <span class="token key atrule">theme</span><span class="token punctuation">:</span> <span class="token string">'tomorrow'</span>    <span class="token comment"># 这里可以选择不同样式的主题</span>  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token comment"># default false</span>  custom_css<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><p>本主题中还使用到了 <a href="https://github.com/wzpan/hexo-generator-search">hexo-generator-search</a> 的 Hexo 插件来做内容搜索，安装命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-generator-search --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">search</span><span class="token punctuation">:</span>  <span class="token key atrule">path</span><span class="token punctuation">:</span> search.xml  <span class="token key atrule">field</span><span class="token punctuation">:</span> post<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在主题文件夹下的<code>_config.yml</code>文件中设置<code>search</code>为true或者false控制显示隐藏</p><h3 id="新建分类-categories-页"><a href="#新建分类-categories-页" class="headerlink" title="新建分类 categories 页"></a>新建分类 categories 页</h3><p><code>categories</code> 页是用来展示所有分类的页面，也就是导航上的分类页面，如果在你的博客 <code>source</code> 目录下还没有 <code>categories/index.md</code> 文件，那么你就需要手动或者使用命令新建一个，命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"categories"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编辑你刚刚新建的页面文件 <code>/source/categories/index.md</code>，至少需要以下内容：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> categories<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2021-10-14 15:30:30</span><span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"categories"</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"categories"</span><span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="新建标签-tags-页"><a href="#新建标签-tags-页" class="headerlink" title="新建标签 tags 页"></a>新建标签 tags 页</h3><p><code>tags</code> 页是用来展示所有标签的页面，如果在你的博客 <code>source</code> 目录下还没有 <code>tags/index.md</code> 文件，那么你就需要新建一个，命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"tags"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编辑你刚刚新建的页面文件 <code>/source/tags/index.md</code>，至少需要以下内容：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> tags<span class="token key atrule">date</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10 15<span class="token punctuation">:</span><span class="token datetime number">30:30</span><span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"tags"</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"tags"</span><span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="新建关于我-about-页"><a href="#新建关于我-about-页" class="headerlink" title="新建关于我 about 页"></a>新建关于我 about 页</h3><p><code>about</code> 页是用来展示<strong>关于我和我的博客</strong>信息的页面，如果在你的博客 <code>source</code> 目录下还没有 <code>about/index.md</code> 文件，那么你就需要新建一个，命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"about"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后可以在本主题下的<code>_config.yml</code>文件下，编辑以下字段进行关于我页面信息的更改</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">baseInfo <span class="token comment"># 基本信息，包括年龄，性别，坐标，状态</span>skills   <span class="token comment"># 技能</span>project   <span class="token comment"># 技能</span>socialAccounts <span class="token comment"># 社交账号</span>games   <span class="token comment"># 游戏</span>books   <span class="token comment">#书籍</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><details green><summary pointer> baseInfo基本信息 </summary>              <div class='content'>              <p><code>baseInfo</code>主要包含年龄，性别，坐标，状态，格式如下，<strong>注意空格缩进哦</strong></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">baseInfo</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否显示</span>  <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">99</span> <span class="token comment"># 年龄</span>  <span class="token key atrule">sex</span><span class="token punctuation">:</span> <span class="token string">'男'</span> <span class="token comment"># 性别</span>  <span class="token key atrule">coordinate</span><span class="token punctuation">:</span> <span class="token string">'火星'</span> <span class="token comment"># 坐标</span>  <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">'划水中'</span> <span class="token comment"># 状态</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><details cyan><summary pointer> skill填写我的技能 </summary>              <div class='content'>              <p><code>skills</code> 填写我的技能，格式如下，<strong>注意空格缩进哦</strong></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 关于我 技能</span><span class="token key atrule">skills</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否显示</span>  <span class="token key atrule">data</span><span class="token punctuation">:</span> <span class="token comment"># 这个data不能忘了，下面的字段注意缩进</span>    <span class="token key atrule">HTML5</span><span class="token punctuation">:</span> <span class="token comment"># 这里写你的技能名称，如 HTML5或者java</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'red'</span> <span class="token comment"># 进度条颜色</span>      <span class="token key atrule">percent</span><span class="token punctuation">:</span> 90% <span class="token comment"># 进度条百分比</span>    <span class="token key atrule">JavaScript</span><span class="token punctuation">:</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%)'</span>      <span class="token key atrule">percent</span><span class="token punctuation">:</span> 85%    <span class="token key atrule">CSS</span><span class="token punctuation">:</span>      <span class="token key atrule">background</span><span class="token punctuation">:</span> <span class="token string">'#000'</span>      <span class="token key atrule">percent</span><span class="token punctuation">:</span> 70%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><details green><summary pointer> socialAccounts填写我的社交账号 </summary>              <div class='content'>              <p><code>socialAccounts</code>填写我的社交账号，格式如下，<strong>注意空格缩进哦</strong></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">socialAccounts</span><span class="token punctuation">:</span>   <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">data</span><span class="token punctuation">:</span> <span class="token comment"># 这个data不能忘了，下面的字段注意缩进</span>    <span class="token key atrule">QQ</span><span class="token punctuation">:</span> <span class="token comment"># 社交软件名称</span>      <span class="token key atrule">icon</span><span class="token punctuation">:</span> fa fa<span class="token punctuation">-</span>qq  <span class="token comment"># 图标，可以为空，前面加上fa，假如图标名称叫fa-quora，就是 fa fa-quora, </span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token number">12345678</span> <span class="token comment"># 账号名称</span>      <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">'http://www.baidu.com'</span> <span class="token comment"># 账号链接地址</span>    <span class="token key atrule">微信</span><span class="token punctuation">:</span>      <span class="token key atrule">icon</span><span class="token punctuation">:</span> fa fa<span class="token punctuation">-</span>weixin      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token number">12345678</span>      <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">'http://www.baidu.com'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><details green><summary pointer> games填写我的游戏信息 </summary>              <div class='content'>              <p><code>games</code> 填写我的游戏，格式如下，<strong>注意空格缩进哦</strong></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">games</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否显示</span>  <span class="token key atrule">data</span><span class="token punctuation">:</span> <span class="token comment"># 这个data不能忘了，下面的字段注意缩进</span>    <span class="token key atrule">王者荣耀</span><span class="token punctuation">:</span> <span class="token comment"># 游戏名称，下面的img是游戏图片</span>      <span class="token key atrule">img</span><span class="token punctuation">:</span> <span class="token string">'https://pic2.zhimg.com/80/v2-54730a36304842b86a57a237b8b39945_720w.jpg?source=1940ef5c'</span>    <span class="token key atrule">英雄杀</span><span class="token punctuation">:</span>      <span class="token key atrule">img</span><span class="token punctuation">:</span> <span class="token string">'https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=1909008358,1888649581&amp;fm=26&amp;gp=0.jpg'</span>    <span class="token key atrule">和平精英</span><span class="token punctuation">:</span>      <span class="token key atrule">img</span><span class="token punctuation">:</span> <span class="token string">'https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1595596612190&amp;di=dbf2030780758c4724ecb1f07f2f4f73&amp;imgtype=0&amp;src=http%3A%2F%2Fimgup04.51wxjz.com%2F51wxjz%2F2019-06%2F05%2F09%2F15596983468928_0.png'</span>    <span class="token key atrule">英雄联盟</span><span class="token punctuation">:</span>      <span class="token key atrule">img</span><span class="token punctuation">:</span> <span class="token string">'https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=3035766587,2822701570&amp;fm=26&amp;gp=0.jpg'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><details green><summary pointer> books填写我的书籍 </summary>              <div class='content'>              <p><code>books</code> 填写我的书籍，格式如下，<strong>注意空格缩进哦</strong></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">books</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否显示</span>  <span class="token key atrule">data</span><span class="token punctuation">:</span> <span class="token comment"># 这个data不能忘了，下面的字段注意缩进</span>    <span class="token key atrule">明朝那些事儿</span><span class="token punctuation">:</span> <span class="token comment"># 书籍名称，下面的img是书籍图片</span>      <span class="token key atrule">img</span><span class="token punctuation">:</span> <span class="token string">'https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=2736238052,2078148140&amp;fm=26&amp;gp=0.jpg'</span>    <span class="token key atrule">春秋左传</span><span class="token punctuation">:</span>      <span class="token key atrule">img</span><span class="token punctuation">:</span> <span class="token string">'https://pic2.zhimg.com/50/v2-6f33f60312de25ddcb795fc81ee91b38_720w.jpg?source=54b3c3a5'</span>    <span class="token key atrule">孙子兵法</span><span class="token punctuation">:</span>      <span class="token key atrule">img</span><span class="token punctuation">:</span> <span class="token string">'https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=710999414,899378807&amp;fm=26&amp;gp=0.jpg'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>              </div>            </details><h3 id="新建友情连接-friends-页"><a href="#新建友情连接-friends-页" class="headerlink" title="新建友情连接 friends 页"></a>新建友情连接 friends 页</h3><div class="tabs" id="tab-3"><ul class="nav-tabs"><li class="tab active"><a class="#tab-3-1">Markdown文件配置(当前使用的)</a></li><li class="tab"><a class="#tab-3-2">新建json文件(旧版用的-不推荐)</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-3-1"><blockquote><p>该功能需要主题版本为2.1.5+</p></blockquote><p>friends 页是用来展示友情连接信息的页面，如果在你的博客 source 目录下还没有 friends/index.md 文件，那么你就需要新建一个，命令如下：</p><pre class="line-numbers language-none"><code class="language-none">hexo new page &quot;friends&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编辑你刚刚新建的页面文件 /source/friends/index.md</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> friends<span class="token key atrule">date</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>010<span class="token punctuation">-</span>17 15<span class="token punctuation">:</span><span class="token datetime number">30:30</span><span class="token key atrule">onlyTitle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 只显示title</span><span class="token key atrule">toc</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 不显示文章目录</span><span class="token comment"># type: "friends" # 这个不要了</span><span class="token comment"># layout: "friends" # 这个不要了</span><span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这时候会生成source/friends/index.md文件，在md文件里自定义写友链就行了。</p></div><div class="tab-pane" id="tab-3-2"><p><code>friends</code> 页是用来展示<strong>友情连接</strong>信息的页面，如果在你的博客 <code>source</code> 目录下还没有 <code>friends/index.md</code> 文件，那么你就需要新建一个，命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"friends"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编辑你刚刚新建的页面文件 <code>/source/friends/index.md</code>，至少需要以下内容：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> friends<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2020-09-14 15:30:30</span><span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"friends"</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"friends"</span><span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同时，在你的博客 <code>source</code> 目录下新建 <code>_data</code> 目录，在 <code>_data</code> 目录中新建 <code>friends.json</code> 文件，文件内容如下所示：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">&#123;</span>  <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"https://pic2.zhimg.com/80/v2-d1bd22e7dc847ae62028ae336d55ded9_720w.jpg?source=1940ef5c"</span><span class="token punctuation">,</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"如梦亦如幻"</span><span class="token punctuation">,</span>  <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"烟雨如江南"</span><span class="token punctuation">,</span>  <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://gitee.com/yuang01"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"https://pic1.zhimg.com/80/v2-1a60e33c33810a4d81a80282b8ca7a33_720w.jpg?source=1940ef5c"</span><span class="token punctuation">,</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"青灯暮雨"</span><span class="token punctuation">,</span>  <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"山水如墨染"</span><span class="token punctuation">,</span>  <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://gitee.com/yuang01"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"https://pic2.zhimg.com/80/v2-134122ca13d041f5ec1f2680f2677318_720w.jpg?source=1940ef5c"</span><span class="token punctuation">,</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"寄情山水花草间"</span><span class="token punctuation">,</span>  <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"宛如丹青未干"</span><span class="token punctuation">,</span>  <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://gitee.com/yuang01"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></div></div><h3 id="中文链接转拼音（可选的）"><a href="#中文链接转拼音（可选的）" class="headerlink" title="中文链接转拼音（可选的）"></a>中文链接转拼音（可选的）</h3><p>如果你的文章名称是中文的，那么 Hexo 默认生成的永久链接也会有中文，这样不利于 <code>SEO</code>，且 <code>gitment</code> 评论对中文链接也不支持。我们可以用 <a href="https://github.com/viko16/hexo-permalink-pinyin">hexo-permalink-pinyin</a> Hexo 插件使在生成文章时生成中文拼音的永久链接。<br>安装命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i hexo-permalink-pinyin --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">permalink_pinyin</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">separator</span><span class="token punctuation">:</span> <span class="token string">'-'</span> <span class="token comment"># default: '-'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong>：除了此插件外，<a href="https://github.com/rozbo/hexo-abbrlink">hexo-abbrlink</a> 插件也可以生成非中文的链接。</p></blockquote><h3 id="添加-RSS-订阅支持（可选的）"><a href="#添加-RSS-订阅支持（可选的）" class="headerlink" title="添加 RSS 订阅支持（可选的）"></a>添加 RSS 订阅支持（可选的）</h3><p>本主题中还使用到了 <a href="https://github.com/hexojs/hexo-generator-feed">hexo-generator-feed</a> 的 Hexo 插件来做 <code>RSS</code>，安装命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-generator-feed --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feed</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> atom  <span class="token key atrule">path</span><span class="token punctuation">:</span> atom.xml  <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token number">20</span>  <span class="token key atrule">hub</span><span class="token punctuation">:</span>  <span class="token key atrule">content</span><span class="token punctuation">:</span>  <span class="token key atrule">content_limit</span><span class="token punctuation">:</span> <span class="token number">140</span>  <span class="token key atrule">content_limit_delim</span><span class="token punctuation">:</span> <span class="token string">' '</span>  <span class="token key atrule">order_by</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>date<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 class="bamboo-h " id="Pjax">Pjax</h2><br/><p>页面不刷新跳转，音乐可以不间断播放。关闭则跳转页面时候刷新页面</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">pjax</span><span class="token punctuation">:</span>  <span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">animation</span><span class="token punctuation">:</span> circle <span class="token comment"># false, nprogress, circle</span>  <span class="token key atrule">animationColor</span><span class="token punctuation">:</span> <span class="token string">'orangered'</span> <span class="token comment"># animation为 nprogress时候的动画颜色, red or #000 ...</span>  <span class="token key atrule">cacheBust</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># url 地址追加时间戳，用以避免浏览器缓存</span>  <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>    <span class="token comment"># The timeout in milliseconds for the XHR requests. Set to 0 to disable the timeout.</span>  <span class="token key atrule">banUrl</span><span class="token punctuation">:</span>          <span class="token comment"># 被屏蔽的 url 地址将不启用 pjax 跳转，可以在控制台下使用 window.location.pathname 获取</span>      <span class="token comment"># - '/xxx/'     </span>      <span class="token comment"># - '/xxx/' </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 本站介绍 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django综合篇之网站地图sitemap</title>
      <link href="/post/django-quan-wang-zhan-da-jian/django-zong-he-pian-zhi-wang-zhan-di-tu-sitemap/"/>
      <url>/post/django-quan-wang-zhan-da-jian/django-zong-he-pian-zhi-wang-zhan-di-tu-sitemap/</url>
      
        <content type="html"><![CDATA[<h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><p>网站地图是根据网站的结构、框架、内容，生成的导航网页，是一个网站所有链接的容器。很多网站的连接层次比较深，蜘蛛很难抓取到，网站地图可以方便搜索引擎或者网络蜘蛛抓取网站页面，了解网站的架构，为网络蜘蛛指路，增加网站内容页面的收录概率。网站地图一般存放在域名根目录下并命名为sitemap<br>一个典型的sitemap，其内容片段如下：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">该 XML 文件并未包含任何关联的样式信息。文档树显示如下。 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>urlset</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>loc</span><span class="token punctuation">></span></span>http://example.com/blog/read/?blogid=63<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>loc</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lastmod</span><span class="token punctuation">></span></span>2020-12-01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lastmod</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>changefreq</span><span class="token punctuation">></span></span>weekly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>changefreq</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>priority</span><span class="token punctuation">></span></span>0.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>priority</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>loc</span><span class="token punctuation">></span></span>http://example.com/blog/read/?blogid=61<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>loc</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lastmod</span><span class="token punctuation">></span></span>2020-12-01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lastmod</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>changefreq</span><span class="token punctuation">></span></span>weekly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>changefreq</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>priority</span><span class="token punctuation">></span></span>0.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>priority</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>urlset</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Django自带了一个高级的生成网站地图的框架，我们可以很容易地创建出XML格式的网站地图。创建网站地图，只需编写一个Sitemap类，并在URLconf中编写对应的访问路由。</p><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>安装sitemap框架的步骤如下：</p><ol><li>在INSTALLED_APPS设置中添加<pre class="line-numbers language-python" data-language="python"><code class="language-python">INSTALLED_APPS <span class="token operator">=</span><span class="token punctuation">[</span> <span class="token string">'django.contrib.sitemaps'</span>  <span class="token string">'django.contrib.site'</span>  <span class="token punctuation">]</span> SITE_ID <span class="token operator">=</span> <span class="token number">1</span>         <span class="token comment"># 设置当前站点</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>添加这两个app, 加入SITE_ID = 1来制定当前的站点。<br>然后登陆Django后台，修改SITE为你Django网站的域名和名称<br>执行数据迁移<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">python manage.py migrate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="添加sitemap功能"><a href="#添加sitemap功能" class="headerlink" title="添加sitemap功能"></a>添加sitemap功能</h1><h2 id="（1）创建sitemap"><a href="#（1）创建sitemap" class="headerlink" title="（1）创建sitemap"></a>（1）创建sitemap</h2></li></ol><p>创建sitemap.py.内容类似下面的代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>sitemaps <span class="token keyword">import</span> Sitemap<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Blog<span class="token punctuation">,</span> Tag<span class="token punctuation">,</span> Category<span class="token keyword">from</span> user<span class="token punctuation">.</span>models <span class="token keyword">import</span> UserInfo<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse<span class="token comment"># 静态内容加入地图</span><span class="token keyword">class</span> <span class="token class-name">StaticViewSitemap</span><span class="token punctuation">(</span>Sitemap<span class="token punctuation">)</span><span class="token punctuation">:</span>    priority <span class="token operator">=</span> <span class="token number">0.5</span>    changefreq <span class="token operator">=</span> <span class="token string">'daily'</span>    <span class="token keyword">def</span> <span class="token function">items</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'blog:haystack'</span><span class="token punctuation">,</span> <span class="token string">'blog:about'</span><span class="token punctuation">,</span> <span class="token string">'blog:archives'</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>    <span class="token keyword">def</span> <span class="token function">location</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> reverse<span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">BlogSitemap</span><span class="token punctuation">(</span>Sitemap<span class="token punctuation">)</span><span class="token punctuation">:</span>    changefreq <span class="token operator">=</span> <span class="token string">"weekly"</span>    priority <span class="token operator">=</span> <span class="token number">0.5</span>    <span class="token comment"># protocol = 'https'</span>    <span class="token keyword">def</span> <span class="token function">items</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">lastmod</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> obj<span class="token punctuation">.</span>modified_time    <span class="token keyword">def</span> <span class="token function">location</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'/blog/read/?blogid=&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">CategorySiteMap</span><span class="token punctuation">(</span>Sitemap<span class="token punctuation">)</span><span class="token punctuation">:</span>    changefreq <span class="token operator">=</span> <span class="token string">"Weekly"</span>    priority <span class="token operator">=</span> <span class="token string">"0.6"</span>    <span class="token keyword">def</span> <span class="token function">items</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> Category<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">lastmod</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> obj<span class="token punctuation">.</span>created_time    <span class="token comment"># 在model里面定义过get_absolute_url方法后,此方法可以省略</span>    <span class="token keyword">def</span> <span class="token function">location</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'/blog/get_categories/?category_name=&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">TagSiteMap</span><span class="token punctuation">(</span>Sitemap<span class="token punctuation">)</span><span class="token punctuation">:</span>    changefreq <span class="token operator">=</span> <span class="token string">"Weekly"</span>    priority <span class="token operator">=</span> <span class="token string">"0.3"</span>    <span class="token keyword">def</span> <span class="token function">items</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> Tag<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">lastmod</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> obj<span class="token punctuation">.</span>created_time    <span class="token keyword">def</span> <span class="token function">location</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'/blog/get_tags/?tag_id=&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">UserSiteMap</span><span class="token punctuation">(</span>Sitemap<span class="token punctuation">)</span><span class="token punctuation">:</span>    changefreq <span class="token operator">=</span> <span class="token string">"Weekly"</span>    priority <span class="token operator">=</span> <span class="token string">"0.3"</span>    <span class="token keyword">def</span> <span class="token function">items</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">lastmod</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> obj<span class="token punctuation">.</span>date_joined    <span class="token keyword">def</span> <span class="token function">location</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'/user/profile/?userid=&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="（2）url路由配置"><a href="#（2）url路由配置" class="headerlink" title="（2）url路由配置"></a>（2）url路由配置</h2><p>url.py中加入:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> blog<span class="token punctuation">.</span>blog_sitemap <span class="token keyword">import</span> BlogSitemap<span class="token punctuation">,</span> CategorySiteMap<span class="token punctuation">,</span> TagSiteMap<span class="token punctuation">,</span> UserSiteMap<span class="token punctuation">,</span> StaticViewSitemap<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>sitemaps<span class="token punctuation">.</span>views <span class="token keyword">import</span> sitemapsitemaps <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'blog'</span><span class="token punctuation">:</span> BlogSitemap<span class="token punctuation">,</span>    <span class="token string">'Category'</span><span class="token punctuation">:</span> CategorySiteMap<span class="token punctuation">,</span>    <span class="token string">'Tag'</span><span class="token punctuation">:</span> TagSiteMap<span class="token punctuation">,</span>    <span class="token string">'User'</span><span class="token punctuation">:</span> UserSiteMap<span class="token punctuation">,</span>    <span class="token string">'static'</span><span class="token punctuation">:</span> StaticViewSitemap<span class="token punctuation">&#125;</span>url<span class="token punctuation">(</span><span class="token string">r'^sitemap\.xml$'</span><span class="token punctuation">,</span> sitemap<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'sitemaps'</span><span class="token punctuation">:</span> sitemaps<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        name<span class="token operator">=</span><span class="token string">'sitemap'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>至此，全部完成，运行你的django程序，浏览器输入:</p><p><a href="http://127.0.0.1:8000/sitemap.xml">http://127.0.0.1:8000/sitemap.xml</a></p><p>就可以看见已经成功生成了，然后就可以提交这个地址给搜索引擎。</p><h1 id="Sitemap类详解"><a href="#Sitemap类详解" class="headerlink" title="Sitemap类详解"></a>Sitemap类详解</h1><p><strong>class Sitemap[source]</strong></p><pre><code> Sitemap类可以定义以下方法/属性：</code></pre><p><strong>1.  items[source]</strong></p><pre><code>必须定义。返回对象列表的方法。</code></pre><p>框架不关心对象的类型，重要的是这些对象将被传递给location()，lastmod()，changefreq()和priority()方法。<br><strong>2. location[source]</strong></p><pre><code>可选。 其值可以是一个方法或属性。</code></pre><p>如果是一个方法, 它应该为items()返回的对象的绝对路径.</p><p>如果它是一个属性，它的值应该是一个字符串，表示items()返回的每个对象的绝对路径。</p><p>上面所说的“绝对路径”表示不包含协议和域名的URL。 例子：</p><ul><li>正确：’/foo/bar/‘ </li><li>错误：’example.com/foo/bar/‘</li><li>错误：’<a href="https://example.com/foo/bar/&#39;">https://example.com/foo/bar/&#39;</a></li></ul><p>如果未提供location，框架将调用items()<strong>返回的每个对象上的get_absolute_url()方法</strong>。</p><p>该属性最终反映到HTML页面上的标签。<br><strong>3. lastmod</strong></p><pre><code>可选。 一个方法或属性。表示当前条目最后的修改时间。</code></pre><p><strong>4. changefreq</strong></p><pre><code>可选。 一个方法或属性。表示当前条目修改的频率。</code></pre><p>changefreq的允许值为：</p><pre><code>    &#39;always&#39;  &#39;hourly&#39;  &#39;daily&#39;  &#39;weekly&#39;  &#39;monthly&#39;  &#39;yearly&#39; &#39;never&#39;</code></pre><p><strong>5. priority</strong></p><pre><code>可选。表示当前条目在网站中的权重系数，优先级。</code></pre><p>示例值：0.4，1.0。 页面的默认优先级为0.5，最高为1.0。<br><strong>6. protocol</strong></p><pre><code>可选的。定义网站地图中的网址的协议（‘http’或’https’）。</code></pre><p><strong>7. limit</strong></p><pre><code>可选的。定义网站地图的每个网页上包含的最大超级链接数。</code></pre><p><strong>8. i18n</strong></p><pre><code>可选的。一个boolean属性，定义是否应使用所有语言生成此网站地图。默认值为False。</code></pre><h1 id="通知Google"><a href="#通知Google" class="headerlink" title="通知Google"></a>通知Google</h1><p>当你的sitemap变化的时候，你会想通知Google，以便让它知道对你的站点进行重新索引。 框架就提供了这样的一个函数： </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>sitemaps<span class="token punctuation">.</span>ping_google<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ping_google() 有一个可选的参数 sitemap_url ，它应该是你的站点地图的URL绝对地址</p><p>如果不能够确定你的sitemap URL, ping_google() 会引发 django.contrib.sitemaps.SitemapNotFound 异常。</p><p>我们可以通过模型中的 save() 方法来调用 ping_google() ：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>sitemaps <span class="token keyword">import</span> ping_google <span class="token keyword">class</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ...</span>  <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">super</span><span class="token punctuation">(</span>Entry<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>      ping_google<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>      <span class="token comment"># Bare 'except' because we could get a variety</span>      <span class="token comment"># of HTTP-related exceptions.</span>      <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一个更有效的解决方案是用 cron 脚本或任务调度表来调用 ping_google() ，该方法使用Http直接请求Google服务器，从而减少每次调用 save() 时占用的网络带宽。    </p>]]></content>
      
      
      <categories>
          
          <category> Django全网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django综合篇之celery4 定时任务的实现新闻热榜</title>
      <link href="/post/django-quan-wang-zhan-da-jian/django-zong-he-pian-zhi-celery4-ding-shi-ren-wu-de-shi-xian-xin-wen-re-bang/"/>
      <url>/post/django-quan-wang-zhan-da-jian/django-zong-he-pian-zhi-celery4-ding-shi-ren-wu-de-shi-xian-xin-wen-re-bang/</url>
      
        <content type="html"><![CDATA[<h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p>系统：Ubuntu系统<br>编辑器：Pycharm<br>Python版本：python3.6（自带celery4.3.0）<br>第三方包依赖： django3.0.8</p><h1 id="本文简介"><a href="#本文简介" class="headerlink" title="本文简介"></a>本文简介</h1><p>这篇文章主要介绍了celery4+django3定时任务的实现, 用于定时获取热门网站的榜单，组成一个新闻聚合网站</p><p>网上有很多celery + django实现定时任务的教程，不过它们大多数是基于djcelery + celery3的； 或者是使用django_celery_beat配置较为繁琐的。</p><p>显然简洁而高效才是我们最终的追求，而celery4已经不需要额外插件即可与django结合实现定时任务了，原生的celery beat就可以很好的实现定时任务功能。</p><p>当然使用原生方案的同时有几点插件所带来的好处被我们放弃了：</p><pre><code>1.插件提供的定时任务管理将不在可用，当我们只需要任务定期执行而不需要人为调度的时候这点忽略不计。2.无法高效的管理或追踪定时任务，定时任务的跟踪其实交给日志更合理，但是对任务的修改就没有那么方便了，不过如果不需要经常变更/增减任务的话这点也在可接受范围内。</code></pre><h1 id="项目内容"><a href="#项目内容" class="headerlink" title="项目内容"></a>项目内容</h1><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">django-admin startproject Websitecd Websitepython3 manage.py startapp hottouch .&#x2F;Website&#x2F;celery.py  .&#x2F;hot&#x2F;tasks.py start-celery.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>上面的命令分别为：</p><ul><li>创建一个名字为Website的项目</li><li>创建一个名字为hot的应用</li><li>创建celery相关的文件<br>创建完成后，基本的目录结构：<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">..&#x2F;Website&#x2F;├── hot│   ├── admin.py│   ├── apps.py│   ├── __init__.py│   ├── migrations│   │   └── __init__.py│   ├── models.py│   ├── tasks.py│   ├── tests.py│   └── views.py├── manage.py├── start-celery.sh└── Website    ├── asgi.py    ├── celery.py    ├── __init__.py    ├── settings.py    ├── urls.py    └── wsgi.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>其中hot是我们的app，用于新闻聚合，Website则是我们的project。</p><h2 id="模型设计"><a href="#模型设计" class="headerlink" title="模型设计"></a>模型设计</h2><p>需要考虑是否仅仅展示实时的信息<br>如果仅仅展示实时的信息，将获取到的新闻榜单内容做成json格式直接送给前端<br>如果还需要将每条信息排序，统计一下历史信息<br>那么需要设计一个新的model，来存贮每条信息</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># hot/models.py</span><span class="token keyword">class</span> <span class="token class-name">Hot</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    STATUS <span class="token operator">=</span> <span class="token punctuation">(</span>        <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'无效'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'有效'</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>    hot_name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'热榜源'</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    type_name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'榜单类型'</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    content <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'内容'</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    create_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">"创建时间"</span><span class="token punctuation">)</span>    update_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'更新时间'</span><span class="token punctuation">)</span>    status <span class="token operator">=</span> models<span class="token punctuation">.</span>SmallIntegerField<span class="token punctuation">(</span>choices<span class="token operator">=</span>STATUS<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'是否有效'</span><span class="token punctuation">)</span>    <span class="token builtin">sorted</span> <span class="token operator">=</span> models<span class="token punctuation">.</span>SmallIntegerField<span class="token punctuation">(</span><span class="token string">'排序'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>hot_name <span class="token operator">+</span> self<span class="token punctuation">.</span>type_name    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        ordering <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'-sorted'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="视图内容"><a href="#视图内容" class="headerlink" title="视图内容"></a>视图内容</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># hot/views.py</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Hot<span class="token keyword">def</span> <span class="token function">hot</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    返回榜单信息    :param request:    :return:    """</span>    hot_queryset <span class="token operator">=</span> Hot<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'热点聚合'</span><span class="token punctuation">,</span>        <span class="token string">'hot_queryset'</span><span class="token punctuation">:</span> hot_queryset    <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'hot/hot.html'</span><span class="token punctuation">,</span> context<span class="token operator">=</span>data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="task设置"><a href="#task设置" class="headerlink" title="task设置"></a>task设置</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> absolute_import<span class="token punctuation">,</span> unicode_literals<span class="token keyword">import</span> sys<span class="token keyword">import</span> os<span class="token keyword">import</span> django<span class="token keyword">from</span> subprocess <span class="token keyword">import</span> getstatusoutput<span class="token comment"># 将当前目录加入django环境</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"DJANGO_SETTINGS_MODULE"</span><span class="token punctuation">:</span> <span class="token string">"Website.settings"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>django<span class="token punctuation">.</span>setup<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">from</span> celery <span class="token keyword">import</span> shared_task<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor<span class="token keyword">from</span> hot<span class="token punctuation">.</span>crawler <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> hot<span class="token punctuation">.</span>models <span class="token keyword">import</span> Hot<span class="token decorator annotation punctuation">@shared_task</span><span class="token keyword">def</span> <span class="token function">run_crawler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    定时一个小时更新一次爬取    :return:    """</span>    crawler_list <span class="token operator">=</span> <span class="token punctuation">[</span>crawler_github<span class="token punctuation">]</span><span class="token comment"># 可以自己添加其他内容</span>    <span class="token keyword">with</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span>        <span class="token keyword">def</span> <span class="token function">get_result</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token triple-quoted-string string">"""            这个是 add_done_callback()方法来添加回调函数,            future.result()为函数运行的结果            :param future:            :return:            """</span>            crawler_result <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>            hot_name <span class="token operator">=</span> crawler_result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'hot_name'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>            type_name <span class="token operator">=</span> crawler_result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'type_name'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>                      content <span class="token operator">=</span> crawler_result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> hot_name<span class="token punctuation">:</span>                hot <span class="token operator">=</span> Hot<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>hot_name<span class="token operator">=</span>hot_name<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>                                <span class="token keyword">if</span> <span class="token keyword">not</span> hot<span class="token punctuation">:</span>                    Hot<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>hot_name<span class="token operator">=</span>hot_name<span class="token punctuation">,</span> type_name<span class="token operator">=</span>type_name<span class="token punctuation">,</span> content<span class="token operator">=</span>content<span class="token punctuation">)</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    hot<span class="token punctuation">.</span>content <span class="token operator">=</span> content                    hot<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token keyword">for</span> future1 <span class="token keyword">in</span> crawler_list<span class="token punctuation">:</span>            pool<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>future1<span class="token punctuation">)</span><span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>get_result<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>run_crawler<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意到了这里用到自己写的crawler ， 这里面放的是各种爬虫<br>这里拿一个举例</p><h2 id="github-爬虫"><a href="#github-爬虫" class="headerlink" title="github 爬虫"></a>github 爬虫</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">crawler_github</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    获取github 热榜    :return:    """</span>    url <span class="token operator">=</span> <span class="token string">'https://github.com/trending'</span>    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">'Host'</span><span class="token punctuation">:</span> <span class="token string">'github.com'</span><span class="token punctuation">,</span>        <span class="token string">'Referer'</span><span class="token punctuation">:</span> <span class="token string">'https://github.com/explore'</span>    <span class="token punctuation">&#125;</span>    response_html <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>    content_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> response_html<span class="token punctuation">:</span>        tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>response_html<span class="token punctuation">.</span>text<span class="token punctuation">)</span>        article_list <span class="token operator">=</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//article[@class='Box-row']"</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> article <span class="token keyword">in</span> article_list<span class="token punctuation">:</span>            title <span class="token operator">=</span> article<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'string(./h1/a)'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>            href <span class="token operator">=</span> <span class="token string">'https://github.com/%s'</span> <span class="token operator">%</span> article<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./h1/a/@href'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            describe <span class="token operator">=</span> article<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'string(./p)'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>                      content_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'%s---%s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>title<span class="token punctuation">,</span> describe<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'href'</span><span class="token punctuation">:</span> href <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'hot_name'</span><span class="token punctuation">:</span> <span class="token string">'GitHub'</span><span class="token punctuation">,</span>            <span class="token string">'type_name'</span><span class="token punctuation">:</span> <span class="token string">'热榜'</span><span class="token punctuation">,</span>            <span class="token string">'crawler_name'</span><span class="token punctuation">:</span> sys<span class="token punctuation">.</span>_getframe<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>f_code<span class="token punctuation">.</span>co_name<span class="token punctuation">,</span>            <span class="token string">'content'</span><span class="token punctuation">:</span> content_list<span class="token punctuation">,</span>            <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="路由配置"><a href="#路由配置" class="headerlink" title="路由配置"></a>路由配置</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># hot/urls.py</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> viewsapp_name <span class="token operator">=</span> <span class="token string">'hot'</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token comment"># 分类页面</span>    path<span class="token punctuation">(</span><span class="token string">'hot'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>hot<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'hot'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>主路由配置</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> includeurlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'hot/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'hot.urls'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'hot'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 新闻热榜    ]   </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Celery定时任务配置"><a href="#Celery定时任务配置" class="headerlink" title="Celery定时任务配置"></a>Celery定时任务配置</h1><p>针对celery, 我们需要关心的主要是 celery.py ， settings.py ， tasks.py 和 start-celery.sh 。</p><h2 id="建立celery"><a href="#建立celery" class="headerlink" title="建立celery"></a>建立celery</h2><p>首先是celery.py，想让celery执行任务就必须实例化一个celery app，并把settings.py里的配置传入app：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> absolute_import<span class="token keyword">import</span> os<span class="token keyword">from</span> celery <span class="token keyword">import</span> Celery<span class="token keyword">from</span> celery<span class="token punctuation">.</span>schedules <span class="token keyword">import</span> crontab<span class="token keyword">from</span> datetime <span class="token keyword">import</span> timedelta<span class="token comment"># 设置django环境</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'DJANGO_SETTINGS_MODULE'</span><span class="token punctuation">,</span> <span class="token string">'Website.settings'</span><span class="token punctuation">)</span><span class="token comment"># 创建celery客户端,并起别名(没有实际意义)</span>app <span class="token operator">=</span> Celery<span class="token punctuation">(</span><span class="token string">'Celery_Website'</span><span class="token punctuation">)</span><span class="token comment"># 加载配置:让客户端和worker知道broker的存在，</span><span class="token comment"># - 'django.conf:settings'表示django,conf.settings也就是django项目的配置，celery会根据前面设置的环境变量自动查找并导入</span><span class="token comment"># - namespace表示在settings.py中celery配置项的名字的统一前缀，这里是'CELERY_'，配置项的名字也需要大写</span>app<span class="token punctuation">.</span>config_from_object<span class="token punctuation">(</span><span class="token string">'django.conf:settings'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'CELERY'</span><span class="token punctuation">)</span><span class="token comment"># 自动将异步任务注册到celery_app</span><span class="token comment"># 提示:不需要找tasks.py 因为celery默认会去各个apps下面去找与tasks.py同名的文件</span>app<span class="token punctuation">.</span>autodiscover_tasks<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 配置broker的位置: 方便celery客户端向broker中发布任务,也为了worker从broker中取任务</span>broker_url <span class="token operator">=</span> <span class="token string">"redis://127.0.0.1/14"</span><span class="token comment"># 更新配置信息，也可以在setting里面添加</span>app<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>update<span class="token punctuation">(</span>    CELERYBEAT_SCHEDULE<span class="token operator">=</span><span class="token punctuation">&#123;</span>        <span class="token string">'定时获取热榜'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'task'</span><span class="token punctuation">:</span> <span class="token string">'hot.tasks.run_crawler'</span><span class="token punctuation">,</span>              <span class="token comment"># 'schedule':  crontab(minute='*/1'),    # 定时任务</span>            <span class="token string">'schedule'</span><span class="token punctuation">:</span>  timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment"># 周期性任务,每十分钟一次</span>            <span class="token string">'args'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="导入celery"><a href="#导入celery" class="headerlink" title="导入celery"></a>导入celery</h2><p>配置就是这么简单，为了能在django里使用这个app，我们需要在Website/<strong>init</strong>.py中导入它：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> absolute_import<span class="token punctuation">,</span> unicode_literals<span class="token keyword">from</span> <span class="token punctuation">.</span>celery <span class="token keyword">import</span> app <span class="token keyword">as</span> celery_app__all__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'celery_app'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="配置celery"><a href="#配置celery" class="headerlink" title="配置celery"></a>配置celery</h2><p>任务配置完成后我们就要配置celery了，我们选择redis作为任务队列，强烈建议在生产环境中使用rabbitmq或者redis作为任务队列或结果缓存后端，而不应该使用关系型数据库：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># setting.py</span><span class="token comment"># redis</span>REDIS_PORT <span class="token operator">=</span> <span class="token number">6379</span>REDIS_DB <span class="token operator">=</span> <span class="token number">0</span><span class="token comment"># 从环境变量中取得redis服务器地址</span>REDIS_HOST <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'REDIS_ADDR'</span><span class="token punctuation">,</span> <span class="token string">'redis'</span><span class="token punctuation">)</span> <span class="token comment"># celery settings</span><span class="token comment"># 这两项必须设置，否则不能正常启动celery beat</span>CELERY_ENABLE_UTC <span class="token operator">=</span> <span class="token boolean">True</span>CELERY_TIMEZONE <span class="token operator">=</span> TIME_ZONE<span class="token comment"># 任务队列配置</span>CELERY_BROKER_URL <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'redis://</span><span class="token interpolation"><span class="token punctuation">&#123;</span>REDIS_HOST<span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>REDIS_PORT<span class="token punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>REDIS_DB<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span>CELERY_ACCEPT_CONTENT <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'application/json'</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>CELERY_RESULT_BACKEND <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'redis://</span><span class="token interpolation"><span class="token punctuation">&#123;</span>REDIS_HOST<span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>REDIS_PORT<span class="token punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>REDIS_DB<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span>CELERY_TASK_SERIALIZER <span class="token operator">=</span> <span class="token string">'json'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="设置定时任务"><a href="#设置定时任务" class="headerlink" title="设置定时任务"></a>设置定时任务</h2><p>然后是我们的定时任务设置,前面我们其实已经将定时任务放入celery.py 里面了，当然也可以放在设置文件中：</p><pre class="line-numbers language-none"><code class="language-none">from celery.schedules import crontabCELERY_BEAT_SCHEDULE&#x3D;&#123;    &#39;fetch_news_every-1-hour&#39;: &#123;      &#39;task&#39;: &#39;news.tasks.fetch_all_news&#39;,      &#39;schedule&#39;: crontab(minute&#x3D;0, hour&#x3D;&#39;*&#x2F;1&#39;),    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>定时任务配置对象是一个dict，由任务名和配置项组成，主要配置想如下：</p><pre><code>task：任务函数所在的模块，模块路径得写全，否则找不到将无法运行该任务schedule：定时策略，一般使用 celery.schedules.crontab ，上面例子为每小时的0分执行一次任务，具体写法与linux的crontab类似可以参考文档说明args：是个元组，给出任务需要的参数，如果不需要参数也可以不写进配置，就像例子中的一样其余配置项较少用，可以参考文档</code></pre><p>至此，配置celery beat的部分就结束了。</p><h3 id="启动celery-beat"><a href="#启动celery-beat" class="headerlink" title="启动celery beat"></a>启动celery beat</h3><p>配置完成后只需要启动celery了。</p><p>启动之前配置一下环境。不要用root运行celery！不要用root运行celery！不要用root运行celery！重要的事情说三遍。</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># start-celery.sh：export REDIS_ADDR&#x3D;127.0.0.1celery -A Website worker -l info -B -f &#x2F;path&#x2F;to&#x2F;log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>-A 表示app所在的目录，-B表示启动celery beat运行定时任务。</p><p>celery正常启动后就可以通过日志来查看任务是否正常运行了：</p>]]></content>
      
      
      <categories>
          
          <category> Django全网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django综合篇之django-haystack配置详解过程</title>
      <link href="/post/django-quan-wang-zhan-da-jian/django-zong-he-pian-zhi-django-haystack-pei-zhi-xiang-jie-guo-cheng/"/>
      <url>/post/django-quan-wang-zhan-da-jian/django-zong-he-pian-zhi-django-haystack-pei-zhi-xiang-jie-guo-cheng/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>django是python语言的一个web框架，功能强大。配合一些插件可为web网站很方便地添加搜索功能。</p><p>搜索引擎使用whoosh，是一个纯python实现的全文搜索引擎，小巧简单。</p><p>中文搜索需要进行中文分词，使用jieba。</p><p>直接在django项目中使用whoosh需要关注一些基础细节问题，而通过haystack这一搜索框架，可以方便地在django中直接添加搜索功能，无需关注索引建立、搜索解析等细节问题。</p><p>haystack支持多种搜索引擎，不仅仅是whoosh，使用solr、elastic search等搜索，也可通过haystack，而且直接切换引擎即可，甚至无需修改搜索代码。</p><h1 id="配置搜索"><a href="#配置搜索" class="headerlink" title="配置搜索"></a>配置搜索</h1><h2 id="1-安装相关包"><a href="#1-安装相关包" class="headerlink" title="1.安装相关包"></a>1.安装相关包</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">pip install django-haystackpip install whooshpip install jieba<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="2-配置django的settings"><a href="#2-配置django的settings" class="headerlink" title="2.配置django的settings"></a>2.配置django的settings</h2><p>修改settings.py文件，添加haystack应用：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token string">'haystack'</span><span class="token punctuation">,</span> <span class="token comment">#将haystack放在最后</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在settings中追加haystack的相关配置：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">HAYSTACK_CONNECTIONS <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token comment"># 此处为默认的WhooshEngine，后面会修改它,因此把它注释掉</span>        <span class="token comment"># 'ENGINE': 'haystack.backends.whoosh_cn_backend.WhooshEngine', </span>        <span class="token string">'ENGINE'</span><span class="token punctuation">:</span> <span class="token string">'blog.whoosh_cn_backend.WhooshEngine'</span><span class="token punctuation">,</span>        <span class="token string">'PATH'</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'whoosh_index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment"># 添加此项，当数据库改变时，会自动更新索引，非常方便</span>HAYSTACK_SIGNAL_PROCESSOR <span class="token operator">=</span> <span class="token string">'haystack.signals.RealtimeSignalProcessor'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>HAYSTACK_CONNECTIONS 的 ENGINE 指定了 django haystack 使用的搜索引擎，这里我们使用了 blog.whoosh_cn_backend.WhooshEngine，虽然目前这个引擎还不存在，但我们接下来会创建它。</p></li><li><p>PATH 指定了索引文件需要存放的位置，我们设置为项目根目录 BASE_DIR 下的 whoosh_index 文件夹（在建立索引是会自动创建）。</p></li><li><p>HAYSTACK_SIGNAL_PROCESSOR 指定什么时候更新索引，这里我们使用haystack.signals.RealtimeSignalProcessor，作用是每当有文章更新时就更新索引。由于博客文章更新不会太频繁，因此实时更新没有问题。</p><h2 id="3-添加url"><a href="#3-添加url" class="headerlink" title="3.添加url"></a>3.添加url</h2></li></ul><p>在整个项目的urls.py中，配置搜索功能的url路径：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># path('search/', include('haystack.urls')), #这是默认的搜索路由</span>    path<span class="token punctuation">(</span><span class="token string">'blog_search/'</span><span class="token punctuation">,</span> BlogSearchView<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'haystack'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                  <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果不重新搜索视图，那么添加上面注释掉的路由就可以了。<br>我们添加了自己重新写的一个搜索视图，下面会具体介绍。</p><h2 id="4-在应用目录下，添加一个索引"><a href="#4-在应用目录下，添加一个索引" class="headerlink" title="4.在应用目录下，添加一个索引"></a>4.在应用目录下，添加一个索引</h2><p>在子应用的目录下，创建一个名为 search_indexes.py 的文件。<br><strong>这是 django haystack 的规定</strong>。要相对某个 app 下的数据进行全文检索，就要在该 app 下创建一个 search_indexes.py 文件，然后创建一个 XXIndex 类（XX 为含有被检索数据的模型，如这里的 Blog），并且继承 SearchIndex 和 Indexable。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> haystack <span class="token keyword">import</span> indexes<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Blog   <span class="token comment"># 修改此处，添加自己model</span><span class="token comment"># 类名必须为需要检索的Model_name+Index，这里需要检索Blog，所以创建BlogIndex</span><span class="token keyword">class</span> <span class="token class-name">BlogIndex</span><span class="token punctuation">(</span>indexes<span class="token punctuation">.</span>SearchIndex<span class="token punctuation">,</span> indexes<span class="token punctuation">.</span>Indexable<span class="token punctuation">)</span><span class="token punctuation">:</span>    text <span class="token operator">=</span> indexes<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>document<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> use_template<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    ③ <span class="token comment"># 此外可以存在，可以不存在，看具体需要的数据</span>    <span class="token triple-quoted-string string">"""下面这些字段，在索引类中进行申明，在REST framework中，索引类的字段可以被作为索引查询结果返回数据额来源"""</span>        <span class="token builtin">id</span> <span class="token operator">=</span> indexes<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>model_attr<span class="token operator">=</span><span class="token string">'id'</span><span class="token punctuation">)</span>    name <span class="token operator">=</span> indexes<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>model_attr<span class="token operator">=</span><span class="token string">'name'</span><span class="token punctuation">)</span>    price <span class="token operator">=</span> indexes<span class="token punctuation">.</span>DecimalField<span class="token punctuation">(</span>model_attr<span class="token operator">=</span><span class="token string">'price'</span><span class="token punctuation">)</span>    <span class="token triple-quoted-string string">"""也就是说，前端在索引的时候，可以按照text=xxx,也可以按照id=xxx,name=xxx等，我们的数据返回也是返回id,name,price """</span>    <span class="token keyword">def</span> <span class="token function">get_model</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> Blog                     <span class="token comment"># 添加自己model</span>    <span class="token keyword">def</span> <span class="token function">index_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> using<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>get_model<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>说明：</p><ul><li><p>修改上文中三处注释即可</p></li><li><p>此文件指定如何通过已有数据来建立索引。get_model处，直接将django中的model放过来，便可以直接完成索引啦，无需关注数据库读取、索引建立等细节。</p></li><li><p>text=indexes.CharField ，指定了将模型类中的哪些字段建立索引，而use_template=True说明后续我们还要指定一个模板文件，告知具体是哪些字段<br>每个索引里面必须有且只能有一个字段为 document=True，这代表 django haystack 和搜索引擎将使用此字段的内容作为索引进行检索(primary field)。注意，如果使用一个字段设置了document=True，则一般约定此字段名为text，这是在 SearchIndex 类里面一贯的命名，以防止后台混乱</p></li><li><p>use_template=True 在 text 字段中，这样就允许我们使用数据模板去建立搜索引擎索引的文件，说得通俗点就是索引里面需要存放一些什么东西，例如 Post 的 title 字段，这样我们可以通过 title 内容来检索 Post 数据了。举个例子，假如你搜索 Python ，那么就可以检索出 title 中含有 Python 的Blog了。</p></li></ul><h2 id="5-指定索引模板文件"><a href="#5-指定索引模板文件" class="headerlink" title="5.指定索引模板文件"></a>5.指定索引模板文件</h2><p>在项目的“templates/search/indexes/应用名称/”下创建“模型类名称_text.txt”文件（例如 templates/search/indexes/blog/blog_text.txt),全小写即可。</p><p>此文件指定将模型中的哪些字段建立索引，写入如下内容：（不要改掉object,可以继续添加其他的字段) </p><pre class="line-numbers language-none"><code class="language-none"># templates&#x2F;search&#x2F;indexes&#x2F;blog&#x2F;blog_text.txt&#123;&#123; object.title &#125;&#125;&#123;&#123; object.body &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="6-指定搜索结果页面"><a href="#6-指定搜索结果页面" class="headerlink" title="6.指定搜索结果页面"></a>6.指定搜索结果页面</h2><p>在templates/search/下面，建立一个search.html页面。</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>&#123;% if query %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>搜索结果如下：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>    &#123;% for result in page.object_list %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/&#123;&#123; result.object.id &#125;&#125;/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; result.object.title&#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span>    &#123;% empty %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>啥也没找到<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    &#123;% endfor %&#125;    &#123;% if page.has_previous or page.has_next %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>            &#123;% if page.has_previous %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?q=&#123;&#123; query &#125;&#125;<span class="token entity named-entity" title="&amp;">&amp;amp;</span>page=&#123;&#123; page.previous_page_number &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;% endif %&#125;<span class="token entity named-entity" title="&laquo;">&amp;laquo;</span> 上一页&#123;% if page.has_previous %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>&#123;% endif %&#125;        |            &#123;% if page.has_next %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?q=&#123;&#123; query &#125;&#125;<span class="token entity named-entity" title="&amp;">&amp;amp;</span>page=&#123;&#123; page.next_page_number &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;% endif %&#125;下一页 <span class="token entity named-entity" title="&raquo;">&amp;raquo;</span>&#123;% if page.has_next %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>&#123;% endif %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    &#123;% endif %&#125;&#123;% endif %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7-使用jieba中文分词器"><a href="#7-使用jieba中文分词器" class="headerlink" title="7.使用jieba中文分词器"></a>7.使用jieba中文分词器</h2><p>在haystack的安装文件夹下，找到文件路径如“/usr/local/lib/python3.6/dist-packages/django_haystack-2.8.1-py3.6.egg/haystack/backends/whoosh_backend.py”，复制一份到自己的app 路径下重命名为whoosh_cn_backend.py，然后添加修改如下内容：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 顶部引入jieba中的中文分词器</span><span class="token keyword">from</span> jieba<span class="token punctuation">.</span>analyse <span class="token keyword">import</span> ChineseAnalyzer<span class="token comment"># 在整个py文件中，查找</span>analyzer<span class="token operator">=</span>StemmingAnalyzer<span class="token punctuation">(</span><span class="token punctuation">)</span>全部改为改为analyzer<span class="token operator">=</span>ChineseAnalyzer<span class="token punctuation">(</span><span class="token punctuation">)</span>总共大概有两三处吧<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8-修改搜索默认引擎"><a href="#8-修改搜索默认引擎" class="headerlink" title="8.修改搜索默认引擎"></a>8.修改搜索默认引擎</h2><p>如果之前已经做了修改，这一步就可以跳过了，修改settings.py文件</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">HAYSTACK_CONNECTIONS <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token comment"># 此处为默认的WhooshEngine，后面会修改它,因此把它注释掉</span>        <span class="token comment"># 'ENGINE': 'haystack.backends.whoosh_cn_backend.WhooshEngine', </span>        <span class="token string">'ENGINE'</span><span class="token punctuation">:</span> <span class="token string">'blog.whoosh_cn_backend.WhooshEngine'</span><span class="token punctuation">,</span>        <span class="token string">'PATH'</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'whoosh_index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">## 10.实现搜索入口在网页中加入搜索框：&#96;&#96;&#96;html&lt;form method&#x3D;&#39;get&#39; action&#x3D;&quot;&#x2F;blog&#x2F;blog_search&#x2F;&quot; target&#x3D;&quot;_blank&quot;&gt;    &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;q&quot;&gt;    &lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;查询&quot;&gt;&lt;&#x2F;form&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意，由于我们自定义了search_view的路由，因此，这里的action需要写成写对的位置，或者</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>blog:haystack<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>get<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="10-自定义搜索视图"><a href="#10-自定义搜索视图" class="headerlink" title="10. 自定义搜索视图"></a>10. 自定义搜索视图</h2><h2 id="11-序列化API设置"><a href="#11-序列化API设置" class="headerlink" title="11. 序列化API设置"></a>11. 序列化API设置</h2><h3 id="1-安装相关包-1"><a href="#1-安装相关包-1" class="headerlink" title="1.安装相关包"></a>1.安装相关包</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">pip install drf-haystack pip install djangorestframework <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>安装需要的第三方包</p><h3 id="2-编写序列化类"><a href="#2-编写序列化类" class="headerlink" title="2.编写序列化类"></a>2.编写序列化类</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># blog/serializer.py</span><span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> <span class="token punctuation">.</span>search_indexes <span class="token keyword">import</span> BlogIndex<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>serializers <span class="token keyword">import</span> ModelSerializer<span class="token keyword">from</span> drf_haystack<span class="token punctuation">.</span>serializers <span class="token keyword">import</span> HaystackSerializerMixin<span class="token keyword">class</span> <span class="token class-name">BlogSerializers</span><span class="token punctuation">(</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> Blog        fields <span class="token operator">=</span> <span class="token string">'__all__'</span>        <span class="token keyword">class</span> <span class="token class-name">BlogIndexSerializer</span><span class="token punctuation">(</span>HaystackSerializerMixin<span class="token punctuation">,</span> BlogSerializers<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span>BlogSerializers<span class="token punctuation">.</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>        index_classes <span class="token operator">=</span> <span class="token punctuation">[</span>BlogIndex<span class="token punctuation">]</span>        search_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">]</span>  <span class="token comment"># 不能和正常搜索一样使用q参数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里序列化Blog数据 和BlogIndex数据</p><p>注意BlogIndexSerializer 中的search_fields ，这里可查询的数据源对应Blog的Model中的数据</p><h3 id="3-视图设置"><a href="#3-视图设置" class="headerlink" title="3.视图设置"></a>3.视图设置</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> drf_haystack<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> HaystackViewSet<span class="token keyword">from</span> <span class="token punctuation">.</span>serializers <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> <span class="token punctuation">.</span>models improt Blog<span class="token keyword">class</span> <span class="token class-name">BlogSearchViewSet</span><span class="token punctuation">(</span>HaystackViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    返回博客文章搜索列表    """</span>    index_models <span class="token operator">=</span> <span class="token punctuation">[</span>Blog<span class="token punctuation">]</span>    serializer_class <span class="token operator">=</span> BlogIndexSerializer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-配置urls路由"><a href="#4-配置urls路由" class="headerlink" title="4.配置urls路由"></a>4.配置urls路由</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token keyword">from</span> blog <span class="token keyword">import</span> views <span class="token keyword">as</span> blog_view<span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> routersrouter <span class="token operator">=</span> routers<span class="token punctuation">.</span>DefaultRouter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 因为视图没有定义query_set字段，因此需要加上basename字段</span>router<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">r'blog_search'</span><span class="token punctuation">,</span> blog_view<span class="token punctuation">.</span>BlogSearchViewSet<span class="token punctuation">,</span> basename<span class="token operator">=</span><span class="token string">'blog_search'</span><span class="token punctuation">)</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'api/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span>router<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment"># API路由</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="12-生成索引"><a href="#12-生成索引" class="headerlink" title="12.生成索引"></a>12.生成索引</h2><p>手动生成一次索引：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">python3 manage.py rebuild_index<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="丰富的自定义"><a href="#丰富的自定义" class="headerlink" title="丰富的自定义"></a>丰富的自定义</h1><p>上面只是快速完成一个基本的搜索引擎，haystack还有更多可自定义，来实现个性化的需求。</p><pre><code>参考官方文档：http://django-haystack.readthedocs.io/en/master/</code></pre><h1 id="自定义搜索view"><a href="#自定义搜索view" class="headerlink" title="自定义搜索view"></a>自定义搜索view</h1><p>上面的配置中，搜索相关的请求被导入到haystack.urls中，如果想自定义搜索的view，实现更多功能，可以修改。</p><h2 id="1-自定义路由"><a href="#1-自定义路由" class="headerlink" title="1.自定义路由"></a>1.自定义路由</h2><p>haystack.urls中内容其实很简单，</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url  <span class="token keyword">from</span> <span class="token punctuation">.</span>views <span class="token keyword">import</span> SearchView    urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>      path<span class="token punctuation">(</span><span class="token string">'blog_search/'</span><span class="token punctuation">,</span> BlogSearchView<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'haystack'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-自定义视图"><a href="#2-自定义视图" class="headerlink" title="2.自定义视图"></a>2.自定义视图</h2><p>那么，我们写一个view，继承自SearchView，即可将搜索的url导入到自定义view中处理啦。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> haystack<span class="token punctuation">.</span>views <span class="token keyword">import</span> SearchView<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Blog<span class="token keyword">import</span> json<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse<span class="token keyword">class</span> <span class="token class-name">BlogSearchView</span><span class="token punctuation">(</span>SearchView<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 重写template的位置</span>    template <span class="token operator">=</span> <span class="token string">'search/blog_search.html'</span>    <span class="token keyword">def</span> <span class="token function">get_context</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>BlogSearchView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context<span class="token punctuation">(</span><span class="token punctuation">)</span>        results <span class="token operator">=</span> self<span class="token punctuation">.</span>results        <span class="token comment"># 当搜索引擎找不到时，重新从数据库中找一遍</span>        <span class="token keyword">if</span> results<span class="token punctuation">.</span>__len__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>            results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            search_blogs <span class="token operator">=</span> Blog<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>title__icontains<span class="token operator">=</span>self<span class="token punctuation">.</span>query<span class="token punctuation">,</span>                                               content__icontains<span class="token operator">=</span>self<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-created_time'</span><span class="token punctuation">)</span>            <span class="token keyword">for</span> search_blog <span class="token keyword">in</span> search_blogs<span class="token punctuation">:</span>                results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"object"</span><span class="token punctuation">:</span> search_blog<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment"># 将result结果返回为Blog列表</span>        results <span class="token operator">=</span> <span class="token punctuation">[</span>blog<span class="token punctuation">[</span><span class="token string">'object'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> blog <span class="token keyword">in</span> results<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">if</span> results<span class="token punctuation">.</span>__len__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">else</span> results        context<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'博客搜索'</span><span class="token punctuation">,</span>            <span class="token string">'results'</span><span class="token punctuation">:</span> results        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> context<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看SearchView的源码或文档，了解每个方法是做什么的，便可有针对性地进行修改。</p><ul><li> 上面重写了template变量，修改了搜索结果页面模板的位置。</li><li> 重写get_context方法，添加一些自己想要的字段，修改results的格式<h2 id="3-高亮搜索关键字"><a href="#3-高亮搜索关键字" class="headerlink" title="3.高亮搜索关键字"></a>3.高亮搜索关键字</h2></li></ul><p>在搜索结果页的模板中，可以使用highlight标签（需要先load一下）</p><pre class="line-numbers language-none"><code class="language-none">&#123;% highlight &lt;text_block&gt; with &lt;query&gt; [css_class &quot;class_name&quot;] [html_tag &quot;span&quot;] [max_length 200] %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>text_block即为全部文字，query为高亮关键字，后面可选参数，可以定义高亮关键字的html标签、css类名，以及整个高亮部分的最长长度。</p><pre><code>高亮部分的源码位于 haystack/templatetags/lighlight.py 和 haystack/utils/lighlighting.py文件中，可复制进行修改，实现自定义高亮功能。</code></pre>]]></content>
      
      
      <categories>
          
          <category> Django全网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step07收藏与点赞功能</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step07-shou-cang-yu-dian-zan-gong-neng/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step07-shou-cang-yu-dian-zan-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>#收藏与点赞功能<br>本节讲一下个人菜单中另外两个比较重要的功能，“我的收藏”与“我的喜欢”。<br>通过学习这两个功能，我们会加深对django中通用视图类的理解与应用。</p><p>##我的收藏<br>###模型<br>上一节已经实现这个模型了<br>我的收藏、我的喜欢，都是与我关联，又因为，我可以收藏多个视频，视频也可以被多个用户收藏，所以用户与视频是属于多对多的关系。<br>所以我们在video模型上添加两个字段liked和collected，分别对应我喜欢和我收藏。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># video/models.py</span><span class="token keyword">class</span> <span class="token class-name">Video</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 观看次数。数据类型是IntegerField，默认是0</span>    view_count <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token comment"># 喜欢的用户。数据类型是ManyToManyField，这是一种多对多的关系，表示一个视频可以被多个用户喜欢，一个用户也可以喜欢多个视频。记得设置用户表为settings.AUTH_USER_MODEL</span>    liked <span class="token operator">=</span> models<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>AUTH_USER_MODEL<span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> related_name<span class="token operator">=</span><span class="token string">"liked_videos"</span><span class="token punctuation">)</span>    <span class="token comment"># 收藏的用户。数据类型是ManyToManyField，这是一种多对多的关系，表示一个视频可以被多个用户收藏，一个用户也可以收藏多个视频。设置用户表为settings.AUTH_USER_MODEL</span>    collected <span class="token operator">=</span> models<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>AUTH_USER_MODEL<span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> related_name<span class="token operator">=</span><span class="token string">"collected_videos"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    created_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看出liked和collected字段都是属于ManyToManyField类型，表示视频与用户是多对多的关系。</p><p>并分别设置它们的别名为”liked_videos”和”collected_videos”，通过别名也可以访问到数据。<br>###路由设置<br>下面我们来添加两者的路由，添加在users/urls.py下面。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">'&lt;int:pk>/collect_videos/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>CollectListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'collect_videos'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>path<span class="token punctuation">(</span><span class="token string">'&lt;int:pk>/like_videos/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>LikeListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'like_videos'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>其中，我的收藏的视图类是CollectListView，我的喜欢的视图类是LikeListView。我们先来实现CollectListView</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># userprofile/views.py</span><span class="token keyword">class</span> <span class="token class-name">CollectListView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> User    template_name <span class="token operator">=</span> <span class="token string">'users/collect_videos.html'</span>    context_object_name <span class="token operator">=</span> <span class="token string">'video_list'</span>    paginate_by <span class="token operator">=</span> <span class="token number">10</span>    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> object_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>CollectListView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        paginator <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'paginator'</span><span class="token punctuation">)</span>        page <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page_obj'</span><span class="token punctuation">)</span>        page_list <span class="token operator">=</span> get_page_list<span class="token punctuation">(</span>paginator<span class="token punctuation">,</span> page<span class="token punctuation">)</span>        context<span class="token punctuation">[</span><span class="token string">'page_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> page_list        <span class="token keyword">return</span> context    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        user <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>User<span class="token punctuation">,</span> pk<span class="token operator">=</span>self<span class="token punctuation">.</span>kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'pk'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        videos <span class="token operator">=</span> user<span class="token punctuation">.</span>collected_videos<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> videos<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>与首页展示的功能类似，这里同样继承了ListView通用视图类。并使用了公共函数get_page_list对数据进行分页。<br>在获取收藏数据列表时，我们用的是user.collected_videos.all()，其中collected_videos就是前面定义的别名。<br>并通过配置template_name将数据传递给模板文件users/collect_videos.html。<br>###前端代码<br>模板文件关键代码</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>我的收藏<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui unstackable items<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    &#123;% for item in video_list %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui tiny image<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            &#123;% thumbnail item.cover "300x200" crop="center" as im %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui image<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; im.url &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            &#123;% empty %&#125;            &#123;% endthumbnail %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>middle aligned content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>header<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>video:detail<span class="token punctuation">'</span> item.pk %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; item.title &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    &#123;% empty %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>暂无数据<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>    &#123;% endfor %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% include "base/page_nav.html" %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>##我的喜欢</p><p>下面来开发我的喜欢功能</p><p>该功能与我的收藏功能类似。因为前面已经添加了like_videos路由，我们直接写LikeListView的代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">LikeListView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> User    template_name <span class="token operator">=</span> <span class="token string">'users/like_videos.html'</span>    context_object_name <span class="token operator">=</span> <span class="token string">'video_list'</span>    paginate_by <span class="token operator">=</span> <span class="token number">10</span>    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> object_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>LikeListView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        paginator <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'paginator'</span><span class="token punctuation">)</span>        page <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page_obj'</span><span class="token punctuation">)</span>        page_list <span class="token operator">=</span> get_page_list<span class="token punctuation">(</span>paginator<span class="token punctuation">,</span> page<span class="token punctuation">)</span>        context<span class="token punctuation">[</span><span class="token string">'page_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> page_list        <span class="token keyword">return</span> context    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        user <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>User<span class="token punctuation">,</span> pk<span class="token operator">=</span>self<span class="token punctuation">.</span>kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'pk'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        videos <span class="token operator">=</span> user<span class="token punctuation">.</span>liked_videos<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> videos<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>与我的收藏的模式一模一样，同样是继承ListView并设置相关model与template_name变量。最终通过users/like_videos.html来渲染。</p>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step3首页功能</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step3-shou-ye-gong-neng/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step3-shou-ye-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>#首页功能<br>在本讲中，我们开始首页功能的开发，在开发过程中，<br>学习到Django中的通用视图类、分页对象paginator以及foreignKey外键的使用。</p><p>首页拆解为4个小的业务模块来开发，分别是：列表显示、分页功能、搜索功能、分类功能。</p><p>下面我们分别对这四个功能模块进行开发讲解。<br>开发思路</p><p>开发一个功能的基本思路是：先新建应用，然后分析功能涉及到哪些业务，从而分析出需要的数据库字段，然后编写模型，之后就是展示阶段，通过url路由配置视图函数，来将模型里面的数据显示出来。</p><p>ok，我们通过命令建立应用，命名为video。执行后，django将为我们新建video文件夹。</p><pre><code>python3 manage.py startapp video</code></pre><p>下面的功能模块开发都在该应用(video)下进行。<br>##建模型</p><p>此处，我们需要建立两个模型，分别是分类表(classification)和视频列表(video)。</p><p>他们是多对一的关系(一个分类对应多个视频，一个视频对应一个分类)。</p><p>首先编写Classification表，在model.py下面，我们键入如下代码。</p><p>字段有title(分类名称)和status(是否启用)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models<span class="token keyword">class</span> <span class="token class-name">Classification</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    list_display <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span><span class="token punctuation">)</span>    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    status <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        db_table <span class="token operator">=</span> <span class="token string">"v_classification"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>字段说明</p><pre><code>title      分类名称。数据类型是CharField，最大长度为max_length=100，允许为空null=Truestatus     是否启用。数据类型是BooleanField,默认为default=Truedb_table   表名</code></pre><p>然后编写Video模型，根据网站业务，我们设置了title(标题)、 desc(描述)、 classification(分类)、file(视频文件)、cover(封面)、status(发布状态)等字段。</p><p>其中classification是一个ForeignKey外键字段，表示一个分类对应多个视频，一个视频对应一个分类(多对一)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models<span class="token keyword">class</span> <span class="token class-name">Video</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    STATUS_CHOICES <span class="token operator">=</span> <span class="token punctuation">(</span>        <span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'发布中'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'未发布'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>                             <span class="token comment"># 标题</span>    desc <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>                              <span class="token comment"># 描述</span>    classification <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>Classification<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>     <span class="token comment"># 外键关联分类</span>    <span class="token builtin">file</span> <span class="token operator">=</span> models<span class="token punctuation">.</span>FileField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>                                                     <span class="token comment"># 视频文件地址</span>    cover <span class="token operator">=</span> models<span class="token punctuation">.</span>ImageField<span class="token punctuation">(</span>upload_to<span class="token operator">=</span><span class="token string">'cover/'</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>                        <span class="token comment"># 封面,设置了存贮目录</span>    status <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> choices<span class="token operator">=</span>STATUS_CHOICES<span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>      <span class="token comment"># 发布状态</span>    created_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>            <span class="token comment"># 创建时间 自动生成时间</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        db_table <span class="token operator">=</span> <span class="token string">"v_video"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>字段说明</p><pre><code>title       视频标题。数据类型是charField，最大长度为max_length=100，允许为空null=Truedesc        视频描述。数据类型是charField，最大长度为max_length=255，允许为空null=Truefile        视频文件地址。数据类型是fileField。其中存的是视频文件的地址，在之后的视频管理中我们将会对视频的上传进行具体的讲解。cover       视频封面。数据类型是ImageField。存储目录为upload_to=‘cover/’，允许为空null=Truestatus      视频状态。是一个选择状态，用choices设置多选元祖。created_time 创建时间。数据类型是DateTimeField 。设置自动生成时间auto_now_add=True</code></pre><p>ForeignKey  表明一种一对多的关联关系。</p><p>比如这里我们的视频和分类的关系，一个视频只能对应一个分类，而一个分类下可以有多个视频。</p><p>更多关于ForeinkKey的说明，可以参看 <a href="https://docs.djangoproject.com/zh-hans/3.1/topics/db/examples/many_to_one/" title="官方介绍">ForeignKey</a></p><p>将新建好的模型注册一下,在video/admin.py 注册如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># Register your models here.)</span>admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Classification<span class="token punctuation">)</span>admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Video<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>##路由配置和注册app</p><p>要想访问到首页，必须先配置好路由。在video下建立urls.py文件<br>命名空间为app的名字‘video’，添加路由信息</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> viewsapp_name <span class="token operator">=</span> <span class="token string">'video'</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>IndexView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'search/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>SearchListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'search'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同时在project中的urls.py 添加路由信息</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>IndexView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'search/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>SearchListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'search'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在设置中添加安装和使用的app， settings。py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">'django.contrib.admin'</span><span class="token punctuation">,</span>    <span class="token string">'django.contrib.auth'</span><span class="token punctuation">,</span>    <span class="token string">'django.contrib.contenttypes'</span><span class="token punctuation">,</span>    <span class="token string">'django.contrib.sessions'</span><span class="token punctuation">,</span>    <span class="token string">'django.contrib.messages'</span><span class="token punctuation">,</span>    <span class="token string">'django.contrib.staticfiles'</span><span class="token punctuation">,</span>    <span class="token string">'users'</span><span class="token punctuation">,</span>    <span class="token string">'video'</span><span class="token punctuation">,</span>                     <span class="token comment"># 新添加的app</span>    <span class="token string">'sorl.thumbnail'</span><span class="token punctuation">,</span>            <span class="token comment"># 本次使用的app，通过thumbnail添加缩略图  </span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一条path语句就代表一条路由信息。这样我们就可以在浏览器输入127.0.0.1:8000/video/index来访问首页了。<br>##显示列表<br>显示列表数据非常简单，我们使用django中内置的视图模版类ListView来显示，首先在view.py中编写IndexView类，用它来显示列表数据。键入如下代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">IndexView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Video    template_name <span class="token operator">=</span> <span class="token string">'video/index.html'</span>    context_object_name <span class="token operator">=</span> <span class="token string">'video_list'</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>此处，我们使用了django提供的通用视图类ListView, ListView使用很简单，只需要我们简单的配置几行代码，即可将数据库里面的数据渲染到前端。比如上述代码中，我们配置了</p><pre><code>model = Video, 作用于Video模型template_name = ‘video/index.html’ ，告诉ListView要使用我们已经创建的模版文件。context_object_name = ‘video_list’ ，上下文变量名，告诉ListView，在前端模版文件中，可以使用该变量名来展现数据。</code></pre><p>##分类功能</p><p>在写分类功能之前，我们先学习一个回调函数 get_context_data()</p><p>这是ListView视图类中的一个函数，在 get_context_data() 函数中，可以传一些额外内容到模板。</p><p>因此我们可以使用该函数来传递分类数据。</p><p>要使用它，很简单。</p><p>只需要在IndexView类下面，追加get_context_data()的实现即可。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">IndexView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Video    template_name <span class="token operator">=</span> <span class="token string">'video/index.html'</span>    context_object_name <span class="token operator">=</span> <span class="token string">'video_list'</span>     <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> object_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>IndexView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        classification_list <span class="token operator">=</span> Classification<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>        context<span class="token punctuation">[</span><span class="token string">'classification_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> classification_list        <span class="token keyword">return</span> context<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在上述代码中，我们将分类数据通过Classification.objects.filter(status=True).values()从数据库里面过滤出来，然后赋给classification_list，最后放到context字典里面。</p><p>在前端模板（templates/video/index.html）中，就可以通过classification_list来取数据。添加代码</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classification<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui red label<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>全部<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    &#123;% for item in classification_list %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui label<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; item.title &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    &#123;% endfor %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当然现在只是实现了分类展示效果，我们还需要继续实现点击效果，即点击不同的分类，显示不同的视频列表。</p><p>我们先给每个分类按钮加上href链接</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classification<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui red label<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>home<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>全部<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    &#123;% for item in classification_list %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui label<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?c=&#123;&#123; item.id &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; item.title &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    &#123;% endfor %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过添加?c= 这里用c代表分类的id，点击后，会传到视图类中，在视图类中，我们使用 get_queryset() 函数，将get数据取出来。通过self.request.GET.get(“c”, None) 赋给c，判断c是否为None，如果为None，就响应全部，如果有值，就通过get_object_or_404(Classification, pk=self.c)先获取当前类，然后classification.video_set获取外键数据。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    self<span class="token punctuation">.</span>c <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>c<span class="token punctuation">:</span>        classification <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>Classification<span class="token punctuation">,</span> pk<span class="token operator">=</span>self<span class="token punctuation">.</span>c<span class="token punctuation">)</span>        <span class="token keyword">return</span> classification<span class="token punctuation">.</span>video_set<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-created_time'</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> Video<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-created_time'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>##分页功能</p><p>在Django中，有现成的分页解决方案，我们开发者省了不少事情。如果是简单的分页，只需要配置一下paginate_by即可实现。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">IndexView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Video    template_name <span class="token operator">=</span> <span class="token string">'video/index.html'</span>    context_object_name <span class="token operator">=</span> <span class="token string">'video_list'</span>    paginate_by <span class="token operator">=</span> <span class="token number">12</span>    c <span class="token operator">=</span> <span class="token boolean">None</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样每页的分页数据就能正确的显示出来来，现在来完善底部的页码条。</p><p>页码列表需要视图类和模板共同来完成，我们先来写视图类。</p><p>在前面我们已经写过get_context_data了，该函数的主要功能就是传递额外的数据给模板。这里，我们就利用get_context_data来传递页码数据。</p><p>我们先定义一个工具函数，叫get_page_list。<br> 在项目根目录下，新建一个文件helpers.py该文件当作一个全局的工具类，用来存放各种工具函数。</p><p> 把get_page_list放到helpers.py里面 该函数用来生产页码列表，不但这里可以使用，以后在其他地方也可以调用该函数。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_page_list</span><span class="token punctuation">(</span>paginator<span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">:</span>    page_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> paginator<span class="token punctuation">.</span>num_pages <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> page<span class="token punctuation">.</span>number <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">:</span>            start_page <span class="token operator">=</span> <span class="token number">1</span>        <span class="token keyword">elif</span> page<span class="token punctuation">.</span>number <span class="token operator">></span> paginator<span class="token punctuation">.</span>num_pages <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">:</span>            start_page <span class="token operator">=</span> paginator<span class="token punctuation">.</span>num_pages <span class="token operator">-</span> <span class="token number">9</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            start_page <span class="token operator">=</span> page<span class="token punctuation">.</span>number <span class="token operator">-</span> <span class="token number">5</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>start_page<span class="token punctuation">,</span> start_page <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            page_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> paginator<span class="token punctuation">.</span>num_pages <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            page_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    <span class="token keyword">return</span> page_list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>分页逻辑：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> 页数<span class="token operator">>=</span><span class="token number">10</span><span class="token punctuation">:</span>    当前页<span class="token operator">&lt;=</span><span class="token number">5</span>时，起始页为<span class="token number">1</span>    当前页<span class="token operator">></span><span class="token punctuation">(</span>总页数<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>时，起始页为<span class="token punctuation">(</span>总页数<span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">)</span>    其他情况 起始页为<span class="token punctuation">(</span>当前页<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>举例：</p><pre><code>假设一共16页情况1: 当前页==5  则页码列表为[1,2,3,4,5,6,7,8,9,10]情况2: 当前页==8  则页码列表为[3,4,5,6,7,8,9,10,11,12]情况3: 当前页==15 则页码列表为[7,8,9,10,11,12,13,14,15,16]`</code></pre><p>当然你看到这个逻辑会有点乱，建议大家读着代码，多试验几遍。</p><p>当拿到页码列表，我们继续改写get_context_data()函数。 将获取到的classification_list追加到context字典中。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>c <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> object_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>    context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>IndexView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>    classification_list <span class="token operator">=</span> Classification<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>    context<span class="token punctuation">[</span><span class="token string">'classification_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> classification_list    paginator <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'paginator'</span><span class="token punctuation">)</span>             <span class="token comment"># 返回的是分页对象</span>    page <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page_obj'</span><span class="token punctuation">)</span>                   <span class="token comment"># 返回的是当前页码</span>    page_list <span class="token operator">=</span> get_page_list<span class="token punctuation">(</span>paginator<span class="token punctuation">,</span> page<span class="token punctuation">)</span>    context<span class="token punctuation">[</span><span class="token string">'page_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> page_list    context<span class="token punctuation">[</span><span class="token string">'c'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>c    context<span class="token punctuation">[</span><span class="token string">'classification_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> classification_list    <span class="token keyword">return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当数据传递给模板之后，模板就负责显示出来就行了。</p><p>因为分页功能比较常用，所以需要把它单独拿出来封装到一个单独的文件中，我们新建templates/base/page_nav.html文件。然后在index.html里面我们将该文件include进来。</p><pre><code>&#123;% include "base/page_nav.html" %&#125;</code></pre><p>打开page_nav.html，写入代码</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&#123;% if is_paginated %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video-page<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui circular labels<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        &#123;% if page_obj.has_previous %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui circular label<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=&#123;&#123; page_obj.previous_page_number &#125;&#125;&#123;% if c %&#125;&amp;c=&#123;&#123;c&#125;&#125;&#123;% endif %&#125;&#123;% if q %&#125;&amp;q=&#123;&#123;q&#125;&#125;&#123;% endif %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&lt;">&amp;lt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        &#123;% endif %&#125;        &#123;% for i in page_list %&#125;        &#123;% if page_obj.number == i %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui red circular label<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; i &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        &#123;% else %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui circular label<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=&#123;&#123; i &#125;&#125;&#123;% if c %&#125;&amp;c=&#123;&#123;c&#125;&#125;&#123;% endif %&#125;&#123;% if q %&#125;&amp;q=&#123;&#123;q&#125;&#125;&#123;% endif %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; i &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        &#123;% endif %&#125;        &#123;% endfor %&#125;        &#123;% if page_obj.has_next %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui circular label<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=&#123;&#123; page_obj.next_page_number &#125;&#125;&#123;% if c %&#125;&amp;c=&#123;&#123;c&#125;&#125;&#123;% endif %&#125;&#123;% if q %&#125;&amp;q=&#123;&#123;q&#125;&#125;&#123;% endif %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        &#123;% endif %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endif %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面代码中，我们用到了page_obj对象的几个属性：</p><pre><code>    has_previous    previous_page_number    next_page_number</code></pre><p>通过这几个属性，即可实现复杂的页码显示效果。其中我们还这href里面加了</p><pre><code>&#123;% if c %&#125;&amp;c=&#123;&#123;c&#125;&#125;</code></pre><p>代表分类的id。<br>##搜索功能</p><p>要实现搜索，我们需要一个搜索框</p><p>因为搜索框是很多页面都需要的，所以我们把代码写到templates/base/header.html文件里面。</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui small icon input v-video-search<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>prompt<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; q &#125;&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>搜索视频<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>v-search<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>search<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>search icon<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">cursor</span><span class="token punctuation">:</span>pointer<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>点击搜索或回车的代码写在了static/js/header.js里面。</p><p>我们还需要配置一下路由，添加一行搜索的路由。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">app_name <span class="token operator">=</span> <span class="token string">'video'</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>IndexView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'search/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>SearchListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'search'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>搜索路由指向的视图类为SearchListView</p><p>下面我们来写SearchListView的代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">SearchListView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Video    template_name <span class="token operator">=</span> <span class="token string">'video/search.html'</span>    context_object_name <span class="token operator">=</span> <span class="token string">'video_list'</span>    paginate_by <span class="token operator">=</span> <span class="token number">8</span>    q <span class="token operator">=</span> <span class="token string">''</span>    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>q <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> Video<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>title__contains<span class="token operator">=</span>self<span class="token punctuation">.</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> object_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>SearchListView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        paginator <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'paginator'</span><span class="token punctuation">)</span>        page <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page_obj'</span><span class="token punctuation">)</span>        page_list <span class="token operator">=</span> get_page_list<span class="token punctuation">(</span>paginator<span class="token punctuation">,</span> page<span class="token punctuation">)</span>        context<span class="token punctuation">[</span><span class="token string">'page_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> page_list        context<span class="token punctuation">[</span><span class="token string">'q'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>q        <span class="token keyword">return</span> context<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关键代码就是Video.objects.filter(title__contains=self.q).filter(status=0)<br>title__contains是包含的意思，表示查询title包含q的记录。利用filter将数据过滤出来。这里写了两层过滤，第一层过滤搜索关键词，第二层过滤status已发布的视频。</p><p>另外，这里也用到了get_context_data来存放额外的数据，包括分页数据、q关键词。</p><p>配置模板文件是templates/video/search.html</p><p>因此模板代码写在search.html里面</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui unstackable items<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    &#123;% for item in video_list %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui tiny image<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            &#123;% thumbnail item.cover "300x200" crop="center" as im %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui image<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; im.url &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            &#123;% empty %&#125;            &#123;% endthumbnail %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>middle aligned content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>header<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>video:detail<span class="token punctuation">'</span> item.pk %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; item.title &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    &#123;% empty %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>暂无数据<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>    &#123;% endfor %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% include "base/page_nav.html" %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>##其他<br>media 媒体文件需要添加<br>在设置中需要添加</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 媒体文件上传路径，包括视频封面，个人头像</span>MEDIA_ROOT <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'upload'</span><span class="token punctuation">)</span>MEDIA_URL <span class="token operator">=</span> <span class="token string">'/upload/'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>同时需要讲媒体文件路径加入到路由表中</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings<span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls<span class="token punctuation">.</span>static <span class="token keyword">import</span> staticurlpatterns <span class="token operator">+=</span> static<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>MEDIA_URL<span class="token punctuation">,</span> document_root<span class="token operator">=</span>settings<span class="token punctuation">.</span>MEDIA_ROOT<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step5详情页面开发</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step5-xiang-qing-ye-mian-kai-fa/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step5-xiang-qing-ye-mian-kai-fa/</url>
      
        <content type="html"><![CDATA[<p>#详情页面开发<br>在本讲中，我们开始详情页功能的开发.</p><p>详情页就是对单个视频进行播放并展示视频的相关信息，比如视频标题、描述、评论信息、相关推荐等。</p><p>我们将会学习到通用视图类DetailView的使用、评论动态加载、以及如何通过ajax实现喜欢和收藏功能，并通过一段段很酷的代码来说明这些功能。</p><p>#整体功能</p><ul><li>1.详情页功能。</li><li>2.对单个视频进行展示，包括标题、描述、观看次数</li><li>3.点赞和收藏功能。</li><li>4.评论功能，通过上拉网页即可分页加载评论列表，用户还能添加评论。</li><li>5.侧栏推荐视频列表，推荐逻辑为推荐观看次数最多的视频。</li><li>6.list页面点击某个视频或者其标题跳转到详情页。</li></ul><p>我们把详情页分为4个小的业务模块来开发，分别是：视频详情显示、喜欢和收藏功能、评论功能、推荐功能。下面我们分别对这四个功能模块进行开发讲解。<br>##视频详情显示</p><p>上一讲中，我们已经建立了video模型，所以不必再新建模型，我们就在video模型的基础上进行扩展。</p><p>上一讲，我们创建的字段有</p><pre><code>title       视频标题。数据类型是charField，最大长度为max_length=100，允许为空null=Truedesc        视频描述。数据类型是charField，最大长度为max_length=255，允许为空null=Truefile        视频文件地址。数据类型是fileField。其中存的是视频文件的地址，在之后的视频管理中我们将会对视频的上传进行具体的讲解。cover       视频封面。数据类型是ImageField。存储目录为upload_to=‘cover/’，允许为空null=Truestatus      视频状态。是一个选择状态，用choices设置多选元祖。created_time 创建时间。数据类型是DateTimeField 。设置自动生成时间auto_now_add=True</code></pre><p>这些字段目前是不够用的，我们再加几个字段，需要加<strong>观察次数、喜欢的用户、收藏的用户</strong>。</p><p>video模型扩展后如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Video</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    STATUS_CHOICES <span class="token operator">=</span> <span class="token punctuation">(</span>        <span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'发布中'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'未发布'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    desc <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">,</span>blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    classification <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>Classification<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token builtin">file</span> <span class="token operator">=</span> models<span class="token punctuation">.</span>FileField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>    cover <span class="token operator">=</span> models<span class="token punctuation">.</span>ImageField<span class="token punctuation">(</span>upload_to<span class="token operator">=</span><span class="token string">'cover/'</span><span class="token punctuation">,</span>blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    status <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">,</span>choices<span class="token operator">=</span>STATUS_CHOICES<span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    view_count <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    liked <span class="token operator">=</span> models<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>AUTH_USER_MODEL<span class="token punctuation">,</span>                                   blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> related_name<span class="token operator">=</span><span class="token string">"liked_videos"</span><span class="token punctuation">)</span>    collected <span class="token operator">=</span> models<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>AUTH_USER_MODEL<span class="token punctuation">,</span>                                   blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> related_name<span class="token operator">=</span><span class="token string">"collected_videos"</span><span class="token punctuation">)</span>    created_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>新增了3个字段</p><pre><code>view_count 观看次数。数据类型是IntegerField，默认是0liked 喜欢的用户。数据类型是ManyToManyField，这是一种多对多的关系，                表示一个视频可以被多个用户喜欢，一个用户也可以喜欢多个视频。                记得设置用户表为settings.AUTH_USER_MODELcollected 收藏的用户。数据类型是ManyToManyField，这是一种多对多的关系，                    表示一个视频可以被多个用户收藏，一个用户也可以收藏多个视频。                    设置用户表为settings.AUTH_USER_MODEL更多关于ManyToManyField的使用介绍，可以查询django官网的介绍。</code></pre><p>下面就是详情展示阶段，我们先配置好详情页的路由信息，在video/urls.py中追加detail的路由信息。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">video<span class="token operator">/</span>urls<span class="token punctuation">.</span>pyapp_name <span class="token operator">=</span> <span class="token string">'video'</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>IndexView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'search/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>SearchListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'search'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'detail/&lt;int:pk>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>VideoDetailView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'detail'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>path(&#39;detail/&lt;int:pk&gt;/&#39;, views.VideoDetailView.as_view(), name=&#39;detail&#39;)</code></pre><p>即表示详情信息，注意每条视频都是有自己的主键的，所以设置路径匹配为detail/<a href="int:pk">int:pk</a>/,其中<a href="int:pk">int:pk</a>表示主键，</p><p>这是django中表示主键的一种方法。这样我们就可以在浏览器输入127.0.0.1:8000/video/detail/xxx来访问详情了。</p><p>如何显示详情呢，django为我们提供了DetailView。</p><p>urls.py中设置的视图类是VideoDetailView，我们让VideoDetailView继承DetailView即可。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">VideoDetailView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>DetailView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Video    template_name <span class="token operator">=</span> <span class="token string">'video/detail.html'</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>看起来超级简单，django就是如此的酷，只需要我们配置几行代码，就能实现很强大的功能。</p><p>这里我们配置model为Video模型，模板为video/detail.html，其它的工作都不用管，全都交给django去干</p><p>模板文件位于templates/video/detail.html，它的代码比较简单，这里就不贴了。</p><p>##观看次数<br>观看次数的展示，本质上就是数据库里的一个自增字段，每次观看的时候，view_count自动加1。</p><p>对于这个小需求，我们需要做两件事情，首先这video模型里面，添加一个次数自增函数，命名为increase_view_count，这很简单，如下所示：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">increase_view_count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    self<span class="token punctuation">.</span>view_count <span class="token operator">+=</span> <span class="token number">1</span>    self<span class="token punctuation">.</span>save<span class="token punctuation">(</span>update_fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'view_count'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后，还需要我们在VideoDetailView视图类里面调用到这个函数。这个时候get_object()派上用场了。</p><p>因为每次调用DetailView的时候，django都会回调get_object()这个函数。</p><p>因此我们可以把increase_view_count()放到get_object()里面执行。完美的代码如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">VideoDetailView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>DetailView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Video    template_name <span class="token operator">=</span> <span class="token string">'video/detail.html'</span>    <span class="token keyword">def</span> <span class="token function">get_object</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> queryset<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        obj <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_object<span class="token punctuation">(</span><span class="token punctuation">)</span>        obj<span class="token punctuation">.</span>increase_view_count<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 通过调用Video中的increase_view_count 获取观看次数</span>        <span class="token keyword">return</span> obj<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>##点赞收藏功能<br>目前为止，我们就能在详情页看到标题、描述、观看次数、收藏次数、喜欢次数。</p><p>虽然可以显示收藏人数、喜欢人数。但是目前还没实现点击喜欢/收藏的功能。下面我们来实现。</p><p>收藏和点赞是一组动作，因此可以用ajax来实现：用户点击后调用后端接口，接口返回json数据，前端显示结果。</p><p>既然需要接口，那我们先添加喜欢/收藏接口的路由，在video/urls.py追加代码如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">'like/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>like<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'like'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>path<span class="token punctuation">(</span><span class="token string">'collect/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>collect<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'collect'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>由于两个功能实现非常类似，限于篇幅，这里只说明一下功能。</p><p>我们先写like函数：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@ajax_required</span><span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">like</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>is_authenticated<span class="token punctuation">:</span>        <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"请先登录"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    video_id <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'video_id'</span><span class="token punctuation">]</span>    video <span class="token operator">=</span> Video<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span>video_id<span class="token punctuation">)</span>    user <span class="token operator">=</span> request<span class="token punctuation">.</span>user    video<span class="token punctuation">.</span>switch_like<span class="token punctuation">(</span>user<span class="token punctuation">)</span>    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"likes"</span><span class="token punctuation">:</span> video<span class="token punctuation">.</span>count_likers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"user_liked"</span><span class="token punctuation">:</span> video<span class="token punctuation">.</span>user_liked<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首先判断用户是否登录，如果登录了则调用switch_like(user)来实现喜欢或不喜欢功能，最后返回json。</p><p>注意这里添加了两个注解@ajax_required和@require_http_methods([“POST”])，分别验证request必须是ajax和post请求。<br>这两个装饰器ajax_required是由自己的helper实现的，目的是加载ajax</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">utils<span class="token operator">/</span>video_helpers<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponseBadRequest<span class="token keyword">def</span> <span class="token function">ajax_required</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Not a mixin, but a nice decorator to validate than a request is AJAX"""</span>    <span class="token keyword">def</span> <span class="token function">wrap</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>is_ajax<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> HttpResponseBadRequest<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> f<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>    wrap<span class="token punctuation">.</span>__doc__ <span class="token operator">=</span> f<span class="token punctuation">.</span>__doc__    wrap<span class="token punctuation">.</span>__name__ <span class="token operator">=</span> f<span class="token punctuation">.</span>__name__    <span class="token keyword">return</span> wrap<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>require_http_methods方法则是自带的，要求请求的方式是POST.</p><p>switch_like()函数则写在了video/model.py里面</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 用户已经点击过喜欢了，就移除，没点击就添加</span><span class="token keyword">def</span> <span class="token function">switch_like</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> user <span class="token keyword">in</span> self<span class="token punctuation">.</span>liked<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>liked<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>user<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>liked<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token comment"># 统计喜欢人数</span><span class="token keyword">def</span> <span class="token function">count_likers</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> self<span class="token punctuation">.</span>liked<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 判断用户是否喜欢</span><span class="token keyword">def</span> <span class="token function">user_liked</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> user <span class="token keyword">in</span> self<span class="token punctuation">.</span>liked<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所有的后端工作都准备好了，我们再把视线转向前端。前端主要是写ajax代码。</p><p>由于ajax代码量较大，我们封装到一个单独的js文件中 ==&gt; static/js/detail.js</p><p>在detail.js中，我们先实现点赞的ajax调用：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">static</span><span class="token operator">/</span>js<span class="token operator">/</span>detail<span class="token punctuation">.</span>js<span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 写入csrf</span>    $<span class="token punctuation">.</span><span class="token function">getScript</span><span class="token punctuation">(</span><span class="token string">"/static/js/csrftoken.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 喜欢</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#like"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">var</span> video_id <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#like"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"video-id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            url<span class="token operator">:</span> <span class="token string">'/video/like/'</span><span class="token punctuation">,</span>            data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>                video_id<span class="token operator">:</span> video_id<span class="token punctuation">,</span>                <span class="token string">'csrf_token'</span><span class="token operator">:</span> csrftoken            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            type<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>            dataType<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">var</span> code <span class="token operator">=</span> data<span class="token punctuation">.</span>code                <span class="token keyword">if</span><span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">var</span> likes <span class="token operator">=</span> data<span class="token punctuation">.</span>likes                    <span class="token keyword">var</span> user_liked <span class="token operator">=</span> data<span class="token punctuation">.</span>user_liked                    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#like-count'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>likes<span class="token punctuation">)</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>user_liked <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#like'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">"grey"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">"red"</span><span class="token punctuation">)</span>                    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#like'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">"red"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">"grey"</span><span class="token punctuation">)</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">var</span> msg <span class="token operator">=</span> data<span class="token punctuation">.</span>msg                    <span class="token function">alert</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>              <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"点赞失败"</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上述代码中，关键代码是$.ajax()函数，我们传入了参数：video_id和csrftoken。</p><p>其中csrftoken可通过/static/js/csrftoken.js生成。</p><p>在success回调中，通过判断user_liked的值来确定自己是否喜欢过，然后改变模板中相应的css。</p><p>##推荐功能</p><p>每个网站都有自己的推荐功能，且都有自己的推荐逻辑。这里的推荐逻辑是根据访问次数最高的n个视频来降序排序，然后推荐给用户的。</p><p>实现起来非常容易，我们知道详情页实现用的是VideoDetailView，我们可以在get_context_data()中把推荐内容传递给前端模板。</p><p>只需要我们改写VideoDetailView的get_context_date()函数。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>    context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>VideoDetailView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>    recommend_list <span class="token operator">=</span> Video<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_recommend_list<span class="token punctuation">(</span><span class="token punctuation">)</span>    context<span class="token punctuation">[</span><span class="token string">'recommend_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> recommend_list    <span class="token keyword">return</span> context<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>改写后，我们添加了一行</p><pre><code>recommend_list = Video.objects.get_recommend_list()</code></pre><p>我们把获取推荐列表的函数get_recommend_list()封装到了Video模型里面。<br>在Video/models.py里面,我们追加代码:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">VideoQuerySet</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>query<span class="token punctuation">.</span>QuerySet<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">get_recommend_list</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-view_count'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>关键是self.filter(status=0).order_by(‘-view_count’)[:4]，通过order_by把view_count降序排序，并选取前4条数据。</p><p>注意此处我们用了VideoQuerySet查询器，需要我们在Video下面添加一行依赖。表示用VideoQuerySet作为Video的查询管理器。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">objects <span class="token operator">=</span> VideoQuerySet<span class="token punctuation">.</span>as_manager<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>当模板拿到数据后，即可渲染显示。这里我们将推荐侧栏的代码封装到templates/video/recommend.html里面。</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"># templates/video/recommend.html&#123;% load thumbnail %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video-side-title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>推荐列表<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui unstackable divided items<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    &#123;% for item in recommend_list %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui tiny image<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            &#123;% thumbnail item.cover "300x200" crop="center" as im %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui image<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; im.url &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            &#123;% empty %&#125;            &#123;% endthumbnail %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>middle aligned content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span> header-title<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>video:detail<span class="token punctuation">'</span> item.pk %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; item.title &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>meta<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; item.view_count &#125;&#125;次观看<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    &#123;% empty %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>暂无推荐<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>    &#123;% endfor %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>并在detail.html中将它包含进来</p><pre><code>&#123;% include "video/recommend.html" %&#125;</code></pre><p>##评论功能</p><p>评论区位于详情页下侧，显示效果如下。共分为两个部分：评论form和评论列表。</p><p>评论功能是一个独立的模块，该功能通用性较高，在其他很多网站中都有评论功能，</p><p>为了避免以后开发其他网站时重复造轮子，我们建立一个新的应用，命名为comment</p><pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell">python3 manage.py startapp comment<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>接下来，我们创建comment模型</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 位于comment/models.py</span><span class="token keyword">class</span> <span class="token class-name">Comment</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>AUTH_USER_MODEL<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span>    nickname <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    avatar <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    video <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>Video<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span>    content <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>    timestamp <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>     <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        db_table <span class="token operator">=</span> <span class="token string">"v_comment"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>user 用户。数据类型是ForeignKey，外键是settings.AUTH_USER_MODEL，并设置为级联删除on_delete=models.CASCADEnickname 用户昵称。数据类型是CharField。avatar 头像。数据类型是CharField。video 对应的视频。数据类型是ForeignKey，对应Video模型，级联删除 on_delete=models.CASCADEcontent 评论内容。 数据类型是CharField。timestamp 评论时间。 数据类型是DateTimeField。</code></pre><p>有了模型之后，我们就可以专心写业务代码了，首先在comment下建立路由文件urls.py。并写入代码:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> viewsapp_name <span class="token operator">=</span> <span class="token string">'comment'</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'submit_comment/&lt;int:pk>'</span><span class="token punctuation">,</span>views<span class="token punctuation">.</span>submit_comment<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'submit_comment'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'get_comments/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>get_comments<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'get_comments'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们配置了两条路由信息：评论提交 和 获取评论。</p><p>提交评论，需要一个form，我们把form放到video/forms.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django <span class="token keyword">import</span> forms<span class="token keyword">from</span> comment<span class="token punctuation">.</span>models <span class="token keyword">import</span> Comment<span class="token keyword">class</span> <span class="token class-name">CommentForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    content <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'不能为空'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>Textarea<span class="token punctuation">(</span>attrs <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入评论内容'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> Comment        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在video/views.py的VideoDetailView下添加form的相关代码。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">VideoDetailView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>DetailView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Video    template_name <span class="token operator">=</span> <span class="token string">'video/detail.html'</span>    <span class="token keyword">def</span> <span class="token function">get_object</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> queryset<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        obj <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_object<span class="token punctuation">(</span><span class="token punctuation">)</span>        obj<span class="token punctuation">.</span>increase_view_count<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> obj    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>VideoDetailView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        form <span class="token operator">=</span> CommentForm<span class="token punctuation">(</span><span class="token punctuation">)</span>         context<span class="token punctuation">[</span><span class="token string">'form'</span><span class="token punctuation">]</span> <span class="token operator">=</span> form         <span class="token keyword">return</span> context<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在get_context_data()函数里面，我们把form传递给模板。</p><p>同样的，提交评论也是异步的，我们用ajax实现，我们打开static/js/detail.js，写入</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 提交评论</span><span class="token keyword">var</span> frm <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#comment_form'</span><span class="token punctuation">)</span>frm<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        type<span class="token operator">:</span> frm<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'method'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        url<span class="token operator">:</span> frm<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'action'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        dataType<span class="token operator">:</span><span class="token string">'json'</span><span class="token punctuation">,</span>        data<span class="token operator">:</span> frm<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">var</span> code <span class="token operator">=</span> data<span class="token punctuation">.</span>code            <span class="token keyword">var</span> msg <span class="token operator">=</span> data<span class="token punctuation">.</span>msg            <span class="token keyword">if</span><span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#id_content'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.comment-list'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#comment-result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">"评论成功"</span><span class="token punctuation">)</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.info'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fadeOut</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#comment-result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.info'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fadeOut</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>评论通过ajax提交后，我们在submit_comment()中就能接收到这个请求。处理如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">submit_comment</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>pk<span class="token punctuation">)</span><span class="token punctuation">:</span>    video <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>Video<span class="token punctuation">,</span> pk <span class="token operator">=</span> pk<span class="token punctuation">)</span>    form <span class="token operator">=</span> CommentForm<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>    <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        new_comment <span class="token operator">=</span> form<span class="token punctuation">.</span>save<span class="token punctuation">(</span>commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>        new_comment<span class="token punctuation">.</span>user <span class="token operator">=</span> request<span class="token punctuation">.</span>user        new_comment<span class="token punctuation">.</span>nickname <span class="token operator">=</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>nickname        new_comment<span class="token punctuation">.</span>avatar <span class="token operator">=</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>avatar        new_comment<span class="token punctuation">.</span>video <span class="token operator">=</span> video        new_comment<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        data <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        data<span class="token punctuation">[</span><span class="token string">'nickname'</span><span class="token punctuation">]</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>nickname        data<span class="token punctuation">[</span><span class="token string">'avatar'</span><span class="token punctuation">]</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>avatar        data<span class="token punctuation">[</span><span class="token string">'timestamp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        data<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_comment<span class="token punctuation">.</span>content        comments <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        comments<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">)</span>        html <span class="token operator">=</span> render_to_string<span class="token punctuation">(</span>            <span class="token string">"comment/comment_single.html"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"comments"</span><span class="token punctuation">:</span> comments<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"html"</span><span class="token punctuation">:</span> html<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'msg'</span><span class="token punctuation">:</span><span class="token string">'评论失败!'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在接收函数中，通过form自带的验证函数来保存记录，然后将这条记录返回到前端模板。</p><p>下面我们开始评论列表的开发。</p><p>评论列表部分，我们使用了的是上拉动态加载的方案，即当页面拉到最下侧时，js加载代码会自动的获取下一页的数据并显示出来。</p><p>前端部分，我们使用了一种基于js的开源加载插件。基于这个插件，可以很容易实现网页的上拉动态加载效果。</p><p>它使用超级简单，仅需要调用$(’.comments’).dropload({})即可。我们把调用的代码封装在static/js/load_comments.js里面。</p><p>完整的调用代码如下：</p><pre class="line-numbers language-none"><code class="language-none">$(function()&#123;    &#x2F;&#x2F; 页数    var page &#x3D; 0;    &#x2F;&#x2F; 每页展示15个    var page_size &#x3D; 15;    &#x2F;&#x2F; dropload    $(&#39;.comments&#39;).dropload(&#123;        scrollArea : window,        loadDownFn : function(me)&#123;            page++;            $.ajax(&#123;                type: &#39;GET&#39;,                url: comments_url,                data:&#123;                     video_id: video_id,                     page: page,                     page_size: page_size                &#125;,                dataType: &#39;json&#39;,                success: function(data)&#123;                    var code &#x3D; data.code                    var count &#x3D; data.comment_count                    if(code &#x3D;&#x3D; 0)&#123;                        $(&#39;#id_comment_label&#39;).text(count + &quot;条评论&quot;);                        $(&#39;.comment-list&#39;).append(data.html);                        me.resetload();                    &#125;else&#123;                        me.lock();                        me.noData();                        me.resetload();                    &#125;                &#125;,                error: function(xhr, type)&#123;                    me.resetload();                &#125;            &#125;);        &#125;    &#125;);&#125;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>不用过多的解释，这段代码已经非常非常清晰了，本质还是ajax的接口请求调用，调用后返回结果更新前端网页内容。</p><p>我们看到ajax调用的接口是get_comments，我们继续来实现它，它位于comment/views.py中。<br>代码如下所示，当获取到page和page_size后，使用paginator对象来实现分页。最后通过render_to_string将html传递给模板。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>view<span class="token punctuation">.</span>py<span class="token keyword">def</span> <span class="token function">get_comments</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>is_ajax<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> HttpResponseBadRequest<span class="token punctuation">(</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page'</span><span class="token punctuation">)</span>    page_size <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page_size'</span><span class="token punctuation">)</span>    video_id <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'video_id'</span><span class="token punctuation">)</span>    video <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>Video<span class="token punctuation">,</span> pk<span class="token operator">=</span>video_id<span class="token punctuation">)</span>    comments <span class="token operator">=</span> video<span class="token punctuation">.</span>comment_set<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-timestamp'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    comment_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>comments<span class="token punctuation">)</span>    paginator <span class="token operator">=</span> Paginator<span class="token punctuation">(</span>comments<span class="token punctuation">,</span> page_size<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        rows <span class="token operator">=</span> paginator<span class="token punctuation">.</span>page<span class="token punctuation">(</span>page<span class="token punctuation">)</span>    <span class="token keyword">except</span> PageNotAnInteger<span class="token punctuation">:</span>        rows <span class="token operator">=</span> paginator<span class="token punctuation">.</span>page<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> EmptyPage<span class="token punctuation">:</span>        rows <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>        code <span class="token operator">=</span> <span class="token number">0</span>        html <span class="token operator">=</span> render_to_string<span class="token punctuation">(</span>            <span class="token string">"comment/comment_single.html"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"comments"</span><span class="token punctuation">:</span> rows<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        code <span class="token operator">=</span> <span class="token number">1</span>        html <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token string">"code"</span><span class="token punctuation">:</span>code<span class="token punctuation">,</span>        <span class="token string">"html"</span><span class="token punctuation">:</span> html<span class="token punctuation">,</span>        <span class="token string">"comment_count"</span><span class="token punctuation">:</span> comment_count    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>##列表页面跳转<br>在首页里面已经加载了视频内容，现在还没有点击挑战到详情页，现在加上</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui card<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>video:detail<span class="token punctuation">'</span> item.pk %&#125;<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>               &#123;% thumbnail item.cover "300x200" crp="center" as im %&#125;               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui image<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; im.url &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>               &#123;% empty %&#125;               &#123;% endthumbnail %&#125;               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>large play icon v-play-icon<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>header<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>video:detail<span class="token punctuation">'</span> item.pk %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; item.title &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>meta<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>date<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>发布于&#123;&#123; item.created_time|time_since&#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                   &#123;&#123; item.view_count&#125;&#125;次观看               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>和recommend页面一样，通过 video:detail 方法组合调用detail方法，访问到详情页面</p>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step06个人中心功能</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step06-ge-ren-zhong-xin-gong-neng/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step06-ge-ren-zhong-xin-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>#个人中心功能<br>从本讲起，我们开始个人中心功能的开发。个人中心里面包括以下几个部分</p><ul><li>个人资料</li><li>修改密码</li><li>订阅设置</li><li>意见反馈</li></ul><p>通过这部分的开发，我们将会接触到更多django的用法。</p><p>##整体功能</p><p>个人中心模块是对用户的信息进行展示并可以编辑。</p><p>其中个人资料、修改密码、订阅设置是对用户信息的编辑，反馈建议是属于创建新数据。<br>##个人资料</p><p>这里主要是对个人资料进行编辑，先显示用户原有的信息，</p><p>然后用户即可对其进行修改并保存，对于编辑功能，django有自己的解决方案，</p><p>即通过通用视图类UpdateView对模型进行更改。关于Update的介绍，同学们可查阅官网介绍</p><p>因为前面已经建立过user模型，所以这里就不用再次建立了，我们直接使用之前的user模型即可。<br>###建立form<br>首先需要新建一张form来存放个人信息，它和userprofile中的User model差不多，但这里时一个form</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#userprofile/forms.py</span><span class="token keyword">from</span> django <span class="token keyword">import</span> forms<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token comment"># 头像大小，这里只是限制图片大小，后面可以直接修改其大小</span><span class="token keyword">def</span> <span class="token function">avatar_file_size</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>    limit <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>    <span class="token keyword">if</span> value<span class="token punctuation">.</span>size <span class="token operator">></span> limit<span class="token punctuation">:</span>        <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">'头像文件太大了，请限制在2M之内'</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">ProfileForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    nickname <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>                               max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>                               required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>                               error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                   <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'昵称至少4个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'昵称不能多于20个字符'</span><span class="token punctuation">,</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                               widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    avatar <span class="token operator">=</span> forms<span class="token punctuation">.</span>ImageField<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token punctuation">[</span>avatar_file_size<span class="token punctuation">]</span><span class="token punctuation">,</span>                              widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>FileInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'n'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    email <span class="token operator">=</span> forms<span class="token punctuation">.</span>EmailField<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>                             error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                 <span class="token string">'invalid'</span><span class="token punctuation">:</span> <span class="token string">'请输入有效的Email地址'</span><span class="token punctuation">,</span>                             <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                             widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>EmailInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    gender <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>max_length<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>                             widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>HiddenInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    mobile <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>max_length<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>                             error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                 <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'请输入11位手机号'</span><span class="token punctuation">,</span>                                 <span class="token string">'max_length'</span><span class="token punctuation">:</span> <span class="token string">'请输入11位手机号'</span><span class="token punctuation">,</span>                             <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                             widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>NumberInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> User        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'nickname'</span><span class="token punctuation">,</span> <span class="token string">'avatar'</span><span class="token punctuation">,</span> <span class="token string">'email'</span><span class="token punctuation">,</span> <span class="token string">'gender'</span><span class="token punctuation">,</span> <span class="token string">'mobile'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里对头像图片做了一个限制,主要时限制其尺寸，目前先这样限制，后面有时间会把这里修改一下，直接把上传的图片进行缩放或者放大，弄成统一尺寸</p><p>其他各个字段也有对应的限制规则</p><p>##更新路由表</p><p>其次我们做的就是在users/urls.py中添加个人资料的路由，</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># users/urls.py</span>path<span class="token punctuation">(</span><span class="token string">'profile/&lt;int:pk>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>ProfileView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'profile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>可以看到，这里我们需要传一个int参数做为主键，并传递给视图类ProfileView。<br>###更新视图<br>下面我们转向ProfileView，它的写法超级简单</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> LoginRequiredMixin<span class="token keyword">from</span> utils<span class="token punctuation">.</span>video_helpers <span class="token keyword">import</span> AuthorRequiredMixin<span class="token keyword">from</span> django<span class="token punctuation">.</span>views <span class="token keyword">import</span> generic<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> messages<span class="token keyword">class</span> <span class="token class-name">ProfileView</span><span class="token punctuation">(</span>LoginRequiredMixin<span class="token punctuation">,</span>AuthorRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>UpdateView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> User    form_class <span class="token operator">=</span> ProfileForm    template_name <span class="token operator">=</span> <span class="token string">'users/profile.html'</span>    <span class="token keyword">def</span> <span class="token function">get_success_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        messages<span class="token punctuation">.</span>success<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">"保存成功"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> reverse<span class="token punctuation">(</span><span class="token string">'userprofile:profile'</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'pk'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>pk<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里继承了UpdateView来实现更新操作，和DetailView类似，我们这里也设置了model和template_name 还有form_class。</p><p>当更新成功后，django会回调get_success_url来将结果告诉模板，因此我们可以在get_success_url里面做一些定制的工作，我们可以传一些自己的参数。</p><p>简单的几行代码，就实现了个人资料的更新，再次彰显了django框架的强大。</p><p>可以看到我们还继承了LoginRequiredMixin和AuthorRequiredMixin两个类，这两个类属于公共类，</p><p>其中LoginRequiredMixin的用途是：只允许登录的用户访问该视图类，</p><p>AuthorRequiredMixin的用途是：只允许用户自己查看自己的个人资料，别人是无法查看的。</p><p>其中AuthorRequiredMixin的代码位于videoproject/utils/helpers.py。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> PermissionDenied<span class="token comment"># 只允许用户自己查看自己的个人资料，别人是无法查看的</span><span class="token keyword">class</span> <span class="token class-name">AuthorRequiredMixin</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        obj <span class="token operator">=</span> self<span class="token punctuation">.</span>get_object<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> obj <span class="token operator">!=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">:</span>            <span class="token keyword">raise</span> PermissionDenied        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dispatch<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>前端代码最后统一再讲</p><p>##修改密码</p><p>同样的，修改密码也是属于更新操作。</p><p>模型当然是用user模型，不必再建。<br>###更新路由<br>我们先添加路由</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">'change_password/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>change_password<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'change_password'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>###添加form<br>新增一个改密码的表单</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># userprofile/forms.py</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>forms <span class="token keyword">import</span> PasswordChangeForm<span class="token comment"># 改密码</span><span class="token keyword">class</span> <span class="token class-name">ChangePwdForm</span><span class="token punctuation">(</span>PasswordChangeForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    old_password <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'不能为空'</span><span class="token punctuation">,</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                                   widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>PasswordInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入旧密码'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    new_password1 <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'不能为空'</span><span class="token punctuation">,</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                                    widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>PasswordInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入新密码'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    new_password2 <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'不能为空'</span><span class="token punctuation">,</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                                    widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>PasswordInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入确认密码'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>###添加视图函数<br>修改密码比较特殊，需要对密码进行特殊处理，因此我们通过视图函数change_password来手写代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># userprofile/views.py</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth <span class="token keyword">import</span> update_session_auth_hash<span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> ChangePwdForm<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> messages<span class="token comment"># 修改密码</span><span class="token keyword">def</span> <span class="token function">change_password</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        form <span class="token operator">=</span> ChangePwdForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>user<span class="token punctuation">,</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            user <span class="token operator">=</span> form<span class="token punctuation">.</span>save<span class="token punctuation">(</span>commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">.</span>is_staff <span class="token keyword">and</span> <span class="token keyword">not</span> user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>                user<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>                update_session_auth_hash<span class="token punctuation">(</span>request<span class="token punctuation">,</span> user<span class="token punctuation">)</span>  <span class="token comment"># 更新session 非常重要！</span>                messages<span class="token punctuation">.</span>success<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'修改成功'</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'userprofile:change_password'</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                messages<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'无权修改管理员密码'</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'userprofile:change_password'</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>form<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        form <span class="token operator">=</span> ChangePwdForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span>    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span>                  <span class="token string">'registration/change_password.html'</span><span class="token punctuation">,</span>                  <span class="token punctuation">&#123;</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当拿到form之后，通过验证form合法性，然后调用user.save()来保存修改。<br>然后通过update_session_auth_hash来更新session, 密码更改之后一定要更新会话。</p><p>这样就实现了修改密码功能。</p><p>##订阅设置</p><p>很多网站都有订阅设置功能，当用户订阅了网站内容之后，网站有了新内容，向订阅用户推送相关内容。<br>###添加表单<br>订阅功能也需要添加表单</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># userprofile/forms.py</span><span class="token keyword">class</span> <span class="token class-name">SubscribeForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> User        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'subscribe'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>###路由设置<br>我们先在users/urls.py下添加订阅功能的路由</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">'subscribe/&lt;int:pk>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>SubscribeView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'subscribe'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们设置的订阅视图类为SubscribeView，因为订阅的功能和修改个人资料功能类似，也是属于更新操作，所以同样是使用UpdateView来更新。<br>###添加视图</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># userprofile/views.py</span><span class="token keyword">class</span> <span class="token class-name">SubscribeView</span><span class="token punctuation">(</span>LoginRequiredMixin<span class="token punctuation">,</span>AuthorRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>UpdateView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> User    form_class <span class="token operator">=</span> SubscribeForm    template_name <span class="token operator">=</span> <span class="token string">'users/subscribe.html'</span>    <span class="token keyword">def</span> <span class="token function">get_success_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        messages<span class="token punctuation">.</span>success<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">"保存成功"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> reverse<span class="token punctuation">(</span><span class="token string">'userprofile:subscribe'</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'pk'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>pk<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>订阅功能实现和Profile的实现有点类似<br>##反馈与建议<br>###添加model<br>这里我们需要在users/models.py下新建一个反馈表，命名为Feedback，</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Feedback</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    contact <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>    content <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>    timestamp <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        db_table <span class="token operator">=</span> <span class="token string">"v_feedback"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>该表一共有3个字段，分别是</p><pre><code>contact 联系方式content 内容timestamp 时间</code></pre><p>###添加表单<br>写完model之后，还需要添加表单类</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># userprofile/forms.py</span><span class="token keyword">class</span> <span class="token class-name">FeedbackForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    content <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>                              max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>                              error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                   <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'至少4个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'max_length'</span><span class="token punctuation">:</span> <span class="token string">'不能多于200个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'内容不能为空'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                              widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>Textarea<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入内容'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    contact <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>                              widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入联系方式'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> Feedback        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">,</span> <span class="token string">'contact'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>写完model之后，我们就能写业务代码了。<br>###设置路由<br>先添加路由</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">'feedback/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>FeedbackView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'feedback'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们设置路由指向FeedbackView视图类。<br>###视图业务<br>我们直接贴出FeedbackView的代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># userprofile/views.py</span><span class="token keyword">from</span> ratelimit<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> ratelimit<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> LoginRequiredMixin<span class="token keyword">from</span> django<span class="token punctuation">.</span>views <span class="token keyword">import</span> generic<span class="token keyword">class</span> <span class="token class-name">FeedbackView</span><span class="token punctuation">(</span>LoginRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>CreateView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Feedback    form_class <span class="token operator">=</span> FeedbackForm    template_name <span class="token operator">=</span> <span class="token string">'users/feedback.html'</span>    <span class="token decorator annotation punctuation">@ratelimit</span><span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token string">'ip'</span><span class="token punctuation">,</span> rate<span class="token operator">=</span><span class="token string">'2/m'</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        was_limited <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'limited'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> was_limited<span class="token punctuation">:</span>            messages<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">"操作太频繁了，请1分钟后再试"</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'userprofile/feedback.html'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'form'</span><span class="token punctuation">:</span> FeedbackForm<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>post<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">get_success_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        messages<span class="token punctuation">.</span>success<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">"提交成功"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> reverse<span class="token punctuation">(</span><span class="token string">'userprofile:feedback'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们看到这个地方继承的是CreateView类，该类属于新建通用视图类。只要我们配置好model、form_class、template_name，django就自动为我们创建记录。</p><p>另外，我们还使用了一种限流量的技术：ratelimit。这是一个第三方类库，通过使用他，可以防止恶意提交数据。它使用超级简单，只需要配置好key和rate即可，key代表业务，rate代表速率，这里我们设置key为ip，即限制ip地址，rate为’2/m’，表示每分钟限制请求2次。超过2次就提示用户操作频繁。</p><p>这样我们就完美的实现了用户反馈。</p><p>##前端业务<br>前端主要修改或添加这些内容</p><pre class="line-numbers language-none"><code class="language-none">── base│   ├── base.html│   ├── header.html│   ├── left_nav.html│   ├── menu.html│   └── page_nav.html├── registration|   └── change_password.html└── ── users    ├── feedback.html    ├── profile.html    └── subscribe.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从base里面就有加载header,header 加载menu,而menu页面就是加载个人信息的页面</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&#123;% if user.is_authenticated %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui inline dropdown<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>v-header-avatar<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span>inline-block<span class="token punctuation">;</span><span class="token property">font-weight</span><span class="token punctuation">:</span>bold<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>        &#123;% thumbnail user.avatar "200x200" crop="center" as im %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui avatar image<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; im.url &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        &#123;% empty %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui avatar image<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>img/img_default_avatar.png<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        &#123;% endthumbnail %&#125;        &#123;&#123; user.username &#125;&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown icon<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>menu<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript">window<span class="token punctuation">.</span>location<span class="token operator">=</span><span class="token string">'&#123;% url '</span>userprofile<span class="token operator">:</span>profile<span class="token string">' user.pk %&#125;'</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user icon<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>个人资料<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript">window<span class="token punctuation">.</span>location<span class="token operator">=</span><span class="token string">'&#123;% url '</span>userprofile<span class="token operator">:</span>profile<span class="token string">' user.pk %&#125;'</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bookmark icon<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>我的收藏<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript">window<span class="token punctuation">.</span>location<span class="token operator">=</span><span class="token string">'&#123;% url '</span>userprofile<span class="token operator">:</span>profile<span class="token string">' user.pk %&#125;'</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>heart icon<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>我的喜欢<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript">window<span class="token punctuation">.</span>location<span class="token operator">=</span><span class="token string">'&#123;% url '</span>userprofile<span class="token operator">:</span>logout<span class="token string">' %&#125;'</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sign-out icon<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>退出<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% else %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui tiny secondary basic button<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>v-header-login<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>userprofile:login<span class="token punctuation">'</span> %&#125;?next=&#123;&#123; request.path &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>&#123;% endif %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果用户登录的话，就能看到用户头像，点击显示下拉菜单，里面有个人资料，(我的收藏，我的喜欢, 这两个功能后面实现) 退出功能<br>用户没登录的话，就显示登录2字<br>点击个人资料能跳转到新的页面</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&#123;% extends 'base/base.html' %&#125;&#123;% load static %&#125;&#123;% load thumbnail %&#125;&#123;% block content %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>v-settings<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui two column grid <span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>four wide column<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            &#123;% include "base/left_nav.html" %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>twelve wide column<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>v-settings-content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui form<span class="token punctuation">"</span></span> <span class="token attr-name">novalidate</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>userprofile:profile<span class="token punctuation">'</span> form.instance.pk %&#125;<span class="token punctuation">"</span></span>                      <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    &#123;% csrf_token %&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sixteen wide inline field v-form-field<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>头像<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>v-inline-middle<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id_avatar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                                &#123;% thumbnail user.avatar "200x200" crop="center" as im %&#125;                                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui mini circular image<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; im.url &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                                &#123;% empty %&#125;                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui mini circular  image<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>img/img_default_avatar.png<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                                &#123;% endthumbnail %&#125;                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                            &#123;&#123;form.avatar&#125;&#125;                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file_is_choose<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>n<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>文件已选择<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sixteen wide inline field v-form-field<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>昵称<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                        &#123;&#123;form.nickname&#125;&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sixteen wide inline field v-form-field<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>Email<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                        &#123;&#123;form.email&#125;&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sixteen wide inline field v-form-field<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>手机号<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                        &#123;&#123;form.mobile&#125;&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sixteen wide inline field v-form-field<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>性别<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui selection  dropdown<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                            &#123;&#123;form.gender&#125;&#125;                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown icon<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>default text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>请选择<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>menu<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">data-value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>M<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>男<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">data-value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>F<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>女<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui primary button<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>保存<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>                    &#123;% include "base/form_errors.html" %&#125;                    &#123;% include "base/form_messages.html" %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;&#123;% block script %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.ui .dropdown'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dropdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#id_avatar"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#file_is_choose"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>js/left_nav.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>&#123;% endblock script %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个页面有几点注意</p><ul><li>1.继承base页面</li><li>2.包含 <code>&#123;% include "base/left_nav.html" %&#125;</code>，即把菜单单独拿出来，点击跳转,<br>  通过最下面的<code>&lt;script src=&quot;&#123;% static 'js/left_nav.js' %&#125;&quot;&gt;&lt;/script&gt;</code>加载新的页面</li><li>3.性别选择这里通过调用下来菜单选择，下拉菜单的调用是通过js实现的</li></ul><p>然后其他几个页面类似<br>##其他<br>订阅设置可能需要设置邮箱，这里就没设置，后面再完善</p>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django综合篇之添加xadmin功能</title>
      <link href="/post/django-quan-wang-zhan-da-jian/django-zong-he-pian-zhi-tian-jia-xadmin-gong-neng/"/>
      <url>/post/django-quan-wang-zhan-da-jian/django-zong-he-pian-zhi-tian-jia-xadmin-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>#添加xadmin功能</p><p>django2.0,以及django3.0直接使用xadmin功能已经不太友好了<br>如果直接使用pip的方式安装 django-xadmin会遇到很多错误的坑<br>这里使用一个新的方式添加xadmin功能<br>##下载文件<br>在这里<a href="https://gitee.com/voldemort/xadmin-django3/tree/master">https://gitee.com/voldemort/xadmin-django3/tree/master</a> 我们需要的xadmin内容</p><p>下载之后只使用xadmin这个文件夹<br>将整个文件夹复制 然后在自己的项目文件夹下新建文件夹 extra_apps,然后xadmin粘贴过来</p><p>同时需要安装</p><pre><code>django-crispy-forms==1.8.1django-import-export==2.0.2django-reversion==3.0.7django-formtools==2.2.0future==0.18.2httplib2==0.9.2six==1.14.0</code></pre><p>上面标注的版本,最好是大于等于其版本<br>DjangoUEditor是根据老的xadmin新添加的功能</p><pre class="line-numbers language-none"><code class="language-none">##添加到项目中settings.py下新增&#96;&#96;&#96;pythonimport syssys.path.insert(0,os.path.join(BASE_DIR,&#39;extra_apps&#39;))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样我们的项目就可以访问到xadmin了</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">'django.contrib.admin'</span><span class="token punctuation">,</span><span class="token comment">#管理网站</span>    <span class="token string">'django.contrib.auth'</span><span class="token punctuation">,</span><span class="token comment">#认证模块</span>    <span class="token string">'django.contrib.contenttypes'</span><span class="token punctuation">,</span><span class="token comment">#内部框架</span>    <span class="token string">'django.contrib.sessions'</span><span class="token punctuation">,</span><span class="token comment">#会话管理</span>    <span class="token string">'django.contrib.messages'</span><span class="token punctuation">,</span><span class="token comment">#消息框架</span>    <span class="token string">'django.contrib.staticfiles'</span><span class="token punctuation">,</span><span class="token comment">#映射的静态资源</span>    <span class="token string">'xadmin'</span><span class="token punctuation">,</span>                   <span class="token comment"># xadmin　　相关</span>    <span class="token string">'crispy_forms'</span><span class="token punctuation">,</span>             <span class="token comment"># xadmin　　相关</span>    <span class="token string">'DjangoUeditor'</span><span class="token punctuation">,</span>            <span class="token comment"># xadmin　　内的富文本编辑器</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将xadmin添加到项目中,毕竟他也是一个新的app,同时添加的还有crispy_forms</p><p>##添加路由<br>urls.py中新增路由</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> include<span class="token keyword">import</span> xadmin    <span class="token comment"># 富文本相关url</span>    path<span class="token punctuation">(</span><span class="token string">'xadmin/'</span><span class="token punctuation">,</span> xadmin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>                      <span class="token comment"># xadmin相关</span>    path<span class="token punctuation">(</span><span class="token string">'ueditor/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'DjangoUeditor.urls'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment"># 富文本编辑器</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>##将自己的app注册到xadmin<br>在admin.py同级目录下建立adminx.py,配置格式如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> xadmin<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># Register your models here.</span><span class="token keyword">import</span> xadmin<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> xadmin <span class="token keyword">import</span> views<span class="token comment"># 此类可以定义admin后台显示的字段，比如文章列表显示标题，创建时间，</span><span class="token keyword">class</span> <span class="token class-name">BlogAdmin</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""博客文章"""</span>    <span class="token comment"># 展示的字段</span>    list_display <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'excerpt'</span><span class="token punctuation">,</span> <span class="token string">'read_num'</span><span class="token punctuation">,</span> <span class="token string">'appreciate'</span><span class="token punctuation">,</span>                    <span class="token string">'created_time'</span><span class="token punctuation">,</span> <span class="token string">'tags'</span><span class="token punctuation">,</span> <span class="token string">'category'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">]</span>    <span class="token comment"># 按文章名进行搜索</span>    search_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span>    <span class="token comment"># 筛选</span>    list_filter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'created_time'</span><span class="token punctuation">,</span> <span class="token string">'category'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">]</span>    <span class="token comment"># 修改图标</span>    model_icon <span class="token operator">=</span> <span class="token string">'fa fa-file-text'</span>    <span class="token comment"># 修改默认排序</span>    ordering <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'-id'</span><span class="token punctuation">]</span>    <span class="token comment"># 设置只读字段</span>    readonly_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'read_num'</span><span class="token punctuation">]</span>    <span class="token comment"># 不显示某一字段</span>    exclude <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span>    list_display_link <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span>    style_fields <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'ueditor'</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">CategoryAdmin</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""分类"""</span>    list_display <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'created_time'</span><span class="token punctuation">]</span>    search_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span>    model_icon <span class="token operator">=</span> <span class="token string">'fa fa-file-text'</span><span class="token keyword">class</span> <span class="token class-name">TagAdmin</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""标签"""</span>    list_display <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">]</span>    search_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span>    model_icon <span class="token operator">=</span> <span class="token string">'fa fa-file-text'</span>xadmin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Blog<span class="token punctuation">,</span> BlogAdmin<span class="token punctuation">)</span>xadmin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Category<span class="token punctuation">,</span> CategoryAdmin<span class="token punctuation">)</span>xadmin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Tag<span class="token punctuation">,</span> TagAdmin<span class="token punctuation">)</span><span class="token comment"># 修改xadmin的基础配置</span><span class="token keyword">class</span> <span class="token class-name">BaseSetting</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 允许使用主题</span>    enable_themes <span class="token operator">=</span> <span class="token boolean">True</span>            <span class="token comment"># 开启自定义主题</span>    use_bootswatch <span class="token operator">=</span> <span class="token boolean">True</span><span class="token comment"># 修改xadmin的全局配置</span><span class="token keyword">class</span> <span class="token class-name">GlobalSetting</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    site_title <span class="token operator">=</span> <span class="token string">'自己的全站'</span>    site_footer <span class="token operator">=</span> <span class="token string">'2020中自己建立的全站'</span>    <span class="token comment"># Models收起功能</span>    menu_style <span class="token operator">=</span> <span class="token string">'accordion'</span>xadmin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>views<span class="token punctuation">.</span>CommAdminView<span class="token punctuation">,</span> GlobalSetting<span class="token punctuation">)</span>xadmin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>views<span class="token punctuation">.</span>BaseAdminView<span class="token punctuation">,</span> BaseSetting<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>##更新数据库<br>建立与xadmin相关的表,并将表添加到数据库</p><pre><code>python manage.py makemigrationspython manage.py migrate</code></pre><p>##更换xadmin的logo<br>base.py更改源码,换logo</p><pre><code>base.png</code></pre><p>##汉化显示菜单名字</p><p>首先自己定义的model文件中，对于每一个变量，添加参数verbose_name</p><pre><code>author = models.ForeignKey(UserInfo, verbose_name=&#39;作者&#39;, on_delete=models.CASCADE)title = models.CharField(max_length=128, verbose_name=&quot;标题&quot;)</code></pre><p>对于app.py文件做出对应的修改</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>apps <span class="token keyword">import</span> AppConfig<span class="token keyword">class</span> <span class="token class-name">BlogConfig</span><span class="token punctuation">(</span>AppConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>    name <span class="token operator">=</span> <span class="token string">'blog'</span>    verbose_name <span class="token operator">=</span> <span class="token string">"博客管理"</span>　　　<span class="token comment">#对应汉化</span>    mean_icon <span class="token operator">=</span> <span class="token string">'fa fa-user'</span>　<span class="token comment"># 添加图标</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后一步，相对应的app下面的__init__.py文件中，添加如下：</p><pre><code>default_app_config = &quot;blog.apps.BlogConfig&quot;</code></pre>]]></content>
      
      
      <categories>
          
          <category> Django全网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step16后台邮件管理</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step16-hou-tai-you-jian-guan-li/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step16-hou-tai-you-jian-guan-li/</url>
      
        <content type="html"><![CDATA[<p>#邮件管理功能</p><p>订阅功能已经实现了：当用户订阅开启订阅功能后，网站会通过后台给用户发送网站最新的一些动向。<br>但是有时候需要关闭推送功能，比如网站邮件做一些调整之类的。</p><p>因此需要灵活的设置发送邮件功能。</p><p>本节来实现这个功能<br>###路由设置</p><p>我们先来写订阅推送的路由，</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -----------------------设置----------------------------</span>path<span class="token punctuation">(</span><span class="token string">'setting/&lt;int:pk>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>SettingView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'setting'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>同时修改myadmin/base.html文件</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui divider<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>myadmin:setting<span class="token punctuation">'</span> 1 %&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>setting<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>设置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>将路由设置为 SettingView</p><h2 id="视图设置"><a href="#视图设置" class="headerlink" title="视图设置"></a>视图设置</h2><p> SettingView 的代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 需admin手动添加1条记录</span><span class="token keyword">class</span> <span class="token class-name">SettingView</span><span class="token punctuation">(</span>SuperUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>UpdateView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Setting    form_class <span class="token operator">=</span> SettingForm    template_name <span class="token operator">=</span> <span class="token string">'myadmin/setting.html'</span>    <span class="token keyword">def</span> <span class="token function">get_success_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        messages<span class="token punctuation">.</span>success<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">"保存成功"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> reverse<span class="token punctuation">(</span><span class="token string">'myadmin:setting'</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'pk'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>kwargs<span class="token punctuation">[</span><span class="token string">'pk'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是一个更新视图类，功能和前面的user、video的 update方法类似</p><p>使用model和form_class 向前端传递更新数据<br>##模型表单的创建<br>这里模板Setting和表单SettingForm需要重新创建</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># myadmin/models.py</span><span class="token keyword">class</span> <span class="token class-name">Setting</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    switch_mail <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        db_table <span class="token operator">=</span> <span class="token string">"v_setting"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建一个模型只有一个布尔型字段，决定是否开启邮件服务</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">SettingForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> Setting        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'switch_mail'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>表单内容也很简单</p><h2 id="注册添加数据"><a href="#注册添加数据" class="headerlink" title="注册添加数据"></a>注册添加数据</h2><p>表单创建完毕需要进行数据迁移</p><pre class="line-numbers language-none"><code class="language-none">python3 manage.py makemigrationspython3 manage.py migrate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>但是现在表单中没有数据，所以两种方法，</p><ul><li>一个直接进行数据库操作，在这个表中插入一条数据</li><li>将模型Settings添加注册到admin后台，通过自带的后台手动添加<br>如果添加到admin后台，不要忘了修改admin文件<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># myadmin/admin.py</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin<span class="token keyword">from</span> myadmin<span class="token punctuation">.</span>models <span class="token keyword">import</span> Settingadmin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Setting<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>##前端文件<br>现在添加前端文件，就能看到这个功能了,这是一个单选框，保存成功页面简单的提示一下<pre class="line-numbers language-html" data-language="html"><code class="language-html">&#123;% extends 'myadmin/base.html' %&#125;&#123;% load static %&#125;&#123;% load thumbnail %&#125;&#123;% block content %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui grid<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>网站设置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui divider<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>v-form-wrap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui form<span class="token punctuation">"</span></span> <span class="token attr-name">novalidate</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>myadmin:setting<span class="token punctuation">'</span> 1 %&#125;<span class="token punctuation">"</span></span>                  <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                &#123;% csrf_token %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>field<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui checkbox<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                      &#123;&#123;form.switch_mail&#125;&#125;                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>开启邮件服务<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui primary button<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>保存<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>                &#123;% include "base/form_errors.html" %&#125;                &#123;% include "base/form_messages.html" %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>##修改发送邮件逻辑<br>前端基本功能实现了，下面实现本节的核心功能</li></ul><p>前端点击已经能实现数据的更新了，现在需要讲这个数据利用起来</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 订阅推送功能</span><span class="token keyword">class</span> <span class="token class-name">SubscribeView</span><span class="token punctuation">(</span>SuperUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 分组,两个一组，分别发送邮件</span>        email_list <span class="token operator">=</span> <span class="token punctuation">[</span>email_list<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>email_list<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>        switch_mail_flag <span class="token operator">=</span> Setting<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>switch_mail   <span class="token comment"># 获取是否发送邮件标志位</span>        <span class="token keyword">if</span> email_list<span class="token punctuation">:</span>            <span class="token keyword">for</span> to_list <span class="token keyword">in</span> email_list<span class="token punctuation">:</span>                <span class="token keyword">try</span><span class="token punctuation">:</span>                    <span class="token keyword">if</span> switch_mail_flag<span class="token punctuation">:</span>                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"send email to %s"</span> <span class="token operator">%</span> to_list<span class="token punctuation">)</span>                        send_html_email<span class="token punctuation">(</span>subject<span class="token punctuation">,</span> html_message<span class="token punctuation">,</span> to_list<span class="token punctuation">)</span>                    <span class="token keyword">else</span><span class="token punctuation">:</span>                        <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"邮件服务未开启"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token comment"># 通知前端服务未开启</span>                <span class="token keyword">except</span> smtplib<span class="token punctuation">.</span>SMTPException <span class="token keyword">as</span> e<span class="token punctuation">:</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在发送邮件前，获取switch_mail这个值，根据它的值决定是否发送邮件</p><p>如果服务未开启，通知前端</p>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step15数据总览功能</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step15-shu-ju-zong-lan-gong-neng/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step15-shu-ju-zong-lan-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>#数据总览功能<br>数据总览功能，是对网站中产生的数据进行一个统计，统计出视频数、发布数、用户数、评论数，等等。让管理者对网站数据有一个清晰的认识，做到心中有数。</p><p>在本站中，笔者一共列举了下面几种数据：视频数、发布中<br>未发布、用户数、用户新增、评论数、评论新增，等几项内容。</p><p>我们把所有的数据都封装到了一个函数里面，即 IndexView 它位于后台管理的首页。<br>##路由设置</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>IndexView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>##视图设置<br>通过IndexView实现视图，IndexView代码如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">IndexView</span><span class="token punctuation">(</span>AdminUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        video_count <span class="token operator">=</span> Video<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_count<span class="token punctuation">(</span><span class="token punctuation">)</span>        video_has_published_count <span class="token operator">=</span> Video<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_published_count<span class="token punctuation">(</span><span class="token punctuation">)</span>        video_not_published_count <span class="token operator">=</span> Video<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_not_published_count<span class="token punctuation">(</span><span class="token punctuation">)</span>        user_count <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>        user_today_count <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>exclude<span class="token punctuation">(</span>date_joined__lt<span class="token operator">=</span>datetime<span class="token punctuation">.</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>        comment_count <span class="token operator">=</span> Comment<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_count<span class="token punctuation">(</span><span class="token punctuation">)</span>        comment_today_count <span class="token operator">=</span> Comment<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_today_count<span class="token punctuation">(</span><span class="token punctuation">)</span>        data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"video_count"</span><span class="token punctuation">:</span> video_count<span class="token punctuation">,</span>                <span class="token string">"video_has_published_count"</span><span class="token punctuation">:</span> video_has_published_count<span class="token punctuation">,</span>                <span class="token string">"video_not_published_count"</span><span class="token punctuation">:</span> video_not_published_count<span class="token punctuation">,</span>                <span class="token string">"user_count"</span><span class="token punctuation">:</span> user_count<span class="token punctuation">,</span>                <span class="token string">"user_today_count"</span><span class="token punctuation">:</span> user_today_count<span class="token punctuation">,</span>                <span class="token string">"comment_count"</span><span class="token punctuation">:</span> comment_count<span class="token punctuation">,</span>                <span class="token string">"comment_today_count"</span><span class="token punctuation">:</span> comment_today_count<span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">'myadmin/index.html'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>与视频相关的统计，我们封装到了Video的models.py下面, 之前已经写好了，现在来调用它</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># video/models.py</span><span class="token keyword">class</span> <span class="token class-name">VideoQuerySet</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>query<span class="token punctuation">.</span>QuerySet<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 视频总数</span>    <span class="token keyword">def</span> <span class="token function">get_count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 发布数</span>    <span class="token keyword">def</span> <span class="token function">get_published_count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 未发布数</span>    <span class="token keyword">def</span> <span class="token function">get_not_published_count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上数据，大都使用了filter过滤器进行了过滤，最后通过count()函数返回给业务方。</p><p>与用户相关的统计，我们直接通过count和exclude将相关数据过滤出来。</p><p>与评论相关的统计，封装到了Comment的models.py下面，</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">CommentQuerySet</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>query<span class="token punctuation">.</span>QuerySet<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 评论总数</span>    <span class="token keyword">def</span> <span class="token function">get_count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 今日新增</span>    <span class="token keyword">def</span> <span class="token function">get_today_count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>exclude<span class="token punctuation">(</span>timestamp__lt<span class="token operator">=</span>datetime<span class="token punctuation">.</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中，今日新增评论，我们通过exclude来过滤时间，使用了 lt 标签来过滤</p>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step14后台反馈功能</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step14-hou-tai-fan-kui-gong-neng/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step14-hou-tai-fan-kui-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>#后天反馈功能<br>用户反馈管理功能，是对前端用户反馈的问题进行展示，并可实现删除功能。</p><p>它可以实时的跟踪到用户对网站的各种意见和吐槽，开发者能及时修缮网站功能或者修改网站bug。</p><p>##路由设置<br>反馈管理包括反馈列表和反馈删除，它们的路由是</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">'feedback_list/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>FeedbackListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'feedback_list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>path<span class="token punctuation">(</span><span class="token string">'feedback_delete/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>feedback_delete<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'feedback_delete'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>分别表示反馈列表和反馈删除功能。<br>修改myadmin/base.html</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>myadmin:feedback_list<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>feedback_list<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>用户反馈<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>##视图设置<br>列表是由FeedbackListView负责来展示，代码如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">FeedbackListView</span><span class="token punctuation">(</span>AdminUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Feedback            <span class="token comment"># 复用之前userprofile中定义的模型</span>    template_name <span class="token operator">=</span> <span class="token string">'myadmin/feedback_list.html'</span>    context_object_name <span class="token operator">=</span> <span class="token string">'feedback_list'</span>    paginate_by <span class="token operator">=</span> <span class="token number">10</span>            <span class="token comment"># 每页10条</span>    q <span class="token operator">=</span> <span class="token string">''</span>    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> object_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>FeedbackListView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        paginator <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'paginator'</span><span class="token punctuation">)</span>        page <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page_obj'</span><span class="token punctuation">)</span>        page_list <span class="token operator">=</span> get_page_list<span class="token punctuation">(</span>paginator<span class="token punctuation">,</span> page<span class="token punctuation">)</span>        context<span class="token punctuation">[</span><span class="token string">'page_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> page_list        context<span class="token punctuation">[</span><span class="token string">'q'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>q        <span class="token keyword">return</span> context    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>q <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> Feedback<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>content__contains<span class="token operator">=</span>self<span class="token punctuation">.</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-timestamp'</span><span class="token punctuation">)</span> <span class="token comment"># 根据内容查询按时间排序</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同样是继承自ListView通用视图，同样是配置了model、template、分页。</p><p>在get_context_data()函数中，传递了分页数据；在get_queryset()中，传递了搜索数据。</p><p>当你删除一条的时候，会触发相应的ajax代码，ajax位于static/js/myadmin/feedback_list.js，</p><p>ajax最终的幕后黑手是feedback_delete接口，它位于myadmin/views.py，</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@ajax_required</span><span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">feedback_delete</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>     feedback_id <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'feedback_id'</span><span class="token punctuation">]</span>    instance <span class="token operator">=</span> Feedback<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>feedback_id<span class="token punctuation">)</span>    instance<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>获取到 feedback 实例后，通过instance.delete()删除</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>反馈建议展示页面有个小bug，字数过长的时候，显示有点问题，会看不到后面的删除按钮</p>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step13后台订阅推送功能</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step13-hou-tai-ding-yue-tui-song-gong-neng/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step13-hou-tai-ding-yue-tui-song-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>#订阅邮件推送功能<br>本讲我们会讲到一些关于发邮件的技术。</p><p>订阅功能是一个很常见的功能，当用户订阅某个网站后，网站会通过后台给用户发送网站最新的一些动向，一般是通过邮件来发送的。</p><p>当你阅读完本节内容，会对发邮件的流程有一个大概的了解。</p><h2 id="配置相关参数"><a href="#配置相关参数" class="headerlink" title="配置相关参数"></a>配置相关参数</h2><p>发送邮件是需要配置相关参数的，且每个邮件服务商都有自己的配置值，笔者使用的是163邮箱，在settings.py追加如下配置</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">EMAIL_BACKEND <span class="token operator">=</span> <span class="token string">'django.core.mail.backends.smtp.EmailBackend'</span><span class="token comment"># 邮件配置</span>EMAIL_USE_SSL <span class="token operator">=</span> <span class="token boolean">True</span>EMAIL_HOST <span class="token operator">=</span> <span class="token string">'smtp.163.com'</span>EMAIL_PORT <span class="token operator">=</span> <span class="token number">465</span>EMAIL_HOST_USER <span class="token operator">=</span> <span class="token string">''</span>        <span class="token comment"># 163邮箱可用</span>EMAIL_HOST_PASSWORD <span class="token operator">=</span> <span class="token string">''</span>    <span class="token comment"># 邮箱密码</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一定要记得配置 EMAIL_BACKEND， 因为django默认配置的是一种模拟发邮件的 BackEnd ，并不能使用，故要替换。<br>###路由设置</p><p>我们先来写订阅推送的路由，</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">'subscribe/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>SubscribeView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'subscribe'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>同时修改myadmin/base.html文件</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>myadmin:subscribe<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>subscribe<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>订阅通知<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将路由设置为 SubscribeView</p><h2 id="视图设置"><a href="#视图设置" class="headerlink" title="视图设置"></a>视图设置</h2><p> SubscribeView 的代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 订阅推送功能</span><span class="token keyword">class</span> <span class="token class-name">SubscribeView</span><span class="token punctuation">(</span>SuperUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        video_list <span class="token operator">=</span> Video<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_published_list<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"myadmin/subscribe.html"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'video_list'</span><span class="token punctuation">:</span> video_list<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>            <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"无权限"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        video_id <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'video_id'</span><span class="token punctuation">]</span>        video <span class="token operator">=</span> Video<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>video_id<span class="token punctuation">)</span>      <span class="token comment"># 通过主键获取到视频的当前实例</span>        subject <span class="token operator">=</span> video<span class="token punctuation">.</span>title        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'video'</span><span class="token punctuation">:</span> video<span class="token punctuation">,</span> <span class="token string">'site_url'</span><span class="token punctuation">:</span> settings<span class="token punctuation">.</span>SITE_URL<span class="token punctuation">&#125;</span>                          <span class="token comment"># 使用SITE_URL构建网址</span>        html_message <span class="token operator">=</span> render_to_string<span class="token punctuation">(</span><span class="token string">'myadmin/mail_template.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>        email_list <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>subscribe<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values_list<span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">,</span> flat<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 获取到所有订阅用户的email地址到email_list</span>        <span class="token comment"># 分组,两个一组，分别发送邮件</span>        email_list <span class="token operator">=</span> <span class="token punctuation">[</span>email_list<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>email_list<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> email_list<span class="token punctuation">:</span>            <span class="token keyword">for</span> to_list <span class="token keyword">in</span> email_list<span class="token punctuation">:</span>                <span class="token keyword">try</span><span class="token punctuation">:</span>                    send_html_email<span class="token punctuation">(</span>subject<span class="token punctuation">,</span> html_message<span class="token punctuation">,</span> to_list<span class="token punctuation">)</span>                <span class="token keyword">except</span> smtplib<span class="token punctuation">.</span>SMTPException <span class="token keyword">as</span> e<span class="token punctuation">:</span>                    logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>e<span class="token punctuation">)</span>                    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"发送失败"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"邮件列表为空"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是一个普通的视图类，功能是由get和post共同来完成的。</p><p>get中设置了要显示的模板文件myadmin/subscribe.html</p><p>当我们要给用户发送邮件的时候，需要先选择要推送的视频。然后点击通知订阅用户，即可触发ajax发送代码</p><p>，ajax代码位于static/js/myadmin/send_mail.js，里面最终调用的是SubscribeView中的post方法，</p><p>post方法中，我们先通过主键获取到视频的当前实例，并且还获取到所有订阅用户的email地址放到email_list中，</p><p>最后调用send_html_email将邮件发送出去，send_html_email封装在video_helpers.py，它的具体代码是</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">send_html_email</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> html_message<span class="token punctuation">,</span> to_list<span class="token punctuation">)</span><span class="token punctuation">:</span>    plain_message <span class="token operator">=</span> strip_tags<span class="token punctuation">(</span>html_message<span class="token punctuation">)</span>    from_email <span class="token operator">=</span> settings<span class="token punctuation">.</span>EMAIL_HOST_USER    send_mail<span class="token punctuation">(</span>subject<span class="token punctuation">,</span> plain_message<span class="token punctuation">,</span> from_email<span class="token punctuation">,</span> to_list<span class="token punctuation">,</span> html_message<span class="token operator">=</span>html_message<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">send_email</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> content<span class="token punctuation">,</span> to_list<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        message <span class="token operator">=</span> <span class="token punctuation">(</span>subject<span class="token punctuation">,</span> content<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>EMAIL_HOST_USER<span class="token punctuation">,</span> to_list<span class="token punctuation">)</span>        send_mass_mail<span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> smtplib<span class="token punctuation">.</span>SMTPException <span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--> send fail"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"fail"</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--> send success"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从代码可以看出，程序最终调用的是django自带的 send_mass_mail 函数，该函数封装了发送邮件的细节。</p><p>当然还可以使用 send_mail 函数，send_mail每次发邮件都会建立一个连接，发多封邮件时建立多个连接。</p><p>而 send_mass_mail 是建立单个连接发送多封邮件，所以一次性发送多封邮件时 send_mass_mail 要优于 send_mail。</p>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step12后台用户管理功能</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step12-hou-tai-yong-hu-guan-li-gong-neng/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step12-hou-tai-yong-hu-guan-li-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>#后台用户管理功能<br>用户管理功能,跟其他功能也类似，增删改查</p><p>##路由设置<br>先在urls.py下添加相关的路由</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">'user_add/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>UserAddView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'user_add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>path<span class="token punctuation">(</span><span class="token string">'user_list/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>UserListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'user_list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>path<span class="token punctuation">(</span><span class="token string">'user_edit/&lt;int:pk>'</span><span class="token punctuation">,</span>views<span class="token punctuation">.</span>UserEditView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'user_edit'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>path<span class="token punctuation">(</span><span class="token string">'user_delete/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>user_delete<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'user_delete'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>#用户添加<br>添加用户前需要创建一个表单来存贮用户相关的数据</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">UserAddForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>                               max_length<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>                               error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                   <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'用户名不少于4个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'max_length'</span><span class="token punctuation">:</span> <span class="token string">'用户名不能多于30个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'用户名不能为空'</span><span class="token punctuation">,</span>                               <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                               widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入用户名'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    password <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>                               max_length<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>                               error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                   <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'密码不少于4个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'max_length'</span><span class="token punctuation">:</span> <span class="token string">'密码不能多于30个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'密码不能为空'</span><span class="token punctuation">,</span>                               <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                               widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>PasswordInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入密码'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> User        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token string">'is_staff'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>主要是用户名和密码，is_staff元素<br>用户添加的视图类是UserAddView</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">UserAddView</span><span class="token punctuation">(</span>SuperUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        form <span class="token operator">=</span> UserAddForm<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">'myadmin/user_add.html'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        form <span class="token operator">=</span> UserAddForm<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            user <span class="token operator">=</span> form<span class="token punctuation">.</span>save<span class="token punctuation">(</span>commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>            password <span class="token operator">=</span> form<span class="token punctuation">.</span>cleaned_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>            user<span class="token punctuation">.</span>set_password<span class="token punctuation">(</span>password<span class="token punctuation">)</span>            user<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> render<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">'myadmin/user_add_success.html'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">'myadmin/user_add.html'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是一个普通的视图类，通过get()和post()来完成用户添加的功能，get里面负责页面的展示，post里面负责逻辑处理。</p><p>在get中，初始化form为UserAddForm，因为添加的用户是有类别的，所以在UserAddForm中应用了is_staff字段来表示管理员。</p><p>在post中，我们通过user.set_password(password)来设置新密码。user.save()来保存记录到数据库。</p><p>保存成功后会跳转到myadmin/user_add_success.html页面。</p><p>##用户列表</p><p>用户添加成功后，当你点击用户列表，即可看到用户列表数据。</p><p>使用的是UserListView视图类，该类是继承自ListView通用视图类的。因此 只需要我们添加实现列表功能。UserListView代码如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">UserListView</span><span class="token punctuation">(</span>AdminUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> User    template_name <span class="token operator">=</span> <span class="token string">'myadmin/user_list.html'</span>    context_object_name <span class="token operator">=</span> <span class="token string">'user_list'</span>    paginate_by <span class="token operator">=</span> <span class="token number">10</span>    q <span class="token operator">=</span> <span class="token string">''</span>    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> object_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>UserListView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        paginator <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'paginator'</span><span class="token punctuation">)</span>        page <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page_obj'</span><span class="token punctuation">)</span>        page_list <span class="token operator">=</span> get_page_list<span class="token punctuation">(</span>paginator<span class="token punctuation">,</span> page<span class="token punctuation">)</span>        context<span class="token punctuation">[</span><span class="token string">'page_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> page_list        context<span class="token punctuation">[</span><span class="token string">'q'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>q        <span class="token keyword">return</span> context    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>q <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>username__contains<span class="token operator">=</span>self<span class="token punctuation">.</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-date_joined'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>跟之前一样，通过ListView展现数据。</p><p>我们知道ListView是有多个回调函数的，这里就是通过get_context_data()和get_queryset()回调函数来实现列表中的功能的。</p><p>在get_context_data()中实现了列表分页功能，在get_queryset()中实现了搜索功能。</p><p>##用户编辑<br>当你点击编辑按钮的时候，即可进入编辑页面。<br>编辑页面也需要创建一个表单来存贮它的数据</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">username_validate</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> value <span class="token operator">==</span> <span class="token string">"admin"</span><span class="token punctuation">:</span>        <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">'不能编辑超级管理员'</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">UserEditForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>                               max_length<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>                               required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>                               validators<span class="token operator">=</span><span class="token punctuation">[</span>username_validate<span class="token punctuation">]</span><span class="token punctuation">,</span>                               error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                  <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'至少4个字符'</span><span class="token punctuation">,</span>                                  <span class="token string">'max_length'</span><span class="token punctuation">:</span> <span class="token string">'不能多于30个字符'</span><span class="token punctuation">,</span>                                  <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'用户名不能为空'</span>                               <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                               widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入用户名'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> User        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'is_staff'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对应的视图设置如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">UserEditView</span><span class="token punctuation">(</span>SuperUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>UpdateView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> User    form_class <span class="token operator">=</span> UserEditForm    template_name <span class="token operator">=</span> <span class="token string">'myadmin/user_edit.html'</span>    <span class="token keyword">def</span> <span class="token function">get_success_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        messages<span class="token punctuation">.</span>success<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">"保存成功"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> reverse<span class="token punctuation">(</span><span class="token string">'myadmin:user_edit'</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'pk'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>kwargs<span class="token punctuation">[</span><span class="token string">'pk'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同样是继承自UpdateView，仅需要配置好model、form_class、template_name即可</p><p>##用户删除</p><p>当你点击删除按钮的时候，会弹出确认框让你删除。然后网站通过ajax调用user_delete来实现真正的删除操作，其中，ajax代码位于static/js/myadmin/user_list.js</p><p>真正的删除函数是user_delete，下面是它的真面目</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@ajax_required</span><span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">user_delete</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>     user_id <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span>    instance <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>user_id<span class="token punctuation">)</span>     instance<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首先获取到当前用户的实例，然后通过 instance.delete()删除.</p><p>##前端页面<br>照例需要修改base.html文件</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>myadmin:user_list<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user_list<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>用户列表<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>myadmin:user_add<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user_add<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>添加用户<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>其他需要添加的文件如下</p><pre class="line-numbers language-none"><code class="language-none">新文件：   static&#x2F;js&#x2F;myadmin&#x2F;user_list.js修改：     templates&#x2F;myadmin&#x2F;base.html新文件：   templates&#x2F;myadmin&#x2F;user_add.html新文件：   templates&#x2F;myadmin&#x2F;user_add_success.html新文件：   templates&#x2F;myadmin&#x2F;user_edit.html新文件：   templates&#x2F;myadmin&#x2F;user_list.html新文件：   templates&#x2F;myadmin&#x2F;user_list_modal.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step11后台评论功能</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step11-hou-tai-ping-lun-gong-neng/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step11-hou-tai-ping-lun-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>#后台评论功能<br>本讲中来讲评论管理功能，数据库中的每一条是来自用户的评价，</p><p>因此后台中的评论管理只有评论列表和评论删除功能，没有增加评论和编辑评论。<br>##路由设置<br>照例我们先添加评论管理的相关路由</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># myadmin/urls.py</span>    <span class="token comment"># ----------------------评论管理----------------------------</span>    path<span class="token punctuation">(</span><span class="token string">'comment_list/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>CommentListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'comment_list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'comment_delete/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>comment_delete<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'comment_delete'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>只添加列表和删除功能<br>##视图设置<br>首先是评论列表的展示，我们通过CommentListView视图类来实现，该类依然是继承ListView来实现的。代码如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">CommentListView</span><span class="token punctuation">(</span>AdminUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Comment    template_name <span class="token operator">=</span> <span class="token string">'myadmin/comment_list.html'</span>    context_object_name <span class="token operator">=</span> <span class="token string">'comment_list'</span>    paginate_by <span class="token operator">=</span> <span class="token number">10</span>    q <span class="token operator">=</span> <span class="token string">''</span>    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> object_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>CommentListView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        paginator <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'paginator'</span><span class="token punctuation">)</span>        page <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page_obj'</span><span class="token punctuation">)</span>        page_list <span class="token operator">=</span> get_page_list<span class="token punctuation">(</span>paginator<span class="token punctuation">,</span> page<span class="token punctuation">)</span>        context<span class="token punctuation">[</span><span class="token string">'page_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> page_list        context<span class="token punctuation">[</span><span class="token string">'q'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>q        <span class="token keyword">return</span> context    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>q <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> Comment<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>content__contains<span class="token operator">=</span>self<span class="token punctuation">.</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-timestamp'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过继承ListView来实现评论列表的展示，通过get_context_data()来实现分页功能，通过get_queryset()来实现搜索功能。</p><p>下面我们继续实现删除功能，该功能比较简单，只需要通过ajax将video_id传给删除接口即可，</p><p>ajax的代码位于static/js/myadmin/comment_list.js，</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 写入csrf</span>$<span class="token punctuation">.</span><span class="token function">getScript</span><span class="token punctuation">(</span><span class="token string">"/static/js/csrftoken.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.comment-delete'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">var</span> tr <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closest</span><span class="token punctuation">(</span><span class="token string">"tr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> comment_id <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"comment-id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.ui.tiny.modal.delete'</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>          closable  <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>          <span class="token function-variable function">onDeny</span>    <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token function-variable function">onApprove</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>                url<span class="token operator">:</span> api_comment_delete<span class="token punctuation">,</span>                data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token string">'comment_id'</span><span class="token operator">:</span>comment_id<span class="token punctuation">,</span>                    <span class="token string">'csrf_token'</span><span class="token operator">:</span> csrftoken                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                type<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>                dataType<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>                <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token keyword">var</span> code <span class="token operator">=</span> data<span class="token punctuation">.</span>code                     <span class="token keyword">var</span> msg <span class="token operator">=</span> data<span class="token punctuation">.</span>msg                     <span class="token keyword">if</span><span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                        window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                        <span class="token function">alert</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token operator">+</span>data<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">'show'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>删除评论的接口是api_comment_delete，最终会调用到comment_delete，代码如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@ajax_required</span><span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">comment_delete</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>     comment_id <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'comment_id'</span><span class="token punctuation">]</span>    instance <span class="token operator">=</span> Comment<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>comment_id<span class="token punctuation">)</span>    instance<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>逻辑还算清晰，即先拿到评论的id，然后获取到该条评论，最后instance.delete()删除</p><p>##前端设置<br>先看一下需要修改的文件</p><pre class="line-numbers language-none"><code class="language-none">修改：     templates&#x2F;myadmin&#x2F;base.html新文件：   templates&#x2F;myadmin&#x2F;comment_list.html新文件：   templates&#x2F;myadmin&#x2F;comment_list_modal.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>其中base.html文件需要将评论地址添加进去,实现跳转</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>myadmin:comment_list<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>comment_list<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>评论列表<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>comment_list.html文件为新添加的文件，大体布局跟video_list.html类似</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&#123;% extends 'myadmin/base.html' %&#125;&#123;% load static %&#125;&#123;% load video_tag %&#125;&#123;% block content %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui grid<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui header six wide column<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>评论列表<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>v-title-extra ten wide column<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui action input v-admin-search<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Search...<span class="token punctuation">"</span></span>  <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123;q&#125;&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>v-search<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui small button<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>search<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>搜索<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui divider<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui unstackable single line striped selectable table<span class="token punctuation">"</span></span>  <span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>thead</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>#id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>用户<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>昵称<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>视频名字<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>评论内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>评论时间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>操作<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>thead</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tbody</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video-list<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            &#123;% for item in comment_list %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">comment-id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123;item.id&#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span> &#123;&#123;item.user_id&#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span> &#123;&#123;item.user.username&#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span> &#123;&#123;item.nickname&#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span> &#123;&#123;item.video.title&#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span> &#123;&#123; item.content | comment_slice &#125;&#125; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span> &#123;&#123;item.timestamp|date:'Y-m-d H:i'&#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui button comment-delete<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>删除<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>            &#123;% empty %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>暂时没有评论<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>            &#123;% endfor %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tbody</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tfoot</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span> <span class="token attr-name">colspan</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>6<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    &#123;% include 'myadmin/page_nav.html' %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tfoot</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;&#123;% block modal %&#125;&#123;% include "myadmin/comment_list_modal.html" %&#125;&#123;% endblock modal %&#125;&#123;% block script %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token keyword">var</span> search_url <span class="token operator">=</span> <span class="token string">"&#123;% url 'myadmin:comment_list' %&#125;"</span>    <span class="token keyword">var</span> api_comment_delete <span class="token operator">=</span> <span class="token string">"&#123;% url 'myadmin:comment_delete' %&#125;"</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>js/myadmin/comment_list.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>&#123;% endblock script %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>小功能，它调用了自定义标签 video_tag，使用这个里面的函数时需要的时候需要提前注册<br>在设置中添加libraries</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># videoproject/settings.py</span>TEMPLATES <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token string">'OPTIONS'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'context_processors'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token string">'libraries'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>                <span class="token string">'my_customs_tag'</span><span class="token punctuation">:</span> <span class="token string">'video.templatetags.video_tag'</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>自定义的标签文件，先注册，然后添加自己想用的函数.</p><p>这里仅仅是添加一个函数，处理评论在页面显示过长的问题, 超过50个字直接截断</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django <span class="token keyword">import</span> templateregister <span class="token operator">=</span> template<span class="token punctuation">.</span>Library<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 分词</span><span class="token decorator annotation punctuation">@register<span class="token punctuation">.</span>filter</span><span class="token keyword">def</span> <span class="token function">comment_slice</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> comment<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'...'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step10后台视频分类功能</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step10-hou-tai-shi-pin-fen-lei-gong-neng/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step10-hou-tai-shi-pin-fen-lei-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>#视频分类<br>视频分类的功能，主要包括以下内容</p><ul><li>分类列表</li><li>添加分类</li><li>修改分类</li><li>删除分类</li></ul><p>分类管理功能包括分类的增删改查。<br>###路由设置<br>增删改查的路由是</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">'classification_add/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>ClassificationAddView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'classification_add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>path<span class="token punctuation">(</span><span class="token string">'classification_list/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>ClassificationListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'classification_list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>path<span class="token punctuation">(</span><span class="token string">'classification_edit/&lt;int:pk>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>ClassificationEditView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'classification_edit'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>path<span class="token punctuation">(</span><span class="token string">'classification_delete/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>classification_delete<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'classification_delete'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>###添加分类<br>先来看分类添加的功能</p><p>分类添加是通过ClassificationAddView视图类来实现的，代码如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ClassificationAddView</span><span class="token punctuation">(</span>SuperUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        form <span class="token operator">=</span> ClassificationAddForm<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">'myadmin/classification_add.html'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        form <span class="token operator">=</span> ClassificationAddForm<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            form<span class="token punctuation">.</span>save<span class="token punctuation">(</span>commit<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> render<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">'myadmin/classification_add_success.html'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">'myadmin/classification_add.html'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此处是通过get和post一同来实现的，get()负责展示界面，post()负责逻辑判断。</p><p>在post()中，直接调用form.save来保存记录，然后跳转到成功页myadmin/classification_add_success.html。<br>###查看分类列表<br>然后点击视频列表，即可查看列表，视频列表的视图类是ClassificationListView，即</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ClassificationListView</span><span class="token punctuation">(</span>AdminUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Classification    template_name <span class="token operator">=</span> <span class="token string">'myadmin/classification_list.html'</span>    context_object_name <span class="token operator">=</span> <span class="token string">'classification_list'</span>    paginate_by <span class="token operator">=</span> <span class="token number">10</span>    q <span class="token operator">=</span> <span class="token string">''</span>    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> object_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>ClassificationListView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        paginator <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'paginator'</span><span class="token punctuation">)</span>        page <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page_obj'</span><span class="token punctuation">)</span>        page_list <span class="token operator">=</span> get_page_list<span class="token punctuation">(</span>paginator<span class="token punctuation">,</span> page<span class="token punctuation">)</span>        context<span class="token punctuation">[</span><span class="token string">'page_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> page_list        context<span class="token punctuation">[</span><span class="token string">'q'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>q        <span class="token keyword">return</span> context    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>q <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> Classification<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>title__contains<span class="token operator">=</span>self<span class="token punctuation">.</span>q<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>继承ListView来显示列表，通过get_queryset()来实现搜索功能，通过get_context_data()来实现分页功能，通过template_name来指定模板</p><p>接着来实现编辑和删除功能。</p><p>编辑对应的视图类是ClassificationEditView，它的实现超级简单，继承UpdateView即可。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ClassificationEditView</span><span class="token punctuation">(</span>SuperUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>UpdateView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Classification    form_class <span class="token operator">=</span> ClassificationEditForm    template_name <span class="token operator">=</span> <span class="token string">'myadmin/classification_edit.html'</span>    <span class="token keyword">def</span> <span class="token function">get_success_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        messages<span class="token punctuation">.</span>success<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">"保存成功"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> reverse<span class="token punctuation">(</span><span class="token string">'myadmin:classification_edit'</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'pk'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>kwargs<span class="token punctuation">[</span><span class="token string">'pk'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编辑页面和添加页面很相似<br>###删除功能<br>最后是删除功能，是通过ajax来实现的，ajax代码位于static/js/myadmin/classification_list.js，<br>在ajax中，通过调用删除接口classification_delete来实现删除功能，</p><p>接口classification_delete的代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@ajax_required</span><span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">classification_delete</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    classification_id <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'classification_id'</span><span class="token punctuation">]</span>    instance <span class="token operator">=</span> Classification<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>classification_id<span class="token punctuation">)</span>    instance<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step09后台视频管理功能</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step09-hou-tai-shi-pin-guan-li-gong-neng/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step09-hou-tai-shi-pin-guan-li-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>#后台视频管理功能<br>从本讲开始，我们开始视频管理功能的开发，视频管理包括</p><ul><li>视频上传</li><li>视频列表</li><li>视频编辑</li><li>视频删除</li></ul><p>这一讲非常重要，因为将学习到一些之前没有学过的技术，比如大文件上传技术。<br>##视频上传</p><p>我们先来实现视频的上传，视频的上传采用的是分块上传的策略，并用了分块上传类库：django_chunked_upload，使用该类库，再配合前端上传js库（jquery.fileupload.js），即可完美的实现文件的分块上传功能。<br>###路由设置<br>照例先编写添加视频的路由</p><p>添加视频，当然需要上传视频的页面，我们的页面是video_add路由来显示，通过urls .py中指定</p><pre class="line-numbers language-none"><code class="language-none"># myadmin&#x2F;urls.pypath(&#39;video_add&#x2F;&#39;, views.AddVideoView.as_view(), name&#x3D;&#39;video_add&#39;),    #上传视频path(&#39;chunked_upload&#x2F;&#39;,  views.MyChunkedUploadView.as_view(), name&#x3D;&#39;api_chunked_upload&#39;),  # 上传接口path(&#39;chunked_upload_complete&#x2F;&#39;, views.MyChunkedUploadCompleteView.as_view(),name&#x3D;&#39;api_chunked_upload_complete&#39;),  # 上传视频完成接口<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>###添加视图<br>AddViewView仅仅用来显示上传页面，它的代码很简单</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">AddVideoView</span><span class="token punctuation">(</span>SuperUserRequiredMixin<span class="token punctuation">,</span> TemplateView<span class="token punctuation">)</span><span class="token punctuation">:</span>    template_name <span class="token operator">=</span> <span class="token string">'myadmin/video_add.html'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>只是继承了TemplateView来显示myadmin/video_add.html<br>###前端</p><pre class="line-numbers language-none"><code class="language-none">templates&#x2F;myadmin&#x2F;├── base.html                       # 基础页面├── login.html                      # 登录页面├── video_add.html                  # 添加视频页面├── video_edit.html                 # 编辑视频页面├── video_list.html                 # 列表页面├── video_list_modal.html           ├── video_publish.html              # 发布页面，跟编辑页面类似└── video_publish_success.html      # 发布成功页面<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>myadmin/video_add.html中实现了上传视频的全过程，视频的上传采用的是分块上传的策略，</p><p>前端使用的是js上传库（jquery.fileupload.js），后端使用的是django_chunked_upload。</p><p>上传的逻辑是这样的：</p><ul><li>前端先选择一个文件，通过jquery.fileupload.js中的$.fileupload()方法来上传文件；</li><li>后端接收到后分批返回已上传块的进度；</li><li>前端根据进度来更新界面；</li></ul><p>由于上传前需要做一些校验的操作，代码较复杂，所以我们把上传的代码封装到了一个js中:static/js/myadmin/video_upload.js，<br>这些内容基本都是django_chunked_upload中的demo模板内容，主要的代码如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#chunked_upload"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fileupload</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  url<span class="token operator">:</span> api_chunked_uplad<span class="token punctuation">,</span>  dataType<span class="token operator">:</span> <span class="token string">"json"</span><span class="token punctuation">,</span>  maxChunkSize<span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token comment">// Chunks of 100 kB</span>  formData<span class="token operator">:</span> form_data<span class="token punctuation">,</span>  <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Called before starting upload</span>    <span class="token keyword">var</span> fileSize <span class="token operator">=</span> data<span class="token punctuation">.</span>originalFiles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> type <span class="token operator">=</span> data<span class="token punctuation">.</span>originalFiles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fileSize <span class="token operator">></span> <span class="token number">100000000</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'文件太大了，请上传100M以内的文件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"video/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'视频格式不正确'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    form_data<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">calculate_md5</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Again, chunks of 100 kB</span>    data<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#progress_label'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#progress_layout'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function-variable function">chunkdone</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Called after uploading each chunk</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>form_data<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      form_data<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>        <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"upload_id"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token operator">:</span> data<span class="token punctuation">.</span>result<span class="token punctuation">.</span>upload_id<span class="token punctuation">&#125;</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">var</span> progress <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>loaded <span class="token operator">/</span> data<span class="token punctuation">.</span>total <span class="token operator">*</span> <span class="token number">100.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>progress<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>progress <span class="token operator">></span> lastprogress<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        lastprogress <span class="token operator">=</span> progress        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#upload_progress'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            percent<span class="token operator">:</span> progress        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function-variable function">done</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Called when the file has completely uploaded</span>    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>      type<span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>      url<span class="token operator">:</span> api_chunked_upload_complete<span class="token punctuation">,</span>      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>        csrfmiddlewaretoken<span class="token operator">:</span> csrf<span class="token punctuation">,</span>        upload_id<span class="token operator">:</span> data<span class="token punctuation">.</span>result<span class="token punctuation">.</span>upload_id<span class="token punctuation">,</span>        md5<span class="token operator">:</span> md5      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      dataType<span class="token operator">:</span> <span class="token string">"json"</span><span class="token punctuation">,</span>      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#upload_label'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#upload_progress'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            percent<span class="token operator">:</span> <span class="token number">100</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#next_layout'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#next'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            window<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token string">'/myadmin/video_publish/'</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>video_id        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在$.fileupload()方法中，有一个回调方法chunkdone()，该方法是用来更新进度的，告诉前端已经上传了多少字节。</p><p>另外还有一个回调方法done()，该方法表示上传完毕，前端可在里面做一些额外的事情。</p><p>上传完毕后，调用了一个接口api_chunked_upload_complete，来给后端发送一个回执：我已上传完毕。<br>###上传成功视图<br>api_chunked_upload和api_chunked_upload_complete的路由已经配好</p><p>在MyChunkedUploadCompleteView中，我们在利用Video模型创建了这条视频</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># myadmin/models.py</span><span class="token keyword">from</span> chunked_upload<span class="token punctuation">.</span>models <span class="token keyword">import</span> ChunkedUpload<span class="token comment"># 上传视频模块用到的， 基本没改动和demo一样</span>MyChunkedUpload <span class="token operator">=</span> ChunkedUpload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>视图中使用它</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># myadmin/views.py</span><span class="token comment"># 上传视频</span><span class="token keyword">class</span> <span class="token class-name">MyChunkedUploadView</span><span class="token punctuation">(</span>ChunkedUploadView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> MyChunkedUpload    field_name <span class="token operator">=</span> <span class="token string">'the_file'</span><span class="token keyword">class</span> <span class="token class-name">MyChunkedUploadCompleteView</span><span class="token punctuation">(</span>ChunkedUploadCompleteView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> MyChunkedUpload    <span class="token comment"># 上传视频回调函数    </span>    <span class="token keyword">def</span> <span class="token function">on_completion</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> uploaded_file<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'uploaded--->'</span><span class="token punctuation">,</span> uploaded_file<span class="token punctuation">.</span>name<span class="token punctuation">)</span>        <span class="token comment"># 视频上传成功回调函数</span>    <span class="token keyword">def</span> <span class="token function">get_response_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> chunked_upload<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        video <span class="token operator">=</span> Video<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token operator">=</span>chunked_upload<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'code'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'video_id'</span><span class="token punctuation">:</span> video<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token string">'msg'</span><span class="token punctuation">:</span> <span class="token string">'success'</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>##视频发布</p><p>然后用户点击下一步，进入video_publish页面，开始发布前的资料填写<br>###视频发布路由设置</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">video_publish的路由是    path<span class="token punctuation">(</span><span class="token string">'video_publish/&lt;int:pk>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>VideoPublishView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'video_publish'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 视频发布，后面可以拓展为视频审核成功后发布</span>    path<span class="token punctuation">(</span><span class="token string">'video_publish_success/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>VideoPublishSuccessView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'video_publish_success'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 视频发布成功</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>###视频发布视图<br>发布列表用到VideoPublishForm，因此需要创建</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># myadmin/forms.py</span><span class="token keyword">from</span> django <span class="token keyword">import</span> forms<span class="token keyword">from</span> video<span class="token punctuation">.</span>models <span class="token keyword">import</span> Video<span class="token keyword">class</span> <span class="token class-name">VideoPublishForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    title <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>                            error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                  <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'至少4个字符'</span><span class="token punctuation">,</span>                                  <span class="token string">'max_length'</span><span class="token punctuation">:</span> <span class="token string">'不能多于200个字符'</span><span class="token punctuation">,</span>                                  <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'标题不能为空'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                            widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入内容'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    desc <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>                           error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                              <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'至少4个字符'</span><span class="token punctuation">,</span>                              <span class="token string">'max_length'</span><span class="token punctuation">:</span> <span class="token string">'不能多于200个字符'</span><span class="token punctuation">,</span>                              <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'描述不能为空'</span>                           <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                           widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>Textarea<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入内容'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    cover <span class="token operator">=</span> forms<span class="token punctuation">.</span>ImageField<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>                             error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                 <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'封面不能为空'</span>                             <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                             widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>FileInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'n'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    status <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>                             widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>HiddenInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'value'</span><span class="token punctuation">:</span> <span class="token string">'0'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> Video        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'desc'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">,</span> <span class="token string">'cover'</span><span class="token punctuation">,</span> <span class="token string">'classification'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>video_publish的视图类是VideoPublishView，它的代码如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">VideoPublishView</span><span class="token punctuation">(</span>SuperUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>UpdateView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Video    form_class <span class="token operator">=</span> VideoPublishForm    template_name <span class="token operator">=</span> <span class="token string">'myadmin/video_publish.html'</span>    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>VideoPublishView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        clf_list <span class="token operator">=</span> Classification<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>        clf_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'clf_list'</span><span class="token punctuation">:</span>clf_list<span class="token punctuation">&#125;</span>        context<span class="token punctuation">.</span>update<span class="token punctuation">(</span>clf_data<span class="token punctuation">)</span>        <span class="token keyword">return</span> context    <span class="token keyword">def</span> <span class="token function">get_success_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> reverse<span class="token punctuation">(</span><span class="token string">'myadmin:video_publish_success'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，对应的页面是myadmin/video_publish.html</p><p>要填写的视频资料有视频标题、描述、分类、封面，</p><p>其中分类是通过get_context_data()带过来的，</p><p>填写后，点击发布，django将通过UpdateView自动为你更新视频信息。并通过get_success_url跳转到成功页面myadmin:video_publish_success，它的路由是</p><p>通过 video_publish_success 调用 VideoPublishSuccessView。</p><p>对应VideoPublishSuccessView是</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">VideoPublishSuccessView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>TemplateView<span class="token punctuation">)</span><span class="token punctuation">:</span>    template_name <span class="token operator">=</span> <span class="token string">'myadmin/video_publish_success.html'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>到此视频添加功能完成</p><p>##视频列表</p><p>视频列表的路由是</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">'video_list/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>VideoListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'video_list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>对应的视图类是VideoListView</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">VideoListView</span><span class="token punctuation">(</span>AdminUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Video    template_name <span class="token operator">=</span> <span class="token string">'myadmin/video_list.html'</span>    context_object_name <span class="token operator">=</span> <span class="token string">'video_list'</span>    paginate_by <span class="token operator">=</span> <span class="token number">10</span>    q <span class="token operator">=</span> <span class="token string">''</span>    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> object_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>VideoListView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        paginator <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'paginator'</span><span class="token punctuation">)</span>        page <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page_obj'</span><span class="token punctuation">)</span>        page_list <span class="token operator">=</span> get_page_list<span class="token punctuation">(</span>paginator<span class="token punctuation">,</span> page<span class="token punctuation">)</span>        context<span class="token punctuation">[</span><span class="token string">'page_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> page_list        context<span class="token punctuation">[</span><span class="token string">'q'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>q        <span class="token keyword">return</span> context    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>q <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> Video<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_search_list<span class="token punctuation">(</span>self<span class="token punctuation">.</span>q<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里继承了ListView来显示视频列表，并通过get_queryset实现了搜索功能，通过get_context_data()实现了分页功能。<br>##视频编辑<br>页面中还有编辑和删除的功能。</p><p>编辑呢，是对单个视频对资料进行更新，删除即删除本条视频和视频文件。</p><p>我们先实现编辑功能，路由是</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">'video_edit/&lt;int:pk>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>VideoEditView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'video_edit'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>对应对视图类是VideoEditView，这个视图类是需要传递主键的。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">VideoEditView</span><span class="token punctuation">(</span>SuperUserRequiredMixin<span class="token punctuation">,</span> generic<span class="token punctuation">.</span>UpdateView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Video    form_class <span class="token operator">=</span> VideoEditForm    template_name <span class="token operator">=</span> <span class="token string">'myadmin/video_edit.html'</span>    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>VideoEditView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        clf_list <span class="token operator">=</span> Classification<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>        clf_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'clf_list'</span><span class="token punctuation">:</span>clf_list<span class="token punctuation">&#125;</span>        context<span class="token punctuation">.</span>update<span class="token punctuation">(</span>clf_data<span class="token punctuation">)</span>        <span class="token keyword">return</span> context    <span class="token keyword">def</span> <span class="token function">get_success_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        messages<span class="token punctuation">.</span>success<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">"保存成功"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> reverse<span class="token punctuation">(</span><span class="token string">'myadmin:video_edit'</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'pk'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>kwargs<span class="token punctuation">[</span><span class="token string">'pk'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>```    其实编辑页面和发布页面很相似，都是继承UpdateView视图类，并在get_context_data<span class="token punctuation">(</span><span class="token punctuation">)</span>里面传递分类信息。最终成功后通过messages<span class="token punctuation">.</span>success<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">"保存成功"</span><span class="token punctuation">)</span>消息告之前端。<span class="token comment">##视频删除</span>删除功能就更加简单了。路由是```pythonpath<span class="token punctuation">(</span><span class="token string">'video_delete/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>video_delete<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'video_delete'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里通过video_delete函数来实现，前端通过ajax（ajax代码位于static/js/myadmin/video_list.js）调用这个函数。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@ajax_required</span><span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">video_delete</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    video_id <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'video_id'</span><span class="token punctuation">]</span>    instance <span class="token operator">=</span> Video<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>video_id<span class="token punctuation">)</span>    instance<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>获取该视频，然后instance.delete()删除之。</p>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step08后台登录</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step08-hou-tai-deng-lu/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step08-hou-tai-deng-lu/</url>
      
        <content type="html"><![CDATA[<p>#后台登录功能<br>从本讲起，我们会介绍后台管理系统的开发，后台管理</p><p>主要是对数据库中的数据进行增、删、改、查的操作，满足网站管理员对网站的管理与维护的需求。</p><p>其实，django自带的也有一个后台管理系统（/admin），但是自带的后台非常简陋，</p><p>无论是界面，还是功能上，都无法满足用户的需求，因此，需要自己开发了一套后台管理系统。<br>##创建新的app<br>后台管理属于一个单独的模块，我们创建一个新的应用，命名为myadmin</p><pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell">python3 manage.py startapp myadmin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>之后的功能都是基于myadmin来实现的。</p><p>因为前面我们已经创建了user模块，所以此处的登录功能是基于之前的user模块来实现的。<br>##添加路由<br>首先在myadmin/urls.py中添加登录和登出的路由</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> viewsapp_name <span class="token operator">=</span> <span class="token string">'myadmin'</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'login/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>login<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'logout/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>logout<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'logout'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们来写login函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth <span class="token keyword">import</span> authenticate<span class="token punctuation">,</span> login <span class="token keyword">as</span> auth_login<span class="token punctuation">,</span> logout <span class="token keyword">as</span> auth_logout<span class="token comment"># 复用userprofile中的UserLoginForm</span><span class="token keyword">from</span> userprofile<span class="token punctuation">.</span>forms <span class="token keyword">import</span> UserLoginForm<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        form <span class="token operator">=</span> UserLoginForm<span class="token punctuation">(</span>request<span class="token operator">=</span>request<span class="token punctuation">,</span> data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            username <span class="token operator">=</span> form<span class="token punctuation">.</span>cleaned_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>            password <span class="token operator">=</span> form<span class="token punctuation">.</span>cleaned_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>            user <span class="token operator">=</span> authenticate<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">,</span> password<span class="token operator">=</span>password<span class="token punctuation">)</span>            <span class="token keyword">if</span> user <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> user<span class="token punctuation">.</span>is_staff<span class="token punctuation">:</span>                auth_login<span class="token punctuation">(</span>request<span class="token punctuation">,</span> user<span class="token punctuation">)</span>                <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'myadmin:index'</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                form<span class="token punctuation">.</span>add_error<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'请输入管理员账号'</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        form <span class="token operator">=</span> UserLoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'myadmin/login.html'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首先这里复用了之前创建的 表单UserLoginForm<br>这里我们使用了user模型中的一个字段is_staff，用它来表示是否是管理员，<br>所以通过if user is not None and user.is_staff来判断管理员，如果是管理员，则auth_login登录并redirect跳转到主页。</p><p>下面我们来实现logout函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    auth_logout<span class="token punctuation">(</span>request<span class="token punctuation">)</span>    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'myadmin:login'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>登出后，直接跳转到login页面。</p>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step4前端页面整合</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step4-qian-duan-ye-mian-zheng-he/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step4-qian-duan-ye-mian-zheng-he/</url>
      
        <content type="html"><![CDATA[<p>#前端页面整合<br>在本讲中，我们开始前端页面整合</p><p>在开发过程中，前端页面也很重要，本次内容简单的对前面三节内容的前端页面做一个简单的整合</p><p>尘归尘，土归土，内容整理之后会讲内容看的更加清晰</p><h1 id="基础页面"><a href="#基础页面" class="headerlink" title="基础页面"></a>基础页面</h1><p>基础页面包括，header base footer三个部分</p><h2 id="base页面"><a href="#base页面" class="headerlink" title="base页面"></a>base页面</h2><p>所有的页面都起始于这个页面</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&#123;% load static %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html; charset=UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>基于Django的视综合网站<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>   <span class="token comment">&lt;!-- 当前页面网站标题 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>&#123;% block title %&#125;&#123;% endblock %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 引入semantic-ui文件        --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>semantic-ui/semantic.min.css<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>css/semantic.custom.css<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>css/style.css<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    &#123;% block css %&#125;&#123;% endblock css %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>&#123;% include "base/header.html" %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui container<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>v-content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    &#123;% block content %&#125;    &#123;% endblock content %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&lt;<span class="token comment">&lt;!-- 引入注脚 --></span>&#123;% include "base/footer.html" %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>semantic-ui/semantic.min.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>&#123;% block script %&#125; &#123;% endblock script %&#125;&#123;% block modal %&#125; &#123;% endblock modal %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个页面可以分为几个部分<br>head 内容， 引入基础的设置，然后时页面标题， 必要的前端布局文件 其他的css文件<br>body 部分， 先是导入header 文件， 留下cotent内容，其他页面导入的部分，都放在这个地方</p><p>footer内容  必要的footer内容， 然后引入JavaScript内容，其他的script内容和modal内容</p><h2 id="header页面"><a href="#header页面" class="headerlink" title="header页面"></a>header页面</h2><p>header 页面放入 导航栏内容， 以及菜单栏内容<br>这里做个示范，后面会进行修改</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&#123;% load static %&#125; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui inverted menu<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>header item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Brand<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>active item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Vitae<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui dropdown item<span class="token punctuation">"</span></span> <span class="token attr-name">tabindex</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            Dropdown<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown icon<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>menu<span class="token punctuation">"</span></span> <span class="token attr-name">tabindex</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Action<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Another Action<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Something else here<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>divider<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Separated Link<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>divider<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>One more separated link<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>right menu<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>v-header-extra<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        &#123;% include "base/menu.html" %&#125;     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="footer页面"><a href="#footer页面" class="headerlink" title="footer页面"></a>footer页面</h2><p>footer页面一般放一些备案信息，网站名字，logo,相关链接等</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&#123;% load static %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui vertical footer segment <span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui center aligned container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui divider<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--        &lt;img src="&#123;% static 'img/logo.png' %&#125;" class="ui centered mini image">--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui horizontal   small divided link list<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>自主开发博客综合网站公司<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>联系我们<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>京ICP证090287<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>#分类页面</p><p>##用户界面</p><p>它在registration文件夹下<br>登录页面， 继承base文件夹的base内容，然后添加自己的内容</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&#123;% extends "base/base.html" %&#125;&#123;% load static %&#125;&#123;% block title %&#125; 登录 &#123;% endblock title %&#125;&#123;% block content %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>v-account-body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui middle aligned center aligned grid<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>column v-account<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui teal image header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                登录账户        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui large form<span class="token punctuation">"</span></span> <span class="token attr-name">novalidate</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>userprofile:login<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span>              <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            &#123;% csrf_token %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui stacked segment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>field<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui left icon input<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user icon<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>                        &#123;&#123;form.username&#125;&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>field<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui left icon input<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lock icon<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>                        &#123;&#123;form.password&#125;&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>next<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; next &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui fluid large teal submit button<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>            &#123;% include "base/form_errors.html" %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                还没有账号？<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>userprofile:signup<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="视频界面"><a href="#视频界面" class="headerlink" title="视频界面"></a>视频界面</h2>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step2注册登录功能</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step2-zhu-ce-deng-lu-gong-neng/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step2-zhu-ce-deng-lu-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>#注册登录功能</p><p>用户注册登录是一个网站的基本功能，django对这部分进行了很好的封装，</p><p>我们只需要在django的基础上做些简单的修改就可以达到我们想要的效果。</p><p>在本讲中，我们会用到user中的用户授权方面的一些函数，还会对django中的user进行扩展，以及django中的form验证。</p><p>#创建users应用</p><p>django的设计哲学是，一个应用只提供一种功能，比如users应用只提供用户相关功能，comment应用只提供评论相关功能，</p><p>这能提高代码的重复利用率。</p><p>在django中，只需要下面一条命令，即可建立users应用</p><pre><code>python3 manage.py startapp userprofile</code></pre><p>###建表</p><p>我们需要一个用户表，用来实现登录注册功能，虽然django已经自带来用户登录注册功能，也有相应的表，但是不符合中国人习惯，需要我们对user模型进行自定义。</p><p>实现自定义User模型最简单的方式就是继承AbstractBaseUser，AbstractBaseUser实现了User的核心功能，我们只需加一些额外的字段进行补充即可。</p><p>User模型原有的字段有：</p><pre><code>usernamepasswordlast_loginis_superuserfirst_namelast_nameemailis_staffis_activedate_joined</code></pre><p>这些都是最基本的字段，并不能满足我们的需求。</p><p>根据网站自身业务，我们又添加了下面的字段</p><pre><code>nickname(昵称)avatar(头像)mobile(手机号)gender(性别)subscribe(是否订阅)</code></pre><p>我们只需在userprofile/models.py中写入代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> AbstractUser<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>AbstractUser<span class="token punctuation">)</span><span class="token punctuation">:</span>    GENDER_CHOICES <span class="token operator">=</span> <span class="token punctuation">(</span>        <span class="token punctuation">(</span><span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'女'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    nickname <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>    avatar <span class="token operator">=</span> models<span class="token punctuation">.</span>FileField<span class="token punctuation">(</span>upload_to<span class="token operator">=</span><span class="token string">'avatar/'</span><span class="token punctuation">)</span>    mobile <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">)</span>    gender <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> choices<span class="token operator">=</span>GENDER_CHOICES<span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    subscribe <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        db_table <span class="token operator">=</span> <span class="token string">"tb_user"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>gender是性别字段，其中用到了choices=GENDER_CHOICES。这种方式常常用在下拉框或单多选框，例如 M对应男 F对应女。</code></pre><p>##url配置</p><p>在userprofile文件夹下面，新建urls.py文件，写入登录、注册和退出的url信息。</p><p>app_name是命名空间，我们命名为‘users’。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> viewsapp_name <span class="token operator">=</span> <span class="token string">'userprofile'</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'login/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>login<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'signup/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>signup<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'signup'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'logout/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>logout<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'logout'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同时更改主路由表，即修改工程文件下的urls.py</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> includeurlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'userprofile/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'userprofile.urls'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后需要注册这个APP， 在admin.py 中添加信息如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Useradmin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>同时将这个app注册到设置中，在setting文件中添加</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">'django.contrib.admin'</span><span class="token punctuation">,</span>    <span class="token string">'django.contrib.auth'</span><span class="token punctuation">,</span>    <span class="token string">'django.contrib.contenttypes'</span><span class="token punctuation">,</span>    <span class="token string">'django.contrib.sessions'</span><span class="token punctuation">,</span>    <span class="token string">'django.contrib.messages'</span><span class="token punctuation">,</span>    <span class="token string">'django.contrib.staticfiles'</span><span class="token punctuation">,</span>    <span class="token string">'users'</span><span class="token punctuation">,</span>   <span class="token comment"># 添加users这个app</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>否则可能会报错</p><pre class="line-numbers language-none"><code class="language-none">RuntimeError: Model class apps.users.models.User doesn&#39;t declare an explicit app_label and isn&#39;t in an application in INSTALLED_APPS.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>同时，由于我们将要复写django自带的User类，需要添加配置信息到setting中</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">AUTH_USER_MODEL <span class="token operator">=</span> <span class="token string">'userprofile.User'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre><code>让Django中自带的user不起作用即可</code></pre><p>否则会出现如下错误：</p><pre><code>auth.User.groups: (fields.E304) Reverse accessor for &#39;User.groups&#39; clasheswith reverse accessor for &#39;UserProfile.groups&#39;.</code></pre><p>url路由配置好了，我们下面就开始写视图函数代码了<br>##注册表单</p><p>我们先来写注册函数，写注册，当然得有注册表单了，幸运的是，在django中，可以用代码来生成表单。</p><p>我们只需在userprofile下新建forms.py文件，然后写入注册表单的代码。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django <span class="token keyword">import</span> forms<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>forms <span class="token keyword">import</span> UserCreationForm<span class="token punctuation">,</span> AuthenticationForm<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token keyword">class</span> <span class="token class-name">UserLoginForm</span><span class="token punctuation">(</span>AuthenticationForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>max_length<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>                               error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                   <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'用户名不少于4个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'max_length'</span><span class="token punctuation">:</span> <span class="token string">'用户名不能多于30个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'用户名不能为空'</span><span class="token punctuation">,</span>                               <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                               widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入用户名'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    password <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>max_length<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>                               error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                   <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'密码不少于8个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'max_length'</span><span class="token punctuation">:</span> <span class="token string">'密码不能多于30个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'密码不能为空'</span><span class="token punctuation">,</span>                               <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                               widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>PasswordInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入密码'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> User        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">]</span>    error_messages <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'invalid_login'</span><span class="token punctuation">:</span> <span class="token string">'用户名或密码错误'</span><span class="token punctuation">,</span> <span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">SignUpForm</span><span class="token punctuation">(</span>UserCreationForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>                               error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                   <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'用户名不少于4个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'max_length'</span><span class="token punctuation">:</span> <span class="token string">'用户名不能多于30个字符'</span><span class="token punctuation">,</span>                                   <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'用户名不能为空'</span><span class="token punctuation">,</span>                               <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                               widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入用户名'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    password1 <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>                                error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                    <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'密码不少于8个字符'</span><span class="token punctuation">,</span>                                    <span class="token string">'max_length'</span><span class="token punctuation">:</span> <span class="token string">'密码不能多于30个字符'</span><span class="token punctuation">,</span>                                    <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'密码不能为空'</span><span class="token punctuation">,</span>                                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                                widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>PasswordInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请输入密码'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    password2 <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>max_length<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>                                error_messages<span class="token operator">=</span><span class="token punctuation">&#123;</span>                                    <span class="token string">'min_length'</span><span class="token punctuation">:</span> <span class="token string">'密码不少于8个字符'</span><span class="token punctuation">,</span>                                    <span class="token string">'max_length'</span><span class="token punctuation">:</span> <span class="token string">'密码不能多于30个字符'</span><span class="token punctuation">,</span>                                    <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token string">'密码不能为空'</span><span class="token punctuation">,</span>                                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                                widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>PasswordInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'placeholder'</span><span class="token punctuation">:</span> <span class="token string">'请确认密码'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> User        fields <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'password1'</span><span class="token punctuation">,</span> <span class="token string">'password2'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>    error_messages <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'password_mismatch'</span><span class="token punctuation">:</span> <span class="token string">'两次密码不一致'</span><span class="token punctuation">,</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们的表单一共有三个字段：username、password1、password2，它们都是CharField类型，widget分别是TextInput和PasswordInput。</p><p>而且django是自带验证的，只需要我们配置好error_messages字典，当form验证的时候，就会显示我们自定义的错误信息。<br>有了注册表单后，就可以在前端模板和视图函数中使用它。<br>###注册视图<br>下面是注册视图函数。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth <span class="token keyword">import</span> authenticate<span class="token punctuation">,</span> login <span class="token keyword">as</span> auth_login<span class="token punctuation">,</span> logout <span class="token keyword">as</span> auth_logout<span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> SignUpForm<span class="token punctuation">,</span> UserLoginForm<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">def</span> <span class="token function">signup</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        form <span class="token operator">=</span> SignUpForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            form<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>            username <span class="token operator">=</span> form<span class="token punctuation">.</span>cleaned_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>            raw_password1 <span class="token operator">=</span> form<span class="token punctuation">.</span>cleaned_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password1'</span><span class="token punctuation">)</span>            user <span class="token operator">=</span> authenticate<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">,</span> password<span class="token operator">=</span>raw_password1<span class="token punctuation">)</span>            auth_login<span class="token punctuation">(</span>request<span class="token punctuation">,</span> user<span class="token punctuation">)</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>form<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        form <span class="token operator">=</span> SignUpForm<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'registration/signup.html'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    auth_logout<span class="token punctuation">(</span>request<span class="token punctuation">)</span>    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在signup函数中，我们通过form = SignUpForm初始化一个表单，并在render函数中传递给模板。</p><p>注册模板文件写在了templates/registration/signup.html</p><p>关键代码是</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui large form<span class="token punctuation">"</span></span> <span class="token attr-name">novalidate</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>userprofile:signup<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>            &#123;% csrf_token %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui stacked segment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>field<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                     &#123;&#123;form.username&#125;&#125;                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>field<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                     &#123;&#123;form.password1&#125;&#125;                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>field<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                     &#123;&#123;form.password2&#125;&#125;                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui submit button<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>            &#123;% include "base/form_errors.html" %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>form的action为</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&#123;% url 'users:signup' %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>即在url.py中定义的signup函数。<br>通过post请求传递给signup，在signup中，通过如下四行代码来实现注册，并自动登录的。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">username <span class="token operator">=</span> form<span class="token punctuation">.</span>cleaned_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>raw_password1 <span class="token operator">=</span> form<span class="token punctuation">.</span>cleaned_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password1'</span><span class="token punctuation">)</span>user <span class="token operator">=</span> authenticate<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">,</span> password<span class="token operator">=</span>raw_password1<span class="token punctuation">)</span>auth_login<span class="token punctuation">(</span>request<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>###登录函数</p><p>登录函数与注册函数的模式是一样的，都是先写form，写模板，最后写视图函数。<br>由于form和模板的代码和注册功能类似，这里就不贴了，大家可以上github查看。</p><p>重点讲一下login视图函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        next_url <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>        form <span class="token operator">=</span> UserLoginForm<span class="token punctuation">(</span>request<span class="token operator">=</span>request<span class="token punctuation">,</span> data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            username <span class="token operator">=</span> form<span class="token punctuation">.</span>cleaned_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>            password <span class="token operator">=</span> form<span class="token punctuation">.</span>cleaned_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>            user <span class="token operator">=</span> authenticate<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">,</span> password<span class="token operator">=</span>password<span class="token punctuation">)</span>            <span class="token keyword">if</span> user <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>                auth_login<span class="token punctuation">(</span>request<span class="token punctuation">,</span> user<span class="token punctuation">)</span>                <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>next_url<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>form<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        next_url <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>        form <span class="token operator">=</span> UserLoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>next_url<span class="token punctuation">)</span>    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'registration/login.html'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">,</span> <span class="token string">'next'</span><span class="token punctuation">:</span> next_url<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>```    在login函数中，我们多了一个next_url变量，<span class="token builtin">next</span>对应的是登录后要跳转的url，其实这是一种场景，假如你在购物网站买东西，最后付款的时候，会跳转到付款页，假如你没有登录，网站会提示你登录，登录后，会再次跳转到付款页。当然了，跳转到登录页的时候，需要你在url后追加next_url参数，如 aaa<span class="token punctuation">.</span> com<span class="token operator">/</span>login<span class="token operator">/</span>?next_url<span class="token operator">=</span>bbb<span class="token punctuation">.</span> com这样用户登录后就会跳到bbb<span class="token punctuation">.</span> com<span class="token comment">###退出函数</span>```python<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth <span class="token keyword">import</span> authenticate<span class="token punctuation">,</span> login <span class="token keyword">as</span> auth_login<span class="token punctuation">,</span> logout <span class="token keyword">as</span> auth_logout<span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    auth_logout<span class="token punctuation">(</span>request<span class="token punctuation">)</span>    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>退出功能，仅需要一行代码 auth_logout(request) 就ok了。</p><p>##其他<br>###静态文件的配置<br>需要的静态文件都存放到static这个文件夹下统一管理<br>包含三个方面css img  js </p><p>在settings中添加如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">STATIC_URL <span class="token operator">=</span> <span class="token string">'/static/'</span>STATICFILES_DIRS <span class="token operator">=</span> <span class="token punctuation">(</span>    os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">"static"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>使用的semantic-ui插件<br>Semantic UI</p><p>这是一个语义化的UI框架，界面做的比较好，风格和bootstrap有点像，比较适用于响应式开发。</p><p>这个插件里面有一些访问谷歌的内容，直接引用的话，国内网络可能有的内容访问不了，或者加载比较慢<br><a href="https://cdn.bootcdn.net/ajax/libs/semantic-ui/2.4.1/semantic.min.css">https://cdn.bootcdn.net/ajax/libs/semantic-ui/2.4.1/semantic.min.css</a></p><p>所以最好还是从github上把这个插件下载下来，点击这里进入github <a href="https://github.com/Semantic-Org/Semantic-UI">https://github.com/Semantic-Org/Semantic-UI</a><br>直接把整个项目作为zip下载下来。</p><p>在dist文件夹中将semantic.min.js和semantic.min.css复制到文件夹中，这里文件夹的结构和上面的Element-UI差不多，新建一个semantic-ui文件夹放置。</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- 引入semantic-ui文件        --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>semantic-ui/semantic.min.css<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>semantic-ui/semantic.min.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>css/semantic.custom.css<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>css/style.css<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>###template文件的配置<br>所有视图文件即views文件统一放入templates文件夹下<br>将其添加到设置中</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">TEMPLATES <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>        <span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.template.backends.django.DjangoTemplates'</span><span class="token punctuation">,</span>        <span class="token string">'DIRS'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'templates'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 配置视图文件</span>        <span class="token string">'APP_DIRS'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>        <span class="token string">'OPTIONS'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'context_processors'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>                <span class="token string">'django.template.context_processors.debug'</span><span class="token punctuation">,</span>                <span class="token string">'django.template.context_processors.request'</span><span class="token punctuation">,</span>                <span class="token string">'django.contrib.auth.context_processors.auth'</span><span class="token punctuation">,</span>                <span class="token string">'django.contrib.messages.context_processors.messages'</span><span class="token punctuation">,</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django综合篇之自定义Command生成初始数据</title>
      <link href="/post/django-quan-wang-zhan-da-jian/django-zong-he-pian-zhi-zi-ding-yi-command-sheng-cheng-chu-shi-shu-ju/"/>
      <url>/post/django-quan-wang-zhan-da-jian/django-zong-he-pian-zhi-zi-ding-yi-command-sheng-cheng-chu-shi-shu-ju/</url>
      
        <content type="html"><![CDATA[<p>#Django–自定义 Command 命令<br>Django 对于命令的添加有一套规范，你可以为每个app 指定命令。</p><p>通俗一点讲，比如在使用manage.py文件执行命令的时候，可以自定制自己的命令，来实现命令的扩充。</p><p>##commands的创建</p><pre><code>1.在app内创建一个management的python目录2.在management目录里面创建commands的python文件夹3.在commands文件夹下创建任意py文件</code></pre><p>此时py文件名就是你的自定制命令，可以使用下面方式执行</p><pre class="line-numbers language-shell" data-language="shell"><div class="caption"><span>script</span></div><code class="language-shell">python manage.py 命令名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Django的Command命令是要放在一个app的management/commands目录下的。</p><p>请确保management和management/commands目录内都包含__init__.py文件</p><p>  首先对于文件名没什么要求，内部需要定义一个Command类并继承BaseCommand类或其子类。</p><p>它必须定义一个Command类并扩展自BaseCommand或其子类。</p><pre><code>其中help是command功能作用简介，handle函数是主处理程序，add_arguments函数是用来接收可选参数的</code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>management<span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseCommand<span class="token punctuation">,</span> CommandError<span class="token keyword">from</span> article<span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticlePost  自己的<span class="token keyword">class</span> <span class="token class-name">Command</span><span class="token punctuation">(</span>BaseCommand<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">'Closes the specified article_id'</span>    <span class="token keyword">def</span> <span class="token function">add_arguments</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">:</span>        parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'article_id'</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> article_id <span class="token keyword">in</span> options<span class="token punctuation">[</span><span class="token string">'article_id'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span>article_id<span class="token punctuation">)</span>            <span class="token keyword">except</span> Poll<span class="token punctuation">.</span>DoesNotExist<span class="token punctuation">:</span>                <span class="token keyword">raise</span> CommandError<span class="token punctuation">(</span><span class="token string">'article "%s" does not exist'</span> <span class="token operator">%</span> article_id<span class="token punctuation">)</span>            poll<span class="token punctuation">.</span>opened <span class="token operator">=</span> <span class="token boolean">False</span>            poll<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'Successfully closed article "%s"'</span> <span class="token operator">%</span> article_id<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可选参数</p><p>可使用add_argument（）方法：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># __author__ = 'dandy'</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>management<span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseCommand<span class="token keyword">class</span> <span class="token class-name">Command</span><span class="token punctuation">(</span>BaseCommand<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">add_arguments</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">:</span>        parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>        parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--delete'</span><span class="token punctuation">,</span>                            action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>                            dest<span class="token operator">=</span><span class="token string">'delete'</span><span class="token punctuation">,</span>                            default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>                            <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Delete poll instead of closing it'</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>options里面直接取参数就可以了。<br>方法<br>返回django版本号：BaseCommand.get_version()<br>命令的真正逻辑。子类必须实现这个方法。：BaseCommand.handle()</p><p>##将本地内容最为初始数据写入文章</p><p>最主要的就是获取本地文章列表</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">current_article_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'md'</span><span class="token punctuation">)</span><span class="token comment"># 通过BASE_DIR 找到存贮文章的目录</span><span class="token keyword">print</span><span class="token punctuation">(</span>current_article_dir<span class="token punctuation">)</span>article_lists <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>getstatusoutput<span class="token punctuation">(</span><span class="token string">'ls %s'</span> <span class="token operator">%</span> current_article_dir<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>  <span class="token comment">#通过subprocess 命令得到当前目录下的内容</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>最终实现：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">import</span> subprocess<span class="token keyword">from</span> myblog<span class="token punctuation">.</span>settings <span class="token keyword">import</span> BASE_DIR<span class="token keyword">from</span> article<span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticlePost<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth <span class="token keyword">import</span> get_user_model<span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>management<span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseCommand<span class="token keyword">class</span> <span class="token class-name">Command</span><span class="token punctuation">(</span>BaseCommand<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">'create blog data'</span>    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">)</span><span class="token punctuation">:</span>        user <span class="token operator">=</span> get_user_model<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_or_create<span class="token punctuation">(</span>            email<span class="token operator">=</span><span class="token string">'test@test.com'</span><span class="token punctuation">,</span> username<span class="token operator">=</span><span class="token string">'测试用户'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'test123456'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        current_article_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'md'</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>current_article_dir<span class="token punctuation">)</span>        article_lists <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>getstatusoutput<span class="token punctuation">(</span><span class="token string">'ls %s'</span> <span class="token operator">%</span> current_article_dir<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> article_lists<span class="token punctuation">:</span>            title <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            f_flag <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>current_article_dir<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>            body <span class="token operator">=</span> f_flag<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>            f_flag<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_or_create<span class="token punctuation">(</span>                title<span class="token operator">=</span>title<span class="token punctuation">,</span>                body<span class="token operator">=</span>body<span class="token punctuation">,</span>                author<span class="token operator">=</span>user<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            article<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span>self<span class="token punctuation">.</span>style<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">(</span><span class="token string">'create blog data \n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Django全网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--38.模板过滤器和标签</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/38.mo-ban-guo-lu-qi-he-biao-qian/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/38.mo-ban-guo-lu-qi-he-biao-qian/</url>
      
        <content type="html"><![CDATA[<p>现在我们已经很熟悉Django的MTV模式了。模板（template）负责如何去展示数据，而视图（view）负责筛选出正确的数据。因此通常来说逻辑都是放到视图中的，但模板也需要一些<strong>和表示相关的逻辑</strong>：比如循环展示（如<code>&#123;% for ... %&#125;</code>）、或者以某种特定格式输出（如<code>&#123;&#123; ...|date:'Y-m-d' &#125;&#125;</code>）等，这些功能都是靠模板的<strong>过滤器（filters）</strong>和<strong>标签（tags）</strong>实现的。</p><p>Django的模板语言包含了很多内置的过滤器和标签，设计目的是满足应用需要占位逻辑需求。但有的时候这些通用的功能满足不了你的某些需求，这时候就需要自定义过滤器和标签来实现了。</p><h2 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h2><p>要在Django中使用模板过滤器或标签，就首先得<strong>注册</strong>它们。</p><p>注册方法如下：</p><ul><li>在APP中新建名为<code>templatetags</code>的目录（方便起见，教程选择了<code>article</code>这个APP）</li><li>在此目录中新建名为<code>__init__.py</code>的空文件，使得此目录被视作一个Python的包</li><li>在此目录中新建python文件（比如<code>my_filters_and_tags.py</code>），就可以在里面愉快的写代码啦</li></ul><p>完成后的目录结构如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>    __init__<span class="token punctuation">.</span>py    views<span class="token punctuation">.</span>py    models<span class="token punctuation">.</span>py    <span class="token comment"># 新增目录</span>    templatetags<span class="token operator">/</span>        __init__<span class="token punctuation">.</span>py  <span class="token comment"># 空文件</span>        my_filters_and_tags<span class="token punctuation">.</span>py  <span class="token comment"># 即将写代码的地方</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>请注意</strong>：</p><ul><li>目录必须位于已注册的APP中，这是出于安全性的考虑</li><li>新建目录后，必须手动重启服务器，里面的过滤器和标签才能生效</li></ul><p>前置条件就完成了，然后需要将其添加到配置文件中去</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">TEMPLATES <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token string">'OPTIONS'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'context_processors'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                   <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token string">'libraries'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>                <span class="token string">'my_customs_tag'</span><span class="token punctuation">:</span> <span class="token string">'yourappname.templatetags.yourfiletername'</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来我们看看如何写一个模板过滤器。</p><h2 id="模板过滤器"><a href="#模板过滤器" class="headerlink" title="模板过滤器"></a>模板过滤器</h2><p>过滤器<code>filter</code>的表现形式为紧跟在上下文后面的管道符<code>|</code>，管道符后面是filter的名称：<code>&#123;&#123; ...|filter_name &#125;&#125;</code>。有的filter还可以带有参数：<code>&#123;&#123; ...|filter_name:var &#125;&#125;</code>。</p><blockquote><p>注意过滤器名称的冒号后面不能有空格。</p></blockquote><p><code>filter</code>这个名字可能会让你误认为它只是用来筛选某些特定数据的，但实际上它远不止这点功能。它可以改变上下文的最终展示效果，也可以将上下文通过运算输出为特定的值。</p><h3 id="小试牛刀"><a href="#小试牛刀" class="headerlink" title="小试牛刀"></a>小试牛刀</h3><p>要成为一个可用的<code>filter</code>，文件中必须包含一个名为 <code>register</code> 的模块级变量，它是一个 <code>template.Library</code> 实例，所有的<code>filters</code>均在其中注册。所以在<code>my_filter_and_tags.py</code>文件中输入以下内容:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>templatetags<span class="token operator">/</span>my_filters_and_tags<span class="token punctuation">.</span>py<span class="token keyword">from</span> django <span class="token keyword">import</span> templateregister <span class="token operator">=</span> template<span class="token punctuation">.</span>Library<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>接下来就可以像写普通的Python函数一样写过滤器了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>templatetags<span class="token operator">/</span>my_filters_and_tags<span class="token punctuation">.</span>py<span class="token keyword">from</span> django <span class="token keyword">import</span> templateregister <span class="token operator">=</span> template<span class="token punctuation">.</span>Library<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@register<span class="token punctuation">.</span>filter</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'transfer'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">transfer</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""将输出强制转换为字符串 arg """</span>    <span class="token keyword">return</span> arg<span class="token decorator annotation punctuation">@register<span class="token punctuation">.</span>filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">lower</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""将字符串转换为小写字符"""</span>    <span class="token keyword">return</span> value<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>filter可以通过装饰器进行注册。若注册装饰器中携带了<code>name</code>参数，则其值为此filter的名称；若未携带，则函数名就是filter的名称。</li><li>filter必须是有一到两个参数的Python函数。第一个参数是上下文本身，第二个参数则由filter提供。举个栗子，在过滤器 <code>&#123;&#123; var|foo:"bar" &#125;&#125;</code> 中，变量 <code>var</code> 为第一个参数，变量 <code>bar</code> 则作为第二个参数。</li></ul><p>调用这些filter的方法是在模板文件中用<code>&#123;% load ... %&#125;</code>将filter文件的名称加载进去，像这样：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 任意模板文件中</span><span class="token punctuation">&#123;</span><span class="token operator">%</span> load my_filters_and_tags <span class="token operator">%</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> <span class="token string">'ABC'</span><span class="token operator">|</span>transfer<span class="token punctuation">:</span><span class="token string">'cool'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>  <span class="token comment"># 输出：'cool'</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> <span class="token string">'ABC'</span><span class="token operator">|</span>lower <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>  <span class="token comment"># 输出： 'abc'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="更人性化的时间"><a href="#更人性化的时间" class="headerlink" title="更人性化的时间"></a>更人性化的时间</h3><p>了解完filter的使用方法后，下面来写点更实用的功能。</p><p>对人类这种生物来说，<strong>相对时间</strong>通常比<strong>绝对时间</strong>要更容易阅读。<code>发表于 3天前</code>可以轻易得知此文章刚发表不久；而<code>发表于 2019年8月10日</code>你还得想想今天到底几号来着。</p><p>因此写一个显示相对日期的<code>time_since_zh</code>过滤器：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>templatetags<span class="token operator">/</span>my_filters_and_tags<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone<span class="token keyword">import</span> math<span class="token comment"># 获取相对时间</span><span class="token decorator annotation punctuation">@register<span class="token punctuation">.</span>filter</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'timesince_zh'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">time_since_zh</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>    now <span class="token operator">=</span> timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>    diff <span class="token operator">=</span> now <span class="token operator">-</span> value    <span class="token keyword">if</span> diff<span class="token punctuation">.</span>days <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> diff<span class="token punctuation">.</span>seconds <span class="token operator">>=</span> <span class="token number">0</span> <span class="token keyword">and</span> diff<span class="token punctuation">.</span>seconds <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'刚刚'</span>    <span class="token keyword">if</span> diff<span class="token punctuation">.</span>days <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> diff<span class="token punctuation">.</span>seconds <span class="token operator">>=</span> <span class="token number">60</span> <span class="token keyword">and</span> diff<span class="token punctuation">.</span>seconds <span class="token operator">&lt;</span> <span class="token number">3600</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>diff<span class="token punctuation">.</span>seconds <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"分钟前"</span>    <span class="token keyword">if</span> diff<span class="token punctuation">.</span>days <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> diff<span class="token punctuation">.</span>seconds <span class="token operator">>=</span> <span class="token number">3600</span> <span class="token keyword">and</span> diff<span class="token punctuation">.</span>seconds <span class="token operator">&lt;</span> <span class="token number">86400</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>diff<span class="token punctuation">.</span>seconds <span class="token operator">/</span> <span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"小时前"</span>    <span class="token keyword">if</span> diff<span class="token punctuation">.</span>days <span class="token operator">>=</span> <span class="token number">1</span> <span class="token keyword">and</span> diff<span class="token punctuation">.</span>days <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>diff<span class="token punctuation">.</span>days<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"天前"</span>    <span class="token keyword">if</span> diff<span class="token punctuation">.</span>days <span class="token operator">>=</span> <span class="token number">30</span> <span class="token keyword">and</span> diff<span class="token punctuation">.</span>days <span class="token operator">&lt;</span> <span class="token number">365</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>diff<span class="token punctuation">.</span>days <span class="token operator">/</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"个月前"</span>    <span class="token keyword">if</span> diff<span class="token punctuation">.</span>days <span class="token operator">>=</span> <span class="token number">365</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>diff<span class="token punctuation">.</span>days <span class="token operator">/</span> <span class="token number">365</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"年前"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码功能很简单，就是将文章发布时间和当前时间作比较，然后返回适当的字符串。</p><p>修改文章列表模板文件中与发布时间相关的代码，把刚写的filter用上：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html...&#123;% load my_filters_and_tags %&#125;...<span class="token comment">&lt;!-- 旧代码&#123;&#123; article.created|date:'Y-m-d' &#125;&#125;--></span><span class="token comment">&lt;!-- 新代码 --></span>&#123;&#123; article.created|timesince_zh &#125;&#125;...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>效果如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190813/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE231.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190813/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE231.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><blockquote><p>实际上Django内置了一个<code>timesince</code>过滤器，只不过显示日期是英文的，不够友好。</p></blockquote><h2 id="模板标签"><a href="#模板标签" class="headerlink" title="模板标签"></a>模板标签</h2><p>模板标签（tag）比过滤器更复杂，功能也更强大。</p><p>标签<code>tag</code>的表现形式为<code>&#123;% tag_name ... %&#125;</code>，比如我们非常熟悉的内置标签<code>&#123;% url ... %&#125;</code>、<code>&#123;% static ... %&#125;</code>等。如果内置标签满足不了你的需求，Django 提供了很多快捷方式，简化了编写绝大多数类型的标签过程。</p><h3 id="简单标签"><a href="#简单标签" class="headerlink" title="简单标签"></a>简单标签</h3><p><code>simple_tag</code>就是最重要的标签类型。标签的注册方法跟过滤器非常类似：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@register<span class="token punctuation">.</span>simple_tag</span><span class="token keyword">def</span> <span class="token function">change_http_to_https</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>    new_url <span class="token operator">=</span> url<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'http://'</span><span class="token punctuation">,</span> <span class="token string">'https://'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> new_url<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>调用时同样记得在模板文件中用<code>&#123;% load... %&#125;</code>引入。用法你应该猜得到：<code>&#123;% change_http_to_https ... %&#125;</code>，这个标签的作用是将http链接替换为https链接。</p><blockquote><p>用 Django-allauth 进行微博登录，默认返回的用户头像是 http 链接（虽然微博有 https 版本的头像）。如果你的站点已经升级为 https 了，又不想花时间去研究微博的接口，那么这个标签就可以派上用场了。</p><p>顺带一说， Django-allauth 第三方登录的头像 url 保存在 <code>User.socialaccount_set.all.0.get_avatar_url</code> 中。</p></blockquote><p>下面这个例子可以返回指定格式的时间字符串：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> datetime<span class="token decorator annotation punctuation">@register<span class="token punctuation">.</span>simple_tag</span><span class="token keyword">def</span> <span class="token function">current_time</span><span class="token punctuation">(</span>format_string<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>format_string<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用时你可以将其保存为模板变量，以便你在期望的位置多次调用：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token operator">%</span> current_time <span class="token string">"%Y-%m-%d %I:%M %p"</span> <span class="token keyword">as</span> the_time <span class="token operator">%</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span>p<span class="token operator">></span>The time <span class="token keyword">is</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> the_time <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span><span class="token operator">&lt;</span>p<span class="token operator">></span>Again<span class="token punctuation">,</span> the time <span class="token keyword">is</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> the_time <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>模板标签也可以访问当前的上下文，只需要在注册标签时传入<code>takes_context</code>参数:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@register<span class="token punctuation">.</span>simple_tag</span><span class="token punctuation">(</span>takes_context<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">current_time</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> format_string<span class="token punctuation">)</span><span class="token punctuation">:</span>    timezone <span class="token operator">=</span> context<span class="token punctuation">[</span><span class="token string">'timezone'</span><span class="token punctuation">]</span>    <span class="token keyword">return</span> your_get_current_time_method<span class="token punctuation">(</span>timezone<span class="token punctuation">,</span> format_string<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>注意，第一个参数必须是<code>context</code>。</p><p>与过滤器不同的是，标签可以接受任意数量的位置或关键字参数。例如:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@register<span class="token punctuation">.</span>simple_tag</span><span class="token keyword">def</span> <span class="token function">my_tag</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>    warning <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">'warning'</span><span class="token punctuation">]</span>    profile <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">'profile'</span><span class="token punctuation">]</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在模板中调用时，任意数量的、以空格分隔的参数会被传递给模板标签。与 Python 中类似，关键字参数的赋值使用等号（”<code>=</code>“），且必须在位置参数后提供：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token operator">%</span> my_tag <span class="token number">123</span> <span class="token string">"abcd"</span> book<span class="token punctuation">.</span>title warning<span class="token operator">=</span>message profile<span class="token operator">=</span>user<span class="token punctuation">.</span>profile <span class="token operator">%</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="包含标签"><a href="#包含标签" class="headerlink" title="包含标签"></a>包含标签</h3><p>包含标签可以让另一个模板为当前模板渲染数据。听起来比较拗口，还是通过例子来理解。</p><p>假设现在有一个需求，是要在文章详情页面中，显示所有相关评论的发布时间。因此在<code>my_filters_and_tags.py</code>中写入：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_filters_and_tags<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token decorator annotation punctuation">@register<span class="token punctuation">.</span>inclusion_tag</span><span class="token punctuation">(</span><span class="token string">'article/tag_list.html'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show_comments_pub_time</span><span class="token punctuation">(</span>article<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""显示文章评论的发布时间"""</span>    comments <span class="token operator">=</span> article<span class="token punctuation">.</span>comments<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'comments'</span><span class="token punctuation">:</span> comments<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>函数传入的参数可以是模板中的上下文变量。函数体内部取得了所有相关评论的查询集，然后把结果<code>comments</code>返回。注意返回结果是进入到<code>tag_list.html</code>这个模板中去了，因此新建它并写入：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/tag_list.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>&#123;% for comment in comments %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span> &#123;&#123; comment.created &#125;&#125; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>&#123;% endfor %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在文章详情页面的模板中，随便找一个位置写入：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...&#123;% load my_filters_and_tags %&#125;...&#123;% show_comments_pub_time article %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>刷新详情页面，顺利的话就能看到所有评论的发表时间都展示出来了。</p><p>包含标签的另一个应用场景就是各种按钮了。有的按钮看上去长得都差不多，但是根据页面不同会有不同的功能，这时候也可以用包含标签来实现。</p><p>总之，包含标签可以将常用的模板代码打包成小组件，方便重复利用。</p><blockquote><p>目前的博客项目中暂时还用不到包含标签，所以放心的删除上面的代码吧。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>模板过滤器和标签，可以完成<strong>和表示相关的逻辑</strong>，从而使视图专注于业务核心逻辑，有利于组件化和逻辑分离。随着学习的深入，会逐渐体会到它的重要性。</p><p>本章对它们做了入门介绍，以便读者对其有初步的概念。更详细的解释请进一步阅读<a href="https://docs.djangoproject.com/en/2.2/howto/custom-template-tags/">Django官方文档</a>。</p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#117;&#x73;&#97;&#x69;&#x70;&#104;&#111;&#x74;&#x6f;&#64;&#x66;&#111;&#120;&#x6d;&#x61;&#x69;&#x6c;&#46;&#99;&#111;&#109;">&#100;&#117;&#x73;&#97;&#x69;&#x70;&#104;&#111;&#x74;&#x6f;&#64;&#x66;&#111;&#120;&#x6d;&#x61;&#x69;&#x6c;&#46;&#99;&#111;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a>添加</li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--32.多级评论</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/32.duo-ji-ping-lun/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/32.duo-ji-ping-lun/</url>
      
        <content type="html"><![CDATA[<p>现在我们的博客已经具有评论功能了。随着文章的评论者越来越多，有的时候评论者之间也需要交流，甚至部分评论还能合并成一个小的整体。因此最好是有某种方法可以将相关的评论聚集到一起，这时候<strong>多级评论</strong>就非常的有用了。</p><p>多级评论意味着你需要将模型重新组织为<strong>树形结构</strong>。“树根”是一级评论，而众多“树叶”则是次级评论。本教程会以第三方库<a href="https://github.com/django-mptt/django-mptt">django-mptt</a>为基础，开发多级评论功能。</p><blockquote><p>django-mptt模块包含了树形数据结构以及查询、修改树形数据的众多方法。</p><p>任何需要树形结构的地方，都可以用 django-mptt 来搭建。比如目录。</p></blockquote><p><strong>注意：</strong>本章新知识点较多，请读者做好心理准备，一定要耐心阅读。</p><h2 id="重构模型"><a href="#重构模型" class="headerlink" title="重构模型"></a>重构模型</h2><p>既然要建立树形结构，老的评论模型肯定是要修改了。</p><p>首先安装<code>django-mptt</code>：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> pip <span class="token function">install</span> django-mptt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装成功后，在配置中<strong>注册</strong>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token string">'mptt'</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这些你已经轻车熟路了。</p><p>接下来，修改<strong>评论模型</strong>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># django-mptt</span><span class="token keyword">from</span> mptt<span class="token punctuation">.</span>models <span class="token keyword">import</span> MPTTModel<span class="token punctuation">,</span> TreeForeignKey<span class="token comment"># 替换 models.Model 为 MPTTModel</span><span class="token keyword">class</span> <span class="token class-name">Comment</span><span class="token punctuation">(</span>MPTTModel<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 新增，mptt树形结构</span>    parent <span class="token operator">=</span> TreeForeignKey<span class="token punctuation">(</span>        <span class="token string">'self'</span><span class="token punctuation">,</span>        on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span>        null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>        blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>        related_name<span class="token operator">=</span><span class="token string">'children'</span>    <span class="token punctuation">)</span>    <span class="token comment"># 新增，记录二级评论回复给谁, str</span>    reply_to <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>        User<span class="token punctuation">,</span>        null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>        blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>        on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span>        related_name<span class="token operator">=</span><span class="token string">'replyers'</span>    <span class="token punctuation">)</span>        <span class="token comment"># 替换 Meta 为 MPTTMeta</span>    <span class="token comment"># class Meta:</span>    <span class="token comment">#     ordering = ('created',)</span>    <span class="token keyword">class</span> <span class="token class-name">MPTTMeta</span><span class="token punctuation">:</span>        order_insertion_by <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'created'</span><span class="token punctuation">]</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>先引入<code>MPTT</code>相关模块，然后改动下列几个位置：</p><ul><li>模型<strong>不再继承</strong>内置的<code>models.Model</code>类，替换为<code>MPTTModel</code>，因此你的模型自动拥有了几个用于树形算法的新字段。（有兴趣的读者，可以在迁移好数据之后在SQLiteStudio中查看）</li><li><code>parent</code>字段是必须定义的，用于存储数据之间的关系，不要去修改它。</li><li><code>reply_to</code>外键用于存储<strong>被评论人</strong>。</li><li>将<code>class Meta</code>替换为<code>class MPTTMeta</code>，参数也有小的变化，这是模块的默认定义，实际功能是相同的。</li></ul><p>这些改动大部分都是<a href="https://django-mptt.readthedocs.io/en/latest/tutorial.html">django-mptt文档</a>的默认设置。需要说明的是这个<code>reply_to</code>。</p><p>先思考一下，多级评论是否允许无限级数？无限级数听起来很美好，但是嵌套的层级如果过多，反而会导致结构混乱，并且难以排版。所以这里就<strong>限制评论最多只能两级</strong>，超过两级的评论一律重置为两级，然后再将实际的被评论人存储在<code>reply_to</code>字段中。</p><blockquote><p>举例说明：一级评论人为 a，二级评论人为 b（parent 为 a），三级评论人为 c（parent 为 b）。因为我们不允许评论超过两级，因此将 c 的 parent 重置为 a，reply_to 记录为 b，这样就能正确追溯真正的被评论者了。</p></blockquote><p>模型修改完了，添加了很多非空的字段进去，因此最好<strong>先清空所有的评论数据</strong>，再进行数据迁移。</p><p>迁移时出现下面的提示也不要慌，</p><p>一律选择第 1 项、</p><p><strong>然后提示填入数据时，直接输入 0 （不要按照提示输入 timezone.now，这是无效值）</strong></p><p> 就可以了：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage.py makemigrationsYou are trying to <span class="token function">add</span> a non-nullable field <span class="token string">'level'</span> to comment without a default<span class="token punctuation">;</span> we can<span class="token string">'t do that (the database needs something to populate existing rows).Please select a fix: 1) Provide a one-off default now (will be set on all existing rows with a null value for this column) 2) Quit, and let me add a default in models.pySelect an option: 1Please enter the default value now, as valid PythonThe datetime and django.utils.timezone modules are available, so you can do e.g. timezone.nowType '</span>exit' to <span class="token builtin class-name">exit</span> this prompt<span class="token operator">>></span><span class="token operator">></span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>要还不行，就把数据库文件删了重新迁移吧。开发阶段用点笨办法也没关系。</p></blockquote><p>数据迁移还是老规矩：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage<span class="token punctuation">.</span>py makemigrations<span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage<span class="token punctuation">.</span>py migrate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这就完成了。</p><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>前面章节已经写过一个视图<code>post_comment</code>用于处理评论了，我们将<strong>复用</strong>它，以求精简代码。</p><p>改动较大，代码全贴出来，请对照改动：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 记得引入 Comment ！</span><span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Comment<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token decorator annotation punctuation">@login_required</span><span class="token punctuation">(</span>login_url<span class="token operator">=</span><span class="token string">'/userprofile/login/'</span><span class="token punctuation">)</span><span class="token comment"># 新增参数 parent_comment_id</span><span class="token keyword">def</span> <span class="token function">post_comment</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> article_id<span class="token punctuation">,</span> parent_comment_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    article <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>ArticlePost<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span>article_id<span class="token punctuation">)</span>    <span class="token comment"># 处理 POST 请求</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        comment_form <span class="token operator">=</span> CommentForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token keyword">if</span> comment_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            new_comment <span class="token operator">=</span> comment_form<span class="token punctuation">.</span>save<span class="token punctuation">(</span>commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>            new_comment<span class="token punctuation">.</span>article <span class="token operator">=</span> article            new_comment<span class="token punctuation">.</span>user <span class="token operator">=</span> request<span class="token punctuation">.</span>user            <span class="token comment"># 二级回复</span>            <span class="token keyword">if</span> parent_comment_id<span class="token punctuation">:</span>                parent_comment <span class="token operator">=</span> Comment<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>parent_comment_id<span class="token punctuation">)</span>                <span class="token comment"># 若回复层级超过二级，则转换为二级</span>                new_comment<span class="token punctuation">.</span>parent_id <span class="token operator">=</span> parent_comment<span class="token punctuation">.</span>get_root<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">id</span>                <span class="token comment"># 被回复人</span>                new_comment<span class="token punctuation">.</span>reply_to <span class="token operator">=</span> parent_comment<span class="token punctuation">.</span>user                new_comment<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'200 OK'</span><span class="token punctuation">)</span>            new_comment<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>article<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"表单内容有误，请重新填写。"</span><span class="token punctuation">)</span>    <span class="token comment"># 处理 GET 请求</span>    <span class="token keyword">elif</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>        comment_form <span class="token operator">=</span> CommentForm<span class="token punctuation">(</span><span class="token punctuation">)</span>        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span>            <span class="token string">'comment_form'</span><span class="token punctuation">:</span> comment_form<span class="token punctuation">,</span>            <span class="token string">'article_id'</span><span class="token punctuation">:</span> article_id<span class="token punctuation">,</span>            <span class="token string">'parent_comment_id'</span><span class="token punctuation">:</span> parent_comment_id        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'comment/reply.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>    <span class="token comment"># 处理其他请求</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"仅接受GET/POST请求。"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>主要变化有3个地方：</p><ul><li>视图的参数<strong>新增</strong>了<code>parent_comment_id=None</code>。此参数代表<strong>父评论</strong>的<code>id</code>值，若为<code>None</code>则表示评论为一级评论，若有具体值则为多级评论。</li><li>如果视图处理的是多级评论，则用<code>MPTT</code>的<code>get_root()</code>方法将其<strong>父级重置为树形结构最底部的一级评论</strong>，然后在<code>reply_to</code>中保存实际的被回复人并保存。视图最终返回的是<code>HttpResponse</code>字符串，后面会用到。</li><li>新增处理<code>GET</code>请求的逻辑，用于<strong>给二级回复提供空白的表单</strong>。后面会用到。</li></ul><p>很好，现在视图中有一个<code>parent_comment_id</code>参数用于区分多级评论，因此就要求有的<code>url</code>传入此参数，有的不传入，像下面这样：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token comment"># 已有代码，处理一级回复</span>    path<span class="token punctuation">(</span><span class="token string">'post-comment/&lt;int:article_id>'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>post_comment<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'post_comment'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># 新增代码，处理二级回复</span>    path<span class="token punctuation">(</span><span class="token string">'post-comment/&lt;int:article_id>/&lt;int:parent_comment_id>'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>post_comment<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'comment_reply'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>两个<code>path</code>都使用了<strong>同一个视图函数</strong>，但是传入的<strong>参数却不一样多</strong>，仔细看。第一个<code>path</code>没有<code>parent_comment_id</code>参数，因此视图就使用了<strong>缺省值</strong><code>None</code>，达到了区分评论层级的目的。</p><h2 id="前端渲染"><a href="#前端渲染" class="headerlink" title="前端渲染"></a>前端渲染</h2><p>在前端的逻辑上，我们的理想很丰满：</p><ul><li>二级回复同样要使用富文本编辑器</li><li>回复时不能离开当前页面</li><li>多个ckeditor加载时，不能有性能问题</li></ul><p>然而理想越丰满，代码写得就越痛苦。</p><p>首先就是<code>detail.html</code>的代码要大改，主要集中在<strong>显示评论部分</strong>以及相关的<code>JavaScript</code>。</p><p>需要改动的地方先全部贴出来：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token comment">&lt;!-- 改动 显示评论 部分 --></span><span class="token comment">&lt;!-- 不要漏了 load mptt_tags！ --></span>&#123;% load mptt_tags %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">></span></span>共有&#123;&#123; comments.count &#125;&#125;条评论<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 遍历树形结构 --></span>    &#123;% recursetree comments %&#125;        <span class="token comment">&lt;!-- 给 node 取个别名 comment --></span>        &#123;% with comment=node %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% if comment.reply_to %&#125;                        offset-1 col-11                        &#123;% else %&#125;                        col-12                        &#123;% endif %&#125;<span class="token punctuation">"</span></span>            <span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> pink</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>                        &#123;&#123; comment.user &#125;&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">></span></span>                     &#123;% if comment.reply_to %&#125;                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>far fa-arrow-alt-circle-right<span class="token punctuation">"</span></span>                            <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> cornflowerblue<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span>                        <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> pink</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>                            &#123;&#123; comment.reply_to &#125;&#125;                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">></span></span>                     &#123;% endif %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>&#123;&#123; comment.body|safe &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> gray</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>                        &#123;&#123; comment.created|date:"Y-m-d H:i" &#125;&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>                    <span class="token comment">&lt;!-- 加载 modal 的按钮 --></span>                    &#123;% if user.is_authenticated %&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span>                             <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-light btn-sm text-muted<span class="token punctuation">"</span></span>                             <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">load_modal</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> article<span class="token punctuation">.</span>id <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> comment<span class="token punctuation">.</span>id <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span>                            <span class="token punctuation">></span></span>                        回复                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>                    &#123;% else %&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-light btn-sm text-muted<span class="token punctuation">"</span></span>                        <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>userprofile:login<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span>                       <span class="token punctuation">></span></span>                        回复                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                    &#123;% endif %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- Modal --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal fade<span class="token punctuation">"</span></span>                      <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>comment_&#123;&#123; comment.id &#125;&#125;<span class="token punctuation">"</span></span>                      <span class="token attr-name">tabindex</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-1<span class="token punctuation">"</span></span>                      <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dialog<span class="token punctuation">"</span></span>                      <span class="token attr-name">aria-labelledby</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CommentModalCenter<span class="token punctuation">"</span></span>                      <span class="token attr-name">aria-hidden</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>                <span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal-dialog modal-dialog-centered modal-lg<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>document<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal-content<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 480px</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal-header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal-title<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>exampleModalCenterTitle<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>回复 &#123;&#123; comment.user &#125;&#125;：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal-body<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal_body_&#123;&#123; comment.id &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                &#123;% if not comment.is_leaf_node %&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>children<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        &#123;&#123; children &#125;&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                &#123;% endif %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    &#123;% endwith %&#125;    &#123;% endrecursetree %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...&#123;% block script %&#125;...<span class="token comment">&lt;!-- 新增代码，唤醒二级回复的 modal --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token comment">// 加载 modal</span>    <span class="token keyword">function</span> <span class="token function">load_modal</span><span class="token punctuation">(</span><span class="token parameter">article_id<span class="token punctuation">,</span> comment_id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> modal_body <span class="token operator">=</span> <span class="token string">'#modal_body_'</span> <span class="token operator">+</span> comment_id<span class="token punctuation">;</span>        <span class="token keyword">let</span> modal_id <span class="token operator">=</span> <span class="token string">'#comment_'</span> <span class="token operator">+</span> comment_id<span class="token punctuation">;</span>                <span class="token comment">// 加载编辑器</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>modal_body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">'&lt;iframe src="/comment/post-comment/'</span> <span class="token operator">+</span>                 article_id <span class="token operator">+</span>                 <span class="token string">'/'</span> <span class="token operator">+</span>                 comment_id <span class="token operator">+</span>                 <span class="token string">'"'</span> <span class="token operator">+</span>                 <span class="token string">' frameborder="0" style="width: 100%; height: 100%;" id="iframe_'</span> <span class="token operator">+</span>                 comment_id <span class="token operator">+</span>                 <span class="token string">'">&lt;/iframe>'</span><span class="token punctuation">;</span>            <span class="token function">$</span><span class="token punctuation">(</span>modal_body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span>modal_id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">'show'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>&#123;% endblock script %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这么大段肯定把你看晕了，不要急，让我们拆开来讲解。</p><h3 id="遍历树"><a href="#遍历树" class="headerlink" title="遍历树"></a>遍历树</h3><p>第一个问题，如何遍历树形结构？</p><p>django-mptt提供了一个快捷方式：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&#123;% load mptt_tags %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>    &#123;% recursetree objs %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>            &#123;&#123; node.your_field &#125;&#125;            &#123;% if not node.is_leaf_node %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>children<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    &#123;&#123; children &#125;&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>            &#123;% endif %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>    &#123;% endrecursetree %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>内部的实现你不用去管，当成一个黑盒子去用就好了。<code>objs</code>是需要遍历的<strong>数据集</strong>，<code>node</code>是其中的<strong>单个数据</strong>。有两个地方要注意：</p><ul><li><code>&#123;% load mptt_tags %&#125;</code>不要忘记写</li><li><code>node</code>这个变量名太宽泛，用<code>&#123;% with comment=node %&#125;</code>给它起了个别名</li></ul><h3 id="Modal"><a href="#Modal" class="headerlink" title="Modal"></a>Modal</h3><p><strong>Modal</strong>是<strong>Bootstrap</strong>内置的弹窗。本文相关代码如下：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- 加载 modal 的按钮 --></span>&#123;% if user.is_authenticated %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span>         <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-light btn-sm text-muted<span class="token punctuation">"</span></span>         <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">load_modal</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> article<span class="token punctuation">.</span>id <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> comment<span class="token punctuation">.</span>id <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span>        <span class="token punctuation">></span></span>    回复<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>&#123;% else %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-light btn-sm text-muted<span class="token punctuation">"</span></span>    <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>userprofile:login<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span>   <span class="token punctuation">></span></span>    回复<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>&#123;% endif %&#125;<span class="token comment">&lt;!-- Modal --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal fade<span class="token punctuation">"</span></span>      <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>comment_&#123;&#123; comment.id &#125;&#125;<span class="token punctuation">"</span></span>      <span class="token attr-name">tabindex</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-1<span class="token punctuation">"</span></span>      <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dialog<span class="token punctuation">"</span></span>      <span class="token attr-name">aria-labelledby</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CommentModalCenter<span class="token punctuation">"</span></span>      <span class="token attr-name">aria-hidden</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>     <span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal-dialog modal-dialog-centered modal-lg<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>document<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal-content<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 480px</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal-header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal-title<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>exampleModalCenterTitle<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>回复 &#123;&#123; comment.user &#125;&#125;：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal-body<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modal_body_&#123;&#123; comment.id &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>它几乎就是从<a href="https://getbootstrap.com/docs/4.1/components/modal/">Bootstrap官方文档</a>抄下来的（所以读者要多浏览官网啊）。有点不同的是本文没有用原生的按钮，而是用<code>JavaScript</code>加载的Modal；还有就是增加了几个容器的<code>id</code>属性，方便后面的<code>JavaScript</code>查询。</p><p>和之前章节用的<code>Layer.js</code>相比，<code>Bootstrap</code>的弹窗更笨重些，也更精致些，很适合在这里使用。</p><p>注意，加载Modal的按钮用模板语法<code>&#123;% if user.is_authenticated %&#125;</code>对用户是否登录做了区分，目的是将未登录的用户引导至登录页面。</p><blockquote><p>这是2019/05/31修订过的内容。感谢读者 @Zhende Liu 对此部分的问题反馈。</p></blockquote><h3 id="加载Modal"><a href="#加载Modal" class="headerlink" title="加载Modal"></a>加载Modal</h3><p>最难理解的可能就是这段加载Modal的<code>JavaScript</code>代码了：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 加载 modal</span><span class="token keyword">function</span> <span class="token function">load_modal</span><span class="token punctuation">(</span><span class="token parameter">article_id<span class="token punctuation">,</span> comment_id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> modal_body <span class="token operator">=</span> <span class="token string">'#modal_body_'</span> <span class="token operator">+</span> comment_id<span class="token punctuation">;</span>    <span class="token keyword">let</span> modal_id <span class="token operator">=</span> <span class="token string">'#comment_'</span> <span class="token operator">+</span> comment_id<span class="token punctuation">;</span>    <span class="token comment">// 加载编辑器</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>modal_body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">'&lt;iframe src="/comment/post-comment/'</span> <span class="token operator">+</span>             article_id <span class="token operator">+</span>             <span class="token string">'/'</span> <span class="token operator">+</span>             comment_id <span class="token operator">+</span>             <span class="token string">'" frameborder="0" style="width: 100%; height: 100%;">&lt;/iframe>'</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span>modal_body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">$</span><span class="token punctuation">(</span>modal_id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">'show'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>实际上核心逻辑只有3步：</p><ul><li>点击回复按钮时唤醒了<code>load_modal()</code>函数，并将文章id、父级评论id传递进去</li><li><code>$(modal_body).append(content)</code>找到对应Modal的容器，并将一个<code>iframe</code>容器动态添加进去</li><li><code>$(modal_id).modal(&#39;show&#39;)</code>找到对应的Modal，并将其唤醒</li></ul><p>为什么<code>iframe</code>需要<strong>动态加载</strong>？这是为了<strong>避免潜在的性能问题</strong>。你确实可以在页面初始加载时把所有<code>iframe</code>都渲染好，但是这需要花费额外的时间，并且绝大部分的Modal用户根本不会用到，很不划算。</p><p><code>if</code>语句的作用是判断Modal中如果已经加载过，就不再重复加载了。</p><p>最后，什么是<code>iframe</code>？这是HTML5中的新特性，可以理解成<strong>当前网页中嵌套的另一个独立的网页</strong>。既然是独立的网页，那自然也会<strong>独立的向后台请求数据</strong>。仔细看<code>src</code>中请求的位置，正是前面我们在<code>urls.py</code>中写好的第二个<code>path</code>。即对应了<code>post_comment</code>视图中的<code>GET</code>逻辑：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token keyword">def</span> <span class="token function">post_comment</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> article_id<span class="token punctuation">,</span> parent_comment_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 处理 GET 请求</span>    <span class="token keyword">elif</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'comment/reply.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>视图返回的<code>comment/reply.html</code>模板还没有写，接下来就把它写好。</p><blockquote><p>老实说用 iframe 来加载 ckeditor 弹窗并不是很“优雅”。单页面上多个 ckeditor 的动态加载、取值、传参，博主没能尝试成功。有兴趣的读者可以和我交流。</p></blockquote><h2 id="Ajax提交表单"><a href="#Ajax提交表单" class="headerlink" title="Ajax提交表单"></a>Ajax提交表单</h2><p>在<code>templates</code>中新建<code>comment</code>目录，并新建<code>reply.html</code>，写入代码：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/comment/reply.html<span class="token comment">&lt;!-- 载入静态文件 --></span>&#123;% load staticfiles %&#125;<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zh-cn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>bootstrap/css/bootstrap.min.css<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span>     <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span>     <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span>    <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>reply_form<span class="token punctuation">"</span></span>     <span class="token punctuation">></span></span>        &#123;% csrf_token %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                &#123;&#123; comment_form.media &#125;&#125;                &#123;&#123; comment_form.body &#125;&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 提交按钮 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">confirm_submit</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> article_id <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> parent_comment_id <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>发送<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>jquery/jquery-3.3.1.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>popper/popper-1.14.4.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>bootstrap/js/bootstrap.min.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- csrf token --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>csrf.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".django-ckeditor-widget"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAttr</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">confirm_submit</span><span class="token punctuation">(</span><span class="token parameter">article_id<span class="token punctuation">,</span> comment_id</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 从 ckeditor 中取值</span>        <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token constant">CKEDITOR</span><span class="token punctuation">.</span>instances<span class="token punctuation">[</span><span class="token string">'id_body'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 调用 ajax 与后端交换数据</span>        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            url<span class="token operator">:</span> <span class="token string">'/comment/post-comment/'</span> <span class="token operator">+</span> article_id <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> comment_id<span class="token punctuation">,</span>            type<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>            data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>body<span class="token operator">:</span> content<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token comment">// 成功回调</span>            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>e <span class="token operator">===</span> <span class="token string">'200 OK'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    parent<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个模板的作用是提供一个ckeditor的编辑器，所以没有继承<code>base.html</code>。让我们拆开来讲。</p><h3 id="Ajax是什么"><a href="#Ajax是什么" class="headerlink" title="Ajax是什么"></a>Ajax是什么</h3><p>用<strong>Ajax技术</strong>来提交表单，与传统方法非常不同。</p><p>传统方法提交表单时向后端提交一个请求。后端处理请求后会返回一个<strong>全新</strong>的网页。这种做法浪费了很多带宽，因为前后两个页面中大部分内容往往都是相同的。与此不同，AJAX技术可以仅向服务器发送并取回必须的数据，并在客户端采用<strong>JavaScript</strong>处理来自服务器的回应。因为在服务器和浏览器之间交换的数据大量减少，服务器回应更快了。</p><p>虽然本教程只用到Ajax的一点皮毛，但是Ajax的应用非常广泛，建议读者多了解相关知识。</p><p>这里会用到Ajax，倒不是因为其效率高，而是因为Ajax可以在表单提交成功后得到反馈，以便刷新页面。</p><p>核心代码如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">confirm_submit</span><span class="token punctuation">(</span><span class="token parameter">article_id<span class="token punctuation">,</span> comment_id</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 从 ckeditor 中取值</span>    <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token constant">CKEDITOR</span><span class="token punctuation">.</span>instances<span class="token punctuation">[</span><span class="token string">'id_body'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 调用 ajax 与后端交换数据</span>    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        url<span class="token operator">:</span> <span class="token string">'/comment/post-comment/'</span> <span class="token operator">+</span> article_id <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> comment_id<span class="token punctuation">,</span>        type<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>        data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>body<span class="token operator">:</span> content<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token comment">// 成功回调</span>        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>e <span class="token operator">===</span> <span class="token string">'200 OK'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                parent<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><strong>CKEDITOR</strong>是编辑器提供的全局变量，这里用<code>CKEDITOR.instances[&#39;id_body&#39;].getData()</code>取得当前编辑器中用户输入的内容。</li><li>接下来调用了Jquery的ajax方法与视图进行数据交换。ajax中定义了视图的url、请求的方法、提交的数据。</li><li><code>success</code>是ajax的回调函数。当得到视图的响应后执行内部的函数。</li></ul><p>前面写视图的时候，二级评论提交成功后会返回<code>200 OK</code>，回调函数接收到这个信号后，就会调用<code>reload()</code>方法，刷新当前的父页面（即文章所在的页面），实现了数据的更新。</p><h3 id="csrf问题"><a href="#csrf问题" class="headerlink" title="csrf问题"></a>csrf问题</h3><p>代码中有这么一行：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>csrf.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>没有这一行，后端会返回<code>403 Forbidden</code>错误，并且表单提交失败。</p><p>还记得之前提交传统表单时的<code>&#123;% csrf_token %&#125;</code>吗？Django为了防止跨域攻击，要求表单必须提供这个token，验证提交者的身份。</p><p>问题是在Ajax中怎么解决这个问题呢？一种方法就是在页面中插入这个<code>csrf.js</code>模块。</p><p>在static目录中将<a href="https://github.com/stacklens/django_blog_tutorial/blob/master/static/csrf.js">csrf.js</a>文件粘贴进去，并在页面中引用，就可以解决此问题了。</p><blockquote><p>csrf.js文件可以在<a href="https://github.com/stacklens/django_blog_tutorial/blob/master/static/csrf.js">我的GitHub仓库下载</a>。</p></blockquote><h2 id="测试！"><a href="#测试！" class="headerlink" title="测试！"></a>测试！</h2><p>进入文章页面，评论的边上多出一个按钮，可以对评论者进行评论了：</p><blockquote><p>注意：Django 3 修改了 xframe 的默认设置，即不支持 iframe 自己。如果你使用的版本是 Django 3，需要在 <code>settings.py</code> 中添加：<code>X_FRAME_OPTIONS = &#39;SAMEORIGIN&#39;</code> 。</p></blockquote><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190504/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE203.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190504/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE203.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击回复按钮，弹出带有富文本编辑器的弹窗：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190504/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE204.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190504/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE204.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击发送按钮，页面会自动刷新，并且二级评论也出现了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190504/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE205.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190504/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE205.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>还可以继续对二级评论者评论，不过更高级的评论会被强制转换为二级评论：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190504/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE206.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190504/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE206.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>功能正常运行了。</p><p>有兴趣的读者可以打开SQLiteStudio，研究一下comment数据表的结构。</p><h2 id="二级回复窗口不弹出"><a href="#二级回复窗口不弹出" class="headerlink" title="二级回复窗口不弹出"></a>二级回复窗口不弹出</h2><p>所有一切准备完毕，点击回复按钮，却没有回复窗口弹出或者弹出了一个窗口，提示拒绝连接<br>打开F12，会有这样的提示</p><pre><code>Refused to display &#39;×××&#39; in a frame because it set &#39;X-Frame-Options&#39; to &#39;deny&#39;.</code></pre><p>查看setting配置，如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的内容显示，Django的项目中默认设置了XFrameOptionsMiddleware的中间件，这个设置在Django 3.0中将对于X-Frame-Options的配置设置成了DENY。<br>可以在设置中，添加如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">X_FRAME_OPTIONS <span class="token operator">=</span> <span class="token string">'SAMEORIGIN'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>认真看完本章并实现了多级评论的同学，可以给自己点掌声了。本章应该是教程到目前为止知识点最多、最杂的章节，涵盖了MTV、Jquery、Ajax、iframe、modal等多种前后端技术。</p><p>没成功实现也不要急躁，web开发嘛，走点弯路很正常的。多观察Django和控制台的报错信息，找到问题并解决它。</p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#x75;&#x73;&#97;&#105;&#x70;&#104;&#111;&#116;&#111;&#64;&#x66;&#x6f;&#x78;&#x6d;&#x61;&#x69;&#x6c;&#x2e;&#x63;&#111;&#x6d;">&#100;&#x75;&#x73;&#97;&#105;&#x70;&#104;&#111;&#116;&#111;&#64;&#x66;&#x6f;&#x78;&#x6d;&#x61;&#x69;&#x6c;&#x2e;&#x63;&#111;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--17.拓展用户信息</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/17.tuo-zhan-yong-hu-xin-xi/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/17.tuo-zhan-yong-hu-xin-xi/</url>
      
        <content type="html"><![CDATA[<p>可能你已经发现了，Django自带的User模型非常实用，以至于我们没有写用户管理相关的任何模型。</p><p>但是自带的User毕竟可用的字段较少。比方说非常重要的电话号码、头像等都没有。解决的方法有很多，你可以不使用User，自己从零写用户模型；也可以对User模型进行扩展。</p><p>博客网站的用户信息并不复杂，因此扩展User就足够了。</p><h2 id="扩展User模型"><a href="#扩展User模型" class="headerlink" title="扩展User模型"></a>扩展User模型</h2><p>扩展User模型又有不同的方法。在大多数情况下，使用<strong>模型一对一链接</strong>的方法是比较适合的。</p><p>编写<code>userprofile/models.py</code>如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">userprofile<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token comment"># 引入内置信号</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models<span class="token punctuation">.</span>signals <span class="token keyword">import</span> post_save<span class="token comment"># 引入信号接收器的装饰器</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>dispatch <span class="token keyword">import</span> receiver<span class="token comment"># 用户扩展信息</span><span class="token keyword">class</span> <span class="token class-name">Profile</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 与 User 模型构成一对一的关系</span>    user <span class="token operator">=</span> models<span class="token punctuation">.</span>OneToOneField<span class="token punctuation">(</span>User<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span> related_name<span class="token operator">=</span><span class="token string">'profile'</span><span class="token punctuation">)</span>    <span class="token comment"># 电话号码字段</span>    phone <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token comment"># 头像</span>    avatar <span class="token operator">=</span> models<span class="token punctuation">.</span>ImageField<span class="token punctuation">(</span>upload_to<span class="token operator">=</span><span class="token string">'avatar/%Y%m%d/'</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token comment"># 个人简介</span>    bio <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'user &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token comment"># 信号接收函数，每当新建 User 实例时自动调用</span><span class="token decorator annotation punctuation">@receiver</span><span class="token punctuation">(</span>post_save<span class="token punctuation">,</span> sender<span class="token operator">=</span>User<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">create_user_profile</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> created<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> created<span class="token punctuation">:</span>        Profile<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>user<span class="token operator">=</span>instance<span class="token punctuation">)</span><span class="token comment"># 信号接收函数，每当更新 User 实例时自动调用</span><span class="token decorator annotation punctuation">@receiver</span><span class="token punctuation">(</span>post_save<span class="token punctuation">,</span> sender<span class="token operator">=</span>User<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">save_user_profile</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>    instance<span class="token punctuation">.</span>profile<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每个<code>Profile</code>模型对应唯一的一个<code>User</code>模型，形成了对User的外接扩展，因此你可以在<code>Profile</code>添加任何想要的字段。这种方法的好处是不需要对<code>User</code>进行任何改动，从而拥有完全自定义的数据表。模型本身没有什么新的知识，比较神奇的是用到的<strong>信号机制</strong>。</p><p>Django包含一个“信号调度程序”，它可以在框架中的某些位置发生操作时，通知其他应用程序。简而言之，信号允许某些<strong>发送者</strong>通知一组<strong>接收器</strong>已经发生了某个动作。当许多代码可能对同一事件感兴趣时，<strong>信号</strong>就特别有用。</p><p>这里引入的<code>post_save</code>就是一个内置信号，它可以在模型调用<code>save()</code>方法后发出信号。</p><p>有了信号之后还需要定义接收器，告诉Django应该把信号发给谁。装饰器<code>receiver</code>就起到接收器的作用。每当<code>User</code>有更新时，就发送一个信号启动<code>post_save</code>相关的函数。</p><p>通过信号的传递，实现了每当<code>User</code>创建/更新时，<code>Profile</code>也会自动的创建/更新。</p><blockquote><p>当然你也可以不使用信号来自动创建Profile表，而是采用手动方式实现。</p><p>为什么删除User表不需要信号？答案是两者的关系采用了models.CASCADE级联删除，已经带有关联删除的功能了。</p><p>avatar字段用来存放头像，暂且不管它，下一章讲解。</p></blockquote><h2 id="重建数据库"><a href="#重建数据库" class="headerlink" title="重建数据库"></a>重建数据库</h2><p>前面讲过，每次改动模型后都需要进行数据的迁移。由于<code>avatar</code>字段为图像字段，需要安装第三方库<code>Pillow</code>来支持：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> E:<span class="token punctuation">\</span>django_project<span class="token punctuation">\</span>my_blog<span class="token operator">></span> pip <span class="token function">install</span> Pillow<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装成功后，通过<code>makemigrations</code>、<code>migrate</code>迁移数据：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> E:<span class="token punctuation">\</span>django_project<span class="token punctuation">\</span>my_blog<span class="token operator">></span>python manage.py makemigrationsMigrations <span class="token keyword">for</span> <span class="token string">'userprofile'</span><span class="token builtin class-name">:</span>  userprofile<span class="token punctuation">\</span>migrations<span class="token punctuation">\</span>0001_initial.py    - Create model Profile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> E:<span class="token punctuation">\</span>django_project<span class="token punctuation">\</span>my_blog<span class="token operator">></span>python manage.py migrateOperations to perform:  Apply all migrations: admin, article, auth, contenttypes, sessions, userprofileRunning migrations:  Applying userprofile.0001_initial<span class="token punctuation">..</span>. OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>迁移好数据后，如果你试图登录用户，会得到报错。</strong>这是因为之前创建的<code>User</code>数据都没有对应的<code>Profile</code>模型，违背了现有的模型。一种解决办法就是干脆删除旧的数据，因此就需要用到Django的<code>shell</code>命令。</p><p><code>shell</code>是Django提供的互动解释器，你可以在这个指令模式中试验代码是否能够正确执行，是相当方便的工具。</p><p>在虚拟环境中输入<code>python manage.py shell</code>就可以进入shell：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> E:<span class="token punctuation">\</span>django_project<span class="token punctuation">\</span>my_blog<span class="token operator">></span>python manage.py shellPython <span class="token number">3.7</span>.0 <span class="token punctuation">(</span>v3.7.0:1bf9cc5093, Jun <span class="token number">27</span> <span class="token number">2018</span>, 04:59:51<span class="token punctuation">)</span> <span class="token punctuation">[</span>MSC v.1914 <span class="token number">64</span> bit <span class="token punctuation">(</span>AMD64<span class="token punctuation">)</span><span class="token punctuation">]</span> on win32Type <span class="token string">"help"</span>, <span class="token string">"copyright"</span>, <span class="token string">"credits"</span> or <span class="token string">"license"</span> <span class="token keyword">for</span> <span class="token function">more</span> information.<span class="token punctuation">(</span>InteractiveConsole<span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看到<code>&gt;&gt;&gt;</code>表示成功进入shell。</p><p>输入下面两行指令就可以轻松删除User数据库：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> from django.contrib.auth.models <span class="token function">import</span> User<span class="token operator">>></span><span class="token operator">></span> User.objects.all<span class="token punctuation">(</span><span class="token punctuation">)</span>.delete<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>注意因为前面写的<code>article</code>模型中，与<code>User</code>的外键也采用了<code>models.CASCADE</code>级联删除模式，因此随着User的删除，<strong>相关的文章也一并删除了</strong>。</p><p>输入<code>exit()</code>退出<code>shell</code>，输入指令<code>python manage.py createsuperuser</code>，<strong>重新创建管理员账户</strong>。</p><blockquote><p>对新手来说，修改数据库经常会导致各种头疼的问题，比如说字段失效、新字段为null、赋值错误、外键链接出错等等，最终导致整个业务逻辑报错。因此我的建议是，在设计数据库时尽量考虑周全，避免频繁修改模型。</p><p>如果实在要修改，并且已经导致数据库混乱了，不妨删除掉<code>/app/migrations/</code>目录下最新的几个文件，清空相关数据库，重新迁移数据。</p></blockquote><p>接下来编写MTV模式的剩余部分。</p><h2 id="表单、视图和模板"><a href="#表单、视图和模板" class="headerlink" title="表单、视图和模板"></a>表单、视图和模板</h2><p>有了扩展的<code>Profile</code>模型后，需要新建一个<strong>表单类</strong>去编辑它的内容：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">userprofile<span class="token operator">/</span>forms<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 引入 Profile 模型</span><span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Profile<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ProfileForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> Profile        fields <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'avatar'</span><span class="token punctuation">,</span> <span class="token string">'bio'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在<code>userprofile/views.py</code>中写处理用户信息的视图函数：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">userprofile<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 别忘了引入模块</span><span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> ProfileForm<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Profile<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 编辑用户信息</span><span class="token decorator annotation punctuation">@login_required</span><span class="token punctuation">(</span>login_url<span class="token operator">=</span><span class="token string">'/userprofile/login/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">profile_edit</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    user <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token comment"># user_id 是 OneToOneField 自动生成的字段</span>    profile <span class="token operator">=</span> Profile<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        <span class="token comment"># 验证修改数据者，是否为用户本人</span>        <span class="token keyword">if</span> request<span class="token punctuation">.</span>user <span class="token operator">!=</span> user<span class="token punctuation">:</span>            <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"你没有权限修改此用户信息。"</span><span class="token punctuation">)</span>        profile_form <span class="token operator">=</span> ProfileForm<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token keyword">if</span> profile_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment"># 取得清洗后的合法数据</span>            profile_cd <span class="token operator">=</span> profile_form<span class="token punctuation">.</span>cleaned_data            profile<span class="token punctuation">.</span>phone <span class="token operator">=</span> profile_cd<span class="token punctuation">[</span><span class="token string">'phone'</span><span class="token punctuation">]</span>            profile<span class="token punctuation">.</span>bio <span class="token operator">=</span> profile_cd<span class="token punctuation">[</span><span class="token string">'bio'</span><span class="token punctuation">]</span>            profile<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># 带参数的 redirect()</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"userprofile:edit"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"注册表单输入有误。请重新输入~"</span><span class="token punctuation">)</span>    <span class="token keyword">elif</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>        profile_form <span class="token operator">=</span> ProfileForm<span class="token punctuation">(</span><span class="token punctuation">)</span>        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'profile_form'</span><span class="token punctuation">:</span> profile_form<span class="token punctuation">,</span> <span class="token string">'profile'</span><span class="token punctuation">:</span> profile<span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">:</span> user <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'userprofile/edit.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"请使用GET或POST请求数据"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>2019/05/13更新：实际上GET方法中不需要将profile_form这个表单对象传递到模板中去，因为模板中已经用Bootstrap写好了表单，所以profile_form并没有用到。感谢读者<a href="https://www.dusaiphoto.com/article/detail/37/#F244">YipCyun</a>指正。</p></blockquote><p>业务逻辑与以前写的处理表单的视图非常相似（还记得吗），就不赘述了。</p><p>需要注意下面几个小地方：</p><ul><li><code>user_id</code>是外键自动生成的字段，用来表征两个数据表的关联。你可以在<strong>SQLiteStudio</strong>中查看它。</li><li>留意<code>redirect()</code>是如何携带参数传递的。</li></ul><p>然后就是<strong>新建模板文件</strong><code>/templates/userprofile/edit.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">/templates/userprofile/edit.html&#123;% extends "base.html" %&#125; &#123;% load staticfiles %&#125;&#123;% block title %&#125; 用户信息 &#123;% endblock title %&#125;&#123;% block content %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-md-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>用户名: &#123;&#123; user.username &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                &#123;% csrf_token %&#125;                <span class="token comment">&lt;!-- phone --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group col-md-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>phone<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>电话<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>phone<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>phone<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; profile.phone &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- bio --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group col-md-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bio<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>简介<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bio<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bio<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; profile.bio &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 提交按钮 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>提交<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>留意模板中如何分别调用<code>User</code>、<code>Profile</code>对象的</li><li>行内文本通过<code>value</code>属性设置了初始值，而多行文本则直接设置<code>&#123;&#123; profile.bio &#125;&#125;</code></li></ul><p>最后配置熟悉的<code>userprofile/urls.py</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">userprofile<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 用户信息</span>    path<span class="token punctuation">(</span><span class="token string">'edit/&lt;int:id>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>profile_edit<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'edit'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动服务器，输入地址查看功能是否正常。注意<strong>旧的用户都删除了</strong>（id=1的用户已经没有了），这里的<code>/&lt;int:id&gt;</code>必须为<strong>新创建的用户的id</strong>。</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181204/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE87.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181204/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE87.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>页面虽然简陋，但是方法是类似的。可以在这个基础上，扩展为一个美观、详细的用户信息页面。</p><p><strong>当然最好再给个人信息添加一个入口。</strong>修改<code>/templates/header.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">/templates/header.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown-menu<span class="token punctuation">"</span></span> <span class="token attr-name">aria-labelledby</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navbarDropdown<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown-item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>&#123;% url <span class="token punctuation">"</span>userprofile:edit<span class="token punctuation">"</span> user.id %&#125;<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>个人信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="修改article视图"><a href="#修改article视图" class="headerlink" title="修改article视图"></a>修改article视图</h2><p>在前面新建article的章节中，由于没有用户管理的知识，存在一些问题：</p><ul><li><code>new_article.author = User.objects.get(id=1)</code>强行把作者指定为id=1的用户，这显然是不对的。</li><li>没有对用户的登录状态进行检查。</li></ul><p>因此稍加修改<code>def article_create()</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> login_required<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 检查登录</span><span class="token decorator annotation punctuation">@login_required</span><span class="token punctuation">(</span>login_url<span class="token operator">=</span><span class="token string">'/userprofile/login/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">article_create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 指定目前登录的用户为作者</span>    new_article<span class="token punctuation">.</span>author <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>request<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重启服务器，文章正确匹配到登录的用户，又可以愉快的写文章了。</p><blockquote><p>实际上，删除文章<code>article_delete()</code>、更新文章<code>article_update()</code>都应该对用户身份进行检查。就请读者尝试修改吧。</p></blockquote><h2 id="配置admin"><a href="#配置admin" class="headerlink" title="配置admin"></a>配置admin</h2><p>前面我们已经尝试过将<code>article</code>配置到<strong>admin</strong>后台，方法是非常简单的，直接在<code>admin.py</code>中写入<code>admin.site.register(Profile)</code>就可以了。但是这样写会导致<code>User</code>、<code>Profile</code>是两个分开的表，不方便不说，强迫症的你怎么能受得了。</p><p>我们希望能够在<strong>admin</strong>中将<code>User</code>、<code>Profile</code>合并为一张完整的表格。方法如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>admin<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>admin <span class="token keyword">import</span> UserAdmin <span class="token keyword">as</span> BaseUserAdmin<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Profile<span class="token comment"># 定义一个行内 admin</span><span class="token keyword">class</span> <span class="token class-name">ProfileInline</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>StackedInline<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Profile    can_delete <span class="token operator">=</span> <span class="token boolean">False</span>    verbose_name_plural <span class="token operator">=</span> <span class="token string">'UserProfile'</span><span class="token comment"># 将 Profile 关联到 User 中</span><span class="token keyword">class</span> <span class="token class-name">UserAdmin</span><span class="token punctuation">(</span>BaseUserAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>    inlines <span class="token operator">=</span> <span class="token punctuation">(</span>ProfileInline<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token comment"># 重新注册 User</span>admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>unregister<span class="token punctuation">(</span>User<span class="token punctuation">)</span>admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>User<span class="token punctuation">,</span> UserAdmin<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>打开<strong>admin</strong>中的<code>User</code>表，发现<code>Profile</code>的数据已经堆叠在底部了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181204/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE88.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181204/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE88.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><h2 id="本章勘误"><a href="#本章勘误" class="headerlink" title="本章勘误"></a>本章勘误</h2><blockquote><p>2019/06/19 新增：感谢读者 @shenhanlin 对本问题的反馈。</p></blockquote><p>本章中用到了信号来实现<code>User</code>和<code>Profile</code>的同步创建，但是也<strong>产生了一个BUG</strong>：在后台中创建<code>User</code>时如果填写了<code>Profile</code>任何内容，则系统报错且保存不成功；其他情况下均正常。</p><p><strong>BUG产生原因：</strong>在后台中创建并保存<code>User</code>时调用了信号接收函数，创建了<code>Profile</code>表；但如果此时管理员填写了内联的<code>Profile</code>表，会导致此表也会被创建并保存。最终结果就是同时创建了两个具有相同<code>User</code>的<code>Profile</code>表，违背了”一对一“外键的原则。</p><p>解决的办法也不难。因为博客项目的需求较简单，其实没有必要用到信号。</p><p>修改model，把两个信号接收函数去除：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">userprofile<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token keyword">class</span> <span class="token class-name">Profile</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    user <span class="token operator">=</span> models<span class="token punctuation">.</span>OneToOneField<span class="token punctuation">(</span>User<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span> related_name<span class="token operator">=</span><span class="token string">'profile'</span><span class="token punctuation">)</span>    phone <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    avatar <span class="token operator">=</span> models<span class="token punctuation">.</span>ImageField<span class="token punctuation">(</span>upload_to<span class="token operator">=</span><span class="token string">'avatar/%Y%m%d/'</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    bio <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'user &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username<span class="token punctuation">)</span>    <span class="token comment"># 下面的信号接收函数全部注释掉</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改view，使得<code>Profile</code>表根据是否已经存在而动态的创建、获取：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">userprofile<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 编辑用户信息</span><span class="token decorator annotation punctuation">@login_required</span><span class="token punctuation">(</span>login_url<span class="token operator">=</span><span class="token string">'/userprofile/login/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">profile_edit</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    user <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token comment"># 旧代码</span>    <span class="token comment"># profile = Profile.objects.get(user_id=id)</span>    <span class="token comment"># 修改后的代码</span>    <span class="token keyword">if</span> Profile<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user_id<span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        profile <span class="token operator">=</span> Profile<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        profile <span class="token operator">=</span> Profile<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>user<span class="token operator">=</span>user<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>即如果<code>Profile</code>已经存在了就获取它，如果不存在就创建一个新的。这样修改后应该就可以顺利的创建新用户了。</p><p>除了上面的方法，还有别的手段解决此问题：</p><ul><li>取消<code>Profile</code>在后台的内联，避免创建<code>User</code>的同时创建此表。</li><li>覆写<code>User</code>表的<code>save()</code>方法，跳过后台的自动保存。（不推荐）</li></ul><p>虽然博主做了不正确的示范，但是信号确实是很重要的概念，就当蜻蜓点水的介绍给大家。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章使用一对一链接的方式，扩展并更新了用户信息。读者可以根据自身需求，添加任何需要的字段内容。</p><p>下一章将学习对图片的简单处理。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#x75;&#115;&#97;&#x69;&#112;&#104;&#x6f;&#x74;&#111;&#x40;&#102;&#x6f;&#120;&#109;&#97;&#105;&#x6c;&#46;&#99;&#x6f;&#109;">&#x64;&#x75;&#115;&#97;&#x69;&#112;&#104;&#x6f;&#x74;&#111;&#x40;&#102;&#x6f;&#120;&#109;&#97;&#105;&#x6c;&#46;&#99;&#x6f;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><h2 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h2><pre><code>有一个bug 标记一下：用户更新文章的时候，没有鉴权，导致任意用户可以任意修改任何人的文章正常逻辑应该是管理员可以删除任何人的文章，只有用户本身可以修改自己的文章</code></pre>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--05.View视图初探</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/05.view-shi-tu-chu-tan/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/05.view-shi-tu-chu-tan/</url>
      
        <content type="html"><![CDATA[<p>数据库虽然已经有了，但是用户通常只需要这个庞大数据库中的很小一部分进行查看、修改等操作。为此还需要代码来恰当的取出并展示数据，这一部分代码就被称为<strong>视图</strong>。</p><p>Django 中视图的概念是<strong>「一类具有相同功能和模板的网页的集合」</strong>。比如，在一个博客应用中，你可能会创建如下几个视图：</p><ul><li>博客首页：展示最近的几项内容。</li><li>内容“详情”页：详细展示某项内容。</li><li>评论处理器：用于响应为一项内容添加评论的操作。</li></ul><p>这些需求都靠<strong>视图（View）</strong>来完成。</p><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World!"></a>Hello World!</h2><p>首先写一个最简单的<strong>视图函数</strong>，在浏览器中打印出<code>Hello World!</code>字符串。</p><p>打开<code>article/views.py</code>，写出视图函数：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token comment"># 导入 HttpResponse 模块</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse<span class="token comment"># 视图函数</span><span class="token keyword">def</span> <span class="token function">article_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>网页都是从视图派生而来。</strong>每一个视图表现为一个简单的Python函数，它必须要做的只有两件事：返回一个包含被请求页面内容的 <code>HttpResponse</code>对象，或者抛出一个异常，比如 <code>Http404</code> 。至于你还想干些什么，随便你。</p><p>视图函数中的<code>request</code>与网页发来的请求有关，里面包含<strong>get</strong>或<strong>post</strong>的内容、用户浏览器、系统等信息。Django调用<code>article_list</code>函数时会返回一个含字符串的 <code>HttpResponse</code>对象。</p><p>有了视图函数，还需要配置<strong>URLconfs</strong>，将用户请求的URL链接关联起来。换句话说，URLconfs的作用是将URL映射到视图中。</p><p>在<a href="https://www.dusaiphoto.com/article/article-detail/6/">前面的文章</a>中已经将URL分发给了<code>article</code>应用，因此这里只需要修改之前添加的<code>article/urls.py</code>就可以。添加以下代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token comment"># 引入views.py</span><span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token comment"># path函数将url映射到视图</span>    path<span class="token punctuation">(</span><span class="token string">'article-list/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>article_list<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'article_list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Django 将会根据用户请求的 URL 来选择使用哪个视图。</strong>本例中当用户请求<code>article/article-list</code>链接时，会调用<code>views.py</code>中的<code>article_list</code>函数，并返回渲染后的对象。参数<code>name</code>用于反查url地址，相当于给url起了个名字，以后会用到。</p><p>测试一下刚才敲的代码是否工作正常。</p><p><strong>在虚拟环境中</strong>，进入项目目录，也就是<code>my_blog</code>文件夹，输入<code>python manage.py runserver</code>，运行调试服务器：</p><pre class="line-numbers language-none"><code class="language-none">(env) E:\django_project\my_blog&gt;python manage.py runserverPerforming system checks...System check identified no issues (0 silenced).August 30, 2018 - 19:41:00Django version 2.1, using settings &#39;my_blog.settings&#39;Starting development server at http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;Quit the server with CTRL-BREAK.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>成功运行后，打开浏览器，输入url地址<code>http://127.0.0.1:8000/article/article-list/</code>，其中<code>127.0.0.1:8000</code>是调试服务器的本地地址，<code>article</code>是项目路由<code>my_blog\urls.py</code>分发的地址，<code>article-list</code>是刚才配置的<code>article\urls.py</code>应用分发的地址。</p><p>运气好的话，浏览器中会打印出<code>Hello World!</code>字符串：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180830/hello.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180830/hello.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>不到10行代码就完成了基本功能，是不是很神奇。</p><p>当然，只是小试牛刀。</p><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>在章节<a href="https://www.dusaiphoto.com/article/article-detail/11/">编写Model模型</a>中虽然定义了数据库表，但是这个表是空的，不方便展示View调取数据的效果。所以在写View之前，需要往数据表里记录一些数据。接下来就做这个工作。</p><h3 id="网站后台概念"><a href="#网站后台概念" class="headerlink" title="网站后台概念"></a>网站后台概念</h3><p><strong>网站后台</strong>，有时也称为<strong>网站管理后台</strong>，是指用于管理网站的一系列操作，如：数据的增加、更新、删除等。在项目开发的初期，因为没有真实的用户数据和完整的测试环境，会频繁地使用后台修改测试数据。</p><p>Django内置了一个很好的后台管理工具，只需要些少量代码，就可以实现强大的功能。</p><h3 id="创建管理员账号（Superuser）"><a href="#创建管理员账号（Superuser）" class="headerlink" title="创建管理员账号（Superuser）"></a>创建管理员账号（Superuser）</h3><p>管理员账号（Superuser）是可以进入网站后台，对数据进行维护的账号，具有很高的权限。这里我们需要创建一个管理员账号，以便添加后续的测试数据。</p><p><strong>虚拟环境</strong>中输入<code>python manage.py createsuperuser</code>指令，创建管理员账号：</p><pre class="line-numbers language-none"><code class="language-none">(env) E:\django_project\my_blog&gt;python manage.py createsuperuserUsername: FengqiEmail address: Fengqi@163.comPassword:Password (again):Superuser created successfully.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>指令会提示你输入账号名字、邮箱和密码，根据喜好填入即可。<br>这里我的账号密码一样：Fengqi</p><h3 id="将ArticlePost注册到后台中"><a href="#将ArticlePost注册到后台中" class="headerlink" title="将ArticlePost注册到后台中"></a>将ArticlePost注册到后台中</h3><p>接下来我们需要“告诉”Django，后台中需要添加<code>ArticlePost</code>这个数据表供管理。</p><p>打开<code>article/admin.py</code>，写入以下代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>admin<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin<span class="token comment"># 别忘了导入ArticlerPost</span><span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticlePost<span class="token comment"># 注册ArticlePost到admin中</span>admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>ArticlePost<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样就简单的注册好了。</p><h3 id="在后台中遨游"><a href="#在后台中遨游" class="headerlink" title="在后台中遨游"></a>在后台中遨游</h3><p>细心的同学可能已经发现，Django项目生成的时候就自动配置好了后台的settings和url，因此不需要我们再操心了。</p><p>启动server，在浏览器中输入<code>http://127.0.0.1:8000/admin/</code>，一切正常的话就看到下面的登录界面了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180906/1.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180906/1.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>输入刚才创建的管理员账号，登录进去：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180906/2.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180906/2.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>红框内就是刚才添加的<code>ArticlePost</code>数据表，点击进入后，再点击右上角的<code>ADD ARTICLE POST</code>按钮，到达如下页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180906/4.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180906/4.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>仔细看一下表单中的每一项，发现与<code>ArticlePost</code>中的字段完全符合；因为<code>updated</code>字段指定了自动添加，这里就没显示了。</p><p>将表单填好后，点击保存：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180906/5.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180906/5.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>可以看到ARTICLE POST中多了刚才录入的一条数据。按照同样的方法，再写入几条数据：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180906/6.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180906/6.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>至此准备工作就已经大功告成。</p><h2 id="检视数据库"><a href="#检视数据库" class="headerlink" title="检视数据库"></a>检视数据库</h2><blockquote><p>2018-10-29 新增内容</p></blockquote><p>通过上面的操作，我们的数据库中已经有1条用户数据、3条文章数据了。有的时候我需要检查数据库中的数据是否正确，但是项目中的数据库文件<code>db.sqlite3</code>又无法直接打开，怎么办呢？</p><p>这时候就需要用到专门处理SQLite数据文件的软件了：<a href="https://sqlitestudio.pl/index.rvt">SQLiteStudio</a></p><p>下载并安装，用它打开<code>db.sqlite3</code>，软件导航栏中就出现了数据库中保存的各类数据列表。比如说auth_user就是用户数据表了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181029/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE70.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181029/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE70.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>你可以用它检查项目代码中数据库的操作是否正常，这在开发阶段是非常实用的。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章初步感受了View的工作模式，创建了Superuser在后台录入了几条测试数据。</p><p>下一章将编写更有意义的View，准备好后老司机就开车了。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#117;&#x73;&#x61;&#105;&#x70;&#x68;&#x6f;&#x74;&#x6f;&#x40;&#102;&#x6f;&#x78;&#x6d;&#x61;&#105;&#108;&#x2e;&#x63;&#x6f;&#109;">&#x64;&#117;&#x73;&#x61;&#105;&#x70;&#x68;&#x6f;&#x74;&#x6f;&#x40;&#102;&#x6f;&#x78;&#x6d;&#x61;&#105;&#108;&#x2e;&#x63;&#x6f;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--02.教程的开发环境</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/02.jiao-cheng-de-kai-fa-huan-jing/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/02.jiao-cheng-de-kai-fa-huan-jing/</url>
      
        <content type="html"><![CDATA[<h2 id="教程的开发环境"><a href="#教程的开发环境" class="headerlink" title="教程的开发环境"></a>教程的开发环境</h2><p>本教程的开发环境为：</p><ul><li><strong>Win 10（64位）</strong></li><li><strong>Python 3.7.0</strong></li><li><strong>Django 3.0.8</strong></li></ul><p>为了避免开发环境不同而导致的错误，建议读者使用相同的版本。</p><h2 id="安装Python"><a href="#安装Python" class="headerlink" title="安装Python"></a>安装Python</h2><p>python的安装为比较简单，首先找到<a href="https://www.python.org/">Python官方网站</a>，选择python3.7的windows版本，下载并安装。</p><p><strong>安装时注意勾选添加python到环境变量中。</strong>如果没有或者漏掉这一步，请安装完毕后自行添加。</p><p>若实在不知道怎么弄的，看这篇文章：</p><p><a href="https://blog.csdn.net/random_w/article/details/78897365">windows上安装python3教程以及环境变量配置</a></p><p>安装完成后打开<a href="https://jingyan.baidu.com/article/046a7b3e83a505f9c27fa9a2.html">命令行</a>，输入<code>python -V</code>，系统打印出python的版本号，说明安装成功了：</p><pre class="line-numbers language-none"><code class="language-none">C:\Users\dusai&gt; python -VPython 3.7.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="配置虚拟环境"><a href="#配置虚拟环境" class="headerlink" title="配置虚拟环境"></a>配置虚拟环境</h2><p><strong>虚拟环境（virtualenv，或venv ）</strong>是 Python 多版本管理的利器，可以使每个项目环境与其他项目独立开来，保持环境的干净，解决包冲突问题。你可以将虚拟环境理解为一个隔绝的小系统。</p><p><strong>从Python3.3版本开始就自带了虚拟环境，不需要安装，配置一下就可以用了。</strong></p><p>新建一个文件夹，教程中为<code>django_project</code>。进入此文件夹：</p><pre class="line-numbers language-none"><code class="language-none">E:\&gt;cd django_projectE:\django_project&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>输入配置venv的命令，其中的<code>env</code>为虚拟环境的放置目录：</p><pre class="line-numbers language-none"><code class="language-none">E:\django_project&gt; python -m venv env  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>创建完成后，输入<code>env\Scripts\activate.bat</code>，即可进入虚拟环境：</p><pre class="line-numbers language-none"><code class="language-none">E:\django_project&gt; env\Scripts\activate.bat(env) E:\django_project&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>盘符前有<code>(env)</code>标识说明进入venv成功。</strong></p><h2 id="安装Django"><a href="#安装Django" class="headerlink" title="安装Django"></a>安装Django</h2><p><strong>在虚拟环境下</strong>，输入命令<code>pip install django==3.0.8</code>：</p><pre class="line-numbers language-none"><code class="language-none">(env) E:\django_project&gt; pip install django&#x3D;&#x3D;3.0.8Collecting django&#x3D;&#x3D;2.2  Using cached   ...  ...Successfully installed django-2.2(env) E:\django_project&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过指令<code>pip install django==3.0.8</code>来安装和教程相同版本的 Django。</p><p>系统打印出以上文字表示Django安装成功了。</p><blockquote><p>这里一定要指定版本号，否则就默认安装 Django 3 了。新手不要纠结版本问题，先跟着教程把基础掌握好。</p></blockquote><h2 id="创建Django项目"><a href="#创建Django项目" class="headerlink" title="创建Django项目"></a>创建Django项目</h2><p>还是在<strong>虚拟环境</strong>下，在<code>django_project</code>文件夹中创建Django项目：</p><pre class="line-numbers language-none"><code class="language-none">(env) E:\django_project&gt;django-admin startproject my_blog<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看<code>django_project</code>文件夹，发现多了<code>my_blog</code>文件夹，其结构应该是这样：</p><pre class="line-numbers language-none"><code class="language-none">my_blog│  db.sqlite3│  manage.py│└─my_blog    │  settings.py    │  urls.py    │  wsgi.py    └─ __init__.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这就是我们刚创建出来的项目了。</p><h2 id="运行Django服务器"><a href="#运行Django服务器" class="headerlink" title="运行Django服务器"></a>运行Django服务器</h2><p>非常幸运，Django自带一个轻量的Web开发服务器，也被叫做“runserver”。</p><p>开发服务器是为了让你快速开发Web程序，通过它可以避开配置生产环境的服务器的繁琐环节。</p><p>开发服务器会自动的检测代码的改变，并且自动加载它，因此在修改代码后不需要手动去重启服务器，非常的方便。</p><p>要运行这个django服务器，首先要进入<code>my_blog</code>文件夹，即含有<code>manage.py</code>文件的那个：</p><pre class="line-numbers language-none"><code class="language-none">(env) E:\django_project&gt;cd my_blog(env) E:\django_project\my_blog&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>输入命令<code>python manage.py runserver</code>：</p><pre class="line-numbers language-none"><code class="language-none">(env) E:\django_project\my_blog&gt;python manage.py runserverPerforming system checks...System check identified no issues (0 silenced).You have 15 unapplied migration(s). Your project may not work properly until you apply the migrations for app(s): admin, auth, contenttypes, sessions.Run &#39;python manage.py migrate&#39; to apply them.August 20, 2018 - 17:32:34Django version 2.2, using settings &#39;my_blog.settings&#39;Starting development server at http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;Quit the server with CTRL-BREAK.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>系统打印出这些信息，说明服务器启动成功了，打开chrome浏览器，输入<a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a> ，即倒数第2排信息提示我们的服务器地址。看到下面的界面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/avatar_thumbnail/hello_django_udoIHbf.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/avatar_thumbnail/hello_django_udoIHbf.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>恭喜你，小火箭起飞，django运行起来了！</p><h2 id="代码编辑器"><a href="#代码编辑器" class="headerlink" title="代码编辑器"></a>代码编辑器</h2><p>django运行起来后，我们还需要一款<strong>代码编辑器</strong>或者<strong>集成开发环境（IDE）</strong>来编辑python文件，以达到开发需求。</p><p>市面上有很多Python的代码编辑器或者集成开发环境可以选择。</p><p>教程使用了代码编辑器<strong>Sublime Text 3</strong>。它不是免费的，但是可以无限期试用，所以你不需要掏腰包。</p><p>进入<a href="https://www.sublimetext.com/3">Sublime Text 3官网</a>，下载对应版本的安装文件安装即可使用了。</p><p>当然你也可以根据喜好选择其他的编辑器或者开发环境：</p><ul><li><a href="https://blog.csdn.net/cH3RUF0tErmB3yH/article/details/80156176">10大Python集成开发环境和代码编辑器（指南）</a></li><li><a href="https://www.zhihu.com/question/20476960">写python程序什么编辑器最好用？</a></li></ul><h2 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h2><p>作为一个正经的web开发者，你的眼中应该只有<a href="https://www.google.com/chrome/">Chrome</a>！</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>经过以上一番折腾，总算是把趁手的工具都准备齐了。</p><p>准备好迎接正式的挑战吧。</p><ul><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--01.前言</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/01.qian-yan/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/01.qian-yan/</url>
      
        <content type="html"><![CDATA[<p><strong>Django</strong> 是一个由 <strong>Python</strong> 写成的开源Web应用框架，可以用它以更高的效率、更少的代码，搭建一个高性能的个人网站。</p><p>如果你以前从未接触过 web 开发，并且想快速上线自己的个性化网站，Django 绝对是你的最佳选择。</p><p><strong>本教程为零基础的小白准备，教你快速搭建一个自己的博客网站。</strong></p><h2 id="教程特点"><a href="#教程特点" class="headerlink" title="教程特点"></a>教程特点</h2><ul><li>零基础、免费、中文、完整项目代码</li><li>基于Python 3.6、Django 3.0.8 Bootstrap 4</li><li>漂亮的前端界面</li></ul><h2 id="适合人群"><a href="#适合人群" class="headerlink" title="适合人群"></a>适合人群</h2><ul><li>拥有一台能开机的电脑</li><li>有一点基础的 python 编程知识</li><li>每天能抽出一个小时学习</li></ul><p>不要犹豫说的就是你，现在立刻开始 Django 的学习吧！</p><h2 id="资源列表"><a href="#资源列表" class="headerlink" title="资源列表"></a>资源列表</h2><p>Django 的官方网站：<a href="https://www.djangoproject.com/">Django</a></p><p>撰写本文参考了以下资料，受益匪浅，并向读者强烈推荐：</p><ul><li><a href="https://www.itdiffer.com/">跟老齐学Python：Django实战</a> 书籍</li><li><a href="https://www.zmrenwu.com/">追梦人物的博客</a> 网站</li><li><a href="https://www.liaoxuefeng.com/">廖雪峰的官方网站</a> 网站</li><li><a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><p>项目开发完毕后使用 Git/GitHub 分布式管理：<a href="http://www.dusaiphoto.com/article/article-detail/13/">Windows环境下使用Git和GitHub</a></p><h2 id="遇到困难时怎么办"><a href="#遇到困难时怎么办" class="headerlink" title="遇到困难时怎么办"></a>遇到困难时怎么办</h2><ul><li><p>认真检查代码拼写、缩进是否正确。一个标点符号的错误可能会导致难以发现的问题</p></li><li><p>较简单的问题直接询问百度；若无法得到满意的答案请尝试 Google 以英文关键字搜索。<br>要坚信全世界这么多学习 Django 的人，你遇到的问题别人早就遇到过了</p></li><li><p><a href="https://www.djangoproject.com/">Django官方网站</a> 是最权威的学习文档，英语不佳的同学，要有耐心仔细阅读</p></li><li><p>实在无法处理的问题，可以暂时跳过。待到技术水平上升台阶，再回头来解决问题</p></li><li><p>若以上办法均不能解决你的问题，请在<a href="https://stackoverflow.com/">StackOverflow</a>等技术网站上求助，那里有海量的热心程序员在等着你的问题</p></li></ul><h2 id="关于Django版本"><a href="#关于Django版本" class="headerlink" title="关于Django版本"></a>关于Django版本</h2><p>Django 2 和 Django 3 在某些配置上又有细微的差别.</p><p>但是目前Django 3 基本已经稳定了， 所以影响基本有限。</p><p>放心大胆的学 Django 3 吧，绝大部分知识都是相同的。</p><h2 id="是时候展现真正的技术了"><a href="#是时候展现真正的技术了" class="headerlink" title="是时候展现真正的技术了"></a>是时候展现真正的技术了</h2><p>说了这么多，相信你已经迫不及待了。让我们赶紧开始旅程吧！</p>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django视频网站搭建--step1创建工程</title>
      <link href="/post/django-shi-pin-wang-zhan-da-jian/step1-chuang-jian-gong-cheng/"/>
      <url>/post/django-shi-pin-wang-zhan-da-jian/step1-chuang-jian-gong-cheng/</url>
      
        <content type="html"><![CDATA[<p>#基于django的视频点播网站开发<br>##项目介绍<br>本文将会对该项目进行一个简单的介绍，包括项目名称、项目背景、项目功能、技术栈等等。</p><p>项目名称: <strong>基于django的视频点播网站开发</strong></p><p>###项目背景</p><p>视频点播网站，搭建一个视频点播网站，练习学习一下django技术，学以致用。<br>项目功能</p><p>###项目功能<br>本项目分为前台和后台</p><p>前台功能</p><pre><code>视频列表展示视频播放详情详情评论个人中心</code></pre><p>后台功能</p><pre><code>视频管理评论管理用户管理反馈管理</code></pre><p>本讲中，主要搭建开发环境。我们会依次安装python、pip、django、mysql和其他的一些必要类库。<br>##安装python</p><p>安装 Python 非常简单，去 Python 官方网站 找到 Python3 的下载地址，根据你的系统选择32位或者64位的安装包，下载好后双击安装即可。</p><p>安装完毕后，在命令行输入 python -v ，如果输出了 Python 的版本号，说明 Python 已安装成功。</p><pre><code>$ python3 -VPython 3.8.0</code></pre><p>安装pip</p><p>如果已经安装了python3， 那么pip3一般会自动的被安装。<br>##安装django<br>安装django非常简单，一条命令搞定。</p><pre><code>pip3 install django</code></pre><p>##安装mysql<br>由于该项目使用的是mysql数据库，所以需要安装mysql。</p><p>如果你使用的是Windows或macOS系统，那么可以去 MySQL官网 直接下载安装包，一步步安装即可。<br>安装过程中会提示创建输账号和密码，一定要记得创建哦～。</p><p>ubuntu下使用命令apt-get install mysql-server安装mysql</p><pre><code>sudo apt-get install mysql-server</code></pre><p>Mysql5.7这个版本，安装过程中不会提示输入密码的，它的的root密码在/etc/mysql/debian.cnf这个文件里面<br>使用sudo cat /etc/mysql/debian.cnf命令打开，你大概会看到如下内容，其中就包括Mysql的默认登陆名与密码</p><pre><code>[client]host     = localhostuser     = debian-sys-maintpassword = Ah5gE7mWH1OxO9Gwsocket   = /var/run/mysqld/mysqld.sock[mysql_upgrade]host     = localhostuser     = debian-sys-maintpassword = Ah5gE7mWH1OxO9Gwsocket   = /var/run/mysqld/mysqld.sock</code></pre><p>1.使用 mysql -u用户名 -p密码进行登陆，</p><pre><code>mysql -udebian-sys-maint -p</code></pre><p>2、修改root用户密码</p><pre><code>show databases；use mysql;update user set authentication_string=PASSWORD(&quot;密码&quot;) where user=&#39;root&#39;;update user set plugin=&quot;mysql_native_password&quot;;flush privileges;quit;</code></pre><p>注:由于mysql5.7没有password字段，密码存储在authentication_string字段中</p><p>3、重新启动Mysql</p><pre><code>/etc/init.d/mysql restart</code></pre><p>4、再次使用root用户登陆<br>安装完毕后，可使用mysql -V查看mysql版本号。</p><pre><code>mysql -Vmysql  Ver 14.14 Distrib 5.7.31, for Linux (x86_64) using  EditLine wrapper</code></pre><p>然登录创建新的数据库，命名为video</p><pre><code>root -u root -pCREATE DATABASE video CHARACTER SET utf8;</code></pre><p>##安装PyCharm</p><p>PyCharm 是一款功能强大的 Python 编辑器，具有跨平台性。 我们项目所有功能的开发都是在pycharm上面完成的。</p><p>到PyCharm官网下载PyCharm安装包。<br>选择对应系统（Windows/Mac）的版本下载。一般学习用直接安装社区版本即可足够用。</p><p>下载之后，双击点下一步安装即可。<br>##其他安装</p><p>另外，下面这些是项目开发过程中会用到的类库，放到了requirements.txt里面</p><pre><code>django==3.0.8pillow==5.3.0 （图片显示）</code></pre><p>可以使用pip3直接安装</p><pre><code>pip3 install -r requiredments.txt</code></pre><p>##创建Django工程</p><p>一切就绪，我们创建django工程，仅需要一行命令</p><pre><code>django-admin startproject videoproject</code></pre><p>创建之后，可使用pycharm打开videoproject文件夹，查看文件结构</p><p>pycharm是很强大的，有自带的命令行工具（Terminal），版本控制工具（Version Control）。</p><p>###启动项目<br>打开Terminal，输入</p><pre><code>python3 manage.py runserver</code></pre><p>在之后的开发中，我们会经常用到该命令行来调试程序。</p><p>命令行输出</p><pre><code>Starting development server at http://127.0.0.1:8000/Quit the server with CONTROL-C.</code></pre><p>然后在浏览器地址栏输入<a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a> 即可看到django默认首页了。</p><p>###项目配置</p><p>项目的配置文件位于videoproject/videoproject/settings.py<br>配置编码</p><p>首先需要配置的是文字编码格式，django默认的编码是英语格式，我们把它改成中文格式，需要修改下面几个变量的值。</p><pre><code>LANGUAGE_CODE = &#39;zh-hans&#39;  # 中文编码TIME_ZONE = &#39;Asia/Shanghai&#39;  # 国际时区改为中国时区USE_I18N = True  # 指定Django的翻译系统是否开启。如果设置为False，Django会做一些优化，不去加载翻译机制USE_L10N = True  # 用于决定是否开启数据本地化。如果此设置为True，例如Django将使用当前语言环境的格式显示数字和日期。USE_TZ = True    # 用来指定是否使用指定的时区(TIME_ZONE)的时间。若为True, 则Django会使用内建的时区的时间；否则, Django将会使用本地的时间</code></pre><p>配置static</p><p>然后还需要配置资源文件目录，用于存储CSS、Javascript、Images等文件。这里我们设置目录为/static/</p><pre><code>STATIC_URL = &#39;/static/&#39;STATICFILES_DIRS = (os.path.join(BASE_DIR, &quot;static&quot;),)</code></pre><p>配置数据库</p><p>然后还需要配置数据库信息，django默认使用的是sqlite数据库，我们修改为mysql数据库。找到DATABASES节点，修改为如下代码。其中，NAME为数据库名，USER为mysql的用户名，PASSWORD为密码，HOSY为127.0.0.1，PORT为3306</p><pre><code>DATABASES = &#123;    &#39;default&#39;: &#123;        &#39;ENGINE&#39;: &#39;django.db.backends.mysql&#39;,        &#39;NAME&#39;: &#39;video&#39;,        &#39;USER&#39;: &#39;root&#39;,        &#39;PASSWORD&#39;: &#39;123456&#39;,        &#39;HOST&#39;:&#39;127.0.0.1&#39;,        &#39;PORT&#39;:&#39;3306&#39;,    &#125;&#125;</code></pre><p>配置好数据库之后，还需要在videoproject/videoproject/<strong>init</strong>.py安装mysql驱动，只需要写入代码：</p><pre><code>import pymysqlpymysql.install_as_MySQLdb()</code></pre><p>上面代码运行的前提是你电脑上已经安装了PyMySQL类库。</p><p>最后可再次运行工程，检查配置是否正确。</p>]]></content>
      
      
      <categories>
          
          <category> Django视频网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--03.创建app</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/03.chuang-jian-app/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/03.chuang-jian-app/</url>
      
        <content type="html"><![CDATA[<h2 id="创建APP"><a href="#创建APP" class="headerlink" title="创建APP"></a>创建APP</h2><p><strong>在Django中的一个app代表一个功能模块。</strong>开发者可以将不同功能的模块放在不同的app中, 方便代码的复用。app就是项目的基石，因此开发博客的第一步就是创建新的app，用来实现跟文章相关的功能模块。</p><p>打开命令行，进入项目所在的目录：<strong>（注意Django的操作必须在虚拟环境下进行）</strong></p><pre class="line-numbers language-none"><code class="language-none">E:\&gt;cd django_projectE:\django_project&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>进入虚拟环境（忘记进入venv方法的看这里： <a href="http://www.dusaiphoto.com/article/article-detail/4/">在Windows中搭建Django的开发环境</a>）：</p><pre class="line-numbers language-none"><code class="language-none"> E:\django_project&gt; env\Scripts\activate.bat(env) E:\&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>看到盘符前有<code>(env)</code>标识则表示进入虚拟环境成功。</p><p>输入<code>python manage.py startapp article</code>指令，创建名为<code>article</code>的app：</p><pre class="line-numbers language-none"><code class="language-none">(env) E:\django_project\my_blog&gt;python manage.py startapp article<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看一下<code>my_blog</code>文件夹，应该看到这样的结构：</p><pre class="line-numbers language-none"><code class="language-none">my_blog│  db.sqlite3│  manage.py│├─article│  │  admin.py│  │  apps.py│  │  models.py│  │  tests.py│  │  views.py│  │  __init__.py│  ││  └─migrations│        └─ __init__.py│└─my_blog    │  settings.py    │  urls.py    │  wsgi.py    └─ __init__.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>项目结构</strong>分解如下：</p><ul><li><p>根目录<code>my_blog</code>下有两个文件：db.sqlite3是一个轻量级的数据库文件，用来存储项目产生的数据，比如博客文章；manage.py是项目执行命令的入口，比如runserver。</p></li><li><p>目录<code>article</code>是刚创建出来的app，用来放置博客文章相关的代码：后台管理文件<code>admin.py</code>，数据模型文件<code>models.py</code>，视图文件<code>views.py</code>，存放数据迁移文件的目录<code>migrations</code>。</p></li><li><p>根目录下还有一个<code>my_blog</code>目录，其中的settings.py包含项目的配置参数，urls.py则是项目的根路由文件。</p></li></ul><p>目前你需要了解的就这么多，后面的章节都会用到。剩下还有一些没讲到的文件可以暂时不管它，碰到时再查资料。</p><h2 id="注册APP（settings）"><a href="#注册APP（settings）" class="headerlink" title="注册APP（settings）"></a>注册APP（settings）</h2><p><strong>接着我们需要修改项目配置文件，“告诉”Django现在有article这么一个app了。</strong></p><p>打开<code>my_blog</code>目录的<code>settings.py</code>，找到<code>INSTALLED_APPS</code>写入如下代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>pyINSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token comment"># 其他代码</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 新增'article'代码，激活app</span>    <span class="token string">'article'</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="配置访问路径（urls）"><a href="#配置访问路径（urls）" class="headerlink" title="配置访问路径（urls）"></a>配置访问路径（urls）</h2><p><strong>然后再给app配置访问路径url。</strong></p><p>url可以理解为访问网站时输入的网址链接，配置好url后Django才知道怎样定位app。</p><p>打开<code>my_blog</code>目录下的<code>urls.py</code>，增加以下代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin<span class="token comment"># 记得引入include</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> include<span class="token comment"># 存放映射关系的列表</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># 新增代码，配置app的url</span>    path<span class="token punctuation">(</span><span class="token string">'article/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'article.urls'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'article'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>path为Django的路由语法：</p><ul><li>参数<code>article/</code>分配了app的访问路径；</li><li><code>include</code>将路径分发给下一步处理；</li><li><code>namespace</code>可以保证反查到唯一的url，即使不同的app使用了相同的url（后面会用到）。</li></ul><p>记得在顶部引入<code>include</code>。</p><blockquote><p>在开发环境下，article的url为：<a href="http://127.0.0.1:8000/article/">http://127.0.0.1:8000/article/</a></p></blockquote><p><strong>还没结束</strong>。现在我们已经通过<code>path</code>将根路径为<code>article</code>的访问都分发给article这个app去处理。但是app通常有多个页面地址，因此还需要app自己也有一个路由分发，也就是<code>article.urls</code>了。</p><blockquote><p>article可以有多个页面，如列表页面、详情页面等，那么就需要如下两个url：</p><p><a href="http://127.0.0.1:8000/article/list/">http://127.0.0.1:8000/article/list/</a></p><p><a href="http://127.0.0.1:8000/article/detail/">http://127.0.0.1:8000/article/detail/</a></p><p>app中的url.py就是用来区分它们的。</p></blockquote><p>在app生成时并没有这个文件，因此需要自己在<code>article</code>文件夹中创建<code>urls.py</code>，在里面输入：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token comment"># 引入path</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token comment"># 正在部署的应用的名称</span>app_name <span class="token operator">=</span> <span class="token string">'article'</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token comment"># 目前还没有urls</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>urlpatterns</code>中暂时是空的，没写入任何路径的映射，不着急以后会写。</p><p>此时我们的app就配置完成了。</p><blockquote><p>注意此时app还没有写好，因此启动服务器可能会报错，是正常的。</p><p>Django2.0之后，app的<code>urls.py</code>必须配置<code>app_name</code>，否则会报错。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章创建了博客文章功能的app，学习了注册app并配置url。</p><p>下一章开始编写模型Model，理解Django的数据库处理。</p><ul><li><p>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</p></li><li><p>或Email私信我：<a href="mailto:&#100;&#117;&#x73;&#97;&#x69;&#x70;&#104;&#x6f;&#x74;&#x6f;&#64;&#102;&#x6f;&#x78;&#x6d;&#97;&#x69;&#108;&#46;&#99;&#x6f;&#109;">&#100;&#117;&#x73;&#97;&#x69;&#x70;&#104;&#x6f;&#x74;&#x6f;&#64;&#102;&#x6f;&#x78;&#x6d;&#97;&#x69;&#108;&#46;&#99;&#x6f;&#109;</a></p></li><li><p>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--04.编写Model</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/04.bian-xie-model/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/04.bian-xie-model/</url>
      
        <content type="html"><![CDATA[<p><strong>Django 框架主要关注的是模型（Model）、模板（Template）和视图（Views），称为MTV模式。</strong></p><p>它们各自的职责如下：</p><table><thead><tr><th>层次</th><th>职责</th></tr></thead><tbody><tr><td>模型（Model），即数据存取层</td><td>处理与数据相关的所有事务： 如何存取、如何验证有效性、包含哪些行为以及数据之间的关系等。</td></tr><tr><td>模板（Template），即业务逻辑层</td><td>处理与表现相关的决定： 如何在页面或其他类型文档中进行显示。</td></tr><tr><td>视图（View），即表现层</td><td>存取模型及调取恰当模板的相关逻辑。模型与模板的桥梁。</td></tr></tbody></table><p><strong>简单来说就是Model存取数据，View决定需要调取哪些数据，而Template则负责将调取出的数据以合理的方式展现出来。</strong></p><h2 id="数据库与模型"><a href="#数据库与模型" class="headerlink" title="数据库与模型"></a>数据库与模型</h2><p><strong>数据库</strong>是存储电子文件的场所，储存独立的数据集合。一个<strong>数据库</strong>由多个<strong>数据表</strong>构成。</p><p>啥意思？举个栗子，三年级二班中同学们的花名册就是<strong>数据表</strong>。有的花名册记录每位同学的考试成绩、有的记录身高体重、还有的记录兴趣爱好…所有的这些花名册都放在老师的柜子里，这个柜子就是<strong>“数据库”</strong>了。</p><blockquote><p>默认情况下，数据库就是db.sqlite3这个文件了。在网站上线后你可能想换别的数据库，不过目前我们还不需要讨论这个内容。</p></blockquote><p>操作数据库使用的是复杂的SQL语句，它是完全不同于Python的另一种语言，这对新手来说无疑是困难的。</p><p>幸运的是，在 Django 里写Web应用并不需要你直接去操作数据库，而是定义好<strong>模型</strong>（用Python语法就可以了！），<strong>模型</strong>中包含了操作数据库所必要的命令。也就是说你只需要定义数据模型，其它的底层代码都不用关心，它们会自动从模型生成。</p><blockquote><p>其实它有专门的术语，叫<strong>对象关系映射</strong>（<strong>Object Relational Mapping</strong>，简称<strong>ORM</strong>），用于实现面向对象编程语言里不同类型系统的数据之间的转换。</p></blockquote><h2 id="编写Model-py"><a href="#编写Model-py" class="headerlink" title="编写Model.py"></a>编写Model.py</h2><p><strong>如前面所讲，Django中通过模型（Model）映射到数据库，处理与数据相关的事务。</strong></p><p>对博客网站来说，最重要的数据就是文章。所以首先来建立一个存放文章的数据模型。</p><p>打开<code>article/models.py</code>文件，输入如下代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models<span class="token comment"># 导入内建的User模型。</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token comment"># timezone 用于处理时间相关事务。</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone<span class="token comment"># 博客文章数据模型</span><span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 文章作者。参数 on_delete 用于指定数据删除的方式</span>    author <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>User<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span>    <span class="token comment"># 文章标题。models.CharField 为字符串字段，用于保存较短的字符串，比如标题</span>    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>    <span class="token comment"># 文章正文。保存大量文本使用 TextField</span>    body <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 文章创建时间。参数 default=timezone.now 指定其在创建数据时将默认写入当前的时间</span>    created <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>default<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">)</span>    <span class="token comment"># 文章更新时间。参数 auto_now=True 指定每次数据更新时自动写入当前时间</span>    updated <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码非常直白。</p><ul><li><p>每个模型都被表示为 <code>django.db.models.Model</code> 类的子类，从它继承了操作数据库需要的所有方法。</p></li><li><p>每个字段都是 <code>Field</code> 类的实例 。比如字符字段被表示为 <code>CharField</code> ，日期时间字段被表示为 <code>DateTimeField</code>。这将告诉Django要处理的数据类型。</p></li><li><p>定义某些 <code>Field</code> 类实例需要参数。例如 <code>CharField</code> 需要一个 <code>max_length</code>参数。这个参数的用处不止于用来定义数据库结构，也用于验证数据。</p></li><li><p>使用 <code>ForeignKey</code>定义一个关系。这将告诉 Django，每个（或多个） <code>ArticlePost</code> 对象都关联到一个 <code>User</code> 对象。</p><blockquote><p>Django具有一个简单的账号系统（User），满足一般网站的用户相关的基本功能。</p></blockquote></li></ul><p><code>ArticlePost</code>类定义了一篇文章所必须具备的要素：作者、标题、正文、创建时间以及更新时间。</p><p>我们还可以额外再定义一些内容，规范<code>ArticlePost</code>中数据的行为：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 内部类 class Meta 用于给 model 定义元数据</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>    <span class="token comment"># ordering 指定模型返回的数据的排列顺序</span>    <span class="token comment"># '-created' 表明数据应该以倒序排列</span>        ordering <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'-created'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>    <span class="token comment"># 函数 __str__ 定义当调用对象的 str() 方法时的返回值内容</span>    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># return self.title 将文章标题返回</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>title<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>内部类<code>Meta</code>中的<code>ordering</code>定义了数据的排列方式。<code>-created</code>表示将以创建时间的倒序排列，保证了最新的文章总是在网页的最上方。注意<code>ordering</code>是元组，括号中只含一个元素时不要忘记末尾的逗号。</p></li><li><p><code>__str__</code>方法定义了需要表示数据时应该显示的名称。给模型增加 <code>__str__</code>方法是很重要的，它最常见的就是在Django管理后台中做为对象的显示值。因此应该总是返回一个友好易读的字符串。</p></li></ul><p>整理并去掉注释，全部代码放在一起是这样：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone<span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    author <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>User<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span>    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>    body <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span><span class="token punctuation">)</span>    created <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>default<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">)</span>    updated <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        ordering <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'-created'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>            <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>title<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>恭喜你，你已经完成了博客网站最核心的数据模型的大部分内容。</strong></p><p>代码不到20行，是不是完全没啥感觉。后面会慢慢体会Django的强大。</p><h3 id="抄还是敲？"><a href="#抄还是敲？" class="headerlink" title="抄还是敲？"></a>抄还是敲？</h3><p>学习本教程时，代码部分直接拷贝还是纯手敲？</p><p>直接拷贝的优点是学得很快，理解原理后，把代码往自己项目中刷刷刷拷贝过去，几下就能运行了。但这要求学习者有较强的自律能力：什么程度才能算已经“理解”了？</p><p>纯手敲就避免了这个问题，想快也快不起来，还经常遇到bug，在解决的过程中纠正自身的习惯性问题。但是手敲的好处必须保证你敲的时候大脑没有放空。</p><p><strong>博主的建议是：</strong></p><ul><li><strong>模型</strong>、<strong>视图</strong>代码量不多，又是重点学习内容，尽量纯手敲。</li><li><strong>模板</strong>根据个人情况，适当拷贝。</li></ul><blockquote><p>视图、模板马上就会讲到。</p></blockquote><h2 id="代码分解"><a href="#代码分解" class="headerlink" title="代码分解"></a>代码分解</h2><blockquote><p>这部分内容不能理解也没关系，先跳过，待水平提高再回过头来阅读。</p></blockquote><h3 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h3><p>Django框架基于python语言，而在python中用<code>import</code>或者<code>from...import</code>来导入模块。</p><p><strong>模块</strong>其实就一些函数和类的集合文件，它能实现一些相应的功能。当我们需要使用这些功能的时候，直接把相应的模块导入到我们的程序中就可以使用了。</p><p><code>import</code>用于导入整个功能模块。但实际使用时往往只需要用模块中的某一个功能，为此导入整个模块有点大材小用，因此可以用<code>from a import b</code>表示从模块<code>a</code>中导入<code>b</code>给我用就可以了。</p><h3 id="类"><a href="#类" class="headerlink" title="类"></a>类</h3><p>Python作为面向对象编程语言，最重要的概念就是<strong>类</strong>（Class）和<strong>实例</strong>（Instance）。</p><p>类是抽象的模板，而实例是根据这个类创建出来的一个个具体的“对象”。每个对象都拥有相同的方法，但各自的数据可能不同。而这些方法被打包封装在一起，就组成了类。</p><p>比如说我们刚写的这个<code>ArticlePost</code>类，作用就是就为博客文章的内容提供了一个模板。每当有一篇新文章生成的时候，都要比对<code>ArticlePost</code>类来创建<code>author</code>、<code>title</code>、<code>body</code>…等等数据；虽然每篇文章的具体内容可能不一样，但是必须都遵循相同的规则。</p><p>在Django中，数据由模型来处理，而模型的载体就是类（Class）。</p><h3 id="字段"><a href="#字段" class="headerlink" title="字段"></a>字段</h3><p><strong>字段</strong>（field）表示数据库表的一个抽象类，Django使用字段类创建数据库表，并将Python类型映射到数据库。</p><p>在模型中，字段被实例化为类属性并表示特定的表，同时具有将字段值映射到数据库的属性及方法。</p><p>比方说<code>ArticlePost</code>类中有一个<code>title</code>的属性，这个属性中保存着<code>Charfield</code>类型的数据：即一个较短的字符串。</p><h3 id="外键"><a href="#外键" class="headerlink" title="外键"></a>外键</h3><p>数据库中有各种各样的数据表，有时候几张表的数据是互相关联的。比如一张表记录了所有的文章，另一张表记录了所有的用户，而文章是用户发表的，这时候这两张表就产生了关系。<strong>外键</strong>就是用来表示这种关系的。</p><p>而<code>ForeignKey</code>是用来解决“<strong>一对多</strong>”关系的。那什么又叫“一对多”？</p><p>在我们的<code>ArticlePost</code>模型中，一篇文章只能有一个作者，而一个作者可以有很多篇文章，这就是“一对多”关系。</p><p>又比如一个班级的同学中，每个同学只能有一种性别，而每种性别可以对应很多的同学，这也是“一对多”。</p><p>因此，通过<code>ForeignKey</code>外键，将<code>User</code>和<code>ArticlePost</code>关联到了一起，最终就是将博客文章的作者和网站的用户关联在一起了。</p><p>既然有“一对多”，当然也有<strong>“一对一”（<code>OneToOneField </code>）、“多对多”（<code>ManyToManyField</code>）</strong>。目前用不到这些外键，后面再回头来对比其差别。</p><blockquote><p>Django2.0 之前的版本外键的<code>on_delete</code>参数可以不填；Django2.0以后<code>on_delete</code>是必填项。</p></blockquote><h3 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h3><p>内部类<code>class Meta</code>提供模型的元数据。元数据是<strong>“任何不是字段的东西”</strong>，例如排序选项<code>ordering</code>、数据库表名<code>db_table</code>、单数和复数名称<code>verbose_name</code>和 <code>verbose_name_plural</code>。这些信息不是某篇文章私有的数据，而是整张表的共同行为。</p><p>要不要写内部类是完全可选的，当然有了它可以帮助理解并规范类的行为。</p><p>在<code>ArticlePost</code>中我们使用的元数据<code>ordering = (&#39;-created&#39;,)</code>，表明了每当我需要取出文章列表，作为博客首页时，按照<code>-created</code>（即文章创建时间，负号标识倒序）来排列，保证了最新文章永远在最顶部位置。</p><h2 id="数据迁移（Migrations）"><a href="#数据迁移（Migrations）" class="headerlink" title="数据迁移（Migrations）"></a>数据迁移（Migrations）</h2><p>编写好了Model后，接下来就需要进行数据迁移。迁移是Django对模型所做的更改传递到数据库中的方式。</p><p><strong>注意，每当对数据库进行了更改（添加、修改、删除等）操作，都需要进行数据迁移。</strong></p><p>Django的迁移代码是由模型文件自动生成的，它本质上只是个历史记录，Django可以用它来进行数据库的滚动更新，通过这种方式使其能够和当前的模型匹配。</p><p>在虚拟环境中进入<code>my_blog</code>文件夹（还没熟悉venv的再温习: <a href="http://www.dusaiphoto.com/article/article-detail/4/">在Windows中搭建Django的开发环境</a>），输入<code>python manage.py makemigrations</code>，对模型的更改创建新的迁移表：</p><pre class="line-numbers language-none"><code class="language-none">(env) e:\django_project\my_blog&gt;python manage.py makemigrationsMigrations for &#39;article&#39;:  article\migrations\0001_initial.py    - Create model ArticlePost(env) e:\django_project\my_blog&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过运行 <code>makemigrations</code> 命令，Django 会检测你对模型文件的修改，并且把修改的部分储存为一次迁移。</p><p>然后输入<code>python manage.py migrate</code>，<strong>应用迁移到数据库中</strong>：</p><pre class="line-numbers language-none"><code class="language-none">(env) e:\django_project\my_blog&gt;python manage.py migrateOperations to perform:  Apply all migrations: admin, article, auth, contenttypes, sessionsRunning migrations:  Applying contenttypes.0001_initial... OK  ...  Applying sessions.0001_initial... OK(env) e:\django_project\my_blog&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>migrate</code> 命令选中所有还没有执行过的迁移并应用在数据库上，也就是将模型的更改同步到数据库结构上。迁移是非常强大的功能，它能让你在开发过程中持续的改变数据库结构而不需要重新删除和创建表。它专注于使数据库平滑升级而不会丢失数据。</p><blockquote><p>有点拗口，也有点枯燥，坚持。乐趣在后面。</p></blockquote><p><strong>再重复一次</strong>：每当你修改了<code>models.py</code>文件，都需要用<code>makemigrations</code>和<code>migrate</code>这两条指令迁移数据。</p><p>在迁移之后，Model的编写就算完成了。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章初步了解了Django的MTV模式，编写了博客文章的Model模型<code>ArticlePost</code>，并将其迁移到了数据库中。</p><p>下一步就向View进军，学习如何调取模型中的数据。</p><ul><li><p>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</p></li><li><p>或Email私信我：<a href="mailto:&#x64;&#117;&#x73;&#97;&#x69;&#112;&#x68;&#x6f;&#x74;&#x6f;&#x40;&#102;&#111;&#x78;&#x6d;&#97;&#x69;&#108;&#x2e;&#99;&#111;&#109;">&#x64;&#117;&#x73;&#97;&#x69;&#112;&#x68;&#x6f;&#x74;&#x6f;&#x40;&#102;&#111;&#x78;&#x6d;&#97;&#x69;&#108;&#x2e;&#99;&#111;&#109;</a></p></li><li><p>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--06.View及Template</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/06.view-ji-template/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/06.view-ji-template/</url>
      
        <content type="html"><![CDATA[<h2 id="改写视图函数"><a href="#改写视图函数" class="headerlink" title="改写视图函数"></a>改写视图函数</h2><p>上一章我们感受了视图的工作流程。</p><p><strong>为了让视图真正发挥作用，</strong>改写<code>article/views.py</code>中的<code>article_list</code>视图函数：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token comment"># 导入数据模型ArticlePost</span><span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticlePost<span class="token keyword">def</span> <span class="token function">article_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 取出所有博客文章</span>    articles <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 需要传递给模板（templates）的对象</span>    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'articles'</span><span class="token punctuation">:</span> articles <span class="token punctuation">&#125;</span>    <span class="token comment"># render函数：载入模板，并返回context对象</span>    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码同样很直白，分析如下：</p><ul><li><p><code>from .models import ArticlePost</code>从<code>models.py</code>中导入<code>ArticlePost</code>数据类</p></li><li><p><code>ArticlePost.objects.all()</code>是数据类的方法，可以获得所有的对象（即博客文章），并传递给<code>articles</code>变量</p></li><li><p><code>context</code>定义了需要传递给<strong>模板</strong>的上下文，这里即<code>articles</code></p><blockquote><p>模板的概念马上就要讲。</p></blockquote></li><li><p>最后返回了<code>render</code>函数。它的作用是结合模板和上下文，并返回渲染后的HttpResponse对象。通俗的讲就是把context的内容，加载进模板，并通过浏览器呈现。</p></li></ul><p><code>render</code>的变量分解如下：</p><ul><li>request是固定的<code>request</code>对象，照着写就可以</li><li><code>article/list.html</code>定义了模板文件的位置、名称</li><li><code>context</code>定义了需要传入模板文件的上下文</li></ul><p>视图函数这样就写好了。</p><h2 id="编写模板（template）"><a href="#编写模板（template）" class="headerlink" title="编写模板（template）"></a>编写模板（template）</h2><p>在前面的视图中我们定义了模板的位置在<code>article/list.html</code>，因此在根目录下新建<code>templates</code>文件夹，再新建<code>article</code>文件夹，再新建<code>list.html</code>文件，即：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog│  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>├─article│  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>└─my_blog│  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>└─templates    └─ article        └─ <span class="token builtin">list</span><span class="token punctuation">.</span>html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>细心的你肯定注意到了，之前的Django文件后缀都是<code>.py</code>，代表Python文件；这里的模板文件后缀是<code>.html</code>，这又是什么呢？</p><p><strong>HTML是一种用于创建网页的标记语言。</strong>它被用来结构化信息，标注哪些文字是标题、哪些文字是正文等（当然不仅仅这点功能）。也可以简单理解为“给数据排版”的文件，跟你写文档用的Office Word一样一样的 。</p><p>在<code>list.html</code>文件中写入：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html&#123;% for article in articles %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>&#123;&#123; article.title &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>&#123;% endfor %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Django通过模板来动态生成HTML，其中就包含描述动态内容的一些特殊语法：</p><ul><li><p> <code>&#123;% for article in articles %&#125;`：`articles`为视图函数的`context`传递过来的上下文，即所有文章的集合。`&#123;% for %&#125;`循坏表示依次取出`articles`中的元素，命名为`article`，并分别执行接下来操作。末尾用`&#123;% endfor %&#125;</code>告诉Django循环结束的位置。</p></li><li><p>使用<code>.</code>符号来访问变量的属性。这里的<code>article</code>为模型中的某一条文章；我们在前面的<code>ArticlePost</code>中定义了文章的标题叫<code>title</code>，因此这里可以用<code>article.title</code>来访问文章的标题。</p></li><li><p><code>&lt;p&gt;...&lt;/p&gt;</code>即为html语言，中间包裹了一个段落的文字。</p></li></ul><p>在上一章中已经定义好了<code>urls.py</code>，因此不再需要改动了。</p><p>一切都很好，深吸一口气。保存所有文件，在浏览器中输入地址<code>http://127.0.0.1:8000/article/article-list/</code>，得到以下错误：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180911/terror.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180911/terror.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>似乎成功从来都不会很顺利。</p><h2 id="错误分析"><a href="#错误分析" class="headerlink" title="错误分析"></a>错误分析</h2><p>虽然出错了，好在Django提供了非常完善的错误处理系统，方便开发者快速找到Bug的蛛丝马迹。</p><p>第一行就醒目地提示：<strong>TemplateDoesNotExist</strong>，说明Django没有找到<code>list.html</code>这个文件。仔细检查目录、文件的名称无误，没问题就往下继续看。</p><p>然后发现有这么两行：</p><pre class="line-numbers language-none"><code class="language-none">...django\contrib\admin\templates\article\list.html (Source does not exist)...django\contrib\auth\templates\article\list.html (Source does not exist)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>似乎Django在这两个位置搜索（没有在刚创建的templates目录），没有发现需要的文件，然后返回了“未发现模板文件”的错误。</p><p>定位了问题的所在，接下来就是在如何“告诉”Django我的模板位置呢？</p><p>答案就在<code>settings.py</code>中了，它保存了Django项目的各种<strong>初始配置</strong>。</p><p>打开并找到这一段，加入代码<code>os.path.join(BASE_DIR, &#39;templates&#39;)</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>pyTEMPLATES <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 定义模板位置</span>        <span class="token string">'DIRS'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'templates'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这就是说模板文件在项目根目录的<code>templates</code>文件夹中，去找找吧。</p><p>保存文件，重新启动服务器：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180911/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE29.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180911/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE29.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>成功！</p><p>虽然简陋，但是已经走通了MTV（model、template、view）环路。</p><p>不要激动，精彩的还在后面。</p><h3 id="三个工具"><a href="#三个工具" class="headerlink" title="三个工具"></a>三个工具</h3><blockquote><p>此节为 2019/6/1 新增</p></blockquote><p>读者在开发中每天都会遇到各种各样的问题。</p><p>解决问题的方法很多，其中有三个工具非常的有效，着重提一下：</p><ul><li><p><strong>Django报错页面</strong>：就是上面出现的那个黄黄的报错页面啦。Django报错页面在大多数情况下都能准确的判断错误类型、错误抛出的位置、甚至是解决方案。读者千万不要觉得读这么多英文好麻烦啊，其实重点就那么几句话。</p></li><li><p><strong>浏览器控制台</strong>：如果你用的浏览器是Chrome，那么打开控制台的快捷键是<code>Ctrl + Shift + i</code>。控制台里又有两个子页面很常用：<strong>Elements</strong>这里列出整个网页源码，可以在这里查看css样式的继承情况、容器的相互关系，甚至可以动态修改源码查看效果。<strong>Console</strong>类似运行Django的命令行。如果浏览器运行网页时遇到故障（比如<code>404 未找到资源</code>、<code>403 服务器通讯失败</code>、<code>500 服务器内部错误</code>），都会在这里提示。以后还可以在JavaScript代码中用<code>console.log()</code>指令将感兴趣的内容打印到Console中查看。<strong>非常非常有用</strong>。</p></li><li><p>**print()**：很多读者在写纯Python代码时知道用<code>print()</code>来查找bug，到Django中反而不会了。其实Django也是一样的，在视图函数中写的<code>print()</code>会打印到命令行中。</p></li></ul><p>依靠这三个工具，基本上就能给出90%以上的错误信息了。接下来就是把错误的关键词放到Google、Bing这些地方去搜索答案了。</p><p>再强调一下敲代码要细心。我发现很多读者的bug都是源自于拼写、缺行漏行这种让人沮丧的错误。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章我们重写了视图，编写了简单的模板，和前面的模型成功关联起来。</p><p>下一章将学习编写一个漂亮的网页模板。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#117;&#x73;&#x61;&#x69;&#112;&#x68;&#x6f;&#116;&#111;&#x40;&#102;&#x6f;&#120;&#109;&#x61;&#x69;&#x6c;&#x2e;&#99;&#x6f;&#109;">&#100;&#117;&#x73;&#x61;&#x69;&#112;&#x68;&#x6f;&#116;&#111;&#x40;&#102;&#x6f;&#120;&#109;&#x61;&#x69;&#x6c;&#x2e;&#99;&#x6f;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--07.使用Bootstrap改写模板</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/07.shi-yong-bootstrap-gai-xie-mo-ban/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/07.shi-yong-bootstrap-gai-xie-mo-ban/</url>
      
        <content type="html"><![CDATA[<p><strong>注意：学本章之前请检查 Django 版本，确保安装的是 Django 2 而不是 Django 3，否则后面所有的章节都会遇到 <code>staticfiles</code> 无法载入的错误。</strong></p><blockquote><p>在虚拟环境中输入 <code>pip list</code> 即可查看。</p></blockquote><p>上一章我们的网站页面实在太粗糙，你肯定不会拿来做真正的博客首页。因此这章我们要借助Bootstrap的力量，改写一个大气的博客。</p><h2 id="配置Bootstrap-4"><a href="#配置Bootstrap-4" class="headerlink" title="配置Bootstrap 4"></a>配置Bootstrap 4</h2><p><strong>Bootstrap</strong>是用于网站开发的开源前端框架（“前端”指的是展现给最终用户的界面），它提供字体排印、窗体、按钮、导航及其他各种组件，旨在使动态网页和Web应用的开发更加容易。</p><p>Bootstrap有几个版本都比较流行，<strong>我们选择最新版本的Bootstrap 4：</strong><a href="https://getbootstrap.com/docs/4.1/getting-started/download/">下载地址</a>，并解压。</p><p>然后在项目根目录下新建目录<code>static/bootstrap/</code>，用于存放Bootstrap静态文件。<strong>静态文件</strong>通常指那些不会改变的文件。Bootstrap中的css、js文件，就是静态文件。</p><p>把刚才解压出来的<code>css</code>和<code>js</code>两个文件夹复制进去。</p><p><strong>因为bootstrap.js依赖 jquery.js 和 popper.js 才能正常运行，因此这两个文件我们也需要一并下载保存。</strong>附上官网下载链接（进入下载页面，复制粘贴代码到新文件即可）：</p><ul><li><a href="https://jquery.com/download/">jquery.js</a></li><li><a href="https://popper.js.org/">popper.js</a></li></ul><blockquote><p>2018-10-29 新增：</p><p>不清楚<code>popper.js</code>如何下载的戳这个链接：</p><p><code>https://unpkg.com/popper.js@1.14.4/dist/umd/popper.js</code></p><p>进去后页面显示很长一段代码，把这段代码全部拷贝；在项目中新建名叫popper.js的文件，把刚拷贝的代码复制进去就可以了。很多开源js文件都是通过这样的方式下载。</p></blockquote><p>现在我们的<code>static/</code>目录结构像这样：</p><pre class="line-numbers language-none"><code class="language-none">my_blog│├─article└─my_blog│ ...└─static    └─bootstrap    │   ├─css # 文件夹    │   └─js # 文件夹    └─jquery    │   └─jquery-3.3.1.js # 文件    └─popper        └─popper-1.14.4.js # 文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因为在Django中需要指定静态文件的存放位置，才能够在模板中正确引用它们。因此在<code>settings.py</code>的末尾加上：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>STATICFILES_DIRS <span class="token operator">=</span> <span class="token punctuation">(</span>    os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">"static"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再确认一下<code>settings.py</code>中有没有<code>STATIC_URL = &#39;/static/&#39;</code>字段，如果没有把它也加在后面。</p><h2 id="编写模板"><a href="#编写模板" class="headerlink" title="编写模板"></a>编写模板</h2><p>在根目录下的<code>templates/</code>中，新建三个文件：</p><ul><li><p><code>base.html</code>是整个项目的模板基础，所有的网页都从它继承；</p></li><li><p><code>header.html</code>是网页顶部的导航栏；</p></li><li><p><code>footer.html</code>是网页底部的注脚。</p></li></ul><p>这三个文件在每个页面中通常都是不变的，独立出来可以避免重复写同样的代码，提高维护性。</p><p>现在<code>templates\</code>的结构像下面这个样子：</p><pre class="line-numbers language-none"><code class="language-none">templates│├─base.html├─header.html├─footer.html└─article    └─list.html # 上一章创建的<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>加上之前的<code>list.html</code>，接下来就要重新写这4个文件了。</p><p>因为前端知识非常博大精深，并且也不是Django学习的重点，本教程不会展开篇幅去讲。<strong>如果之前没接触过前端知识也没关系，这里可以先复制粘贴，不影响后面Django的学习。</strong></p><p>你可以试着改写其中的某段代码，看看会对页面产生什么样的影响；遇到不懂的就在<a href="https://getbootstrap.com/docs/4.1/getting-started/introduction/">Bootstrap官方文档</a>找答案。慢慢就会明白它的运行机制，毕竟Bootstrap真的是非常简单易用的工具。</p><blockquote><p>2018-10-29 新增：</p><p>Bootstrap是非常优秀的前端框架，上手简单，所以很流行。</p><p>官网是最权威的文档。你可以在官方网站上进行系统的学习：<a href="https://getbootstrap.com/docs/4.1/getting-started/introduction/">https://getbootstrap.com/docs/4.1/getting-started/introduction/</a></p><p>通篇去看Bootstrap文档会非常枯燥的，因此建议你可以像查字典一样的，需要用哪个模块，就到官网上找相关的代码，修改一下拷贝到你的项目中就可以了。用多了自然会明白每个字段的作用。</p></blockquote><p><strong>这里会一次性写大量代码，不要着急慢慢看，理解了就很简单了。</strong></p><p>首先写<code>base.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/base.html<span class="token comment">&lt;!-- 载入静态文件 --></span>&#123;% load staticfiles %&#125;<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- 网站主语言 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zh-cn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 网站采用的字符编码 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 预留网站标题的位置 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>&#123;% block title %&#125;&#123;% endblock %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 引入bootstrap的css文件 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>bootstrap/css/bootstrap.min.css<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 引入导航栏 --></span>    &#123;% include 'header.html' %&#125;    <span class="token comment">&lt;!-- 预留具体页面的位置 --></span>    &#123;% block content %&#125;&#123;% endblock content %&#125;    <span class="token comment">&lt;!-- 引入注脚 --></span>    &#123;% include 'footer.html' %&#125;    <span class="token comment">&lt;!-- bootstrap.js 依赖 jquery.js 和popper.js，因此在这里引入 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>jquery/jquery-3.3.1.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>popper/popper-1.14.4.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- 引入bootstrap的js文件 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>bootstrap/js/bootstrap.min.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>模板中要加上 <code>&#123;% load staticfiles %&#125;</code> 之后，才可使用 <code>&#123;% static 'path' %&#125;</code> 引用静态文件。</li><li>HTML语法中，所有的内容都被标签包裹；标签及标签中的属性可以对内容进行排印、解释说明等作用。</li><li><code>&lt;head&gt;&lt;/head&gt;</code>标签内包含网页的元数据，是不会在页面内显示出来的。<code>&lt;body&gt;&lt;/body&gt;</code>标签内才是网页会显示的内容。</li><li>留意Bootstrap的css、js文件分别是如何引入的</li><li> jquery.js 和 popper.js 要在 bootstrap.js 前引入。</li></ul><p>然后是<code>header.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/header.html<span class="token comment">&lt;!-- 定义导航栏 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navbar navbar-expand-lg navbar-dark bg-dark<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 导航栏商标 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navbar-brand<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>我的博客<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 导航入口 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navbar-nav<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- 条目 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-link<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>文章<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>标签内的<code>class</code>属性是Bootstrap样式的定义方法。试着改写或删除其中一些内容，观察页面的变化。</p><p>然后改写之前的<code>list.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html<span class="token comment">&lt;!-- extends表明此页面继承自 base.html 文件 --></span>&#123;% extends "base.html" %&#125;&#123;% load staticfiles %&#125;<span class="token comment">&lt;!-- 写入 base.html 中定义的 title --></span>&#123;% block title %&#125;    首页&#123;% endblock title %&#125;<span class="token comment">&lt;!-- 写入 base.html 中定义的 content --></span>&#123;% block content %&#125;<span class="token comment">&lt;!-- 定义放置文章标题的div容器 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row mt-2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        &#123;% for article in articles %&#125;        <span class="token comment">&lt;!-- 文章内容 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-4 mb-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- 卡片容器 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card h-100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 标题 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card-header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; article.title &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 摘要 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card-body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card-text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; article.body|slice:'100' &#125;&#125;...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 注脚 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card-footer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>阅读本文<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        &#123;% endfor %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>留意<code>&#123;% block title %&#125;</code>和<code>&#123;% block content %&#125;</code>是如何与<code>base.html</code>中相对应起来的。</li><li>摘要中的<code>&#123;&#123; article.body|slice:'100' &#125;&#125;</code>取出了文章的正文；其中的<code>|slice:&#39;100&#39;</code>是Django的过滤器语法，表示取出正文的前100个字符，避免摘要太长。</li></ul><p>最后写入<code>footer.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&#123;% load staticfiles %&#125;<span class="token comment">&lt;!-- Footer --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>footer</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>py-3 bg-dark fixed-bottom<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>m-0 text-center text-white<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Copyright <span class="token entity named-entity" title="&copy;">&amp;copy;</span> www.dusaiphoto.com 2018<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>footer</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>呼，真是一大堆的东西啊。</p><p><strong>让我们来捋一捋发生了什么：</strong></p><p>当我们通过<code>url</code>访问<code>list.html</code>时，顶部的<code>&#123;% extends "base.html" %&#125;</code>告诉Django：“这个文件是继承<code>base.html</code>的，你去调用它吧。”</p><p>于是Django就老老实实去渲染<code>base.html</code>文件：</p><ul><li>其中的<code>&#123;% include 'header.html' %&#125;</code>表明这里需要加入<code>header.html</code>的内容</li><li><code>&#123;% include 'footer.html' %&#125;</code>加入<code>footer.html</code>的内容</li><li><code>&#123;% block content %&#125;&#123;% endblock content %&#125;</code>表明这里应该加入<code>list.html</code>中的对应块的内容</li></ul><h2 id="运行服务器"><a href="#运行服务器" class="headerlink" title="运行服务器"></a>运行服务器</h2><p>老规矩，保存全部文件，进入虚拟环境，运行开发服务器，在浏览器中输入<code>http://127.0.0.1:8000/article/article-list/</code>，看到如下页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180916/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE32.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180916/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE32.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>一个漂亮的博客界面就这样出现在眼前，非常神奇。</p><p><strong>如果报错也不要着急，程序员就是不断与bug斗争的一个职业。</strong>仔细检查Django给出的错误提示，修复它，你一定行。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章我们引入了前端框架Bootstrap 4，借助它重新组织了模板的结构，编写了一个漂亮的博客网站的首页。</p><p>下一章我们将学习编写文章详情页面。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#x75;&#115;&#x61;&#105;&#112;&#104;&#x6f;&#x74;&#111;&#x40;&#102;&#x6f;&#120;&#x6d;&#97;&#105;&#108;&#x2e;&#x63;&#x6f;&#x6d;">&#100;&#x75;&#115;&#x61;&#105;&#112;&#104;&#x6f;&#x74;&#111;&#x40;&#102;&#x6f;&#120;&#x6d;&#97;&#105;&#108;&#x2e;&#x63;&#x6f;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--09.使用Markdown书写文章</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/09.shi-yong-markdown-shu-xie-wen-zhang/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/09.shi-yong-markdown-shu-xie-wen-zhang/</url>
      
        <content type="html"><![CDATA[<p>上一章我们实现了文章详情页面。为了让文章正文能够进行标题、加粗、引用、代码块等不同的排版（像在Office中那样！），我们将使用Markdown语法。</p><h2 id="安装Markdown"><a href="#安装Markdown" class="headerlink" title="安装Markdown"></a>安装Markdown</h2><p><strong>Markdown</strong>是一种轻量级的标记语言，它允许人们“使用易读易写的纯文本格式编写文档，然后转换成有效的或者HTML文档。建议读者一定要花五分钟时间熟悉一下Markdown的语法，熟练后码字效率一定会大幅提高。</p><p>关于Markdown语法看这里：<a href="https://coding.net/help/doc/project/markdown.html">Markdown 语法介绍</a></p><p>安装markdown也很简单：进入虚拟环境，输入指令<code>pip install markdown</code>即可。</p><h2 id="使用Markdown"><a href="#使用Markdown" class="headerlink" title="使用Markdown"></a>使用Markdown</h2><p>为了将Markdown语法书写的文章渲染为HTML文本，首先改写<code>article/views.py</code>的<code>article_detail()</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 引入markdown模块</span><span class="token keyword">import</span> markdown<span class="token keyword">def</span> <span class="token function">article_detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token comment"># 将markdown语法渲染成html样式</span>    article<span class="token punctuation">.</span>body <span class="token operator">=</span> markdown<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>article<span class="token punctuation">.</span>body<span class="token punctuation">,</span>        extensions<span class="token operator">=</span><span class="token punctuation">[</span>        <span class="token comment"># 包含 缩写、表格等常用扩展</span>        <span class="token string">'markdown.extensions.extra'</span><span class="token punctuation">,</span>        <span class="token comment"># 语法高亮扩展</span>        <span class="token string">'markdown.extensions.codehilite'</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">)</span>    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'article'</span><span class="token punctuation">:</span> article <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/detail.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码中<code>markdown.markdown</code>语法接收两个参数：第一个参数是需要渲染的文章正文<code>article.body</code>；第二个参数载入了常用的语法扩展，<code>markdown.extensions.extra</code>中包括了缩写、表格等扩展，<code>markdown.extensions.codehilite</code>则是后面要使用的代码高亮扩展。</p><p>然后，修改<code>templates/article/detail.html</code>中有关文章正文的部分：</p><pre class="line-numbers language-none"><code class="language-none">templates&#x2F;article&#x2F;detail.html...# 在 article.body 后加上 |safe 过滤器&lt;p&gt;&#123;&#123; article.body|safe &#125;&#125;&lt;&#x2F;p&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Django出于安全的考虑，会将输出的HTML代码进行转义，<strong>这使得<code>article.body</code>中渲染的HTML文本无法正常显示。</strong>管道符<code>|</code>是Django中过滤器的写法，而<code>|safe</code>就类似给<code>article.body</code>贴了一个标签，表示这一段字符不需要进行转义了。</p><p>这样就把Markdown语法配置好了。</p><p>启动服务器，在后台中新录入一条用markdown语法书写的文章，内容如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 国风·周南·关雎</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">**</span>关关雎鸠，在河之洲。窈窕淑女，君子好逑。<span class="token operator">**</span>参差荇菜，左右流之。窈窕淑女，寤寐求之。<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span> 列表一<span class="token operator">+</span> 列表二    <span class="token operator">+</span> 列表二<span class="token operator">-</span><span class="token number">1</span>    <span class="token operator">+</span> 列表二<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>​```python<span class="token keyword">def</span> <span class="token function">article_detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token comment"># 将markdown语法渲染成html样式</span>article<span class="token punctuation">.</span>body <span class="token operator">=</span> markdown<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>article<span class="token punctuation">.</span>body<span class="token punctuation">,</span>extensions<span class="token operator">=</span><span class="token punctuation">[</span><span class="token comment"># 包含 缩写、表格等常用扩展</span><span class="token string">'markdown.extensions.extra'</span><span class="token punctuation">,</span><span class="token comment"># 语法高亮扩展</span><span class="token string">'markdown.extensions.codehilite'</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span>context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'article'</span><span class="token punctuation">:</span> article <span class="token punctuation">&#125;</span><span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/detail.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>​```<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注意</strong>：直接复制本段Markdown文字到你的项目中，可能导致语法高亮不正常（猜测是换行符导致的？）。建议读者手动输入。感谢读者<a href="https://www.dusaiphoto.com/my-notifications/mark-as-read/20/451/article/#F215">micronuths的反馈</a>。</p></blockquote><p>返回文章详情，结果如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180917/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE42.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180917/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE42.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>很好，但是代码块还是不怎么好看。</p><p>写技术文章没有代码高亮怎么行。继续努力。</p><h2 id="代码高亮"><a href="#代码高亮" class="headerlink" title="代码高亮"></a>代码高亮</h2><p>在<code>static</code>目录中新建一个目录<code>md_css/</code>，一会儿放置代码高亮的样式文件。</p><p>重新打开一个命令行窗口，<strong>进入虚拟环境，安装Pygments：<code>pip install Pygments</code></strong></p><p>Pygments是一种通用语法高亮显示器，可以帮助我们自动生成美化代码块的样式文件。</p><p>在命令行中进入刚才新建的<code>md_css</code>目录中，输入Pygments指令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pygmentize -S monokai -f html -a .codehilite <span class="token operator">></span> monokai.css<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>这里有一点需要注意, 生成命令中的 -a 参数需要与真实页面中的 CSS Selector 相对应，即<code>.codehilite</code>这个字段在有些版本中应写为<code>.highlight</code>。如果后面的代码高亮无效，很可能是这里出了问题。</strong></p><p>回车后检查一下，在<code>md_css</code>目录中是否自动生成了一个叫<code>monokai.css</code>的文件，这是一个深色背景的高亮样式文件。</p><p>接下来我们在<code>base.html</code>中引用这个文件：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/base.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>bootstrap/css/bootstrap.min.css<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- 引入monikai.css --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>md_css/monokai.css<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重新启动服务器，顺利的话看到如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180917/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE41.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180917/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE41.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>除了Monokai这个深色的样式外，Pygments还内置了很多其他的样式，这个就看喜好选择了。</p><p>各种不同样式可以在这里参照：<a href="https://github.com/richleland/pygments-css">pygments-css</a></p><hr><h3 id="故障排查"><a href="#故障排查" class="headerlink" title="故障排查"></a>故障排查</h3><blockquote><p>此节 2018/12/22 新增</p></blockquote><p>代码高亮这里遇到问题的读者比较多，因此展开讲一下如何排查问题。其他地方遇到类似问题也可以这样去做。</p><p>首先请查看网页的源代码：用<a href="https://www.google.com/chrome/">Chrome</a>浏览器的同学按<strong>Ctrl+U</strong>，其他浏览器请自行查找快捷键。</p><p><strong>找到正文中书写代码块的部分。正常情况下这部分的源代码应该是这样的：</strong></p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181222/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE116.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181222/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE116.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><ul><li><p>代码块被<code>&lt;div class=&quot;codehilite&quot;&gt;</code>包裹（或者<code>&lt;div class=&quot;highlight&quot;&gt;</code>）</p></li><li><p>代码内容被各种不同的<code>&lt;span&gt;</code>包裹</p></li></ul><p><strong>根据源代码，可能出现的问题分为以下两种：</strong></p><ul><li><p>如果看到的源代码跟上面的很像，很可能是模板出了问题</p></li><li><p>如果看到的源代码跟上面的区别很大，很可能是视图出了问题</p></li></ul><p>下面分别说说怎么解决。</p><p><strong>如果模板出了问题：</strong></p><ul><li><p>检查<code>monokai.css</code>这个文件是否正常载入。检查方法就是直接点击网页源代码中的<code>&lt;link&gt;</code>引用链接，看是否正常。</p><ul><li><p>如果链接正常，看一下每行开头字段是<code>.codehilite</code>还是<code>highlight</code>，确保和包裹代码块的字段相对应</p></li><li><p>如果链接不正常，查看<code>settings.py</code>中是否忘记写<code>STATIC_URL</code>或者<code>STATICFILES_DIRS</code>字段</p></li></ul></li><li><p>进入浏览器开发者模式，查看<code>monokai.css</code>样式是否被别的样式所覆盖。Chrome请按<strong>F12</strong>或者<strong>Ctrl+Shift+I</strong></p></li><li><p>最后清除浏览器缓存，重启服务器</p></li></ul><p><strong>如果视图出了问题：</strong></p><ul><li><p>重新安装 markdown 和 pygments，卸载指令是<code>pip uninstall xxx</code></p></li><li><p>注释掉<code>markdown.extensions.extra</code>或者<code>markdown.extensions.codehilite</code>，刷新网页源代码看看是否有变化。如果没有变化说明扩展没有正确载入</p></li><li><p>最后清除浏览器缓存，重启服务器</p></li></ul><p><strong>特别提醒markdown中代码块的书写：</strong></p><ul><li><p>开头：单独一行。三个点符（英文输入法时，Tab键上面那个键），后紧跟python这个单词</p></li><li><p>正文：即代码本身。缩进请用4个空格</p></li><li><p>结尾：单独一行。还是三个点符</p></li></ul><p>遇到几个读者都是因为书写的问题，找了一个上午的Bug，痛不欲生…</p><p>如果以上步骤还没解决你的问题，不妨暂时跳过这一部分，不影响后面的学习。</p><h2 id="自定义样式"><a href="#自定义样式" class="headerlink" title="自定义样式"></a>自定义样式</h2><blockquote><p>此节 2019/6/1 新增</p></blockquote><p>很多读者注意到博主的Markdown文章样式似乎比<code>pygments</code>生成的样式要漂亮一些。</p><p>确实是这样的。<code>pygments</code>提供的样式比较基础，满足不了各位大佬千奇百怪的需求，因此需要对文章样式进行深度定制。</p><p>定制的方法很多。首先你应该注意到了，<code>pygments</code>生成的其实就是<strong>普通的css文件</strong>而已，源码也不复杂，会一点点css基础就能看懂。你完全可以自由的改动源码，变换颜色、字间距、给代码块加圆角、增加图片阴影，都随便你。</p><p>另一个经常被读者问到的是，<code>pygments</code>的表格样式太难看了，自己从零定制表格样式又太麻烦，怎么办？博主的处理办法偷了个懒，在页面中用<code>Jquery</code>动态加载了<code>Bootstrap</code>的表格样式，就像这样：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'div#article_body table'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'table table-bordered'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'div#article_body thead'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'thead-light'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>很方便就得到漂亮的表格。</p><blockquote><p>注意这里只是示例，照搬代码可能会有错误。Jquery后面才会讲到，读者不懂的可先查阅一点基础知识。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章引进了Markdown语法以及代码高亮扩展，从此可以写排版漂亮的文章正文了。</p><p>下一章将学习如何创建一篇新的文章。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#117;&#x73;&#x61;&#105;&#112;&#104;&#x6f;&#x74;&#x6f;&#x40;&#x66;&#x6f;&#120;&#109;&#x61;&#x69;&#108;&#x2e;&#99;&#111;&#x6d;">&#x64;&#117;&#x73;&#x61;&#105;&#112;&#104;&#x6f;&#x74;&#x6f;&#x40;&#x66;&#x6f;&#120;&#109;&#x61;&#x69;&#108;&#x2e;&#99;&#111;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--08.编写文章详情页面</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/08.bian-xie-wen-zhang-xiang-qing-ye-mian/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/08.bian-xie-wen-zhang-xiang-qing-ye-mian/</url>
      
        <content type="html"><![CDATA[<p>有了文章列表页面后，当然还需要详情页面，方便用户对某一篇感兴趣的文章深入阅读。</p><h2 id="编写视图函数"><a href="#编写视图函数" class="headerlink" title="编写视图函数"></a>编写视图函数</h2><p>打开<code>article/views.py</code>，增加文章详情页面的视图函数<code>article_detail()</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 文章详情</span><span class="token keyword">def</span> <span class="token function">article_detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 取出相应的文章</span>    article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token comment"># 需要传递给模板的对象</span>    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'article'</span><span class="token punctuation">:</span> article <span class="token punctuation">&#125;</span>    <span class="token comment"># 载入模板，并返回context对象</span>    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/detail.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>article_detail(request, id)</code>函数中多了<code>id</code>这个参数。<strong>注意我们在写model的时候并没有写叫做id的字段，</strong>这是Django自动生成的用于索引数据表的主键（Primary Key，即pk）。有了它才有办法知道到底应该取出哪篇文章。</li><li><code>ArticlePost.objects.get(id=id)</code>意思是在所有文章中，取出id值相符合的唯一的一篇文章。</li></ul><p>然后编写<code>article/urls.py</code>，配置路由地址：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 文章详情</span>    path<span class="token punctuation">(</span><span class="token string">'article-detail/&lt;int:id>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>article_detail<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'article_detail'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>&lt;int:id&gt;</code>：Django2.0的<code>path</code>新语法用**尖括号&lt;&gt;**定义需要传递的参数。这里需要传递名叫<code>id</code>的整数到视图函数中去。</p><p><strong>重申一下老版本的Django是没有<code>path</code>语法的。</strong></p><h2 id="编写模板"><a href="#编写模板" class="headerlink" title="编写模板"></a>编写模板</h2><p>在<code>templates/article/</code>中新建<code>detail.html</code>文件，编写如下代码：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html<span class="token comment">&lt;!-- extends表明此页面继承自 base.html 文件 --></span>&#123;% extends "base.html" %&#125;&#123;% load staticfiles %&#125;<span class="token comment">&lt;!-- 写入 base.html 中定义的 title --></span>&#123;% block title %&#125;    文章详情&#123;% endblock title %&#125;<span class="token comment">&lt;!-- 写入 base.html 中定义的 content --></span>&#123;% block content %&#125;<span class="token comment">&lt;!-- 文章详情 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- 标题及作者 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12 mt-4 mb-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; article.title &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12 alert alert-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>作者：&#123;&#123; article.author &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- 文章正文 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>&#123;&#123; article.body &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>这里我们用<code>&#123;&#123; article.xxx &#125;&#125;</code>取出了文章标题、作者以及正文。</strong></p><p>前面我们已经通过后台创建了几篇文章，这里将取出id为1的一篇文章测试效果。</p><p>运行开发服务器后，在浏览器中输入<code>http://127.0.0.1:8000/article/article-detail/1/</code>：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180916/34.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180916/34.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><h2 id="优化网页入口"><a href="#优化网页入口" class="headerlink" title="优化网页入口"></a>优化网页入口</h2><p>虽然已经实现了文章详情功能，但是通过输入url访问的方式实在太不友好。</p><p>改写<code>header.html</code>，让用户可通过导航栏右侧的<strong>文章</strong>链接返回首页：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/header.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navbar-nav<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token comment">&lt;!-- 改写了这里的 href --></span>             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-link<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_list<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>文章<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意看这里href是如何改写的：</strong></p><ul><li><p>href定义了链接跳转的地址。</p></li><li><p><code>&#123;% url '...' %&#125;</code>是Django规定的模板解耦语法，用它可以根据我们在<code>urls.py</code>中设置的名字，反向解析到对应的url中去。</p></li></ul><p>关于其中的<code>&#39;article:article_list&#39;</code>的解释：</p><ul><li>前面的<code>article</code>是在项目根目录的<code>urls.py</code>中定义的app的名称</li><li>后面的<code>article_list</code>是在app中的<code>urls.py</code>中定义的具体的路由地址</li></ul><p>通过这样的方法就将链接跳转的指向给配置好了，只要对应url的名称不变，url本身无论怎么变化，Django都可以解析到正确的地址，很灵活。</p><p>当然你也可以直接在<code>href</code>中写入url的地址，但是一旦url有变化，所有相关的链接都会失效，维护性不好。</p><p>然后再改写<code>list.html</code>，让用户可点击<strong>阅读本文</strong>按钮进入文章详情：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card-footer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 同样改写 href --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_detail<span class="token punctuation">'</span> article.id %&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>阅读本文<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>留意文章的id是如何传递的：</strong></p><ul><li>在<code>list.html</code>中，通过<code>href=&quot;&#123;% url 'article:article_detail' article.id %&#125;&quot;</code>，将id传递给<code>article/urls.py</code></li><li>在<code>article/urls.py</code>中，通过<code>&lt;int:id&gt;</code>传递给视图函数<code>article_detail()</code></li><li>在视图函数<code>article_detail()</code>中，通过形参<code>id</code>取得了文章的id值，并进行处理，最终定位了需要获取的文章对象</li></ul><p>现在我们可以通过链接访问网站上的不同页面了，而不需要手动输入url。当然这也是现代网站的基础。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>现在我们也拥有查看文章详情的功能了，并且优化了网页切换的体验。</p><p>下一章将学习使用Markdown语法对文章正文进行排版。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#x75;&#x73;&#x61;&#105;&#112;&#104;&#111;&#x74;&#111;&#64;&#102;&#x6f;&#x78;&#x6d;&#x61;&#x69;&#108;&#46;&#99;&#x6f;&#109;">&#x64;&#x75;&#x73;&#x61;&#105;&#112;&#104;&#111;&#x74;&#111;&#64;&#102;&#x6f;&#x78;&#x6d;&#x61;&#x69;&#108;&#46;&#99;&#x6f;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--10.发布新的文章</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/10.fa-bu-xin-de-wen-zhang/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/10.fa-bu-xin-de-wen-zhang/</url>
      
        <content type="html"><![CDATA[<p>前面我们已经学会如何用Markdown语法书写文章了。</p><p>但是还有问题呀。之前写文章都是在后台中进行的，<strong>万一有别的普通用户也要发表文章怎么办？万一我想拓展些后台中没有的提交验证功能又怎么办？</strong></p><p>本章即讲述如何在前台中提交新的文章，以便满足开发者各种各样的<em>特殊需求</em>。</p><h2 id="Forms表单类"><a href="#Forms表单类" class="headerlink" title="Forms表单类"></a>Forms表单类</h2><p><strong>在HTML中，表单是在 <code>&lt;form&gt;...&lt;/form&gt;</code> 中的一些元素</strong>，它允许访客做类似输入文本、选择选项、操作对象或空间等动作，然后发送这些信息到服务端。一些表单界面元素（文本框或复选框）非常简单并内置在HTML中，而其他会复杂些：像弹出日期选择等操作控件。</p><p>处理表单是一件挺复杂的事情。想想看Django的admin，许多不同类型的数据可能需要在一张表单中准备显示，渲染成HTML，使用方便的界面进行编辑，传到服务器，验证和清理数据，然后保存或跳过进行下一步处理。</p><p>Django的表单功能可以简化上述工作的大部分内容，并且也能比大多数程序员自己编写代码去实现来的更安全。</p><p><strong>Django表单系统的核心组件是 <code>Form</code>类</strong>，它能够描述一张表单并决定它如何工作及呈现。</p><p>要使用<code>Form</code>类也很简单，需要在<code>article/</code>中创建<code>forms.py</code>文件，并写入如下代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>forms<span class="token punctuation">.</span>py<span class="token comment"># 引入表单类</span><span class="token keyword">from</span> django <span class="token keyword">import</span> forms<span class="token comment"># 引入文章模型</span><span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticlePost<span class="token comment"># 写文章的表单类</span><span class="token keyword">class</span> <span class="token class-name">ArticlePostForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        <span class="token comment"># 指明数据模型来源</span>        model <span class="token operator">=</span> ArticlePost        <span class="token comment"># 定义表单包含的字段</span>        fields <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'body'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码中<code>ArticlePostForm</code>类继承了Django的表单类<code>forms.ModelForm</code>，并在类中定义了内部类<code>class Meta</code>（之前提到过，<a href="https://www.dusaiphoto.com/article/article-detail/11/">还记得吗</a>），指明了数据模型的来源，以及表单中应该包含数据模型的哪些字段。</p><p>在<code>ArticlePost</code>模型中，<code>created</code>和<code>updated</code>字段为自动生成，不需要填入；<code>author</code>字段暂时固定为id=1的管理员用户，也不用填入；剩下的<code>title</code>和<code>body</code>就是表单需要填入的内容了。</p><p>接下来，改写<code>article/views.py</code>，添加一个视图函数以处理写文章的请求：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 引入redirect重定向模块</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token punctuation">,</span> redirect<span class="token comment"># 引入HttpResponse</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse<span class="token comment"># 引入刚才定义的ArticlePostForm表单类</span><span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> ArticlePostForm<span class="token comment"># 引入User模型</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 写文章的视图</span><span class="token keyword">def</span> <span class="token function">article_create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 判断用户是否提交数据</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>        <span class="token comment"># 将提交的数据赋值到表单实例中</span>        article_post_form <span class="token operator">=</span> ArticlePostForm<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token comment"># 判断提交的数据是否满足模型的要求</span>        <span class="token keyword">if</span> article_post_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment"># 保存数据，但暂时不提交到数据库中</span>            new_article <span class="token operator">=</span> article_post_form<span class="token punctuation">.</span>save<span class="token punctuation">(</span>commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>            <span class="token comment"># 指定数据库中 id=1 的用户为作者</span>            <span class="token comment"># 如果你进行过删除数据表的操作，可能会找不到id=1的用户</span>            <span class="token comment"># 此时请重新创建用户，并传入此用户的id</span>            new_article<span class="token punctuation">.</span>author <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token comment"># 将新文章保存到数据库中</span>            new_article<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># 完成后返回到文章列表</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"article:article_list"</span><span class="token punctuation">)</span>        <span class="token comment"># 如果数据不合法，返回错误信息</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"表单内容有误，请重新填写。"</span><span class="token punctuation">)</span>    <span class="token comment"># 如果用户请求获取数据</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token comment"># 创建表单类实例</span>        article_post_form <span class="token operator">=</span> ArticlePostForm<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 赋值上下文</span>        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'article_post_form'</span><span class="token punctuation">:</span> article_post_form <span class="token punctuation">&#125;</span>        <span class="token comment"># 返回模板</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/create.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>分析一下上面的代码。当视图函数接收到一个客户端的<code>request</code>请求时，首先根据<code>request.method</code>判断用户是要<strong>提交数据（POST）、还是要获取数据（GET）</strong>：</p><ul><li><p>如果用户是<strong>提交数据</strong>，将POST给服务器的表单数据赋于<code>article_post_form</code>实例。然后使用Django内置的方法<code>.is_valid()</code>判断提交的数据是否满足模型的要求。</p><ul><li><p>如果<strong>满足要求</strong>，保存表单中的数据（但是<code>commit=False</code>暂时不提交到数据库，因为<code>author</code>还未指定），并指定<code>author</code>为id=1的管理员用户。然后提交到数据库，并通过<code>redirect</code>返回文章列表。<code>redirect</code>可通过url地址的名字，反向解析到对应的url。</p></li><li><p>如果<strong>不满足要求</strong>，则返回一个字符串**”表单内容有误，请重新填写。”**，告诉用户出现了什么问题。</p></li></ul></li><li><p>如果用户是<strong>获取数据</strong>，则返回一个空的表单类对象，提供给用户填写。</p></li></ul><p>其实逻辑并不复杂，不明白的读者请逐句理解。</p><p>Django官方文档对Form类做了详细的说明：</p><p><code>Form</code>实例可以<strong>绑定</strong>到数据，也可以<strong>不绑定</strong>数据。</p><ul><li>如果<strong>绑定</strong>到数据，就能够验证该数据并将表单呈现为HTML并显示数据。</li><li>如果它<strong>未绑定</strong>，则无法进行验证（因为没有要验证的数据！），但仍然可以将空白表单呈现为HTML。</li></ul><p>要将数据绑定到表单，就将数据作为字典作为第一个参数传递给<code>Form</code>类构造函数：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json">>>> data = <span class="token punctuation">&#123;</span>'subject'<span class="token operator">:</span> 'hello'<span class="token punctuation">,</span>...         'message'<span class="token operator">:</span> 'Hi there'<span class="token punctuation">,</span>...         'sender'<span class="token operator">:</span> 'foo@example.com'<span class="token punctuation">,</span>...         'cc_myself'<span class="token operator">:</span> True<span class="token punctuation">&#125;</span>>>> f = ContactForm(data)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Form</code>对象的主要任务是验证数据。使用绑定后的 <code>Form</code>实例，调用<code>is_valid()</code>方法验证并返回指定数据是否有效的布尔值：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json">>>> data = <span class="token punctuation">&#123;</span>'subject'<span class="token operator">:</span> 'hello'<span class="token punctuation">,</span>...         'message'<span class="token operator">:</span> 'Hi there'<span class="token punctuation">,</span>...         'sender'<span class="token operator">:</span> 'foo@example.com'<span class="token punctuation">,</span>...         'cc_myself'<span class="token operator">:</span> True<span class="token punctuation">&#125;</span>>>> f = ContactForm(data)>>> f.is_valid()True<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>让我们尝试一些无效的数据。<code>subject</code>为空（错误，因为默认情况下需要所有字段），并且<code>sender</code>不是有效的电子邮件地址:</p><pre class="line-numbers language-json" data-language="json"><code class="language-json">>>> data = <span class="token punctuation">&#123;</span>'subject'<span class="token operator">:</span> ''<span class="token punctuation">,</span>...         'message'<span class="token operator">:</span> 'Hi there'<span class="token punctuation">,</span>...         'sender'<span class="token operator">:</span> 'invalid email address'<span class="token punctuation">,</span>...         'cc_myself'<span class="token operator">:</span> True<span class="token punctuation">&#125;</span>>>> f = ContactForm(data)>>> f.is_valid()False<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关于Forms类的详细解释看这里：<a href="https://docs.djangoproject.com/zh-hans/2.1/ref/forms/api/">The Forms API</a></p><p><strong>这里特别提醒Django中的缩进不能够空格和tab键混用，否则会报错。</strong>由于不同的编辑器对tab的显示不尽相同，因此你应该坚持使用空格键缩进。</p><blockquote><p>大多数文本编辑器可以自动将tab转换为空格，请合理设置。</p></blockquote><p>写好视图之后，就需要写模板文件了。在<code>templates/article/</code>中创建<code>create.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/create.html<span class="token comment">&lt;!-- extends表明此页面继承自 base.html 文件 --></span>&#123;% extends "base.html" %&#125; &#123;% load staticfiles %&#125;<span class="token comment">&lt;!-- 写入 base.html 中定义的 title --></span>&#123;% block title %&#125; 写文章 &#123;% endblock title %&#125;<span class="token comment">&lt;!-- 写入 base.html 中定义的 content --></span>&#123;% block content %&#125;<span class="token comment">&lt;!-- 写文章表单 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>            <span class="token comment">&lt;!-- 提交文章的表单 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- Django中需要POST数据的地方都必须有csrf_token --></span>                &#123;% csrf_token %&#125;                <span class="token comment">&lt;!-- 文章标题 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token comment">&lt;!-- 标签 --></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>文章标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token comment">&lt;!-- 文本框 --></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 文章正文 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>文章正文<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token comment">&lt;!-- 文本区域 --></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 提交按钮 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>完成<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>html文件还是一如既往的长。<strong>再重复一次，看不懂html文件语法也没有关系，先照着抄一遍，以后再慢慢理解，不影响目前Django的学习。</strong></p><p>对其中的新内容进行审视：</p><ul><li><p><code>&lt;form&gt;..&lt;/form&gt;</code>标签中的内容就是需要提交的表单。<code>method=&quot;post&quot;</code>指定了表单提交的方式为POST（与视图函数中的<code>request.method</code>相联系）；<code>action=&quot;.&quot;</code>指定了表单提交的地址为默认的当前url。</p></li><li><p>关于<code>&#123;% csrf_token %&#125;</code>，它是Django中一个与网络安全相关的中间件验证。目前我们暂时不去深究它的实现，<strong>只需要知道表单中必须包含它就可以了</strong>，否则将会得到一个403错误。</p></li><li><p><code>&lt;input&gt;</code>和<code>&lt;textarea&gt;</code>标签中的<code>name=&#39;&#39;</code>属性指定了当前文本框提交的数据的名称，它必须与表单类中的字段名称对应，否则服务器无法将字段和数据正确的对应起来。</p></li></ul><p>最后老规矩，在<code>article/urls.py</code>中增加一个写文章的url地址：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>urls<span class="token punctuation">.</span>pyurlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 写文章</span>    path<span class="token punctuation">(</span><span class="token string">'article-create/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>article_create<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'article_create'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>大功告成了，不要着急，先喝口水，万一有bug又得忙活半天了。<strong>如果报错也不要慌张，开发过程一定是曲折的，耐心看看Django给出的错误提示，线索就在其中。</strong></p><p>保存修改并运行服务器，地址栏中输入：<code>http://127.0.0.1:8000/article/article-create/</code>，看到如下界面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180926/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE49.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180926/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE49.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>很好，似乎正常工作起来了。接着随便输入些<a href="https://www.dusaiphoto.com/article/article-detail/20/">Markdown语法的文章</a>，测试功能是否正常：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180926/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE52.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180926/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE52.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击<strong>完成</strong>按钮后，页面会回到文章列表：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180926/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE53.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180926/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE53.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>刚才提交的文章神奇的出现在列表中了。</p><p>点击<strong>阅读本文</strong>按钮，进入文章详情页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180926/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE54.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180926/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE54.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>出现了具有<strong>Markdown</strong>语法的优美的文章。</p><p>是不是非常有成就感呢？</p><p>别激动，还有一些收尾工作需要做。</p><h2 id="优化写文章入口"><a href="#优化写文章入口" class="headerlink" title="优化写文章入口"></a>优化写文章入口</h2><p>与之前类似，我们需要在导航栏中设置一个<strong>写文章</strong>的入口，优化使用体验。</p><p>将下列代码加入到<code>templates/header.html</code>中：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-link<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_create<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>写文章<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>读者是否清楚，上面的代码应该放置在什么位置呢？</p><p>保存后刷新浏览器界面，<strong>导航栏</strong>有了如下变化：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20180926/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE55.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20180926/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE55.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击<strong>写文章</strong>按钮，就可以进入写新文章的页面了，从此再也不用手动输入繁琐的url地址了。</p><p>世界是多么的美好。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章学习了使用Django的表单类，完成了提交新文章的基本功能。当然目前暂时还没有真正将文章和登录的用户关联起来；等到学习了用户管理的知识，再回头来处理这部分的内容。</p><p>下一章继续学习如何删除一篇文章。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#117;&#115;&#x61;&#105;&#x70;&#104;&#x6f;&#x74;&#111;&#x40;&#102;&#111;&#120;&#x6d;&#97;&#x69;&#108;&#46;&#x63;&#111;&#x6d;">&#100;&#117;&#115;&#x61;&#105;&#x70;&#104;&#x6f;&#x74;&#111;&#x40;&#102;&#111;&#120;&#x6d;&#97;&#x69;&#108;&#46;&#x63;&#111;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--12.更新文章</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/12.geng-xin-wen-zhang/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/12.geng-xin-wen-zhang/</url>
      
        <content type="html"><![CDATA[<p>目前为止我们已经完成了文章的新建、删除以及查看，还剩最后一项，即对已经完成的文章进行修改。</p><p><strong>实际上修改文章与新建文章有点类似</strong>，不同的地方有两点：</p><ul><li>修改是在原有文章的基础上，因此需要传递 <strong>id</strong> 指明具体需要修改的文章</li><li>加载页面时需要将旧的内容作为默认值填写到表单中，因此需要将文章对象传递到<code>html</code>中</li></ul><p>按照这个思路，接下来先写视图函数。</p><h2 id="视图函数"><a href="#视图函数" class="headerlink" title="视图函数"></a>视图函数</h2><p>在<code>ariticle/views.py</code>中增加修改文章的视图函数<code>article_update()</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 更新文章</span><span class="token keyword">def</span> <span class="token function">article_update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    更新文章的视图函数    通过POST方法提交表单，更新titile、body字段    GET方法进入初始表单页面    id： 文章的 id    """</span>    <span class="token comment"># 获取需要修改的具体文章对象</span>    article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token comment"># 判断用户是否为 POST 提交表单数据</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>        <span class="token comment"># 将提交的数据赋值到表单实例中</span>        article_post_form <span class="token operator">=</span> ArticlePostForm<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token comment"># 判断提交的数据是否满足模型的要求</span>        <span class="token keyword">if</span> article_post_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment"># 保存新写入的 title、body 数据并保存</span>            article<span class="token punctuation">.</span>title <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span>            article<span class="token punctuation">.</span>body <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'body'</span><span class="token punctuation">]</span>            article<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># 完成后返回到修改后的文章中。需传入文章的 id 值</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"article:article_detail"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>        <span class="token comment"># 如果数据不合法，返回错误信息</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"表单内容有误，请重新填写。"</span><span class="token punctuation">)</span>    <span class="token comment"># 如果用户 GET 请求获取数据</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token comment"># 创建表单类实例</span>        article_post_form <span class="token operator">=</span> ArticlePostForm<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 赋值上下文，将 article 文章对象也传递进去，以便提取旧的内容</span>        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'article'</span><span class="token punctuation">:</span> article<span class="token punctuation">,</span> <span class="token string">'article_post_form'</span><span class="token punctuation">:</span> article_post_form <span class="token punctuation">&#125;</span>        <span class="token comment"># 将响应返回到模板中</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/update.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更新的视图与创建文章非常相似，但又有点小区别：</p><ul><li>文章的 id 作为参数传递进来了</li><li>用户POST提交表单时没有创建新的文章，而是在之前的文章中修改</li><li><code>redirect</code>函数没有返回文章列表，而是返回到修改后的文章页面去了，因此需要同时把文章的id也打包传递进去，这是url所规定的</li><li>GET获取页面时将article对象也传递到模板中去，以便后续的调用</li></ul><h2 id="编写模板"><a href="#编写模板" class="headerlink" title="编写模板"></a>编写模板</h2><p>模板文件就与创建文章的更像了，不过我们这里还是重新写一遍。</p><p>新建<code>templates/article/update.html</code>并写入：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/update.html&#123;% extends "base.html" %&#125; &#123;% load staticfiles %&#125;&#123;% block title %&#125; 更新文章 &#123;% endblock title %&#125;&#123;% block content %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                &#123;% csrf_token %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>文章标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token comment">&lt;!-- 在 value 属性中指定文本框的初始值为旧的内容，即 article 对象中的 title 字段 --></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; article.title &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>文章正文<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token comment">&lt;!-- 文本域不需要 value 属性，直接在标签体中嵌入数据即可 --></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; article.body &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>完成<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在模板中，分别将文章旧的标题和正文作为初始值，传递了进去，其他就与新建文章的模板完全没区别了。</p><p>有读者可能就会问了，既然这两个函数、模板都很相似，<strong>能不能合并成一个函数、模板呢？</strong>当然是可以的，合并相同功能的函数可以让代码更加简洁漂亮，也便于后期的维护。有兴趣的读者可以自己尝试一下。</p><h2 id="URL-和入口"><a href="#URL-和入口" class="headerlink" title="URL 和入口"></a>URL 和入口</h2><p>接下来的套路都懂的，配置路由<code>article/urls.py</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 更新文章</span>    path<span class="token punctuation">(</span><span class="token string">'article-update/&lt;int:id>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>article_update<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'article_update'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在文章详情页面<code>tempaltes/article/detail.html</code>中添加修改文章的入口：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">tempaltes/article/detail.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12 alert alert-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>作者：&#123;&#123; article.author &#125;&#125;    · <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">confirm_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>删除文章<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    · <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">"</span></span><span class="token attr-name"><span class="token namespace">article:</span>article_update"</span> <span class="token attr-name">article.id</span> <span class="token attr-name">%&#125;"</span><span class="token punctuation">></span></span>编辑文章<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动服务器，可以看到修改文章的功能就实现了。同样的，如有故障也不要着急，在Debug页面寻找出错的线索，求助网络帮忙解决吧。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>至此我们就实现了一篇文章的增、删、改、查四个基础功能，也算小有成就。</strong></p><p>当然还有很多进阶的功能可以去做，不过我们在这里先休息休息，来罐快乐水庆祝一下。</p><p>下一章开始解决更加燃眉之急的内容：用户管理。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#x75;&#115;&#97;&#x69;&#x70;&#104;&#111;&#x74;&#111;&#x40;&#x66;&#111;&#120;&#109;&#97;&#105;&#108;&#x2e;&#x63;&#111;&#x6d;">&#100;&#x75;&#115;&#97;&#x69;&#x70;&#104;&#111;&#x74;&#111;&#x40;&#x66;&#111;&#120;&#109;&#97;&#105;&#108;&#x2e;&#x63;&#111;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><blockquote><p>转载请告知作者并注明出处。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--14.用户的注册</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/14.yong-hu-de-zhu-ce/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/14.yong-hu-de-zhu-ce/</url>
      
        <content type="html"><![CDATA[<p>既然有登录登出，那么用户的注册肯定也是少不了的。</p><h2 id="注册表单类"><a href="#注册表单类" class="headerlink" title="注册表单类"></a>注册表单类</h2><p>用户注册时会用到<strong>表单</strong>来提交账号、密码等数据，所以需要写注册用的表单<code>/userprofile/forms.py</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>forms<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 注册用户表单</span><span class="token keyword">class</span> <span class="token class-name">UserRegisterForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 复写 User 的密码</span>    password <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span><span class="token punctuation">)</span>    password2 <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> User        fields <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'email'</span><span class="token punctuation">)</span>    <span class="token comment"># 对两次输入的密码是否一致进行检查</span>    <span class="token keyword">def</span> <span class="token function">clean_password2</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        data <span class="token operator">=</span> self<span class="token punctuation">.</span>cleaned_data        <span class="token keyword">if</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span> <span class="token operator">==</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password2'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">raise</span> forms<span class="token punctuation">.</span>ValidationError<span class="token punctuation">(</span><span class="token string">"密码输入不一致,请重试。"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上一章也讲过，对数据库进行操作的表单应该继承<code>forms.ModelForm</code>，可以自动生成模型中已有的字段。</p><p>这里我们覆写了<code>password</code>字段，因为通常在注册时需要重复输入<code>password</code>来确保用户没有将密码输入错误，所以覆写掉它以便我们自己进行数据的验证工作。<code>def clean_password2()</code>中的内容便是在验证密码是否一致了。<code>def clean_[字段]</code>这种写法Django会自动调用，来对单个字段的数据进行验证清洗。</p><p>覆写某字段之后，内部类<code>class Meta</code>中的定义对这个字段就没有效果了，所以<code>fields</code>不用包含<code>password</code>。</p><p><strong>需要注意：</strong></p><ul><li>验证密码一致性方法不能写<code>def clean_password()</code>，因为如果你不定义<code>def clean_password2()</code>方法，会导致password2中的数据被Django判定为无效数据从而清洗掉，从而<code>password2</code>属性不存在。最终导致两次密码输入始终会不一致，并且很难判断出错误原因。</li><li>从POST中取值用的<code>data.get(&#39;password&#39;)</code>是一种稳妥的写法，即使用户没有输入密码也不会导致程序错误而跳出。前面章节提取POST数据我们用了<code>data[&#39;password&#39;]</code>，这种取值方式如果data中不包含<code>password</code>，Django会报错。另一种防止用户不输入密码就提交的方式是在表单中插入<code>required</code>属性，后面会讲到。</li></ul><h2 id="视图函数"><a href="#视图函数" class="headerlink" title="视图函数"></a>视图函数</h2><p>编写注册的视图<code>/userprofile/views.py</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token comment"># 引入 UserRegisterForm 表单类</span><span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> UserLoginForm<span class="token punctuation">,</span> UserRegisterForm<span class="token comment"># 用户注册</span><span class="token keyword">def</span> <span class="token function">user_register</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        user_register_form <span class="token operator">=</span> UserRegisterForm<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token keyword">if</span> user_register_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            new_user <span class="token operator">=</span> user_register_form<span class="token punctuation">.</span>save<span class="token punctuation">(</span>commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>            <span class="token comment"># 设置密码</span>            new_user<span class="token punctuation">.</span>set_password<span class="token punctuation">(</span>user_register_form<span class="token punctuation">.</span>cleaned_data<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            new_user<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># 保存好数据后立即登录并返回博客列表页面</span>            login<span class="token punctuation">(</span>request<span class="token punctuation">,</span> new_user<span class="token punctuation">)</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"article:article_list"</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"注册表单输入有误。请重新输入~"</span><span class="token punctuation">)</span>    <span class="token keyword">elif</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>        user_register_form <span class="token operator">=</span> UserRegisterForm<span class="token punctuation">(</span><span class="token punctuation">)</span>        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'form'</span><span class="token punctuation">:</span> user_register_form <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'userprofile/register.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"请使用GET或POST请求数据"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>逻辑上结合了<strong>发表文章视图</strong>和<strong>用户登录视图</strong>，没有新的知识。</p><p>用户在注册成功后会自动登录并返回博客列表页面。</p><h2 id="模板和url"><a href="#模板和url" class="headerlink" title="模板和url"></a>模板和url</h2><p>表单有关的模板文件我们也很熟悉了，新建<code>/templates/userprofile/register.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">/templates/userprofile/register.html&#123;% extends "base.html" %&#125; &#123;% load staticfiles %&#125;&#123;% block title %&#125; 登录 &#123;% endblock title %&#125;&#123;% block content %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                &#123;% csrf_token %&#125;                <span class="token comment">&lt;!-- 账号 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group col-md-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>昵称<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 邮箱 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group col-md-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Email<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 密码 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group col-md-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>设置密码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 确认密码 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group col-md-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>确认密码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password2<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password2<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 提交按钮 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>提交<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的模板文件中，我们在昵称、密码<code>input</code> 标签中添加了<code>required</code>属性（前面提到过）。如果用户不填写带有<code>required</code>属性的字段，表单就不能提交，并提示用户填写。实际上前面学习的很多表单都可以添加<code>required</code>属性来提前验证数据的有效性。</p><p>注册的入口你可以放在任何喜欢的地方。本文放在登录页面中<code>/templates/userprofile/login.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">/templates/userprofile/login.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span><span class="token punctuation">></span></span>还没有账号？<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span><span class="token punctuation">></span></span>点击<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>&#123;% url <span class="token punctuation">"</span>userprofile:register<span class="token punctuation">"</span> %&#125;<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>注册账号<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>加入我们吧！<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后就是在app中配置路由文件<code>/userprofile/urls.py</code>了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 用户注册</span>    path<span class="token punctuation">(</span><span class="token string">'register/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>user_register<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'register'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>运行服务器，进入到登录页面，多了注册的提示：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181030/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE71.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181030/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE71.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击<strong>注册账号</strong>进入注册页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181030/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE72.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181030/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE72.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>填写好表单后提交（Email地址是可以为空的）：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181030/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE73.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181030/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE73.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>成功登录并返回了博客列表，功能完成。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章用到了表单类、对数据进行验证清洗等知识，完成了用户的注册功能。</p><p>接下来学习如何实现删除已有的用户。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#x75;&#115;&#97;&#x69;&#x70;&#x68;&#111;&#116;&#x6f;&#64;&#102;&#x6f;&#120;&#x6d;&#97;&#105;&#x6c;&#46;&#99;&#111;&#109;">&#x64;&#x75;&#115;&#97;&#x69;&#x70;&#x68;&#111;&#116;&#x6f;&#64;&#102;&#x6f;&#120;&#x6d;&#97;&#105;&#x6c;&#46;&#99;&#111;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><blockquote><p>转载请告知作者并注明出处。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--16.重置用户密码</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/16.chong-zhi-yong-hu-mi-ma/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/16.chong-zhi-yong-hu-mi-ma/</url>
      
        <content type="html"><![CDATA[<p>随着技术的发展，验证用户身份的手段越来越多，指纹、面容、声纹应有尽有，但密码依然是最重要的手段。</p><p>互联网处处都有密码的身影，甚至变成了现代人的一种负担。像笔者这样的，动辄几十个账号密码，忘记其中几个简直太正常了。</p><p>本章讲如何帮助健忘症患者，重置用户密码。</p><h2 id="安装第三方库"><a href="#安装第三方库" class="headerlink" title="安装第三方库"></a>安装第三方库</h2><p>前面我们已经知道如何修改文章标题、正文等内容，但是密码作为验证身份的重要口令，必须以更加稳妥的方式修改。一种比较常用的方式是<strong>发送一封修改密码的邮件到用户事先绑定的邮箱里</strong>。</p><p>业务流程分析如下：</p><ul><li>向用户邮箱发送包含重置密码地址的邮件。邮件的地址需要动态生成，防止不怀好意的用户从中捣乱；</li><li>向网站用户展示一条发送邮件成功的信息；</li><li>用户点击邮箱中的地址后，转入重置密码的页面；</li><li>向用户展示一条重置成功的信息。</li></ul><p>上面4个步骤包含了4个视图和模板，自己写代码看来有些繁琐。</p><p>可能你会想，Django这种以开发效率著称的框架，<strong>重置密码这种常用功能是不是内置了呢</strong>？答案是肯定的。事实上内置模块的流程和上面的是完全相同的，你只需要将上面4个步骤的<code>url</code>配置好就可以使用了。当然内置的模板很简陋，你可以覆写模板变成自己网站的风格。</p><blockquote><p>实际上Django不仅内置了密码重置，还包括登录、登出、密码修改等功能。建议读者到一定水平后多阅读Django的源码，学习其中的编程技巧。另外这部分内容Django是用<strong>类视图</strong>写的，现在阅读可能有一定困难。</p><p>源码位置：/env/Lib/site-packages/django/contrib/auth/views.py</p><p>官方文档：<a href="https://docs.djangoproject.com/zh-hans/2.1/topics/auth/default/">Django 的验证系统</a></p></blockquote><p>使用内置的模块似乎要简单多了，那还能不能更简单呢？确实是可以的。</p><p>Django作为优秀的Web框架，有很多优秀的<strong>第三方库</strong>（即APP）被世界各地的程序员们打包发布在网上，免费供你使用。成功从来都是站在巨人的肩膀上的，既然已经有了“轮子”，何必要自己再造一个呢。</p><p>我们这里就可以用到一个叫<code>Django-password-reset</code>的第三方库。</p><p>打开虚拟环境，输入指令<code>pip install -U django-password-reset</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> E:<span class="token punctuation">\</span>django_project<span class="token punctuation">\</span>my_blog<span class="token operator">></span>pip <span class="token function">install</span> -U django-password-resetCollecting django-password-reset<span class="token punctuation">..</span>.Installing collected packages: django-password-resetSuccessfully installed django-password-reset-2.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看到以上信息说明安装成功了。</p><h2 id="快速使用"><a href="#快速使用" class="headerlink" title="快速使用"></a>快速使用</h2><p>既然第三方库也是app，那肯定需要在<code>/my_blog/settings.py</code>中注册了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token string">'password_reset'</span><span class="token punctuation">,</span>    <span class="token comment"># 新增</span>    <span class="token string">'article'</span><span class="token punctuation">,</span>    <span class="token string">'userprofile'</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在根路由<code>/my_blog/urls.py</code>中添加app的地址：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>my_blog<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    path<span class="token punctuation">(</span><span class="token string">'password-reset/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'password_reset.urls'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改<code>/templates/userprofile/login.html</code>，提供一个重置密码的入口：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">/templates/userprofile/login.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- 新增 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span><span class="token punctuation">></span></span>忘记密码了？<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span><span class="token punctuation">></span></span>点击<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>&#123;% url <span class="token punctuation">"</span>password_reset_recover<span class="token punctuation">"</span> %&#125;<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>这里<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>重置密码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>邮件不能凭空产生</strong>，目前为止我们并没有配置发件邮箱的账号密码，也没有配置发送邮件的端口、发件人等信息。</p><p>因此还需要在<code>/my_blog/settings.py</code>末尾添加发送邮箱的相关配置：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># SMTP服务器，改为你的邮箱的smtp!</span>EMAIL_HOST <span class="token operator">=</span> <span class="token string">'smtp.qq.com'</span><span class="token comment"># 改为你自己的邮箱名！</span>EMAIL_HOST_USER <span class="token operator">=</span> <span class="token string">'your_email_account@xxx.com'</span><span class="token comment"># 你的邮箱密码</span>EMAIL_HOST_PASSWORD <span class="token operator">=</span> <span class="token string">'your_password'</span><span class="token comment"># 发送邮件的端口</span>EMAIL_PORT <span class="token operator">=</span> <span class="token number">25</span><span class="token comment"># 是否使用 TLS</span>EMAIL_USE_TLS <span class="token operator">=</span> <span class="token boolean">True</span><span class="token comment"># 默认的发件人</span>DEFAULT_FROM_EMAIL <span class="token operator">=</span> <span class="token string">'xxx的博客 &lt;your_email_account@xxx.com>'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>有读者反应，这里如果用QQ邮箱有如下问题：1. 邮箱密码不是登录密码，而是 smtp 的专门的认证码；2. 发送端口 25 可能不通，请尝试 465 或 587 端口。若还是不行，建议更换其他品牌的邮箱测试。</p><p><strong>简单邮件传输协议 (Simple Mail Transfer Protocol, SMTP)</strong> 是在Internet传输Email的协议标准。</p><p>SMTP是基于文本的协议。在其之上指定了一条消息的一个或多个接收者，然后消息文本会被传输。SMTP使用TCP端口25。</p><p>SMTP是一个“推”的协议（发送邮件），它不允许从远程服务器上“拉”来消息（接收邮件）。要接收邮件，客户端必须使用<strong>POP3</strong>或<strong>IMAP</strong>。</p></blockquote><p>设置好后就可以开启服务器测试了。</p><p>点击登录页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181102/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE76.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181102/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE76.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击最后一行的链接“这里”：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181102/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE77.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181102/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE77.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>按照要求输入用户名或者Email，点击确认按钮：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181102/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE78a.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181102/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE78a.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>提示已经把重置密码的链接发到邮箱中了。</p><p>前往Email中查看新邮件：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181102/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE79.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181102/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE79.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>居然神奇的收到了邮件！继续点击邮件中的链接：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181102/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE81.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181102/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE81.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>按照提示输入新密码后：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181102/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE80.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181102/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE80.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>密码重置就成功了。</p><p>尝试一下新密码登录是没问题的，顺利完成了任务。</p><p>篇幅关系就没有去挨个覆写原有的模板文件了。如果有兴趣可以仔细阅读官方文档，尝试去改写模板文件，让页面更加匹配自己网站的风格。</p><p><strong>官方文档在这里：</strong><a href="https://django-password-reset.readthedocs.io/en/latest/index.html">docs</a></p><p><strong>GitHub：</strong><a href="https://github.com/brutasse/django-password-reset">django-password-reset</a></p><p>相信读者也尝到使用三方库的甜头了：<strong>只需要写很少的代码，就可以完成大量的功能。</strong>笔者是推荐在开发中多使用优秀的三方库的，可以极大的提高效率，减少重复劳动。当然使用三方库也有一些缺点，比如会因为一知半解而维护困难、不能量身定制等。在实践中到底用还是不用，就根据实际情况再做权衡了。</p><p>后面陆续还会介绍更多的三方库，还是贯彻那句话：成功是站在巨人肩膀上的。</p><h2 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h2><p>发送邮件因为涉及到了发送邮箱的相关设置和权限，所以容易出各种各样奇怪的问题。</p><p>好比说你的发送邮箱设置是<a href="mailto:&#120;&#x78;&#120;&#x40;&#115;&#x69;&#110;&#97;&#x2e;&#99;&#x6f;&#109;">&#120;&#x78;&#120;&#x40;&#115;&#x69;&#110;&#97;&#x2e;&#99;&#x6f;&#109;</a>。项目代码都是对的，但是新浪禁止了smtp服务，那邮件也会发送不成功。如果报错请尝试以下方法：</p><ul><li>设置发送邮箱为允许smtp服务</li><li>检查账号、密码是否正确</li><li>有的发送端口需要额外的设置，尝试更换端口</li><li>更换其他服务商的邮箱</li></ul><p>如果还不行，就请根据报错页面，搜索一下类似问题的解决方案了。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章学习了使用第三方库<code>django-password-reset</code>，高效完成了重置密码的功能。</p><p>下一章学习扩展并更新用户资料。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#x75;&#115;&#x61;&#105;&#112;&#104;&#x6f;&#x74;&#x6f;&#64;&#x66;&#111;&#x78;&#109;&#x61;&#105;&#108;&#x2e;&#x63;&#111;&#x6d;">&#100;&#x75;&#115;&#x61;&#105;&#112;&#104;&#x6f;&#x74;&#x6f;&#64;&#x66;&#111;&#x78;&#109;&#x61;&#105;&#108;&#x2e;&#x63;&#111;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--15.用户的删除</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/15.yong-hu-de-shan-chu/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/15.yong-hu-de-shan-chu/</url>
      
        <content type="html"><![CDATA[<p>这一章将实现删除用户数据的功能。实际上删除用户和前面的删除文章是完全类似的，有了之前的铺垫，这一章会非常的轻松。</p><h2 id="权限与视图"><a href="#权限与视图" class="headerlink" title="权限与视图"></a>权限与视图</h2><p>用户数据是很多网站最重要的财产，<strong>确保用户数据的安全是非常重要的</strong>。</p><p>前面学习的用户登录、退出、创建都是相对安全的操作；而删除数据就很危险，弄不好会造成不可逆的损失。因此我们希望对操作者做一些限制，比如只能用户登录且必须是本用户才能进行删除的操作。这就是<strong>权限</strong>。</p><p>因此在视图中进行简单的用户权限的验证工作。编写<code>/userprofile/views.py</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token comment"># 引入验证登录的装饰器</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> login_required<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token decorator annotation punctuation">@login_required</span><span class="token punctuation">(</span>login_url<span class="token operator">=</span><span class="token string">'/userprofile/login/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">user_delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        user <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>        <span class="token comment"># 验证登录用户、待删除用户是否相同</span>        <span class="token keyword">if</span> request<span class="token punctuation">.</span>user <span class="token operator">==</span> user<span class="token punctuation">:</span>            <span class="token comment">#退出登录，删除数据并返回博客列表</span>            logout<span class="token punctuation">(</span>request<span class="token punctuation">)</span>            user<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"article:article_list"</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"你没有删除操作的权限。"</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"仅接受post请求。"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>分析上面的代码：</p><ul><li><p><code>@login_required</code>是一个<strong>Python装饰器</strong>。装饰器可以在不改变某个函数内容的前提下，给这个函数添加一些功能。具体来说就是<code>@login_required</code>要求调用<code>user_delete()</code>函数时，用户必须登录；如果未登录则不执行函数，将页面重定向到<code>/userprofile/login/</code>地址去。</p></li><li><p>装饰器确认用户已经登录后，允许调用<code>user_delete()</code>；然后需要删除的用户<strong>id</strong>通过请求传递到视图中，由<code>if</code>语句确认是否与登录的用户一致，成功后则退出登录并删除用户数据，返回博客列表页面。</p></li></ul><blockquote><p>装饰器的详细解释可以看这里：<a href="https://www.zhihu.com/question/26930016">如何理解Python装饰器？</a></p><p><code>@login_required</code>的详细解释看这里：<a href="https://docs.djangoproject.com/en/2.1/topics/auth/default/#django.contrib.auth.decorators.login_required">login_required</a></p></blockquote><h2 id="模板与url"><a href="#模板与url" class="headerlink" title="模板与url"></a>模板与url</h2><p>然后改写<code>/templates/header.html</code>，新增了<strong>删除用户</strong>的入口，并且在末尾添加<strong>弹窗组件</strong>的代码:</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">/templates/header.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown-menu<span class="token punctuation">"</span></span> <span class="token attr-name">aria-labelledby</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navbarDropdown<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- 新增 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown-item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">user_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>删除用户<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown-item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>&#123;% url <span class="token punctuation">"</span>userprofile:logout<span class="token punctuation">"</span> %&#125;<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>退出登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span class="token comment">&lt;!-- 新增 --></span>&#123;% if user.is_authenticated %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span>     <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span>     <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user_delete<span class="token punctuation">"</span></span>    <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>userprofile:delete<span class="token punctuation">'</span> user.id %&#125;<span class="token punctuation">"</span></span>     <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;% csrf_token %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>发送<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">        <span class="token keyword">function</span> <span class="token function">user_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 调用layer弹窗组件</span>            layer<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>                title<span class="token operator">:</span> <span class="token string">"确认删除"</span><span class="token punctuation">,</span>                content<span class="token operator">:</span> <span class="token string">"确认删除用户资料吗？"</span><span class="token punctuation">,</span>                <span class="token function-variable function">yes</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> layero</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'form#user_delete button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    layer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>&#123;% endif %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>因为删除用户要求用户必须登录，因此就把它的入口放在登陆后才显示的下拉框中，这样页面可以更加简洁。当然这种方式并不是最佳的选择，通常的做法是把删除功能放在独立的用户资料页面中。</p></li><li><p>与删除文章类似，点击<strong>删除用户</strong>链接后调用了<code>user_delete()</code>函数，函数包含了<strong>弹窗组件</strong>确认用户没有误操作；点击弹窗中的确认按钮后，提交删除的隐藏表单，执行视图。</p></li><li><p>注意到<code>user_delete()</code>函数和表单是用<code>if</code>模板语句包裹起来的。因为用户未登录时页面对象中是没有<code>user.id</code>属性的，但是函数中却又包含了<code>user.id</code>，Django在解析模板时就会报错。<code>if</code>语句确保了<strong>只有在用户登录时才对这段JavaScript代码进行解析</strong>，回避了这个问题。</p></li><li><p>我们在<code>base.html</code>已经引用了<strong>弹窗组件模块</strong>，而<code>header.html</code>是拼接在<code>base.html</code>中的，因此就不用再重复引用弹窗组件了。</p></li></ul><p>最后就是写好<code>/userprofile/urls.py</code>的路由映射了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>urls<span class="token punctuation">.</span>pyurlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 用户删除</span>    path<span class="token punctuation">(</span><span class="token string">'delete/&lt;int:id>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>user_delete<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'delete'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行服务器看看效果。登录用户并在右上角下拉框中点击<strong>删除用户</strong>：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181031/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE74.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181031/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE74.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击确定后就可以成功删除用户数据了。</p><h2 id="检查数据库"><a href="#检查数据库" class="headerlink" title="检查数据库"></a>检查数据库</h2><p>前面我们已经讲过如何用<a href="https://sqlitestudio.pl/index.rvt">SQLiteStudio</a>查看数据库存储的内容，确保数据真正的从数据库中擦除了。</p><p>用<strong>SQLiteStudio</strong>打开项目中<code>db.sqlite3</code>文件，找到<code>auth_user</code>字段，显示如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181031/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE75.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181031/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE75.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>可以看到<code>dusai123</code>这个用户确实已经没有了。</p><p>在验证操作数据的逻辑时，<strong>SQLiteStudio</strong>可以帮助我们直观的发现问题，一定要善加利用。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章学习了删除用户功能，并给它赋予了简单的权限。</p><p>下一章将学习通过邮箱重置用户密码。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#117;&#x73;&#x61;&#x69;&#x70;&#x68;&#x6f;&#x74;&#111;&#64;&#x66;&#111;&#x78;&#109;&#97;&#105;&#108;&#x2e;&#99;&#111;&#109;">&#100;&#117;&#x73;&#x61;&#x69;&#x70;&#x68;&#x6f;&#x74;&#111;&#64;&#x66;&#111;&#x78;&#109;&#97;&#105;&#108;&#x2e;&#99;&#111;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--18.上传头像</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/18.shang-chuan-tou-xiang/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/18.shang-chuan-tou-xiang/</url>
      
        <content type="html"><![CDATA[<p>到目前为止我们的博客处理的都是文字。现代互联网早就进入了“读图”时代，图片的维护、展示也就相当重要。</p><p>上一章中预留了avatar字段，用来保存用户上传的头像，现在我们来实现这个功能。</p><h2 id="必要的设置"><a href="#必要的设置" class="headerlink" title="必要的设置"></a>必要的设置</h2><p>图片属于一种媒体文件，它与静态文件类似，<strong>需要设置一个统一的目录</strong>，便于集中存储和访问。</p><p>这类需要框架统一设置的参数，当然应该在<code>/my_blog/settings.py</code>中。在底部加上：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 媒体文件地址</span>MEDIA_URL <span class="token operator">=</span> <span class="token string">'/media/'</span>MEDIA_ROOT <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'media/'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>MEDIA_ROOT</strong>和<strong>MEDIA_URL</strong>是用户上传文件保存、访问的位置：</p><ul><li><p>在前面的<code>Profile</code>中我们设置了<strong>upload_to</strong>参数。有了这个参数，文件上传后将自动保存到项目根目录的<code>media</code>文件夹中。 <code>os.path.join(MEDIA_ROOT, &#39;media/&#39;)</code>指定了media文件夹的位置。</p></li><li><p>MEDIA_URL代表用户通过URL来访问这个本地地址的URL。设置好这个参数后，用户就可以通过解析url，很方便的获取文件的地址。这样做的好处是避免的硬编码，让代码更容易维护。</p></li></ul><p>Django框架擅长的是对逻辑的处理，而对图片这类文件的处理则非常的耗时。因此在实际的<strong>生产环境</strong>中（即产品上线之后），通常是有专门的Web服务器来处理文件的访问。</p><p>而在开发阶段我们不会在意效率问题，所以Django也提供了方法，让开发服务器能够处理图片。</p><p>在<code>/my_blog/urls.py</code>添加下面的语句：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>my_blog<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 新引入的模块</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings<span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls<span class="token punctuation">.</span>static <span class="token keyword">import</span> staticurlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token comment">#添加这行</span>urlpatterns <span class="token operator">+=</span> static<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>MEDIA_URL<span class="token punctuation">,</span> document_root<span class="token operator">=</span>settings<span class="token punctuation">.</span>MEDIA_ROOT<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样就为以后上传的图片配置好了URL路径。</p><h2 id="编写MTV"><a href="#编写MTV" class="headerlink" title="编写MTV"></a>编写MTV</h2><p>回顾一下，<code>avatar</code>的字段已经在上一章写好了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">Profile</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    avatar <span class="token operator">=</span> models<span class="token punctuation">.</span>ImageField<span class="token punctuation">(</span>upload_to<span class="token operator">=</span><span class="token string">'avatar/%Y%m%d/'</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>upload_to</code>指定了图片上传的位置，即<code>/media/avatar/%Y%m%d/</code>。<code>%Y%m%d</code>是日期格式化的写法，会最终格式化为系统时间。比如说图片上传是2018年12月5日，则图片会保存在<code>/media/avatar/2018205/</code>中。</p><blockquote><p>注意<code>ImageField</code>字段不会存储图片本身，而仅仅保存图片的地址。</p><p>记得用pip指令安装Pillow。</p></blockquote><p>表单类在前面也写好了，不用修改：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>forms<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ProfileForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> Profile        fields <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'avatar'</span><span class="token punctuation">,</span> <span class="token string">'bio'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接着需要修改视图，使之能够对图片进行处理：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token decorator annotation punctuation">@login_required</span><span class="token punctuation">(</span>login_url<span class="token operator">=</span><span class="token string">'/userprofile/login/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">profile_edit</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 修改本行</span>    <span class="token comment"># 上传的文件保存在 request.FILES 中，通过参数传递给表单类</span>    profile_form <span class="token operator">=</span> ProfileForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> request<span class="token punctuation">.</span>FILES<span class="token punctuation">)</span>    <span class="token keyword">if</span> profile_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token comment"># 添加在 profile.bio = profile_cd['bio'] 后面</span>        <span class="token comment"># 如果 request.FILES 存在文件，则保存</span>        <span class="token keyword">if</span> <span class="token string">'avatar'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>FILES<span class="token punctuation">:</span>            profile<span class="token punctuation">.</span>avatar <span class="token operator">=</span> profile_cd<span class="token punctuation">[</span><span class="token string">"avatar"</span><span class="token punctuation">]</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>表单上传的文件对象存储在类字典对象<code>request.FILES</code>中，因此需要修改表单类的参数，将它一并传递进去。</li><li>如果<code>request.FILES</code>中存在键为<code>avatar</code>的元素，则将其赋值给<code>profile.avatar</code>（注意保存的是图片地址）；否则不进行处理。</li></ul><p>修改模板文件，添加代码显示、处理用户的头像：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">/templates/userprofile/edit.html...&#123;% if profile.avatar %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-md-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>头像<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; profile.avatar.url &#125;&#125;<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">max-width</span><span class="token punctuation">:</span> 20%<span class="token punctuation">;</span> <span class="token property">border-radius</span><span class="token punctuation">:</span> 15%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-md-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;% else %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-md-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>暂无头像<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">></span></span>&#123;% endif %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">...</span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;% csrf_token %&#125;    <span class="token comment">&lt;!-- avatar --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>上传头像<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control-file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>模板语法<code>&#123;% if ... %&#125;</code>判断用户是否上传头像。</li><li><code>&lt;img&gt;</code>标签用于显示图片内容；在<code>style</code>属性中规定了图片的最大宽度并带有一点的圆角。</li><li><strong>注意</strong>，表单必须设置<code>enctype=&quot;multipart/form-data&quot;</code>属性，才能够正确上传图片等文件。</li><li>添加<code>&lt;input type=&quot;file&quot; ...&gt;</code>标签用于上传图片。</li></ul><p>启动服务器，刷新用户信息页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181206/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE89.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181206/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE89.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击<strong>选择图片</strong>，上传一张图片后点击<strong>提交</strong>：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181206/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE90.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181206/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE90.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>查看一下项目目录，生成了新的文件夹<code>media/avatar/20181205/</code>，其中存储了该头像文件；在<strong>SQLiteStudio</strong>中查看<code>avatar</code>字段，其保存的是文件的url地址。</p><blockquote><p>除了上传，图片的处理还包括验证格式、改变尺寸、更名、裁剪、美化等多种多样的需求。</p><p>如果上传的图片重名，会导致报错吗？请试试看。</p><p>更改图片仅仅会改变字段中存储的url，并不会真正删除图片本身。因此在处理大容量文件时要小心，需要额外的方法进行清理。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章学习了通过表单上传文件的基础知识。更加高级的文件处理手段还需在探索中不断发掘。你还可以利用BootStrap知识，美化个人信息外观，使它像一个完善的产品级页面。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#117;&#115;&#x61;&#105;&#x70;&#104;&#x6f;&#x74;&#111;&#x40;&#102;&#x6f;&#x78;&#x6d;&#97;&#x69;&#x6c;&#46;&#99;&#111;&#109;">&#100;&#117;&#115;&#x61;&#105;&#x70;&#104;&#x6f;&#x74;&#111;&#x40;&#102;&#x6f;&#x78;&#x6d;&#97;&#x69;&#x6c;&#46;&#99;&#111;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><blockquote><p>转载请告知作者并注明出处。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--19.文章分页</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/19.wen-zhang-fen-ye/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/19.wen-zhang-fen-ye/</url>
      
        <content type="html"><![CDATA[<p>随着时间的推移（<strong>加上勤奋的写作！</strong>），你的博客文章一定会越来越多。如果不进行处理，可能同一个页面会挤上成百上千的文章，不美观不说，还降低了页面的反应速度。</p><p>这个时候就需要对文章进行分页的处理。</p><h2 id="利用轮子"><a href="#利用轮子" class="headerlink" title="利用轮子"></a>利用轮子</h2><p>写一个完善的分页功能是有些难度的，好在Django已经帮你准备好一个现成的分页模块了（Django把大部分基础功能都替你准备好了！）。内置模块虽然简单，但是对博客来说完全足够了。</p><p>我们要用到的是<code>Paginator</code>类。在<code>Shell</code>中可以充分尝试它的用法：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>paginator <span class="token keyword">import</span> Paginator<span class="token operator">>></span><span class="token operator">></span> objects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'john'</span><span class="token punctuation">,</span> <span class="token string">'paul'</span><span class="token punctuation">,</span> <span class="token string">'george'</span><span class="token punctuation">,</span> <span class="token string">'ringo'</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> p <span class="token operator">=</span> Paginator<span class="token punctuation">(</span>objects<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> p<span class="token punctuation">.</span>count<span class="token number">4</span><span class="token operator">>></span><span class="token operator">></span> p<span class="token punctuation">.</span>num_pages<span class="token number">2</span><span class="token operator">>></span><span class="token operator">></span> p<span class="token punctuation">.</span>page_range<span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> page1 <span class="token operator">=</span> p<span class="token punctuation">.</span>page<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> page1<span class="token operator">&lt;</span>Page <span class="token number">1</span> of <span class="token number">2</span><span class="token operator">></span><span class="token operator">>></span><span class="token operator">></span> page1<span class="token punctuation">.</span>object_list<span class="token punctuation">[</span><span class="token string">'john'</span><span class="token punctuation">,</span> <span class="token string">'paul'</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> page2 <span class="token operator">=</span> p<span class="token punctuation">.</span>page<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> page2<span class="token punctuation">.</span>object_list<span class="token punctuation">[</span><span class="token string">'george'</span><span class="token punctuation">,</span> <span class="token string">'ringo'</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> page2<span class="token punctuation">.</span>has_next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token boolean">False</span><span class="token operator">>></span><span class="token operator">></span> page2<span class="token punctuation">.</span>has_previous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> page2<span class="token punctuation">.</span>has_other_pages<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token boolean">True</span><span class="token operator">>></span><span class="token operator">></span> page2<span class="token punctuation">.</span>previous_page_number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>这是一个官网的例子。详见：<a href="https://docs.djangoproject.com/zh-hans/2.1/topics/pagination/">Pagination</a></p></blockquote><p>有了这个类，剩下的工作就是把它应用到项目中去。</p><h2 id="轻车熟路"><a href="#轻车熟路" class="headerlink" title="轻车熟路"></a>轻车熟路</h2><p>要对文章列表分页，因此就要修改<code>article/views.py</code>的<code>def article_list()</code>视图：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 引入分页模块</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>paginator <span class="token keyword">import</span> Paginator<span class="token keyword">def</span> <span class="token function">article_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 修改变量名称（articles -> article_list）</span>    article_list <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 每页显示 1 篇文章</span>    paginator <span class="token operator">=</span> Paginator<span class="token punctuation">(</span>article_list<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment"># 获取 url 中的页码</span>    page <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page'</span><span class="token punctuation">)</span>    <span class="token comment"># 将导航对象相应的页码内容返回给 articles</span>    articles <span class="token operator">=</span> paginator<span class="token punctuation">.</span>get_page<span class="token punctuation">(</span>page<span class="token punctuation">)</span>    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'articles'</span><span class="token punctuation">:</span> articles <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在视图中通过<code>Paginator</code>类，给传递给模板的内容做了手脚：<strong>返回的不再是所有文章的集合，而是对应页码的部分文章的对象，并且这个对象还包含了分页的方法。</strong></p><p>我们在前面的文章已经接触过一些将参数传递到视图的手段了：</p><ul><li>通过POST请求将表单数据传递到视图</li><li>通过url将地址中的参数传递到视图</li></ul><p>这里用到了另一种方法：在GET请求中，在url的末尾附上<code>?key=value</code>的键值对，视图中就可以通过<code>request.GET.get(&#39;key&#39;)</code>来查询<code>value</code>的值。</p><p>然后改写模板，在最末尾的<code>&lt;/div&gt;</code>前面，加入分页的内容：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html...<span class="token comment">&lt;!-- 页码导航 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pagination row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>m-auto<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>step-links<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token comment">&lt;!-- 如果不是第一页，则显示上翻按钮 --></span>            &#123;% if articles.has_previous %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=1<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token entity named-entity" title="&laquo;">&amp;laquo;</span> 1                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=&#123;&#123; articles.previous_page_number &#125;&#125;<span class="token punctuation">"</span></span>                    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-secondary<span class="token punctuation">"</span></span>                <span class="token punctuation">></span></span>                    &#123;&#123; articles.previous_page_number &#125;&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>            &#123;% endif %&#125;            <span class="token comment">&lt;!-- 当前页面 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>current btn btn-danger btn-lg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                &#123;&#123; articles.number &#125;&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>            <span class="token comment">&lt;!-- 如果不是最末页，则显示下翻按钮 --></span>            &#123;% if articles.has_next %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=&#123;&#123; articles.next_page_number &#125;&#125;<span class="token punctuation">"</span></span>                   <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-secondary<span class="token punctuation">"</span></span>                <span class="token punctuation">></span></span>                    &#123;&#123; articles.next_page_number &#125;&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=&#123;&#123; articles.paginator.num_pages &#125;&#125;<span class="token punctuation">"</span></span>                   <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span>                <span class="token punctuation">></span></span>                    &#123;&#123; articles.paginator.num_pages &#125;&#125; <span class="token entity named-entity" title="&raquo;">&amp;raquo;</span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>            &#123;% endif %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>内容也比较简单，用到了前面的<code>Shell</code>中演示的部分方法，判断当前页所处的位置。</p><p>这样就行了！补充几篇文章（笔者共6篇），方便测试。刷新页面后是这样的：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181220/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE115.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181220/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE115.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>视图中设置了每页只有1篇文章，所以就真的只有1篇了。</p><p>当然这只是为了测试，实际环境中肯定要远大于1篇的。</p><p>点击第2页的按钮后是这样的：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181220/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE113.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181220/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE113.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p><strong>看到顶部地址栏中的变化了吗？</strong></p><p>思考一下<code>page</code>是如何从模板传递到视图的。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>除模板外，我们只写了4行代码，就有了还不错的分页导航，Django就是这么贴心。</p><p>除了对文章列表，你可以对任何你想分页的地方运用此模块（比如以后要讲到的评论），满足用户各类的需求。</p><p>读者还可以稍加阅读<a href="https://getbootstrap.com/">Bootstrap 4官方文档</a>，改写一个符合自己品味的外观。</p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#117;&#115;&#97;&#x69;&#x70;&#x68;&#x6f;&#x74;&#111;&#64;&#102;&#x6f;&#x78;&#x6d;&#x61;&#105;&#x6c;&#46;&#x63;&#x6f;&#109;">&#100;&#117;&#115;&#97;&#x69;&#x70;&#x68;&#x6f;&#x74;&#111;&#64;&#102;&#x6f;&#x78;&#x6d;&#x61;&#105;&#x6c;&#46;&#x63;&#x6f;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--20.浏览量</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/20.liu-lan-liang/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/20.liu-lan-liang/</url>
      
        <content type="html"><![CDATA[<p><strong>文章浏览量</strong>是所有社交类网站所必备的数据，足以显示其重要性了。</p><p>博主可以通过浏览量来评估某篇文章的受欢迎程度，读者也能够通过浏览量来筛选质量更高的文章。</p><p>然而，准确统计浏览量并不简单：</p><ul><li>某些类型的请求不应该统计为浏览量，比如作者自己的浏览或编辑文章之后的重定向请求；</li><li>由于用户众多，浏览量的数据时刻都在快速更新，会给数据库带来很大的压力。因此很多大型网站都会使用如<a href="https://redis.io/">Redis</a>这样的读写速度非常快的内存数据库辅助存储。</li></ul><p>因为我们的项目是博客网站，粗略统计就可以了，也没有那么大的用户压力，所以设计就简单得多了。</p><h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><p>浏览量作为每篇博文都有的数据，需要一个字段来存储。</p><p>因此修改文章的模型：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        total_views <span class="token operator">=</span> models<span class="token punctuation">.</span>PositiveIntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>PositiveIntegerField</code>是用于存储正整数的字段</li><li><code>default=0</code>设定初始值从0开始</li></ul><p>修改完数据库别忘了要<strong>数据迁移</strong>，否则更改不会生效。</p><p>由于新字段设置了初始值，迁移会很顺畅：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> E:<span class="token punctuation">\</span>django_project<span class="token punctuation">\</span>my_blog<span class="token operator">></span>python manage.py makemigrationsMigrations <span class="token keyword">for</span> <span class="token string">'article'</span><span class="token builtin class-name">:</span>  article<span class="token punctuation">\</span>migrations<span class="token punctuation">\</span>0003_articlepost_total_views.py    - Add field total_views to articlepostMigrations <span class="token keyword">for</span> <span class="token string">'userprofile'</span><span class="token builtin class-name">:</span>  userprofile<span class="token punctuation">\</span>migrations<span class="token punctuation">\</span>0002_auto_20181227_2041.py    - Alter field avatar on profile    - Alter field user on profile<span class="token punctuation">(</span>env<span class="token punctuation">)</span> E:<span class="token punctuation">\</span>django_project<span class="token punctuation">\</span>my_blog<span class="token operator">></span>python manage.py migrateOperations to perform:  Apply all migrations: admin, article, auth, contenttypes, sessions, userprofileRunning migrations:  Applying article.0003_articlepost_total_views<span class="token punctuation">..</span>. OK  Applying userprofile.0002_auto_20181227_2041<span class="token punctuation">..</span>. OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="列表模板"><a href="#列表模板" class="headerlink" title="列表模板"></a>列表模板</h2><p>为了方便观察效果，这次先写模板文件。</p><p>什么地方需要显示浏览量呢？很容易想到的就是文章列表了。修改文章列表的模板：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card-footer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 已有代码 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_detail<span class="token punctuation">'</span> article.id %&#125;<span class="token punctuation">"</span></span>        <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        阅读本文    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 显示浏览量 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col align-self-end<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> gray<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>            浏览: &#123;&#123; article.total_views &#125;&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>笔者将浏览量显示在了<strong>“阅读本文”</strong>的边上。</p><p>有的同学觉得显示在这里不好看，请修改代码，将其放到自己最满意的地方。（顺便熟悉一下Bootstrap！）</p><h2 id="详情模板"><a href="#详情模板" class="headerlink" title="详情模板"></a>详情模板</h2><p>除了文章列表外，通常详情页面中也需要显示浏览量。</p><p>除此之外，在前面的学习中为了方便，没有做任何<strong>权限管理</strong>，以至于任何用户都可以对所有文章进行修改、删除：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181228/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE118.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181228/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE118.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>这样是肯定不行的，必须修复这个严重的错误。</p><p>修改<code>article/detail.html</code>模板文件：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token comment">&lt;!-- 文章详情 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        ...        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12 alert alert-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>                作者：&#123;&#123; article.author &#125;&#125;                &#123;% if user == article.author %&#125;                    · <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">confirm_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>删除文章<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                    · <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">"</span></span><span class="token attr-name"><span class="token namespace">article:</span>article_update"</span> <span class="token attr-name">article.id</span> <span class="token attr-name">%&#125;"</span><span class="token punctuation">></span></span>                        编辑文章                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                &#123;% endif %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>                浏览：&#123;&#123; article.total_views &#125;&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改内容有：</p><ul><li>确认当前登录用户是文章的作者，才显示“删除文章、“编辑文章”两个链接</li><li>显示浏览量</li></ul><p>修改后的页面如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181228/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE119.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181228/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE119.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>上图中由于文章作者和登录用户不一致，修改文章的链接没有渲染出来了；如果登录用户是作者本人，它们又会正常显示。</p><blockquote><p>这样的方法可以阻止大部分的“好用户”非法修改数据。但是如果有“坏用户”直接输入url地址来使坏，该怎么办呢？所以光是靠前端页面来鉴权是不够的。</p></blockquote><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>现在浏览量能够正确显示了，但是由于没有进行任何处理，其数值会一直为0。我们希望每当用户访问详情页面时，浏览量就加1。</p><p>修改<code>article_detail()</code>如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">def</span> <span class="token function">article_detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>        <span class="token comment"># 浏览量 +1</span>    article<span class="token punctuation">.</span>total_views <span class="token operator">+=</span> <span class="token number">1</span>    article<span class="token punctuation">.</span>save<span class="token punctuation">(</span>update_fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'total_views'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>update_fields=[]</code>指定了数据库只更新<code>total_views</code>字段，优化执行效率。</p><p>测试一下，可以正常对浏览量计数了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181228/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE121.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181228/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE121.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><h2 id="视图中鉴权"><a href="#视图中鉴权" class="headerlink" title="视图中鉴权"></a>视图中鉴权</h2><p>前面讲了，光是在模板中鉴权是不够的，必须在后端业务逻辑中再次验证用户身份。</p><p>修改<code>article_update()</code>更新文章的视图：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 提醒用户登录</span><span class="token decorator annotation punctuation">@login_required</span><span class="token punctuation">(</span>login_url<span class="token operator">=</span><span class="token string">'/userprofile/login/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">article_update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 已有代码</span>    article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token comment"># 过滤非作者的用户</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>user <span class="token operator">!=</span> article<span class="token punctuation">.</span>author<span class="token punctuation">:</span>        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"抱歉，你无权修改这篇文章。"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>视图中进行了两次鉴权：</p><ul><li><code>login_required</code>装饰器过滤未登录的用户</li><li><code>if</code>语句过滤已登录、但非作者本人的用户</li></ul><p>通过在业务逻辑中再次验证身份，完全阻止恶意用户从中使坏了。</p><p>除了更新文章的视图外，<strong>删除文章也应该做类似的工作</strong>，请读者自行修改并测试。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章完成了简单的统计浏览量的功能，并且在前后端中对用户的身份进行了验证。</p><p>下一章学习与浏览量紧密相关的功能：<strong>查询最热文章</strong>。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#117;&#x73;&#x61;&#x69;&#x70;&#104;&#x6f;&#x74;&#x6f;&#64;&#102;&#x6f;&#120;&#109;&#x61;&#x69;&#108;&#x2e;&#99;&#111;&#109;">&#x64;&#117;&#x73;&#x61;&#x69;&#x70;&#104;&#x6f;&#x74;&#x6f;&#64;&#102;&#x6f;&#120;&#109;&#x61;&#x69;&#108;&#x2e;&#99;&#111;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><blockquote><p>转载请注明出处。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--21.最热文章</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/21.zui-re-wen-zhang/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/21.zui-re-wen-zhang/</url>
      
        <content type="html"><![CDATA[<p>有了浏览量之后，文章受欢迎的程度就有了评价标准。随之而来的就有根据浏览量对文章进行排序的需求，即显示<strong>“最热文章”</strong>。</p><p>现在你已经很熟悉MTV模式，不需要我啰嗦也能完成任务：</p><ul><li>文章的模型已经有了，不需要写Model了</li><li>写一个视图函数<code>article_list_by_views()</code>，取出按浏览排序后的文章对象</li><li>将文章对象传递到模板，并进行渲染</li></ul><p><strong>很简单，但也隐藏着问题</strong>：最热文章列表和之前的普通文章列表相比，大部分功能其实都是相同的，仅仅是排序不同而已。</p><p>万一哪天需要根据文章标题排序呢？万一还需要用户id排序、标签排序、收藏排序…不仅如此，就连路由<code>urls.py</code>都要跟着膨胀。代码会越来越臃肿且不可维护。</p><p><strong>重复的代码是万恶之源。</strong>因此这里挑战一下，不创建新的视图/路由，而是将排序功能融合到已有的视图/路由中。</p><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>根据以上需求，重写<code>article_list()</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 重写文章列表</span><span class="token keyword">def</span> <span class="token function">article_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 根据GET请求中查询条件</span>    <span class="token comment"># 返回不同排序的对象数组</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'order'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'total_views'</span><span class="token punctuation">:</span>        article_list <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-total_views'</span><span class="token punctuation">)</span>        order <span class="token operator">=</span> <span class="token string">'total_views'</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        article_list <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        order <span class="token operator">=</span> <span class="token string">'normal'</span>    paginator <span class="token operator">=</span> Paginator<span class="token punctuation">(</span>article_list<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page'</span><span class="token punctuation">)</span>    articles <span class="token operator">=</span> paginator<span class="token punctuation">.</span>get_page<span class="token punctuation">(</span>page<span class="token punctuation">)</span>        <span class="token comment"># 修改此行</span>    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'articles'</span><span class="token punctuation">:</span> articles<span class="token punctuation">,</span> <span class="token string">'order'</span><span class="token punctuation">:</span> order <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>重点知识如下：</strong></p><ul><li>前面用过GET请求传递单个参数。它也是可以传递多个参数的，如<code>?a=1&amp;b=2</code>，参数间用<code>&amp;</code>隔开</li><li>视图根据GET参数<code>order</code>的值，判断取出的文章如何排序</li><li><code>order_by()</code>方法指定对象如何进行排序。模型中有<code>total_views</code>这个整数字段，因此‘total_views’为正序，‘-total_views’为逆序</li><li>为什么把新变量<code>order</code>也传递到模板中？因为文章需要翻页！<code>order</code>给模板一个标识，提醒模板下一页应该如何排序</li></ul><p>这样一来，排序所需要的参数都可以通过查询获得，连<code>urls.py</code>都不用改写了。</p><h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><p>接下来修改文章列表模板：优化入口，并且正确分页：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span> <span class="token attr-name">aria-label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breadcrumb<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ol</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breadcrumb<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breadcrumb-item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_list<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    最新                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breadcrumb-item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_list<span class="token punctuation">'</span> %&#125;?order=total_views<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    最热                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ol</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row mt-2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        &#123;% for article in articles %&#125;        ...        &#123;% endfor %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- 页码导航 --></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=1&amp;order=&#123;&#123; order &#125;&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&laquo;">&amp;laquo;</span> 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=&#123;&#123; articles.previous_page_number &#125;&#125;&amp;order=&#123;&#123; order &#125;&#125;<span class="token punctuation">"</span></span>    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-secondary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>...    &#123;% if articles.has_next %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=&#123;&#123; articles.next_page_number &#125;&#125;&amp;order=&#123;&#123; order &#125;&#125;<span class="token punctuation">"</span></span>   <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-secondary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; articles.next_page_number &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=&#123;&#123; articles.paginator.num_pages &#125;&#125;&amp;order=&#123;&#123; order &#125;&#125;<span class="token punctuation">"</span></span>   <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; articles.paginator.num_pages &#125;&#125; <span class="token entity named-entity" title="&raquo;">&amp;raquo;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>新增了Bootstrap中的面包屑导航样式<code>breadcrumb</code></li><li>页码导航中，所有的分页链接都新增了<code>order</code>参数</li></ul><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>启动服务器，点击“最热”：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181228/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE132.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181228/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE132.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>工作得很好！切换页码，留意地址栏中是如何变化的。</p><p>还剩一个小瑕疵：用户点击“最热”按钮后，此按钮最好能够变为灰色，并且不可点击。这个精益求精的机会就留给读者去优化吧。</p><blockquote><p>header.html中有一个小改动：”写文章”的入口被挪到用户下拉菜单中了。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章已经摸到一个高级的编程领域门槛了：代码复用。将类似功能的代码合并到了一起，并且让后续的功能扩展变得很容易。只需要在视图中写几个<code>elif</code>语句就搞定了。</p><p>在读者以后的编程中，也要尽量优化代码结构，达到事半功倍的效果。</p><p>至此，博客虽小，功能却相当完整了。继续努力！</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#117;&#x73;&#97;&#105;&#x70;&#x68;&#x6f;&#116;&#x6f;&#x40;&#x66;&#x6f;&#x78;&#x6d;&#x61;&#x69;&#x6c;&#46;&#99;&#x6f;&#x6d;">&#100;&#117;&#x73;&#97;&#105;&#x70;&#x68;&#x6f;&#116;&#x6f;&#x40;&#x66;&#x6f;&#x78;&#x6d;&#x61;&#x69;&#x6c;&#46;&#99;&#x6f;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><blockquote><p>转载请注明出处。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--22.搜索文章</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/22.sou-suo-wen-zhang/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/22.sou-suo-wen-zhang/</url>
      
        <content type="html"><![CDATA[<p>不管是最新文章列表也好、最热文章列表也罢，都是把<strong>所有</strong>的文章数据全部展示给了用户。</p><p>但是如果用户只关心某些<strong>特定类型</strong>的文章，抽取全部数据就显得既不方便、又不效率了。</p><p>因此，给用户提供一个<strong>搜索功能</strong>，提供给用户感兴趣的几篇文章，就大有用处了。</p><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a>逻辑</h3><p>尽管细节不同，但是<strong>搜索和列表</strong>有很多类似的地方：它们都是先检索出一些文章对象，并将其展示给用户。上一章已经说过，<strong>代码重复是万恶之源</strong>，好的实践必须把功能类似的模块尽量复用起来。基于这个原则，我们打算继续在原有的<code>article_list()</code>上添砖加瓦，让其功能更加的强大。</p><blockquote><p>随着项目越来越庞大，又需要将功能复杂的模块拆分成更简单的多个模块。目前我们还不用担心这个问题。</p></blockquote><p>更酷的是，我们希望搜索出来的文章也能够按照时间、热度等各种方式进行排序。因此需要构造一个新的参数<code>search</code>，能够和之前的<code>order</code>参数进行联合查询。</p><h3 id="GET还是POST？"><a href="#GET还是POST？" class="headerlink" title="GET还是POST？"></a>GET还是POST？</h3><p>用户搜索内容时提交的文本，可以用GET请求提交，也可以用POST请求提交。根据实际的需要进行选择。</p><p>因为<code>order</code>是用GET提交的，并且翻页是GET请求，因此选择GET方式提交搜索文本，可以方便地和之前的模块结合起来。</p><p>之前我们已经用过表单组件<code>&lt;form method=&quot;POST&quot;&gt;</code>，通过POST请求提交数据。表单组件同样也可以提交GET请求，只要去掉<code>method=&quot;POST&quot;</code>属性就可以了。</p><h3 id="Q对象"><a href="#Q对象" class="headerlink" title="Q对象"></a>Q对象</h3><p><code>Model.objects.all()</code>能够返回表中的所有对象。</p><p>对应的，<code>Model.objects.filter(**kwargs)</code>可以返回与给定参数匹配的部分对象。</p><blockquote><p>还有<code>Model.objects.exclude(**kwargs)</code>返回与给定参数不匹配的对象</p></blockquote><p>如果想对多个参数进行查询怎么办？比如同时查询文章标题和正文内容。这时候就需要<strong>Q对象</strong>。</p><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>那么按照前面说好的，修改<code>article_list()</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 引入 Q 对象</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Q<span class="token keyword">def</span> <span class="token function">article_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    search <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">)</span>    order <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'order'</span><span class="token punctuation">)</span>    <span class="token comment"># 用户搜索逻辑</span>    <span class="token keyword">if</span> search<span class="token punctuation">:</span>        <span class="token keyword">if</span> order <span class="token operator">==</span> <span class="token string">'total_views'</span><span class="token punctuation">:</span>            <span class="token comment"># 用 Q对象 进行联合搜索</span>            article_list <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>                Q<span class="token punctuation">(</span>title__icontains<span class="token operator">=</span>search<span class="token punctuation">)</span> <span class="token operator">|</span>                Q<span class="token punctuation">(</span>body__icontains<span class="token operator">=</span>search<span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-total_views'</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            article_list <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>                Q<span class="token punctuation">(</span>title__icontains<span class="token operator">=</span>search<span class="token punctuation">)</span> <span class="token operator">|</span>                Q<span class="token punctuation">(</span>body__icontains<span class="token operator">=</span>search<span class="token punctuation">)</span>            <span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token comment"># 将 search 参数重置为空</span>        search <span class="token operator">=</span> <span class="token string">''</span>        <span class="token keyword">if</span> order <span class="token operator">==</span> <span class="token string">'total_views'</span><span class="token punctuation">:</span>            article_list <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-total_views'</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            article_list <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    paginator <span class="token operator">=</span> Paginator<span class="token punctuation">(</span>article_list<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page'</span><span class="token punctuation">)</span>    articles <span class="token operator">=</span> paginator<span class="token punctuation">.</span>get_page<span class="token punctuation">(</span>page<span class="token punctuation">)</span>        <span class="token comment"># 增加 search 到 context</span>    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'articles'</span><span class="token punctuation">:</span> articles<span class="token punctuation">,</span> <span class="token string">'order'</span><span class="token punctuation">:</span> order<span class="token punctuation">,</span> <span class="token string">'search'</span><span class="token punctuation">:</span> search <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重点知识如下：</p><ul><li><p>新增参数<strong>search</strong>，存放需要搜索的文本。若search不为空，则检索特定文章对象。</p></li><li><p>留意<strong>filter</strong>中<strong>Q对象</strong>的用法。<code>Q(title__icontains=search)</code>意思是在模型的<code>title</code>字段查询，<code>icontains</code>是<strong>不区分大小写的包含</strong>，中间用两个下划线隔开。<code>search</code>是需要查询的文本。多个Q对象用管道符<code>|</code>隔开，就达到了联合查询的目的。</p><blockquote><p>icontains不区分大小写，对应的contains区分大小写</p></blockquote></li><li><p>为什么需要<code>search = &#39;&#39;</code>语句？如果用户没有搜索操作，则<code>search = request.GET.get(&#39;search&#39;)</code>会使得<code>search = None</code>，而这个值传递到模板中会错误地转换成<code>&quot;None&quot;</code><strong>字符串</strong>！等同于用户在搜索“None”关键字，这明显是错误的。</p><blockquote><p>完成本章内容后，可以删除此语句看看效果</p></blockquote></li></ul><p>除此之外还有一点小的代码优化工作：将需要重复用到<code>order = request.GET.get(&#39;order&#39;)</code>提取到顶部，让模块稍稍清爽一点。</p><h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><p>还是修改文章列表的模板文件。</p><p>需要修改的内容稍多，仔细一些不要看错：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 修改，面包屑的href增加search参数 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span> <span class="token attr-name">aria-label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breadcrumb<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ol</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breadcrumb<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breadcrumb-item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_list<span class="token punctuation">'</span> %&#125;?search=&#123;&#123; search &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    最新                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breadcrumb-item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_list<span class="token punctuation">'</span> %&#125;?order=total_views&amp;search=&#123;&#123; search &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    最热                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ol</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 新增，搜索栏 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-auto mr-auto<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-inline<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sr-only<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>content<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>                     <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control mb-2 mr-sm-2<span class="token punctuation">"</span></span>                     <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>search<span class="token punctuation">"</span></span>                     <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>搜索文章...<span class="token punctuation">"</span></span>                     <span class="token attr-name">required</span>                <span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 新增，搜索提示语 --></span>    &#123;% if search %&#125;        &#123;% if articles %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>"&#123;&#123; search &#125;&#125;"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>的搜索结果如下：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span>                &#123;% else %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">></span></span>暂无<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>"&#123;&#123; search &#125;&#125;"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>有关的文章。<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span>        &#123;% endif %&#125;    &#123;% endif %&#125;                    ...    <span class="token comment">&lt;!-- 修改，页码href增加search参数 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=1&amp;order=&#123;&#123; order &#125;&#125;&amp;search=&#123;&#123; search &#125;&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=&#123;&#123; articles.previous_page_number &#125;&#125;&amp;order=&#123;&#123; order &#125;&#125;&amp;search=&#123;&#123; search &#125;&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-secondary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=&#123;&#123; articles.next_page_number &#125;&#125;&amp;order=&#123;&#123; order &#125;&#125;&amp;search=&#123;&#123; search &#125;&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-secondary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=&#123;&#123; articles.paginator.num_pages &#125;&#125;&amp;order=&#123;&#123; order &#125;&#125;&amp;search=&#123;&#123; search &#125;&#125;<span class="token punctuation">"</span></span><span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>面包屑组件、页码组件都改动了href：增加了<code>search</code>参数</li><li>新增搜索栏，以GET请求提交<code>search</code>参数；<code>required</code>属性阻止用户提交空白文本</li><li>新增搜索提示语。好的UI必须让用户了解当前的状态</li></ul><p>Emmm…想想也不用改动其他东西了。</p><p>开始测试吧！</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>还是打开文章列表页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181230/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE133.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181230/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE133.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>出现了搜索栏！并且翻页、最热等功能一切正常。</p><p>在搜索栏中输入“PYTHON”，结果如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181230/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE134.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181230/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE134.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>成功将标题或正文中含有”python”关键字的文章检索出来了，并且是忽略大小写的。点击<strong>最热</strong>可以让检索结果按浏览量排序，翻页功能也正常工作。很好，达成了目标！</p><p>学到这里的读者应该感到自豪：你用了同一个url，集成了很多种功能，展示了不同的内容！这对新手来说其实并不容易做到。</p><blockquote><p>这种方法有一个小缺点：有的时候url中会包含像<code>search=&#39;&#39;</code>（空值）这样无意义的字符串，强迫症简直不能忍。所幸这无伤大雅，通常用户并不会关心你的url是什么样子的，只要网页美观好用就行。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章完成了一个简单的搜索功能，这对于个人博客来说应该够用了。</p><p>更加复杂、深度定制的搜索可以借助第三方模块，如<a href="https://github.com/django-haystack/django-haystack">Haystack</a>。</p><p>另外笔者这样实现搜索不一定是最优的。相信你已经掌握多种途径来实现搜索功能了（POST请求？搜索专用视图？另写url？），尽情尝试一番吧。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#117;&#x73;&#97;&#105;&#112;&#104;&#111;&#x74;&#111;&#x40;&#x66;&#111;&#120;&#x6d;&#97;&#105;&#108;&#46;&#99;&#x6f;&#x6d;">&#100;&#117;&#x73;&#97;&#105;&#112;&#104;&#111;&#x74;&#111;&#x40;&#x66;&#111;&#120;&#x6d;&#97;&#105;&#108;&#46;&#99;&#x6f;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><blockquote><p>转载请注明出处。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--23.文章目录</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/23.wen-zhang-mu-lu/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/23.wen-zhang-mu-lu/</url>
      
        <content type="html"><![CDATA[<p>对会读书的人来说，读一本书要做的第一件事，就是仔细阅读这本书的目录。阅读目录可以对整体内容有所了解，并清楚地知道感兴趣的部分在哪里，提高阅读质量。</p><p>博文也是同样的，好的目录对博主和读者都很有帮助。更进一步的是，还可以在目录中设置锚点，点击标题就立即前往该处，非常的方便。</p><h2 id="文中的目录"><a href="#文中的目录" class="headerlink" title="文中的目录"></a>文中的目录</h2><p>之前我们已经为博文支持了Markdown语法，现在继续增强其功能。</p><p>有折腾代码高亮的痛苦经历之后，设置Markdown的目录扩展就显得特别轻松了。</p><p>修改文章详情视图：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 文章详情</span><span class="token keyword">def</span> <span class="token function">article_detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    article<span class="token punctuation">.</span>body <span class="token operator">=</span> markdown<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>article<span class="token punctuation">.</span>body<span class="token punctuation">,</span>        extensions<span class="token operator">=</span><span class="token punctuation">[</span>        <span class="token string">'markdown.extensions.extra'</span><span class="token punctuation">,</span>        <span class="token string">'markdown.extensions.codehilite'</span><span class="token punctuation">,</span>                    <span class="token comment"># 目录扩展</span>        <span class="token string">'markdown.extensions.TOC'</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>    <span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>仅仅是将<code>markdown.extensions.TOC</code>扩展添加了进去。</p><blockquote><p><strong>注意</strong>：有读者反映某些版本下 <code>markdown.extensions.TOC</code> 会报错。如果遇到这种情况，请尝试修改为 <code>markdown.extensions.toc</code> 。</p></blockquote><p>代码增加这一行就足够了。为了方便测试，往之前的文章中添加几个一级标题、二级标题等。</p><blockquote><p>还记得Markdown语法如何写标题吗？一级标题：<code># title1</code>，二级标题：<code>## title2</code></p></blockquote><p>然后你可以在文中的任何地方插入<code>[TOC]</code>字符串，目录就自动生成好了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181231/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE135.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181231/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE135.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击标题，页面就立即前往相应的标题处（即“锚点”的概念）。</p><h2 id="任意位置的目录"><a href="#任意位置的目录" class="headerlink" title="任意位置的目录"></a>任意位置的目录</h2><p>上面的方法只能将目录插入到文章当中。如果我想把目录插入到页面的任何一个位置呢？</p><p>也简单，这次需要修改Markdown的渲染方法：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">def</span> <span class="token function">article_detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 修改 Markdown 语法渲染</span>    md <span class="token operator">=</span> markdown<span class="token punctuation">.</span>Markdown<span class="token punctuation">(</span>        extensions<span class="token operator">=</span><span class="token punctuation">[</span>        <span class="token string">'markdown.extensions.extra'</span><span class="token punctuation">,</span>        <span class="token string">'markdown.extensions.codehilite'</span><span class="token punctuation">,</span>        <span class="token string">'markdown.extensions.toc'</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>    <span class="token punctuation">)</span>    article<span class="token punctuation">.</span>body <span class="token operator">=</span> md<span class="token punctuation">.</span>convert<span class="token punctuation">(</span>article<span class="token punctuation">.</span>body<span class="token punctuation">)</span>    <span class="token comment"># 新增了md.toc对象</span>    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'article'</span><span class="token punctuation">:</span> article<span class="token punctuation">,</span> <span class="token string">'toc'</span><span class="token punctuation">:</span> md<span class="token punctuation">.</span>toc <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/detail.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了能将<code>toc</code>单独提取出来，我们先将Markdown类赋值给一个临时变量<code>md</code>，然后用<code>convert()</code>方法将正文渲染为html页面。通过<code>md.toc</code>将目录传递给模板。</p><blockquote><p>注意<code>markdown.markdown()</code>和<code>markdown.Markdown()</code>的区别</p><p>更详细的解释见：<a href="https://python-markdown.github.io/extensions/toc/">官方文档</a></p></blockquote><p>为了将新的目录渲染到页面中，需要修改文章详情模板：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- 将原有内容嵌套进新的div中 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-9<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mt-4 mb-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; article.title &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>alert alert-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                ...            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- 新增的目录 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-3 mt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">></span></span>目录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>                &#123;&#123; toc|safe &#125;&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>重新布局，将原有内容装进<code>col-9</code>的容器中，将右侧<code>col-3</code>的空间留给目录</li><li><code>toc</code>需要<code>|safe</code>标签才能正确渲染</li></ul><p>重新打开页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181231/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE136.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181231/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE136.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>完成了文章的目录功能，至此文章详情页面也比较完善了。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#x75;&#x73;&#x61;&#105;&#x70;&#x68;&#111;&#x74;&#x6f;&#x40;&#x66;&#x6f;&#120;&#109;&#x61;&#105;&#x6c;&#x2e;&#x63;&#x6f;&#x6d;">&#100;&#x75;&#x73;&#x61;&#105;&#x70;&#x68;&#111;&#x74;&#x6f;&#x40;&#x66;&#x6f;&#120;&#109;&#x61;&#105;&#x6c;&#x2e;&#x63;&#x6f;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><blockquote><p>转载请注明出处。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--25.课间休息</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/25.ke-jian-xiu-xi/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/25.ke-jian-xiu-xi/</url>
      
        <content type="html"><![CDATA[<p><strong>教程看到这里，你已经学会如下内容：</strong></p><ul><li>搭建开发环境</li><li>博文管理</li><li>用户管理</li><li>发表评论</li><li>若干其他功能</li></ul><p>搭建简单的小博客，以上的功能够用了。<strong>但相信你的志向不止于此，</strong>毕竟程序员面试个个造火箭啊。</p><h2 id="接下来学什么"><a href="#接下来学什么" class="headerlink" title="接下来学什么"></a>接下来学什么</h2><p><strong>教程接下来是进阶部分，包括：</strong></p><ul><li>类视图</li><li>多级评论</li><li>文章栏目和标签</li><li>图片处理</li><li>第三方登录</li><li>测试与维护</li><li>部署</li><li>其他内容</li></ul><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>开发好项目的demo后，你应该尽快部署到云服务器上，让世界各地的用户随时浏览你的网页。不要误会，<strong>部署只是一个起点</strong>，作用是让你获得巨大的成就感；部署后你还是需要持续的优化、添加网站的功能，以及修补你满天飞的Bug。</p><p><a href="https://www.dusaiphoto.com/article/detail/71/">将项目部署到线上的章节</a>在本教程的末尾，心急的同学可以先去尝试部署。当然按部就班的学完教程再部署也是可以的。</p><h2 id="继续战斗"><a href="#继续战斗" class="headerlink" title="继续战斗"></a>继续战斗</h2><p>看完这些，你就可以踏上新的征程了。</p><p>写这篇博文正好在2019年元旦，而你应该在未来的某个普通的日子看到。</p><p><strong>陌生人，祝你学业进步、事业有成，继续战斗吧！</strong></p><blockquote><p>写教程付出博主很多的精力，如果你有收获，欢迎点击教程尾部的**[打赏]**按钮，请博主喝杯咖啡~</p><p>或者在我的<a href="https://github.com/stacklens/django_blog_tutorial">GitHub博客教程代码</a>给一个小星星，感谢各位的支持。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--24.评论</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/24.ping-lun/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/24.ping-lun/</url>
      
        <content type="html"><![CDATA[<p>在没有互联网的年代，我们用日记来记录每天的心得体会。小的时候我有一个带锁的日记本，生怕被别人看见里面写了啥，钥匙藏得那叫一个绝。</p><p>现在时代变了，网络版的日记本：博客，却巴不得越多人看越好。</p><p>别人看完你写的深度好文，难免也想高谈阔论一番，这就是“评论”功能。</p><p>本章将要编写的评论模块，几乎没有新的知识点，而是将前面章节内容的综合应用。</p><p><strong>强烈建议读者自行尝试编写这部分内容，测试自己的知识掌握程度。</strong></p><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>评论是一个相对独立的功能，因此新建一个评论的app：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> E:<span class="token punctuation">\</span>django_project<span class="token punctuation">\</span>my_blog <span class="token operator">></span> ppython manage.py startapp comment<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>有的人觉得奇怪，没有博文就没有评论，为什么说评论是“独立”的功能？</p><p>那是因为不仅博文可以评论，照片、视频甚至网站本身都可以“被评论”。将其封装成单独的模块方便以后的扩展。</p></blockquote><p>确认app创建成功后，记得在<code>settings.py</code>中注册：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token string">'comment'</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>TIME_ZONE <span class="token operator">=</span> <span class="token string">'Asia/Shanghai'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因为我们想显示发表评论的时间，修改时区设置<code>TIME_ZONE</code>为上海的时区。</p><p>然后在<code>my_blog/urls.py</code>中注册根路由：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 评论</span>    path<span class="token punctuation">(</span><span class="token string">'comment/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'comment.urls'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'comment'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="编写核心功能"><a href="#编写核心功能" class="headerlink" title="编写核心功能"></a>编写核心功能</h2><h3 id="评论的模型"><a href="#评论的模型" class="headerlink" title="评论的模型"></a>评论的模型</h3><p>首先编写评论的模型：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token keyword">from</span> article<span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticlePost<span class="token comment"># 博文的评论</span><span class="token keyword">class</span> <span class="token class-name">Comment</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    article <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>        ArticlePost<span class="token punctuation">,</span>        on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span>        related_name<span class="token operator">=</span><span class="token string">'comments'</span>    <span class="token punctuation">)</span>    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>        User<span class="token punctuation">,</span>         on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span>         related_name<span class="token operator">=</span><span class="token string">'comments'</span>    <span class="token punctuation">)</span>    body <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span><span class="token punctuation">)</span>    created <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        ordering <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>模型中共有2个外键：</p><ul><li><code>article</code>是被评论的文章</li><li><code>user</code>是评论的发布者</li></ul><p>别忘了每次新增、修改Model后，必须<strong>数据迁移</strong>。</p><blockquote><p>提示：你必须先在setting.py中注册app，这个app中的数据迁移才能生效</p></blockquote><h3 id="评论的表单"><a href="#评论的表单" class="headerlink" title="评论的表单"></a>评论的表单</h3><p>用户提交评论时会用到表单，因此<strong>新建</strong>表单类：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>forms<span class="token punctuation">.</span>py<span class="token keyword">from</span> django <span class="token keyword">import</span> forms<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Comment<span class="token keyword">class</span> <span class="token class-name">CommentForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        model <span class="token operator">=</span> Comment        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'body'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因为模型中的2个外键将通过视图逻辑自动填写，所以这里只需要提交<code>body</code>就足够了。</p><h3 id="评论的url"><a href="#评论的url" class="headerlink" title="评论的url"></a>评论的url</h3><p>在comment app中<strong>新建</strong>路由文件：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> viewsapp_name <span class="token operator">=</span> <span class="token string">'comment'</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token comment"># 发表评论</span>    path<span class="token punctuation">(</span><span class="token string">'post-comment/&lt;int:article_id>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>post_comment<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'post_comment'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>评论必须关联在某篇具体的博文里，因此传入博文的<code>id</code>，方便后续调用。</p><p><code>post_comment()</code>视图还没写，先取个名字占位置。</p><h3 id="评论的视图"><a href="#评论的视图" class="headerlink" title="评论的视图"></a>评论的视图</h3><p>评论的视图函数如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token punctuation">,</span> get_object_or_404<span class="token punctuation">,</span> redirect<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> login_required<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse<span class="token keyword">from</span> article<span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticlePost<span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> CommentForm<span class="token comment"># 文章评论</span><span class="token decorator annotation punctuation">@login_required</span><span class="token punctuation">(</span>login_url<span class="token operator">=</span><span class="token string">'/userprofile/login/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">post_comment</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> article_id<span class="token punctuation">)</span><span class="token punctuation">:</span>    article <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>ArticlePost<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span>article_id<span class="token punctuation">)</span>    <span class="token comment"># 处理 POST 请求</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        comment_form <span class="token operator">=</span> CommentForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token keyword">if</span> comment_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            new_comment <span class="token operator">=</span> comment_form<span class="token punctuation">.</span>save<span class="token punctuation">(</span>commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>            new_comment<span class="token punctuation">.</span>article <span class="token operator">=</span> article            new_comment<span class="token punctuation">.</span>user <span class="token operator">=</span> request<span class="token punctuation">.</span>user            new_comment<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>article<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"表单内容有误，请重新填写。"</span><span class="token punctuation">)</span>    <span class="token comment"># 处理错误请求</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"发表评论仅接受POST请求。"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>代码中有2个新面孔。</strong></p><p><code>get_object_or_404()</code>：它和<code>Model.objects.get()</code>的功能基本是相同的。区别是在生产环境下，如果用户请求一个不存在的对象时，<code>Model.objects.get()</code>会返回<code>Error 500</code>（服务器内部错误），而<code>get_object_or_404()</code>会返回<code>Error 404</code>。相比之下，返回404错误更加的准确。</p><p><code>redirect()</code>：返回到一个适当的url中：即用户发送评论后，重新定向到文章详情页面。当其参数是一个Model对象时，会自动调用这个Model对象的<code>get_absolute_url()</code>方法。因此接下来马上修改<code>article</code>的模型。</p><blockquote><p>实际上之前的章节已经用过<code>redirect()</code>了。功能是相同的，实现上略有区别。</p></blockquote><h3 id="文章的模型"><a href="#文章的模型" class="headerlink" title="文章的模型"></a>文章的模型</h3><p>按照上面说的，在文章模型中添加<code>get_absolute_url()</code>方法：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 记得导入</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse<span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 获取文章地址</span>    <span class="token keyword">def</span> <span class="token function">get_absolute_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> reverse<span class="token punctuation">(</span><span class="token string">'article:article_detail'</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过<code>reverse()</code>方法返回文章详情页面的url，实现了路由重定向。</p><h3 id="文章详情视图"><a href="#文章详情视图" class="headerlink" title="文章详情视图"></a>文章详情视图</h3><p>评论模块需要在<strong>文章详情</strong>页面展示，所以必须把评论模块的上下文也传递到模板中。</p><p>因此修改<code>article/views.py</code>中的<code>article_detail()</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">from</span> comment<span class="token punctuation">.</span>models <span class="token keyword">import</span> Comment<span class="token keyword">def</span> <span class="token function">article_detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 已有代码</span>    article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token comment"># 取出文章评论</span>    comments <span class="token operator">=</span> Comment<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>article<span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 添加comments上下文</span>    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'article'</span><span class="token punctuation">:</span> article<span class="token punctuation">,</span> <span class="token string">'toc'</span><span class="token punctuation">:</span> md<span class="token punctuation">.</span>toc<span class="token punctuation">,</span> <span class="token string">'comments'</span><span class="token punctuation">:</span> comments <span class="token punctuation">&#125;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>filter()</code>可以取出多个满足条件的对象，而<code>get()</code>只能取出1个，注意区分使用</p></blockquote><h3 id="文章详情模板"><a href="#文章详情模板" class="headerlink" title="文章详情模板"></a>文章详情模板</h3><p>到最后一步了，坚持。所有后台的功能已经写完了，就差把所有这些展现到页面中了。</p><p>修改文章详情页面：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-9<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    ...    <span class="token comment">&lt;!-- 已有代码，文章正文 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 发表评论 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span>    &#123;% if user.is_authenticated %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span>                 <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>comment:post_comment<span class="token punctuation">'</span> article.id %&#125;<span class="token punctuation">"</span></span>                 <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span>            <span class="token punctuation">></span></span>            &#123;% csrf_token %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">></span></span>                            我也要发言：                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span>                         <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>                         <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span>                         <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span>                         <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span>                         <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 提交按钮 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary <span class="token punctuation">"</span></span><span class="token punctuation">></span></span>发送<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    &#123;% else %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row justify-content-center<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            请<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>userprofile:login<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>后回复        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    &#123;% endif %&#125;        <span class="token comment">&lt;!-- 显示评论 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">></span></span>共有&#123;&#123; comments.count &#125;&#125;条评论<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        &#123;% for comment in comments %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> pink</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>                    &#123;&#123; comment.user &#125;&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">></span></span> 于                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> green</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>                    &#123;&#123; comment.created|date:"Y-m-d H:i:s" &#125;&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span> 时说：            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">font-family</span><span class="token punctuation">:</span> inherit<span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> 1em<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>&#123;&#123; comment.body &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">></span></span>        &#123;% endfor %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- 目录 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-3 mt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>表单组件中的<code>action</code>指定数据提交到哪个url中</p></li><li><p>显示评论中的<code>comments.count</code>是模板对象中内置的方法，对包含的元素进行计数</p></li><li><p><code>|date:&quot;Y-m-d H:i :s&quot;</code>：管道符你已经很熟悉了，用于给对象“粘贴”某些属性或功能。这里用于格式化日期的显示方式。请尝试修改其中的某些字符试试效果。</p></li><li><p><code>&lt;pre&gt;</code>定义预格式化的文本，在我们的项目中最关键的作用是保留空格和换行符。该标签会改变文字的字体、大小等，因此用<code>style</code>属性重新定义相关内容。尝试将<code>&lt;pre&gt;</code>替换为<code>div</code>，输入多行文本试试效果。</p><blockquote><p>之前说代码最好不要复制粘贴，否则有些“小坑”你是留意不到的。比如在<code>&lt;pre&gt;</code>标签中的文本千万不能缩进。</p></blockquote></li></ul><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>又到了激动人心的测试环节了。</p><p>登录自己的账户，进入某个文章详情页面，发现已经可以进行留言了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190101/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE137.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190101/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE137.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>如果退出登录，显示提示语：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190101/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE138.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190101/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE138.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击登录就回到登录页面。</p><p>评论模块的发布、展示功能就搞定了。</p><h3 id="扫尾工作"><a href="#扫尾工作" class="headerlink" title="扫尾工作"></a>扫尾工作</h3><p>数据的删、改功能我们已经做过很多遍，这里不打算再赘述了。</p><p>评论同样也可以支持Markdown语法，或者插入Emoji表情符号。</p><p>读者可以自己去实现感兴趣的功能。</p><blockquote><p>有些网站干脆就没有删除、更新评论的功能。因为对小站来说，这些功能用到的次数太少太少了，不如把精力用在更有价值的地方去。比如<a href="https://www.dusaiphoto.com/">我的博客</a>就没有。</p><p>还有的网站提供软删除，删除后仅仅是不显示而已，实际上数据还存在。</p><p>具体应该如何做，都以你的喜好而定。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章实现了发表评论、展示评论的功能。像开头说的一样，本章的内容是前面所学章节的综合。</p><p>如果你没有看本章代码，而是完全靠自己完成了评论功能，那么恭喜你获得了<strong>“Django入门程序员”</strong>的称号！不要小看“入门”两字，万事开头难嘛。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#x75;&#x73;&#x61;&#105;&#x70;&#104;&#x6f;&#116;&#111;&#64;&#102;&#111;&#120;&#109;&#97;&#x69;&#x6c;&#x2e;&#99;&#x6f;&#109;">&#100;&#x75;&#x73;&#x61;&#105;&#x70;&#104;&#x6f;&#116;&#111;&#64;&#102;&#111;&#120;&#109;&#97;&#x69;&#x6c;&#x2e;&#99;&#x6f;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><blockquote><p>转载请注明出处。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--27.文章栏目</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/27.wen-zhang-lan-mu/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/27.wen-zhang-lan-mu/</url>
      
        <content type="html"><![CDATA[<p>博客的文章类型通常不止一种：有时候你会写高深莫测的技术文章，有时候又纯粹只记录一下当天的心情。</p><p>因此<strong>对文章的分类</strong>就显得相当的重要了，既方便博主对文章进行分类归档，也方便用户有针对性的阅读。</p><p>而文章分类一个重要的途径就是设置<strong>栏目</strong>。</p><h2 id="栏目的模型"><a href="#栏目的模型" class="headerlink" title="栏目的模型"></a>栏目的模型</h2><p>实现文章栏目功能的方法有多种。你可以只是简单的在文章的Model中增加<code>CharField()</code>字段，以字符串的形式将栏目名称保存起来（实际上这种实现更像是<strong>“标签”</strong>，以后会讲到）。这样做的优点是比较简单；缺点也很明显，就是时间长了你可能会记混栏目的名字，并且也不方便对栏目的其他属性进行扩展。</p><p>因此对文章栏目可以独立为一个Model，用外键与文章的Model关联起来。</p><p>修改<code>article/modles.py</code>文件：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ArticleColumn</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    栏目的 Model    """</span>    <span class="token comment"># 栏目标题</span>    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token comment"># 创建时间</span>    created <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>default<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>title<span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 文章栏目的 “一对多” 外键</span>    column <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>        ArticleColumn<span class="token punctuation">,</span>        null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>        blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>        on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span>        related_name<span class="token operator">=</span><span class="token string">'article'</span>    <span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>栏目的Model有两个字段，“名称”和“创建日期”。</p><p>一篇文章只有一个栏目，而一个栏目可以对应多篇文章，因此建立“一对多”的关系。</p><p>写好模型后记得用<code>makemigrations</code>和<code>migrate</code>指令<strong>迁移数据</strong>。</p><h2 id="列表中显示栏目"><a href="#列表中显示栏目" class="headerlink" title="列表中显示栏目"></a>列表中显示栏目</h2><h3 id="添加测试数据"><a href="#添加测试数据" class="headerlink" title="添加测试数据"></a>添加测试数据</h3><p>模型写好之后就需要几条栏目的数据来进行测试。由于还没有写视图，因此需要善加利用Django自带的后台。</p><p>首先把栏目模型注册到后台：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>admin<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticleColumn<span class="token comment"># 注册文章栏目</span>admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>ArticleColumn<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后就可以在后台中添加栏目的数据条目了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190129/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE153.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190129/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE153.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>先随便添加了“HTML”、“Java”、“Django”这3条。</p><p>在后台中随便打开一篇文章，“栏目”字段已经静静的在等你了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190129/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE155.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190129/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE155.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>随机找几篇文章设置不同的<strong>栏目</strong>用于测试。</p><h3 id="重写文章列表"><a href="#重写文章列表" class="headerlink" title="重写文章列表"></a>重写文章列表</h3><p>之前我们用<strong>卡片类型</strong>的UI界面展示文章列表。</p><p>卡片的好处是简洁大方，但是<strong>随着数据的增多</strong>，卡片小小的版面已经不堪重负了。</p><p>因此这里重写<code>list.html</code>模板的列表循环：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">article/list.html...<span class="token comment">&lt;!-- 列表循环 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row mt-2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    &#123;% for article in articles %&#125;        <span class="token comment">&lt;!-- 文章内容 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token comment">&lt;!-- 栏目 --></span>            &#123;% if article.column %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span>                     <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-sm mb-2                        &#123;% if article.column.title == <span class="token punctuation">'</span>Django<span class="token punctuation">'</span> %&#125;                            btn-success                        &#123;% elif article.column.title == <span class="token punctuation">'</span>Java<span class="token punctuation">'</span> %&#125;                            btn-danger                        &#123;% elif article.column.title == <span class="token punctuation">'</span>HTML<span class="token punctuation">'</span> %&#125;                            btn-warning                        &#123;% endif %&#125;                    <span class="token punctuation">"</span></span>                <span class="token punctuation">></span></span>                    &#123;&#123; article.column &#125;&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>            &#123;% endif %&#125;            <span class="token comment">&lt;!-- 标题 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_detail<span class="token punctuation">'</span> article.id %&#125;<span class="token punctuation">"</span></span>                       <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> black<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span>                     <span class="token punctuation">></span></span>                        &#123;&#123; article.title &#125;&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">></span></span>            <span class="token comment">&lt;!-- 摘要 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> gray<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>                    &#123;&#123; article.body|slice:'100' &#125;&#125;...                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>            <span class="token comment">&lt;!-- 注脚 --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 附加信息 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> green<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>                    &#123;&#123; article.total_views &#125;&#125; 浏览<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>                    &#123;&#123; article.created|date:'Y-m-d' &#125;&#125; 发布<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> darkred<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>                    &#123;&#123; article.updated|date:'Y-m-d' &#125;&#125; 更新                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    &#123;% endfor %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最主要的改动就是新增了展现“栏目”的按钮。我们甚至还为不同的栏目设置了不同的按钮颜色。</p><p>在附加信息中顺便还把之前没有用到的日期信息也添加上去了。</p><p>来看看效果：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190129/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE159_Dl0zERq.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190129/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE159_Dl0zERq.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>感觉还不错！</p><h2 id="修改写文章功能"><a href="#修改写文章功能" class="headerlink" title="修改写文章功能"></a>修改写文章功能</h2><p>展示已经没问题了，但是发表新文章时还不能选择栏目。</p><p>修改写文章的模板，在表单中新增下面的内容：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/create.html...<span class="token comment">&lt;!-- 提交文章的表单 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    &#123;% csrf_token %&#125;    <span class="token comment">&lt;!-- 文章标题 --></span>    ...        <span class="token comment">&lt;!-- 文章栏目 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>column<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>栏目<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span>                 <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>column<span class="token punctuation">"</span></span>                 <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>column<span class="token punctuation">"</span></span>        <span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>none<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>请选择栏目..<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>            &#123;% for column in columns %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; column.id &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; column &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>            &#123;% endfor %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 文章正文 --></span>    ...    <span class="token comment">&lt;!-- 提交按钮 --></span>    ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>&lt;select&gt;</code>是表单的下拉框选择组件。在这个组件中循环列出所有的栏目数据，并且设置<code>value</code>属性，指定表单提交栏目的<code>id</code>值。</p><p>刷新页面，效果像下面这样：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190129/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE158.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190129/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE158.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>跟之前一样，能够展示了，但是还没有处理表单的视图逻辑。</p><p>修改已有的写文章视图<code>article_create()</code>，让其能够处理表单上传的栏目数据：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token comment"># 引入栏目Model</span><span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticleColumn<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 写文章的视图</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">def</span> <span class="token function">article_create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">if</span> article_post_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                        <span class="token comment"># 新增的代码</span>            <span class="token keyword">if</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'column'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'none'</span><span class="token punctuation">:</span>                new_article<span class="token punctuation">.</span>column <span class="token operator">=</span> ArticleColumn<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'column'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                        <span class="token comment"># 已有代码</span>            new_article<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token comment"># 新增及修改的代码</span>        columns <span class="token operator">=</span> ArticleColumn<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'article_post_form'</span><span class="token punctuation">:</span> article_post_form<span class="token punctuation">,</span> <span class="token string">'columns'</span><span class="token punctuation">:</span> columns <span class="token punctuation">&#125;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>新增代码涉及<code>get</code>和<code>post</code>两部分：</p><ul><li>POST：主要考虑某些文章是可以没有栏目的。因此用<code>if</code>语句判断该文章是否有栏目，如果有，则根据表单提交的<code>value</code>值，关联对应的栏目。</li><li>GET：增加栏目的上下文，以便模板使用。</li></ul><p>测试一下，写文章的栏目功能应该可以正常工作了。</p><h2 id="修改更新视图"><a href="#修改更新视图" class="headerlink" title="修改更新视图"></a>修改更新视图</h2><p>更新文章的视图同样也需要升级一下。</p><p>还是先更改模板：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/update.html...<span class="token comment">&lt;!-- 提交文章的表单 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    &#123;% csrf_token %&#125;    <span class="token comment">&lt;!-- 文章标题 --></span>    ...    <span class="token comment">&lt;!-- 文章栏目 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>column<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>栏目<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span>                 <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>column<span class="token punctuation">"</span></span>                 <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>column<span class="token punctuation">"</span></span>        <span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>none<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>请选择栏目..<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>            &#123;% for column in columns %&#125;                &lt;option value="&#123;&#123; column.id &#125;&#125;"                    &#123;% if column.id == article.column.id %&#125;                        selected                    &#123;% endif %&#125;                >                    &#123;&#123; column &#125;&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>            &#123;% endfor %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 文章正文 --></span>    ...    <span class="token comment">&lt;!-- 提交按钮 --></span>    ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>与前面稍有不同的是，表单中判断了<code>column.id</code>与<code>article.column.id</code>是否相等，如果相等则将其设置为默认值。</p><p>然后修改视图函数：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token comment"># 更新文章</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">def</span> <span class="token function">article_update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 判断用户是否为 POST 提交表单数据</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">if</span> article_post_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment"># 新增的代码</span>            <span class="token keyword">if</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'column'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'none'</span><span class="token punctuation">:</span>                article<span class="token punctuation">.</span>column <span class="token operator">=</span> ArticleColumn<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'column'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                article<span class="token punctuation">.</span>column <span class="token operator">=</span> <span class="token boolean">None</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 新增及修改的代码</span>        columns <span class="token operator">=</span> ArticleColumn<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span>             <span class="token string">'article'</span><span class="token punctuation">:</span> article<span class="token punctuation">,</span>             <span class="token string">'article_post_form'</span><span class="token punctuation">:</span> article_post_form<span class="token punctuation">,</span>            <span class="token string">'columns'</span><span class="token punctuation">:</span> columns<span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码逻辑与前面很类似。修改文章的栏目功能，也就完成了。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章实现了简单的<strong>栏目功能</strong>，可以舒舒服服对文章进行分类了，强迫症福音啊。</p><p>还有些可以完善的工作，比如：</p><ul><li><p>单击<strong>栏目按钮</strong>显示所有相同栏目的文章。这个功能与之前学过的<a href="https://www.dusaiphoto.com/article/detail/46/">最热文章排序</a>以及<a href="https://www.dusaiphoto.com/article/detail/47/">搜索文章</a>非常的类似。还记得<code>filter()</code>方法吗？稍微麻烦点的地方是你需要考虑栏目、搜索、排序三者的联合查询，因此可能会对原有代码结构做适当的调整。</p><blockquote><p><strong>实在不知道如何去实现的同学，请查看<a href="https://github.com/stacklens/django_blog_tutorial">教程代码</a>文章列表的视图和模板，答案就在里面。</strong></p></blockquote></li><li><p>栏目Model的增删改查。</p><blockquote><p>如果你不想写增删改查，用后台管理栏目是完全可以的。</p></blockquote></li></ul><p>以上内容就不在这里赘述了。留给读者去尝试实现。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#x75;&#x73;&#x61;&#x69;&#x70;&#104;&#111;&#116;&#x6f;&#x40;&#x66;&#x6f;&#x78;&#109;&#x61;&#x69;&#108;&#46;&#x63;&#111;&#x6d;">&#100;&#x75;&#x73;&#x61;&#x69;&#x70;&#104;&#111;&#116;&#x6f;&#x40;&#x66;&#x6f;&#x78;&#109;&#x61;&#x69;&#108;&#46;&#x63;&#111;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--26.基于类的视图</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/26.ji-yu-lei-de-shi-tu/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/26.ji-yu-lei-de-shi-tu/</url>
      
        <content type="html"><![CDATA[<p>说是完结，马上又开始写进阶篇了。</p><p>本章不会为博客项目增加新功能，<strong>但是也同样重要</strong>，因为我们要学习<del>高逼格的</del>基于<strong>类</strong>的视图。</p><h2 id="什么是类视图"><a href="#什么是类视图" class="headerlink" title="什么是类视图"></a>什么是类视图</h2><p>前面章节中写的所有视图都是基于函数的，即<code>def</code>；而类视图是基于类的，即<code>class</code>。</p><p>有编程基础的同学都知道，<strong>类</strong>是面向对象技术中非常重要的概念。具有复杂<strong>数据</strong>、<strong>功能</strong>的类，可以通过继承轻而易举的将自身特性传递给另一个类，从而实现代码的高效复用。</p><p>相比以前的函数视图，类视图有以下优势：</p><ul><li>HTTP方法（<code>GET</code>，<code>POST</code>等）相关的代码，可以通过<strong>方法</strong>而不是<strong>条件分支</strong>来组织</li><li>可以通过诸如mixins（多重继承）之类的面向对象技术将代码分解为<strong>可重用组件</strong></li></ul><p>说的都是什么意思？通过例子来感受一下。</p><h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><h3 id="函数和类"><a href="#函数和类" class="headerlink" title="函数和类"></a>函数和类</h3><p>假设我们有一个<a href="https://www.dusaiphoto.com/article/detail/16/">博客列表</a>，列表既有GET方法、又有POST方法，那么用视图函数看起来像这样：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">views<span class="token punctuation">.</span>py<span class="token keyword">def</span> <span class="token function">article_list_example</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""处理GET请求"""</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>        articles <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'articles'</span><span class="token punctuation">:</span> articles<span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而在<strong>类视图</strong>中，则变为这样：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">views<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>views <span class="token keyword">import</span> View<span class="token keyword">class</span> <span class="token class-name">ArticleListView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""处理GET请求"""</span>    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        articles <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'articles'</span><span class="token punctuation">:</span> articles<span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从本质上讲，基于类的视图允许你使用不同的<strong>类实例方法</strong>（即上面的<code>def get()</code>）响应不同的HTTP请求方法，而不需要使用<strong>条件分支</strong>代码。这样做的好处是把不同的HTTP请求都分离到独立的函数中，逻辑更加清晰，并且方便复用。</p><p><strong>需要注意的是</strong>，因为Django的URL解析器希望将请求发送到<strong>函数</strong>而不是类，所以类视图有一个 <code>as_view()</code>方法，该方法返回一个函数，当请求匹配关联模式的URL时，则调用该函数。</p><p>即，视图函数的url原本写为：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>article_list_example<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>类视图的url需改写为：</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>ArticleListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="通用视图"><a href="#通用视图" class="headerlink" title="通用视图"></a>通用视图</h3><p>像<strong>列表</strong>这样的功能在web开发中是很常见的，开发者会一遍又一遍写几乎相同的列表逻辑。Django的<strong>通用视图</strong>正是为缓解这种痛苦而开发的。它们对常用模式进行抽象，以便你快速编写公共视图，而无需编写太多代码。</p><p>因此用列表通用视图改写如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">views<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>generic <span class="token keyword">import</span> ListView<span class="token keyword">class</span> <span class="token class-name">ArticleListView</span><span class="token punctuation">(</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 上下文的名称</span>    context_object_name <span class="token operator">=</span> <span class="token string">'articles'</span>    <span class="token comment"># 查询集</span>    queryset <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 模板位置</span>    template_name <span class="token operator">=</span> <span class="token string">'article/list.html'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>列表继承了父类<code>ListView</code>，也就获得了父类中的处理列表的方法，因此你可以看到，我们在自己的类中没有写任何处理的逻辑，仅仅是赋值了几个变量而已。</p><h3 id="动态过滤"><a href="#动态过滤" class="headerlink" title="动态过滤"></a>动态过滤</h3><p>从数据库中筛选特定的内容也是常见的需求，类视图如何实现呢？</p><p>你可能想到了，将上面代码中改为<code>queryset = ArticlePost.objects.filter()</code>就可以了。</p><p>除此之外，<strong>更好的办法</strong>是覆写<code>get_queryset()</code>方法：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ArticleListView</span><span class="token punctuation">(</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    context_object_name <span class="token operator">=</span> <span class="token string">'articles'</span>    template_name <span class="token operator">=</span> <span class="token string">'article/list.html'</span>    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        查询集        """</span>        queryset <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">'Python'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> queryset<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例子中只是过滤出标题为“Python”的文章而已，有些大材小用了；但是你可以在<code>get_queryset()</code>中写复杂的联合查询逻辑，满足个性化的功能。</p><h3 id="添加上下文"><a href="#添加上下文" class="headerlink" title="添加上下文"></a>添加上下文</h3><p>在博客列表的设计时，我们返回给模板的<strong>上下文</strong>除了<code>articles</code>以外，还有很多额外的信息，如<code>order</code>、<code>search</code>；在类视图中同样可以实现，改写<code>get_context_data()</code>方法即可：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ArticleListView</span><span class="token punctuation">(</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 获取原有的上下文</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        <span class="token comment"># 增加新上下文</span>        context<span class="token punctuation">[</span><span class="token string">'order'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'total_views'</span>        <span class="token keyword">return</span> context<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>除此之外，<code>ListView</code>还有些别的方法可以覆写，深入了解可以看这里：<a href="https://docs.djangoproject.com/zh-hans/2.1/ref/class-based-views/generic-display/#listview">官方文档</a></p><h3 id="混入类"><a href="#混入类" class="headerlink" title="混入类"></a>混入类</h3><p><strong>混入类（Mixin）</strong>是指<strong>具有某些功能、通常不独立使用、提供给其他类继承功能</strong>的类。嗯，就是“混入”的字面意思。</p><p>前面的列表视图中已经有<code>get_context_data()</code>方法了。假设需要写一个功能类似的视频列表，就可以用<strong>Mixin</strong>来避免重复代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ContextMixin</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">get_context_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        context <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_context_data<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        context<span class="token punctuation">[</span><span class="token string">'order'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'total_views'</span>        <span class="token keyword">return</span> context<span class="token keyword">class</span> <span class="token class-name">ArticleListView</span><span class="token punctuation">(</span>ContextMixin<span class="token punctuation">,</span> ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">VideoListView</span><span class="token punctuation">(</span>ContextMixin<span class="token punctuation">,</span> ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过混入，两个子类都获得了<code>get_context_data()</code>方法。</p><blockquote><p>从语法上看，混入是通过多重继承实现的。有区别的是，Mixin是<strong>作为功能</strong>添加到子类中的，而不是作为父类。</p></blockquote><p>实际上Django内置了很多通用的Mixin类，实现了大部分常用的功能，点这里深入了解：<a href="https://docs.djangoproject.com/zh-hans/2.1/ref/class-based-views/mixins/">官方文档</a></p><h2 id="详情页"><a href="#详情页" class="headerlink" title="详情页"></a>详情页</h2><p>既然列表都有通用视图，详情页当然也有对应的<code>DetailView</code>。</p><p>用类视图写一个<a href="https://www.dusaiphoto.com/article/detail/19/">简单的详情页</a>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">views<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>generic <span class="token keyword">import</span> DetailView<span class="token keyword">class</span> <span class="token class-name">ArticleDetailView</span><span class="token punctuation">(</span>DetailView<span class="token punctuation">)</span><span class="token punctuation">:</span>    queryset <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    context_object_name <span class="token operator">=</span> <span class="token string">'article'</span>    template_name <span class="token operator">=</span> <span class="token string">'article/detail.html'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后配置url：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token comment"># 详情类视图</span>    path<span class="token punctuation">(</span><span class="token string">'detail-view/&lt;int:pk>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>ArticleDetailView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意这里传入的参数不是<code>id</code>而是<code>pk</code>，这是视图的要求（也可以传入<code>slug</code>）。<code>pk</code>是数据表的主键，在默认情况下其实就是<code>id</code>。</p><p>这就写好了！</p><p>也可以添加任何别的功能，比如<a href="https://www.dusaiphoto.com/article/detail/45/">统计浏览量</a>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ArticleDetailView</span><span class="token punctuation">(</span>DetailView<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">def</span> <span class="token function">get_object</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        获取需要展示的对象        """</span>        <span class="token comment"># 首先调用父类的方法</span>        obj <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>ArticleDetailView<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_object<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 浏览量 +1</span>        obj<span class="token punctuation">.</span>total_views <span class="token operator">+=</span> <span class="token number">1</span>        obj<span class="token punctuation">.</span>save<span class="token punctuation">(</span>update_fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'total_views'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> obj<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>方法<code>get_object()</code>的作用是获取需要展示的对象。首先调用父类方法，将这个对象赋值给<code>obj</code>变量，然后再对其进行统计浏览量的操作，最后将对象返回。相当于在原有的方法中把自己的逻辑“塞”了进去。</p><p>关于<code>DetailView</code>更多特性看这里：<a href="https://docs.djangoproject.com/zh-hans/2.1/ref/class-based-views/generic-display/#detailview">官方文档</a></p><h1 id="编辑"><a href="#编辑" class="headerlink" title="编辑"></a>编辑</h1><p>除了能够展示信息，通用视图还包含<code>CreateView</code>、<code>UpdateView</code>、<code>DeleteView</code>等<strong>编辑</strong>数据的类。</p><p>如果要<a href="https://www.dusaiphoto.com/article/detail/22/">新建文章</a>，则视图可以这么写：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">views<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>edit <span class="token keyword">import</span> CreateView<span class="token keyword">class</span> <span class="token class-name">ArticleCreateView</span><span class="token punctuation">(</span>CreateView<span class="token punctuation">)</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> ArticlePost        fields <span class="token operator">=</span> <span class="token string">'__all__'</span>    <span class="token comment"># 或者只填写部分字段，比如：</span>    <span class="token comment"># fields = ['title', 'content']</span>        template_name <span class="token operator">=</span> <span class="token string">'article/create_by_class_view.html'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建<code>create_by_class_view.html</code>文件（目录在哪，你应该已经很清楚了），写入：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">create_by_class_view.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;% csrf_token %&#125;    &#123;&#123; form.as_p &#125;&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Save<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后添加url：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">urls<span class="token punctuation">.</span>pyurlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'create-view/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>ArticleCreateView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>虽然外观简陋（这不是重点），但现在这个视图确实已经能够创建新文章了！</p><p><code>UpdateView</code>和<code>DeleteView</code>这里就不再赘述了，以后用到的地方再进行讲解。</p><p>想提前了解的同学戳这里：<a href="https://docs.djangoproject.com/zh-hans/2.1/ref/class-based-views/generic-editing/">官方文档</a></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>有没有感受到<strong>代码隔离</strong>和<strong>继承</strong>的强大？没有？以后的章节会逐渐使用<strong>类</strong>编写视图，你会慢慢体会的。</p><p>类视图的内容非常丰富，短短一篇文章只能蜻蜓点水而已。读者在编程中遇到困难了，官方文档是你最好的教程。</p><p>如果你有耐心从头到尾阅读类视图的官方文档，那当然是最好的了。</p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#x75;&#x73;&#97;&#105;&#x70;&#104;&#111;&#x74;&#111;&#64;&#x66;&#111;&#120;&#x6d;&#x61;&#105;&#108;&#46;&#99;&#x6f;&#109;">&#100;&#x75;&#x73;&#97;&#105;&#x70;&#104;&#111;&#x74;&#111;&#64;&#x66;&#111;&#120;&#x6d;&#x61;&#105;&#108;&#46;&#99;&#x6f;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><blockquote><p>转载请告知作者并注明出处。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--28.文章标签</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/28.wen-zhang-biao-qian/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/28.wen-zhang-biao-qian/</url>
      
        <content type="html"><![CDATA[<p><strong>“标签”</strong>是作者从文章中提取的<strong>核心词汇</strong>，其他用户可以通过标签快速了解文章的关注点。每一篇文章的标签可能都不一样，并且还可能拥有多个标签，这是与栏目功能不同的。</p><p>好在标签功能也有优秀的三方库：<a href="https://github.com/jazzband/django-taggit">Django-taggit</a>，省得自己动手设计了。快速开发就是这样，能“借用”就不要自己重复劳动。</p><h2 id="安装及设置"><a href="#安装及设置" class="headerlink" title="安装及设置"></a>安装及设置</h2><p>首先在<strong>虚拟环境</strong>中安装Django-taggit：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> django-taggit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装成功后，修改项目设置以添加库：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token string">'taggit'</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="修改文章模型"><a href="#修改文章模型" class="headerlink" title="修改文章模型"></a>修改文章模型</h2><p>标签是文章Model的属性，因此需要修改文章模型。</p><p>需要注意的是标签引用的不是内置字段，而是库中的<code>TaggableManager</code>，它是处理多对多关系的管理器：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># Django-taggit</span><span class="token keyword">from</span> taggit<span class="token punctuation">.</span>managers <span class="token keyword">import</span> TaggableManager<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 文章标签</span>    tags <span class="token operator">=</span> TaggableManager<span class="token punctuation">(</span>blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后记得<strong>数据迁移</strong>。</p><h2 id="带标签文章的发表"><a href="#带标签文章的发表" class="headerlink" title="带标签文章的发表"></a>带标签文章的发表</h2><p>修改文章的表单类，让其能够提交标签字段：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>forms<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ArticlePostForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        fields <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'body'</span><span class="token punctuation">,</span> <span class="token string">'tags'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后修改发表文章的视图，保存POST中的标签：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">def</span> <span class="token function">article_create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 已有代码</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>        article_post_form <span class="token operator">=</span> ArticlePostForm<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token keyword">if</span> article_post_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            new_article <span class="token operator">=</span> article_post_form<span class="token punctuation">.</span>save<span class="token punctuation">(</span>commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            new_article<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token comment"># 新增代码，保存 tags 的多对多关系</span>            article_post_form<span class="token punctuation">.</span>save_m2m<span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要注意的是，如果提交的表单使用了<code>commit=False</code>选项，则必须调用<code>save_m2m()</code>才能正确的保存标签，就像普通的多对多关系一样。</p><p>最后就是在发表文章的模板中添加标签的表单项了：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/create.html...<span class="token comment">&lt;!-- 提交文章的表单 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    ...        <span class="token comment">&lt;!-- 文章标签 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tags<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>标签<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>                <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control col-3<span class="token punctuation">"</span></span>                <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tags<span class="token punctuation">"</span></span>                <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tags<span class="token punctuation">"</span></span>        <span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行服务器，就可以在发表页面看到效果了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190211/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE162.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190211/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE162.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>多个标签最好用<strong>英文逗号</strong>进行分隔。<strong>中文逗号</strong>有的版本会报错，干脆就不要去使用了。</p><h2 id="列表中显示标签"><a href="#列表中显示标签" class="headerlink" title="列表中显示标签"></a>列表中显示标签</h2><p>虽然保存标签的功能已经实现了，还得把它显示出来才行。</p><p>显示标签最常用的位置是在<strong>文章列表</strong>中，方便用户筛选感兴趣的文章。</p><p>修改文章列表的模板，将标签显示出来：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html...<span class="token comment">&lt;!-- 栏目 --></span>...<span class="token comment">&lt;!-- 标签 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>    &#123;% for tag in article.tags.all %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span>           <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>badge badge-secondary<span class="token punctuation">"</span></span>         <span class="token punctuation">></span></span>            &#123;&#123; tag &#125;&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    &#123;% endfor %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>链接中的<code>class</code>中是Bootstrap定义的<a href="https://getbootstrap.com/docs/4.1/components/badge/">徽章样式</a>。</p><p>插入位置紧靠在栏目按钮的后面。当然你想放到其他位置也是完全可以的。</p><p>刷新列表页面看看效果：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190211/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE164.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190211/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE164.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><h2 id="标签过滤"><a href="#标签过滤" class="headerlink" title="标签过滤"></a>标签过滤</h2><p>有时候用户想搜索带有某一个标签的所有文章，现在就来做这个功能。</p><p>与搜索功能一样，只需要调取数据时用<code>filter()</code>方法过滤结果就可以了。</p><p>修改<code>&lt;a&gt;</code>标签中的<code>href</code>，使其带有<code>tag</code>参数返回到View中：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html...<span class="token comment">&lt;!-- 标签 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>    &#123;% for tag in article.tags.all %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_list<span class="token punctuation">'</span> %&#125;?tag=&#123;&#123; tag &#125;&#125;<span class="token punctuation">"</span></span>           <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>badge badge-secondary<span class="token punctuation">"</span></span>         <span class="token punctuation">></span></span>            &#123;&#123; tag &#125;&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    &#123;% endfor %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在View中取得<code>tag</code>的值，并进行搜索。</p><p>下面的代码将<code>article_list()</code>函数完整写出来了（包括上一章末尾没讲的栏目查询），方便读者比对。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">def</span> <span class="token function">article_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 从 url 中提取查询参数</span>    search <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">)</span>    order <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'order'</span><span class="token punctuation">)</span>    column <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'column'</span><span class="token punctuation">)</span>    tag <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'tag'</span><span class="token punctuation">)</span>    <span class="token comment"># 初始化查询集</span>    article_list <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 搜索查询集</span>    <span class="token keyword">if</span> search<span class="token punctuation">:</span>        article_list <span class="token operator">=</span> article_list<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>            Q<span class="token punctuation">(</span>title__icontains<span class="token operator">=</span>search<span class="token punctuation">)</span> <span class="token operator">|</span>            Q<span class="token punctuation">(</span>body__icontains<span class="token operator">=</span>search<span class="token punctuation">)</span>        <span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        search <span class="token operator">=</span> <span class="token string">''</span>    <span class="token comment"># 栏目查询集</span>    <span class="token keyword">if</span> column <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> column<span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        article_list <span class="token operator">=</span> article_list<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>column<span class="token operator">=</span>column<span class="token punctuation">)</span>    <span class="token comment"># 标签查询集</span>    <span class="token keyword">if</span> tag <span class="token keyword">and</span> tag <span class="token operator">!=</span> <span class="token string">'None'</span><span class="token punctuation">:</span>        article_list <span class="token operator">=</span> article_list<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>tags__name__in<span class="token operator">=</span><span class="token punctuation">[</span>tag<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 查询集排序</span>    <span class="token keyword">if</span> order <span class="token operator">==</span> <span class="token string">'total_views'</span><span class="token punctuation">:</span>        article_list <span class="token operator">=</span> article_list<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-total_views'</span><span class="token punctuation">)</span>    paginator <span class="token operator">=</span> Paginator<span class="token punctuation">(</span>article_list<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page'</span><span class="token punctuation">)</span>    articles <span class="token operator">=</span> paginator<span class="token punctuation">.</span>get_page<span class="token punctuation">(</span>page<span class="token punctuation">)</span>        <span class="token comment"># 需要传递给模板（templates）的对象</span>    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">'articles'</span><span class="token punctuation">:</span> articles<span class="token punctuation">,</span>        <span class="token string">'order'</span><span class="token punctuation">:</span> order<span class="token punctuation">,</span>        <span class="token string">'search'</span><span class="token punctuation">:</span> search<span class="token punctuation">,</span>        <span class="token string">'column'</span><span class="token punctuation">:</span> column<span class="token punctuation">,</span>        <span class="token string">'tag'</span><span class="token punctuation">:</span> tag<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'article/list.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意Django-taggit中<strong>标签过滤</strong>的写法：<code>filter(tags__name__in=[tag])</code>，意思是在<code>tags</code>字段中过滤<code>name</code>为<code>tag</code>的数据条目。赋值的字符串<code>tag</code>用方括号包起来。</p><blockquote><p>之所以这样写是因为Django-taggit还支持多标签的联合查询，比如：</p><p><code>Model.objects.filter(tags__name__in=[&quot;tag1&quot;, &quot;tag2&quot;])</code></p></blockquote><p>为了实现带参数的交叉查询，还要将<strong>翻页</strong>等位置的<code>href</code>修改一下：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html...<span class="token comment">&lt;!-- 所有类似地方加上 tag 参数，如排序、翻页等 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_list<span class="token punctuation">'</span> %&#125;?search=&#123;&#123; search &#125;&#125;&amp;column=&#123;&#123; column &#125;&#125;&amp;tag=&#123;&#123; tag &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    最新<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_list<span class="token punctuation">'</span> %&#125;?order=total_views&amp;search=&#123;&#123; search &#125;&#125;&amp;column=&#123;&#123; column &#125;&#125;&amp;tag=&#123;&#123; tag &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    最热<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?page=1&amp;order=&#123;&#123; order &#125;&#125;&amp;search=&#123;&#123; search &#125;&#125;&amp;column=&#123;&#123; column &#125;&#125;&amp;tag=&#123;&#123; tag &#125;&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token entity named-entity" title="&laquo;">&amp;laquo;</span> 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- 上面3条是举例，其他类似地方也请补充进去 --></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>标签过滤功能就完成了。</p><p>Django-taggit更多的用法请阅读官方文档：<a href="https://django-taggit.readthedocs.io/en/latest/index.html">Django-taggit</a></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章学习了使用Django-taggit来完成标签功能。</p><p>在学习阶段，你可以<strong>不借助他人的轮子，自己实现功能</strong>：瞎折腾对掌握基础有很大帮助。</p><p>实际开发时，又分为两种情况：</p><ul><li><strong>浅层需求某项通用功能，开发完成后改动不大</strong>：此类功能建议尽量使用轮子，加快开发效率。人生苦短，能节约的时间，一秒钟都不要浪费。</li><li><strong>需要大量定制化的功能，开发完成后需要频繁改动</strong>：此类功能因为经常对底层代码进行改动，与其在别人的代码上修修补补，还不如自己从头写了。自己的代码不仅熟悉，而且都是为定制化而生的。</li></ul><p>到底如何选择，就根据你的喜欢进行斟酌了。</p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#117;&#115;&#x61;&#x69;&#112;&#104;&#x6f;&#116;&#111;&#64;&#x66;&#x6f;&#120;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#99;&#111;&#x6d;">&#x64;&#117;&#115;&#x61;&#x69;&#112;&#104;&#x6f;&#116;&#111;&#64;&#x66;&#x6f;&#120;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#99;&#111;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--30.富文本编辑器</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/30.fu-wen-ben-bian-ji-qi/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/30.fu-wen-ben-bian-ji-qi/</url>
      
        <content type="html"><![CDATA[<p>前面我们已经实现了用Markdown语法写文章了。但是文章的评论用Markdown就不太合适了，你不能强求用户也花时间去熟悉语法啊。另外评论中通常还有表情、带颜色的字体等功能，这些也是Markdown不具备的。</p><p>因此富文本编辑器<a href="https://github.com/django-ckeditor/django-ckeditor">Django-ckeditor</a>就派上用场了。</p><h2 id="在后台使用Ckeditor"><a href="#在后台使用Ckeditor" class="headerlink" title="在后台使用Ckeditor"></a>在后台使用Ckeditor</h2><p>在<strong>虚拟环境</strong>中安装django-ckeditor：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> pip <span class="token function">install</span> django-ckeditor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装成功后还是老规矩，在<code>settings.py</code>中注册app：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token string">'ckeditor'</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来需要修改模型了。用django-ckeditor库自己的富文本字段<code>RichTextField</code>替换普通的文本字段<code>TextField</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># django-ckeditor</span><span class="token keyword">from</span> ckeditor<span class="token punctuation">.</span>fields <span class="token keyword">import</span> RichTextField<span class="token keyword">class</span> <span class="token class-name">Comment</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 之前为 body = models.TextField()</span>    body <span class="token operator">=</span> RichTextField<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>记得每次修改模型后要<strong>迁移数据</strong>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage.py makemigrations<span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage.py migrate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>为方便测试，修改<code>comment/admin.py</code>文件，将评论模块注册到后台中：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>admin<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Commentadmin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Comment<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动服务器，进入后台的评论页面，发现已经可以使用django-ckeditor了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE178.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE178.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>功能相当齐全，字体、字号、颜色、链接、表情应有尽有。</p><p>如果我只需要部分功能怎么办呢？比如<strong>插入flash动画</strong>基本就用不到。另外似乎也没看到<strong>插入代码块</strong>的功能。</p><p><code>ckeditor</code>允许你在<code>settings.py</code>中进行自定义配置：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>CKEDITOR_CONFIGS <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token comment"># django-ckeditor默认使用default配置</span>    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token comment"># 编辑器宽度自适应</span>        <span class="token string">'width'</span><span class="token punctuation">:</span><span class="token string">'auto'</span><span class="token punctuation">,</span>        <span class="token string">'height'</span><span class="token punctuation">:</span><span class="token string">'250px'</span><span class="token punctuation">,</span>        <span class="token comment"># tab键转换空格数</span>        <span class="token string">'tabSpaces'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>        <span class="token comment"># 工具栏风格</span>        <span class="token string">'toolbar'</span><span class="token punctuation">:</span> <span class="token string">'Custom'</span><span class="token punctuation">,</span>        <span class="token comment"># 工具栏按钮</span>        <span class="token string">'toolbar_Custom'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token comment"># 表情 代码块</span>            <span class="token punctuation">[</span><span class="token string">'Smiley'</span><span class="token punctuation">,</span> <span class="token string">'CodeSnippet'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token comment"># 字体风格</span>            <span class="token punctuation">[</span><span class="token string">'Bold'</span><span class="token punctuation">,</span> <span class="token string">'Italic'</span><span class="token punctuation">,</span> <span class="token string">'Underline'</span><span class="token punctuation">,</span> <span class="token string">'RemoveFormat'</span><span class="token punctuation">,</span> <span class="token string">'Blockquote'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token comment"># 字体颜色</span>            <span class="token punctuation">[</span><span class="token string">'TextColor'</span><span class="token punctuation">,</span> <span class="token string">'BGColor'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token comment"># 链接</span>            <span class="token punctuation">[</span><span class="token string">'Link'</span><span class="token punctuation">,</span> <span class="token string">'Unlink'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token comment"># 列表</span>            <span class="token punctuation">[</span><span class="token string">'NumberedList'</span><span class="token punctuation">,</span> <span class="token string">'BulletedList'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token comment"># 最大化</span>            <span class="token punctuation">[</span><span class="token string">'Maximize'</span><span class="token punctuation">]</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment"># 加入代码块插件</span>        <span class="token string">'extraPlugins'</span><span class="token punctuation">:</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'codesnippet'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在<code>toolbar_Custom</code>中定义需要使用的功能模块；没列出的功能就不再显示了。代码块功能是编辑器自带的插件，需要在<code>extraPlugins</code>中指定使用。效果如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE180.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE180.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>编辑富文本搞定后，还需要在前台界面中展示出来。富文本是以类似<code>html</code>的格式进行保存的，因此还要在展示评论的代码加入<code>|safe</code>过滤器，防止浏览器进行转义。</p><p>修改<code>detail.html</code>中展示评论的部分代码：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token comment">&lt;!-- 显示评论 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">></span></span>共有&#123;&#123; comments.count &#125;&#125;条评论<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>    &#123;% for comment in comments %&#125;        ...        <span class="token comment">&lt;!-- 修改这里 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>&#123;&#123; comment.body|safe &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    &#123;% endfor %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>进入文章详情页面看看效果：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE181.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE181.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><h2 id="代码高亮"><a href="#代码高亮" class="headerlink" title="代码高亮"></a>代码高亮</h2><p>代码高亮需要添加额外的插件<strong>Prism</strong>。在<a href="https://ckeditor.com/cke4/addon/prism">Prism</a>插件官方页面下载（也可以点击<a href="https://download.ckeditor.com/prism/releases/prism_1.0.1.zip">这里</a>直接下载）后，将解压出来的<code>prism</code>放到静态文件目录 <code>static\ckeditor\ckeditor\plugins\prism</code> 中。</p><blockquote><p>也可以将其放到 <code>env\Lib\site-packages\ckeditor\static\ckeditor\ckeditor\plugins</code> 目录，<strong>env</strong>是你创建的虚拟环境的目录。之前你安装的所有库都在这个env目录中的。不推荐。</p></blockquote><p>然后在<a href="https://prismjs.com/download.html#themes=prism-okaidia&languages=markup+css+clike+javascript+python&plugins=line-numbers">Prism官网</a>选择主题：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE185_%E6%8B%B7%E8%B4%9D.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE185_%E6%8B%B7%E8%B4%9D.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><ul><li>根据喜好选择一个喜欢的主题</li><li>然后选择需要高亮的语言。不清楚就可以全选</li><li>勾选行号插件</li><li>最后点击<code>DOWNLOAD CSS</code>下载样式</li></ul><p>在<code>static</code>目录中新建<code>prism</code>目录，将下载好的CSS文件放进去。</p><blockquote><p>注意这里的static是项目中的静态文件目录（与前面的章节相同），而不是env文件夹中的static目录。</p></blockquote><p>然后在需要代码高亮的<strong>模板文件</strong>中引用prism的静态文件，对代码进行渲染：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>ckeditor/ckeditor/plugins/prism/lib/prism/prism_patched.min.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>prism/prism.css<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将<strong>Prism</strong>、<strong>widget</strong>、<strong>lineutils</strong>插件添加到配置文件中。后面两个编辑器自带，不用单独下载，添上就可以了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>CKEDITOR_CONFIGS <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 添加 Prism 相关插件</span>        <span class="token string">'extraPlugins'</span><span class="token punctuation">:</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'codesnippet'</span><span class="token punctuation">,</span> <span class="token string">'prism'</span><span class="token punctuation">,</span> <span class="token string">'widget'</span><span class="token punctuation">,</span> <span class="token string">'lineutils'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样就完成了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE184.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE184.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>代码高亮效果不错！</p><h2 id="在前台使用Ckeditor"><a href="#在前台使用Ckeditor" class="headerlink" title="在前台使用Ckeditor"></a>在前台使用Ckeditor</h2><p>为了让用户在前台也能使用富文本编辑器，还得对代码稍加改动。</p><p>首先需要把评论的表单传递到文章详情页面中。因此修改<code>article_detail</code>视图：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 引入评论表单</span><span class="token keyword">from</span> comment<span class="token punctuation">.</span>forms <span class="token keyword">import</span> CommentForm<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 文章详情</span><span class="token keyword">def</span> <span class="token function">article_detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 引入评论表单</span>    comment_form <span class="token operator">=</span> CommentForm<span class="token punctuation">(</span><span class="token punctuation">)</span>    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span>         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token string">'comment_form'</span><span class="token punctuation">:</span> comment_form<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后将<code>detail.html</code>原来评论表单中的正文部分（即前面章节写的<code>&lt;textarea&gt;</code>）替换如下：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token comment">&lt;!-- 发表评论 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">...</span><span class="token punctuation">></span></span>&#123;% csrf_token %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 将之前的&lt;textarea>替换掉 --></span>        <span class="token comment">&lt;!-- &lt;textarea type="text"                        class="form-control"                        id="body"                        name="body"                        rows="2">&lt;/textarea>  --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>            &#123;&#123; comment_form.media &#125;&#125;            &#123;&#123; comment_form.body &#125;&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 提交按钮 --></span>    ...                   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中的<code>comment_form.media</code>是编辑器自身的渲染代码，<code>comment_form.body</code>则是评论正文字段。</p><p>看看效果：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE188.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE188.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>不错，编辑器已经可以正常使用了，但还有一个小问题：似乎编辑器宽度没有自适应，右边大片白白的空间也太浪费了。继续努力。</p><h2 id="宽度自适应"><a href="#宽度自适应" class="headerlink" title="宽度自适应"></a>宽度自适应</h2><p>首先在配置文件中将宽度设置为<code>auto</code>，这一步我们已经做好了。</p><p>Ckeditor编辑器本身有一个<code>inline-block</code>的样式，阻碍了自适应效果，需要用<code>Jquery</code>语法将其清除掉。在详情页面底部加入代码：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html<span class="token comment">&lt;!-- 注意这是错误的示范！ --></span>...<span class="token comment">&lt;!-- 新增代码 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".django-ckeditor-widget"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAttr</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- 这个已经有了 --></span>&#123;% endblock content %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>$</code>符号代表Jquery语句。这句的意思是：找到页面中<code>class=&#39;django-ckeditor-widget&#39;</code>的容器，然后删除这个容器的<code>style</code>属性。</p><p><strong>看似没什么问题，然而Bug藏在细节中</strong>。注意这是个Jquery语句，那么就要求运行之前先载入<code>Jquery.js</code>。然而在渲染页面时，包含<code>$</code>语句的<code>&#123;% block content %&#125;</code>会插入到<code>base.html</code>模板的<code>Jquery.js</code>标签的前面，导致语句不会生效，并且控制台会报出<code>$ is not defined</code>的错误。</p><blockquote><p>比较容易想到的办法是将引入Jquery.js的标签提到更顶部的位置，在block模板插入前就加载。这样做的问题是JS文件加载通常较慢，它会阻塞后面的代码，从而减缓页面整体加载速度。本文不采用这种办法。</p></blockquote><p>解决方案是在<code>base.html</code>中新增专门用于拼接<code>JavaScript</code>脚本的位置，命名为<code>&#123;% block script %&#125;</code>。注意它必须放置在<code>Jquery</code>标签的后面：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/base.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    ...    <span class="token comment">&lt;!-- 已有代码 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>jquery/jquery-3.3.1.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    ...    <span class="token comment">&lt;!-- 新增代码 --></span>    &#123;% block script %&#125;&#123;% endblock script %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后将<code>detail.html</code>中的JS代码放到这个块中：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...&#123;% block script %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".django-ckeditor-widget"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAttr</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>&#123;% endblock script %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这种方法可以灵活的定义JS脚本的运行顺序，并且代码看起来更加整洁。推荐所有的JS代码都采取这种方法插入。</p><p>刷新页面，编辑器就能够宽度自适应了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE182.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE182.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>发表含有代码块的评论，详情页面的显示如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE183.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190321/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE183.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>现在，博文和其评论都可以漂亮的排版了。对于有些不喜欢Markdown的人来说，甚至可以连博文都使用<code>django-cdeditor</code>提供的富文本编辑器。我自己还是倾向用Markdown写文章：写作效率比好看更重要，并且主流网站几乎都支持Markdown，多平台发稿很方便。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#x75;&#x73;&#x61;&#x69;&#112;&#x68;&#x6f;&#116;&#111;&#64;&#x66;&#111;&#x78;&#x6d;&#x61;&#x69;&#108;&#x2e;&#x63;&#111;&#x6d;">&#100;&#x75;&#x73;&#x61;&#x69;&#112;&#x68;&#x6f;&#116;&#111;&#64;&#x66;&#111;&#x78;&#x6d;&#x61;&#x69;&#108;&#x2e;&#x63;&#111;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><blockquote><p>感谢<a href="http://www.aaron-zhao.com/post/1/">Aaron Zhao 的个人博客</a>提供了本文的参考。博主还讲解了django-ckeditor上传图片的设置，有兴趣可以前往了解。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--29.文章标题图</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/29.wen-zhang-biao-ti-tu/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/29.wen-zhang-biao-ti-tu/</url>
      
        <content type="html"><![CDATA[<p>现在虽然博客的功能大都实现了，但是界面还是比较朴素，特别是首页的文章列表几乎全是文字，看多了难免疲劳。因此，给每个文章标题配一张<strong>标题图</strong>，不仅美观，用户也能通过图片快速了解文章内容。实际上大部分社交网站也都是这么干的，毕竟人的天性就是懒，能看图就坚决不看字。</p><p>在<a href="https://www.dusaiphoto.com/article/detail/38/">上传用户头像</a>章节中，我们已经接触过上传、展示图片了。标题图的实现也差不多，不同的是本章会更近一步，<strong>对图片进行缩放</strong>等处理，使页面整洁美观、并且高效。</p><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>与用户头像类似，标题图是属于每篇博文自己的“资产”，因此需要<strong>修改model</strong>，新建一个字段：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 文章标题图</span>    avatar <span class="token operator">=</span> models<span class="token punctuation">.</span>ImageField<span class="token punctuation">(</span>upload_to<span class="token operator">=</span><span class="token string">'article/%Y%m%d/'</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意上传地址中的<code>%Y%m%d</code>是日期格式化的写法。比如上传时间是2019年2月26日，则标题图会上传到<code>media/article/20190226</code>这个目录中。</p><p>记得<strong>数据迁移</strong>。</p><p>标题图通常在创建新文章的时候就设置好了，而新文章是通过表单上传到数据库中的。因此接下来就是<strong>修改发表文章的表单类</strong>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>forms<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ArticlePostForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        fields <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'body'</span><span class="token punctuation">,</span> <span class="token string">'tags'</span><span class="token punctuation">,</span> <span class="token string">'avatar'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>增加了<code>avatar</code>字段而已，没有新内容。</p><p>下一步就是<strong>修改视图</strong>。因为POST的表单中包含了图片文件，所以要将<code>request.FILES</code>也一并绑定到表单类中，否则图片无法正确保存：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">def</span> <span class="token function">article_create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>        <span class="token comment"># 增加 request.FILES</span>        article_post_form <span class="token operator">=</span> ArticlePostForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> request<span class="token punctuation">.</span>FILES<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>很好，功能差不多已经通了，接下来就是对图片进行处理。</p><h2 id="处理图片"><a href="#处理图片" class="headerlink" title="处理图片"></a>处理图片</h2><p>写代码之前先构思一下需要进行怎样的处理：</p><ul><li>标题图对画质没有太高的要求，因此需要<strong>缩小图片的体积</strong>，以便提高网页的加载速度。</li><li>其次还需要对图片的长宽进行规范化。我比较喜欢将图片的<strong>宽度设置得相同</strong>，这样标题可以比较整齐。</li></ul><p>下一个问题是，代码应该写到什么地方呢？似乎在<strong>model</strong>、<strong>form</strong>或者<strong>view</strong>里处理图片都可以。在这里我打算把代码写到<strong>model</strong>中去，这样不管你在任何地方上传图片（包括后台中！），图片都会得到处理。</p><p>想好之后，就要行动了。还记得Pillow这个库吗，我们很早就把它安装好了，现在是使用它的时候了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 记得导入！</span><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 前面写好的代码</span>    avatar <span class="token operator">=</span> models<span class="token punctuation">.</span>ImageField<span class="token punctuation">(</span>upload_to<span class="token operator">=</span><span class="token string">'article/%Y%m%d/'</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token comment"># 保存时处理图片</span>    <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 调用原有的 save() 的功能</span>        article <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>ArticlePost<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        <span class="token comment"># 固定宽度缩放图片大小</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>avatar <span class="token keyword">and</span> <span class="token keyword">not</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'update_fields'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>avatar<span class="token punctuation">)</span>            <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">=</span> image<span class="token punctuation">.</span>size            new_x <span class="token operator">=</span> <span class="token number">400</span>            new_y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>new_x <span class="token operator">*</span> <span class="token punctuation">(</span>y <span class="token operator">/</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>            resized_image <span class="token operator">=</span> image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> new_y<span class="token punctuation">)</span><span class="token punctuation">,</span> Image<span class="token punctuation">.</span>ANTIALIAS<span class="token punctuation">)</span>            resized_image<span class="token punctuation">.</span>save<span class="token punctuation">(</span>self<span class="token punctuation">.</span>avatar<span class="token punctuation">.</span>path<span class="token punctuation">)</span>        <span class="token keyword">return</span> article    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>代码不多，但是有很多细节，值得仔细推敲。</strong>不急，一行一行来：</p><ul><li><p><code>save()</code>是model内置的方法，它会在model实例每次保存时调用。这里改写它，将处理图片的逻辑“塞进去”。</p></li><li><p><code>super(ArticlePost, self).save(*args, **kwargs)</code>的作用是调用父类中原有的<code>save()</code>方法，即将model中的字段数据保存到数据库中。因为图片处理是基于已经保存的图片的，所以<strong>这句一定要在处理图片之前执行</strong>，否则会得到找不到原始图片的错误。</p></li><li><p>博文的标题图不是必须的，<code>if</code>中的<code>self.avatar</code>剔除掉没有标题图的文章，这些文章不需要处理图片。</p></li><li><p>不太好理解的是<code>if</code>中的这个<code>not kwargs.get(&#39;update_fields&#39;)</code>。还记得<code>article_detail()</code>视图中为了统计浏览量而调用了<code>save(update_fields=[&#39;total_views&#39;])</code>吗？没错，就是为了排除掉统计浏览量调用的<code>save()</code>，免得每次用户进入文章详情页面都要处理标题图，太影响性能了。</p><blockquote><p>这种判断方法虽然简单，但会造成模型和视图的紧耦合。读者在实践中可探索更优雅的方法，比如专门设置一个参数，用来判断是哪类视图调用了save()。</p></blockquote></li><li><p>接下来都是Pillow处理图片的流程了：打开原始图片，取得分辨率，将新图片的宽度设置为400并根据比例缩小高度，最后用新图片将原始图片覆盖掉。<code>Image.ANTIALIAS</code>表示缩放采用平滑滤波。</p></li><li><p>最后一步，将父类<code>save()</code>返回的结果原封不动的返回去。</p></li></ul><p>完美！</p><h2 id="模板与测试"><a href="#模板与测试" class="headerlink" title="模板与测试"></a>模板与测试</h2><p>剩下的工作就比较简单了。</p><p>修改<strong>发表文章的模板</strong>，让表单能够上传图片：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/create.html...<span class="token comment">&lt;!-- 记得增加 enctype ！ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">...</span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    ...    <span class="token comment">&lt;!-- 文章标题图 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>标题图<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control-file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后<strong>修改文章列表模板</strong>，让其能够展现标题图。</p><p>为了美观，这里稍微改动了列表循环的整体结构：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html...<span class="token comment">&lt;!-- 列表循环 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row mt-2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    &#123;% for article in articles %&#125;        <span class="token comment">&lt;!-- 标题图 --></span>        &#123;% if article.avatar %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; article.avatar.url &#125;&#125;<span class="token punctuation">"</span></span>                      <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span>                      <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">max-width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span> <span class="token property">border-radius</span><span class="token punctuation">:</span> 20px</span><span class="token punctuation">"</span></span></span>                <span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        &#123;% endif %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token comment">&lt;!-- 栏目 --></span>            ...            <span class="token comment">&lt;!-- 标签 --></span>            ...            ...                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">/></span></span>    &#123;% endfor %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来又是喜闻乐见的测试环节。</p><p>启动服务器，打开发表文章页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190226/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE173.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190226/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE173.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>选择几张分辨率各不相同的图片作为标题图，</p><p>发表几篇文章并回到文章列表页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190226/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE175.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190226/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE175.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>看起来似乎不错。</p><p>查看一下media目录下实际保存的图片：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190226/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE176.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190226/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE176.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>确实保存到想要的目录下，并且左下角显示图片的宽度全都为400了。</p><h2 id="扫尾工作"><a href="#扫尾工作" class="headerlink" title="扫尾工作"></a>扫尾工作</h2><p>功能已经实现了，但还有扫尾工作需要去做：</p><ul><li><p>需要对上传的图片做更多的验证工作，比如上传的文件是否为图片、分辨率是否满足要求。虽然在个人博客项目中这些验证并不是特别重要，但在其他项目中就说不好了：谁知道用户会上传些什么奇奇怪怪的东西？</p></li><li><p>编辑文章、删除文章也同样需要处理上传的图片。你还可以将缩放分辨率的技术应用到用户头像上，比如裁剪成方形。</p><blockquote><p>注意：删除数据库中的avatar条目只是断开了数据表和图片的链接而已，实际上图片还保存在原来的位置。要彻底删除图片，你还得写操作系统文件的代码才行。</p></blockquote></li></ul><p>怎么实现这些功能就不赘述了，留给读者自己去折腾吧。</p><h2 id="编辑文章"><a href="#编辑文章" class="headerlink" title="编辑文章"></a>编辑文章</h2><blockquote><p>2019/06/24 新增本节</p></blockquote><p>有不少读者在将<strong>标题图</strong>和<strong>标签</strong>功能添加到<strong>编辑文章</strong>页面时遇到了困难，所以提示一下如何实现。</p><p>其实大家的思路是没错的，编辑和创建差不太多，唯一区别是编辑功能还需要把旧的数据给展现出来。关键是要注意几个问题：</p><ul><li><strong>标题图</strong>是文件，你应该在<code>request.FILES</code>里获取它，而不是<code>request.POST</code></li><li><strong>tags</strong>不是普通的字段，<code>article.tags</code>是取不到值的，你应该用<a href="https://django-taggit.readthedocs.io/en/latest/api.html">官方文档</a>给的<strong>接口</strong>去获取、设置数据</li></ul><p>所以<strong>视图相关代码</strong>应该这样写：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token comment"># 更新文章</span><span class="token decorator annotation punctuation">@login_required</span><span class="token punctuation">(</span>login_url<span class="token operator">=</span><span class="token string">'/userprofile/login/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">article_update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">if</span> article_post_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token keyword">if</span> request<span class="token punctuation">.</span>FILES<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'avatar'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                article<span class="token punctuation">.</span>avatar <span class="token operator">=</span> request<span class="token punctuation">.</span>FILES<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'avatar'</span><span class="token punctuation">)</span>            article<span class="token punctuation">.</span>tags<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token operator">*</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'tags'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clear<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>            article<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span>             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token string">'tags'</span><span class="token punctuation">:</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> article<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>tags.set()</code>和<code>tags.names()</code>就是库提供的接口了，分别用于更新数据和获取标签名。注意<code>tags.set()</code>是如何将序列分隔并解包的。</li><li>渲染空表单时用到了列表生成器将数据转换为字符串。</li></ul><p><strong>模板相关代码：</strong></p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/update.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    &#123;% csrf_token %&#125;    ...    <span class="token comment">&lt;!-- 文章标题图 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>标题图<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control-file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 文章标签--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tags<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>标签<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control col-3<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tags<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tags<span class="token punctuation">"</span></span>            <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; tags &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>enctype=&quot;multipart/form-data&quot;</code>这个属性的意思是表单提交时不对字符编码。表单里带有文件时，一定要加上它。</p><p>核心代码大概就这样，我的<a href="https://github.com/stacklens/django_blog_tutorial">GitHub仓库master分支</a>更新了此部分的完整代码，提供给大家参考。</p><p>此外还有些细节问题可以优化，读者就自己去试试看吧！</p><h2 id="轮子"><a href="#轮子" class="headerlink" title="轮子"></a>轮子</h2><p>虽然本文是自己动手写的代码（严格说来Pillow也是轮子），但想必你也猜到了，还有更加智能的轮子：<a href="https://github.com/matthewwithanm/django-imagekit">django-imagekit</a>，这个库可以直接集成到model里面，比如这样：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token comment"># 引入imagekit</span><span class="token keyword">from</span> imagekit<span class="token punctuation">.</span>models <span class="token keyword">import</span> ProcessedImageField<span class="token keyword">from</span> imagekit<span class="token punctuation">.</span>processors <span class="token keyword">import</span> ResizeToFit<span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        avatar <span class="token operator">=</span> ProcessedImageField<span class="token punctuation">(</span>        upload_to<span class="token operator">=</span><span class="token string">'article/%Y%m%d'</span><span class="token punctuation">,</span>        processors<span class="token operator">=</span><span class="token punctuation">[</span>ResizeToFit<span class="token punctuation">(</span>width<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'JPEG'</span><span class="token punctuation">,</span>        options<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'quality'</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>字段中定义好了上传位置、处理规则、存储格式以及图片质量，你不需要写任何处理图片的代码了。</p><p>更多的用法见<a href="https://github.com/matthewwithanm/django-imagekit">官方介绍</a>。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章学习了如何上传并处理文章的标题图，从此博客首页就有了漂亮的外观。</p><p>需要指出的是，个人博客所采用的服务器通常性能不佳，用来保存文章缩略图等小尺寸的图片倒还好，但是<strong>千万不要存储大尺寸的图片文件</strong>，否则用户等待几分钟都刷不开你的图片，那是很悲剧的。</p><p>因此建议你将大尺寸的图片、视频等放到专业的云对象存储服务商中，比如<a href="https://www.qiniu.com/">七牛云</a>、<a href="https://www.upyun.com/">又拍云</a>等，在你存储量很小时（10G以内）是花不了多少钱的。</p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#x75;&#115;&#97;&#x69;&#112;&#104;&#x6f;&#x74;&#111;&#x40;&#102;&#x6f;&#120;&#x6d;&#97;&#x69;&#x6c;&#x2e;&#99;&#111;&#x6d;">&#x64;&#x75;&#115;&#97;&#x69;&#112;&#104;&#x6f;&#x74;&#111;&#x40;&#102;&#x6f;&#120;&#x6d;&#97;&#x69;&#x6c;&#x2e;&#99;&#111;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--31.四个重要的小功能</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/31.si-ge-chong-yao-de-xiao-gong-neng/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/31.si-ge-chong-yao-de-xiao-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>本章集中介绍四个重要的小功能：<strong>回到顶部浮动按钮</strong>、<strong>矢量图标</strong>、<strong>页脚沉底</strong>和<strong>粘性侧边栏</strong>。</p><p>这几个功能与Django基本没啥关系，更多的是前端知识，但是对博客网站都很重要，问的读者也比较多，因此也集中讲一下好了。</p><h2 id="回到顶部浮动按钮"><a href="#回到顶部浮动按钮" class="headerlink" title="回到顶部浮动按钮"></a>回到顶部浮动按钮</h2><p>当用户拜读完你的博文后，可能想回到文章开头重新阅读，或者审视其中的某些内容。如果文章内容较多，不停滑动滚轮回页面顶部未免有点太让人烦躁了。</p><p>一种解决办法是增加一个<strong>回到顶部的浮动按钮</strong>。当页面向下滚动到某个位置后，按钮就呈现在页面右下角；点击按钮，页面就回到顶部。这个功能 Bootstrap 4 似乎没有提供，但也不复杂，就自己用 JavaScript 和 CSS 写吧。</p><p>在<code>templates</code>目录新建<code>back_to_top_func.html</code>文件，写入以下代码：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/back_to_top_func.html<span class="token comment">&lt;!-- 参考了 鹦鹉 的代码，在此致谢 --></span><span class="token comment">&lt;!-- https://ezbox.idv.tw/131/back-to-top-button-without-images --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BackTop<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>toTop-arrow<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">z-index</span><span class="token punctuation">:</span> 100<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token comment">// 向上滚动的函数</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#BackTop'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'html,body'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">animate</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>scrollTop<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scroll</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scrollTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#BackTop'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fadeIn</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#BackTop'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fadeOut</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">    <span class="token comment">/* 按钮边框的大小、位置、样式 */</span>    <span class="token selector">.toTop-arrow</span> <span class="token punctuation">&#123;</span>        <span class="token property">width</span><span class="token punctuation">:</span> 3.5rem<span class="token punctuation">;</span>        <span class="token property">height</span><span class="token punctuation">:</span> 3.5rem<span class="token punctuation">;</span>        <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>        <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>        <span class="token property">border</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>        <span class="token property">border-radius</span><span class="token punctuation">:</span> 33%<span class="token punctuation">;</span>        <span class="token property">opacity</span><span class="token punctuation">:</span> 0.7<span class="token punctuation">;</span>        <span class="token property">background</span><span class="token punctuation">:</span> black<span class="token punctuation">;</span>        <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>        <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>        <span class="token property">right</span><span class="token punctuation">:</span> 1.5rem<span class="token punctuation">;</span>        <span class="token property">bottom</span><span class="token punctuation">:</span> 1.5rem<span class="token punctuation">;</span>        <span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/* 绘制按钮中的向上箭头 */</span>    <span class="token selector">.toTop-arrow::before, .toTop-arrow::after</span> <span class="token punctuation">&#123;</span>        <span class="token property">width</span><span class="token punctuation">:</span> 31px<span class="token punctuation">;</span>        <span class="token property">height</span><span class="token punctuation">:</span> 7px<span class="token punctuation">;</span>        <span class="token property">border-radius</span><span class="token punctuation">:</span> 3px<span class="token punctuation">;</span>        <span class="token property">background</span><span class="token punctuation">:</span> orange<span class="token punctuation">;</span>        <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>        <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token selector">.toTop-arrow::before</span> <span class="token punctuation">&#123;</span>        <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>-45deg<span class="token punctuation">)</span> <span class="token function">translate</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> -50%<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token property">left</span><span class="token punctuation">:</span> 0.4rem<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token selector">.toTop-arrow::after</span> <span class="token punctuation">&#123;</span>        <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span>45deg<span class="token punctuation">)</span> <span class="token function">translate</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> -50%<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token property">right</span><span class="token punctuation">:</span> 0.4rem<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/* 取消点击按钮时的聚焦 */</span>    <span class="token selector">.toTop-arrow:focus</span> <span class="token punctuation">&#123;</span>        <span class="token property">outline</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码分成<code>html</code>、<code>javascript</code>、<code>css</code>三部分。</p><p><strong>HTML</strong>部分只有一行，用<strong>button</strong>标签表示了浮动按钮的容器。</p><p><strong>JavaScript</strong>部分主要用到了<strong>Jquery</strong>的语法。页面加载完成后开始监听两个事件：</p><ul><li>当用户点击浮动按钮时，将页面滚动到顶部</li><li>当页面滚动时，根据页面距离顶部的距离，决定按钮显示或隐藏</li></ul><p><strong>CSS</strong>部分最长但也很简单，主要定义了按钮的位置、大小、图案等样式。读者可以试着、改动、删除部分代码，看看按钮形态会怎样变化。</p><p>核心代码就写好了。有点小瑕疵的是前面在<code>footer.html</code>中定义了<code>class=&quot;fixed-bottom&quot;</code>，这个属性的显示层级很高，会将浮动按钮给覆盖掉。因此删除<code>templates/footer.html</code>中的<code>fixed-bottom</code>属性：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/footer.html...<span class="token comment">&lt;!-- 删除了 fixed-bottom 属性 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>footer</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>py-3 bg-dark<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>footer</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>z-index这个css样式决定了页面中容器的显示顺序，数值越大则显示优先级越高。</p><p>之所以fixed-bottom会覆盖掉浮动按钮，就是因为它将z-index设置成了一个很大的数值。</p></blockquote><p>因为我们想在全站都拥有这个按钮，所以将刚写好的模块引用到<code>base.html</code>中：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/base.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    ...    <span class="token comment">&lt;!-- jquery.js --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>jquery/jquery-3.3.1.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    ...    <span class="token comment">&lt;!-- 在jquery后面引入 --></span>    &#123;% include 'back_to_top_func.html' %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意模块用到了<strong>Jquery</strong>，因此要在Jquery后面引入。</p><p>效果如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE192.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE192.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击按钮后，页面滚回到顶部。</p><h2 id="矢量图标"><a href="#矢量图标" class="headerlink" title="矢量图标"></a>矢量图标</h2><p>与老版本不同，Bootstrap 4 中也没有自带图标。作为补偿，官方也推荐了几款强大且免费的第三方<strong>矢量图标</strong>提供商。我比较喜欢的是<a href="https://fontawesome.com/">Font Awesome</a>，提供1500+免费图标（以及5000+付费图标），完全够用了。各种你想得到想不到的图标都有：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE193.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE193.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>用法也很简单，你甚至不用将其下载到本地（当然想下载也可以）。根据官网的提示，直接在<code>base.html</code>中引入：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/base.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span>       <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://use.fontawesome.com/releases/v5.8.1/css/all.css<span class="token punctuation">"</span></span>       <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf<span class="token punctuation">"</span></span>       <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在页面中插入某个图标的标签就可以用了。</p><p>首先在<a href="https://fontawesome.com/icons?d=gallery">官网图标库</a>搜索想要的图标，比如<code>eye</code>：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE194.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE194.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击图标进去后就能看到它的<strong>标签名称</strong>：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE195.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE195.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>将此标签名称复制到你的网页中，图标就渲染出来了。</p><p>很神奇的是，矢量图标跟普通的字体是完全类似的，你可以通过CSS定义图标的颜色（<code>color</code>）、大小（<code>font-size</code>）等样式。</p><p>尝试一下。将图标代码添加到<code>templates/article/list.html</code>中的列表循环：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/list.html...<span class="token comment">&lt;!-- 注脚 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 附加信息，增加了图标 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fas fa-eye<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> lightskyblue<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>        &#123;&#123; article.total_views &#125;&#125;<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fas fa-comments<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> yellowgreen<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- 修改为评论的计数 --></span>        &#123;&#123; article.comments.count &#125;&#125;<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fas fa-clock<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> pink<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>        &#123;&#123; article.created|date:'Y-m-d' &#125;&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看看效果：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE196.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE196.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>好玩吧。读者朋友慢慢挑选心仪的图标，到自己的博客中吧。</p><p>相比写代码来说，这是个相当愉悦的过程。</p><h2 id="页脚沉底"><a href="#页脚沉底" class="headerlink" title="页脚沉底"></a>页脚沉底</h2><p>刚才做浮动按钮时，取消了页脚固定在底部的<code>fixed-bottom</code>。</p><p>按钮倒是没被遮盖了，但又冒出来另一个烦人的问题，请看下图：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE197.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE197.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>当页面内容较少时，页脚下方居然空出来一大块地方，太丑了。</p><blockquote><p><a href="https://css-tricks.com/couple-takes-sticky-footer/">《Sticky Footer, Five Ways》</a>罗列了5种方法解决这个问题，有兴趣的同学可深入了解。</p></blockquote><p>需要修改<code>base.html</code>和<code>footer.html</code>两个文件。先贴改动代码：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/base.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    &#123;% include 'header.html' %&#125;        <span class="token comment">&lt;!-- 新增两个 div 容器 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        &#123;% block content %&#125;&#123;% endblock content %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>push<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    &#123;% include 'footer.html' %&#125;    ...        <span class="token comment">&lt;!-- 增加样式 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">        <span class="token selector">html, body</span> <span class="token punctuation">&#123;</span>            <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>            <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">#wrapper</span> <span class="token punctuation">&#123;</span>            <span class="token property">min-height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>            <span class="token property">margin-bottom</span><span class="token punctuation">:</span> -60px<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">#footer,        #push</span> <span class="token punctuation">&#123;</span>            <span class="token property">height</span><span class="token punctuation">:</span> 60px<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/footer.html...<span class="token comment">&lt;!-- 增加 id="footer" 属性 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>footer</span> <span class="token attr-name">...</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>footer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>footer</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码通过CSS样式控制页面尺寸不小于屏幕的高度，以及页脚的高度为60px。不太好理解的主要有两个地方：</p><ul><li><code>#push</code>容器留出一段与页脚等高的空隙，避免正文内容与页脚重叠。</li><li><code>#wrapper</code>容器的底部有一个负边距，作用是给页脚容器让出位置。这个负边距你不设置也可以，无非就是底部多出高度为<code>60px</code>的空白罢了。</li></ul><p>刷新页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE198.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE198.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>舒服了。</p><blockquote><p>随着项目逐渐增大，HTML、JavaScript、CSS交织在一起，也更加混乱。</p><p>虽然教程没有把这三种类型的代码分离开，但是你应该考虑这样做。</p></blockquote><h2 id="粘性侧边栏"><a href="#粘性侧边栏" class="headerlink" title="粘性侧边栏"></a>粘性侧边栏</h2><p>目前教程将<strong>文章目录</strong>放置在文章的右侧，这就是相当于是个侧边栏。问题是当用户向下阅读文章时，目录却不会固定在页面中，而是几下就翻得没影了，影响体验。</p><p><strong>粘性侧边栏</strong>就是来解决这个问题的。当页面向下滚动时，粘性侧边栏会灵活的固定在屏幕中，保证用户在任何位置都可以看到侧边栏中的内容。</p><p>具体工作模式如下图：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE199.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE199.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>考虑到侧边栏有可能会很长，因此设计出足够“聪明”的粘性侧边栏也不那么容易。教程将用到<a href="https://github.com/abouolia">Abouolia</a>的<a href="https://github.com/abouolia/sticky-sidebar">粘性侧边栏插件</a>，强大且小巧，读者可以去<a href="https://abouolia.github.io/sticky-sidebar/">官方示例</a>感受一下。</p><p>将<a href="https://github.com/abouolia/sticky-sidebar">插件的GitHub库</a>下载到本地后，因为博客项目已经加载好了<code>Jquery</code>，所以只需要用到<code>dist</code>目录下的<code>jquery.sticky-sidebar.min.js</code>这个文件就可以了。在项目的<code>static</code>目录下新建目录<code>sticky_sidebar</code>，将其粘贴进去：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/static/sticky_sidebar/jquery.sticky-sidebar.min.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>因为只需要在<strong>文章详情</strong>页面用到，所以在详情页中引入模块就够用了：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token comment">&lt;!-- 目录 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">...</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sidebar<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sidebar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sidebar__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">></span></span>目录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>            &#123;&#123; toc|safe &#125;&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span class="token comment">&lt;!-- 粘性侧边栏样式 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">    <span class="token selector">.sidebar</span><span class="token punctuation">&#123;</span>        <span class="token property">will-change</span><span class="token punctuation">:</span> min-height<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token selector">.sidebar__inner</span><span class="token punctuation">&#123;</span>        <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">translate</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">translate3d</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token property">will-change</span><span class="token punctuation">:</span> position<span class="token punctuation">,</span> transform<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>...&#123;% block script %&#125;<span class="token comment">&lt;!-- 引入粘性侧边栏 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>sticky_sidebar/jquery.sticky-sidebar.min.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#sidebar'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stickySidebar</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        topSpacing<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>        bottomSpacing<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>...&#123;% endblock script %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>按照插件的要求，侧边栏套上了<strong>两层容器</strong>，第一层含有属性<code>id=&quot;sidebar&quot; class=&quot;sidebar&quot;</code>，第二层含有属性<code>class=&quot;sidebar__inner&quot;</code>。然后设置样式，引入静态文件并调用插件，没什么好说的，照做就可以了。与前面的章节相同，由于插件需求<strong>Jquery</strong>，一定要把 JavaScript 语句放到<code>&#123;% block script %&#125;</code>中，否则会报错哦。</p><blockquote><p>插件还有其他可设置的规则，详情见<a href="https://abouolia.github.io/sticky-sidebar/">官方文档</a></p></blockquote><p>刷新页面，不管你怎么滚动页面，目录都显示在屏幕中，并且随着滚轮很自然的上下移动了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE200.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190411/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE200.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章学习了回到顶部浮动按钮、矢量图标、页脚沉底和粘性侧边栏四个功能。</p><p>就像前面说的，这几个功能跟Django没什么关系，但是既然要想做一个完整的博客网站，就不要抱有幻想。<strong>光靠那么一点点Django代码是不可能的</strong>，什么知识你都得会一点才行。</p><p>读者以后会遇到更加多样的编程工具，一定不要被“Django程序员”这个头衔所束缚，勇敢去学吧。谁让你已经上了贼船呢。</p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#x75;&#x73;&#x61;&#105;&#x70;&#104;&#x6f;&#116;&#x6f;&#64;&#102;&#x6f;&#120;&#109;&#x61;&#105;&#108;&#46;&#99;&#111;&#109;">&#x64;&#x75;&#x73;&#x61;&#105;&#x70;&#104;&#x6f;&#116;&#x6f;&#64;&#102;&#x6f;&#120;&#109;&#x61;&#105;&#108;&#46;&#99;&#111;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--33.消息通知</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/33.xiao-xi-tong-zhi/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/33.xiao-xi-tong-zhi/</url>
      
        <content type="html"><![CDATA[<p>凭借你勤奋的写作，拜读你文章的用户越来越多，他们的评论也分散在众多的文章之中。作为博主，读者的留言肯定是要都看的；而读者给你留言，自然也希望得到回复。</p><p>怎么将未读的留言呈现给正确的用户呢？总不能用户自己去茫茫文章中寻找吧，那也太蠢了。给评论增加<strong>通知功能</strong>就是很流行的解决方案：比如微信朋友圈留言的通知、新浪微博留言的通知、以及各种社交平台的“小红点”。</p><p>本篇将以<code>django-notifications</code>为基础，非常高效的搭建一个简易的通知系统。</p><h2 id="发送通知"><a href="#发送通知" class="headerlink" title="发送通知"></a>发送通知</h2><p>前面的步骤我们已经很熟悉了。</p><p>首先安装<code>django-notifications</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> pip <span class="token function">install</span> django-notifications-hq<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>注册app：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token string">'notifications'</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在根路由中安装路径：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">import</span> notifications<span class="token punctuation">.</span>urlsurlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    path<span class="token punctuation">(</span><span class="token string">'inbox/notifications/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span>notifications<span class="token punctuation">.</span>urls<span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'notifications'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意这里的<code>notifications.urls</code>没有像之前一样用字符串，是为了确保模块安装到正确的命名空间中。</p><p>数据迁移：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage.py migrate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>app就安装好了。</p><p>接下来你就可以在项目的<strong>任何地方</strong>发送通知了！像这样：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> notifications<span class="token punctuation">.</span>signals <span class="token keyword">import</span> notifynotify<span class="token punctuation">.</span>send<span class="token punctuation">(</span>actor<span class="token punctuation">,</span> recipient<span class="token punctuation">,</span> verb<span class="token punctuation">,</span> target<span class="token punctuation">,</span> action_object<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>其中的参数释义：</p><ul><li><code>actor</code>：发送通知的对象</li><li><code>recipient</code>：接收通知的对象</li><li><code>verb</code>：动词短语</li><li><code>target</code>：链接到动作的对象<em>（可选）</em></li><li><code>action_object</code>：执行通知的对象（可选）</li></ul><p>有点绕，举个栗子：<a href="https://www.dusaiphoto.com/">杜赛</a>  <code>(actor)</code>  在  <a href="https://www.dusaiphoto.com/article/detail/2">Django搭建个人博客</a>  <code>(target)</code>  中对  <a href="">你</a>  <code>(recipient)</code>  <a href="">发表了</a>  <code>(verb)</code>    <a href="">评论</a>  <code>(action_object)</code>。</p><p>因为我们想要在用户<strong>发表评论的时候发送通知</strong>，因此修改一下发表评论的视图：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comments<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">from</span> notifications<span class="token punctuation">.</span>signals <span class="token keyword">import</span> notify<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">def</span> <span class="token function">post_comment</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 已有代码，创建新回复</span>    <span class="token keyword">if</span> comment_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 已有代码，二级回复</span>        <span class="token keyword">if</span> parent_comment_id<span class="token punctuation">:</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment"># 新增代码，给其他用户发送通知</span>            <span class="token keyword">if</span> <span class="token keyword">not</span> parent_comment<span class="token punctuation">.</span>user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>                notify<span class="token punctuation">.</span>send<span class="token punctuation">(</span>                    request<span class="token punctuation">.</span>user<span class="token punctuation">,</span>                    recipient<span class="token operator">=</span>parent_comment<span class="token punctuation">.</span>user<span class="token punctuation">,</span>                    verb<span class="token operator">=</span><span class="token string">'回复了你'</span><span class="token punctuation">,</span>                    target<span class="token operator">=</span>article<span class="token punctuation">,</span>                    action_object<span class="token operator">=</span>new_comment<span class="token punctuation">,</span>                <span class="token punctuation">)</span>            <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'200 OK'</span><span class="token punctuation">)</span>                new_comment<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 新增代码，给管理员发送通知</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>            notify<span class="token punctuation">.</span>send<span class="token punctuation">(</span>                    request<span class="token punctuation">.</span>user<span class="token punctuation">,</span>                    recipient<span class="token operator">=</span>User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>is_superuser<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    verb<span class="token operator">=</span><span class="token string">'回复了你'</span><span class="token punctuation">,</span>                    target<span class="token operator">=</span>article<span class="token punctuation">,</span>                    action_object<span class="token operator">=</span>new_comment<span class="token punctuation">,</span>                <span class="token punctuation">)</span>                    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>article<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>增加了两条<code>notify</code>的语句，分别位于两个<code>if</code>语句中：</p><ul><li>第一个<code>notify</code>：用户之间可以互相评论，因此需要发送通知。<code>if</code>语句是为了防止管理员收到重复的通知。</li><li>第二个<code>notify</code>：普通用户回复时给管理员发送通知。</li></ul><blockquote><p>普通用户回复普通用户时，这段代码是不会发送通知给管理员的。如果需要发送给管理员，在第一个 notify 的 recipient 里以列表形式，将被回复用户和管理员添加进去即可。感谢 @囸義使鍺 反馈。</p></blockquote><p>其他的代码没有变化，注意位置不要错就行了。你可以试着发送几条评论，然后打开<code>SQLiteStudio</code>，查看<code>notifications_notification</code>表中的数据变化。</p><blockquote><p>有效代码实际上只有4行，我们就完成了创建、发送通知的功能！相信你已经逐渐体会到运用第三方库带来的便利了。这就是站在了“巨人们”的肩膀上。</p></blockquote><h2 id="小红点"><a href="#小红点" class="headerlink" title="小红点"></a>小红点</h2><p>后台创建通知的逻辑已经写好了，但是如果不能在前端显示出来，那也没起到作用。</p><p>而前端显示消息通知比较流行的是<strong>“小红点”</strong>，流行得都已经泛滥了，尽管很多软件其实根本就不需要。另一种形式是消息<strong>徽章</strong>，即一个红色方框中带有消息条目的计数。这两种方式都会用到博客页面中。</p><p>在位置的选择上，<code>header</code>是很合适的，因为它在博客的所有位置都会显示，很符合通知本身的定位。</p><p>因此修改<code>header.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/header.html<span class="token comment">&lt;!-- 引入notifications的模板标签 --></span>&#123;% load notifications_tags %&#125;&#123;% notifications_unread as unread_count %&#125;...<span class="token comment">&lt;!-- 已有代码，用户下拉框 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-item dropdown<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-link dropdown-toggle<span class="token punctuation">"</span></span> <span class="token attr-name">...</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 新增代码，小红点 --></span>        &#123;% if unread_count %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">viewBox</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0 0 8 8<span class="token punctuation">"</span></span>                 <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8px<span class="token punctuation">"</span></span>                 <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8px<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>circle</span> <span class="token attr-name">cx</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>                        <span class="token attr-name">cy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>                        <span class="token attr-name">r</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>                        <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#ff6b6b<span class="token punctuation">"</span></span>                        <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>circle</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span>        &#123;% endif %&#125;                &#123;&#123; user.username &#125;&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 已有代码，下拉框中的链接 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown-menu<span class="token punctuation">"</span></span> <span class="token attr-name">...</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 新增代码，通知计数 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown-item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>通知            &#123;% if unread_count %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>badge badge-danger<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; unread_count &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>            &#123;% endif %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                ...        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">...</span><span class="token punctuation">></span></span>退出登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>django-notifications</code>自带简易的模板标签，可以在前台模板中调用重要的通知相关的对象，在<strong>顶部引入</strong>就可以使用了。比如<code>unread_count</code>是当前用户的未读通知的计数。</p><p><code>Bootstrap</code>自带有徽章的样式，但是却没有小红点的样式（至少我没有找到），所以就只能用<code>svg</code>自己画了，好在也不难。</p><blockquote><p><code>svg</code>是绘制矢量图形的标签，这里就不展开讲了，感兴趣请自行搜索相关文章。</p></blockquote><p>随便评论几条，刷新页面看一看：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190518/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE210.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190518/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE210.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>效果不错。但是链接的<code>href</code>是空的，接下来就处理。</p><h2 id="未读与已读"><a href="#未读与已读" class="headerlink" title="未读与已读"></a>未读与已读</h2><p>既然是通知，那么肯定能够分成<strong>”未读的“</strong>和<strong>”已读的“</strong>两种。在适当的时候，未读通知又需要转换为已读的。现在我们来开发功能集中处理它。</p><p>通知是一个独立的功能，以后有可能在任何地方用到，放到评论app中似乎并不合适。</p><p>所以新建一个app：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage.py startapp notice<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>注册：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token string">'notice'</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根路由：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># notice</span>    path<span class="token punctuation">(</span><span class="token string">'notice/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'notice.urls'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'notice'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来就是视图了。之前所有的视图都是用的<strong>视图函数</strong>，这次我们更进一步，用<strong>类视图</strong>来完成。忘记什么是类视图的，回忆一下前面<a href="https://www.dusaiphoto.com/article/detail/52/">类的视图</a>章节。</p><p>编写视图：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">notice<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token punctuation">,</span> redirect<span class="token keyword">from</span> django<span class="token punctuation">.</span>views <span class="token keyword">import</span> View<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>generic <span class="token keyword">import</span> ListView<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> LoginRequiredMixin<span class="token keyword">from</span> article<span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticlePost<span class="token keyword">class</span> <span class="token class-name">CommentNoticeListView</span><span class="token punctuation">(</span>LoginRequiredMixin<span class="token punctuation">,</span> ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""通知列表"""</span>    <span class="token comment"># 上下文的名称</span>    context_object_name <span class="token operator">=</span> <span class="token string">'notices'</span>    <span class="token comment"># 模板位置</span>    template_name <span class="token operator">=</span> <span class="token string">'notice/list.html'</span>    <span class="token comment"># 登录重定向</span>    login_url <span class="token operator">=</span> <span class="token string">'/userprofile/login/'</span>    <span class="token comment"># 未读通知的查询集</span>    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>notifications<span class="token punctuation">.</span>unread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">CommentNoticeUpdateView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""更新通知状态"""</span>    <span class="token comment"># 处理 get 请求</span>    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 获取未读消息</span>        notice_id <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'notice_id'</span><span class="token punctuation">)</span>        <span class="token comment"># 更新单条通知</span>        <span class="token keyword">if</span> notice_id<span class="token punctuation">:</span>            article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'article_id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>notifications<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>notice_id<span class="token punctuation">)</span><span class="token punctuation">.</span>mark_as_read<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>article<span class="token punctuation">)</span>        <span class="token comment"># 更新全部通知</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>notifications<span class="token punctuation">.</span>mark_all_as_read<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'notice:list'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>视图共两个。</p><p><code>CommentNoticeListView</code>：继承自<code>ListView</code>，用于展示所有的未读通知。<code>get_queryset</code>方法返回了传递给模板的上下文对象，<code>unread()</code>方法是<code>django-notifications</code>提供的，用于获取所有未读通知的集合。另外视图还继承了<strong>“混入类”</strong><code>LoginRequiredMixin</code>，要求调用此视图必须先登录。</p><p><code>CommentNoticeUpdateView</code>：继承自<code>View</code>，获得了如get、post等基础的方法。<code>mark_as_read()</code>、<code>mark_all_as_read</code>都是模块提供的方法，用于将未读通知转换为已读。<code>if</code>语句用来判断转换单条还是所有未读通知。</p><blockquote><p>重复：阅读有困难的同学，请重新阅读<a href="https://www.dusaiphoto.com/article/detail/52/">类的视图</a>章节，或者去<a href="https://docs.djangoproject.com/en/2.2/topics/class-based-views/">官方文档</a>查阅。</p></blockquote><p>接下来就是新建<code>urls.py</code>了，写入：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">notice<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> viewsapp_name <span class="token operator">=</span> <span class="token string">'notice'</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token comment"># 通知列表</span>    path<span class="token punctuation">(</span><span class="token string">'list/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>CommentNoticeListView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># 更新通知状态</span>    path<span class="token punctuation">(</span><span class="token string">'update/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>CommentNoticeUpdateView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'update'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>path()</code>的第二个参数只能接收<strong>函数</strong>，因此别忘了要调用类视图的<code>as_view()</code>方法。</p><p><strong>集中处理通知需要一个单独的页面。</strong>新建<code>templates/notice/list.html</code>模板文件：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/notice/list.html&#123;% extends "base.html" %&#125;&#123;% load staticfiles %&#125;&#123;% block title %&#125;    通知&#123;% endblock title %&#125;&#123;% block content %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row mt-4 ml-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">"</span></span><span class="token attr-name"><span class="token namespace">notice:</span>update"</span> <span class="token attr-name">%&#125;"</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-warning<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>清空所有通知<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 未读通知列表 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row mt-2 ml-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            &#123;% for notice in notices %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list-group-item<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notice_link<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">"</span></span><span class="token attr-name"><span class="token namespace">notice:</span>update"</span> <span class="token attr-name">%&#125;?article_id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>&#123;&#123;</span> <span class="token attr-name">notice.target.id</span> <span class="token attr-name">&#125;&#125;&amp;notice_id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>&#123;&#123;</span> <span class="token attr-name">notice.id</span> <span class="token attr-name">&#125;&#125;"</span>                       <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span>                    <span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> #5897fb<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>                        &#123;&#123; notice.actor &#125;&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>                        在 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> #01a252<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>&#123;&#123; notice.target &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span> &#123;&#123; notice.verb &#125;&#125;。                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                    <span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>&#123;&#123; notice.timestamp|date:"Y/m/d H:i" &#125;&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>            &#123;% endfor %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">    <span class="token selector">#notice_link a:link</span> <span class="token punctuation">&#123;</span>        <span class="token property">color</span><span class="token punctuation">:</span> black<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token selector">#notice_link a:visited</span> <span class="token punctuation">&#123;</span>        <span class="token property">color</span><span class="token punctuation">:</span> lightgrey<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>模板中主要提供了两个功能：</p><ul><li>点击<code>button</code>按钮清空所有未读通知</li><li>点击单个通知，将其转换为已读通知，并前往此评论所在的文章</li></ul><p>末尾<code>&lt;style&gt;</code>标签中的<strong>伪类选择器</strong>，作用是将已经点击过的通知字体颜色转换为浅灰色，优化用户体验。</p><p>最后就是补上<strong>入口</strong>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/header.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">...</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">"</span></span><span class="token attr-name"><span class="token namespace">notice:</span>list"</span> <span class="token attr-name">%&#125;"</span><span class="token punctuation">></span></span>通知...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样就完成了。</p><p>打开服务器，用一个普通账号评论几条，再登录管理员账号并进入通知页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190518/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE212.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190518/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE212.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>就能看到不错的效果了。实现的效果是仅展示未读通知，当然也可以在下边展示已读通知，方便用户追溯。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通知功能非常的重要，特别是在你的博客成长壮大了之后。你还可以把它用在别的地方，比如每新发表一篇文章，就给你所有的“粉丝”推送一条通知，提醒他们可以来拜读了。具体如何扩展运用，就靠你脑洞大开了。</p><p><strong>课后作业：</strong>前面的代码中，如果用户自己评论自己，同样也会收到通知。这种通知并没有必要，请修正它。</p><blockquote><p>遇到困难，在<a href="https://github.com/stacklens/django_blog_tutorial">教程示例代码</a>找答案吧。</p></blockquote><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#117;&#115;&#97;&#x69;&#112;&#104;&#111;&#116;&#111;&#x40;&#x66;&#111;&#x78;&#x6d;&#x61;&#105;&#x6c;&#46;&#99;&#x6f;&#x6d;">&#100;&#117;&#115;&#97;&#x69;&#112;&#104;&#111;&#116;&#111;&#x40;&#x66;&#111;&#x78;&#x6d;&#x61;&#105;&#x6c;&#46;&#99;&#x6f;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--34.锚点定位</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/34.mao-dian-ding-wei/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/34.mao-dian-ding-wei/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>老读者注意：</strong>上一章<a href="https://www.dusaiphoto.com/article/detail/64/">消息通知</a>有个bug，即发给管理员的<code>notify</code>必须移动到<code>new_comment.save()</code>的后面，否则会导致<code>action_object</code>存储为<code>NULL</code>，并且导致本章的<code>html</code>拼接锚点失效。</p><p>原文已更正，为博主的疏忽表示歉意。</p></blockquote><p>上一章已经实现了<strong>消息通知功能</strong>，可以很人性化的把用户引导到被他人回复的页面中去。</p><p>但是仔细想想，似乎还有不方便的地方：如果页面中评论较多，想找到感兴趣的那一条评论还是要费点功夫的。所以这个消息通知，最好是能够不仅前往正确的页面，还要前往正确的位置（需求是无穷无尽的..）。</p><p>为了实现这个功能，本章就要介绍一个非常古老的功能：<strong>锚点定位</strong>。以及如何在Django中实现它。</p><h2 id="锚点是什么"><a href="#锚点是什么" class="headerlink" title="锚点是什么"></a>锚点是什么</h2><p>我们在写<code>html</code>文件的容器时，经常会用到<code>id</code>属性：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fruit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>apple<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这个<code>id</code>属性不仅可以作为<code>Javascript</code>或者<code>css</code>代码查询某个容器的标记，还可以作为锚点，定位页面应该前往的位置。输入下面的地址：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">http://www.myblog.com/home#fruit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>浏览器就会打开<code>home</code>页面，并且视窗前往<code>id=&quot;fruit&quot;</code>的容器。</p><p>明白了锚点是什么，下面就通过<strong>三种不同的实现方法</strong>，看看锚点在Django博客项目中是如何应用的。</p><h2 id="三种实现"><a href="#三种实现" class="headerlink" title="三种实现"></a>三种实现</h2><h3 id="html拼接"><a href="#html拼接" class="headerlink" title="html拼接"></a>html拼接</h3><p>锚点首先要实现的功能，就是<strong>当管理员点击消息通知时，浏览器视窗前往此通知的评论位置</strong>。</p><p>因此首先修改文章详情页面，给渲染评论的<code>div</code>容器添加<code>id</code>属性：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token comment">&lt;!-- 已有代码，遍历树形结构 --></span>&#123;% recursetree comments %&#125;&#123;% with comment=node %&#125;<span class="token comment">&lt;!-- 唯一新增代码：id属性 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>comment_elem_&#123;&#123; comment.id &#125;&#125;<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>    ...    <span class="token comment">&lt;!-- 下面都是已有代码 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>children<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        &#123;&#123; children &#125;&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    &#123;% endif %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endwith %&#125;&#123;% endrecursetree %&#125;...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们还是用<code>comment.id</code>来给每条评论赋予唯一的<code>id</code>值。注意<code>id</code>属性保持<strong>唯一性</strong>。前面在二级回复的<strong>Modal</strong>中用了<code>comment_&#123;&#123; comment.id &#125;&#125;</code>，这里千万不要重复了。</p><p>然后修改通知列表模板，添加锚点：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/notice/list.html...&#123;% for notice in notices %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">...</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 新增 comment_elem_&#123;&#123; notice.action_object.id &#125;&#125; 锚点 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">"</span></span><span class="token attr-name"><span class="token namespace">notice:</span>update"</span> <span class="token attr-name">%&#125;?article_id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>&#123;&#123;</span> <span class="token attr-name">notice.target.id</span> <span class="token attr-name">&#125;&#125;&amp;notice_id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>&#123;&#123;</span> <span class="token attr-name">notice.id</span> <span class="token attr-name">&#125;&#125;#comment_elem_&#123;&#123;</span> <span class="token attr-name">notice.action_object.id</span> <span class="token attr-name">&#125;&#125;"</span>       <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span>       <span class="token punctuation">></span></span>        ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>&#123;% endfor %&#125;...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意这里<code>url</code>中拼接了两种玩意儿：</p><ul><li>跟在<code>?</code>后面的是查询参数，用于给视图传递参数，是之前写的旧代码</li><li>跟在<code>#</code>后面的是锚点，也就是本章正在学的东东</li></ul><p><code>?</code>和<code>#</code>一个重要的差别，就是<code>?</code>不能够传递到下个页面的<code>url</code>中去，而<code>#</code>可以。</p><p>测试一下，用普通用户账号发几条一级评论，登录管理员账号并点击消息通知：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190605/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE217.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190605/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE217.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>浏览器视窗没有在页面顶部，而是直接前往到该条评论处。</p><p>通过<code>html</code>拼接是实现锚点最<strong>简单直接</strong>的方法。</p><h3 id="视图拼接"><a href="#视图拼接" class="headerlink" title="视图拼接"></a>视图拼接</h3><p><code>html</code>拼接虽好，但它不是万能的。如果要<strong>前往一个当前页面还没有创建的容器</strong>，该怎么办？</p><p>举个栗子。按照目前我们的博客设计，当用户发表评论时，页面会刷新、视窗将停留在文章详情的顶部。但实际上这时候视窗应该停留在新发表的评论处才比较合理，因为用户可能想检查一下自己发表的评论是否正确。而在原页面时由于新评论都还没发表，所以<code>comment.id</code>是不存在的，没办法用<code>html</code>拼接锚点。读者好好思考一下是不是这样。</p><p>这种情况下就需要在视图中拼接锚点了。修改文章评论视图，将锚点拼接到<code>redirect</code>函数中：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 文章评论视图</span><span class="token keyword">def</span> <span class="token function">post_comment</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> article_id<span class="token punctuation">,</span> parent_comment_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 已有代码</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">if</span> comment_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token keyword">if</span> parent_comment_id<span class="token punctuation">:</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            new_comment<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>                notify<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>            <span class="token comment"># 新增代码，添加锚点</span>            redirect_url <span class="token operator">=</span> article<span class="token punctuation">.</span>get_absolute_url<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'#comment_elem_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>new_comment<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>            <span class="token comment"># 修改redirect参数</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>redirect_url<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>get_absolute_url()</code>是之前章节写的方法，用于查询某篇文章的地址。</p></blockquote><p>说白了就是把拼接的位置从<strong>模板</strong>挪到了<strong>视图</strong>中，因为新评论必须在视图中保存之后才会被分配一个<code>id</code>值。</p><h3 id="流动的数据"><a href="#流动的数据" class="headerlink" title="流动的数据"></a>流动的数据</h3><p>最后我们来看稍微复杂点的情况。</p><p>当用户发表一级评论时，我们在视图中拼接锚点解决了刷新当前页面并定位的问题。但是<strong>二级评论</strong>是通过<code>iframe + ajax</code>实现的，这又该怎么办？</p><p>理一理思路。</p><p>首先，新评论的<code>id</code>值是在视图中创建的，但是由于视图是从<code>iframe</code>中请求的，在视图中没办法刷新<code>iframe</code>的父页面。所以我们唯一能做的就是<strong>把数据传递出去</strong>，到前端去处理。</p><p>修改文章评论视图：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">comment<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token comment"># 引入JsonResponse</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> JsonResponse<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 文章评论视图</span><span class="token keyword">def</span> <span class="token function">post_comment</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> article_id<span class="token punctuation">,</span> parent_comment_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    article <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>ArticlePost<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span>article_id<span class="token punctuation">)</span>    <span class="token comment"># 已有代码</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">if</span> comment_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token keyword">if</span> parent_comment_id<span class="token punctuation">:</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token comment"># 修改此处代码</span>                <span class="token comment"># return HttpResponse("200 OK")</span>                <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"200 OK"</span><span class="token punctuation">,</span> <span class="token string">"new_comment_id"</span><span class="token punctuation">:</span> new_comment<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>新引入的<code>JsonResponse</code>返回的是<code>json</code>格式的数据，由它将新评论的<code>id</code>传递出去。</p><blockquote><p>json是web开发中很常用的轻量级数据格式，非常像python的字典，读者请自行了解。</p><p>特别提醒json格式必须用双引号。</p></blockquote><p>现在数据在<code>iframe</code>中了。但是我们需要刷新的是<code>iframe</code>的父页面啊，所以还要**继续把数据往父页面“扔”**。</p><p>修改二级评论的模板：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/comment/reply.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token operator">...</span><span class="token keyword">function</span> <span class="token function">confirm_submit</span><span class="token punctuation">(</span><span class="token parameter">article_id<span class="token punctuation">,</span> comment_id</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token operator">...</span>    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token operator">...</span>        <span class="token comment">// 成功回调函数</span>        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                        <span class="token comment">// 旧代码</span>            <span class="token comment">// if(e === '200 OK')&#123;</span>            <span class="token comment">//     parent.location.reload();</span>            <span class="token comment">// &#125;;</span>                        <span class="token comment">// 新代码</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'200 OK'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token comment">// 调用父页面的函数</span>                parent<span class="token punctuation">.</span><span class="token function">post_reply_and_show_it</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>new_comment_id<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于现在ajax获取的是json数据，因此用<code>e.code</code>获取视图返回的状态。</p><p>旧代码用<code>parent.location.reload()</code>刷新了父页面。同样的，用<code>parent.abc()</code>可以调用父页面的<code>abc()</code>函数。这样就把数据传递到父页面里去了。</p><p>这下就好说了。在父页面中（文章详情模板）添加需要执行锚点拼接的函数：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...&#123;% block script %&#125;...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token operator">...</span>    <span class="token comment">// 新增函数，处理二级回复</span>    <span class="token keyword">function</span> <span class="token function">post_reply_and_show_it</span><span class="token punctuation">(</span><span class="token parameter">new_comment_id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> next_url <span class="token operator">=</span> <span class="token string">"&#123;% url 'article:article_detail' article.id %&#125;"</span><span class="token punctuation">;</span>        <span class="token comment">// 去除 url 尾部 '/' 符号</span>        next_url <span class="token operator">=</span> next_url<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>next_url<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token operator">?</span> next_url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> next_url<span class="token punctuation">;</span>        <span class="token comment">// 刷新并定位到锚点</span>        window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>next_url <span class="token operator">+</span> <span class="token string">"#comment_elem_"</span> <span class="token operator">+</span> new_comment_id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>&#123;% endblock script %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>函数中运用了<strong>JavaScript</strong>的<strong>三元运算符</strong><code>a ? b : c</code>，翻译成人话就是：如果<code>a</code>成立则返回<code>b</code>，如果<code>a</code>不成立就返回<code>c</code>。作用是去掉<code>url</code>尾部的<code>/</code>，否则锚点不会生效。你可能会问，三元运算符多麻烦，为什么不直接把<code>url</code>末尾一个字符剔除掉呢？答案是这样写代码更加健壮。万一哪天Django解析的<code>url</code>尾部没有斜杠了呢。</p><p><code>window.location.replace()</code>作用是重定向页面，在这里面终于可以愉快的拼接锚点了。</p><p>一切都OK啦。测试发表二级评论，运气好的同学应该可以顺利将视窗定位到刚评论的位置了。</p><p>感受到数据的流动没有？</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章学习了锚点的html拼接、视图拼接、ajax+iframe综合运用，理解后就能应付绝大部分的状况了。</p><p>锚点虽然古老，但并不陈旧。</p><p>合理的运用锚点，可以让你的博客相当的人性化，这也是好网站的一个标志。</p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#x75;&#x73;&#97;&#105;&#112;&#x68;&#111;&#x74;&#111;&#64;&#x66;&#111;&#x78;&#x6d;&#97;&#x69;&#x6c;&#46;&#99;&#x6f;&#109;">&#x64;&#x75;&#x73;&#97;&#105;&#112;&#x68;&#111;&#x74;&#111;&#64;&#x66;&#111;&#x78;&#x6d;&#97;&#x69;&#x6c;&#46;&#99;&#x6f;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--35.第三方登录</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/35.di-san-fang-deng-lu/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/35.di-san-fang-deng-lu/</url>
      
        <content type="html"><![CDATA[<p>现在我们已经拥有一个可以进行用户<strong>本地登录</strong>的博客系统了。如果有人欣赏你的文章，说不定就会注册成为本地用户，并和你好好交流一番。</p><p>但头疼的是，用户可能每天都在互联网上浏览很多非常棒的博客，如果每个博客都要去注册才能评论，对用户是个不小的负担。对个人博客这类草根网站，说不定用户就懒得去注册了，你也就损失了一个潜在的”粉丝“。</p><p>比较流行的解决方案是允许用户通过<strong>第三方登录</strong>，即可以通过GitHub、微博这类知名社区的授权，从而登录你的小站，免去了注册的麻烦。</p><p>本章会介绍一个强大的库：<code>Django-allauth</code>，它不仅包含一整套的本地注册、登录、管理的解决方案，还支持GitHub、Twitter、微博、微信甚至百度等几十种第三方登录方式，真的是当爹又当妈啊…</p><h2 id="本地登录"><a href="#本地登录" class="headerlink" title="本地登录"></a>本地登录</h2><p>先看看<code>django-allauth</code>的本地登录如何配置。</p><p>安装<code>django-allauth</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> pip <span class="token function">install</span> django-allauth<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改配置文件：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>TEMPLATES <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token string">'OPTIONS'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'context_processors'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>                <span class="token comment"># allauth 启动必须项</span>                <span class="token string">'django.template.context_processors.request'</span><span class="token punctuation">,</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">]</span>AUTHENTICATION_BACKENDS <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token comment"># Django 后台可独立于 allauth 登录</span>    <span class="token string">'django.contrib.auth.backends.ModelBackend'</span><span class="token punctuation">,</span>    <span class="token comment"># 配置 allauth 独有的认证方法，如 email 登录</span>    <span class="token string">'allauth.account.auth_backends.AuthenticationBackend'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># allauth 启动必须项</span>    <span class="token string">'django.contrib.auth'</span><span class="token punctuation">,</span>    <span class="token string">'django.contrib.messages'</span><span class="token punctuation">,</span>    <span class="token string">'django.contrib.sites'</span><span class="token punctuation">,</span>    <span class="token string">'allauth'</span><span class="token punctuation">,</span>    <span class="token string">'allauth.account'</span><span class="token punctuation">,</span>    <span class="token string">'allauth.socialaccount'</span><span class="token punctuation">,</span>        <span class="token comment"># 可添加需要的第三方登录</span>    <span class="token string">'allauth.socialaccount.providers.github'</span><span class="token punctuation">,</span>    <span class="token string">'allauth.socialaccount.providers.weibo'</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token comment"># 设置站点</span>SITE_ID <span class="token operator">=</span> <span class="token number">1</span><span class="token comment"># 登录成功后重定向地址</span>LOGIN_REDIRECT_URL <span class="token operator">=</span> <span class="token string">'/article/article-list'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意上面的配置中，有的内容是创建项目时本来就有的，检查一下你的项目中是否包含；有的内容是完全新增的，不要漏掉了。</p><p><code>django-allauth</code>也是一个app，因此需要分配给它<code>url</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    path<span class="token punctuation">(</span><span class="token string">'accounts/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'allauth.urls'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后一步是迁移数据：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage.py migrate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这就完成了！</p><p>输入<code>django-allauth</code>的默认登录页面地址：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">http://127.0.0.1:8000/accounts/login/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>显示页面如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190620/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE220.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190620/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE220.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><h3 id="设置网站首页"><a href="#设置网站首页" class="headerlink" title="设置网站首页"></a>设置网站首页</h3><p>教程到现在，我们的博客都还没有分配首页地址。</p><p>博客网站的首页通常就是文章列表本身，因此把这个路由添加到<code>my_blog/urls.py</code>中：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">from</span> article<span class="token punctuation">.</span>views <span class="token keyword">import</span> article_listurlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token comment"># home</span>    path<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> article_list<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再把登录成功后的重定向地址改过来：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 重定向 url</span><span class="token comment">#LOGIN_REDIRECT_URL = '/article/article-list'</span>LOGIN_REDIRECT_URL <span class="token operator">=</span> <span class="token string">'/'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样就拥有地址为<code>http://127.0.0.1:8000</code>首页啦。</p><h3 id="美化模板"><a href="#美化模板" class="headerlink" title="美化模板"></a>美化模板</h3><p><code>django-allauth</code>自带的模板是简陋的，需要覆写为自己网站的风格才能使用。</p><p>还记得我们一直在使用的<strong>虚拟环境</strong>吗？没错，所有项目运行所需的第三方库都是保存在虚拟环境的文件夹中的，在本教程中也就是<code>env</code>文件夹了。找到下面的路径：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">env<span class="token punctuation">\</span>Lib<span class="token punctuation">\</span>site-packages<span class="token punctuation">\</span>allauth<span class="token punctuation">\</span>templates<span class="token punctuation">\</span>account<span class="token punctuation">\</span>login.html<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这个<code>login.html</code>就是原始的登录模板文件了。虽然可以直接修改这个文件来优化页面，但是这样做是很蠢的，因为每当你升级库、或者换台电脑部署时，模板又恢复回去了。</p><p>正确的做法是<strong>复制</strong>这个<code>login.html</code>到你自己项目的<code>templates</code>文件夹中去。即你需要在项目中创建一个<strong>完全相同的路径</strong>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates\account\login.html<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p> Django会优先在项目中寻找模板文件，因此只要相对路径相同，则可以达到覆写的目的。</p></blockquote><p>接下来就可以愉快的定制风格了。</p><p>参考代码如下：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates\account\login.html&#123;% extends "base.html" %&#125;&#123;% load i18n %&#125;&#123;% load account socialaccount %&#125;&#123;% block title %&#125;登录&#123;% endblock %&#125;&#123;% block content %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>            &#123;% get_providers as socialaccount_providers %&#125;            &#123;% if socialaccount_providers %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>                &#123;% blocktrans with site.name as site_name %&#125;请登录已有本地账号或<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; signup_url &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>新账号。                也可以通过第三方登录:&#123;% endblocktrans %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>socialaccount_ballot<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mb-2 mt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>第三方登录：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>socialaccount_providers<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                  &#123;% include "socialaccount/snippets/provider_list.html" with process="login" %&#125;                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mb-2 mt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>本地登录：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>            &#123;% include "socialaccount/snippets/login_extra.html" %&#125;            &#123;% else %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>&#123;% blocktrans %&#125;If you have not created an account yet, then please            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; signup_url &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>sign up<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span> first.&#123;% endblocktrans %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>            &#123;% endif %&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-6<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>login<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>login_form<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>account_login<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    &#123;% csrf_token %&#125;                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id_login<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>账号: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>login<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>请输入用户名或Email<span class="token punctuation">"</span></span> <span class="token attr-name">autofocus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>autofocus<span class="token punctuation">"</span></span> <span class="token attr-name">required</span>                            <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id_login<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-text text-muted ml-1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                            还没有账号？                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>account_signup<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> cornflowerblue<span class="token punctuation">;</span> </span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>                                注册新账号                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group mb-1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id_password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                            密码:                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>请输入密码<span class="token punctuation">"</span></span> <span class="token attr-name">required</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id_password<span class="token punctuation">"</span></span>                            <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-text text-muted ml-1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>secondaryAction layui-text<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>account_reset_password<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                                忘记密码?                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>custom-control custom-checkbox mb-2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id_remember<span class="token punctuation">"</span></span> <span class="token attr-name">checked</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>custom-control-input<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id_remember<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>custom-control-label<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                            保持登录                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>primaryAction btn btn-primary<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit_login<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>确认<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endblock %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>实际效果如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190620/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE230.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190620/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE230.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>除了登录页面以外，其他的所有页面，如注册、邮箱认证页面及邮件、第三方登录页面等都可以用这种方法进行覆写。教程中就不再赘述，读者请自行尝试。</p><h3 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h3><p>接下来看看注册页面。</p><p>点击注册按钮，则看到如下页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190620/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE221.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190620/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE221.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>需要注意的是<strong>邮箱</strong>这一项如果你填了，那么站点会自动向填写的邮箱发送认证邮件。因此前面章节中讲过的关于邮箱的配置一定要正确，否则就会得到一个<code>ConnectionRefusedError</code>的错误。相关的配置项如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token comment"># SMTP服务器</span>EMAIL_HOST <span class="token operator">=</span> <span class="token string">'your smtp'</span><span class="token comment"># 邮箱名</span>EMAIL_HOST_USER <span class="token operator">=</span> <span class="token string">'your email'</span><span class="token comment"># 邮箱密码</span>EMAIL_HOST_PASSWORD <span class="token operator">=</span> <span class="token string">'your password'</span><span class="token comment"># 发送邮件的端口</span>EMAIL_PORT <span class="token operator">=</span> <span class="token number">25</span><span class="token comment"># 是否使用 TLS</span>EMAIL_USE_TLS <span class="token operator">=</span> <span class="token boolean">True</span><span class="token comment"># 默认的发件人</span>DEFAULT_FROM_EMAIL <span class="token operator">=</span> <span class="token string">'your email'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>记得修改为你自己的邮箱配置。</p><p>另外需要注意的是<code>django-allauth</code>所注册的账号与<code>django</code>内置的本地账号是通用的，也就是说通过内置<code>User</code>创建的账号，是可以通过<code>django-allauth</code>登录的。</p><blockquote><p>有了django-allauth，之前教程中写的用户登录、注册以及密码重置模块统统都可以不要了。那既然如此，博主绕了这么大个弯不是坑人吗？这个嘛，学习就是要变着法折腾..</p></blockquote><h2 id="GitHub登录"><a href="#GitHub登录" class="headerlink" title="GitHub登录"></a>GitHub登录</h2><p>搞定了本地登录，接下来的第三方登录才是重点。</p><p>由于<strong>GitHub</strong>的第三方登录是最容易的，因此作为例子来讲解。</p><blockquote><p>作为合格的程序员，怎么能没有GitHub账号！</p></blockquote><h3 id="GitHub注册OAuth"><a href="#GitHub注册OAuth" class="headerlink" title="GitHub注册OAuth"></a>GitHub注册OAuth</h3><p>创建第三方登录的第一步，是需要在GitHub网站上创建OAuth应用。登录GitHub账号，然后进入地址：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">https://github.com/settings/applications/new<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>不排除以后这个地址会变，如果不对就麻烦读者在个人主页的<code>settings</code>里找一找<code>OAuth</code>的设置了。</p><p>进入页面后，填写一下内容：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190621/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE222.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190621/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE222.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>填写的是本地IP，以后部署在线上再修改成实际的域名。</p><p>注意<code>callback URL</code>填写的内容。点击确定后，就得到了应用的信息：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190621/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE224.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190621/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE224.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>其中的<code>Client ID</code>和<code>Client Secret</code>就是要用到的凭证。</p><h3 id="Django后台配置"><a href="#Django后台配置" class="headerlink" title="Django后台配置"></a>Django后台配置</h3><p>然后对Django后台进行设置。</p><p>进入后台，你会发现多了几个栏目：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190621/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE225.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190621/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE225.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>打开<code>Sites</code>，将<code>example.com</code>修改为博客域名。开发时则修改为本地IP：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190621/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE226.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190621/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE226.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>然后进入<code>Social applications</code>，添加一条<code>applications</code>如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190621/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE228.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190621/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE228.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>注意最下面的<code>Sites</code>栏<strong>一定要把刚才添加的站点选择到右边去</strong>。</p><p>回到<code>django-allauth</code>的登录页面，点击<code>github</code>登录：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190621/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE229.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190621/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE229.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>实现了GitHub登录。</p><h2 id="allauth配置项"><a href="#allauth配置项" class="headerlink" title="allauth配置项"></a>allauth配置项</h2><p><strong>挑几个比较重要的讲一下。</strong></p><p><code>ACCOUNT_EMAIL_VERIFICATION = &#39;optional&#39; / &#39;mandatory&#39; / &#39;none&#39;</code>：当其为<code>mandatory</code>时，本地注册的用户必须先验证邮箱才可以登录。<code>optional</code>和<code>none</code>都不要求验证邮箱，区别是<code>optional</code>仍然会发送验证邮件，而<code>none</code>连认证邮件都不会发送。</p><p><code>SOCIALACCOUNT_EMAIL_VERIFICATION = &#39;optional&#39; / &#39;mandatory&#39; / &#39;none&#39;</code>：同理，但是作用于第三方账号的注册。</p><p><code>ACCOUNT_AUTHENTICATION_METHOD = &#39;username_email&#39; / &#39;user&#39; / &#39;email&#39;</code>：指定登录方法，即通过用户名、邮箱进行登录，或者两者均可。</p><p><code>ACCOUNT_EMAIL_REQUIRED =  True / False</code>：注册本地用户时，是否必须填写邮箱。</p><p>除此之外还有很多配置项，详细了解请查阅<a href="https://django-allauth.readthedocs.io/en/latest/configuration.html">官方文档</a>。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章学习了通过<code>django-allauth</code>实现本地及GitHub登录的功能。微博、微信的登录方式大致都遵循这个流程；本章虽然加载了微博的接口，但是限于篇幅并没有配置，请读者查阅官方文档去实现。需要注意的是国内的第三方登录多半需要一两天时间去申请、审核，要更加麻烦一些。</p><p>另外还剩下写入口、删除旧功能等收尾工作，就交给读者自己去完成了。</p><blockquote><p>提示一下，登录的逆向解析地址为<code>&#123;% url 'account_login' %&#125;</code>，注册为<code>&#123;% url 'account_signup' %&#125;</code>。这些在原始模板文件或官方网站都能查到。</p></blockquote><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#x75;&#115;&#97;&#x69;&#112;&#104;&#x6f;&#116;&#111;&#64;&#x66;&#x6f;&#x78;&#109;&#97;&#105;&#x6c;&#46;&#x63;&#x6f;&#109;">&#x64;&#x75;&#115;&#97;&#x69;&#112;&#104;&#x6f;&#116;&#111;&#64;&#x66;&#x6f;&#x78;&#109;&#97;&#105;&#x6c;&#46;&#x63;&#x6f;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--36.自动化测试</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/36.zi-dong-hua-ce-shi/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/36.zi-dong-hua-ce-shi/</url>
      
        <content type="html"><![CDATA[<p>测试是伴随着开发进行的，<strong>开发有多久，测试就要多久</strong>。本教程已经进行了30多章了，都是如何测试的？当然是<code>runserver</code>啦！每当开发新功能后，都需要运行服务器，假装自己就是用户，测试是否运行正常。</p><p>这样的人工测试优点是非常直观，你看到的和用户看到的是完全相同的。但是缺点也很明显：</p><ul><li><strong>效率低。</strong>在开发时可能你需要反复的修改代码、测试功能，这样重复查看几十次甚至几百次网页时会相当的让人烦躁。</li><li><strong>容易遗漏bug。</strong>随着你的项目越来越复杂，组件之间的交互也更加复杂。修改某一个组件可能会导致另一个组件出现意想不到的bug，但是在人工测试时却很难检查出来，总不能每写几行代码就把整个网站统统检查一遍吧。过了很久之后你终于发现了这个bug，但此时你已经搞不清它来源于什么地方了。</li><li><strong>有的测试不方便进行。</strong>比如说有个功能，限制每个用户每天发表评论不能超过10条，人工测试就显得比较麻烦，特别是需要反复调试的时候。</li></ul><p>为了解决人工测试的种种问题，<code>Django</code>引入了<code>Python</code>标准库的单元测试模块，也就是<strong>自动化测试</strong>了：你可以写一段代码，让代码帮你测试！（程序员是最会偷懒的职业..）代码会忠实的完成测试任务，帮助你从繁重的测试工作中解脱出来。除此之外，自动化测试还有以下优点：</p><ul><li><strong>预防错误。</strong>当应用过于复杂时，代码的意图会变得非常不清晰，甚至你都看不懂自己写的代码，这是很常见的。而测试就好像是从内部审查代码一样，可以帮助你发现微小的错误。</li><li><strong>有利于团队协作。</strong>良好的测试保证其他人不会不小心破坏了你的代码（也保证你不会不小心弄坏别人的..）。现在已经不是单打独斗出英雄的年代了，想要成为优秀的Django程序员，你必须擅长编写测试！</li></ul><p>虽然学习自动化测试不会让你的博客增加一丝丝的功能，但是可以<strong>让代码更加强壮</strong>，所以我觉得很有必要拿出一章来专门讲讲。</p><blockquote><p><a href="https://docs.djangoproject.com/zh-hans/2.2/intro/tutorial05/">Django官方文档的第5部分</a>讲测试讲得非常的好，并且有中文版本。本章节就大量借鉴了官方文档，也非常非常推荐读者去拜读。</p></blockquote><h2 id="第一个测试"><a href="#第一个测试" class="headerlink" title="第一个测试"></a>第一个测试</h2><h3 id="给我bug！"><a href="#给我bug！" class="headerlink" title="给我bug！"></a>给我bug！</h3><p>为了演示测试是如何工作的，让我们首先在<strong>文章模型</strong>中写个有bug的方法：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone<span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">def</span> <span class="token function">was_created_recently</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 若文章是"最近"发表的，则返回 True</span>        diff <span class="token operator">=</span> timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>created        <span class="token keyword">if</span> diff<span class="token punctuation">.</span>days <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token keyword">and</span> diff<span class="token punctuation">.</span>seconds <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">True</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个方法用于检测当前文章是否是最近发表的。</p><blockquote><p>这个方法稍微扩展一下就会变得非常实用。比如可以将博文的发表日期显示为“刚刚”、“3分钟前”、“5小时前”等相对时间，用户体验将大有提升。</p></blockquote><p>仔细看看，它是没办法正确判断“未来”的文章的：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> datetime<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> article<span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticlePost<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token comment"># 创建一篇"未来"的文章</span><span class="token operator">>></span><span class="token operator">></span> future_article <span class="token operator">=</span> ArticlePost<span class="token punctuation">(</span>author<span class="token operator">=</span>User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">,</span>body<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">,</span> created<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 是否是“最近”发表的？</span><span class="token operator">>></span><span class="token operator">></span> future_article<span class="token punctuation">.</span>was_created_recently<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token boolean">True</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>未来发生的肯定不是最近发生的，因此代码是错误的。</p><h3 id="写个测试暴露bug"><a href="#写个测试暴露bug" class="headerlink" title="写个测试暴露bug"></a>写个测试暴露bug</h3><p>接下来就要写测试用例，将测试转为自动化。</p><p>还记得最初生成<strong>文章app</strong>时候的目录结构吗？</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">article │  admin.py │  apps.py │  models.py │  tests.py │  views.py │  __init__.py │ └─migrations       └─ __init__.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个<code>tests.py</code>就是留给你写测试用例的地方了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>tests<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>test <span class="token keyword">import</span> TestCase<span class="token keyword">import</span> datetime<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone<span class="token keyword">from</span> article<span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticlePost<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token keyword">class</span> <span class="token class-name">ArticlePostModelTests</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">test_was_created_recently_with_future_article</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 若文章创建时间为未来，返回 False</span>        author <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'test_password'</span><span class="token punctuation">)</span>        author<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        future_article <span class="token operator">=</span> ArticlePost<span class="token punctuation">(</span>            author<span class="token operator">=</span>author<span class="token punctuation">,</span>            title<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">,</span>            body<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">,</span>            created<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>assertIs<span class="token punctuation">(</span>future_article<span class="token punctuation">.</span>was_created_recently<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>基本就是把刚才在<code>Shell</code>中的测试代码抄了过来。有点不同的是末尾这个<code>assertIs</code>方法，了解<strong>“断言”</strong>的同学会对它很熟悉：它的作用是检测方法内的两个参数是否完全一致，如果不是则抛出异常，提醒你这个地方是有问题滴。</p><p>接下来运行测试：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage.py <span class="token builtin class-name">test</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>运行结果如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">Creating test database <span class="token keyword">for</span> alias <span class="token string">'default'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>System check identified no issues <span class="token punctuation">(</span><span class="token number">0</span> silenced<span class="token punctuation">)</span><span class="token punctuation">.</span>F<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>FAIL<span class="token punctuation">:</span> test_was_created_recently_with_future_article <span class="token punctuation">(</span>article<span class="token punctuation">.</span>tests<span class="token punctuation">.</span>ArticlePostModelTests<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"E:\django_project\my_blog\article\tests.py"</span><span class="token punctuation">,</span> line <span class="token number">19</span><span class="token punctuation">,</span> <span class="token keyword">in</span> test_was_created_recently_with_future_article    self<span class="token punctuation">.</span>assertIs<span class="token punctuation">(</span>future_article<span class="token punctuation">.</span>was_created_recently<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>AssertionError<span class="token punctuation">:</span> <span class="token boolean">True</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">False</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>Ran <span class="token number">1</span> test <span class="token keyword">in</span> <span class="token number">0.</span>000sFAILED <span class="token punctuation">(</span>failures<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>Destroying test database <span class="token keyword">for</span> alias <span class="token string">'default'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里面名堂就很多了：</p><ul><li>首先测试系统会在所有以<code>tests</code>开头的文件中寻找测试代码</li><li>所有<code>TestCase</code>的子类都被认为是测试代码</li><li>系统创建了一个特殊的数据库供测试使用，即所有测试产生的数据不会对你自己的数据库造成影响</li><li>类中所有以<code>test</code>开头的方法会被认为是测试用例</li><li>在运行测试用例时，<code>assertIs</code>抛出异常，因为<code>True is not False</code></li><li>完成测试后，自动销毁测试数据库</li></ul><p>测试系统明确指明了错误的数量、位置和种类等信息，请读者细细品尝。</p><h3 id="修正bug"><a href="#修正bug" class="headerlink" title="修正bug"></a>修正bug</h3><p>既然通过测试找到了bug，那接下来就要把代码进行修正：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone<span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">def</span> <span class="token function">was_created_recently</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        diff <span class="token operator">=</span> timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>created                <span class="token comment"># if diff.days &lt;= 0 and diff.seconds &lt; 60:</span>        <span class="token keyword">if</span> diff<span class="token punctuation">.</span>days <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> diff<span class="token punctuation">.</span>seconds <span class="token operator">>=</span> <span class="token number">0</span> <span class="token keyword">and</span> diff<span class="token punctuation">.</span>seconds <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">True</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重新运行测试：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage<span class="token punctuation">.</span>py testCreating test database <span class="token keyword">for</span> alias <span class="token string">'default'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>System check identified no issues <span class="token punctuation">(</span><span class="token number">0</span> silenced<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>Ran <span class="token number">1</span> test <span class="token keyword">in</span> <span class="token number">0.</span>000sOKDestroying test database <span class="token keyword">for</span> alias <span class="token string">'default'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这次代码顺利通过了测试。</p><p>可以肯定的是，在往后的开发中，这个bug不会再出现了，因为你只需要运行一遍测试，就会立即得到警告。<strong>可以认为项目的这一小部分代码永远是安全的</strong>。</p><h3 id="更全面的测试"><a href="#更全面的测试" class="headerlink" title="更全面的测试"></a>更全面的测试</h3><p>既然一个测试用例就可以保证一小段代码永远安全，那我写一堆测试岂不是可以保证整个项目永远安全吗？确实如此，这个买卖绝对是不亏的。</p><p>因此我们继续再增加几个测试，全面强化代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>tests<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>test <span class="token keyword">import</span> TestCase<span class="token keyword">import</span> datetime<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone<span class="token keyword">from</span> article<span class="token punctuation">.</span>models <span class="token keyword">import</span> ArticlePost<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token keyword">class</span> <span class="token class-name">ArticlePostModelTests</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">test_was_created_recently_with_future_article</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 若文章创建时间为未来，返回 False</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">def</span> <span class="token function">test_was_created_recently_with_seconds_before_article</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 若文章创建时间为 1 分钟内，返回 True</span>        author <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'user1'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'test_password'</span><span class="token punctuation">)</span>        author<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        seconds_before_article <span class="token operator">=</span> ArticlePost<span class="token punctuation">(</span>            author<span class="token operator">=</span>author<span class="token punctuation">,</span>            title<span class="token operator">=</span><span class="token string">'test1'</span><span class="token punctuation">,</span>            body<span class="token operator">=</span><span class="token string">'test1'</span><span class="token punctuation">,</span>            created<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>assertIs<span class="token punctuation">(</span>seconds_before_article<span class="token punctuation">.</span>was_created_recently<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">test_was_created_recently_with_hours_before_article</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 若文章创建时间为几小时前，返回 False</span>        author <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'user2'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'test_password'</span><span class="token punctuation">)</span>        author<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        hours_before_article <span class="token operator">=</span> ArticlePost<span class="token punctuation">(</span>            author<span class="token operator">=</span>author<span class="token punctuation">,</span>            title<span class="token operator">=</span><span class="token string">'test2'</span><span class="token punctuation">,</span>            body<span class="token operator">=</span><span class="token string">'test2'</span><span class="token punctuation">,</span>            created<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>assertIs<span class="token punctuation">(</span>hours_before_article<span class="token punctuation">.</span>was_created_recently<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">test_was_created_recently_with_days_before_article</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 若文章创建时间为几天前，返回 False</span>        author <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'user3'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'test_password'</span><span class="token punctuation">)</span>        author<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        months_before_article <span class="token operator">=</span> ArticlePost<span class="token punctuation">(</span>            author<span class="token operator">=</span>author<span class="token punctuation">,</span>            title<span class="token operator">=</span><span class="token string">'test3'</span><span class="token punctuation">,</span>            body<span class="token operator">=</span><span class="token string">'test3'</span><span class="token punctuation">,</span>            created<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>assertIs<span class="token punctuation">(</span>months_before_article<span class="token punctuation">.</span>was_created_recently<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在我们拥有了4个测试，来保证<code>was_created_recently()</code>方法对于<strong>过去</strong>、<strong>最近</strong>、<strong>未来</strong>中的4种情况都返回正确的值。你还可以继续扩展，直到你觉得完全没有任何bug藏匿的可能性为止。</p><p>在实际的开发中，有些难缠的bug会把自己伪装得非常的好，而不是像教程这样明确的知道它就在那里。有了自动化测试，无论以后你的项目怎么变化、app交互多么的复杂，只要在测试中写好的逻辑就一定是符合预期的，而你所需要做的只是运行一条测试指令而已。</p><blockquote><p>虽然教程中仅使用了<code>assertIs</code>，但实际上Django中的断言有大概几十种之多，比如<code>assertEqual</code>、<code>assertContains</code>等，并且还在不断更新。详见<a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase">Python标准断言</a>和<a href="https://docs.djangoproject.com/zh-hans/2.2/topics/testing/tools/#assertions">Django扩展断言</a></p></blockquote><h2 id="测试视图"><a href="#测试视图" class="headerlink" title="测试视图"></a>测试视图</h2><p>上面的测试都是针对模型的。<strong>视图</strong>该怎么测试？如何通过测试系统模拟出用户的请求呢？</p><p>答案是<code>TestCase</code>类提供了一个供测试使用的<code>Client</code>来模拟用户通过请求和视图层代码的交互。</p><p>以<strong>文章详情视图</strong>的<strong>浏览量统计</strong>为例，比较容易出现的潜在bug有：</p><ul><li>增加的浏览量未能正常保存进数据库（即每次请求则浏览量+1）</li><li>增加浏览量的同时，<code>updated</code>字段也错误的一并更新</li></ul><p>所以有针对的写2条测试。新写一个专门<strong>测试视图的类</strong>，与前面的<strong>测试模型的类</strong>区分开：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>tests<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">from</span> time <span class="token keyword">import</span> sleep<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse<span class="token keyword">class</span> <span class="token class-name">ArticlePostModelTests</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">ArtitclePostViewTests</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">test_increase_views</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 请求详情视图时，阅读量 +1</span>        author <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'user4'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'test_password'</span><span class="token punctuation">)</span>        author<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        article <span class="token operator">=</span> ArticlePost<span class="token punctuation">(</span>            author<span class="token operator">=</span>author<span class="token punctuation">,</span>            title<span class="token operator">=</span><span class="token string">'test4'</span><span class="token punctuation">,</span>            body<span class="token operator">=</span><span class="token string">'test4'</span><span class="token punctuation">,</span>            <span class="token punctuation">)</span>        article<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>assertIs<span class="token punctuation">(</span>article<span class="token punctuation">.</span>total_views<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        url <span class="token operator">=</span> reverse<span class="token punctuation">(</span><span class="token string">'article:article_detail'</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>        viewed_article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>article<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>assertIs<span class="token punctuation">(</span>viewed_article<span class="token punctuation">.</span>total_views<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">test_increase_views_but_not_change_updated_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 请求详情视图时，不改变 updated 字段</span>        author <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'user5'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'test_password'</span><span class="token punctuation">)</span>        author<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        article <span class="token operator">=</span> ArticlePost<span class="token punctuation">(</span>            author<span class="token operator">=</span>author<span class="token punctuation">,</span>            title<span class="token operator">=</span><span class="token string">'test5'</span><span class="token punctuation">,</span>            body<span class="token operator">=</span><span class="token string">'test5'</span><span class="token punctuation">,</span>            <span class="token punctuation">)</span>        article<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>        url <span class="token operator">=</span> reverse<span class="token punctuation">(</span><span class="token string">'article:article_detail'</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>        viewed_article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>article<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>assertIs<span class="token punctuation">(</span>viewed_article<span class="token punctuation">.</span>updated <span class="token operator">-</span> viewed_article<span class="token punctuation">.</span>created <span class="token operator">&lt;</span> timezone<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意看代码是如何与<strong>视图层</strong>交互的：<code>response = self.client.get(url)</code>向视图发起请求并获得了响应，剩下的就是从数据库中取出更新后的数据，并用<strong>断言</strong>语句来判断代码是否符合预期了。</p><p>运行测试：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage<span class="token punctuation">.</span>py testCreating test database <span class="token keyword">for</span> alias <span class="token string">'default'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>System check identified no issues <span class="token punctuation">(</span><span class="token number">0</span> silenced<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>Ran <span class="token number">6</span> tests <span class="token keyword">in</span> <span class="token number">0.</span>617sOKDestroying test database <span class="token keyword">for</span> alias <span class="token string">'default'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>6条测试用例全部通过。</p><h2 id="越多越好的测试"><a href="#越多越好的测试" class="headerlink" title="越多越好的测试"></a>越多越好的测试</h2><p>仅仅是app中的两个非常小的功能，就已经写了6条测试用例了，并且还可以继续扩展。除此之外，其他的每个模型、视图都可以扩展出几十甚至上百条测试，这样下去代码总量很快就要失去控制了，并且相对于业务代码来说，测试代码显得繁琐且不够优雅。</p><p><strong>但是没关系！</strong>就让测试代码继续肆意增长吧。大部分情况下，你写完一个测试之后就可以忘掉它了。在你继续开发的过程中，它会一直默默无闻地为你做贡献的。最坏的情况是当你继续开发的时候，发现之前的一些测试现在看来是多余的。但是这也不是什么问题，多做些测试也不错。</p><h2 id="深入代码测试"><a href="#深入代码测试" class="headerlink" title="深入代码测试"></a>深入代码测试</h2><p>在前面的测试中，我们已经从模型层和视图层的角度检查了应用的输入输出，但是模板呢？虽然可以用<code>assertInHTML</code>、<code>assertJSONEqual</code>等断言大致检查模板中的某些内容，但更加近似于浏览器的检查就要使用<code>Selenium</code>等测试工具（毕竟Django的重点是后端而不是前端）。</p><p><code>Selenium</code>不仅可以测试 Django 框架里的代码，甚至还可以检查 JavaScript代码。它假装成是一个正在和你站点进行交互的浏览器，就好像有个真人在访问网站一样。Django 提供了<code>LiveServerTestCase</code>来和<code>Selenium</code>这样的工具进行交互。</p><p>关于测试的话题这里只是开了个头，读者可以继续阅读下面的内容进一步了解：</p><ul><li><a href="https://docs.djangoproject.com/en/2.2/topics/testing/overview/">Django: Writing and running tests</a></li><li><a href="https://docs.djangoproject.com/en/2.2/topics/testing/tools/">Django: Testing tools</a></li><li><a href="https://docs.djangoproject.com/en/2.2/topics/testing/advanced/">Django: Advanced testing topics</a></li><li><a href="https://selenium-python.readthedocs.io/getting-started.html">Selenium官方文档</a></li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>有一帮崇尚“测试驱动”的开发者，他们开发时先写测试代码，然后才写业务代码。而普通开发者通常是先写业务代码，再写测试代码，这也是没问题的。但如果你已经写了很多业务代码了，再回头写测试确实有些无从下手，那么至少在以后写新功能时，记得加上测试。测试写得好不好，甚至比功能本身更能看出编程水平。</p><p>测试可以让代码更加强壮。项目没出bug时，皆大欢喜，有没有测试都一样；一旦出现难缠的bug，你就会无比想念一套完善的测试代码了。</p><p>博主写自己的网站时就没有对测试给与足够的重视，回想起来走了很多弯路。希望读者以前车之鉴，培养良好的编程习惯。</p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#x75;&#115;&#97;&#x69;&#x70;&#104;&#111;&#x74;&#x6f;&#x40;&#x66;&#111;&#120;&#109;&#97;&#105;&#108;&#x2e;&#99;&#x6f;&#x6d;">&#x64;&#x75;&#115;&#97;&#x69;&#x70;&#104;&#111;&#x74;&#x6f;&#x40;&#x66;&#111;&#120;&#109;&#97;&#105;&#108;&#x2e;&#99;&#x6f;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--37.日志记录</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/37.ri-zhi-ji-lu/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/37.ri-zhi-ji-lu/</url>
      
        <content type="html"><![CDATA[<p>上一章学习了自动化测试，很好，现在我们可以绞尽脑汁写出一份全面的测试，来保证代码永远健康了。</p><p>话虽如此，但是作为一个独立开发者<strong>很难写出真正全面的测试代码</strong>。这是因为用户在使用你的网站时可不会循规蹈矩，而是会以各种怪异的姿势浏览网页、上传数据。但这也不是坏事，用户就是天然的测试人员，他们会很可爱的帮你找出一大堆的bug，陪你度过难眠的夜晚（伴随着编程能力的提升）。</p><p>现在的问题是，开发者如何得知用户到底遇到了哪些问题？用户们大部分都与你素昧平生，分部在世界各地。更糟糕的是，部署在线上时由于配置了<code>DEBUG = False</code>，出错时并不会出现报错页面，连用户自己都不清楚到底是哪里有bug。</p><p>Django给你的答案：<strong>日志</strong>。</p><h2 id="日志的组成"><a href="#日志的组成" class="headerlink" title="日志的组成"></a>日志的组成</h2><p><strong>日志</strong>是指程序在运行过程中，对状态、时间、错误等的记录。即把运行过程中产生的信息输出或保存起来，供开发者查阅。</p><p>Django使用Python内置的<code>logging</code>模块处理日志。关于该模块的使用，<a href="https://docs.python.org/3/howto/logging.html">Python文档</a>里有非常详细的讨论。如果你从未用过，本文提供一个快速入门。</p><p>日志事件的信息流程如下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190716/logging_flow.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190716/logging_flow.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><blockquote><p>这个图看不懂也没关系。以后你需要深度使用日志时，会回来仔细研究它的。</p></blockquote><p>一份日志配置由<code>Loggers</code>、<code>Handlers</code>、<code>Filters</code>、<code>Formatters</code>四部分组成。</p><h3 id="Loggers"><a href="#Loggers" class="headerlink" title="Loggers"></a>Loggers</h3><p><code>Logger</code>即<strong>记录器</strong>，是日志系统的入口。<strong>它有三个重要的工作</strong>：</p><ul><li>向应用程序（也就是你的项目）公开几种方法，以便运行时记录消息</li><li>根据传递给Logger的消息的严重性，确定出需要处理的消息</li><li>将需要处理的消息传递给所有感兴趣的处理器（<code>Handler</code>）</li></ul><p>每一条写入logger的消息都是一条日志记录。每一条日志记录也包含<strong>级别</strong>，代表对应消息的严重程度。常用的级别如下：</p><ul><li><code>DEBUG</code>：排查故障时使用的低级别系统信息，通常开发时使用</li><li><code>INFO</code>：一般的系统信息，并不算问题</li><li><code>WARNING</code>：描述系统发生的小问题的信息，但通常不影响功能</li><li><code>ERROR</code>：描述系统发生的大问题的信息，可能会导致功能不正常</li><li><code>CRITICAL</code>：描述系统发生严重问题的信息，应用程序有崩溃风险</li></ul><p>当logger处理一条消息时，会将自己的日志级别和这条消息的日志级别做对比。如果消息的级别匹配或者高于logger的日志级别，它就会被进一步处理；否则这条消息就会被忽略掉。</p><p>当logger确定了一条消息需要处理之后，会把它传给<code>Handler</code>。</p><h3 id="Handlers"><a href="#Handlers" class="headerlink" title="Handlers"></a>Handlers</h3><p><code>Handler</code>即<strong>处理器</strong>，它的主要功能是<strong>决定如何处理logger中每一条消息</strong>，比如把消息输出到屏幕、文件或者Email中。</p><p>和logger一样，handler也有<strong>级别</strong>的概念。如果一条日志记录的级别不匹配或者低于handler的日志级别，则会被handler忽略。</p><p>一个logger可以有多个handler，每一个handler可以有不同的日志级别。这样就可以根据消息的重要性不同，来提供不同类型的输出。例如，你可以添加一个handler把<code>ERROR</code>和<code>CRITICAL</code>消息发到你的Email，再添加另一个 handler把所有的消息（包括<code>ERROR</code>和<code>CRITICAL</code>消息）保存到文件里。</p><h3 id="Filters"><a href="#Filters" class="headerlink" title="Filters"></a>Filters</h3><p><code>Filter</code>即<strong>过滤器</strong>。在日志记录从logger传到handler的过程中，使用<code>Filter</code>来<strong>做额外的控制</strong>。例如只允许某个特定来源的<code>ERROR</code>消息输出。</p><p>Filter还被用来在日志输出之前对日志记录做修改。例如当满足一定条件时，把日志记录从 <code>ERROR</code> 降到 <code>WARNING</code> 级别。</p><p>Filter在logger和handler中都可以添加；多个filter可以链接起来使用，来做多重过滤操作。</p><h3 id="Formatters"><a href="#Formatters" class="headerlink" title="Formatters"></a>Formatters</h3><p><code>Formatter</code>即格式化器，主要功能是<strong>确定最终输出的形式和内容</strong>。</p><h2 id="日志配置示例"><a href="#日志配置示例" class="headerlink" title="日志配置示例"></a>日志配置示例</h2><p>说了这么多脑壳都说晕了，接下来看两个示例。</p><h3 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h3><p>在Django中可以通过字典的形式对整个项目的日志进行配置，配置的位置当然是在<code>settings.py</code>中了。一个简单的配置如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">import</span> osLOGGING <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'version'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token string">'disable_existing_loggers'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>    <span class="token string">'handlers'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">'file'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'level'</span><span class="token punctuation">:</span> <span class="token string">'DEBUG'</span><span class="token punctuation">,</span>            <span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'logging.FileHandler'</span><span class="token punctuation">,</span>            <span class="token string">'filename'</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'logs/debug.log'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token string">'loggers'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">'django'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'handlers'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token string">'level'</span><span class="token punctuation">:</span> <span class="token string">'DEBUG'</span><span class="token punctuation">,</span>            <span class="token string">'propagate'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>字典中的<code>version</code>指明了配置的版本；<code>disable_existing_loggers</code>指明是否禁止默认配置的记录器。这两项通常不需要去改动，重点看下<code>loggers</code>和<code>handlers</code>的配置：</p><ul><li>如前面说，一条消息首先传递给logger。Django中内置了几种记录器，比如这里用到的<code>Django</code>记录器，它会接收Django层次结构中的所有消息。然后我们定义了需要处理<code>DEBUG</code>以上级别的消息，并把这些消息传递给名叫<code>file</code>的处理器。<code>&#39;propagate&#39;: True</code>意思是本记录器处理过的消息其他处理器也可以继续处理。</li><li>现在消息来到名叫<code>file</code>的<code>handlers</code>中了。这个处理器定义了消息处理级别仍然为DEBUG，在class中定义将消息输出到文件中去，文件地址为项目目录的<code>logs/debug.log</code>。</li><li>因为这里没有配置<code>filters</code>和<code>formatters</code>，因此会采用默认的设置。</li></ul><p>需要注意的是日志的输出文件的目录<code>logs/</code>一定要提前创建好，并且确保项目拥有此目录的写入权限。</p><p>这个日志系统就配置好了！接下来运行项目，随便刷新几个页面看看<code>debug.log</code>中有没有写入消息：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">logs<span class="token operator">/</span>debug<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">0.001</span><span class="token punctuation">)</span>             SELECT name<span class="token punctuation">,</span> <span class="token builtin">type</span> FROM sqlite_master            WHERE <span class="token builtin">type</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">,</span> <span class="token string">'view'</span><span class="token punctuation">)</span> AND NOT name<span class="token operator">=</span><span class="token string">'sqlite_sequence'</span>            ORDER BY name<span class="token punctuation">;</span> args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">(</span><span class="token number">0.000</span><span class="token punctuation">)</span> SELECT <span class="token string">"django_migrations"</span><span class="token punctuation">.</span><span class="token string">"app"</span><span class="token punctuation">,</span> <span class="token string">"django_migrations"</span><span class="token punctuation">.</span><span class="token string">"name"</span> FROM <span class="token string">"django_migrations"</span><span class="token punctuation">;</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>debug.log</code>文件中出现了一大堆冗长的信息，因为<code>DEBUG</code>级别会包含所有的数据库查询记录。</p><blockquote><p>默认情况下，仅在调试模式下才会显示<code>DEBUG</code>级别的消息日志，部署在线上时只会将<code>INFO</code>或以上的信息进行记录。</p></blockquote><p>再试试别的。把上面代码中记录器和处理器的日志级别都改为<code>INFO</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">LOGGING <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token string">'handlers'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">'file'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'level'</span><span class="token punctuation">:</span> <span class="token string">'INFO'</span><span class="token punctuation">,</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token string">'loggers'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">'django'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'level'</span><span class="token punctuation">:</span> <span class="token string">'INFO'</span><span class="token punctuation">,</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再刷新几次界面，看看输出的内容：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token string">"GET /article/article-list/ HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">14438</span><span class="token string">"GET /article/article-detail/32/ HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">33364</span><span class="token string">"GET /accounts/login/ HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">7180</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这次清爽多了，输出的主要是页面的拉取信息。</p><p>让我们再看看<code>ERROR</code>信息长什么样的。在地址栏输入一个不存在的文章详情页面地址：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http://127.0.0.1:8000/article/article-detail/9999/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>很明显这会得到一个数据不存在的报错：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">Internal Server Error<span class="token punctuation">:</span> <span class="token operator">/</span>article<span class="token operator">/</span>article<span class="token operator">-</span>detail<span class="token operator">/</span><span class="token number">9999</span><span class="token operator">/</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"E:\django_project\env\lib\site-packages\django\core\handlers\exception.py"</span><span class="token punctuation">,</span> line <span class="token number">34</span><span class="token punctuation">,</span> <span class="token keyword">in</span> inner    response <span class="token operator">=</span> get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>article<span class="token punctuation">.</span>models<span class="token punctuation">.</span>ArticlePost<span class="token punctuation">.</span>DoesNotExist<span class="token punctuation">:</span> ArticlePost matching query does <span class="token keyword">not</span> exist<span class="token punctuation">.</span><span class="token string">"GET /article/article-detail/9999/ HTTP/1.1"</span> <span class="token number">500</span> <span class="token number">80792</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ERROR</code>日志输出了整个bug的回溯，和你在浏览器中的报错是完全一样的，这些信息就非常的有用了。基本上<code>ERROR</code>信息能够暴露出用户在使用你的网站过程中的大部分问题；也就是说每一个<code>ERROR</code>都是需要你去解决掉的。<code>ERROR</code>信息的<strong>错误码</strong>通常都是“500”，也就是<strong>服务器内部错误</strong>的代码。</p><p>不过仔细想想，似乎找不到对应的资源在很多时候并不是bug，而是用户在输入url时自己犯了错误。所以我们把文章详情视图的<code>ArticlePost.objects.get(id=id)</code>改成<code>get_object_or_404(ArticlePost, id=id)</code>试试：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> get_object_or_404<span class="token keyword">def</span> <span class="token function">article_detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 取出相应的文章</span>    <span class="token comment"># article = ArticlePost.objects.get(id=id)</span>    article <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>ArticlePost<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>服务器重启后再次刷新一个不存在的页面，看看日志：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">Not Found<span class="token punctuation">:</span> <span class="token operator">/</span>article<span class="token operator">/</span>article<span class="token operator">-</span>detail<span class="token operator">/</span><span class="token number">9999</span><span class="token operator">/</span><span class="token string">"GET /article/article-detail/9999/ HTTP/1.1"</span> <span class="token number">404</span> <span class="token number">1780</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>现在它不是一条<code>ERROR</code>信息了，而是变为了<code>WARNING</code>，所以也没有了错误回溯（错误码也由 500 变成了 404）。这里就能看出这两个方法的重要区别了；在项目中到底选择哪个没有定论，还是以你的具体需求决定。</p><h3 id="复杂示例"><a href="#复杂示例" class="headerlink" title="复杂示例"></a>复杂示例</h3><p>接下来再看一个复杂的日志配置：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">LOGGING <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'version'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token string">'disable_existing_loggers'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>    <span class="token string">'formatters'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">'verbose'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'format'</span><span class="token punctuation">:</span> <span class="token string">'&#123;levelname&#125; &#123;asctime&#125; &#123;module&#125; &#123;process:d&#125; &#123;thread:d&#125; &#123;message&#125;'</span><span class="token punctuation">,</span>            <span class="token string">'style'</span><span class="token punctuation">:</span> <span class="token string">'&#123;'</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token string">'simple'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'format'</span><span class="token punctuation">:</span> <span class="token string">'&#123;levelname&#125; &#123;message&#125;'</span><span class="token punctuation">,</span>            <span class="token string">'style'</span><span class="token punctuation">:</span> <span class="token string">'&#123;'</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token string">'filters'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">'require_debug_true'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'()'</span><span class="token punctuation">:</span> <span class="token string">'django.utils.log.RequireDebugTrue'</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token string">'handlers'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">'console'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'level'</span><span class="token punctuation">:</span> <span class="token string">'INFO'</span><span class="token punctuation">,</span>            <span class="token string">'filters'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'require_debug_true'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'logging.StreamHandler'</span><span class="token punctuation">,</span>            <span class="token string">'formatter'</span><span class="token punctuation">:</span> <span class="token string">'simple'</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token string">'mail_admins'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'level'</span><span class="token punctuation">:</span> <span class="token string">'ERROR'</span><span class="token punctuation">,</span>            <span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'django.utils.log.AdminEmailHandler'</span><span class="token punctuation">,</span>            <span class="token string">'formatter'</span><span class="token punctuation">:</span> <span class="token string">'verbose'</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token string">'file'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'level'</span><span class="token punctuation">:</span> <span class="token string">'WARNING'</span><span class="token punctuation">,</span>            <span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'logging.FileHandler'</span><span class="token punctuation">,</span>            <span class="token string">'filename'</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'logs/debug.log'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string">'formatter'</span><span class="token punctuation">:</span> <span class="token string">'verbose'</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token string">'loggers'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token string">'django'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'handlers'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'console'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token string">'propagate'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token string">'django.request'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">'handlers'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">,</span> <span class="token string">'mail_admins'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token string">'level'</span><span class="token punctuation">:</span> <span class="token string">'WARNING'</span><span class="token punctuation">,</span>            <span class="token string">'propagate'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>让我们来分解一下此配置。</p><p>配置中定义了<strong>两个格式化器</strong>：</p><ul><li><code>verbose</code>：详细的格式化器，依次输出：消息级别、发生时间、抛出模块、进程ID、线程ID、提示信息</li><li><code>simple</code>：简要的格式化器，仅输出消息级别和提示信息</li></ul><p><strong>一个过滤器</strong>：</p><ul><li><code>require_debug_true</code>：使用此过滤器的消息仅在调试时才会生效</li></ul><p><strong>三个处理器</strong>：</p><ul><li><code>console</code>：处理<code>INFO</code>以上级别消息，输出简要信息到命令行中；此处理器仅在调试模式生效</li><li><code>mail_admins</code>：处理<code>ERROR</code>以上级别消息，输出详细信息到Email中</li><li><code>file</code>：处理<code>WARNING</code>以上级别消息，输出详细信息到文件中</li></ul><p><strong>两个记录器</strong>：</p><ul><li><code>django</code>：将django产生的所有消息转交给<code>console</code>处理器</li><li><code>django.request</code>：将网络请求相关消息转交给<code>file</code>、<code>mail_admins</code>这两个处理器。注意这里的<code>&#39;propagate&#39;: False</code>使得此记录器处理过的消息就不再让<code>django</code>记录器再次处理了</li></ul><p>读者可以尝试制造不同级别的消息，看看日志系统是否正常工作。当然最重要的，跟Email有关的配置一定要事先把Email给设置好，即下面的内容填成你的：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># SMTP服务器</span>EMAIL_HOST <span class="token operator">=</span> <span class="token string">'your smtp'</span><span class="token comment"># 邮箱名</span>EMAIL_HOST_USER <span class="token operator">=</span> <span class="token string">'your email'</span><span class="token comment"># 邮箱密码</span>EMAIL_HOST_PASSWORD <span class="token operator">=</span> <span class="token string">'your password'</span><span class="token comment"># 发送邮件的端口</span>EMAIL_PORT <span class="token operator">=</span> <span class="token number">25</span><span class="token comment"># 是否使用 TLS</span>EMAIL_USE_TLS <span class="token operator">=</span> <span class="token boolean">True</span><span class="token comment"># 默认的发件人</span>DEFAULT_FROM_EMAIL <span class="token operator">=</span> <span class="token string">'your email'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="日志分割"><a href="#日志分割" class="headerlink" title="日志分割"></a>日志分割</h3><p>现在我们已经可以愉快的记录日志了，接下来一个问题是如何去<strong>分割日志</strong>？假设你的网站能够有幸运行十年时间，如果不间断的往同一个文件中写日志信息，最终它会变成一个拖垮服务器的庞然大物。</p><p>最好是日志能够按自然天进行记录和分割。好在这个问题也不需要你去费脑筋，Python帮你搞定了。</p><p>只需要把处理器稍稍改一下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>LOGGING <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token string">'handlers'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token string">'file'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment"># 注释掉 class</span>            <span class="token comment"># 'class': 'logging.FileHandler',</span>                        <span class="token comment">#新增内容</span>            <span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">'logging.handlers.TimedRotatingFileHandler'</span><span class="token punctuation">,</span>            <span class="token string">'when'</span><span class="token punctuation">:</span> <span class="token string">'midnight'</span><span class="token punctuation">,</span>            <span class="token string">'backupCount'</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>TimedRotatingFileHandler</code>：Python内置的随时间分割日志文件的模块</li><li><code>when</code>：分割时间为凌晨</li><li><code>backupCount</code>：日志文件保存日期为30天</li></ul><p>接下来把系统时间往后调一天，然后重新启动服务器：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python manage.py runserver --noreload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>注意这次启动有点不一样</strong>，后面有个<code>--noreload</code>后缀。这是因为通常Django的调试服务器运行时会顺带启动重载器，所以每当重载器检测到代码有变化后，会自动重启服务器，相当的方便。但问题是分割文件与重载器同时操作日志文件会产生冲突，因此这里一定要用<code>--noreload</code>暂时将重载器禁止掉。</p><p>然后就可以愉快的刷几条消息到文件中啦。你会发现老日志已经更名为<code>debug.log.2019-07-17</code>了，而刚刷的新消息则保存在<code>debug.log</code>中。</p><blockquote><p>除了上面介绍的<code>TimedRotatingFileHandler</code>，Python还提供了一个按照文件大小分割的<code>RotatingFileHandler</code>。有兴趣的看<a href="https://docs.python.org/3/library/logging.handlers.html#logging.handlers.RotatingFileHandler">Python官方文档</a></p></blockquote><h2 id="自定义日志"><a href="#自定义日志" class="headerlink" title="自定义日志"></a>自定义日志</h2><p>内置配置实际上已经能够满足90%以上的日志需求了，但总有时候你想在一些奇怪的地方进行记录，这就需要你自己在代码中插入自定义的日志记录代码了。</p><p>自定义日志用起来也是相当方便的：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> my_blog<span class="token punctuation">.</span>settings <span class="token keyword">import</span> LOGGING<span class="token keyword">import</span> logginglogging<span class="token punctuation">.</span>config<span class="token punctuation">.</span>dictConfig<span class="token punctuation">(</span>LOGGING<span class="token punctuation">)</span>logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">'django.request'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">whatever</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># do something</span>    logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Something went wrong!'</span><span class="token punctuation">)</span>    <span class="token comment"># do something else</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>导入刚才写的日志框架并将<code>django.request</code>配置到<code>logger</code>对象中。然后你就可以在任何地方安插任何级别的消息了。消息内容可以用字符串的格式化方法（<code>str.format()</code>），玩出各种花样。</p><p>关于日志的入门介绍就到此为止了，想深入学习的读者请继续阅读本文的参考文章：</p><ul><li><a href="https://docs.djangoproject.com/en/2.2/topics/logging/">Django logging</a></li><li><a href="https://docs.python.org/3/library/logging.html">Python 3 logging</a></li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>和上章类似，本章的内容也是概念偏多，希望读者尽可能去理解，最起码要囫囵吞枣的把日志成功移植到你的项目中去。<strong>获取一份好的日志，有时候远比开发一个无关紧要的新功能更重要。</strong></p><p>比较起来博主认为对博客项目来说，日志比测试还重要，毕竟用户的使用体验是最佳的实践。</p><p>但请不要误会我的意思。测试和日志就像两兄弟，测试解决开发中的问题，日志解决维护中的问题。有机的结合起来，你的项目才能够长期稳定健康。</p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#117;&#115;&#x61;&#105;&#x70;&#x68;&#111;&#116;&#x6f;&#x40;&#x66;&#111;&#120;&#x6d;&#97;&#x69;&#108;&#46;&#99;&#111;&#x6d;">&#100;&#117;&#115;&#x61;&#105;&#x70;&#x68;&#111;&#116;&#x6f;&#x40;&#x66;&#111;&#120;&#x6d;&#97;&#x69;&#108;&#46;&#99;&#111;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--39.点赞功能</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/39.dian-zan-gong-neng/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/39.dian-zan-gong-neng/</url>
      
        <content type="html"><![CDATA[<p>假设你的博客已经顺利部署到了线上。你写了很多好文章，和粉丝们互动并感受成就感。</p><p>现在你想更进一步，努力提高文章质量，使其更受读者欢迎，打造圈内一流博客。问题是该如何判断一篇文章是“受欢迎的”？靠浏览量是个方法，但是并不能区分出内容花拳绣腿的标题党。靠评论数也是个好方法，但个人博客通常读者不多，好文章零评论是很正常的。</p><p>这时候<strong>“点赞”</strong>功能就显得重要了。如果大部分读者都给了一个赞，那就表明文章确实还不错。</p><h2 id="动手之前的思考"><a href="#动手之前的思考" class="headerlink" title="动手之前的思考"></a>动手之前的思考</h2><p>点赞功能可不简单，实现途径非常的多。别急着动手，耐心思考：我们的博客到底需要什么样的点赞？</p><p><strong>首先，点赞是否要求用户必须登录？</strong>要求登录的好处是可以精确的记录是哪些用户、对哪些文章点过赞（多对多关系），以便进行细致的数据分析。坏处是登录这个要求很笨重，会屏蔽掉大部分的游客用户。博主倾向于不要求用户登录，毕竟小站通常用户就不多，提高参与度才是点赞最核心的任务。</p><blockquote><p>如果某天你的小站火了，就把要求用户登录的交互功能让给“收藏”吧！</p></blockquote><p><strong>其次，用户是否可以重复点赞？</strong>很多视频平台的用户可以对某个喜欢的女主播疯狂点赞，以表达自己非常非常的喜欢。这对用户较多的平台是没问题的，因为用户数量多了之后，你点几百个赞也只是九牛一毛。但博客网站这样做很容易造成某些文章点赞为零，某些文章点赞数又出奇的高。显然这不代表文章质量的差异。</p><p>好了，目前我们的策略是不要求用户登录，也不允许用户重复点赞。<strong>下一个问题是，在哪里记录用户的点赞相关的数据呢？</strong>点赞数量毫无疑问要保存在数据库里，以便随时取出数据并呈现出来。</p><p>但问题是<strong>校验用户是否已点赞的记录保存在哪？</strong>在数据库中记录用户的IP地址是个方法，但你得处理好记录IP和记录登录用户的关系，稍微有点麻烦。另外每次用户的点赞都需要向后端发送校验请求，增加了服务器的负担。</p><p>既然数据保存在后端数据库里不好，<strong>那能不能保存在浏览器端呢？</strong>答案是可以的，并且有 <strong>Cookie</strong> 和 <strong>LocalStorage</strong> 都可以让你保存数据。它两的主要区别如下：</p><table><thead><tr><th>特性</th><th align="left">Cookie</th><th>LocalStorage</th></tr></thead><tbody><tr><td>生命周期</td><td align="left">可设置失效时间，默认是关闭浏览器后失效</td><td>除非被清除，否则永久保存</td></tr><tr><td>存储空间</td><td align="left">4K左右</td><td>一般为5MB</td></tr><tr><td>与服务器通信</td><td align="left">每次都会携带在HTTP头中</td><td>不参与服务器的通信</td></tr><tr><td>易用性</td><td align="left">源生接口不友好</td><td>源生接口可以接受</td></tr></tbody></table><p>比较下来会发现 LocalStorage 可以永久保存数据，存储空间大，也不参与服务器通信，很适合点赞的需求。由于数据保存在浏览器中，所以也不需要区分用户有没有登录了：实际上每次请求点赞时，校验的是当前这个浏览器是否已经点过赞了，而不是用户！</p><p>可能你会反驳说，那要是用户换一个浏览器不就可以重复点赞了吗，更何况浏览器端的数据是非常容易篡改的。但这又有什么关系呢？点赞数据并不需要非常精确，随他去吧。</p><blockquote><p>所有的现代浏览器都支持 LocalStorage 功能。如果你还在用 IE6 ，赶紧考虑升级浏览器吧。</p></blockquote><p>总结一下，我们的点赞功能如下：</p><ul><li>不要求用户登录</li><li>不允许重复点赞</li><li>点赞数保存在服务器数据库中</li><li>点赞校验数据保存在浏览器的 LocalStorage 中</li></ul><p>当用户点赞时，前端脚本会在 LocalStorage 里校验是否已经点过赞了；如未点过赞，才会向服务器发送点赞请求，并记录数据。</p><p>想清楚需求，难题就迎刃而解了。接下来就是代码实现。</p><blockquote><p>需要说明的是，以上分析并不代表其他方法不好，仅仅是在博客小站的环境下，博主觉得合适的技术路径而已。如果你心中住着另一个哈姆雷特，请想办法去实现它。</p></blockquote><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>本章的重点工作在前端，因此先把简单的后端代码写了，权当热身。</p><blockquote><p>有的读者听到前端就觉得头疼。你的痛苦我明白，但也是必不可少的。光写 Python 是做不出漂亮网站的。</p></blockquote><p>由于点赞数需要保存在数据库中，因此修改文章模型是必须的了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>models<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 文章模型</span><span class="token keyword">class</span> <span class="token class-name">ArticlePost</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 新增点赞数统计</span>    likes <span class="token operator">=</span> models<span class="token punctuation">.</span>PositiveIntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>迁移数据：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage.py makemigrations<span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> python manage.py migrate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>继续用类视图：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 点赞数 +1</span><span class="token keyword">class</span> <span class="token class-name">IncreaseLikesView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        article<span class="token punctuation">.</span>likes <span class="token operator">+=</span> <span class="token number">1</span>        article<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>功能是让点赞数增加1个，并且返回 <code>success</code> 。至于为什么是 <code>success</code> 后面再讲。</p><p>最后就是路由了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 点赞 +1</span>    path<span class="token punctuation">(</span>        <span class="token string">'increase-likes/&lt;int:id>/'</span><span class="token punctuation">,</span>         views<span class="token punctuation">.</span>IncreaseLikesView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         name<span class="token operator">=</span><span class="token string">'increase_likes'</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>很简单吧。剩下的就是专心写前端代码了。</p><h3 id="JS与Ajax"><a href="#JS与Ajax" class="headerlink" title="JS与Ajax"></a>JS与Ajax</h3><p>由于校验数据保存在浏览器中，因此前端的工作较多。</p><p>先把完整代码贴出来（讲解在后面）：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token comment">&lt;!-- 已有代码，文章正文 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>&#123;&#123; article.body|safe &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- 新增点赞按钮 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-align</span><span class="token punctuation">:</span>center<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-outline-danger<span class="token punctuation">"</span></span>            <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span>            <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">validate_is_like</span><span class="token punctuation">(</span>                     <span class="token string">'&#123;% url '</span>article<span class="token operator">:</span>increase_likes<span class="token string">' article.id %&#125;'</span><span class="token punctuation">,</span>                     <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> article<span class="token punctuation">.</span>id <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                     <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> article<span class="token punctuation">.</span>likes <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>                     <span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span>            <span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>点赞<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fas fa-heart<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>likes_number<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            &#123;&#123; article.likes &#125;&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...&#123;% block script %&#125;...<span class="token comment">&lt;!-- 以下均为新代码 --></span><span class="token comment">&lt;!-- csrf token --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>csrf.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token comment">// 点赞功能主函数</span>    <span class="token keyword">function</span> <span class="token function">validate_is_like</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> id<span class="token punctuation">,</span> likes</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 取出 LocalStorage 中的数据</span>        <span class="token keyword">let</span> storage <span class="token operator">=</span> window<span class="token punctuation">.</span>localStorage<span class="token punctuation">;</span>        <span class="token keyword">const</span> storage_str_data <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">"my_blog_data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> storage_json_data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>storage_str_data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 若数据不存在，则创建空字典</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>storage_json_data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            storage_json_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token comment">// 检查当前文章是否已点赞。是则 status = true</span>        <span class="token keyword">const</span> status <span class="token operator">=</span> <span class="token function">check_status</span><span class="token punctuation">(</span>storage_json_data<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            layer<span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token string">'已经点过赞了哟~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 点过赞则立即退出函数</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 用 Jquery 找到点赞数量，并 +1</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'span#likes_number'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>likes <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'color'</span><span class="token punctuation">,</span> <span class="token string">'#dc3545'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 用 ajax 向后端发送 post 请求</span>        $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>            url<span class="token punctuation">,</span>            <span class="token comment">// post 只是为了做 csrf 校验，因此数据为空</span>            <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">===</span> <span class="token string">'success'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token comment">// 尝试修改点赞数据</span>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                        storage_json_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                    <span class="token comment">// 将字典转换为字符串，以便存储到 LocalStorage</span>                    <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>storage_json_data<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 尝试存储点赞数据到 LocalStorage</span>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                        storage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"my_blog_data"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token comment">// code 22 错误表示 LocalStorage 空间满了</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">22</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            storage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"my_blog_data"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    layer<span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token string">"与服务器通信失败..过一会儿再试试呗~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token comment">// 辅助点赞主函数，验证点赞状态</span>    <span class="token keyword">function</span> <span class="token function">check_status</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 尝试查询点赞状态</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token keyword">in</span> data <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>&#123;% endblock script %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码内容很多，接下来拆分讲解。</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- 新增点赞代码 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-align</span><span class="token punctuation">:</span>center<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-outline-danger<span class="token punctuation">"</span></span>            <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span>            <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">validate_is_like</span><span class="token punctuation">(</span>                     <span class="token string">'&#123;% url '</span>article<span class="token operator">:</span>increase_likes<span class="token string">' article.id %&#125;'</span><span class="token punctuation">,</span>                     <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> article<span class="token punctuation">.</span>id <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                     <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> article<span class="token punctuation">.</span>likes <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>                     <span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span>            <span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>点赞<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fas fa-heart<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>likes_number<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            &#123;&#123; article.likes &#125;&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的 HTML 代码功能很简单，提供一个点赞的按钮，点击此按钮时会触发叫做<code>validate_is_like</code>的 JavaScript 函数。<strong>特别需要注意</strong>的是 <code>&#39;&#123;% url 'article:increase_likes' article.id %&#125;&#39;</code> 都是用的单引号，这里千万不能用双引号，原因请读者思考一下。</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>csrf.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>还记得<a href="https://github.com/stacklens/django_blog_tutorial/blob/master/static/csrf.js">csrf.js</a>吗？我们在多级评论章节已经将它引入了，目的是让 Ajax 也能通过 csrf 校验。如果还没有这个文件的请点击链接下载。</p><p>接下来就是占据最多版面的函数<code>validate_is_like()</code>，我们来拆分里面的内容。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 取出 LocalStorage 中的数据</span><span class="token keyword">let</span> storage <span class="token operator">=</span> window<span class="token punctuation">.</span>localStorage<span class="token punctuation">;</span><span class="token keyword">const</span> storage_str_data <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">"my_blog_data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> storage_json_data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>storage_str_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 若数据不存在，则创建空字典</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>storage_json_data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    storage_json_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>浏览器里面， <code>window</code> 对象指当前的浏览器窗口。它也是当前页面的顶层对象（即最高一层的对象），所有其他对象都是它的下属，<code>localStorage</code> 也是如此。</p><p>要校验数据，首先必须取出数据。这里用<code>localStorage.getItem()</code>接口取出了数据。</p><p>虽然 LocalStorage 的存储方式为标准的<strong>键值对</strong>类型（类似Python的字典），但是很怪的是存储的值只支持字符串类型。所以这里要用 <code>JSON.parse()</code> 将字符串还原为对象。</p><p>用户第一次点赞时，LocalStorage 中肯定是没有任何数据的，所以 <code>if</code> 语句的作用是创建一个空的字典待用。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 检查当前文章是否已点赞。是则 status = true</span><span class="token keyword">const</span> status <span class="token operator">=</span> <span class="token function">check_status</span><span class="token punctuation">(</span>storage_json_data<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    layer<span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token string">'已经点过赞了哟~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 点过赞则立即退出函数</span>    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 用 Jquery 找到点赞数量，并 +1</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'span#likes_number'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>likes <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'color'</span><span class="token punctuation">,</span> <span class="token string">'#dc3545'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来马上调用函数 <code>check_status</code> 检查用户是否已经对本文点过赞了。如果点过了，就弹窗提示，并且用 <code>return</code> 马上终止 <code>validate_is_like</code> 函数，<strong>后面的代码就不执行了</strong>；如果还没点过，就让按钮的点赞数 +1。</p><p>但这时候其实后台数据库的点赞数并没有更新。接着往下看。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 用 ajax 向后端发送 post 请求</span>$<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>    url<span class="token punctuation">,</span>    <span class="token comment">// post 只是为了做 csrf 校验，因此数据为空</span>    <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">===</span> <span class="token string">'success'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 尝试修改点赞数据</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                storage_json_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>            <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>storage_json_data<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 尝试存储点赞数据到 LocalStorage</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                storage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"my_blog_data"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// code 22 错误表示 LocalStorage 空间满了</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">22</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    storage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"my_blog_data"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            layer<span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token string">"与服务器通信失败..过一会儿再试试呗~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里开始尝试与后端通信并更新点赞数。整块代码被 <code>$.post()</code> 包裹，它其实就是 Ajax 的 post 请求。<code>function(result) &#123;...&#125;</code> 是请求成功时才执行的回调函数，参数 <code>result</code> 是后端的返回值。如果通信成功，则尝试将点赞的校验数据保存到 LocalStorage 中。期间发生任何错误（特别是 LocalStorage 存储已满的错误），都会清除 LocalStorage 中的所有数据，以便后续的数据记录。</p><p>可以看出，博主采用的数据结构比较简单，像这样：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span>    <span class="token number">2</span><span class="token punctuation">:</span> true<span class="token punctuation">,</span>    <span class="token number">31</span><span class="token punctuation">:</span> true    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>键代表文章的 <code>id</code>，布尔值代表点赞的状态。上面数据的意思是 <code>id</code> 为 2 和 31 的文章已经点过赞了。读者以后可能会希望文章、评论以及其他内容都可以点赞，那就需要设计更加复杂的数据结构。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 辅助点赞主函数，验证点赞状态</span><span class="token keyword">function</span> <span class="token function">check_status</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 尝试查询点赞状态</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token keyword">in</span> data <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>至于 <code>check_status()</code> 函数就很简单了，作用是查询是否已经点过赞了，是则返回 true，否则返回 false。</p><p>整个 JavaScript 脚本就完成了。</p><h3 id="调试接口"><a href="#调试接口" class="headerlink" title="调试接口"></a>调试接口</h3><p>读者在调试时可能会出现各种问题，请按 <code>Ctrl + Shift + I</code> 打开浏览器控制台的 <code>Console</code> 界面，利用以下命令 debug：</p><ul><li>localStorage：查看 LocalStorage 的数据</li><li>localStorage.clear()：清除所有数据</li><li>localStorage.getItem()：获取某个数据</li><li>localStorage.setItem()：保存某个数据</li></ul><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>代码讲完了，接下来就打开文章详情页面测试一下：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190905/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE234.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190905/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE234.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击点赞按钮，点赞数 +1；再次点击点赞按钮，点赞数不会增加，并且会弹窗提示用户已经点过了。</p><p>你可以随意尝试关闭页面或浏览器，保存的点赞校验数据是不会消失的。</p><p>这样就完成了一个简单的点赞功能。</p><p>当然还可以继续往下优化：</p><ul><li>没点赞的爱心应该显示为灰色，点过的显示为红色，这样才人性化</li><li>最好再来一点酷炫的点赞动画，或者提示性文字</li><li>要不要给被点赞人发一条通知信息呢？</li><li>…</li></ul><p>教程篇幅有限，不打算再深入下去了，就当做读者朋友的课后作业吧，要用心完成哦。<strong>给你点赞！</strong></p><blockquote><p>第一条的提示：初始加载页面时，爱心统一显示为灰色，然后调用 JavaScript 脚本比对 LocalStorage 中的数据，灵活运用 Jquery ，将点过赞的爱心颜色修改为红色。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们的博客项目现在拥有了层次分明的用户交互结构：浏览量数据最轻巧，评价文章类型的受欢迎度；点赞数据比较平衡，评价文章内容的受欢迎度；评论数据最笨重，但价值也最高。读者以后在开发功能的时候，也要像这样把核心需求想清楚才行。</p><p>另一个需要提出的是，只有非敏感、不重要的数据才保存在 LocalStorage，不要对它太过依赖。</p><p>再一次提醒，教程为了便于讲解，代码文件已经变得越来越庞大。请在适当的时候把它分割成多个更小的组件，方便维护和重用。</p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#x75;&#115;&#x61;&#x69;&#x70;&#104;&#111;&#116;&#111;&#64;&#102;&#111;&#120;&#109;&#x61;&#x69;&#108;&#46;&#99;&#x6f;&#109;">&#100;&#x75;&#115;&#x61;&#x69;&#x70;&#104;&#111;&#116;&#111;&#64;&#102;&#111;&#120;&#109;&#x61;&#x69;&#108;&#46;&#99;&#x6f;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--40.将项目部署到云服务器</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/40.jiang-xiang-mu-bu-shu-dao-yun-fu-wu-qi/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/40.jiang-xiang-mu-bu-shu-dao-yun-fu-wu-qi/</url>
      
        <content type="html"><![CDATA[<p>我们的博客虽然还有很多不完善的地方，但是没关系，越早把它部署到互联网上，才能越早发现线上特有的问题。现在也提倡渐进式开发，让产品在迭代中快速成长。</p><p>部署考验的不是你的 Django 编程水平，而是你对 Linux 的操作能力，以及对网络通信的理解。多说无益，直接开干！</p><h2 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h2><p>要架设网站，首先你要有一台连接到互联网的服务器。国内比较出名的云服务器属<strong>阿里云</strong>、<strong>腾讯云</strong>、<strong>百度云</strong>，三家各有优劣，大家自行了解比较，并选择自己适合的购买。</p><p><strong>利益相关：</strong>博主自己用的是阿里云，所以教程会以<strong>阿里云ECS</strong>作为例子讲解。新用户通过<a href="https://www.aliyun.com/product/ecs?source=5176.11533457&userCode=m3bbolgr&type=copy">推广链接</a>注册有折扣和现金券（目前是20元）；学生有<a href="https://promotion.aliyun.com/ntms/act/campus2018.html?source=5176.11533457&userCode=m3bbolgr&type=copy">优惠服务器</a>每月9.5元，性能还不错，很划算。如果你想用其他云服务器，操作流程也差不多，不必担心。</p><p>首先进入<strong>阿里云ECS的购买页面</strong>：</p><p><img src="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28249%29.png" class="lazyload placeholder" data-srcset="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28249%29.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>图片字很小，看不清楚的同学将就一下放大看吧。</p><p>挑重点说一下：</p><ul><li><strong>实例</strong>从入门级里选一款便宜的，以后流量高了再升级也不迟（土豪请无视这条）。</li><li><strong>镜像</strong>选择 Ubuntu 16.04 64位。其他 Linux 版本也是可以的。</li><li><strong>系统盘</strong>先选个 20G，够你用一阵了。数据盘暂时用不上，不用勾选。</li></ul><p>点击下一步，来到<strong>网络和安全组</strong>页面：</p><p><img src="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28250%29.png" class="lazyload placeholder" data-srcset="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28250%29.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>这页默认就行了，公网带宽选最低的 1M ，初期够用了。</p><p>点击下一步，到<strong>系统配置</strong>页面：</p><p><img src="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28241%29.png" class="lazyload placeholder" data-srcset="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28241%29.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>为了后面远程连接服务器更简单，这里勾选<strong>自定义密码</strong>，也就是输入用户/密码的认证方式了。实际上秘钥对的认证方式更安全些，以后摸熟了再改回来吧。</p><p>点击下一步，到<strong>分组设置</strong>页面。这个页面全部默认设置就好了。点击下一步，<strong>确认订单</strong>无误后，就可以付款啦。</p><p>付款成功后，通过控制台就可以看到已购买的云服务器了：</p><p><img src="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28243%29.png" class="lazyload placeholder" data-srcset="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28243%29.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>这里有时候会有黄字提醒你服务器的网络端口没开，点击黄字链接去开通一下：</p><p><img src="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28244%29.png" class="lazyload placeholder" data-srcset="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28244%29.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>把 22（远程连接端口）、443（HTTPS端口）、80（HTTP端口）都打开，3389端口顺便也开了。</p><p>至此服务器的购买、配置就完成啦。稍等几分钟后等待初始化完成，就可以得到服务器的<strong>公网 IP 地址</strong>，博主的是 <code>118.31.35.48</code> ，后面会用到。</p><p>接下来就是正式的部署。</p><h2 id="正式部署"><a href="#正式部署" class="headerlink" title="正式部署"></a>正式部署</h2><p>开发时我们用的是 Django 自带的开发服务器，但那个性能太差了，不可能用到线上环境。所以线上部署时，我们不仅要安装 <code>Django</code>，还要安装 <code>Nginx</code> 和 <code>Gunicorn</code>，这三兄弟的工作流程如下：</p><ul><li>客户端发来 http 请求，Nginx 作为直接对外的服务器接口，对 http 请求进行分析</li><li>如果是静态资源请求，则由Nginx自己处理（效率极高）</li><li>如果是动态资源请求，则把它转发给 Gunicorn</li><li>Gunicorn 对请求进行预处理后，转发给 Django，最终完成资源的返回</li></ul><p>如果用餐馆来做比喻的话，Nginx 就是迎宾小姐，客人如果点了酒水，迎宾小姐自己就帮忙拿了；而 Gunicorn 是传菜员，Django 是厨师，他两一起满足客人对现炒美食的需求。</p><h3 id="远程连接"><a href="#远程连接" class="headerlink" title="远程连接"></a>远程连接</h3><p>部署的第一步就是想办法连接到云服务器上去，否则一切都免谈。鉴于项目是在 Windows 环境开发的，推荐用 <strong>XShell</strong> 来作为远程连接的工具，非常的好用。XShell 有<a href="https://www.netsarang.com/zh/free-for-home-school/">学校及家庭版本</a>，填一下姓名和邮箱就可以免费使用了。千万别嫌麻烦去下载来路不明的“绿色版”、“纯净版”，万一有木马你哭都哭不出来了。</p><p>XShell 怎么使用就不赘述了，以读者的聪明才智，稍微查阅一下就明白了。</p><blockquote><p>使用相当简单，基本就是把主机 IP、端口号（22）以及登录验证填好就能连接了。</p></blockquote><p>连接成功后，就能在 XShell 窗口中看到阿里云的欢迎字样了：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Welcome to Ubuntu <span class="token number">16.04</span>.6 LTS <span class="token punctuation">(</span>GNU/Linux <span class="token number">4.4</span>.0-151-generic x86_64<span class="token punctuation">)</span> * Documentation:  https://help.ubuntu.com * Management:     https://landscape.canonical.com * Support:        https://ubuntu.com/advantageWelcome to Alibaba Cloud Elastic Compute Service <span class="token operator">!</span>root@dusaiphoto:~$ <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>root@dusaiphoto:~$ </code>是命令提示符，输入命令时不需要你输入这个。本文后面把 <code>root@dusaiphoto:</code>字符省略掉，方便大家阅读。</p><h3 id="代码部署"><a href="#代码部署" class="headerlink" title="代码部署"></a>代码部署</h3><p>为了防止系统太旧引起的各种麻烦，先升级一下库的版本：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">~$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update~$ <span class="token function">sudo</span> <span class="token function">apt-get</span> upgrade<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>完成之后，接着安装需要的几个包：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">~$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> nginx~$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python3~$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python3-pip~$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">git</span>~$ <span class="token function">sudo</span> pip3 <span class="token function">install</span> virtualenv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>分别安装了 <strong>nginx</strong>、<strong>python3</strong>、<strong>pip</strong>、<strong>git</strong>、<strong>virtualenv</strong>。其中 python3 和 pip3 的写法是因为阿里云自带了 Python2.7，把它们区分一下。之前开发时虚拟环境用的 python 自带的，为了避免读者的版本不同造成的各类错误，稳妥起见用 virtualenv 库来创建虚拟环境，操作步骤都是差不多的。</p><p>接下来就是要改一下 Django 的配置文件 <code>settings.py</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token comment"># 关闭调试模式</span>DEBUG <span class="token operator">=</span> <span class="token boolean">False</span><span class="token comment"># 允许的服务器</span>ALLOWED_HOSTS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'*'</span><span class="token punctuation">]</span><span class="token comment"># 静态文件收集目录</span>STATIC_ROOT <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'collected_static'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>部署时要关闭调试模式，避免安全性问题（此时 Django 就不再处理静态资源了）。</li><li><code>ALLOWED_HOSTS</code>指明了允许访问的服务器名称或 IP，星号表示允许所有的请求。实际部署时请改成你的域名或 IP，比如<code>ALLOWED_HOSTS = [&#39;.dusaiphoto.com&#39;, &#39;127.0.0.1&#39;]</code>。</li><li>项目中有很多静态文件，部署时需要找一个地方统一收集起来，也就是<code>STATIC_ROOT</code>指定的地址了。</li></ul><p>因为项目代码需要通过 <code>GitHub</code> 仓库进行下载（就像本教程的示例代码一样），因此修改完毕后需要把代码上传到 <code>GitHub</code>。怎么上传这里也不赘述了，博主之前写过一篇<a href="https://www.dusaiphoto.com/article/detail/13/">《Win 10 连接 GitHub》</a>的文章，有需要的读者稍微读一下。</p><p><strong>注意：</strong>一般情况下，需要将开发时生成的迁移文件（各个 app 中的 migrations 目录）一并上传到服务器端，这样可以保证各环境中的数据库操作一致。也就是说，服务器上不再需要 makemigrations 了，只进行 migrate 就可以了。这下理解为什么数据迁移要设计成两条指令了吧。</p><p>另外，<strong>虚拟环境一般是需要在服务器上重新生成的</strong>，因此我们需要把开发中用到的库列一个清单，以便在服务器上统一安装。在<strong>本地虚拟环境</strong>中输入：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip freeze <span class="token operator">></span> requirements.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>项目中就多了个 <code>requirements.txt</code> 文件，里面记录了项目需要的库的清单。</p><blockquote><p>教程为了演示，上传了媒体资源和数据库，实际开发时可千万不要上传。</p></blockquote><p>然后更新 Git 记录并上传到 GitHub。重新回到<strong>服务器的命令行</strong>，给项目代码创建目录并进入此目录：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">~$ <span class="token function">mkdir</span> -p /home/sites/dusaiphoto.com~$ <span class="token builtin class-name">cd</span> /home/sites/dusaiphoto.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>目录位置是随便你的，但建议找个地方统一管理所有的网站项目。</p><p>然后从 GitHub 中拉取项目代码：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>/dusaiphoto.com$ <span class="token function">git</span> clone https://github.com/stacklens/django_blog_tutorial.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这里拉取的博客教程的代码。建议读者先拉取教程代码来测试，成功之后再重新部署自己的代码。完成之后可以输入 <code>ls</code> 指令，看看代码文件夹是否正常生成了。</p><p>接着在服务器生成虚拟环境：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>/dusaiphoto.com$ virtualenv --python<span class="token operator">=</span>python3.5 <span class="token function">env</span><span class="token punctuation">..</span>/dusaiphoto.com$ <span class="token builtin class-name">source</span> env/bin/activate<span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">..</span>/dusaiphoto.com$ <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这里用 <code>virtualenv</code> 生成并激活了虚拟环境。python 版本选择 3.5 还是 3.7 都可以，区别并不大。</p><p>接下来就是安装库、收集静态资源、数据迁移了：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">..</span>/dusaiphoto.com$ <span class="token builtin class-name">cd</span> django_blog_tutorial<span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">..</span>/django_blog_tutorial$ pip3 <span class="token function">install</span> -r requirements.txt<span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">..</span>/django_blog_tutorial$ python3 manage.py collectstatic<span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">..</span>/django_blog_tutorial$ python3 manage.py migrate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>代码部署基本就完成了，接下来配置 <code>Nginx</code> 。</p><h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><p>前面我们安装了 <code>Nginx</code> ，先来试试安装是否正常。启动 nginx 服务：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> ~$ <span class="token function">sudo</span> <span class="token function">service</span> nginx start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>打开浏览器，输入你的<strong>服务器公网 IP 地址</strong>：</p><p><img src="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28247%29.png" class="lazyload placeholder" data-srcset="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28247%29.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>Nginx 欢迎界面出现了，神奇吧。但这个默认配置显然是不能用的，所以需要重新写 Nginx 的配置文件。进入 <code>/etc/nginx/sites-available</code> 目录，这里是定义 <strong>Nginx 可用配置</strong>的地方。输入指令 <code>sudo vi dusaiphoto.com</code> 创建配置文件并打开 <strong>vi 编辑器</strong>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> ~$ <span class="token builtin class-name">cd</span> /etc/nginx/sites-available<span class="token punctuation">(</span>env<span class="token punctuation">)</span> /etc/nginx/sites-available$ <span class="token punctuation">(</span>env<span class="token punctuation">)</span> /etc/nginx/sites-available$ <span class="token function">sudo</span> <span class="token function">vi</span> dusaiphoto.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>关于 <code>vi</code> 编辑器如何使用也不赘述了，这里只说两个最基本的操作：</p><ul><li>按 <code>i</code> 键切换到<strong>编辑模式</strong>，这时候才可以进行输入、删除、修改等操作</li><li>按 <code> Ctrl + c</code> 退回到<strong>命令模式</strong>，然后输入 <code>:wq + Enter</code> 保存文件修改并退回到服务器命令行</li></ul><p>回到正题，用 <code>vi</code> 在 <code>dusaiphoto.com</code> 文件中写入：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">server <span class="token punctuation">&#123;</span>  charset utf-8<span class="token punctuation">;</span>  listen <span class="token number">80</span><span class="token punctuation">;</span>  server_name <span class="token number">118.31</span>.35.48<span class="token punctuation">;</span>  <span class="token comment"># 改成你的 IP</span>  location /static <span class="token punctuation">&#123;</span>    <span class="token builtin class-name">alias</span> /home/sites/dusaiphoto.com/django_blog_tutorial/collected_static<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>    location /media <span class="token punctuation">&#123;</span>    <span class="token builtin class-name">alias</span> /home/sites/dusaiphoto.com/django_blog_tutorial/media<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  location / <span class="token punctuation">&#123;</span>    proxy_set_header Host <span class="token variable">$host</span><span class="token punctuation">;</span>    proxy_pass http://unix:/tmp/118.31.35.48.socket<span class="token punctuation">;</span>  <span class="token comment"># 改成你的 IP</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此配置会监听 80 端口（通常 http 请求的端口），监听的 IP 地址写你自己的<strong>服务器公网 IP</strong>。</p><p>配置中有3个规则：</p><ul><li>如果请求 static 路径则由 Nginx 转发到目录中寻找静态资源</li><li>如果请求 media 路径则由 Nginx 转发到目录中寻找媒体资源</li><li>其他请求则交给 Django 处理</li></ul><blockquote><p>如果你已经申请好域名了，就把配置中有 IP 的地方都修改为域名，比如：server_name <a href="http://www.dusaiphoto.com/">www.dusaiphoto.com</a>;</p></blockquote><p>写好后就退出 <code>vi</code> 编辑器，回到命令行。因为我们写的只是 Nginx 的<strong>可用配置</strong>，所以还需要把这个配置文件链接到<strong>在用配置</strong>上去：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">..</span>/sites-available$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /etc/nginx/sites-available/dusaiphoto.com /etc/nginx/sites-enabled<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>至此 Nginx 就配置好了，接下来搞定 <code>Gunicorn</code>。</p><blockquote><p>有的读者无论怎么配置都只能看到 Nginx 欢迎页面，有可能是 sites-enabled 目录中的 default 文件覆盖了你写的配置。将 default 文件删掉就可以正常代理自己的配置文件了。</p></blockquote><h3 id="Gunicorn及测试"><a href="#Gunicorn及测试" class="headerlink" title="Gunicorn及测试"></a>Gunicorn及测试</h3><p><strong>先回到项目所在的目录</strong>，并且进入<strong>虚拟环境</strong>，然后输入：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">..</span>/django_blog_tutorial$ pip3 <span class="token function">install</span> gunicorn<span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">..</span>/django_blog_tutorial$ <span class="token function">sudo</span> <span class="token function">service</span> nginx reload<span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">..</span>/django_blog_tutorial$ gunicorn --bind unix:/tmp/118.31.35.48.socket my_blog.wsgi:application<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这里的三个步骤分别是：</p><ul><li>安装 <code>Gunicorn</code></li><li>重启 <code>Nginx</code> 服务</li><li>启动 <code>Gunicorn</code> </li></ul><blockquote><p>启动 Gunicorn 也是一样，如果你已经有域名了，就把套接字中的 IP 地址换成域名；wsgi 字眼前面是项目的名称。另外 <code>sudo service nginx reload</code> 可替换成 <code>sudo service nginx restart</code>，区别是 reload 只重载配置文件，restart 重启整个服务。</p></blockquote><p>接下来用浏览器访问服务器试一下：</p><p><img src="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28251%29.jpg" class="lazyload placeholder" data-srcset="http://blog.dusaiphoto.com/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%28251%29.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p><strong>大功告成啦，撒花庆祝！</strong></p><h2 id="后续工作"><a href="#后续工作" class="headerlink" title="后续工作"></a>后续工作</h2><h3 id="遗留问题"><a href="#遗留问题" class="headerlink" title="遗留问题"></a>遗留问题</h3><p>成功部署到线上后，还有些小问题没解决。</p><p><strong>第一个问题</strong>是进入文章详情页面， ckeditor 无法加载了，并且浏览器报出 <code>prism_patched.js Not Found</code>的错误。这个问题的根源在于之前我们在开发 ckeditor 的代码高亮功能时，<code>prism</code> 模块是直接插入到虚拟环境的库中的，但问题是部署时虚拟环境是需要重新建立的，所以就缺少了这个 prism 插件导致报错。</p><p>解决办法也很简单，在虚拟环境中找到 prism 插件的位置：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span><span class="token punctuation">\</span>env<span class="token punctuation">\</span>Lib<span class="token punctuation">\</span>site-packages<span class="token punctuation">\</span>ckeditor<span class="token punctuation">\</span>static<span class="token punctuation">\</span>ckeditor<span class="token punctuation">\</span>ckeditor<span class="token punctuation">\</span>plugins<span class="token punctuation">\</span>prism<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后把它原封不动的复制到项目的 <code>static</code> 中完全相同的目录中去：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">my_blog<span class="token punctuation">\</span>static<span class="token punctuation">\</span>ckeditor<span class="token punctuation">\</span>ckeditor<span class="token punctuation">\</span>plugins<span class="token punctuation">\</span>prism<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这样做行得通的原因是 django-ckeditor 也是一个 app，Django 访问 app 资源时会优先在项目中搜索，没有才去虚拟环境里搜索。</p><p>然后就是通过 GitHub 更新服务器代码，并且重新收集静态文件：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">..</span>/django_blog_tutorial$ <span class="token function">git</span> pull origin master<span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token punctuation">..</span>/django_blog_tutorial$ python3 manage.py collectstatic<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这个问题给我们的启示就是：针对三方库、资源的改动最好不要直接修改源文件或环境，而是想办法在项目副本中更改，这样更便于维护。</p><blockquote><p>有读者发现旧的富文本评论中的表情没显示，这个别担心，新发表的评论是没问题的。</p></blockquote><p><strong>第二个问题</strong>是 GitHub 登录不正常了，这个多半不是代码的问题，而是你的服务器以及 GitHub 的回调配置问题。这里也不展开讲了，请读者返回前面第三方登录的文章再研究下。</p><p><strong>第三个问题</strong>是开发阶段用的 <code>sqlite</code> 数据库虽然很方便，但是性能较差。线上以性能为王，所以需要将数据库更换为 <code>MYSQL</code> 这类主流的高性能数据库。远程安装配置 MYSQL 的方法可以参考一下<a href="http://www.liujiangblog.com/course/django/165">刘江的博客</a>，讲得很清楚。</p><p><strong>第四个问题</strong>是教程部署是以 root 用户进行的，这是服务器中具有最高权限的用户，除掉自身的瞎操作，一旦被攻击者登录了会相当惨烈（尤其是用户/密码的登录方式，安全系数极低）。比较好的方式是重新创建一个普通用户来进行部署，并且将登录方式改为秘钥对。</p><h3 id="后期运维"><a href="#后期运维" class="headerlink" title="后期运维"></a>后期运维</h3><p>你的网站是需要不断更新优化代码的。每次修改代码后，更新到服务器上也很简单。在<strong>虚拟环境</strong>中并<strong>进入项目目录</strong>，依次（collectstatic 和 migrate 是可选的）执行以下命令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> pull origin masterpython3 manage.py collectstaticpython3 manage.py migrate<span class="token comment"># 重启 gunicorn</span><span class="token function">pkill</span> gunicorngunicorn --bind unix:/tmp/118.31.35.48.socket my_blog.wsgi:application<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>加上 <code>cd</code> 更改目录的指令，部署过程有十几条指令，手动输入也太麻烦了。简单粗暴的办法是利用 XShell 的宏，把部署指令写成顺序执行的脚本，点几个按钮就完成了，非常方便。</p><blockquote><p>更高级的做法是在服务器上编写自动化部署的脚本，这个就读者以后慢慢研究吧</p></blockquote><p>如果你更改了 Nginx 的配置文件，还需要重启 Nginx 服务：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> nginx reload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>最后，还记得前面章节开发的<strong>日志记录功能</strong>不？看看项目中有 <code>logs</code> 目录吗？</p><h3 id="域名及优化"><a href="#域名及优化" class="headerlink" title="域名及优化"></a>域名及优化</h3><p>相对部署来说，域名配置就很容易了。阿里云提供域名的购买、备案（顶级域名必须，约10个工作日）、解析服务，简直全家桶有没有。重点提醒有了域名之后要改的地方：</p><ul><li><code>settings.py</code> 中的 <code>ALLOWED_HOSTS</code></li><li><code>Nginx</code> 中与 IP/域名 有关的位置</li><li><code>Gunicorn</code> 中与 IP/域名 有关的位置</li></ul><p>域名搞定之后，接着就可以着手考虑把网站升级为 https 版本了，这是大趋势，一定要做。（这个也留给读者自己折腾）</p><p>另外，开发时为了效率把所有静态资源都下载到本地，但是部署时不推荐这样做，原因是静态文件通常体积都较大，你花血汗钱买的服务器载入会很慢。尽量远程 CDN 调用，像这样：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>国内推荐<a href="https://www.bootcdn.cn/">BootCDN</a>，速度快还免费。</p><p>媒体资源也是类似，小图还无所谓，大图就要放在<a href="https://portal.qiniu.com/signup?code=1hfqrn5z85c9e">七牛云</a>这类的对象存储云上，否则你网页的载入速度会很悲剧的。</p><p>最后再次提醒，在开发时我们往 <code>settings.py</code> 中写入如 SECRET_KEY 、邮箱密码等各种敏感信息，部署时千万不要直接上传到互联网（GitHub 库是公开的！），而是把这些信息写到服务器本地，然后在 <code>settings.py</code> 中读取。</p><h3 id="进程托管"><a href="#进程托管" class="headerlink" title="进程托管"></a>进程托管</h3><p>部署过程中还有个新手经常碰到的问题，就是当 SSH 终端一关闭，Web 服务也一起被关闭了，导致网站无法连接。这个问题在 @frostming 的文章 <a href="https://frostming.com/2020/05-24/process-management">《Web 服务的进程托管》</a> 中用了三种常见方法解决了，并且还实现了异常重启和开机自启动。有类似疑惑的同学可以前往围观。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>部署可以说是入门者最大的难关了，也是检验成果、获取成就感的关键一步。多查资料，要相信你遇到的问题别人早就遇到过了。</p><p>部署是菜鸟的毕业礼，也是新人的第一课。</p><p><strong>路漫漫其修远兮，吾将上下而求索。</strong></p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#x75;&#115;&#x61;&#105;&#112;&#104;&#111;&#x74;&#x6f;&#64;&#x66;&#111;&#x78;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#x63;&#111;&#109;">&#x64;&#x75;&#115;&#x61;&#105;&#112;&#104;&#111;&#x74;&#x6f;&#64;&#x66;&#111;&#x78;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#x63;&#111;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--42.小功能集合贴</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/42.xiao-gong-neng-ji-he-tie/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/42.xiao-gong-neng-ji-he-tie/</url>
      
        <content type="html"><![CDATA[<p>有些<strong>功能独立的小功能</strong>，单独一篇文章不够分量，于是在这里集中解释了。</p><p>和<a href="https://www.dusaiphoto.com/article/detail/43/">读者常见问题帖</a>一样，本篇是<strong>持续更新</strong>的，想到一个写一个。</p><h2 id="文章快捷导航"><a href="#文章快捷导航" class="headerlink" title="文章快捷导航"></a>文章快捷导航</h2><p>快捷导航指的是这个功能：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190117/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE145.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190117/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE145.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击对应按钮，页面立即跳转到另一篇文章中，省去了用户返回首页重新寻找文章的繁琐。</p><h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><p>实现本功能的关键就是要查找出<strong>发表时间与当前文章相邻</strong>的文章。为了演示简单，就粗略以<code>id</code>作为发表时间的排序。</p><p>在之前的<a href="https://www.dusaiphoto.com/article/detail/47/">搜索文章的教程</a>中，我们已经体验过<code>contains</code>这种查找方法了，现在需要用到另外两种：<code>gt</code>和<code>lt</code>。</p><p>编写视图：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 文章详情</span><span class="token keyword">def</span> <span class="token function">article_detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 已有代码。取出相应的文章</span>    article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 过滤出所有的id比当前文章小的文章</span>    pre_article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__lt<span class="token operator">=</span>article<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-id'</span><span class="token punctuation">)</span>    <span class="token comment"># 过滤出id大的文章</span>    next_article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__gt<span class="token operator">=</span>article<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>        <span class="token comment"># 取出相邻前一篇文章</span>    <span class="token keyword">if</span> pre_article<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>        pre_article <span class="token operator">=</span> pre_article<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        pre_article <span class="token operator">=</span> <span class="token boolean">None</span>            <span class="token comment"># 取出相邻后一篇文章</span>    <span class="token keyword">if</span> next_article<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>        next_article <span class="token operator">=</span> next_article<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        next_article <span class="token operator">=</span> <span class="token boolean">None</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment"># 需要传递给模板的对象</span>    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span>         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token string">'pre_article'</span><span class="token punctuation">:</span> pre_article<span class="token punctuation">,</span>        <span class="token string">'next_article'</span><span class="token punctuation">:</span> next_article<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行逻辑如下：</p><ul><li><code>lt</code>过滤出所有<code>id</code>比当前文章小的文章</li><li>对这些文章按<code>-id</code>进行排序</li><li>取出排在首位的文章，即相邻的文章</li><li>返回给模板上下文</li></ul><p><code>gt</code>的原理也是类似。</p><h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>模板得到上下文后，就要相应修改：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/detail.html...<span class="token comment">&lt;!-- 相邻文章导航 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row justify-content-end<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    &#123;% if next_article %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-auto mr-auto<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span>  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; next_article.get_absolute_url &#125;&#125;<span class="token punctuation">"</span></span>             <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-info<span class="token punctuation">"</span></span>            <span class="token punctuation">></span></span>            &#123;&#123; next_article.title &#125;&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    &#123;% endif %&#125;&#123;% if pre_article %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-auto<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span>  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; pre_article.get_absolute_url &#125;&#125;<span class="token punctuation">"</span></span>         <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-info<span class="token punctuation">"</span></span>         <span class="token punctuation">></span></span>            &#123;&#123; pre_article.title &#125;&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endif %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码很简单，就是按照上下文的信息，将导航按钮正确显示出来。功能就完成了。</p><p>导航的逻辑不一定非要按时间排序，也可以按照热度、文章类别甚至文字个数，这个就随便你了。</p><h2 id="页面定位"><a href="#页面定位" class="headerlink" title="页面定位"></a>页面定位</h2><p>良好的UI设计应该让用户清楚自己当前的状态。</p><p>比如<a href="https://www.dusaiphoto.com/">我的博客</a>就是这样的：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190105/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE139.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190105/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE139.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>可以清楚看到当前正位于【文章】-【编程】-【最近】这个页面中的。</p><p>实现方法提供给大家参考。</p><blockquote><p>例子中的样式用的LayUI，而不是Bootstrap，但是思路是相同的</p><p>读者请尝试用Bootstrap实现</p></blockquote><h3 id="栏目和排序"><a href="#栏目和排序" class="headerlink" title="栏目和排序"></a>栏目和排序</h3><p>栏目和排序都是<strong>被查询文章集合</strong>的共有属性，因此考虑在<code>article_list()</code>视图中把它们作为<strong>上下文</strong>传递到模板中来，类似于某种“标记”：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token comment"># 传递到模板的对象</span>context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token string">'column'</span><span class="token punctuation">:</span> column<span class="token punctuation">,</span> <span class="token string">'order'</span><span class="token punctuation">:</span> order <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>然后在模板中通过<code>column</code>和<code>order</code>的值，控制按钮的样式：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">/list.html<span class="token comment">&lt;!-- 栏目 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">...</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>          ...          &#123;% if column_id == column.id %&#125;          layui-btn-warm          &#123;% else %&#125;          layui-btn-primary          &#123;% endif %&#125;          <span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>...<span class="token comment">&lt;!-- 排序 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">...</span><span class="token punctuation">></span></span>    &#123;% if order == 'total_views' %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cite</span><span class="token punctuation">></span></span>最近<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>cite</span><span class="token punctuation">></span></span>    &#123;% else %&#125;    最近    &#123;% endif %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码中的<code>column_id</code>是当前页面所在的栏目，<code>column.id</code>是视图传递给模板的上下文。通过比对这两个值是否一致，从而决定<strong>栏目按钮</strong>的样式。</p><p>面包屑也是类似的方法，判断是否需要插入<code>&lt;cite&gt;</code>标签。</p><h3 id="导航栏"><a href="#导航栏" class="headerlink" title="导航栏"></a>导航栏</h3><p>就是<a href="https://www.dusaiphoto.com/">我的博客</a>顶部的“黑条”，它是所有板块的入口。</p><p>如果导航栏也采用类似上面的<strong>传递值给模板</strong>来定位，那么要求所有的app都要传递同一个”标记”到模板中。理论上可行，但是也会导致app之间耦合得太紧，个人感觉不是好的实践。</p><p>所以我采用了一种笨办法：直接在模板中读取当前的url，从而判断页面位置：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">/header.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>  <span class="token punctuation">"</span>             ...             &#123;% if <span class="token punctuation">'</span>/xxx<span class="token punctuation">'</span> in request.path %&#125;             layui-this             &#123;% endif %&#125;             <span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这种方法有个小问题，就是如果url中恰好出现了别的板块的关键词，定位可能会显示错误。</p><p>不过对博客来说也不算什么大问题，比紧耦合的设计要好多了。</p><hr><p><em>持续更新中…</em></p><hr><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#117;&#115;&#97;&#105;&#112;&#x68;&#x6f;&#x74;&#111;&#64;&#x66;&#x6f;&#x78;&#109;&#x61;&#105;&#108;&#46;&#x63;&#x6f;&#x6d;">&#100;&#117;&#115;&#97;&#105;&#112;&#x68;&#x6f;&#x74;&#111;&#64;&#x66;&#x6f;&#x78;&#109;&#x61;&#105;&#108;&#46;&#x63;&#x6f;&#x6d;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--41.期末总结</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/41.qi-mo-zong-jie/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/41.qi-mo-zong-jie/</url>
      
        <content type="html"><![CDATA[<p>本教程共写作了一年多（龟速更新..），也算告一段落了。如果还有读者特别想看、但是教程又没涉及的内容，博主会继续更新，不过时间就不能保证了。业余精力有限，如果不能保证文章的质量，那我情愿不写。</p><p>如果你是本教程的忠实读者，看到这里就已经学会了以下内容：</p><ul><li>博文管理</li><li>用户管理</li><li>多级评论</li><li>文章栏目和标签</li><li>图片处理</li><li>第三方登录</li><li>点赞</li><li>测试与维护</li><li>部署</li><li>其他零星功能</li></ul><p>不错，基本功能都有了。</p><h2 id="接下来学什么"><a href="#接下来学什么" class="headerlink" title="接下来学什么"></a>接下来学什么</h2><h3 id="响应式布局"><a href="#响应式布局" class="headerlink" title="响应式布局"></a>响应式布局</h3><p>响应式布局，简单来说就是页面布局随着终端设备的变化而自动适应。</p><p>教程为了起步平缓，没有展开这方面的内容。也就是说教程中的博客在手机上浏览，界面会变得非常的糟糕。</p><p>好在 BootStrap 就是一个强大的响应式布局框架。在它的官网上有非常详细的介绍、复制就能用的代码，请耐心查阅：<a href="https://getbootstrap.com/docs/4.1/getting-started/introduction/">Bootstrap官方文档</a></p><h3 id="各种轮子"><a href="#各种轮子" class="headerlink" title="各种轮子"></a>各种轮子</h3><p>轮子是别人封装好的库。虽然不用自己写，但最起码要学会使用。优秀的轮子推荐如下：</p><ul><li><a href="https://github.com/brack3t/django-braces">django-braces</a>：包含各种有用的基础类视图。写类视图用它可以节省很多时间。</li><li><a href="https://django-haystack.readthedocs.io/en/master/">django-haystack</a>：实现复杂的定制化搜索。</li><li><a href="https://www.django-rest-framework.org/">django-rest-framework</a>：有的读者迫不及待想尝试前后端分离开发模式，这个框架几乎是你唯一的选择。</li></ul><p>优秀的app很多，这里没办法列举。感兴趣的同学请点这里：<a href="https://djangopackages.org/">djangopackages</a>，这个网址集合了所有优秀的库。慢慢研究吧。</p><h3 id="其他技能"><a href="#其他技能" class="headerlink" title="其他技能"></a>其他技能</h3><p>博主之前反复强调了，虽然这只是个 Django 教程，但是只会写 Django 是没法支撑一个漂亮的网站的。</p><ul><li>你要学 <code>JavaScript</code>，让界面更美观</li><li>要学 <code>Linux</code>，以便网站运维</li><li>要学数据库知识，让你在某些特殊情况下摆脱 ORM，高效的操作远程数据库</li><li>以及云服务器各种组件、微信支付接口、缓存数据库、…</li></ul><p><strong>不要你精通，但是至少得会一点点，关键时刻可以救命。</strong></p><h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>读者在教程中是否学到新东西了呢？</p><p>如果有，欢迎点击教程尾部的**[打赏]**按钮，请博主喝杯咖啡~</p><p>或者在我的<a href="https://github.com/stacklens/django_blog_tutorial">GitHub博客教程代码</a>给一个小星星，感谢各位的支持。</p><p><strong>我的教程是写完了，但是你的学习才刚开始。</strong>胜利的背后总有无数个难熬的夜晚。</p><p>天下没有不散的筵席。下一个教程见！</p><blockquote><p>近期向博主咨询问题的读者比较多，考虑组建微信群或QQ群，让大家有一个互相学习的空间，也减轻我的压力。到时网站的醒目位置会有二维码或链接，有兴趣的读者可以偶尔来转转。</p></blockquote><p><img src="https://www.dusaiphoto.com/media/image/image_source/20190101/end.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20190101/end.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--11.删除文章</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/11.shan-chu-wen-zhang/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/11.shan-chu-wen-zhang/</url>
      
        <content type="html"><![CDATA[<p>既然有了写文章的功能，那当然也必须要有删除文章的功能了。</p><h2 id="不安全的方式"><a href="#不安全的方式" class="headerlink" title="不安全的方式"></a>不安全的方式</h2><p>有了之前的学习做铺垫，删除文章实现起来就比较简单了。</p><p>首先增加一个视图函数：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 删文章</span><span class="token keyword">def</span> <span class="token function">article_delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 根据 id 获取需要删除的文章</span>    article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>    <span class="token comment"># 调用.delete()方法删除文章</span>    article<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 完成删除后返回文章列表</span>    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"article:article_list"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>与查询文章类似，因为需要知道具体应该删除哪一篇文章，因此必须传入文章的<code>id</code>；</li><li>紧接着调用<code>.delete()</code>函数删除数据库中这篇文章的条目；</li><li>删除成功后返回到文章列表。</li></ul><p>这里与上一章一样，不对用户的身份进行限制，即任何人都可以删除任意文章。当然这样肯定是不符合常理的，等到我们学习了用户管理的知识后，再回头来修改。</p><p>然后写入路由信息：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 删除文章</span>    path<span class="token punctuation">(</span><span class="token string">'article-delete/&lt;int:id>/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>article_delete<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'article_delete'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里几乎与文章详情的写法一样，没有新的内容。再次注意文章的id是如何传递到视图中的。</p><p>最后我们希望能够在文章详情的页面进行删除的操作（当然也可以在专门的管理文章的页面中），因此修改模板<code>detail.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token comment">&lt;!-- 文章详情 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        ...        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12 alert alert-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>作者：&#123;&#123; article.author &#125;&#125;         · <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">"</span></span><span class="token attr-name"><span class="token namespace">article:</span>article_delete"</span> <span class="token attr-name">article.id</span> <span class="token attr-name">%&#125;"</span><span class="token punctuation">></span></span>删除文章<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里增加了一个调用<code>article_delete</code>视图函数的链接，并且将<code>article.id</code>传递进去。</p><p>运行开发服务器，可以发现已经能够正常的删除文章了：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181008/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE56.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181008/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE56.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><h3 id="增加弹窗"><a href="#增加弹窗" class="headerlink" title="增加弹窗"></a>增加弹窗</h3><p>功能已经实现了，但是还有个小问题没有解决：万一我只是不小心点到了链接，辛辛苦苦写的文章就被删除了，岂不是欲哭无泪了？</p><p>很容易想到的一个解决方法，就是点击删除按钮是出现一个弹窗，确认后再进行删除，确保用户不是误操作的。</p><p>弹窗是很常用的功能，但是想写出一个美观好用的弹窗却不容易。幸运的是我们不需要重复造轮子，早就有革命先驱做好相关的功能了，这里我们选择使用<strong>Layer弹窗组件</strong>。</p><p><em>layer</em>是一款备受青睐的web弹层组件，具备全方位的解决方案。首先到官网下载Layer插件：<a href="https://layer.layui.com/">Layer</a></p><p>解压后将里面的<strong>layer文件夹（含有layer.js的）</strong>直接复制到项目的<code>static</code>文件夹下。</p><p>为了未来在所有页面都能使用Layer弹窗功能，在<code>base.html</code>中通过标签引入：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/base.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    ...    <span class="token comment">&lt;!-- bootstrap.js 依赖 jquery.js 和popper.js，因此在这里引入 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>jquery/jquery-3.3.1.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    ...    <span class="token comment">&lt;!-- 引入layer.js --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>layer/layer.js<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>layer插件依赖jquery才能正常工作，因此要在jquery的后面引入layer。</strong></p><p>再次改写模板文件<code>detail.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token comment">&lt;!-- 文章详情 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        ...        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12 alert alert-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>作者：&#123;&#123; article.author &#125;&#125;         · <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">confirm_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>删除文章<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token comment">// 删除文章的函数</span>    <span class="token keyword">function</span> <span class="token function">confirm_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 调用layer弹窗组件</span>        layer<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token comment">// 弹窗标题</span>            title<span class="token operator">:</span> <span class="token string">"确认删除"</span><span class="token punctuation">,</span>            <span class="token comment">// 正文</span>            content<span class="token operator">:</span> <span class="token string">"确认删除这篇文章吗？"</span><span class="token punctuation">,</span>            <span class="token comment">// 点击确定按钮后调用的回调函数</span>            <span class="token function-variable function">yes</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> layero</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 指定应当前往的 url</span>                location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">'&#123;% url "article:article_delete" article.id %&#125;'</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>&lt;a&gt;</code>标签中增加了<code>onclick</code>属性，表示在点击链接时调用后面的<code>confirm_delete()</code>函数。</li><li><code>confirm_delete()</code>函数中调用了<strong>layer弹窗组件</strong>，对弹窗的<strong>标题</strong>、<strong>正文</strong>以及<strong>确定键</strong>进行了定义。**<code>location.href</code>是点击确定键后应该前往的地址，即删除文章的url。**（当然Layer组件远不止这些用法，具体可在官方文档中查阅）。</li><li>通过<code>onclick</code>实现了功能逻辑，因此<code>href</code>链接就不需要再跳转了。</li></ul><blockquote><p>不要将模板语法和JavaScript语法搞混了。</p><p>包裹在 <code>&#123;% .. %&#125;</code> 中的是Django的模板语法。Django在模板语法帮助下将零散的模板文件拼接成完整的html文件，再传递到用户的浏览器中进行解析。模板语法适合执行一些简单的逻辑。</p><p>包裹在<code>script</code>标签中的是JavaScript语法，它是与Python不同的、能够在浏览器中运行的前端语言。学好JavaScript同样是一个漫长的过程，好在本教程中只会涉及一点基本的JavaScript代码。</p></blockquote><p>保存所有文件后刷新页面，很好，达到了理想的效果：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181008/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE57.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181008/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE57.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><h2 id="安全的方式"><a href="#安全的方式" class="headerlink" title="安全的方式"></a>安全的方式</h2><p>可能你认为删除文章功能实现起来没什么难度，但是请注意，<strong>上面的方法是有隐患的</strong>。要继续深入探讨，就得提到<strong>跨域请求伪造攻击</strong>，也称为<strong>CSRF攻击</strong>了（Cross-site request forgery）。</p><h3 id="CSRF攻击"><a href="#CSRF攻击" class="headerlink" title="CSRF攻击"></a>CSRF攻击</h3><p>CSRF攻击你可以理解为：攻击者盗用了你的身份，以你的名义发送恶意请求。还是拿删除文章举例：</p><ul><li>用户登录了<strong>博客网站A</strong>，浏览器记录下这次会话，并保持了登录状态；</li><li>用户在没有退出登录的情况下，又非常不小心的打开了邪恶的<strong>攻击网站B</strong>；</li><li><strong>攻击网站B</strong>在页面中植入恶意代码，悄无声息的向<strong>博客网站A</strong>发送删除文章的请求，此时浏览器误以为是用户在操作，从而顺利的执行了删除操作。</li></ul><p>由于浏览器的同源策略，CSRF攻击者并不能得到你的登录数据实际内容，但是可以欺骗浏览器，让恶意请求附上正确的登录数据。不要小看CSRF攻击的威力：倘若是你的银行账户具有此类安全漏洞，黑客就可以神不知鬼不觉转走你的所有存款。</p><p>所以这里如何防范CSRF攻击的风险呢？方法是有的，即删除文章时用POST方法，并且校验<code>csrf</code>令牌。</p><h3 id="CSRF令牌"><a href="#CSRF令牌" class="headerlink" title="CSRF令牌"></a>CSRF令牌</h3><p>前面我们讲到在 Django 中提交表单必须加<code>csrf_token</code>，这个就是CSRF令牌了，它防范CSRF攻击的流程如下：</p><ul><li>当用户访问 django 站点时，django 反馈给用户的表单中有一个隐含字段 <code>csrf_token</code>，这个值是在服务器端随机生成的，每次都不一样；</li><li>在后端处理 POST 请求前，django 会校验请求的 cookie 里的 <code>csrf_token</code> 和表单里的 <code>csrf_token</code> 是否一致。一致则请求合法，否则这个请求可能是来自于 CSRF攻击，返回 403 服务器禁止访问。</li></ul><p>由于攻击者并不能得到用户的 cookie 内容（仅仅是靠浏览器转发），所以通常情况下是无法构造出正确的 <code>csrf_token</code>  的，从而防范了此类攻击。原理就是这样，下面来看看如何实现安全的删除功能。</p><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>首先修改删除文章的链接，以及点击它时调用的函数：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">templates/article/detail.html...<span class="token comment">&lt;!-- · &lt;a href="#" onclick="confirm_delete()">删除文章&lt;/a> --></span>· <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">confirm_safe_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>删除文章<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- 新增一个隐藏的表单 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span>       <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span>       <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>safe_delete<span class="token punctuation">"</span></span>      <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_safe_delete<span class="token punctuation">'</span> article.id %&#125;<span class="token punctuation">"</span></span>       <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span>      <span class="token punctuation">></span></span>    &#123;% csrf_token %&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>发送<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token operator">...</span><span class="token keyword">function</span> <span class="token function">confirm_safe_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    layer<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        title<span class="token operator">:</span> <span class="token string">"确认删除"</span><span class="token punctuation">,</span>        content<span class="token operator">:</span> <span class="token string">"确认删除这篇文章吗？"</span><span class="token punctuation">,</span>        <span class="token function-variable function">yes</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> layero</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'form#safe_delete button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            layer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码流程如下：</p><ul><li>点击删除文章链接时，弹出 layer 弹窗</li><li>弹窗不再发起 GET 请求，而是通过 Jquery 选择器找到隐藏的表单，并点击发送按钮</li><li>表单发起 POST 请求，并携带了 csrf 令牌，从而避免了 csrf 攻击</li></ul><p>接着添加表单提交的url：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># 安全删除文章</span>    path<span class="token punctuation">(</span>        <span class="token string">'article-safe-delete/&lt;int:id>/'</span><span class="token punctuation">,</span>        views<span class="token punctuation">.</span>article_safe_delete<span class="token punctuation">,</span>        name<span class="token operator">=</span><span class="token string">'article_safe_delete'</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后就是将新的删除视图写好：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">article<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 安全删除文章</span><span class="token keyword">def</span> <span class="token function">article_safe_delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        article <span class="token operator">=</span> ArticlePost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span>        article<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"article:article_list"</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"仅允许post请求"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可能你要问了，没发现哪行代码校验了<code>csrf</code>令牌啊？放心，默认配置下所有的 POST 请求都由 <strong>Django 中间件</strong>帮你验证了。另外视图一定要限制为 POST 请求，即<code>if request.method == &#39;POST&#39;</code>必须有，就请读者思考一下原因吧。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章新增了删除博客文章的功能，并且使用了弹窗组件优化了用户体验。</p><p>另一个重要的知识点就是CSRF攻击的防范。记住一条，凡是重要的数据操作，都应该考虑带有 csrf 令牌的 POST 请求；或者更简单的方法，数据查询用 GET，数据更改用 POST。</p><p>注意这个删除文章的功能并没有对用户身份进行验证。别急，等到讲完用户管理之后再来处理。</p><p>下一章将学习如何更新文章，准备好继续作战吧。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#100;&#117;&#115;&#x61;&#x69;&#112;&#x68;&#111;&#x74;&#x6f;&#x40;&#x66;&#x6f;&#x78;&#109;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#109;">&#100;&#117;&#115;&#x61;&#x69;&#112;&#x68;&#111;&#x74;&#x6f;&#x40;&#x66;&#x6f;&#x78;&#109;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--45.html学习1</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/45.html-xue-xi-1/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/45.html-xue-xi-1/</url>
      
        <content type="html"><![CDATA[<p>#HTTML学习1</p><h2 id="lang-”en”"><a href="#lang-”en”" class="headerlink" title="lang=”en”"></a>lang=”en”</h2><p>这是一个W3C的标准；<br>lang代表语言，en是英语；改成zh-cn指简体中文<br>xml:lang就是xml的语言<br>##meta标签<br>###charset<br>代表编码格式，一般有utf-8,gbk-2312等<br>###viewport<br>一般用于移动端布局</p><pre><code>content属性值详解：width：可视区域的宽度，值可为数字或关键词device-widthheight：同widthinitial-scale：页面首次被显示是可视区域的缩放级别，取值1.0则页面按实际尺寸显示，无任何缩放user-scalable:是否可对页面进行缩放，0禁止缩放maximum-scale=1.0, minimum-scale=1.0;可视区域的缩放级别，maximum-scale用户可将页面放大的程序，1.0将禁止用户放大到实际尺寸之上。</code></pre><p>###Keywords<br>在早年，keywords标签在关键词排名中起到非常大的作用，但是后来被很多的SEOER用来作弊，最终导致搜索引擎大大降低了此标签的重要性，</p><p>所以才有我们现在经常看到的很多大型网站的关键词排名很好，但是却没有书写keywords标签.</p><p>所以说现在写不写keywords标签真的无所谓了，但是如果你还是放不下这个标签你也可以写上，但千万不能有故意堆砌关键词的嫌疑了！<br>###description<br>description要用简短的文字描述网站或网页的主要内容，有利于各大搜索引擎的抓取收录你的网站或网页。</p><p>当你设置了description网站描述文字，才会显示在搜索引擎的结果页中，而每个网页的description也是同样的道理，简短又准确的网页描述文字，可以帮助用户在搜索引擎中更方便的找到你的网站和网页！<br>content属性值是网页描述文字，尽量用简洁的文字描述该网页的主要内容，一般控制在60字以内</p><p>meta标签必须写在头部head标签之内，而description的meta标签务必要写在keywords的meta标签之后<br>###书签图标</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>icon<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% static <span class="token punctuation">'</span>tag.icon<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> 一般为这种格式，显示在网页顶部，当有人收藏你的网站时也会显示</p><p>##js和min.js区别<br>   相同的是，他们的内容是一样的，包含的函数数量相同，同版本中的函数表达也是一样。</p><p>   不同点，单单从名字可以看出，一个占的空间大些，一个占的空间小。</p><p>   .min.js文件是将正常的.js文件空格都去掉，函数名尽量简写，使文件空间尽量小，加入项目，可以尽量减少项目的总的大小。</p><p>   而.js文件便于查看和学习，函数都有很好的排版。</p><p>  综合来说。jquery.min.js是用于项目引用。</p><p>##站长推送代码</p><pre><code> &lt;script&gt;    　(function()&#123;    　var bp = document.createElement(&#39;script&#39;);    　var curProtocol = window.location.protocol.split(&#39;:&#39;)[0];      　if (curProtocol === &#39;https&#39;)&#123;            bp.src = &#39;https://zz.bdstatic.com/linksubmit/push.js&#39;;      　&#125;        else&#123;          bp.src = &#39;http://push.zhanzhang.baidu.com/push.js&#39;;        &#125;        var s = document.getElementsByTagName(&quot;script&quot;)[0];        s.parentNode.insertBefore(bp, s);      &#125;)();  &lt;/script&gt;</code></pre><p>低本钱实现链接自动提交，百度站长平台宣布,站长需要在每个页面的HTML代码中包括以下自动推送JS代码当页面被会见时。</p><p>页面链接会自动推送给百度，有利于新页面更快被百度发现．为了更快速的发现站点天天发生的最新内容。</p>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Django博客网站搭建--13.用户的登录和退出</title>
      <link href="/post/django-bo-ke-wang-zhan-da-jian/13.yong-hu-de-deng-lu-he-tui-chu/"/>
      <url>/post/django-bo-ke-wang-zhan-da-jian/13.yong-hu-de-deng-lu-he-tui-chu/</url>
      
        <content type="html"><![CDATA[<h2 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h2><p>用户数据可以说是大部分网站最重要的资产。用户管理就是对用户数据进行增删改查等操作的功能，自然也就非常的重要了。</p><p>本章开始学习用户管理的内容，首先从用户登录开始。</p><p>在Django中用app来区别不同功能的模块，达到代码隔离和复用。<strong>因为用户管理和博客文章的功能不同，因此需要新建一个专门的app。</strong></p><p><strong>进入虚拟环境</strong>，运行<code>startapp</code>指令创建新的app：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">python manage<span class="token punctuation">.</span>py startapp userprofile<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看项目目录，发现已经新生成了userprofile目录及其中的文件了。</p><h2 id="再遇表单类"><a href="#再遇表单类" class="headerlink" title="再遇表单类"></a>再遇表单类</h2><p>用户登录时，需要填写账户密码等表单数据，因此又要用到Form表单类。</p><p>在<code>userprofile</code>目录中创建表单类的文件<code>forms.py</code>，编写如下代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>forms<span class="token punctuation">.</span>py<span class="token comment"># 引入表单类</span><span class="token keyword">from</span> django <span class="token keyword">import</span> forms<span class="token comment"># 引入 User 模型</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token comment"># 登录表单，继承了 forms.Form 类</span><span class="token keyword">class</span> <span class="token class-name">UserLoginForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>Form<span class="token punctuation">)</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span><span class="token punctuation">)</span>    password <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在前面发表文章的模块中，表单类继承了<code>forms.ModelForm</code>，这个父类<strong>适合于需要直接与数据库交互的功能</strong>，比如新建、更新数据库的字段等。如果表单将用于直接添加或编辑Django模型，则可以使用 <code>ModelForm</code>来避免重复书写字段描述。</p><p>而<code>forms.Form</code>则需要手动配置每个字段，<strong>它适用于不与数据库进行直接交互的功能</strong>。用户登录不需要对数据库进行任何改动，因此直接继承<code>forms.Form</code>就可以了。</p><h2 id="编写视图"><a href="#编写视图" class="headerlink" title="编写视图"></a>编写视图</h2><p>用户的登录是比较复杂的功能，好在Django提供了封装好的模块供我们使用。</p><p>首先在<code>userprofile/views.py</code>中写视图函数：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token punctuation">,</span> redirect<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth <span class="token keyword">import</span> authenticate<span class="token punctuation">,</span> login<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse<span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> UserLoginForm<span class="token comment"># Create your views here.</span><span class="token keyword">def</span> <span class="token function">user_login</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        user_login_form <span class="token operator">=</span> UserLoginForm<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>        <span class="token keyword">if</span> user_login_form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment"># .cleaned_data 清洗出合法数据</span>            data <span class="token operator">=</span> user_login_form<span class="token punctuation">.</span>cleaned_data            <span class="token comment"># 检验账号、密码是否正确匹配数据库中的某个用户</span>            <span class="token comment"># 如果均匹配则返回这个 user 对象</span>            user <span class="token operator">=</span> authenticate<span class="token punctuation">(</span>username<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> password<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> user<span class="token punctuation">:</span>                <span class="token comment"># 将用户数据保存在 session 中，即实现了登录动作</span>                login<span class="token punctuation">(</span>request<span class="token punctuation">,</span> user<span class="token punctuation">)</span>                <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"article:article_list"</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"账号或密码输入有误。请重新输入~"</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"账号或密码输入不合法"</span><span class="token punctuation">)</span>    <span class="token keyword">elif</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>        user_login_form <span class="token operator">=</span> UserLoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'form'</span><span class="token punctuation">:</span> user_login_form <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'userprofile/login.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"请使用GET或POST请求数据"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>跟发表文章的表单类类似，Form对象的主要任务就是验证数据。调用<code>is_valid()</code>方法验证并返回指定数据是否有效的布尔值。</p></li><li><p><code>Form</code>不仅负责验证数据，还可以“清洗”它：将其标准化为一致的格式，这个特性使得它允许以各种方式输入特定字段的数据，<strong>并且始终产生一致的输出。</strong>一旦<code>Form</code>使用数据创建了一个实例并对其进行了<strong>验证</strong>，就可以通过<code>cleaned_data</code>属性访问清洗之后的数据。</p></li><li><p><code>authenticate()</code>方法验证用户名称和密码是否匹配，如果是，则将这个用户数据返回。</p></li><li><p><code>login()</code>方法实现用户登录，将用户数据保存在session中。</p></li></ul><p>其他的内容就跟发表文章时的技巧类似了。</p><h3 id="什么是session"><a href="#什么是session" class="headerlink" title="什么是session"></a>什么是session</h3><p>Session在网络应用中，称为<strong>“会话控制”</strong>，它存储特定用户会话所需的属性及配置信息。</p><p>当用户在 Web 页之间跳转时，存储在 Session 对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。</p><p>Session 最常见的用法就是存储用户的登录数据。</p><p>详情看这里：<a href="https://baike.baidu.com/item/Session/479100">Session百度百科</a></p><h2 id="登录的模板"><a href="#登录的模板" class="headerlink" title="登录的模板"></a>登录的模板</h2><p>接着写模板文件。</p><p>创建<code>/templates/userprofile/login.html</code>模板：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">/templates/userprofile/login.html&#123;% extends "base.html" %&#125; &#123;% load staticfiles %&#125;&#123;% block title %&#125; 登录 &#123;% endblock title %&#125;&#123;% block content %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                &#123;% csrf_token %&#125;                <span class="token comment">&lt;!-- 账号 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>账号<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 密码 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>密码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>                <span class="token comment">&lt;!-- 提交按钮 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>提交<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>&#123;% endblock content %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>内容与<a href="https://www.dusaiphoto.com/article/article-detail/22/">使用Form表单类发表新文章</a>非常类似。唯一新知识是输入密码表单的<code>type=&quot;password&quot;</code>，可以让输入密码的时候显示小圆点，避免有人偷窥。</p><p>然后我们改写一下<code>tempalates/header.html</code>，把登录的按钮加进去：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">/tempalates/header.html...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navbar-nav<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    ...        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-link<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>article:article_list<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>文章<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- Django的 if 模板语句 --></span>    &#123;% if user.is_authenticated %&#125;        <span class="token comment">&lt;!-- 如果用户已经登录，则显示用户名下拉框 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-item dropdown<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-link dropdown-toggle<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navbarDropdown<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">data-toggle</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown<span class="token punctuation">"</span></span> <span class="token attr-name">aria-haspopup</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">aria-expanded</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>              &#123;&#123; user.username &#125;&#125;            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown-menu<span class="token punctuation">"</span></span> <span class="token attr-name">aria-labelledby</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navbarDropdown<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown-item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>退出登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 如果用户未登录，则显示 “登录” --></span>    &#123;% else %&#125;        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nav-link<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;% url <span class="token punctuation">'</span>userprofile:login<span class="token punctuation">'</span> %&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>                        <span class="token comment">&lt;!-- if 语句在这里结束 --></span>    &#123;% endif %&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里使用了新的模板语法：<code>&#123;% if ... %&#125;</code>，用来判断用户是否已经登录：</p><ul><li>如果用户已经登录，则显示一个名字为用户名称的下拉框，就像通常的社交网站一样。</li><li>如果用户未登录，则显示“登录”两个字提醒用户可以点击登录。</li></ul><p><code>is_authenticated</code>是<code>models.User</code>类的属性，用于判断用户是否已通过身份验证。</p><h2 id="url及其他设置"><a href="#url及其他设置" class="headerlink" title="url及其他设置"></a>url及其他设置</h2><p>最后的步骤就是将app配置到项目中去。</p><p>创建<code>userprofile/urls.py</code>文件：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> viewsapp_name <span class="token operator">=</span> <span class="token string">'userprofile'</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token comment"># 用户登录</span>    path<span class="token punctuation">(</span><span class="token string">'login/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>user_login<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置根路由<code>my_blog/urls.py</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>my_blog<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token comment"># 用户管理</span>    path<span class="token punctuation">(</span><span class="token string">'userprofile/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'userprofile.urls'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'userprofile'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置<code>my_blog/settings.py</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">my_blog<span class="token operator">/</span>settings<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token string">'userprofile'</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因为<code>userprofile</code>这个app并没有改动model，因此不用迁移数据。</p><p>OK了，运行服务器，在admin后台中退出登录（找找页面右上角），返回到文章列表页：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181029/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE66.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181029/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE66.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击登录按钮，输入账号和密码（可以故意输错试试会出现什么）：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181029/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE68.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181029/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE68.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>点击提交，将自动回到文章列表页面：</p><p><img src="https://www.dusaiphoto.com/media/image/image_source/20181029/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE69.jpg" class="lazyload placeholder" data-srcset="https://www.dusaiphoto.com/media/image/image_source/20181029/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE69.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p><p>大功告成。</p><h2 id="用户的退出"><a href="#用户的退出" class="headerlink" title="用户的退出"></a>用户的退出</h2><p>有了用户登录的知识后，用户退出就很简单了。这里就直接给出代码，相信你一定能看懂。</p><p>还是先添加用户退出的视图：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>views<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 引入logout模块</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth <span class="token keyword">import</span> authenticate<span class="token punctuation">,</span> login<span class="token punctuation">,</span> logout<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># 用户退出</span><span class="token keyword">def</span> <span class="token function">user_logout</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    logout<span class="token punctuation">(</span>request<span class="token punctuation">)</span>    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"article:article_list"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后配置<code>/userprofile/urls.py</code>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>userprofile<span class="token operator">/</span>urls<span class="token punctuation">.</span>py<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'login/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>user_login<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment"># 用户退出</span>    path<span class="token punctuation">(</span><span class="token string">'logout/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>user_logout<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'logout'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在写登录的代码时，已经给用户退出留好了接口，因此只需要改动<code>/templates/header.html</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">/templates/header.html...# 改动 href 中的链接指向<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dropdown-item<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>&#123;% url <span class="token punctuation">"</span>userprofile:logout<span class="token punctuation">"</span> %&#125;<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>退出登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>保存后刷新页面，点击下拉框中“退出登录”选项，用户就顺利退出了。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章用到了表单类、if模板语句、用户验证等知识完成了用户管理的登录和退出。</p><p>接下来学习如何实现注册和删除。</p><ul><li>有疑问请在<a href="http://www.dusaiphoto.com/">杜赛的个人网站</a>留言，我会尽快回复。</li><li>或Email私信我：<a href="mailto:&#x64;&#117;&#115;&#x61;&#105;&#112;&#x68;&#111;&#116;&#x6f;&#64;&#x66;&#111;&#x78;&#109;&#97;&#x69;&#x6c;&#x2e;&#99;&#x6f;&#109;">&#x64;&#117;&#115;&#x61;&#105;&#112;&#x68;&#111;&#116;&#x6f;&#64;&#x66;&#111;&#x78;&#109;&#97;&#x69;&#x6c;&#x2e;&#99;&#x6f;&#109;</a></li><li>项目完整代码：<a href="https://github.com/stacklens/django_blog_tutorial">Django_blog_tutorial</a></li></ul><blockquote><p>转载请告知作者并注明出处。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Django博客网站搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之桥接模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-qiao-jie-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-qiao-jie-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="模式动机"><a href="#模式动机" class="headerlink" title="模式动机"></a>模式动机</h2><p>设想如果要绘制矩形、圆形、椭圆、正方形，我们至少需要4个形状类，但是如果绘制的图形需要具有不同的颜色，如红色、绿色、蓝色等，此时至少有如下两种设计方案：</p><ul><li>第一种设计方案是为每一种形状都提供一套各种颜色的版本。</li><li>第二种设计方案是根据实际需要对形状和颜色进行组合</li></ul><p>对于有两个变化维度（即两个变化的原因）的系统，采用方案二来进行设计系统中类的个数更少，且系统扩展更为方便。设计方案二即是桥接模式的应用。桥接模式将继承关系转换为关联关系，从而降低了类与类之间的耦合，减少了代码编写量。</p><h2 id="模式定义"><a href="#模式定义" class="headerlink" title="模式定义"></a>模式定义</h2><blockquote><p><strong>桥接模式</strong>(<code>Bridge Pattern</code>)：将抽象和实现解耦，使得两者可以独立地变化。它是一种对象结构型模式，又称为桥梁模式。</p></blockquote><h3 id="模式角色"><a href="#模式角色" class="headerlink" title="模式角色"></a>模式角色</h3><p>桥接模式包含如下角色：</p><ul><li><code>Abstraction</code>：抽象类角色</li><li><code>RefinedAbstraction</code>：扩充抽象类</li><li><code>Implementor</code>：实现化角色</li><li><code>ConcreteImplementor</code>：具体实现化角色的实现类</li></ul><h3 id="UML类图"><a href="#UML类图" class="headerlink" title="UML类图"></a>UML类图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/12/19/java-design-bridge.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/12/19/java-design-bridge.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="桥接模式UML"></p><h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p>首先，是实现化角色<code>Abstraction</code>类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 实现化角色 Implementor. * * @author blinkfox on 2018-12-17. */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Implementor</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 基本方法1.     */</span>    <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 基本方法2.     */</span>    <span class="token keyword">void</span> <span class="token function">doAnything</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后，是各个具体的实现化角色类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * ConcreteImplementor1. * * @author blinkfox on 2018-12-17. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteImplementor1</span> <span class="token keyword">implements</span> <span class="token class-name">Implementor</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 基本方法1.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ConcreteImplementor1 的业务逻辑 doSomething."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 基本方法2.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAnything</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ConcreteImplementor1 的业务逻辑 doAnything."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * ConcreteImplementor2. * * @author blinkfox on 2018-12-17. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteImplementor2</span> <span class="token keyword">implements</span> <span class="token class-name">Implementor</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 基本方法1.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ConcreteImplementor2 的业务逻辑 doSomething."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 基本方法2.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAnything</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ConcreteImplementor2 的业务逻辑 doAnything."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来，是抽象类角色<code>Abstraction</code>类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>blinkfox<span class="token punctuation">.</span>patterns<span class="token punctuation">.</span>bridge</span><span class="token punctuation">;</span><span class="token comment">/** * 抽象化角色 Abstraction. * * @author blinkfox on 2018-12-17. */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Abstraction</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** 定义对实现化角色的引用. */</span>    <span class="token keyword">private</span> <span class="token class-name">Implementor</span> impl<span class="token punctuation">;</span>    <span class="token comment">/**     * 构造方法.     *     * @param impl 实现类的实例     */</span>    <span class="token keyword">public</span> <span class="token class-name">Abstraction</span><span class="token punctuation">(</span><span class="token class-name">Implementor</span> impl<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>impl <span class="token operator">=</span> impl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * impl 的 getter方法.     *     * @return impl     */</span>    <span class="token keyword">public</span> <span class="token class-name">Implementor</span> <span class="token function">getImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> impl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 自身的请求处理方法.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>impl<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再次，是扩展的具体抽象化角色类<code>RefinedAbstraction</code>：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * RefinedAbstraction. * * @author blinkfox on 2018-12-17. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RefinedAbstraction</span> <span class="token keyword">extends</span> <span class="token class-name">Abstraction</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 构造方法.     *     * @param impl 实现类的实例     */</span>    <span class="token keyword">public</span> <span class="token class-name">RefinedAbstraction</span><span class="token punctuation">(</span><span class="token class-name">Implementor</span> impl<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>impl<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 覆盖后的请求处理方法.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"RefinedAbstraction 开始做业务处理."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doAnything</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后，是客户端场景类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Client. * * @author blinkfox on 2018-12-17. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * main方法.     *     * @param args 数组参数     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 定义一个实现化角色和抽象化角色,并执行请求方法.</span>        <span class="token class-name">Implementor</span> impl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteImplementor1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Abstraction</span> abs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RefinedAbstraction</span><span class="token punctuation">(</span>impl<span class="token punctuation">)</span><span class="token punctuation">;</span>        abs<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="模式分析"><a href="#模式分析" class="headerlink" title="模式分析"></a>模式分析</h2><p>理解桥接模式，重点需要理解如何将抽象化(<code>Abstraction</code>)与实现化(<code>Implementation</code>)脱耦，使得二者可以独立地变化。</p><ul><li><strong>抽象化</strong>：抽象化就是忽略一些信息，把不同的实体当作同样的实体对待。在面向对象中，将对象的共同性质抽取出来形成类的过程即为抽象化的过程。</li><li><strong>实现化</strong>：针对抽象化给出的具体实现，就是实现化，抽象化与实现化是一对互逆的概念，实现化产生的对象比抽象化更具体，是对抽象化事物的进一步具体化的产物。</li><li><strong>脱耦</strong>：脱耦就是将抽象化和实现化之间的耦合解脱开，或者说是将它们之间的强关联改换成弱关联，将两个角色之间的继承关系改为关联关系。<strong>桥接模式中的所谓脱耦，就是指在一个软件系统的抽象化和实现化之间使用关联关系（组合或者聚合关系）而不是继承关系，从而使两者可以相对独立地变化，这就是桥接模式的用意。</strong></li></ul><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>桥接模式的优点:</p><ul><li>分离抽象接口及其实现部分。</li><li>桥接模式有时类似于多继承方案，但是多继承方案违背了类的单一职责原则（即一个类只有一个变化的原因），复用性比较差，而且多继承结构中类的个数非常庞大，桥接模式是比多继承方案更好的解决方法。</li><li>桥接模式提高了系统的可扩充性，在两个变化维度中任意扩展一个维度，都不需要修改原有系统。</li><li>实现细节对客户透明，可以对用户隐藏实现细节。</li></ul><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>桥接模式的缺点:</p><ul><li>桥接模式的引入会增加系统的理解与设计难度，由于聚合关联关系建立在抽象层，要求开发者针对抽象进行设计与编程。 </li><li>桥接模式要求正确识别出系统中两个独立变化的维度，因此其使用范围具有一定的局限性。</li></ul><h3 id="适用环境"><a href="#适用环境" class="headerlink" title="适用环境"></a>适用环境</h3><p>在以下情况下可以使用桥接模式：</p><ul><li>如果一个系统需要在构件的抽象化角色和具体化角色之间增加更多的灵活性，避免在两个层次之间建立静态的继承联系，通过桥接模式可以使它们在抽象层建立一个关联关系。</li><li>抽象化角色和实现化角色可以以继承的方式独立扩展而互不影响，在程序运行时可以动态将一个抽象化子类的对象和一个实现化子类的对象进行组合，即系统需要对抽象化角色和实现化角色进行动态耦合。</li><li>一个类存在两个独立变化的维度，且这两个维度都需要进行扩展。</li><li>虽然在系统中使用继承是没有问题的，但是由于抽象化角色和具体化角色需要独立变化，设计要求需要独立管理这两者。</li><li>对于那些不希望使用继承或因为多层次继承导致系统类的个数急剧增加的系统，桥接模式尤为适用。</li></ul><h3 id="模式应用"><a href="#模式应用" class="headerlink" title="模式应用"></a>模式应用</h3><p>一个Java桌面软件总是带有所在操作系统的视感(<code>LookAndFeel</code>)，如果一个Java软件是在Unix系统上开发的，那么开发人员看到的是<code>Motif</code>用户界面的视感；在Windows上面使用这个系统的用户看到的是Windows用户界面的视感；而一个在<code>Macintosh</code>上面使用的用户看到的则是<code>Macintosh</code>用户界面的视感，Java语言是通过所谓的Peer架构做到这一点的。Java为AWT中的每一个GUI构件都提供了一个Peer构件，在AWT中的Peer架构就使用了桥接模式。</p><h3 id="模式扩展"><a href="#模式扩展" class="headerlink" title="模式扩展"></a>模式扩展</h3><p>适配器模式与桥接模式的联用:</p><p>桥接模式和适配器模式用于设计的不同阶段，<strong>桥接模式用于系统的初步设计</strong>，对于存在两个独立变化维度的类可以将其分为抽象化和实现化两个角色，使它们可以分别进行变化；而在初步设计完成之后，<strong>当发现系统与已有类无法协同工作时，可以采用适配器模式</strong>。但有时候在设计初期也需要考虑适配器模式，特别是那些涉及到大量第三方应用接口的情况。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>桥接模式将抽象部分与它的实现部分分离，使它们都可以独立地变化。它是一种对象结构型模式。</li><li>桥接模式包含如下四个角色：抽象类中定义了一个实现类接口类型的对象并可以维护该对象；扩充抽象类扩充由抽象类定义的接口，它实现了在抽象类中定义的抽象业务方法，在扩充抽象类中可以调用在实现类接口中定义的业务方法；实现类接口定义了实现类的接口，实现类接口仅提供基本操作，而抽象类定义的接口可能会做更多更复杂的操作；具体实现类实现了实现类接口并且具体实现它，在不同的具体实现类中提供基本操作的不同实现，在程序运行时，具体实现类对象将替换其父类对象，提供给客户端具体的业务操作方法。</li><li>在桥接模式中，抽象化(<code>Abstraction</code>)与实现化(<code>Implementation</code>)脱耦，它们可以沿着各自的维度独立变化。</li><li>桥接模式的主要优点是分离抽象接口及其实现部分，是比多继承方案更好的解决方法，桥接模式还提高了系统的可扩充性，在两个变化维度中任意扩展一个维度，都不需要修改原有系统，实现细节对客户透明，可以对用户隐藏实现细节；其主要缺点是增加系统的理解与设计难度，且识别出系统中两个独立变化的维度并不是一件容易的事情。</li><li>桥接模式适用情况包括：需要在构件的抽象化角色和具体化角色之间增加更多的灵活性，避免在两个层次之间建立静态的继承联系；抽象化角色和实现化角色可以以继承的方式独立扩展而互不影响；一个类存在两个独立变化的维度，且这两个维度都需要进行扩展；设计要求需要独立管理抽象化角色和具体化角色；不希望使用继承或因为多层次继承导致系统类的个数急剧增加的系统。</li></ul><p>参考自：<a href="https://design-patterns.readthedocs.io/zh_CN/latest/structural_patterns/bridge.html">桥接模式</a></p>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之适配器模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-gua-pei-qi-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-gua-pei-qi-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="模式动机"><a href="#模式动机" class="headerlink" title="模式动机"></a>模式动机</h2><ul><li>在软件开发中采用类似于电源适配器的设计和编码技巧被称为适配器模式。</li><li>通常情况下，客户端可以通过目标类的接口访问它所提供的服务。有时，现有的类可以满足客户类的功能需要，但是它所提供的接口不一定是客户类所期望的，这可能是因为现有类中方法名与目标类中定义的方法名不一致等原因所导致的。</li><li>在这种情况下，现有的接口需要转化为客户类期望的接口，这样保证了对现有类的重用。如果不进行这样的转化，客户类就不能利用现有类所提供的功能，适配器模式可以完成这样的转化。</li><li>在适配器模式中可以定义一个包装类，包装不兼容接口的对象，这个包装类指的就是适配器(<code>Adapter</code>)，它所包装的对象就是适配者(<code>Adaptee</code>)，即被适配的类。</li><li>适配器提供客户类需要的接口，适配器的实现就是把客户类的请求转化为对适配者的相应接口的调用。也就是说：当客户类调用适配器的方法时，在适配器类的内部将调用适配者类的方法，而这个过程对客户类是透明的，客户类并不直接访问适配者类。因此，适配器可以使由于接口不兼容而不能交互的类可以一起工作。这就是适配器模式的模式动机。</li></ul><h2 id="模式定义"><a href="#模式定义" class="headerlink" title="模式定义"></a>模式定义</h2><blockquote><p><strong>适配器模式</strong>(<code>Adapter Pattern</code>) ：将一个接口转换成客户希望的另一个接口，使接口不兼容的那些类可以一起工作，其别名为包装器(<code>Wrapper</code>)。适配器模式既可以作为类结构型模式，也可以作为对象结构型模式。适配器模式是一种<strong>结构型模式</strong>。</p></blockquote><h2 id="模式结构"><a href="#模式结构" class="headerlink" title="模式结构"></a>模式结构</h2><h3 id="参与角色"><a href="#参与角色" class="headerlink" title="参与角色"></a>参与角色</h3><p>适配器模式包含如下角色：</p><ul><li><code>Target</code>：目标抽象类</li><li><code>Adapter</code>：适配器类</li><li><code>Adaptee</code>：适配者类</li><li><code>Client</code>：客户类</li></ul><h3 id="UML类图"><a href="#UML类图" class="headerlink" title="UML类图"></a>UML类图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/12/12/adapter-structure.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/12/12/adapter-structure.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="适配器模式UML"></p><h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p>首先，是目标角色接口和具体目标实现类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Target 目标角色类. * * @author blinkfox on 2018-12-11. */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Target</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 目标角色自己的方法.     */</span>    <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的目标角色实现类. * * @author blinkfox on 2018-12-11. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteTarget</span> <span class="token keyword">implements</span> <span class="token class-name">Target</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 目标角色自己的方法.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello, I'm concrete target method."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其次，是适配者类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 适配者类. * * @author blinkfox on 2018-12-11. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Adaptee</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 这是原有的业务逻辑方法.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello, I'm Adaptee method."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后，是适配器角色类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 适配器类. * * @author blinkfox on 2018-12-11. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Adapter</span> <span class="token keyword">extends</span> <span class="token class-name">Adaptee</span> <span class="token keyword">implements</span> <span class="token class-name">Target</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 适配了目标角色自己的方法.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"适配器适配了目标角色方法."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后，是客户端场景类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 客户端场景类. * * @author blinkfox on 2018-12-11. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * main方法.     *     * @param args 数组参数     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 原有业务逻辑.</span>        <span class="token class-name">Target</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        target<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 增加了适配器角色后的业务逻辑.</span>        <span class="token class-name">Target</span> adaptTarget <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Adapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        adaptTarget<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="模式分析"><a href="#模式分析" class="headerlink" title="模式分析"></a>模式分析</h2><h3 id="适用环境"><a href="#适用环境" class="headerlink" title="适用环境"></a>适用环境</h3><p>在以下情况下可以使用适配器模式：</p><ul><li>系统需要使用现有的类，而这些类的接口不符合系统的需要。</li><li>想要建立一个可以重复使用的类，用于与一些彼此之间没有太大关联的一些类，包括一些可能在将来引进的类一起工作。</li></ul><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul><li>将目标类和适配者类解耦，通过引入一个适配器类来重用现有的适配者类，而无须修改原有代码。</li><li>增加了类的透明性和复用性，将具体的实现封装在适配者类中，对于客户端类来说是透明的，而且提高了适配者的复用性。</li><li>灵活性和扩展性都非常好，通过使用配置文件，可以很方便地更换适配器，也可以在不修改原有代码的基础上增加新的适配器类，完全符合“开闭原则”。</li></ul><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>如果一定要置换掉适配者类的一个或多个方法，就只好先做一个适配者类的子类，将适配者类的方法置换掉，然后再把适配者类的子类当做真正的适配者进行适配，实现过程较为复杂。</p><h3 id="模式应用"><a href="#模式应用" class="headerlink" title="模式应用"></a>模式应用</h3><p>Sun公司在1996年公开了Java语言的数据库连接工具JDBC，JDBC使得Java语言程序能够与数据库连接，并使用SQL语言来查询和操作数据。JDBC给出一个客户端通用的抽象接口，每一个具体数据库引擎（如SQL Server、Oracle、MySQL等）的JDBC驱动软件都是一个介于JDBC接口和数据库引擎接口之间的适配器软件。抽象的JDBC接口和各个数据库引擎API之间都需要相应的适配器软件，这就是为各个不同数据库引擎准备的驱动程序。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>结构型模式描述如何将类或者对象结合在一起形成更大的结构。</li><li>适配器模式用于将一个接口转换成客户希望的另一个接口，适配器模式使接口不兼容的那些类可以一起工作，其别名为包装器。适配器模式既可以作为类结构型模式，也可以作为对象结构型模式。</li><li>适配器模式包含四个角色：目标抽象类定义客户要用的特定领域的接口；适配器类可以调用另一个接口，作为一个转换器，对适配者和抽象目标类进行适配，它是适配器模式的核心；适配者类是被适配的角色，它定义了一个已经存在的接口，这个接口需要适配；在客户类中针对目标抽象类进行编程，调用在目标抽象类中定义的业务方法。</li><li>在类适配器模式中，适配器类实现了目标抽象类接口并继承了适配者类，并在目标抽象类的实现方法中调用所继承的适配者类的方法；在对象适配器模式中，适配器类继承了目标抽象类并定义了一个适配者类的对象实例，在所继承的目标抽象类方法中调用适配者类的相应业务方法。</li><li>适配器模式的主要优点是将目标类和适配者类解耦，增加了类的透明性和复用性，同时系统的灵活性和扩展性都非常好，更换适配器或者增加新的适配器都非常方便，符合“开闭原则”；类适配器模式的缺点是适配器类在很多编程语言中不能同时适配多个适配者类，对象适配器模式的缺点是很难置换适配者类的方法。</li><li>适配器模式适用情况包括：系统需要使用现有的类，而这些类的接口不符合系统的需要；想要建立一个可以重复使用的类，用于与一些彼此之间没有太大关联的一些类一起工作。</li></ul><p>参考自：<a href="https://design-patterns.readthedocs.io/zh_CN/latest/structural_patterns/adapter.html">适配器模式</a></p>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>软件程序设计原则</title>
      <link href="/post/ruan-jian-she-ji/ruan-jian-cheng-xu-she-ji-yuan-ze/"/>
      <url>/post/ruan-jian-she-ji/ruan-jian-cheng-xu-she-ji-yuan-ze/</url>
      
        <content type="html"><![CDATA[<h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>软件也像人一样，具有生命力，从出生到死亡，会经历多种变化。软件架构设计也不是一蹴而就的，是不断地演进发展。每个程序员都可以从理解编程原则和模式中受益。</p><p>软件设计原则是一组帮助我们避开不良设计的指导方针。根据<code>Robert Martin</code>的理论，应该避免不良设计的以下三个重要特点：</p><ul><li><strong>僵化</strong>：很难做改动，因为每一个细微的改动都会影响到系统大量的其他功能</li><li><strong>脆弱</strong>：每当你做一次改动，总会引起系统中预期之外的部分出现故障</li><li><strong>死板</strong>：代码很难在其他应用中重用，因其不能从当前应用中单独抽离出来</li></ul><p>下面这些软件设计原则是我从一些书籍和网络中收集而来，并不完整，而且你也需要在一些有“冲突的原则”之间进行权衡和取舍。本文或许会对你的编程、程序设计、讨论或评审工作有所帮助。</p><h2 id="二、通用设计原则"><a href="#二、通用设计原则" class="headerlink" title="二、通用设计原则"></a>二、通用设计原则</h2><h3 id="1-KISS"><a href="#1-KISS" class="headerlink" title="1. KISS"></a>1. KISS</h3><p>所谓<code>KISS</code>原则，即：<code>Keep It Simple,Stupid</code>，指<strong>设计时要坚持简约原则，避免不必要的复杂化，并且易于修改</strong>。</p><blockquote><p>Everything should be made as simple as possible, but not simpler. - Albert Einstein</p></blockquote><p>简单清晰、功能强大是软件设计最重要的原则和目标。但是软件工程天然错综复杂，而“简单”却没有一个衡量标准，判断和实现一个东西是不是简单，可以通过以下方式来参考。</p><ul><li>让别的软件工程师以一种最容易的方式使用你的方案。</li><li>简单不是走捷径，不是为手边的问题找一个最快的方案。</li><li>当系统变得更庞大更复杂的时候依然能够被理解。</li><li>如果系统无法保持简单，那么我们能做的就是保持各个局部简单，即任何单个的类、模块、应用的设计目标及工作原理都能被快速理解。</li></ul><blockquote><p><strong>我的理解</strong>：保持简单但不能掩盖软件丰富的内涵。即<strong>简约而不简单</strong>！简约是对复杂的事物抽丝剥茧、去除细枝末节显露主要逻辑的过程。就像小时候老师教写文章，要求尽可能用朴实的语言，言简意赅的写出来，但却又要避免语言过于贫乏。软件的“抽象”和它的“直观性”，其实是一对矛盾的关系，软件设计就要保证这两者的平衡。代码抽象过于复杂会陷入“过度设计”不易理解的困境；为了“直观性”缺乏抽象，长此以往又会出现大量的重复、不易于扩展和难维护的困境。</p></blockquote><h3 id="2-DRY"><a href="#2-DRY" class="headerlink" title="2. DRY"></a>2. DRY</h3><p>所谓<code>DRY</code>原则，即：<code>Don&#39;t Repeat Yourself</code>，<strong>不要让自己重复</strong>。</p><p><strong>重复代码是软件程序变烂的万恶之首</strong>。<code>DRY</code>并不是指你不能复制代码，而是你复制的代码不能包含重复的“信息”。复制的东西并不仅仅是复制了代码，而是由于你把同一个信息散播在了代码的各个部分导致了有很多相近的代码也散播在各个地方。代码之所以要写的好，不要重复某些“信息”，因为需求人员总是要改需求，不改代码你就要“死”，改代码你就要加班，所以为了减少修改代码的痛苦，我们不能重复任何信息。举个例子，有一天需求人员说，要把分隔符从分号改成顿号！一下子就要改多个地方了。</p><p>所以，<strong>去掉重复的信息会让你的代码结构发生本质的变化</strong>。</p><p>“重复代码”有很多变体：</p><ul><li>魔法数字、魔法字符串等</li><li>相同代码块</li><li>相似的代码逻辑及操作</li></ul><p>对于消除重复的代码有<strong>事不过三</strong>法则。</p><ul><li>第一次先写了一段代码。</li><li>第二次在另一个地方写了一段相同或相似逻辑的代码，你已经有消除和提取重复代码的冲动了。</li><li>再次在另一个地方写了同样的代码，你已忍无可忍，现在可以考虑抽取和消除重复代码了。</li></ul><blockquote><p><strong>我的理解</strong>：解决重复的最佳的方式是通过培养良好的编码习惯来避免重复，通过重构的手段来消除重复。发现和解决重复并不困难，通过提取抽象、提取方法等措施就能消除重复，但困难的是<strong>立即行动</strong>去解决重复，从而不断的磨砺和提升自己的编程技艺，不断将私人代码变成公共代码，这才是自我提升的过程。解决了重复，经过一段时间，你就会发现，你对整个系统的理解程度在不知不觉中提高了不少。</p></blockquote><h3 id="3-Maximize-Cohesion，-Minimize-Coupling"><a href="#3-Maximize-Cohesion，-Minimize-Coupling" class="headerlink" title="3. Maximize Cohesion， Minimize Coupling"></a>3. Maximize Cohesion， Minimize Coupling</h3><p>所谓<code>Maximize Cohesion,Minimize Coupling</code>原则，即：<strong>高内聚低耦合</strong>。这是判断设计好坏的标准，主要是看<strong>模块内的内聚性是否高，模块间的耦合度是否低。</strong></p><ul><li><strong>耦合性</strong>：也称块间联系。指软件系统结构中各模块间相互联系紧密程度的一种度量。模块之间联系越紧密，其耦合性就越强，模块的独立性则越差。模块间耦合高低取决于模块间接口的复杂性、调用的方式及传递的信息。耦合是软件结构中各模块之间相互连接的一种度量，耦合强弱取决于模块间接口的复杂程度、进入或访问一个模块的点以及通过接口的数据。</li><li><strong>内聚性</strong>：又称块内联系。指模块的功能强度的度量，即一个模块内部各个元素彼此结合的紧密程度的度量。若一个模块内各元素（语名之间、程序段之间）联系的越紧密，则它的内聚性就越高。内聚是从功能角度来度量模块内的联系，一个好的内聚模块应当恰好做一件事。它描述的是模块内的功能联系。</li></ul><p>内聚和耦合是密切相关的，同其他模块存在高耦合的模块意味着低内聚，而高内聚的模块意味着该模块同其他模块之间是低耦合。在进行软件设计时，应力争做到高内聚，低耦合。</p><p>Java中实现高内聚低耦合的常用方式：</p><ul><li>少使用类的继承，多用接口隐藏实现的细节。</li><li>模块的功能化分尽可能的单一，道理也很简单，功能单一的模块供其它模块调用的机会就少。</li><li>遵循一个定义只在一个地方出现。</li><li>少使用全局变量。</li><li>类属性和方法的声明少用<code>public</code>，多用<code>private</code>关键字，</li><li>多用设计模式，比如采用<code>MVC</code>的设计模式就可以降低界面与业务逻辑的耦合度。</li><li>尽量不用“硬编码”的方式写程序。</li><li>最后当然就是避免直接操作或调用其它模块或类（内容耦合）。</li></ul><h3 id="4-SOC"><a href="#4-SOC" class="headerlink" title="4. SOC"></a>4. SOC</h3><p>所谓<code>SOC</code>原则，即：<strong>关注点分离</strong>（<code>Separation of Concerns</code>）。<strong>不同领域的功能，应该由不同的代码和最小重迭的模块组成。</strong>关注点分离是处理复杂性的一个原则。由于关注点混杂在一起会导致软件程序复杂性大大增加，所以能够把不同的关注点分离开来，分别处理就是处理复杂性的一个原则，一种方法。关注点分离原则不仅体现在软件程序设计等设计方法中，同时也体现在架构设计、问题求解、软件开发过程、软件项目管理以及软件开发方法学等诸多方面。</p><p><code>MVC</code>就是关注点分离的一个体现，把业务逻辑、数据、界面分离，这也是组织代码结构的一个形式。<code>MVC</code>的基本结构：</p><ul><li><code>Model</code>层表示应用程序的数据核心，通常负责在数据库中存取数据。</li><li><code>View</code>是应用程序的显示层，通常是依据模型的数据而建立。</li><li><code>Controller</code>是用来控制和处理输入输出的，是处理用户交互的部分，也负责向模型（<code>Model</code>层）发送数据。</li></ul><p><code>MVC</code>的这个设计各个关注点是分开的，这样有助于我们管理和开发复杂的应用程序，我们可以在某个时间点只集中精力在其中的某一个关注点，而不是所有的部分。</p><blockquote><p>好的架构必须使每个关注点相互分离，也就是说系统中的一个部分发生了变化，不会影响其他部分。即使需要改变，也能够清晰地识别出那些部分需要改变。如果需要扩展架构，影响将会最小化，已经可以工作的每个部分都将继续工作。——Ivar Jacobson(《AOSD中文版》)</p></blockquote><h4 id="分离方式"><a href="#分离方式" class="headerlink" title="分离方式"></a>分离方式</h4><p>下面将介绍一些分层的思想和方式:</p><ul><li><strong>纵向分离</strong>: 如常见的三层架构（逻辑控制层、业务处理层和数据持久化层）。</li><li><strong>横向分离</strong>: 如把我们的软件拆分成模块或子系统。从左到右是模块1、模块2、模块3，这是一种水平方向的切割。这跟纵向的分离是两个不同的方向，横向分离大多是模块化的过程。</li><li><strong>切面分离</strong>: 有些内容是多个层之间都需要的，比如日志（<code>log</code>），在你的系统里面，界面层、逻辑层、数据访问层可能都需要写日志，这种跨到多层同样逻辑就可以考虑切面分离。</li><li><strong>依赖方向分离</strong>: 按依赖方向考虑，决定某个类应该放在哪个层次里面，或者考虑将某一层切割成多层。</li><li><strong>关注数据分离</strong>: 在组织数据时，应该尽量考虑数据本身的固有属性，如果不是它们的固有属性，那么应该分离出来。比如产品的类就不应该关联<code>customer</code>类，应该是用订单类来把他们联系在一起。</li><li><strong>关注行为分离</strong>: 行为也应该是事物或对象的固有的本身的行为，明显偏离原来行为的，应该考虑成另外的关注点儿分离开。比如有一个函数叫做<code>CreateNewCustomer()</code>，那么<code>CreateNewCustomer()</code>的行为就应该限定在创建一个新客户上面，给新客户自动发优惠券的动作就不能放到这个函数里面。</li><li><strong>扩展分离</strong>: 如果基于某种设计，原先不具有某些行为需要增加，可以考虑通过扩展或插件的形式来完成，将这些功能放入到插件或扩展中。</li><li><strong>反转分离</strong>: 很多依赖注入的框架，如<code>Spring</code>、<code>Guice</code>等等，这些帮助我们做依赖反转，从而倒置依赖关系。</li></ul><h3 id="5-YAGNI"><a href="#5-YAGNI" class="headerlink" title="5. YAGNI"></a>5. YAGNI</h3><p>所谓<code>YAGNI</code>原则，即：<code>You Ain’t Gonna Need It</code>，<strong>你不需要它</strong>。它是一种极限编程（XP）实践，表示程序员不应为目前还不需要的功能编写代码。<code>YAGNI</code>很像<code>KISS</code>原则，因为它也是致力于构建简单的方案。然而，<code>KISS</code>是通过尽可能容易的完成某件事情来实现精简方案；但<code>YAGNI</code>是通过根本就不实现它来达到精简。<code>YAGNI</code>的观点是你应该<strong>为了眼前的需求做设计而不是未来</strong>。</p><blockquote><p>只在真正需要某些功能的时候才去实现它，而不是仅仅因为你预见到它将出现。- XP的联合创始人Ron Jeffries</p></blockquote><p>即使你非常确信将来你需要某个特性，也不要现在就去实现它。在很多情况下，你会发现或许最终你不需要它了，或者是你真正所需的特性与你之前预计的有很大的出入。遵循 YAGNI 实践有两个主要原因：</p><ul><li>你节约了时间，因为你避免了编写最终证明不必要的代码。</li><li>你的代码质量更高了，因为你使代码不必为你的“推测”所污染，而这些“推测”最终可能或多或少有些错误，但此时这些错误已牢牢地依附在你的代码中了。</li></ul><blockquote><p><strong>我的理解</strong>：YAGNI 原则，本质上是告诫我们<strong>写代码不要画蛇添足，否则就会弄巧成拙了</strong>。编写业务代码时，不要去假想一些需求或者场景，因为大多数你所设想的场景都不会发生，而你所多写的那些代码也将会长期滞留在你的系统中，收效甚微，但却让你和团队花费了更多的时间和精力去书写和维护，更可怕的是可能会对将来新的代码维护人造成困惑。另外对于没有被使用到的代码，我认为也都应该立即删除，从而保持系统的精简，如果将来需要时再去书写或恢复，而且那时侯写出的代码也绝对比之前的更为契合。</p></blockquote><h3 id="6-Boy-Scout-Rule"><a href="#6-Boy-Scout-Rule" class="headerlink" title="6. Boy-Scout Rule"></a>6. Boy-Scout Rule</h3><p><code>Boy-Scout Rule</code>，译为：<strong>童子军规则</strong>。美国童子军有一个简单的规则：“让营地比你刚来时更干净(<code>Always leave the campground cleaner than you found it</code>)”。如果看到地上有垃圾，不管是谁扔的，都要清理。这样你就有意地为下一批来宿营的人改善了环境。</p><p>童子军规则告诉我们在对现有代码库进行更改时，代码质量往往会降低，从而积累技术债务。所以需要<strong>始终保持代码整洁</strong>。不管原作者是谁，如果我们努力去改进代码模块，不管是多么小的改进，我们的软件系统就再也不会持续变坏了。取而代之的是，系统在发展的同时会逐渐变得更好。我们也会看到团队们关心整体的系统，而不是各自只关心自己负责的一小部分。而且团队成员要互助，互相清理代码，他们遵从童子军规则，因为那对每个人都很好，而不仅仅是对自己好。</p><p>关于童子军规则中所提倡的<strong>对代码坏味道的尽早修复</strong>，我也想起来了我们所熟知的“<strong>破窗效应</strong>”和“<strong>讳疾忌医</strong>”的典故：</p><h4 id="破窗效应"><a href="#破窗效应" class="headerlink" title="破窗效应"></a>破窗效应</h4><blockquote><p>如果有人打坏了一幢建筑物的窗户玻璃，而这扇窗户又得不到及时的维修，别人就可能受到某些示范性的纵容去打烂更多的窗户。久而久之，这些破窗户就给人造成一种无序的感觉，结果在这种公众麻木不仁的氛围中，犯罪就会滋生、猖獗。——政治学家威尔逊和犯罪学家凯琳提出的“破窗效应”理论</p></blockquote><ul><li>“环境早就脏了，我扔的这点儿垃圾根本起不到关键性作用。”</li><li>“这个代码以前的其他人也都是这样写的。”</li><li>“反正也不是只有我才这么写代码的。”</li></ul><p>不少人会像上面这样辩解自己的过错。其实，这些说法根本站不住脚，错了就是错了，影响的大小并不能改变行为错误的本质，别人的错误更不会是证明你无错的理由。任何一种不良现象的存在，都有可能传递一种错误信息。进而导致更坏的后果，正所谓“<strong>千里之堤，溃于蚁穴</strong>”、<strong>勿以善小而不为，勿以恶小而为之</strong>。</p><h4 id="讳疾忌医的典故"><a href="#讳疾忌医的典故" class="headerlink" title="讳疾忌医的典故"></a>讳疾忌医的典故</h4><p><img src="https://statics.sh1a.qingstor.com/2018/11/24/hjjy.jpeg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/24/hjjy.jpeg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="扁鹊三连"></p><p>《扁鹊见蔡桓公》的故事，我们从小就学习了，告诉我们不能盲目相信自己，不能讳疾忌医。但想想我们自己代码的坏味道和bug，也是如出一辙。</p><p>代码坏味道或者糟糕的程序代码就像隐形的“疾病”一样潜伏在项目中，也因此形成了技术债务。如果这些“疾病”在项目初期不引起注关注、不把疾病扼杀在萌芽之中，那么后期修复它的代价也就越大，也必然会使得项目的软件程序越来越难以维护，这个项目也最终会像蔡桓公一样无药可治、“无奈何也”。</p><blockquote><p>所以，请记住童子军规则对我们的启示：<strong>始终保持代码整洁，勿以善小而不为，勿以恶小而为之，有病早治</strong>。</p></blockquote><h3 id="其他原则："><a href="#其他原则：" class="headerlink" title="其他原则："></a>其他原则：</h3><ul><li><strong>避免过早优化</strong>（<code>Avoid Premature Optimization</code>）: 除非你的代码运行的比你想像中的要慢，否则别去优化。假如你真的想优化，就必须先想好如何用数据证明，它的速度变快了。“<strong>过早的优化是一切罪恶之源</strong>。”——Donald Knuth</li><li><strong>最小惊讶原则</strong>(<code>Principle of least astonishment</code>): 代码应该尽可能减少让读者惊喜。也就是说，你编写的代码只需按照项目的要求来编写。其他华丽的功能就不必了，以免弄巧成拙。</li><li><strong>代码重用原则</strong>（<code>Code Reuse is Good</code>）: 重用代码能提高代码的可读性，缩短开发时间。</li><li><strong>别让我思考</strong>(<code>Don’t Make Me Think</code>): 所编写的代码一定要易于读易于理解，这样别人才会欣赏，也能够给你提出合理化的建议。相反，若是繁杂难解的程序，其他人总是会避而远之的。</li><li><strong>为维护者写代码</strong>(<code>Write Code for the Maintainer</code>): 优秀的代码，应当使本人或是他人在将来都能够对它继续编写或维护。代码维护时，或许本人会比较容易，但对他人却比较麻烦。因此你写的代码要尽可能保证他人能够容易维护。“如果一个维护者不再继续维护你的代码，很可能他就有了想杀你的冲动。”</li><li><strong>正交原则(Orthogonality)</strong>: 正交性的基本思想是，在概念上不相关的事物不应该与系统相关。设计越正交，异常越少。 这使得用编程语言更容易学习，读写程序。(反例：<code>CSS</code>)。</li><li><strong>做最简单的事儿就让代码可运行</strong>（<code>Do the simplest thing that could possibly work</code>）: 尽可能做最简单的事就可以让代码可运行。在编程中，一定要保持简单原则。作为一名程序员不断的反思“如何在工作中做到简化呢？”这将有助于在设计中保持简单的路径。</li><li><strong>隐藏实现细节</strong>（<code>Hide Implementation Details</code>）: 软件模块通过提供接口隐藏信息（即实现细节），而不泄漏任何不必要的信息。</li><li><strong>科里定律</strong>(<code>Curly&#39;s Law</code>): 是为任何特定的代码选择一个明确定义的目标：<strong>只做一件事</strong>。</li><li><strong>墨菲定律</strong>（<code>Murphy&#39;s Law</code>）:根本内容是：<strong>如果事情有变坏的可能，不管这种可能性有多小，它总会发生</strong>。主要内容如下：<ul><li>任何事都没有表面看起来那么简单；</li><li>所有的事都会比你预计的时间长；</li><li>会出错的事总会出错；</li><li>如果你担心某种情况发生，那么它就更有可能发生。</li></ul></li></ul><h2 id="三、面向对象设计原则"><a href="#三、面向对象设计原则" class="headerlink" title="三、面向对象设计原则"></a>三、面向对象设计原则</h2><h3 id="1-SRP"><a href="#1-SRP" class="headerlink" title="1. SRP"></a>1. SRP</h3><p>所谓<code>SRP</code>原则，即：<code>Single Responsibility Principle</code>，<strong>单一职责原则</strong>。原始定义如下：</p><blockquote><p>There should never be more than one reason for a class to change.(<strong>只有一个引起类改变的原因</strong>)</p></blockquote><p>在面向对象编程领域中，单一职责原则（<code>Single responsibility principle</code>）规定每个类都应该有一个单一的职责或者叫功能，并且该功能应该由这个类完全封装起来。所有它的（这个类的）服务都应该严密的和该功能平行（功能平行，意味着没有依赖）。一个类或者模块应该有且只有一个改变的原因。</p><p>如果一个类承担的职责过多，就等于把这些职责耦合在一起了。一个职责的变化可能会削弱或者抑制这个类完成其他职责的能力。这种耦合会导致脆弱的设计，当发生变化时，设计会遭受到意想不到的破坏。而如果想要避免这种现象的发生，就要尽可能的遵守单一职责原则。此原则的核心就是<strong>解耦</strong>和<strong>增强内聚性</strong>。</p><h4 id="单一职责的好处："><a href="#单一职责的好处：" class="headerlink" title="单一职责的好处："></a>单一职责的好处：</h4><ul><li>类的复杂性降低，实现什么职责都有清晰明确的定义;</li><li>可读性提高，复杂性降低，可维护性提高;</li><li>变更引起的风险降低。</li></ul><h4 id="单一职责原则的注意点："><a href="#单一职责原则的注意点：" class="headerlink" title="单一职责原则的注意点："></a>单一职责原则的注意点：</h4><ul><li>单一职责最难划分的是<strong>职责</strong>。</li><li>单一职责原则提出标准：用职责和变化原因来衡量接口或类设计的是否优良，但是职责和变化原因都是不可度量的，因项目、环境而异。</li><li>接口一定要做到单一职责，类的设计尽量做到只有一个原因引起它变化。</li></ul><h3 id="2-LSP"><a href="#2-LSP" class="headerlink" title="2. LSP"></a>2. LSP</h3><p>所谓<code>LSP</code>原则，即：<code>Liskov Substitution principle</code>，<strong>里氏替换原则</strong>。原始定义如下：</p><blockquote><p>Functions that use pointers of references to base classes must be able to use objects of derived classes without knowing it.（<strong>所有引用基类的地方必须能透明地使用其子类的对象</strong>）</p></blockquote><p>更通俗的定义即为：<strong>子类可以扩展父类的功能，但不能改变父类原有的功能</strong>。里氏替换原则包含了一下4层含义：</p><ul><li>子类必须完全实现父类的方法。在类中调用其他类是务必要使用父类或接口，如果不能使用父类或接口，则说明类的设计已经违背了<code>LSP</code>原则。</li><li>子类可以有自己的个性。子类当然可以有自己的行为和外观了，也就是方法和属性。</li><li>覆盖或实现父类的方法时输入参数可以被放大。即子类可以覆盖父类的方法，但输入参数应比父类方法中的大，这样在子类代替父类的时候，调用的仍然是父类的方法。即以子类中方法的前置条件必须与超类中被覆盖的方法的前置条件相同或者更宽松。</li><li>覆盖或实现父类的方法时输出结果可以被缩小。</li></ul><h4 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h4><ul><li>提高代码的重用性，子类拥有父类的方法和属性；</li><li>提高代码的可扩展性，子类可形似于父类，但异于父类，保留自我的特性；</li></ul><h4 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h4><ul><li>继承是侵入性的，只要继承就必须拥有父类的所有方法和属性，在一定程度上约束了子类，降低了代码的灵活性；</li><li>增加了耦合，当父类的常量、变量或者方法被修改了，需要考虑子类的修改，所以一旦父类有了变动，很可能会造成非常糟糕的结果，要重构大量的代码。</li></ul><h3 id="3-ISP"><a href="#3-ISP" class="headerlink" title="3. ISP"></a>3. ISP</h3><p>所谓<code>ISP</code>原则，即：<code>Interface Segregation Principle</code>，<strong>接口隔离原则</strong>。原始定义如下：</p><blockquote><p>Clients should not be forced to depend upon interfaces that they do not use.(客户端只依赖于它所需要的接口；它需要什么接口就提供什么接口，把不需要的接口剔除掉。)</p></blockquote><blockquote><p>The dependency of one class to another one should depend on the smallest possible interface.(类间的依赖关系应建立在最小的接口上。)</p></blockquote><p>即，<strong>接口尽量细化，接口中的方法尽量少</strong>。接口隔离原则与单一职责原则的审视角度是不同的，单一职责原则要求的是类和接口职责单一，注重的是职责，这是业务逻辑上的划分，而接口隔离原则要求接口的方法尽量少。根据接口隔离原则拆分接口时，首先必须满足单一职责原则。</p><p>采用接口隔离原则对接口进行约束时，要注意以下几点：</p><ul><li>接口尽量小，但是要有限度。对接口进行细化可以提高程序设计灵活性是不挣的事实，但是如果过小，则会造成接口数量过多，使设计复杂化。所以一定要适度。</li><li>为依赖接口的类定制服务，只暴露给调用的类它需要的方法，它不需要的方法则隐藏起来。只有专注地为一个模块提供定制服务，才能建立最小的依赖关系。</li><li>提高内聚，减少对外交互。使接口用最少的方法去完成最多的事情。</li></ul><p>运用接口隔离原则，一定要适度，接口设计的过大或过小都不好。设计接口的时候，只有多花些时间去思考和筹划，才能准确地实践这一原则。</p><h3 id="4-OCP"><a href="#4-OCP" class="headerlink" title="4. OCP"></a>4. OCP</h3><p>所谓<code>OCP</code>原则，即：<code>Open Closed Principle</code>，<strong>开闭原则</strong>。原始定义如下：</p><blockquote><p>software entities (classes, modules, functions, etc.) should be open for extension, but closed for modification.(对扩展开放，对修改关闭)</p></blockquote><p>开闭原则（<code>OCP</code>）是面向对象设计中“可复用设计”的基石，是面向对象设计中最重要的原则之一，其它很多的设计原则和设计模式都是实现开闭原则的一种手段。核心就是：<strong>对扩展开放，对修改关闭</strong>。其含义是说一个软件应该通过扩展来实现变化，而不是通过修改已有的代码来实现变化的。</p><p>软件系统中包含的各种组件，例如模块（<code>Module</code>）、类（<code>Class</code>）以及功能（<code>Function</code>）等等，应该在不修改现有代码的基础上，引入新功能。开闭原则中“开”，是指对于组件功能的扩展是开放的，是允许对其进行功能扩展的；开闭原则中“闭”，是指对于原有代码的修改是封闭的。</p><p>实现开闭原则的关键就在于“<strong>抽象</strong>”。把系统的所有可能的行为抽象成一个抽象底层，这个抽象底层规定出所有的具体实现必须提供的方法的特征。作为系统设计的抽象层，要预见所有可能的扩展，从而使得在任何扩展情况下，系统的抽象底层不需修改；同时，由于可以从抽象底层导出一个或多个新的具体实现，可以改变系统的行为，因此系统设计对扩展是开放的。在实际开发过程的设计开始阶段，就要罗列出来系统所有可能的行为，并把这些行为加入到抽象底层，根本就是不可能的，这么去做也是不经济的。因此我们应该现实的接受修改拥抱变化，使我们的代码可以对扩展开放，对修改关闭。</p><p>开闭原则的好处：</p><ul><li>可复用性好;</li><li>可维护性好。</li></ul><h3 id="5-DIP"><a href="#5-DIP" class="headerlink" title="5. DIP"></a>5. DIP</h3><p>所谓<code>DIP</code>原则，即：<code>Dependency Inversion Principle</code>，<strong>依赖倒置原则</strong>。原始定义如下：</p><blockquote><p>High-level modules should not depend on low-level modules. Both should depend on abstractions.(<strong>高层模块不应该依赖低层模块，两者都应该依赖其抽象</strong>)</p></blockquote><blockquote><p>Abstractions should not depend on details. Details should depend on abstractions.(<strong>抽象不应该依赖细节；细节应该依赖抽象</strong>)</p></blockquote><p>面向过程的开发，上层调用下层，上层依赖于下层，当下层剧烈变动时上层也要跟着变动，这就会导致模块的复用性降低而且大大提高了开发的成本。面向对象的开发很好的解决了这个问题，一般情况下抽象的变化概率很小，让用户程序依赖于抽象，实现的细节也依赖于抽象。即使实现细节不断变动，只要抽象不变，客户程序就不需要变化。这大大降低了客户程序与实现细节的耦合度。</p><p>依赖倒置原则主要有以下三层含义：</p><ul><li>高层模块不应该依赖低层模块，两者都应该依赖其抽象（抽象类或接口）；</li><li>抽象不应该依赖细节（具体实现）；  </li><li>细节（具体实现）应该依赖抽象。</li></ul><p>依赖倒置原则基于这样一个事实：<strong>相对于细节的多变性，抽象的东西要稳定的多</strong>。以抽象为基础搭建起来的架构比以细节为基础搭建起来的架构要稳定的多。在 Java 中，抽象指的是接口或者抽象类，细节就是具体的实现类，使用接口或者抽象类的目的是制定好规范和契约，而不去涉及任何具体的操作，把展现细节的任务交给他们的实现类去完成。<strong>依赖倒置原则的核心思想就是面向接口编程</strong>。</p><h3 id="6-LOD-LKP"><a href="#6-LOD-LKP" class="headerlink" title="6. LOD | LKP"></a>6. LOD | LKP</h3><p>所谓<code>LOD</code>原则，即：<code>Law of Demeter</code>，<strong>迪米特法则</strong>，又叫<strong>最少知识原则</strong>（<code>Least Knowledge Principle</code>，简写<code>LKP</code>），就是说一个对象应当对其他对象有尽可能少的了解。通俗的讲，一个类应该对自己需要耦合或调用的类知道得最少，被耦合的类是如何的复杂都和我没关系，即为“不和陌生人说话”。迪米特法则的英文解释如下：</p><blockquote><p>talk only to your immediate friends.(<strong>只与直接的朋友通信</strong>)</p></blockquote><p><strong>迪米特法则的初衷在于降低类之间的耦合</strong>。由于每个类尽量减少对其他类的依赖，因此，很容易使得系统的功能模块功能独立，相互之间不存在（或很少有）依赖关系。</p><p>迪米特法则不希望类之间建立直接的联系。如果真的有需要建立联系，也希望能通过它的“朋友”类来转达。因此，应用迪米特法则有可能造成的一个后果就是：系统中存在大量的中介类，这些类之所以存在完全是为了传递类之间的相互调用关系——这在一定程度上增加了系统的复杂度,同时也为系统的维护带来了难度。所以，在采用迪米特法则时需要反复权衡，不遵循不对，严格执行又会“过犹不及”。既要做到让结构清晰，又要做到高内聚低耦合。</p><h3 id="7-CRP"><a href="#7-CRP" class="headerlink" title="7. CRP"></a>7. CRP</h3><p>所谓<code>CRP</code>原则，即：<code>Composite Reuse Principle</code>，<strong>组合复用原则</strong>。</p><p>组合复用原则的核心思想是：<strong>尽量使用对象组合，而不是继承来达到复用的目的</strong>。该原则就是在一个新的对象里面使用一些已有的对象，使之成为新对象的一部分：新的对象通过向这些对象的委派达到复用已有功能的目的。</p><p>继承的缺点主要有以下几点：</p><ul><li>继承复用破坏数据封装性，将基类的实现细节全部暴露给了派生类，基类的内部细节常常对派生类是透明的，白箱复用。虽然简单，但不安全，不能在程序的运行过程中随便改变。</li><li>基类的实现发生了改变，派生类的实现也不得不改变。</li><li>从基类继承而来的派生类是静态的，不可能在运行时间内发生改变，因此没有足够的灵活性。</li></ul><p>由于组合可以将已有的对象纳入到新对象中，使之成为新对象的一部分，因此新对象可以调用已有对象的功能，这样做有下面的好处：</p><ul><li>新对象存取<code>组成对象</code>的唯一方法是通过<code>组成对象</code>的<code>getter/setter</code>方法。</li><li>组合复用是黑箱复用，因为组成对象的内部细节是新对象所看不见的。</li><li>组合复用所需要的依赖较少。</li><li>每一个新的类可以将焦点集中到一个任务上。</li><li>组合复用可以在运行时间动态进行，新对象可以动态的引用与成分对象类型相同的对象。</li></ul><p>组合复用的缺点：就是用组合复用建造的系统会有较多的对象需要管理。</p><p>组合复用原则可以使系统更加灵活，类与类之间的耦合度降低，一个类的变化对其他类造成的影响相对较少，因此一般首选使用组合来实现复用；其次才考虑继承。在使用继承时，需要严格遵循里氏代换原则，有效使用继承会有助于对问题的理解，降低复杂度，而滥用继承反而会增加系统构建和维护的难度以及系统的复杂度，因此需要慎重使用继承复用。</p><p>使用继承时必须满足<code>Is-A</code>的关系是才能使用继承，而组合却是一种<code>Has-A</code>的关系。导致错误的使用继承而不是使用组合的一个重要原因可能就是错误的把<code>Has-A</code>当成了<code>Is-A</code>。</p>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 面向对象编程 </tag>
            
            <tag> 设计原则 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GitLab CI/CD 介绍和使用</title>
      <link href="/post/ruan-jian-gong-ju/devops/gitlab-ci-jie-shao-he-shi-yong/"/>
      <url>/post/ruan-jian-gong-ju/devops/gitlab-ci-jie-shao-he-shi-yong/</url>
      
        <content type="html"><![CDATA[<h2 id="一、持续集成介绍"><a href="#一、持续集成介绍" class="headerlink" title="一、持续集成介绍"></a>一、持续集成介绍</h2><blockquote><p>持续集成是一种软件开发实践，即团队开发成员经常集成他们的工作，通常每个成员每天至少集成一次，也就意味着每天可能会发生多次集成。每次集成都通过自动化的构建（包括编译，发布，自动化测试)来验证，从而尽快地发现集成错误。许多团队发现这个过程可以大大减少集成的问题，让团队能够更快的开发内聚的软件。—— Martin Fowler</p></blockquote><h3 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a>1 概念</h3><ul><li><strong>持续集成</strong>(<code>Continuous Integration</code>)：<strong>频繁地(一天多次)将代码集成到主干。</strong>让产品可以快速迭代，同时还能保持高质量。它的核心措施是，代码集成到主干之前，必须通过自动化测试。只要有一个测试用例失败，就不能集成。“持续集成并不能消除 Bug，而是让它们非常容易发现和改正。”</li><li><strong>持续交付</strong>(<code>Continuous Delivery</code>)：<strong>频繁地将软件的新版本，交付给质量团队或者用户，以供评审。</strong>如果评审通过，代码就进入生产阶段。持续交付可以看作持续集成的下一步。它强调的是，不管怎么更新，软件是随时随地可以交付的。</li><li><strong>持续部署</strong>(<code>continuous Deployment</code>)：<strong>代码通过评审以后，自动部署到生产环境。</strong>是持续部署是持续交付的下一步，持续部署的目标是，代码在任何时刻都是可部署的，可以进入生产阶段。</li></ul><h3 id="2-持续集成的好处"><a href="#2-持续集成的好处" class="headerlink" title="2 持续集成的好处"></a>2 持续集成的好处</h3><ul><li><strong>自动化构建且状态对每个人可见</strong>。可以使用<code>Maven</code>、<code>Gradle</code>等来实现自动化构建，可以在构建过程中实现自动化测试（前提是有写单元测试用例）。集成服务器在持续集成过程中发现问题可以及时发送警告给相关的干系人。</li><li><strong>解放了重复性劳动。</strong>自动化部署工作可以解放集成、测试、部署等重复性劳动，而机器集成的频率明显比手工高很多。</li><li><strong>更快地发现和修复问题。</strong>持续集成更早的获取变更，更早的进入测试，更早的发现问题，解决问题的成本显著下降。</li><li><strong>更快的交付成果。</strong>更早发现错误减少解决错误所需的工作量。集成服务器在构建环节发现错误可以及时通知开发人员修复。集成服务器在部署环节发现错误可以回退到上一版本，服务器始终有一个可用的版本。</li><li><strong>减少手工的错误。</strong>在重复性动作上，人容易犯错，而机器犯错的几率几乎为零。</li><li><strong>减少了等待时间。</strong>缩短了从开发、集成、测试、部署各个环节的时间，从而也就缩短了中间可以出现的等待时机。持续集成，意味着开发、集成、测试、部署也得以持续。</li><li><strong>更高的产品质量。</strong>集成服务器往往提供代码质量检测等功能，对不规范或有错误的地方会进行标致，也可以设置邮件和短信等进行警告。</li></ul><h3 id="3-常用持续集成工具"><a href="#3-常用持续集成工具" class="headerlink" title="3 常用持续集成工具"></a>3 常用持续集成工具</h3><ul><li><a href="https://jenkins.io/">Jenkins</a></li><li><a href="https://docs.gitlab.com/ee/ci/README.html">GitLab CI</a></li><li><a href="https://www.jetbrains.com/teamcity/">TeamCity</a></li><li><a href="https://www.travis-ci.org/">Travis CI</a></li><li><a href="https://www.atlassian.com/software/bamboo">Bamboo</a></li><li><a href="https://circleci.com/">CircleCI</a></li><li>…</li></ul><h2 id="二、Gitlab-持续集成"><a href="#二、Gitlab-持续集成" class="headerlink" title="二、Gitlab 持续集成"></a>二、Gitlab 持续集成</h2><p><img src="https://statics.sh1a.qingstor.com/2018/11/22/pipelines.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/22/pipelines.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="GitLab CI/CD"></p><h3 id="1-概念介绍"><a href="#1-概念介绍" class="headerlink" title="1 概念介绍"></a>1 概念介绍</h3><h4 id="1-GitLab"><a href="#1-GitLab" class="headerlink" title="(1) GitLab"></a>(1) GitLab</h4><p><a href="https://about.gitlab.com/">GitLab</a> 是一个利用<code>Ruby on Rails</code>开发的开源应用程序，实现一个自托管的 Git 项目仓库，可通过 Web 界面进行访问公开的或者私人项目。它拥有与<a href="https://github.com/">GitHub</a>类似的功能，能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。</p><h4 id="2-GitLab-CI-CD"><a href="#2-GitLab-CI-CD" class="headerlink" title="(2) GitLab CI/CD"></a>(2) GitLab CI/CD</h4><p><a href="https://docs.gitlab.com/ee/ci/README.html">GitLab CI/CD</a> 是<code>GitLab Continuous Integration</code>（Gitlab持续集成）的简称。GitLab 自<code>GitLab 8.0</code>开始提供了持续集成的功能，且对所有项目默认开启。只要在项目仓库的根目录添加<code>.gitlab-ci.yml</code>文件，并且配置了Runner（运行器），那么每一次<code>push</code>或者合并请求（<code>Merge Request</code>）都会触发<a href="https://docs.gitlab.com/ce/ci/pipelines.html">CI Pipeline</a>。</p><h4 id="3-GitLab-Runner"><a href="#3-GitLab-Runner" class="headerlink" title="(3) GitLab Runner"></a>(3) GitLab Runner</h4><p><a href="https://docs.gitlab.com/runner/">GitLab Runner</a> <code>GitLab Runner</code>是一个开源项目，可以运行在 GNU / Linux，macOS 和 Windows 操作系统上。每次<code>push</code>的时候 GitLab CI 会根据<code>.gitlab-ci.yml</code>配置文件运行你流水线（<code>Pipeline</code>）中各个阶段的任务（<code>Job</code>），并将结果发送回 GitLab。GitLab Runner 是基于 Gitlab CI 的 API 进行构建的相互隔离的机器（或虚拟机）。GitLab Runner 不需要和 Gitlab 安装在同一台机器上，且考虑到 GitLab Runner 的资源消耗问题和安全问题，也不建议这两者安装在同一台机器上。</p><p>Gitlab Runner 分为三种：</p><ul><li>共享Runner(<code>Shared runners</code>)</li><li>专享Runner(<code>Specific runners</code>)</li><li>分组Runner(<code>Group Runners</code>)</li></ul><h4 id="4-Pipelines"><a href="#4-Pipelines" class="headerlink" title="(4) Pipelines"></a>(4) Pipelines</h4><p><a href="https://docs.gitlab.com/ce/ci/pipelines.html">Pipelines</a> 中文称为流水线，是分阶段执行的构建任务。如：安装依赖、运行测试、打包、部署开发服务器、部署生产服务器等流程。每一次<code>push</code>或者<code>Merge Request</code>都会触发生成一条新的Pipeline。</p><p>下面是流水线示例图：</p><p><img src="https://docs.gitlab.com/ce/ci/img/pipelines_index.png" class="lazyload placeholder" data-srcset="https://docs.gitlab.com/ce/ci/img/pipelines_index.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="Pipeline Status"></p><h4 id="5-Stages"><a href="#5-Stages" class="headerlink" title="(5) Stages"></a>(5) Stages</h4><p><a href="https://docs.gitlab.com/ce/ci/yaml/README.html#stages">Stages</a> 表示构建阶段，可以理解为上面所说“安装依赖”、“运行测试”等环节的流程。我们可以在一次 Pipeline 中定义多个 Stages，这些 Stages 会有以下特点：</p><ul><li>所有 Stages 会按照顺序运行，即当一个 Stage 完成后，下一个 Stage 才会开始（当然可以在<code>.gitlab-ci.yml</code>文件中配置上一阶段失败时下一阶段也执行）</li><li>只有当所有 Stages 完成后，该构建任务 (Pipeline) 才会成功</li><li>如果任何一个 Stage 失败，那么后面的 Stages 不会执行，该构建任务 (Pipeline) 失败</li></ul><p>下面是一个流水线内的阶段任务示例图：</p><p><img src="https://docs.gitlab.com/ce/ci/img/pipelines.png" class="lazyload placeholder" data-srcset="https://docs.gitlab.com/ce/ci/img/pipelines.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="Job Status"></p><h4 id="6-Jobs"><a href="#6-Jobs" class="headerlink" title="(6) Jobs"></a>(6) Jobs</h4><p><a href="https://docs.gitlab.com/ce/ci/pipelines.html#jobs">Jobs</a> 表示构建的作业（或称之为任务），表示某个 Stage 里面执行的具体任务。我们可以在 Stages 里面定义多个 Jobs，这些 Jobs 会有以下特点：</p><ul><li>相同 Stage 中的 Jobs 无执行顺序要求，会并行执行</li><li>相同 Stage 中的 Jobs 都执行成功时，该 Stage 才会成功</li><li>如果任何一个 Job 失败，那么该 Stage 失败，即该构建任务 (Pipeline) 也失败（可以在<code>.gitlab-ci.yml</code>文件中配置允许某 Job 可以失败，也算该 Stage 成功）</li></ul><h4 id="7-gitlab-ci-yml"><a href="#7-gitlab-ci-yml" class="headerlink" title="(7) .gitlab-ci.yml"></a>(7) .gitlab-ci.yml</h4><p>GitLab 中默认开启了 Gitlab CI/CD 的支持，且使用<a href="http://yaml.org/">YAML</a>文件<a href="https://docs.gitlab.com/ee/ci/yaml/README.html#examples">.gitlab-ci.yml</a>来管理项目构建配置。该文件需要存放于项目仓库的根目录（默认路径，可在 GitLab 中修改），它定义该项目的 CI/CD 如何配置。所以，我们只需要在<code>.gitlab-ci.yml</code>配置文件中定义流水线的各个阶段，以及各个阶段中的若干作业（任务）即可。</p><p>下面是<code>.gitlab-ci.yml</code>文件的一个简单的<code>Hello World</code>示例：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 定义 test 和 package 两个 Stages</span><span class="token key atrule">stages</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> test  <span class="token punctuation">-</span> package<span class="token comment"># 定义 package 阶段的一个 job</span><span class="token key atrule">package-job</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> package  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> echo "Hello<span class="token punctuation">,</span> package<span class="token punctuation">-</span>job"    <span class="token punctuation">-</span> echo "I am in package stage"<span class="token comment"># 定义 test 阶段的一个 job</span><span class="token key atrule">test-job</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> echo "Hello<span class="token punctuation">,</span> test<span class="token punctuation">-</span>job"    <span class="token punctuation">-</span> echo "I am in test stage"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上配置中，用 stages 关键字来定义 Pipeline 中的各个构建阶段，然后用一些非关键字来定义 jobs。每个 job 中可以可以再用 stage 关键字来指定该 job 对应哪个 stage。job 里面的<code>script</code>关键字是每个 job 中必须要包含的，它表示每个 job 要执行的命令。</p><blockquote><p><strong>注</strong>：猜猜上面例子的运行结果？</p></blockquote><h4 id="8-Badges"><a href="#8-Badges" class="headerlink" title="(8) Badges"></a>(8) Badges</h4><p><a href="https://docs.gitlab.com/ce/ci/pipelines.html#badges">Badges</a> 即：<strong>徽章</strong>，当 Pipelines 执行过程中或者执行完成时会生成徽章，你可以将这些徽章加入到你的<code>README.md</code>文件中，便于从仓库主页看到最新的构建状态。</p><p>徽章的链接形如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http://example.gitlab.com/namespace/project/badges/branch/build.svg <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们用 GitLab 项目的徽章作为例子，效果如下：</p><p><img src="https://gitlab.com/gitlab-org/gitlab-ce/badges/master/build.svg" class="lazyload placeholder" data-srcset="https://gitlab.com/gitlab-org/gitlab-ce/badges/master/build.svg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="Gitlab build badges"> <img src="https://gitlab.com/gitlab-org/gitlab-ce/badges/master/coverage.svg?job=coverage" class="lazyload placeholder" data-srcset="https://gitlab.com/gitlab-org/gitlab-ce/badges/master/coverage.svg?job=coverage" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="Gitlab coverage badges"></p><h3 id="2-安装-GitLab-Runner"><a href="#2-安装-GitLab-Runner" class="headerlink" title="2 安装 GitLab Runner"></a>2 安装 GitLab Runner</h3><p><a href="https://docs.gitlab.com/runner/install/index.html">这里</a>有 GitLab Runner安装相关的资源和文档可供大家参考。以下仅以咱们公司常用的<code>Centos</code>为例来做安装说明。</p><h4 id="1-在线安装"><a href="#1-在线安装" class="headerlink" title="(1) 在线安装"></a>(1) 在线安装</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加官方的repo.</span><span class="token function">curl</span> -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">bash</span><span class="token comment"># yum 安装Gtilab Runner.</span><span class="token function">sudo</span> yum <span class="token function">install</span> gitlab-runner<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-离线安装"><a href="#2-离线安装" class="headerlink" title="(2) 离线安装"></a>(2) 离线安装</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装Git</span><span class="token function">sudo</span> yum –y <span class="token function">install</span> <span class="token function">git</span><span class="token comment"># rpm离线安装事先下载好的 Gitlab Runner rpm包.</span><span class="token function">rpm</span> -ivh gitlab-runner-10.5.0-1.x86_64.rpm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong>：Gitlab Runner 依赖了<code>Git</code>，所以，离线安装 Gitlab Runner 之前得首先安装Git，离线安装包可以从<a href="https://packages.gitlab.com/runner/gitlab-runner">这里</a>下载。</p></blockquote><h3 id="3-注册-Gitlab-Runner"><a href="#3-注册-Gitlab-Runner" class="headerlink" title="3 注册 Gitlab Runner"></a>3 注册 Gitlab Runner</h3><p>安装了 GitLab Runner 之后,就可以为 GitLab 中的仓库<a href="https://docs.gitlab.com/runner/register/index.html">注册一个 Runner</a>，注册的交互式命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gitlab-runner register<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>命令的交互式的过程如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 输入注册命令</span><span class="token function">sudo</span> gitlab-runner register<span class="token comment"># 输入公司的 GitLab 网站地址</span>Please enter the gitlab-ci coordinator URL <span class="token punctuation">(</span>e.g. https://gitlab.com <span class="token punctuation">)</span>http://gitlab.xxxx.com/<span class="token comment"># 你项目仓库的token，token可以在 Settings -> CI/CD -> Runners settings 中找到.</span>Please enter the gitlab-ci token <span class="token keyword">for</span> this runnerxxx<span class="token comment"># 输入描述这个 runner 的名称</span>Please enter the gitlab-ci description <span class="token keyword">for</span> this runner<span class="token punctuation">[</span>hostame<span class="token punctuation">]</span> my-runner<span class="token comment"># 输入 runner 的标签</span>Please enter the gitlab-ci tags <span class="token keyword">for</span> this runner <span class="token punctuation">(</span>comma separated<span class="token punctuation">)</span>:my-tag,another-tag<span class="token comment"># 输入 runner 的执行器.</span>Please enter the executor: ssh, docker+machine, docker-ssh+machine, kubernetes, docker, parallels, virtualbox, docker-ssh, shell:shell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上流程注册成功之后，就可以在你的项目仓库中 <code>Settings</code> -&gt; <code>CI/CD</code> -&gt; <code>Runners settings</code> 看到这个 Runner 了。</p><h3 id="4-Gitlab-Runner-常用命令汇总"><a href="#4-Gitlab-Runner-常用命令汇总" class="headerlink" title="4 Gitlab Runner 常用命令汇总"></a>4 Gitlab Runner 常用命令汇总</h3><p>下面的表格中列出了一些常用的<a href="https://docs.gitlab.com/runner/commands/README.html#gitlab-runner-list">Gitlab Runner命令</a>，以供参考：</p><table><thead><tr><th>命令</th><th align="left">描述</th></tr></thead><tbody><tr><td>gitlab-runner run</td><td align="left">运行一个runner服务</td></tr><tr><td>gitlab-runner register</td><td align="left">注册一个新的runner</td></tr><tr><td>gitlab-runner start</td><td align="left">启动服务</td></tr><tr><td>gitlab-runner stop</td><td align="left">关闭服务</td></tr><tr><td>gitlab-runner restart</td><td align="left">重启服务</td></tr><tr><td>gitlab-runner status</td><td align="left">查看各个runner的状态</td></tr><tr><td>gitlab-runner unregister</td><td align="left">注销掉某个runner</td></tr><tr><td>gitlab-runner list</td><td align="left">显示所有运行着的runner</td></tr><tr><td>gitlab-runner verify</td><td align="left">检查已注册的运行程序是否可以连接到GitLab，但它不验证GitLab Runner服务是否正在使用运行程序。</td></tr></tbody></table><h2 id="三、一个Web项目-CI-CD-简单示例"><a href="#三、一个Web项目-CI-CD-简单示例" class="headerlink" title="三、一个Web项目 CI/CD 简单示例"></a>三、一个Web项目 CI/CD 简单示例</h2><p>接下来，用一个实际项目来演示 GitLab CI/CD 的配置和使用，其中主要包括：编译测试、项目打包、部署服务、Sonar手动检查、Sonar定时检查五个阶段。</p><p>下面用一个传统的 Java web 项目(这里称之为<code>cidemo</code>)和<code>Tomcat</code>来作为示例，并用来展示常用配置的使用。当我每次<code>push</code>代码或者<code>Merge Request</code>时，都会生成一条流水线，且会自动执行我们上面所说的一些阶段，而Sonar手动检查我们设置为手动操作，且再额外配置Sonar定时检查的任务。</p><blockquote><p><strong>注</strong>：我 Gitlab Runner 是安装在<code>Centos</code>环境中，并使用的<code>shell</code>执行器。</p></blockquote><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 定义stages</span><span class="token key atrule">stages</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> test  <span class="token punctuation">-</span> install  <span class="token punctuation">-</span> run  <span class="token punctuation">-</span> sonar<span class="token comment"># 定义安装包的存放位置和Tomcat服务器的地址的变量，便于后续部署使用.</span><span class="token key atrule">variables</span><span class="token punctuation">:</span>  <span class="token key atrule">CIDEMO_PACKAGE_DIR</span><span class="token punctuation">:</span> <span class="token string">'/home/gitlab-runner/packages/cidemo/'</span>  <span class="token key atrule">SERVER_HOME_DIR</span><span class="token punctuation">:</span> <span class="token string">'/home/gitlab-runner/tomcat/cidemo-tomcat/'</span><span class="token comment">###################### 构建编译和单元测试的job. #######################</span><span class="token key atrule">编译测试任务</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test  <span class="token key atrule">only</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> branches  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> mvn clean test<span class="token comment">###################### Maven安装得到war包的job. #######################</span><span class="token key atrule">打包任务</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> install  <span class="token key atrule">only</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> develop  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> mvn install    <span class="token punctuation">-</span> echo '准备将最新的war包复制、保存到某个目录里面供后续使用.'    <span class="token punctuation">-</span> rm <span class="token punctuation">-</span>rf $CIDEMO_PACKAGE_DIR/<span class="token important">*.war</span>    <span class="token punctuation">-</span> cp target/<span class="token important">*.war</span> $CIDEMO_PACKAGE_DIR/cidemo.war<span class="token comment">####################### 部署运行war包的job. #######################</span><span class="token key atrule">部署运行任务</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> run  <span class="token key atrule">only</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> develop  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> echo '准备部署和运行war包！(为了方便部署到了Tomcat中运行)'    <span class="token punctuation">-</span> cd $SERVER_HOME_DIR    <span class="token punctuation">-</span> sh bin/shutdown.sh    <span class="token punctuation">-</span> rm <span class="token punctuation">-</span>rf webapps/cidemo.war    <span class="token punctuation">-</span> cp $CIDEMO_PACKAGE_DIR/cidemo.war $SERVER_HOME_DIR/webapps/cidemo.war    <span class="token punctuation">-</span> nohup sh ./bin/startup.sh <span class="token punctuation">></span> logs/cidemo_nohup.log 2<span class="token punctuation">></span><span class="token important">&amp;1</span> &amp;<span class="token comment">###################### Sonar手动构建的job. #######################</span><span class="token key atrule">Sonar手动检查</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> sonar  <span class="token key atrule">when</span><span class="token punctuation">:</span> manual  <span class="token key atrule">only</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> develop  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> echo '准备对项目代码做sonar的质量检查！'    <span class="token punctuation">-</span> mvn compile <span class="token important">&amp;&amp;</span> mvn sonar<span class="token punctuation">:</span>sonar <span class="token punctuation">-</span>Dsonar.host.url=http<span class="token punctuation">:</span>//172.16.34.102<span class="token punctuation">:</span>9000 <span class="token punctuation">-</span>Dsonar.login=497a0e0e2fc07f64c4b54edc17bb47dfa251ba34<span class="token comment">###################### Sonar每晚定时构建的job. #######################</span><span class="token key atrule">Sonar定时检查</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> sonar  <span class="token key atrule">only</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> schedules  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> echo '开始定时对项目代码做sonar的质量检查！'    <span class="token punctuation">-</span> mvn compile <span class="token important">&amp;&amp;</span> mvn sonar<span class="token punctuation">:</span>sonar <span class="token punctuation">-</span>Dsonar.host.url=http<span class="token punctuation">:</span>//172.16.34.102<span class="token punctuation">:</span>9000 <span class="token punctuation">-</span>Dsonar.login=497a0e0e2fc07f64c4b54edc17bb47dfa251ba34<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="四、Gitlab-CI-CD-yaml-常用配置介绍"><a href="#四、Gitlab-CI-CD-yaml-常用配置介绍" class="headerlink" title="四、Gitlab CI/CD yaml 常用配置介绍"></a>四、Gitlab CI/CD yaml 常用配置介绍</h2><p>开始构建之前<code>.gitlab-ci.yml</code>文件定义了一系列带有约束说明的任务。这些任务都是以任务名开始并且至少要包含script部分，<code>.gitlab-ci.yml</code>允许指定无限量 jobs。每个 jobs 必须有一个唯一的名字，且名字不能是下面列出的保留字段：</p><ul><li><code>image</code></li><li><code>services</code></li><li><code>stages</code></li><li><code>types</code></li><li><code>before_script</code></li><li><code>after_script</code></li><li><code>variables</code></li><li><code>cache</code></li></ul><p>job由一列参数来定义 jobs 的行为：</p><table><thead><tr><th>Keyword</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td>script</td><td>yes</td><td>Runner执行的命令或脚本</td></tr><tr><td>extends</td><td>no</td><td>定义此作业将继承的配置条目</td></tr><tr><td>image</td><td>no</td><td>所使用的docker镜像，查阅<a href="https://docs.gitlab.com/ce/ci/docker/using_docker_images.html#define-image-and-services-from-gitlab-ciyml">使用docker镜像</a></td></tr><tr><td>services</td><td>no</td><td>所使用的docker服务，查阅<a href="https://docs.gitlab.com/ce/ci/docker/using_docker_images.html#define-image-and-services-from-gitlab-ciyml">使用docker镜像</a></td></tr><tr><td>stage</td><td>no</td><td>定义job stage（默认：<code>test</code>）</td></tr><tr><td>type</td><td>no</td><td><code>stage</code>的别名（已弃用）</td></tr><tr><td>variables</td><td>no</td><td>定义job级别的变量</td></tr><tr><td>only</td><td>no</td><td>定义一列git分支，并为其创建job</td></tr><tr><td>except</td><td>no</td><td>定义一列git分支，不创建job</td></tr><tr><td>tags</td><td>no</td><td>定义一列tags，用来指定选择哪个Runner（同时Runner也要设置tags）</td></tr><tr><td>allow_failure</td><td>no</td><td>允许job失败。失败的job不影响commit状态</td></tr><tr><td>when</td><td>no</td><td>定义何时开始job。可以是<code>on_success</code>，<code>on_failure</code>，<code>always</code>或者<code>manual</code></td></tr><tr><td>dependencies</td><td>no</td><td>定义job依赖关系，这样他们就可以互相传递artifacts</td></tr><tr><td>cache</td><td>no</td><td>定义应在后续运行之间缓存的文件列表</td></tr><tr><td>before_script</td><td>no</td><td>重写一组在作业前执行的命令</td></tr><tr><td>after_script</td><td>no</td><td>重写一组在作业后执行的命令</td></tr><tr><td>environment</td><td>no</td><td>定义此作业完成部署的环境名称</td></tr><tr><td>coverage</td><td>no</td><td>定义给定作业的代码覆盖率设置</td></tr><tr><td>etry</td><td>no</td><td>定义在发生故障时可以自动重试作业的时间和次数</td></tr><tr><td>parallel</td><td>no</td><td>定义应并行运行的作业实例数</td></tr></tbody></table><h3 id="extends"><a href="#extends" class="headerlink" title="extends"></a>extends</h3><blockquote><p>是在 GitLab 11.3 中引入的。</p></blockquote><p><code>extends</code>定义了一个使用<code>extends</code>的作业将继承的条目名称。它是使用<a href="https://docs.gitlab.com/ee/ci/yaml/README.html#anchors">YAML锚点</a>的替代方案，并且更加灵活和可读：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">.tests</span><span class="token punctuation">:</span>  <span class="token key atrule">script</span><span class="token punctuation">:</span> rake test  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test  <span class="token key atrule">only</span><span class="token punctuation">:</span>    <span class="token key atrule">refs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> branches<span class="token key atrule">rspec</span><span class="token punctuation">:</span>  <span class="token key atrule">extends</span><span class="token punctuation">:</span> .tests  <span class="token key atrule">script</span><span class="token punctuation">:</span> rake rspec  <span class="token key atrule">only</span><span class="token punctuation">:</span>    <span class="token key atrule">variables</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> $RSPEC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在上面的示例中，<code>rspec</code>作业继承自<code>.tests</code>模板作业。 GitLab 将根据键执行反向深度合并。 GitLab将：</p><ul><li>将<code>rspec</code>内容以递归方式合并到<code>.tests</code>中。</li><li>不合并键的值。</li></ul><p>这实际生成的是以下<code>rspec</code>作业：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">rspec</span><span class="token punctuation">:</span>  <span class="token key atrule">script</span><span class="token punctuation">:</span> rake rspec  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test  <span class="token key atrule">only</span><span class="token punctuation">:</span>    <span class="token key atrule">refs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> branches    <span class="token key atrule">variables</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> $RSPEC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong>: <code>rake test</code>已被<code>rake rspec</code>脚本覆盖。</p></blockquote><h3 id="image-和-services"><a href="#image-和-services" class="headerlink" title="image 和 services"></a>image 和 services</h3><p>这两个关键字允许使用一个自定义的 Docker 镜像和一系列的服务，并且可以用于整个 job 周期。详细配置文档请查看<a href="https://docs.gitlab.com/ee/ci/docker/README.html">a separate document</a>。</p><h3 id="before-script-和-after-script"><a href="#before-script-和-after-script" class="headerlink" title="before_script 和 after_script"></a>before_script 和 after_script</h3><p><code>before_script</code>用来定义所有 job 之前运行的命令，<code>after_script</code>用来定义所有 job 之后运行的命令。它们可以是一个数组或者是多行字符串。</p><h3 id="stages"><a href="#stages" class="headerlink" title="stages"></a>stages</h3><p>stages 用来定义可以被 job 调用的 stages。stages 的规范允许有灵活的多级 pipelines。</p><p>stages中的元素顺序决定了对应job的执行顺序：</p><ol><li>相同 stage 的 job 可以平行执行。</li><li>下一个 stage 的 job 会在前一个 stage 的 job 成功后开始执行。</li></ol><p>接下仔细看看这个例子，它包含了3个 stage：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">stages</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> build <span class="token punctuation">-</span> test <span class="token punctuation">-</span> deploy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol><li>首先，所有 build 的 jobs 都是并行执行的。</li><li>所有 build 的 jobs 执行成功后，test 的 jobs 才会开始并行执行。</li><li>所有 test 的 jobs 执行成功，deploy 的 jobs 才会开始并行执行。</li><li>所有的 deploy 的 jobs 执行成功，<code>commit</code>才会标记为<code>success</code>。</li><li>任何一个前置的 jobs 失败了，<code>commit</code>会标记为<code>failed</code>并且下一个 stages 的 jobs 都不会执行。</li></ol><p>这有两个特殊的例子值得一提：</p><ol><li>如果<code>.gitlab-ci.yml</code>中没有定义stages，那么 job’s stages 会默认定义为<code>build</code>，<code>test</code>和<code>deploy</code>。</li><li>如果一个 job 没有指定 stage，那么这个任务会分配到 test stage。</li></ol><h3 id="only-和-except"><a href="#only-和-except" class="headerlink" title="only 和 except"></a>only 和 except</h3><p><code>only</code>和<code>except</code>是两个参数用分支策略来限制 jobs 构建：</p><ul><li><code>only</code>定义哪些分支和标签的git项目将会被job执行。</li><li><code>except</code>定义哪些分支和标签的git项目将不会被job执行。</li></ul><p>下面是refs策略的使用规则：</p><ul><li>only 和 except 可同时使用。如果<code>only</code>和<code>except</code>在一个 job 配置中同时存在，则以 only 为准，跳过 except(从下面示例中得出)。</li><li>only 和 except 可以使用正则表达式。</li><li>only 和 except 允许使用特殊的关键字：<code>branches</code>，<code>tags</code>和<code>triggers</code>。</li><li>only 和 except 允许使用指定仓库地址但不是forks的仓库(查看示例3)。</li></ul><p>在下面这个例子中，job 将只会运行以<code>issue-</code>开始的refs(分支)，然而<code>except</code>中设置将被跳过。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">job</span><span class="token punctuation">:</span>  <span class="token comment"># use regexp</span>  <span class="token key atrule">only</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> /^issue<span class="token punctuation">-</span>.<span class="token important">*$/</span>  <span class="token comment"># use special keyword</span>  <span class="token key atrule">except</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> branches<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在下面这个例子中，job 将只会执行有<code>tags</code>的refs，或者通过<code>API</code>触发器明确地请求构建。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">job</span><span class="token punctuation">:</span>  <span class="token comment"># use special keywords</span>  <span class="token key atrule">only</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> tags    <span class="token punctuation">-</span> triggers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面这个例子将会为所有的分支执行job，但 master 分支除外。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">job</span><span class="token punctuation">:</span>  <span class="token key atrule">only</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> branches@gitlab<span class="token punctuation">-</span>org/gitlab<span class="token punctuation">-</span>ce  <span class="token key atrule">except</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> master@gitlab<span class="token punctuation">-</span>org/gitlab<span class="token punctuation">-</span>ce<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="variables"><a href="#variables" class="headerlink" title="variables"></a>variables</h3><p>GItLab CI 允许在<code>.gitlab-ci.yml</code>文件中添加变量，并在 job 环境中起作用。因为这些配置是存储在 git 仓库中，所以<strong>最好是存储项目的非敏感配置</strong>，例如：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">variables</span><span class="token punctuation">:</span>  DATABASE_URL<span class="token punctuation">:</span><span class="token string">"postgres://postgres@postgres/my_database"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这些变量可以被后续的命令和脚本使用。</p><p>除了用户自定义的变量外，Runner 也可以定义它自己的变量。<code>CI_COMMIT_REG_NAME</code>就是一个很好的例子，它的值表示用于构建项目的分支或tag名称。除了在<code>.gitlab-ci.yml</code>中设置变量外，还有可以通过 GitLab 的界面上设置私有变量。</p><p>这里有更多关于<a href="https://docs.gitlab.com/ce/ci/variables/README.html">variables</a>的介绍。</p><h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><h4 id="cache-paths"><a href="#cache-paths" class="headerlink" title="cache: paths"></a>cache: paths</h4><p>使用<code>paths</code>指令选择要缓存的文件或目录。也可以使用通配符。</p><p>如果 cache 定义在 jobs 的作用域之外，那么它就是全局缓存，所有 jobs 都可以使用该缓存。</p><p>缓存<code>binaries</code>和<code>.config</code>中的所有文件：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">rspec</span><span class="token punctuation">:</span>  <span class="token key atrule">script</span><span class="token punctuation">:</span> test  <span class="token key atrule">cache</span><span class="token punctuation">:</span>    <span class="token key atrule">paths</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> binaries/    <span class="token punctuation">-</span> .config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>缓存<code>git</code>中没有被跟踪的文件：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">rspec</span><span class="token punctuation">:</span>  <span class="token key atrule">script</span><span class="token punctuation">:</span> test  <span class="token key atrule">cache</span><span class="token punctuation">:</span>    <span class="token key atrule">untracked</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>缓存<code>binaries</code>下没有被<code>git</code>跟踪的文件：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">rspec</span><span class="token punctuation">:</span>  <span class="token key atrule">script</span><span class="token punctuation">:</span> test  <span class="token key atrule">cache</span><span class="token punctuation">:</span>    <span class="token key atrule">untracked</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">paths</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> binaries/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>job 中优先级高于全局的。下面这个<code>rspec</code> job中将只会缓存<code>binaries/</code>下的文件：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">cache</span><span class="token punctuation">:</span>  <span class="token key atrule">paths</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> my/files<span class="token key atrule">rspec</span><span class="token punctuation">:</span>  <span class="token key atrule">script</span><span class="token punctuation">:</span> test  <span class="token key atrule">cache</span><span class="token punctuation">:</span>    <span class="token key atrule">key</span><span class="token punctuation">:</span> rspec    <span class="token key atrule">paths</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> binaries/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意，缓存是在 jobs 之前进行共享的。如果你不同的 jobs 缓存不同的文件路径，必须设置不同的<code>cache:key</code>，否则缓存内容将被重写。缓存只是尽力而为之，所以别期望缓存会一直存在。</p><h4 id="cache-key"><a href="#cache-key" class="headerlink" title="cache: key"></a>cache: key</h4><p><code>key</code>指令允许我们定义缓存的作用域(亲和性)，可以是所有 jobs 的单个缓存，也可以是每个 job，也可以是每个分支或者是任何你认为合适的地方。它也可以让你很好的调整缓存，允许你设置不同 jobs 的缓存，甚至是不同分支的缓存。</p><p><code>cache:key</code>可以使用任何的<a href="https://docs.gitlab.com/ce/ci/variables/README.html">预定义变量</a>。</p><p>默认key是默认设置的这个项目缓存，因此默认情况下，从GitLab 9.0开始，每个 pipelines 和 jobs 中可以共享一切。</p><p>配置示例</p><p>缓存每个job：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">cache</span><span class="token punctuation">:</span>  <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"$CI_JOB_NAME"</span>  <span class="token key atrule">untracked</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>缓存每个分支：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">cache</span><span class="token punctuation">:</span>  <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"$CI_COMMIT_REF_NAME"</span>  <span class="token key atrule">untracked</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>缓存每个 job 且每个分支：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">cache</span><span class="token punctuation">:</span>  <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"$CI_JOB_NAME/$CI_COMMIT_REF_NAME"</span>  <span class="token key atrule">untracked</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>缓存每个分支且每个stage：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">cache</span><span class="token punctuation">:</span>  <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"$CI_JOB_STAGE/$CI_COMMIT_REF_NAME"</span>  <span class="token key atrule">untracked</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果使用的Windows Batch(windows批处理)来跑脚本需要用%替代$：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">cache</span><span class="token punctuation">:</span>  <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"%CI_JOB_STAGE%/%CI_COMMIT_REF_NAME%"</span>  <span class="token key atrule">untracked</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="allow-failure"><a href="#allow-failure" class="headerlink" title="allow_failure"></a>allow_failure</h3><p><code>allow_failure</code>可以用于当你想设置一个 job 失败的之后并不影响后续的CI组件的时候。失败的 jobs 不会影响到<code>commit</code>状态。</p><p>当开启了允许 job 失败，所有的 intents 和 purposes 里的 pipeline 都是成功/绿色，但是也会有一个”<code>CI build passed with warnings</code>“信息显示在<code>Merge Request</code>或<code>commit</code>或<code>job page</code>。这被允许失败的作业使用，但是如果失败表示其他地方应采取其他（手动）步骤。</p><p>下面的这个例子中，job1和job2将会并列进行，如果job1失败了，它也不会影响进行中的下一个 stage，因为这里有设置了<code>allow_failure: true</code>。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">job1</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> execute_script_that_will_fail  <span class="token key atrule">allow_failure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">job2</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> execute_script_that_will_succeed<span class="token key atrule">job3</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> deploy_to_staging<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="when"><a href="#when" class="headerlink" title="when"></a>when</h3><p><code>when</code>用于实现在发生故障或尽管失败时运行的作业。when可以设置以下值：</p><ul><li><code>on_success</code> - 只有前面 stages 的所有工作成功时才执行。这是默认值。</li><li><code>on_failure</code> - 当前面 stages 中任意一个jobs失败后执行。</li><li><code>always</code> - 无论前面 stages 中 jobs 状态如何都执行。</li><li><code>manual</code> - 手动执行(GitLab8.10增加)。更多请查看手动操作。</li></ul><h3 id="artifacts"><a href="#artifacts" class="headerlink" title="artifacts"></a>artifacts</h3><p><code>artifacts</code>用于指定成功后应附加到 job 的文件和目录的列表。只能使用项目工作间内的文件或目录路径。在job成功完成后artifacts将会发送到GitLab中，同时也会在 GitLab UI 中提供下载。如果想要在不通的 job 之间传递<code>artifacts</code>，请查阅<a href="https://docs.gitlab.com/ce/ci/yaml/README.html#dependencies">依赖关系</a>。以下是一些例子：</p><p>发送<code>binaries</code>和<code>.config</code>中的所有文件：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">artifacts</span><span class="token punctuation">:</span>  <span class="token key atrule">paths</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> binaries/  <span class="token punctuation">-</span> .config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>发送所有没有被Git跟踪的文件：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">artifacts</span><span class="token punctuation">:</span>  <span class="token key atrule">untracked</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>发送没有被Git跟踪和<code>binaries</code>中的所有文件：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">artifacts</span><span class="token punctuation">:</span>  <span class="token key atrule">untracked</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">paths</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> binaries/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="五、其他相关内容"><a href="#五、其他相关内容" class="headerlink" title="五、其他相关内容"></a>五、其他相关内容</h2><h3 id="1-API触发器-Triggers"><a href="#1-API触发器-Triggers" class="headerlink" title="1 API触发器 Triggers"></a>1 API触发器 Triggers</h3><p>Triggers 可用于强制使用API调用重建特定分支，<code>tag</code>或<code>commits</code>。API的使用示例可以在<code>Settings</code> -&gt; <code>CI/CD</code> -&gt; <code>Pipeline triggers</code>中找到。</p><p>在<code>triggers</code>文档中<a href="https://docs.gitlab.com/ce/ci/triggers/README.html">查看更多</a>。</p><h3 id="2-配置定时任务"><a href="#2-配置定时任务" class="headerlink" title="2 配置定时任务"></a>2 配置定时任务</h3><p>GitLab CI 中可以在 GitLab <code>Settings</code> -&gt; <code>CI/CD</code> -&gt; <code>Schedules</code>中配置定时任务，点击<code>New Schedule</code>按钮，可以配置你流水线的定时执行任务，包括：描述信息、定时的Cron表达式、目标分支、变量等信息。</p><p>然后在需要定时执行的作业的<code>only</code>分支写上<code>schedules</code>即可。</p><h3 id="3-校验-gitlab-ci-yml"><a href="#3-校验-gitlab-ci-yml" class="headerlink" title="3 校验 .gitlab-ci.yml"></a>3 校验 .gitlab-ci.yml</h3><p>GitLab CI 的每个实例都有一个名为<code>Lint</code>的嵌入式调试工具。 你可以在 GitLab 实例的<code>-/ci/lint</code>下找到该链接。</p><h3 id="4-配置邮件发送"><a href="#4-配置邮件发送" class="headerlink" title="4 配置邮件发送"></a>4 配置邮件发送</h3><p>如果希望在每次构建完成后（或者在仅构建失败的情况下），想邮件发送给相关开发人员，则可以在 GitLab <code>Settings</code> -&gt; <code>Integrations</code> 中找到<code>Pipelines emails</code>，点击进去就可以配置邮件发送相关的内容了。</p><h3 id="5-GitLab-Pages"><a href="#5-GitLab-Pages" class="headerlink" title="5 GitLab Pages"></a>5 GitLab Pages</h3><p><a href="https://gitlab.com/pages/">GitLab Pages</a>是用于托管静态文件的服务。而<code>pages</code>是一个特殊的job，用于将静态的内容上传到GitLab，可用于为您的网站提供服务。它有特殊的语法，因此必须满足以下两个要求：</p><ul><li>任何静态内容必须放在<code>public/</code>目录下</li><li>artifacts必须定义在<code>public/</code>目录下</li></ul><p>下面的这个例子是将所有文件从项目根目录移动到<code>public/</code>目录。<code>.public</code>工作流是<code>cp</code>，并且它不会循环复制<code>public/</code>本身。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">pages</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy  <span class="token key atrule">script</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> mkdir .public  <span class="token punctuation">-</span> cp <span class="token punctuation">-</span>r * .public  <span class="token punctuation">-</span> mv .public public  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>    <span class="token key atrule">paths</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> public  <span class="token key atrule">only</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更多内容请查看<a href="https://docs.gitlab.com/ce/user/project/pages/index.html">GitLab Pages用户文档</a>。</p><h3 id="6-跳过-jobs"><a href="#6-跳过-jobs" class="headerlink" title="6 跳过 jobs"></a>6 跳过 jobs</h3><p>如果你的<code>commit</code>信息中包含<code>[ci skip]</code>或者<code>[skip ci]</code>，不论大小写，那么这个<code>commit</code>将会创建但是 jobs 也会跳过。</p><hr><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://docs.gitlab.com/ce/ci/yaml/README.html">官方文档地址</a></li><li><a href="https://segmentfault.com/a/1190000010442764#articleHeader24">segmentfault yaml配置中文翻译</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GitLab CI </tag>
            
            <tag> DevOps </tag>
            
            <tag> Jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue 文档风格的 Typora 主题</title>
      <link href="/post/ruan-jian-gong-ju/markdown/vue-wen-dang-feng-ge-de-typora-zhu-ti/"/>
      <url>/post/ruan-jian-gong-ju/markdown/vue-wen-dang-feng-ge-de-typora-zhu-ti/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://github.com/blinkfox/typora-vue-theme">typora-vue-theme</a> 是 Typora Markdown 文档编辑器中一款类似<a href="https://vuejs.org/">Vue</a>文档风格的主题。</p></blockquote><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><a href="https://www.typora.io/">Typora</a>是一款支持实时预览的 Markdown 编辑器和阅读器，支持<code>Windows</code>、<code>macOS</code>、<code>Linux</code>三大平台。Typora 作为一款合格的 Markdown 编辑器，支持图片、列表、表格、代码、公式、目录等功能，同时这款软件还支持（一键）动态预览功能，让一切都变得如此干净、纯粹。并且有多种主题模板。**<a href="https://github.com/blinkfox/typora-vue-theme">typora-vue-theme</a>就是参考了<a href="https://vuejs.org/">Vue</a>文档风格而开发的一个 Typora 自定义主题**。</p><h2 id="安装主题"><a href="#安装主题" class="headerlink" title="安装主题"></a>安装主题</h2><ol><li>下载本主题中的<code>vue.css</code>、<code>vue-dark.css</code>文件和包含字体的<code>vue</code>文件夹；</li><li>打开 Typora，点击“<strong>偏好设置</strong>” =&gt; “<strong>打开主题文件夹</strong>”按钮，将弹出 Typora 的主题文件夹；</li><li>将下载好的<code>vue.css</code>和<code>vue-dark.css</code>文件和包含字体的<code>vue</code>文件夹放到 Typora 的主题文件夹中；</li><li>关闭并重新打开 Typora，从菜单栏中选择 “<strong>主题</strong>” =&gt; “<strong>Vue</strong>” 或者 “<strong>Vue Dark</strong>” 即可。</li></ol><h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="https://statics.sh1a.qingstor.com/2018/11/19/typora-vue-theme-screen-1.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/19/typora-vue-theme-screen-1.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="vue主题效果图1"></p><p><img src="https://statics.sh1a.qingstor.com/2018/11/19/typora-vue-theme-screen-2.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/19/typora-vue-theme-screen-2.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="vue主题效果图2"></p><p><img src="https://statics.sh1a.qingstor.com/2018/11/19/typora-vue-theme-screen-3.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/19/typora-vue-theme-screen-3.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="vue主题效果图3"></p><h3 id="Vue-Dark"><a href="#Vue-Dark" class="headerlink" title="Vue Dark"></a>Vue Dark</h3><p><img src="https://github.com/MamoruDS/typora-vue-theme/raw/master/screenshots/screenshot_01.png" class="lazyload placeholder" data-srcset="https://github.com/MamoruDS/typora-vue-theme/raw/master/screenshots/screenshot_01.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="vue主题效果图4"></p><p><img src="https://github.com/MamoruDS/typora-vue-theme/raw/master/screenshots/screenshot_02.png" class="lazyload placeholder" data-srcset="https://github.com/MamoruDS/typora-vue-theme/raw/master/screenshots/screenshot_02.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="vue主题效果图5"></p><blockquote><p><strong>感谢</strong>: 本主题中的<code>vue-dark.css</code>来自<a href="https://github.com/MamoruDS/typora-vue-dark-theme">typora-vue-dark-theme</a>.</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 软件工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Typora </tag>
            
            <tag> Markdown </tag>
            
            <tag> Vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CPU多级缓存</title>
      <link href="/post/ruan-jian-gong-ju/cpu-duo-ji-huan-cun/"/>
      <url>/post/ruan-jian-gong-ju/cpu-duo-ji-huan-cun/</url>
      
        <content type="html"><![CDATA[<h2 id="一、什么是CPU缓存"><a href="#一、什么是CPU缓存" class="headerlink" title="一、什么是CPU缓存"></a>一、什么是CPU缓存</h2><h3 id="1-CPU缓存的来历"><a href="#1-CPU缓存的来历" class="headerlink" title="1. CPU缓存的来历"></a>1. CPU缓存的来历</h3><p>众所周知,CPU是计算机的大脑，它负责执行程序的指令，而内存负责存数据, 包括程序自身的数据。在很多年前，CPU的频率与内存总线的频率在同一层面上。内存的访问速度仅比寄存器慢一些。但是，这一局面在上世纪90年代被打破了。CPU的频率大大提升，但内存总线的频率与内存芯片的性能却没有得到成比例的提升。并不是因为造不出更快的内存，只是因为太贵了。内存如果要达到目前CPU那样的速度，那么它的造价恐怕要贵上好几个数量级。所以，CPU的运算速度要比内存读写速度快很多，这样会使CPU花费很长的时间等待数据的到来或把数据写入到内存中。所以，<strong>为了解决CPU运算速度与内存读写速度不匹配的矛盾</strong>，就出现了CPU缓存。</p><h3 id="2-CPU缓存的概念"><a href="#2-CPU缓存的概念" class="headerlink" title="2. CPU缓存的概念"></a>2. CPU缓存的概念</h3><p><strong>CPU缓存是位于CPU与内存之间的临时数据交换器，它的容量比内存小的多但是交换速度却比内存要快得多。CPU缓存一般直接跟CPU芯片集成或位于主板总线互连的独立芯片上</strong>。</p><p>为了简化与内存之间的通信，高速缓存控制器是针对数据块，而不是字节进行操作的。高速缓存其实就是一组称之为<strong>缓存行</strong>(Cache Line)的固定大小的数据块组成的，典型的一行是<code>64</code>字节。</p><h3 id="3-CPU缓存的意义"><a href="#3-CPU缓存的意义" class="headerlink" title="3. CPU缓存的意义"></a>3. CPU缓存的意义</h3><p>CPU往往需要重复处理相同的数据、重复执行相同的指令，如果这部分数据、指令CPU能在CPU缓存中找到，CPU就不需要从内存或硬盘中再读取数据、指令，从而减少了整机的响应时间。所以，缓存的意义满足以下两种<strong>局部性原理</strong>：</p><ul><li><strong>时间局部性（Temporal Locality）</strong>：如果一个信息项正在被访问，那么在近期它很可能还会被再次访问。</li><li><strong>空间局部性（Spatial Locality）</strong>：如果一个存储器的位置被引用，那么将来他附近的位置也会被引用。</li></ul><h2 id="二、CPU的三级缓存"><a href="#二、CPU的三级缓存" class="headerlink" title="二、CPU的三级缓存"></a>二、CPU的三级缓存</h2><h3 id="1-CPU的三级缓存"><a href="#1-CPU的三级缓存" class="headerlink" title="1. CPU的三级缓存"></a>1. CPU的三级缓存</h3><p>随着多核CPU的发展，CPU缓存通常分成了三个级别：<code>L1</code>，<code>L2</code>，<code>L3</code>。级别越小越接近CPU，所以速度也更快，同时也代表着容量越小。L1 是最接近CPU的, 它容量最小（例如：<code>32K</code>），速度最快，每个核上都有一个 L1 缓存，L1 缓存每个核上其实有两个 L1 缓存, 一个用于存数据的 L1d Cache（Data Cache），一个用于存指令的 L1i Cache（Instruction Cache）。L2 缓存 更大一些（例如：<code>256K</code>），速度要慢一些, 一般情况下每个核上都有一个独立的L2 缓存; L3 缓存是三级缓存中最大的一级（例如3MB），同时也是最慢的一级, 在同一个CPU插槽之间的核共享一个 L3 缓存。</p><p>下面是三级缓存的处理速度参考表：</p><table><thead><tr><th>从CPU到</th><th>大约需要的CPU周期</th><th>大约需要的时间(单位ns)</th></tr></thead><tbody><tr><td>寄存器</td><td>1 cycle</td><td></td></tr><tr><td>L1 Cache</td><td>~3-4 cycles</td><td>~0.5-1 ns</td></tr><tr><td>L2 Cache</td><td>~10-20 cycles</td><td>~3-7 ns</td></tr><tr><td>L3 Cache</td><td>~40-45 cycles</td><td>~15 ns</td></tr><tr><td>跨槽传输</td><td></td><td>~20 ns</td></tr><tr><td>内存</td><td>~120-240 cycles</td><td>~60-120ns</td></tr></tbody></table><p>下图是Intel Core i5-4285U的CPU三级缓存示意图：</p><p><img src="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-1.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-1.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="CPU三级缓存"></p><p>就像数据库缓存一样，获取数据时首先会在最快的缓存中找数据，如果缓存没有命中(Cache miss) 则往下一级找, 直到三级缓存都找不到时，那只有向内存要数据了。一次次地未命中，代表取数据消耗的时间越长。</p><h3 id="2-带有高速缓存CPU执行计算的流程"><a href="#2-带有高速缓存CPU执行计算的流程" class="headerlink" title="2. 带有高速缓存CPU执行计算的流程"></a>2. 带有高速缓存CPU执行计算的流程</h3><ol><li>程序以及数据被加载到主内存</li><li>指令和数据被加载到CPU的高速缓存</li><li>CPU执行指令，把结果写到高速缓存</li><li>高速缓存中的数据写回主内存</li></ol><p>目前流行的多级缓存结构如下图：</p><p><img src="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-2.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-2.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="多级缓存结构"></p><h2 id="三、CPU缓存一致性协议-MESI"><a href="#三、CPU缓存一致性协议-MESI" class="headerlink" title="三、CPU缓存一致性协议(MESI)"></a>三、CPU缓存一致性协议(MESI)</h2><p><strong>MESI</strong>（<code>Modified Exclusive Shared Or Invalid</code>）(也称为<strong>伊利诺斯协议</strong>，是因为该协议由伊利诺斯州立大学提出的）是一种广泛使用的支持写回策略的缓存一致性协议。为了保证多个CPU缓存中共享数据的一致性，定义了缓存行(Cache Line)的四种状态，而CPU对缓存行的四种操作可能会产生不一致的状态，因此缓存控制器监听到本地操作和远程操作的时候，需要对地址一致的缓存行的状态进行一致性修改，从而保证数据在多个缓存之间保持一致性。</p><h3 id="1-MESI协议中的状态"><a href="#1-MESI协议中的状态" class="headerlink" title="1. MESI协议中的状态"></a>1. MESI协议中的状态</h3><p>CPU中每个缓存行（Caceh line)使用<code>4</code>种状态进行标记，使用<code>2bit</code>来表示:</p><table><thead><tr><th>状态</th><th>描述</th><th>监听任务</th><th>状态转换</th></tr></thead><tbody><tr><td>M 修改 (Modified)</td><td>该Cache line有效，数据被修改了，和内存中的数据不一致，数据只存在于本Cache中。</td><td>缓存行必须时刻监听所有试图读该缓存行相对就主存的操作，这种操作必须在缓存将该缓存行写回主存并将状态变成S（共享）状态之前被延迟执行。</td><td>当被写回主存之后，该缓存行的状态会变成独享（exclusive)状态。</td></tr><tr><td>E 独享、互斥 (Exclusive)</td><td>该Cache line有效，数据和内存中的数据一致，数据只存在于本Cache中。</td><td>缓存行也必须监听其它缓存读主存中该缓存行的操作，一旦有这种操作，该缓存行需要变成S（共享）状态。</td><td>当CPU修改该缓存行中内容时，该状态可以变成Modified状态</td></tr><tr><td>S 共享 (Shared)</td><td>该Cache line有效，数据和内存中的数据一致，数据存在于很多Cache中。</td><td>缓存行也必须监听其它缓存使该缓存行无效或者独享该缓存行的请求，并将该缓存行变成无效（Invalid）。</td><td>当有一个CPU修改该缓存行时，其它CPU中该缓存行可以被作废（变成无效状态 Invalid）。</td></tr><tr><td>I 无效 (Invalid)</td><td>该Cache line无效。</td><td>无</td><td>无</td></tr></tbody></table><blockquote><p><strong>注意</strong>：<br><strong>对于M和E状态而言总是精确的，他们在和该缓存行的真正状态是一致的，而S状态可能是非一致的</strong>。如果一个缓存将处于S状态的缓存行作废了，而另一个缓存实际上可能已经独享了该缓存行，但是该缓存却不会将该缓存行升迁为E状态，这是因为其它缓存不会广播他们作废掉该缓存行的通知，同样由于缓存并没有保存该缓存行的copy的数量，因此（即使有这种通知）也没有办法确定自己是否已经独享了该缓存行。</p></blockquote><p>从上面的意义看来E状态是一种投机性的优化：如果一个CPU想修改一个处于S状态的缓存行，总线事务需要将所有该缓存行的copy变成invalid状态，而修改E状态的缓存不需要使用总线事务。</p><p>MESI状态转换图：</p><p><img src="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-3.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-3.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="MESI状态转换图"></p><p>下图表示了当一个缓存行(Cache line)的调整的状态的时候，另外一个缓存行(Cache line)需要调整的状态。</p><table><thead><tr><th>状态</th><th>M</th><th>E</th><th>S</th><th><strong>I</strong></th></tr></thead><tbody><tr><td><strong>M</strong></td><td>×</td><td>×</td><td>×</td><td>√</td></tr><tr><td><strong>E</strong></td><td>×</td><td>×</td><td>×</td><td>√</td></tr><tr><td><strong>S</strong></td><td>×</td><td>×</td><td>√</td><td>√</td></tr><tr><td><strong>I</strong></td><td>√</td><td>√</td><td>√</td><td>√</td></tr></tbody></table><p>举个示例：</p><blockquote><p>假设cache 1 中有一个变量<code>x = 0</code>的 Cache line 处于S状态(共享)。<br>那么其他拥有x变量的 cache 2、cache 3 等<code>x</code>的 Cache line调整为<code>S</code>状态（共享）或者调整为<code>I</code>状态（无效）。</p></blockquote><h3 id="2-多核缓存协同操作"><a href="#2-多核缓存协同操作" class="headerlink" title="2. 多核缓存协同操作"></a>2. 多核缓存协同操作</h3><h4 id="1-内存变量"><a href="#1-内存变量" class="headerlink" title="(1) 内存变量"></a>(1) 内存变量</h4><p>假设有三个CPU A、B、C，对应三个缓存分别是cache a、b、c。在主内存中定义了<code>x</code>的引用值为0。</p><p><img src="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-4.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-4.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="内存变量"></p><h4 id="2-单核读取"><a href="#2-单核读取" class="headerlink" title="(2) 单核读取"></a>(2) 单核读取</h4><p>执行流程是：</p><ul><li>CPU A发出了一条指令，从主内存中读取<code>x</code>。</li><li>从主内存通过 bus 读取到 CPU A 的缓存中（远端读取 Remote read）,这时该 Cache line 修改为 E 状态（独享）。</li></ul><p><img src="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-5.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-5.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="单核读取"></p><h4 id="3-双核读取"><a href="#3-双核读取" class="headerlink" title="(3) 双核读取"></a>(3) 双核读取</h4><p>执行流程是：</p><ul><li>CPU A发出了一条指令，从主内存中读取<code>x</code>。</li><li>CPU A从主内存通过bus读取到 cache a 中并将该 Cache line 设置为E状态。</li><li>CPU B发出了一条指令，从主内存中读取<code>x</code>。</li><li>CPU B试图从主内存中读取<code>x</code>时，CPU A检测到了地址冲突。这时CPU A对相关数据做出响应。此时<code>x</code>存储于 cache a 和 cache b 中，<code>x</code>在 chche a 和 cache b 中都被设置为S状态(共享)。</li></ul><p><img src="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-6.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-6.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="双核读取"></p><h4 id="4-修改数据"><a href="#4-修改数据" class="headerlink" title="(4) 修改数据"></a>(4) 修改数据</h4><p>执行流程是：</p><ul><li>CPU A 计算完成后发指令需要修改<code>x</code>.</li><li>CPU A 将<code>x</code>设置为M状态（修改）并通知缓存了<code>x</code>的 CPU B, CPU B 将本地 cache b 中的<code>x</code>设置为<code>I</code>状态(无效)</li><li>CPU A 对<code>x</code>进行赋值。</li></ul><p><img src="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-7.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-7.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="修改数据"></p><h4 id="5-同步数据"><a href="#5-同步数据" class="headerlink" title="(5) 同步数据"></a>(5) 同步数据</h4><p>那么执行流程是：</p><ul><li>CPU B 发出了要读取x的指令。</li><li>CPU B 通知CPU A,CPU A将修改后的数据同步到主内存时cache a 修改为E（独享）</li><li>CPU A同步CPU B的x,将cache a和同步后cache b中的x设置为S状态（共享）。</li></ul><p><img src="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-8.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/18/javabf-cpu-8.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="同步数据"></p><h3 id="3-CPU-存储模型简介"><a href="#3-CPU-存储模型简介" class="headerlink" title="3. CPU 存储模型简介"></a>3. CPU 存储模型简介</h3><p>MESI协议为了保证多个 CPU cache 中共享数据的一致性，定义了 Cache line 的四种状态，而 CPU 对 cache 的<code>4</code>种操作可能会产生不一致状态，因此 cache 控制器监听到本地操作和远程操作的时候，需要对地址一致的 Cache line 状态做出一定的修改，从而保证数据在多个cache之间流转的一致性。</p><p>但是，缓存的一致性消息传递是要时间的，这就使得状态切换会有更多的延迟。某些状态的切换需要特殊的处理，可能会阻塞处理器。这些都将会导致各种各样的稳定性和性能问题。比如你需要修改本地缓存中的一条信息，那么你必须将<code>I</code>（无效）状态通知到其他拥有该缓存数据的CPU缓存中，并且等待确认。等待确认的过程会阻塞处理器，这会降低处理器的性能。因为这个等待远远比一个指令的执行时间长的多。所以，为了为了避免这种阻塞导致时间的浪费，引入了存储缓存(<code>Store Buffer</code>)和无效队列(<code>Invalidate Queue</code>)。</p><h4 id="1-存储缓存"><a href="#1-存储缓存" class="headerlink" title="(1) 存储缓存"></a>(1) 存储缓存</h4><p>在没有存储缓存时，CPU 要写入一个量，有以下情况：</p><ul><li>量不在该 CPU 缓存中，则需要发送 Read Invalidate 信号，再等待此信号返回，之后再写入量到缓存中。</li><li>量在该 CPU 缓存中，如果该量的状态是 Exclusive 则直接更改。而如果是 Shared 则需要发送 Invalidate 消息让其它 CPU 感知到这一更改后再更改。</li></ul><p>这些情况中，很有可能会触发该 CPU 与其它 CPU 进行通讯，接着需要等待它们回复。这会浪费大量的时钟周期！为了提高效率，可以使用<strong>异步</strong>的方式去处理：先将值写入到一个 Buffer 中，再发送通讯的信号，等到信号被响应，再应用到 cache 中。并且此 Buffer 能够接受该 CPU 读值。这个 Buffer 就是 Store Buffer。而不须要等待对某个量的赋值指令的完成才继续执行下一条指令，直接去 Store Buffer 中读该量的值，这种优化叫<strong>Store Forwarding</strong>。</p><h4 id="2-无效队列"><a href="#2-无效队列" class="headerlink" title="(2) 无效队列"></a>(2) 无效队列</h4><p>同理，解决了主动发送信号端的效率问题，那么，接受端 CPU 接受到 Invalidate 信号后如果立即采取相应行动(去其它 CPU 同步值)，再返回响应信号，则时钟周期也太长了，此处也可优化。接受端 CPU 接受到信号后不是立即采取行动，而是将 Invalidate 信号插入到一个队列 Queue 中，立即作出响应。等到合适的时机，再去处理这个 Queue 中的 Invalidate 信号，并作相应处理。这个 Queue 就是<strong>Invalidate Queue</strong>。</p><h2 id="四、乱序执行"><a href="#四、乱序执行" class="headerlink" title="四、乱序执行"></a>四、乱序执行</h2><p><strong>乱序执行（<code>out-of-orderexecution</code>）</strong>：是指CPU允许将多条指令不按程序规定的顺序分开发送给各相应电路单元处理的技术。这样将根据各电路单元的状态和各指令能否提前执行的具体情况分析后，将能提前执行的指令立即发送给相应电路。</p><p>这好比请A、B、C三个名人为晚会题写横幅“春节联欢晚会”六个大字，每人各写两个字。如果这时在一张大纸上按顺序由A写好”春节”后再交给B写”联欢”，然后再由C写”晚会”，那么这样在A写的时候，B和C必须等待，而在B写的时候C仍然要等待而A已经没事了。</p><p>但如果采用三个人分别用三张纸同时写的做法， 那么B和C都不必须等待就可以同时各写各的了，甚至C和B还可以比A先写好也没关系（就象乱序执行），但当他们都写完后就必须重新在横幅上（自然可以由别人做，就象CPU中乱序执行后的重新排列单元）按”春节联欢晚会”的顺序排好才能挂出去。</p><p>所以，CPU 为什么会有乱序执行优化？本质原因是<strong>CPU为了效率</strong>，将长费时的操作“异步”执行，排在后面的指令不等前面的指令执行完毕就开始执行后面的指令。而且允许排在前面的长费时指令后于排在后面的指令执行完。</p><p>CPU 执行乱序主要有以下几种：</p><ul><li>**写写乱序(store store)**：<code>a=1;b=2; -&gt; b=2;a=1;</code></li><li>**写读乱序(store load)**：<code>a=1;load(b); -&gt; load(b);a=1;</code></li><li>**读读乱序(load load)**：<code>load(a);load(b); -&gt; load(b);load(a);</code></li><li>**读写乱序(load store)**：<code>load(a);b=2; -&gt; b=2;load(a);</code></li></ul><p>总而言之，<strong>CPU的乱序执行优化指的是处理器为提高运算速度而做出违背代码原有顺序的优化</strong>。</p><hr><p>参考文章：</p><ul><li><a href="http://ifeve.com/from-javaeye-cpu-cache/">从Java视角理解系统结构（二）CPU缓存</a></li><li><a href="http://www.cnblogs.com/yanlong300/p/8986041.html">CPU缓存一致性协议MESI</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CPU缓存 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之责任链模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-ze-ren-lian-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-ze-ren-lian-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="模式动机"><a href="#模式动机" class="headerlink" title="模式动机"></a>模式动机</h2><p>很多情况下，在一个软件系统中可以处理某个请求的对象不止一个。例如审批工作流等，他们可以构成一条处理采购单的链式结构，采购单(可以看作是要处理的信息)沿着这条链进行传递，这条链就称为责任链。责任链可以是一条直线、一个环或者一个树形结构，最常见的职责链是直线型，即沿着一条单向的链来传递请求。链上的每一个对象都是请求处理者，责任链模式可以将请求的处理者组织成一条链，并让请求沿着链传递，由链上的处理者对请求进行相应的处理。在此过程中，客户端实际上无须关心请求的处理细节以及请求的传递，只需将请求发送到链上即可，从而实现请求发送者和请求处理者解耦。</p><h2 id="模式定义"><a href="#模式定义" class="headerlink" title="模式定义"></a>模式定义</h2><blockquote><p><strong>定义</strong>：责任链模式(<code>Chain of Responsibility Pattern</code>)是使多个对象都有机会处理请求，从而避免请求的发送者与请求处理者耦合在一起。将这些对象连接成一条链，并且沿着这条链传递请求，直到有对象处理它为止。它是一种对象行为型模式。</p></blockquote><p><strong>实质</strong>：责任链上的处理者负责处理请求，客户只需要将请求发送到职责链上即可，无须关心请求的处理细节和请求的传递，从而实现请求发送者与请求处理者的解耦。</p><h2 id="模式结构"><a href="#模式结构" class="headerlink" title="模式结构"></a>模式结构</h2><h3 id="参与角色"><a href="#参与角色" class="headerlink" title="参与角色"></a>参与角色</h3><ul><li><code>Handler</code>（抽象处理者）：处理请求的接口，一般设计为具有抽象请求处理方法的抽象类，以便于不同的具体处理者进行继承，从而实现具体的请求处理方法。此外，由于每一个请求处理者的下家还是一个处理者，因此抽象处理者本身还包含了一个本身的引用(<code>nextHandler</code>)作为其对下家的引用，以便将处理者链成一条链；</li><li><code>ConcreteHandler</code>（具体处理者）：抽象处理者的子类，可以处理用户请求，其实现了抽象处理者中定义的请求处理方法。在具体处理请求时需要进行判断，若其具有相应的处理权限，那么就处理它；否则，其将请求转发给后继者，以便让后面的处理者进行处理。</li></ul><p>在责任链模式里，由每一个请求处理者对象对其下家的引用而连接起来形成一条请求处理链。请求将在这条链上一直传递，直到链上的某一个请求处理者能够处理此请求。<strong>发出这个请求的客户端并不知道链上的哪一个请求处理者将处理这个请求，这使得系统可以在不影响客户端的情况下动态地重新组织链和分配责任</strong>。</p><h3 id="UML类图"><a href="#UML类图" class="headerlink" title="UML类图"></a>UML类图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/11/04/chain-of-responsibility.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/11/04/chain-of-responsibility.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="责任链模式UML类图"></p><h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p>首先，责任链模式的核心在于对请求处理者的抽象。在实现过程中，抽象处理者一般会被设定为<strong>抽象类</strong>，其典型实现代码如下所示：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 责任连模式的抽象处理者角色. * * Created by blinkfox on 16/7/11. */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** 后继处理者角色. */</span>    <span class="token keyword">protected</span> <span class="token class-name">Handler</span> nextHandler<span class="token punctuation">;</span>    <span class="token comment">/**     * 处理请求的抽象方法.     *     * @param condition 条件     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">String</span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * nextHandler的Setter方法.     *     * @param nextHandler 后继处理器     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNextHandler</span><span class="token punctuation">(</span><span class="token class-name">Handler</span> nextHandler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>nextHandler <span class="token operator">=</span> nextHandler<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其次，是若干个具体的处理角色类。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体处理角色1. * * Created by blinkfox on 16/7/11. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteHandler1</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 具体处理角色1的处理方法.     *     * @param condition 条件     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">String</span> condition<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 如果是自己的责任，就自己处理，负责传给下家处理</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"ConcreteHandler1"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> <span class="token string">"具体处理角色1的处理方法handled1..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> <span class="token string">"具体处理角色1 通过..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            nextHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体处理角色2. * * Created by blinkfox on 16/7/11. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteHandler2</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 具体处理角色2的处理方法.     *     * @param condition 条件     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">String</span> condition<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 如果是自己的责任，就自己处理，负责传给下家处理</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"ConcreteHandler2"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> <span class="token string">"具体处理角色2的处理方法handled1..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> <span class="token string">"具体处理角色2 通过..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            nextHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体处理角色n. * * Created by blinkfox on 16/7/11. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteHandlerN</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 这里假设n是链的最后一个节点必须处理掉.     * 在实际情况下，可能出现环，或者是树形，这里并不一定是最后一个节点.     *     * @param condition 参数条件     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">String</span> condition<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> <span class="token string">"具体处理角色n的处理方法 结束..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后，是客户端场景类，代码调用示例如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 责任连模式的客户端场景类. * * Created by blinkfox on 16/7/11. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChainClient</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 主入口方法.     *     * @param args 数组参数     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Handler</span> handler1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteHandler1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Handler</span> handler2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteHandler2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Handler</span> handlern <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteHandlerN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        handler1<span class="token punctuation">.</span><span class="token function">setNextHandler</span><span class="token punctuation">(</span>handler2<span class="token punctuation">)</span><span class="token punctuation">;</span>        handler2<span class="token punctuation">.</span><span class="token function">setNextHandler</span><span class="token punctuation">(</span>handlern<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//假设这个请求是ConcreteHandler2的责任</span>        handler1<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token string">"ConcreteHandler2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong>：责任链模式并不创建职责链，职责链的创建工作必须由系统的其他部分来完成，一般由使用该责任链的客户端创建。职责链模式降低了请求的发送者和请求处理者之间的耦合，从而使得多个请求处理者都有机会处理这个请求。</p></blockquote><h2 id="模式分析"><a href="#模式分析" class="headerlink" title="模式分析"></a>模式分析</h2><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>在实际软件开发中，如果遇到有多个对象可以处理同一请求时可以考虑使用职责链模式，最常见的例子包括在 Java Web 应用开发中创建一个过滤器（Filter）链来对请求数据进行过滤（中文字符乱码的处理）、在工作流系统中实现公文的分级审批、在Struts应用中添加不同的拦截器(常用的有类型转化、异常处理，数据校验…)以增强Struts2的功能等。</p><h3 id="纯与不纯的责任链模式"><a href="#纯与不纯的责任链模式" class="headerlink" title="纯与不纯的责任链模式"></a>纯与不纯的责任链模式</h3><ul><li><strong>纯的责任链模式</strong>要求一个具体的处理者对象只能在两个行为中选择一个：一是承担责任，而是把责任推给下家。不允许出现某一个具体处理者对象在承担了一部分责任后又把责任向下传的情况；</li><li>在纯责任链模式里面，一个请求必须被某一个处理者对象所接收；</li><li>在不纯的责任链模式里面，一个请求可以最终不被任何接收端对象所接收。</li></ul><p>纯的责任链模式的实际例子很难找到，一般看到的例子均是不纯的责任链模式的实现。</p><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul><li>降低耦合度，使请求的发送者和接收者解耦，便于灵活的、可插拔的定义请求处理过程；</li><li>简化、封装了请求的处理过程，并且这个过程对客户端而言是透明的，以便于动态地重新组织链以及分配责任，增强请求处理的灵活性；</li><li>可以从职责链任何一个节点开始，也可以随时改变内部的请求处理规则，每个请求处理者都可以去动态地指定他的继任者；</li><li>职责链可简化对象间的相互连接。它们仅需保持一个指向其后继者的引用，而不需保持它所有的候选接受者的引用；</li><li>增加新的请求处理类很方便。</li></ul><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul><li>不能保证请求一定被接收。既然一个请求没有明确的接收者，那么就不能保证它一定会被处理；</li><li>该请求可能一直到链的末端都得不到处理。一个请求也可能因该链没有被正确配置而得不到处理；</li><li>系统性能将受到一定影响，而且在进行代码调试时不太方便；可能会造成循环调用。</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>在职责链模式里，很多对象由每一个对象对其下家的引用而连接起来形成一条链。请求在这个链上传递，直到链上的某一个对象决定处理此请求。发出这个请求的客户端并不知道链上的哪一个对象最终处理这个请求，这使得系统可以在不影响客户端的情况下动态地重新组织链和分配责任。</li><li>职责链模式的主要优点在于可以降低系统的耦合度，简化对象的相互连接，同时增强给对象指派职责的灵活性，增加新的请求处理类也很方便；其主要缺点在于不能保证请求一定被接收，且对于比较长的职责链，请求的处理可能涉及到多个处理对象，系统性能将受到一定影响，而且在进行代码调试时不太方便。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript之再学习</title>
      <link href="/post/qian-duan/javascript-zhi-zai-xue-xi/"/>
      <url>/post/qian-duan/javascript-zhi-zai-xue-xi/</url>
      
        <content type="html"><![CDATA[<h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>JavaScript 是一种面向对象的动态语言，它包含类型、运算符、标准内置（ built-in）对象和方法。它的语法来源于 Java 和 C，所以这两种语言的许多语法特性同样适用于 JavaScript。需要注意的一个主要区别是 JavaScript 不支持类，类这一概念在 JavaScript 通过对象原型（object prototype）得到延续。另一个主要区别是 JavaScript 中的函数也是对象，JavaScript 允许函数在包含可执行代码的同时，能像其他对象一样被传递。</p><h2 id="数据类型和结构"><a href="#数据类型和结构" class="headerlink" title="数据类型和结构"></a>数据类型和结构</h2><h3 id="1-动态类型"><a href="#1-动态类型" class="headerlink" title="1. 动态类型"></a>1. 动态类型</h3><p><code>JavaScript</code>是一种弱类型或者说动态语言。这意味着你不用提前声明变量的类型，在程序运行过程中，类型会被自动确定。这也意味着你可以使用同一个变量保存不同类型的数据：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>    <span class="token comment">// foo is a Number now</span><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token string">"bar"</span><span class="token punctuation">;</span> <span class="token comment">// foo is a String now</span><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment">// foo is a Boolean now</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="2-数据类型"><a href="#2-数据类型" class="headerlink" title="2. 数据类型"></a>2. 数据类型</h3><p>最新的<code>ECMAScript</code>标准定义了 7 种数据类型:</p><ul><li>6 种原始类型<ul><li><code>Null</code> (空, 只有一个值<code>null</code>)</li><li><code>Undefined</code> (未定义, 一个没有被赋值的变量的默认值是<code>undefined</code>):</li><li><code>Boolean</code> (布尔, 可以有两个值：<code>true</code> 和 <code>false</code>)</li><li><code>Number</code> (数字)</li><li><code>String</code> (字符串)</li><li><code>Symbol</code> (符号, ECMAScript 6 新定义的类型，表示独一无二的值)</li></ul></li><li>和 <code>Object</code> (对象)<ul><li><code>Function</code> (函数)</li><li><code>Array</code> (数组)</li><li><code>Date</code> (日期)</li><li><code>JSON</code> (JS对象标识,来序列化对象、数组、数值、字符串、布尔值和 <code>null</code>)</li><li><code>Math</code> (数学方面的计算)</li><li><code>RegExp</code> (正则表达式)</li><li><code>Error</code> (错误)</li><li><code>Map</code></li><li><code>Set</code></li></ul></li></ul><h3 id="内置对象"><a href="#内置对象" class="headerlink" title="内置对象"></a>内置对象</h3><p>这里的<strong>内置对象</strong>指的是在全局作用域(<code>global scope</code>)中的对象，由于很多，不再一一列出说明，更全面的解释在<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects">这里</a>。</p><p>全局对象本身可通过<code>this</code>操作符在全局作用域中获得。实际上，全局作用域就是由全局对象的各个属性组成的（包括继承来的属性）。</p><h2 id="严格模式"><a href="#严格模式" class="headerlink" title="严格模式"></a>严格模式</h2><p>除了正常运行模式，ECMAscript 5添加了第二种运行模式：”严格模式”（<code>strict mode</code>）。顾名思义，这种模式使得Javascript在更严格的条件下运行。</p><p>严格模式可以应用到整个script标签或个别函数中。设立”严格模式”的目的，主要有以下几个：</p><ul><li>消除 Javascript 语法的一些不合理、不严谨之处，减少一些怪异行为;</li><li>消除代码运行的一些不安全之处，保证代码运行的安全；</li><li>提高编译器效率，增加运行速度；</li><li>为未来新版本的 Javascript 做好铺垫。</li></ul><h3 id="为某个script标签开启严格模式"><a href="#为某个script标签开启严格模式" class="headerlink" title="为某个script标签开启严格模式"></a>为某个script标签开启严格模式</h3><p>进入严格模式的标志，是下面这行语句：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="为某个函数开启严格模式"><a href="#为某个函数开启严格模式" class="headerlink" title="为某个函数开启严格模式"></a>为某个函数开启严格模式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">strict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token comment">// 函数级别严格模式语法</span>  <span class="token string">'use strict'</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token string">"I'm a strict mode function!  "</span> <span class="token operator">+</span> <span class="token function">nested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">notStrict</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token string">"I'm not strict."</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="相等性判断"><a href="#相等性判断" class="headerlink" title="相等性判断"></a>相等性判断</h2><p>JavaScript提供三种不同的值比较操作：</p><ul><li>严格相等 (“triple equals” 或 “identity”)，使用<code>===</code></li><li>宽松相等 (“double equals”) ，使用<code>==</code></li><li>以及<code>Object.is</code> (ECMAScript 2015/ ES6 新特性)</li></ul><p>简而言之，在比较两件事情时，双等号将执行类型转换; 三等号将进行相同的比较，而不进行类型转换 (如果类型不同, 只是总会返回 false );  而<code>Object.is</code>的行为方式与三等号相同，但是对于NaN和-0和+0进行特殊处理，所以最后两个不相同，而<code>Object.is(NaN，NaN)</code>将为 true。</p><p><img src="https://statics.sh1a.qingstor.com/2020/11/27/js_equals.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2020/11/27/js_equals.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="各原始类型值的相等比较对照表"></p><h2 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h2><p>作用域就是变量与函数的可访问范围，即作用域控制着变量与函数的可见性和生命周期。在JavaScript中，变量的作用域有<strong>全局作用域</strong>和<strong>局部作用域</strong>两种。</p><h3 id="全局作用域"><a href="#全局作用域" class="headerlink" title="全局作用域"></a>全局作用域</h3><p>在代码中任何地方都能访问到的对象拥有全局作用域。一般来说以下几种情形：</p><ul><li>最外层函数和在最外层函数外面定义的变量拥有全局作用域。</li><li>所有未定义而直接赋值的变量自动声明为拥有全局作用域。</li><li>所有window对象的属性拥有全局作用域。如：<code>window.name</code>、<code>window.location</code>等。</li></ul><blockquote><p><strong>注</strong>：全局变量存在于程序的整个生命周期。没有块级作用域。</p></blockquote><h3 id="局部作用域"><a href="#局部作用域" class="headerlink" title="局部作用域"></a>局部作用域</h3><p>局部作用域一般只在固定的代码片段内可访问到，最常见的是在函数内部，所有在一些地方也会看到有人把这种作用域称为<strong>函数作用域</strong>。</p><h3 id="作用域链"><a href="#作用域链" class="headerlink" title="作用域链"></a>作用域链</h3><p>JavaScript里一切都是对象。函数对象和其它对象一样，拥有可以通过代码访问的属性和一系列仅供JavaScript引擎访问的内部属性。其中一个内部属性是<code>Scope</code>，该内部属性包含了函数被创建的作用域中对象的集合，这个集合被称为函数的作用域链，它决定了哪些数据能被函数访问。</p><p>因为全局变量总是存在于<strong>运行时上下文</strong>作用域链的最末端。所以，在标识符解析的时候，查找全局变量是最慢的。所以，在编写代码的时候应尽量少使用全局变量，尽可能使用局部变量。一个好的经验法则是：<strong>如果一个跨作用域的对象被引用了一次以上，则先把它存储到局部变量里再使用</strong>。</p><p><code>with</code>语句主要用来临时扩展作用域链，将语句中的对象添加到作用域的头部。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">person <span class="token operator">=</span> <span class="token punctuation">&#123;</span>name<span class="token operator">:</span> <span class="token string">"yhb"</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">22</span><span class="token punctuation">,</span> height<span class="token operator">:</span><span class="token number">175</span><span class="token punctuation">,</span> wife<span class="token operator">:</span> <span class="token punctuation">&#123;</span>name<span class="token operator">:</span> <span class="token string">"lwy"</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">with</span> <span class="token punctuation">(</span>person<span class="token punctuation">.</span>wife<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>with语句将<code>person.wife</code>添加到当前作用域链的头部，所以输出的就是：<code>lwy</code>；with语句结束后，作用域链恢复正常。</p><blockquote><p>当代码运行到with语句时，运行期上下文的作用域链临时被改变了。一个新的可变对象被创建，它包含了参数指定的对象的所有属性。这个对象将被推入作用域链的头部，这意味着函数的所有局部变量现在处于第二个作用域链对象中，因此访问代价更高了。<br><strong>注</strong>：在程序中应避免使用with语句。</p></blockquote><h2 id="闭包-Closures"><a href="#闭包-Closures" class="headerlink" title="闭包(Closures)"></a>闭包(Closures)</h2><h3 id="一个示例"><a href="#一个示例" class="headerlink" title="一个示例"></a>一个示例</h3><p>如何从外部读取局部变量？</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> n<span class="token operator">=</span><span class="token number">999</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">alert</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 999</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在上面的代码中，函数f2就被包括在函数f1内部，这时f1内部的所有局部变量，对f2都是可见的。但是反过来就不行，f2内部的局部变量，对f1就是不可见的。这就是Javascript语言特有的”链式作用域”结构（<code>chain scope</code>），子对象会一级一级地向上寻找所有父对象的变量。所以，<strong>父对象的所有变量，对子对象都是可见的，反之则不成立</strong>。</p><p>既然f2可以读取f1中的局部变量，那么只要把f2作为返回值，我们不就可以在f1外部读取它的内部变量了吗！</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> n<span class="token operator">=</span><span class="token number">999</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">alert</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 999</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> f2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> result<span class="token operator">=</span><span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 999</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="闭包解释"><a href="#闭包解释" class="headerlink" title="闭包解释"></a>闭包解释</h3><blockquote><p><strong>闭包定义</strong>：闭包是一个函数和函数所声明的词法环境的结合。</p></blockquote><p>在上面的代码中，f2函数就是闭包。<strong>闭包</strong>（<code>closure</code>）定义非常抽象，很难看懂。我的理解是，<strong>闭包就是能够读取其他函数内部变量的函数</strong>。在本质上，闭包就是将函数内部和函数外部连接起来的一座桥梁。</p><p>闭包最大用处有两个，一个是可以读取函数内部的变量，另一个就是让这些变量的值始终保持在内存中，不会在调用结束后被垃圾回收机制（<code>garbage collection</code>）回收。</p><h3 id="立即执行函数表达式"><a href="#立即执行函数表达式" class="headerlink" title="立即执行函数表达式"></a>立即执行函数表达式</h3><p>有时你想模拟一个模拟块级作用域，例如你想将变量从全局作用域隔离。完成这个工作的模式叫做<code>IIFE</code>(立即执行函数表达式(<code>Immediately Invoked Function Expression</code>))：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 块开始</span>    <span class="token keyword">var</span> tmp <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>  <span class="token comment">// 非全局变量</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 块结束</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="用闭包模拟私有方法"><a href="#用闭包模拟私有方法" class="headerlink" title="用闭包模拟私有方法"></a>用闭包模拟私有方法</h3><p>JavaScript 并不提供原生的支持私有方法，但是可以使用闭包模拟私有方法。私有方法不仅仅有利于限制对代码的访问：还提供了管理全局命名空间的强大能力，避免非核心的方法弄乱了代码的公共接口部分。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> Counter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> privateCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">changeBy</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        privateCounter <span class="token operator">+=</span> val<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>        <span class="token function-variable function">increment</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">changeBy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token function-variable function">decrement</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">changeBy</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> privateCounter<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Counter<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* logs 0 */</span>Counter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Counter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Counter<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* logs 2 */</span>Counter<span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Counter<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* logs 1 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面创建了一个环境，为三个函数所共享：<code>Counter.increment</code>, <code>Counter.decrement</code>和<code>Counter.value</code>。该共享环境创建于一个匿名函数体内，该函数一经定义立刻执行。环境中包含两个私有项：名为<code>privateCounter</code>的变量和名为<code>changeBy</code>的函数。这两项都无法在匿名函数外部直接访问。必须通过匿名包装器返回的三个公共函数访问。</p><p><strong>注意</strong>：</p><ul><li>由于闭包会使得函数中的变量都被保存在内存中，内存消耗很大，所以不能滥用闭包，否则会造成网页的性能问题，在IE中可能导致内存泄露。解决方法是，在退出函数之前，将不使用的局部变量全部删除。</li><li>闭包会在父函数外部，改变父函数内部变量的值。所以，如果你把父函数当作对象（object）使用，把闭包当作它的公用方法（Public Method），把内部变量当作它的私有属性（private value），这时一定要小心，不要随便改变父函数内部变量的值。</li></ul><h2 id="内存机制"><a href="#内存机制" class="headerlink" title="内存机制"></a>内存机制</h2><p>首先JavaScript中的变量分为<strong>基本类型</strong>和<strong>引用类型</strong>。</p><ul><li>基本类型就是保存在栈内存中的简单数据段。基本类型有<code>Undefined</code>、<code>Null</code>、<code>Boolean</code>、<code>Number</code>和<code>String</code>。这些类型在内存中分别占有固定大小的空间，他们的值保存在<strong>栈空间</strong>，我们通过按值来访问的。</li><li>引用类型指的是那些保存在堆内存中的对象。引用类型，值大小不固定，栈内存中存放地址指向堆内存中的对象。是按引用访问的。栈内存中存放的只是该对象的访问地址，在堆内存中为这个值分配空间。</li></ul><h3 id="为什么会有栈内存和堆内存之分？"><a href="#为什么会有栈内存和堆内存之分？" class="headerlink" title="为什么会有栈内存和堆内存之分？"></a>为什么会有栈内存和堆内存之分？</h3><p>与垃圾回收机制有关，为了使程序运行时占用的内存最小。</p><p>当一个方法执行时，每个方法都会建立自己的内存栈，在这个方法内定义的变量将会逐个放入这块栈内存里，随着方法的执行结束，这个方法的内存栈也将自然销毁了。因此，所有在方法中定义的变量都是放在栈内存中的；</p><p>当我们在程序中创建一个对象时，这个对象将被保存到运行时数据区中，以便反复利用（因为对象的创建成本通常较大），这个运行时数据区就是堆内存。堆内存中的对象不会随方法的结束而销毁，即使方法结束后，这个对象还可能被另一个引用变量所引用（方法的参数传递时很常见），则这个对象依然不会被销毁，只有当一个对象没有任何引用变量引用它时，系统的垃圾回收机制才会在核实的时候回收它。</p><h3 id="垃圾回收机制"><a href="#垃圾回收机制" class="headerlink" title="垃圾回收机制"></a>垃圾回收机制</h3><p>Javascript具有自动垃圾回收机制(<code>GC</code>:<code>Garbage Collecation</code>)，也就是说，执行环境会负责管理代码执行过程中使用的内存。</p><p>JavaScript垃圾回收的机制很简单：<strong>找出不再使用的变量，然后释放掉其占用的内存，但是这个过程不是实时的，因为其开销比较大，所以垃圾回收器会按照固定的时间间隔周期性的执行</strong>。</p><p>不再使用的变量也就是生命周期结束的变量，当然只可能是局部变量，全局变量的生命周期直至浏览器卸载页面才会结束。局部变量只在函数的执行过程中存在，而在这个过程中会为局部变量在栈或堆上分配相应的空间，以存储它们的值，然后在函数中使用这些变量，直至函数结束，而闭包中由于内部函数的原因，外部函数并不能算是结束。</p><h4 id="清除方式"><a href="#清除方式" class="headerlink" title="清除方式"></a>清除方式</h4><ul><li><strong>标记清除</strong>：垃圾回收器在运行的时候会给存储在内存中的所有变量都加上标记。然后，它会去掉环境中的变量以及被环境中的变量引用的变量的标记（闭包）。而在此之后再被加上标记的变量将被视为准备删除的变量，原因是环境中的变量已经无法访问到这些变量了。最后，垃圾回收器完成内存清除工作，销毁那些带标记的值并回收它们所占用的内存空间。</li><li><strong>引用计数</strong>：引用计数的含义是跟踪记录每个值被引用的次数。当声明了一个变量并将一个引用类型值赋给该变量时，则这个值的引用次数就是1。如果同一个值又被赋给另一个变量，则该值的引用次数加1。相反，如果包含对这个值引用的变量又取得了另外一个值，则这个值的引用次数减1。当这个值的引用次数变成0时，则说明没有办法再访问这个值了，因而就可以将其占用的内存空间回收回来。这样，当垃圾回收器下次再运行时，它就会释放那些引用次数为0的值所占用的内存。</li></ul><h2 id="原型-prototype"><a href="#原型-prototype" class="headerlink" title="原型(prototype)"></a>原型(prototype)</h2><p>原型是一个对象，其他对象可以通过它实现属性继承。JavaScript的对象中都包含了一个<code>Prototype</code>内部属性，这个属性所对应的就是该对象的原型。<code>Prototype</code>作为对象的内部属性，是不能被直接访问的。所以为了方便查看一个对象的原型，Firefox和Chrome中提供了<code>__proto__</code>这个非标准的访问器。</p><ul><li>所有的对象都有<code>__proto__</code>属性，该属性对应着该对象的原型。</li><li>所有的函数对象都有<code>prototype</code>属性，该属性的值会被赋值给该函数创建的对象的<code>__proto__</code>属性</li><li>所有的原型对象都有<code>constructor</code>属性，该属性对应创建所有指向该原型的实例的构造函数</li><li>函数对象和原型对象通过<code>prototype</code>和<code>constructor</code>属性进行相互关联</li><li><code>Object</code>实例对象的原型<code>obj.__proto__</code>就是<code>Object.prototype</code></li><li><code>hasOwnProperty</code>是<code>Object.prototype</code>的一个方法，该方法能判断一个对象是否包含自定义属性而不是原型链上的属性，因为”hasOwnProperty” 是 JavaScript 中唯一一个处理属性但是不查找原型链的函数</li></ul><h3 id="原型链"><a href="#原型链" class="headerlink" title="原型链"></a>原型链</h3><p>因为每个对象和原型都有原型，对象的原型指向对象的父，而父的原型又指向父的父，这种原型层层连接起来的就构成了原型链。</p><p>当通过原型链查找一个属性的时候，首先查找的是对象本身的属性，如果找不到才会继续按照原型链进行查找。这样一来，如果想要覆盖原型链上的一些属性，我们就可以直接在对象中引入这些属性，达到属性隐藏的效果。</p><h2 id="对象创建方式"><a href="#对象创建方式" class="headerlink" title="对象创建方式"></a>对象创建方式</h2><h3 id="1-Object构造函数方式"><a href="#1-Object构造函数方式" class="headerlink" title="1. Object构造函数方式"></a>1. Object构造函数方式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> Person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Person<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Nike'</span><span class="token punctuation">;</span>Person<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">29</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这行代码创建了<code>Object</code>引用类型的一个新实例，然后把实例保存在变量<code>Person</code>中。</p><h3 id="2-对象字面量方式"><a href="#2-对象字面量方式" class="headerlink" title="2. 对象字面量方式"></a>2. 对象字面量方式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> Person <span class="token operator">=</span> <span class="token punctuation">&#123;</span> name<span class="token operator">:</span> <span class="token string">'Nike'</span><span class="token punctuation">;</span> age<span class="token operator">:</span> <span class="token number">29</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>对象字面量是对象定义的一种简写形式，目的在于简化创建包含大量属性对象的过程。</p><blockquote><p><strong>注</strong>：前两种方法的缺点在于：它们都是用了同一个接口创建很多对象，会产生大量的重复代码，就是如果你有100个对象，那你要输入100次很多相同的代码。那我们有什么方法来避免过多的重复代码呢，就是把创建对象的过程封装在函数体内，通过函数的调用直接生成对象。</p></blockquote><h3 id="3-工厂模式"><a href="#3-工厂模式" class="headerlink" title="3. 工厂模式"></a>3. 工厂模式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createPerson</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> job</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    o<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    o<span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    o<span class="token punctuation">.</span>job <span class="token operator">=</span> job<span class="token punctuation">;</span>    o<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> o<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token function">createPerson</span><span class="token punctuation">(</span><span class="token string">'Nike'</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token string">'teacher'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在使用工厂模式创建对象的时候，我们都可以注意到，在<code>createPerson</code>函数中，返回的是一个对象。但我们就无法判断返回的对象究竟是一个什么样的类型。于是就出现了第四种创建对象的模式。</p><h3 id="4-构造函数方式"><a href="#4-构造函数方式" class="headerlink" title="4. 构造函数方式"></a>4. 构造函数方式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> job</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>job <span class="token operator">=</span> job<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'Nike'</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token string">'teacher'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">alert</span><span class="token punctuation">(</span>person1 <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ture</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对比工厂模式，我们可以发现以下区别：</p><ul><li>没有显示地创建对象</li><li>直接将属性和方法赋给了<code>this</code>对象</li><li>没有<code>return</code>语句</li><li>终于可以识别的对象的类型。对于检测对象类型，我们应该使用instanceof操作符，我们来进行自主检测：</li></ul><p>那么构造函数确实挺好用的，但是它也有它的缺点：就是每个方法都要在每个实例上重新创建一遍，方法指的就是我们在对象里面定义的函数。如果方法的数量很多，就会占用很多不必要的内存。于是出现了第五种创建对象的方法。</p><h3 id="5-原型创建对象模式"><a href="#5-原型创建对象模式" class="headerlink" title="5. 原型创建对象模式"></a>5. 原型创建对象模式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Nike'</span><span class="token punctuation">;</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>jbo <span class="token operator">=</span> <span class="token string">'teacher'</span><span class="token punctuation">;</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>person1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Greg'</span><span class="token punctuation">;</span><span class="token function">alert</span><span class="token punctuation">(</span>person1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//'Greg' --来自实例</span><span class="token function">alert</span><span class="token punctuation">(</span>person2<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//'Nike' --来自原型</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当为对象实例添加一个属性时，这个属性就会屏蔽原型对象中保存的同名属性。</p><p>这时候我们就可以使用构造函数模式与原型模式结合的方式，构造函数模式用于定义实例属性，而原型模式用于定义方法和共享的属性。</p><h3 id="6-组合使用构造函数模式和原型模式"><a href="#6-组合使用构造函数模式和原型模式" class="headerlink" title="6. 组合使用构造函数模式和原型模式"></a>6. 组合使用构造函数模式和原型模式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> job</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>job <span class="token operator">=</span> job<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    constructor<span class="token operator">:</span> Person<span class="token punctuation">,</span>    <span class="token function-variable function">sayName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'Nike'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'teacher'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="7-动态原型模式"><a href="#7-动态原型模式" class="headerlink" title="7. 动态原型模式"></a>7. 动态原型模式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> job</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>job <span class="token operator">=</span> job<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sayName <span class="token operator">!=</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'Nike'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'teacher'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>person1<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>动态原型模式将所有信息封装在了构造函数中，而通过构造函数中初始化原型（仅第一个对象实例化时初始化原型），这个可以通过判断该方法是否有效而选择是否需要初始化原型。</p><h3 id="8-寄生构造函数方式"><a href="#8-寄生构造函数方式" class="headerlink" title="8. 寄生构造函数方式"></a>8. 寄生构造函数方式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> job</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    o<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    o<span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    o<span class="token punctuation">.</span>job <span class="token operator">=</span> job<span class="token punctuation">;</span>    o<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> o<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'Nike'</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token string">'teacher'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>寄生模式和工厂模式几乎一样，寄生模式和工厂模式的区别：</p><ul><li>寄生模式创建对象时使用了<code>new</code>关键字</li><li>寄生模式的外部包装函数是一个构造函数</li></ul><blockquote><p><strong>作用</strong>:寄生模式可以在特殊的情况下为对象来创建构造函数,原因在于我们可以通过构造函数重写对象的值，并通过return返回。重写调用构造函数(创建的对象的实例)之后的对象实例的新的值。</p></blockquote><h3 id="9-稳妥构造函数方式"><a href="#9-稳妥构造函数方式" class="headerlink" title="9. 稳妥构造函数方式"></a>9. 稳妥构造函数方式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> job</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    o<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> o<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'Nike'</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token string">'teacher'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用稳妥构造函数模式只能通过其构造函数内部的方法来获取里面的属性值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>道格拉斯·克拉克福德发明了JavaScript中的稳妥对象这个概念。所谓稳妥对象，是指没有公共属性，而且其方法也不引用<code>this</code>对象。稳妥对象最适合在一些安全环境中（这些环境会禁止使用<code>this</code>和<code>new</code>），或者在防止数据被其他应用程序改动时使用。稳妥构造函数遵循的与寄生构造函数类似的模式，但又两点不同：</p><ul><li>一是新创建对象的实例方法不引用<code>this</code>；</li><li>二是不使用<code>new</code>操作符调用构造函数。</li></ul><blockquote><p><strong>注</strong>：与寄生构造函数模式类似，使用稳妥构造函数模式创建的对象与构造函数之间没有什么关系，因此instanceof操作符对这种对象也没有意义。</p></blockquote><h2 id="并发模型和事件循环-event-loop"><a href="#并发模型和事件循环-event-loop" class="headerlink" title="并发模型和事件循环(event loop)"></a>并发模型和事件循环(event loop)</h2><p>JavaScript 的并发模型基于<strong>事件循环</strong>。</p><p><img src="https://statics.sh1a.qingstor.com/2020/11/27/js_event.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2020/11/27/js_event.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="Js堆栈队列图"></p><h3 id="1-运行时概念"><a href="#1-运行时概念" class="headerlink" title="1. 运行时概念"></a>1. 运行时概念</h3><h4 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h4><p>函数调用形成了一个栈帧。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token number">11</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">foo</span><span class="token punctuation">(</span>x <span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当调用 bar 时，创建了第一个帧 ，帧中包含了 bar 的参数和局部变量。当 bar 调用 foo 时，第二个帧就被创建，并被压到第一个帧之上，帧中包含了 foo 的参数和局部变量。当 foo 返回时，最上层的帧就被弹出栈（剩下 bar 函数的调用帧 ）。当 bar 返回的时候，栈就空了。</p><h4 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h4><p>对象被分配在一个堆中，即用以表示一个大部分非结构化的内存区域。</p><h4 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h4><p>一个 JavaScript 运行时包含了一个待处理的消息队列。每一个消息都与一个函数相关联。当栈拥有足够内存时，从队列中取出一个消息进行处理。这个处理过程包含了调用与这个消息相关联的函数（以及因而创建了一个初始堆栈帧）。当栈再次为空的时候，也就意味着消息处理结束。</p><h3 id="2-事件循环"><a href="#2-事件循环" class="headerlink" title="2. 事件循环"></a>2. 事件循环</h3><p>之所以称为<strong>事件循环</strong>，是因为它经常被用于类似如下的方式来实现：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">waitForMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  queue<span class="token punctuation">.</span><span class="token function">processNextMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果当前没有任何消息，queue.waitForMessage 会等待着同步将要到来的消息。</p><p>每一个消息完整的执行后，其它消息才会被执行。这个模型的一个缺点在于当一个消息的完成耗时过长，网络应用无法处理用户的交互如点击或者滚动。浏览器用“程序需要过长时间运行”的对话框来缓解这个问题。一个比较好的解决方案是使消息处理变短且如果可能的话，将一个消息拆分成几个消息。</p><p>在浏览器里，当一个事件出现且有一个事件监听器被绑定时，消息会被随时添加。如果没有事件监听器，事件会丢失。所以点击一个附带点击事件处理函数的元素会添加一个消息。其它事件亦然。</p><h3 id="3-绝不阻塞"><a href="#3-绝不阻塞" class="headerlink" title="3. 绝不阻塞"></a>3. 绝不阻塞</h3><p>事件循环(event loop)模型特性在于它<strong>永不阻塞</strong>。通常由事件或者回调函数进行 I/O (input/output)处理 。</p><hr><p>参考文档：</p><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript">MDN</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之单例模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-dan-li-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-dan-li-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="模式动机"><a href="#模式动机" class="headerlink" title="模式动机"></a>模式动机</h2><p>对于系统中的某些类来说，只有一个实例很重要，例如，一个系统中可以存在多个打印任务，但是只能有一个正在工作的任务；一个系统只能有一个窗口管理器或文件系统；一个系统只能有一个计时工具或ID（序号）生成器。</p><p>如何保证一个类只有一个实例并且这个实例易于被访问呢？定义一个全局变量可以确保对象随时都可以被访问，但不能防止我们实例化多个对象。</p><p>一个更好的解决办法是让类自身负责保存它的唯一实例。这个类可以保证没有其他实例被创建，并且它可以提供一个访问该实例的方法。这就是单例模式的模式动机。</p><h2 id="模式定义"><a href="#模式定义" class="headerlink" title="模式定义"></a>模式定义</h2><blockquote><p><strong>单例模式(<code>Singleton Pattern</code>)<strong>：单例模式确保某一个类只有一个实例，而且自行实例化并向整个系统提供这个实例，这个类称为单例类，它提供全局访问的方法。单例模式是一种</strong>对象创建型模式</strong>。单例模式又名单件模式或单态模式。</p></blockquote><p>单例模式的要点有三个：</p><ul><li>一是某个类只能有一个实例；</li><li>二是它必须自行创建这个实例；</li><li>三是它必须自行向整个系统提供这个实例。</li></ul><h2 id="模式结构"><a href="#模式结构" class="headerlink" title="模式结构"></a>模式结构</h2><h3 id="参与角色"><a href="#参与角色" class="headerlink" title="参与角色"></a>参与角色</h3><ul><li><code>Singleton</code>: 单例</li></ul><h3 id="UML类图"><a href="#UML类图" class="headerlink" title="UML类图"></a>UML类图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/10/29/Java-design-singleton-uml.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/10/29/Java-design-singleton-uml.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="单例模式UML类图"></p><h3 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/10/29/Java-design-singleton-seq.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/10/29/Java-design-singleton-seq.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="单例模式时序图"></p><h2 id="代码实现方式"><a href="#代码实现方式" class="headerlink" title="代码实现方式"></a>代码实现方式</h2><h3 id="1-饿汉式（推荐使用）"><a href="#1-饿汉式（推荐使用）" class="headerlink" title="1. 饿汉式（推荐使用）"></a>1. 饿汉式（推荐使用）</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 饿汉式单例模式. * * @author blinkfox on 2017-10-23. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** 全局唯一实例. */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Singleton</span> singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong>：这种方式避免了多线程的同步问题，但不是懒加载。如果不需要懒加载的方式，推荐使用。</p></blockquote><h3 id="2-非线程安全懒汉式（不推荐使用）"><a href="#2-非线程安全懒汉式（不推荐使用）" class="headerlink" title="2. 非线程安全懒汉式（不推荐使用）"></a>2. 非线程安全懒汉式（不推荐使用）</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 非线程安全的懒汉式. * * @author blinkfox on 2017-10-23. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> singleton<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 通过懒加载的方式获取实例，但是非线程安全.     * @return Singleton实例     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong>：是懒加载的方式，但非线程安全。不推荐使用。</p></blockquote><h3 id="3-低效的线程安全懒汉式（不推荐使用）"><a href="#3-低效的线程安全懒汉式（不推荐使用）" class="headerlink" title="3. 低效的线程安全懒汉式（不推荐使用）"></a>3. 低效的线程安全懒汉式（不推荐使用）</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 低效的线程安全的懒汉式. * * @author blinkfox on 2017-10-23. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> singleton<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 通过 synchronized 关键字来保证线程安全，也是懒加载的方式来获取实例.     * @return Singleton实例     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token class-name">Singleton</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong>：是懒加载的方式，也线程安全，但是效率很低。因为99%的情况下是不需要去同步的。不推荐使用。</p></blockquote><h3 id="4-双重校验锁线程安全懒汉式（不推荐使用）"><a href="#4-双重校验锁线程安全懒汉式（不推荐使用）" class="headerlink" title="4. 双重校验锁线程安全懒汉式（不推荐使用）"></a>4. 双重校验锁线程安全懒汉式（不推荐使用）</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 双重校验锁线程安全懒汉式. * * @author blinkfox on 2017-10-23. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> singleton<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 通过'双重校验锁'来更高效的保证线程安全，也是懒加载的方式来获取实例.     * @return Singleton实例     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong>：是懒加载的方式，也线程安全，效率也不错。但受限于Jdk5以前的Java内存模型，仍然会有bug，Java5及之后才能正常达到单例效果。</p></blockquote><h3 id="5-枚举式（强烈推荐使用）"><a href="#5-枚举式（强烈推荐使用）" class="headerlink" title="5. 枚举式（强烈推荐使用）"></a>5. 枚举式（强烈推荐使用）</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 枚举方式的单例. * * @author blinkfox on 2017-10-23. */</span><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>    INSTANCE<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong>：在<code>《Effective Java》</code>一书中强烈推荐使用枚举来实现单例模式，该方式简单可自由序列化；保证只有一个实例（即使使用反射机制也无法多次实例化一个枚举量）；线程安全。唯一的缺点是非懒加载方式。</p></blockquote><h3 id="6-静态内部类（推荐使用）"><a href="#6-静态内部类（推荐使用）" class="headerlink" title="6. 静态内部类（推荐使用）"></a>6. 静态内部类（推荐使用）</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 通过使用静态内部类的方式来实现懒加载且线程安全的创建单例. * * @author blinkfox on 2017-10-23. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 静态内部类.     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SingletonHolder</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">private</span> <span class="token class-name">SingletonHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton4</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 通过懒加载的方式获取Singleton唯一实例的方法.     * @return Singleton实例     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">SingletonHolder</span><span class="token punctuation">.</span>instance<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong>：这种方式利用了<code>ClassLoader</code>的机制保证初始化<code>instance</code>时只有一个线程，其只有显示通过调用<code>getInstance</code>方法时，才会显示装载<code>SingletonHolder</code>类，从而实例化<code>instance</code>。</p></blockquote><h2 id="模式分析"><a href="#模式分析" class="headerlink" title="模式分析"></a>模式分析</h2><p>单例模式的目的是保证一个类仅有一个实例，并提供一个访问它的全局访问点。单例模式包含的角色只有一个，就是单例类——<code>Singleton</code>。</p><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul><li>提供了对唯一实例的受控访问。因为单例类封装了它的唯一实例，所以它可以严格控制客户怎样以及何时访问它，并为设计及开发团队提供了共享的概念。</li><li>由于在系统内存中只存在一个对象，因此可以节约系统资源，对于一些需要频繁创建和销毁的对象，单例模式无疑可以提高系统的性能。</li><li>允许可变数目的实例。我们可以基于单例模式进行扩展，使用与单例控制相似的方法来获得指定个数的对象实例。</li></ul><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul><li>由于单例模式中没有抽象层，因此单例类的扩展有很大的困难。</li><li>单例类的职责过重，在一定程度上违背了“单一职责原则”。因为单例类既充当了工厂角色，提供了工厂方法，同时又充当了产品角色，包含一些业务方法，将产品的创建和产品的本身的功能融合到一起。</li><li>滥用单例将带来一些负面问题，如为了节省资源将数据库连接池对象设计为单例类，可能会导致共享连接池对象的程序过多而出现连接池溢出；现在很多面向对象语言(如<code>Java</code>、<code>C#</code>)的运行环境都提供了自动垃圾回收的技术，因此，如果实例化的对象长时间不被利用，系统会认为它是垃圾，会自动销毁并回收资源，下次利用时又将重新实例化，这将导致对象状态的丢失。</li></ul><h3 id="适用环境"><a href="#适用环境" class="headerlink" title="适用环境"></a>适用环境</h3><p>在以下情况下可以使用单例模式：</p><ul><li>系统只需要一个实例对象，如系统要求提供一个唯一的序列号生成器，或者需要考虑资源消耗太大而只允许创建一个对象。</li><li>客户调用类的单个实例只允许使用一个公共访问点，除了该公共访问点，不能通过其他途径访问该实例。</li><li>在一个系统中要求一个类只有一个实例时才应当使用单例模式。反过来，如果一个类可以有几个实例共存，就需要对单例模式进行改进，使之成为多例模式。</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>单例模式确保某一个类只有一个实例，而且自行实例化并向整个系统提供这个实例，这个类称为单例类，它提供全局访问的方法。单例模式的要点有三个：一是某个类只能有一个实例；二是它必须自行创建这个实例；三是它必须自行向整个系统提供这个实例。单例模式是一种对象创建型模式。</li><li>单例模式只包含一个单例角色：在单例类的内部实现只生成一个实例，同时它提供一个静态的工厂方法，让客户可以使用它的唯一实例；为了防止在外部对其实例化，将其构造函数设计为私有。</li><li>实现单例模式，如果不需要懒加载的效果，则推荐使用枚举和饿汉式的方式；如果需要懒加载的效果，则推荐使用静态内部类来实现更好。</li><li>单例模式的主要优点在于提供了对唯一实例的受控访问并可以节约系统资源；其主要缺点在于因为缺少抽象层而难以扩展，且单例类职责过重。</li><li>单例模式适用情况包括：系统只需要一个实例对象；客户调用类的单个实例只允许使用一个公共访问点。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>面向对象编程的理解</title>
      <link href="/post/bian-cheng-zhi-dao/mian-xiang-dui-xiang-bian-cheng-de-li-jie/"/>
      <url>/post/bian-cheng-zhi-dao/mian-xiang-dui-xiang-bian-cheng-de-li-jie/</url>
      
        <content type="html"><![CDATA[<h2 id="面向过程和面向对象"><a href="#面向过程和面向对象" class="headerlink" title="面向过程和面向对象"></a>面向过程和面向对象</h2><h3 id="面向过程思想概述"><a href="#面向过程思想概述" class="headerlink" title="面向过程思想概述"></a>面向过程思想概述</h3><p>面向着具体的每一个步骤和过程，把每一个步骤和过程完成，然后由这些功能方法相互调用，完成需求。</p><h3 id="面向对象思想概述"><a href="#面向对象思想概述" class="headerlink" title="面向对象思想概述"></a>面向对象思想概述</h3><p>当需求单一，或者简单时，我们一步一步去操作没问题，并且效率也挺高。可随着需求的更改，功能的增多，发现需要面对每一个步骤很麻烦了，这时就开始思索，能不能把这些步骤和功能在进行封装，封装时根据不同的功能，进行不同的封装，功能类似的封装在一起。这样结构就清晰了很多。用的时候，找到对应的类就可以了。这就是面向对象的思想。面向对象是基于面向过程的编程思想。</p><h2 id="面向对象特征"><a href="#面向对象特征" class="headerlink" title="面向对象特征"></a>面向对象特征</h2><ul><li>抽象</li><li>封装</li><li>继承</li><li>多态</li></ul><h3 id="抽象"><a href="#抽象" class="headerlink" title="抽象"></a>抽象</h3><p>把现实世界中的某一类东西，提取出来，用程序代码表示，抽象出来的一般叫做类或者接口。抽象并不打算了解全部问题，而是选择其中的一部分，暂时不用部分细节。抽象包括两个方面：</p><ul><li>数据抽象：表示世界中一类事物的特征,就是对象的属性.比如鸟有翅膀,羽毛等(类的属性)</li><li>过程抽象：表示世界中一类事物的行为,就是对象的行为.比如鸟会飞,会叫(类的方法)</li></ul><h3 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h3><p>封装，即隐藏对象的属性和实现细节，仅对外公开接口，控制在程序中属性的读和修改的访问级别；将抽象得到的数据和行为（或功能）相结合，形成一个有机的整体，也就是将数据与操作数据的源代码进行有机的结合，形成“类”，其中数据和函数都是类的成员。封装的目的是增强安全性和简化编程，使用者不必了解具体的实现细节，而只是要通过外部接口，以特定的访问权限来使用类的成员。隐藏之后，外部程序就不能接触和改变那些细节，所以不用担心自己的类会受到非法修改，可确保它们不会对其他程序造成影响。</p><h4 id="封装的原则"><a href="#封装的原则" class="headerlink" title="封装的原则"></a>封装的原则</h4><ul><li>将不需要对外提供的内容都隐藏起来</li><li>把属性都隐藏，提供公共方法对其访问</li></ul><h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>一种联结类的层次模型，并且允许和鼓励类的重用，提供一种明确表达共性的方法。对象的一个新类可以从现有的类中派生，这个过程称为类继承。新类继承了原始类的特性，新类称为原始类的派生类(子类)，原始类称为新类的基类(父类)。派生类可以从它的父类哪里继承方法和实例变量，并且类可以修改或增加新的方法使之更适合特殊的需要。因此可以说，继承为了重用父类代码，同时为实现多态性作准备。</p><h4 id="继承概念的实现方式"><a href="#继承概念的实现方式" class="headerlink" title="继承概念的实现方式"></a>继承概念的实现方式</h4><ul><li>类继承：类继承是指直接使用基类的属性和方法而无需额外编码。</li><li>接口继承：接口继承是指仅使用属性和方法的名称、但是子类必须提供实现。</li></ul><h3 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h3><p>多态就是指一个类实例的相同方法在不同情形有不同表现形式。多态机制使具有不同内部结构的对象可以共享相同的外部接口。这意味着，虽然针对不同对象的具体操作不同，但通过一个公共的类，它们（那些操作）可以通过相同的方式予以调用。</p><h4 id="实现多态的方式"><a href="#实现多态的方式" class="headerlink" title="实现多态的方式"></a>实现多态的方式</h4><ul><li>重载</li><li>重写</li><li>实现接口</li></ul><h2 id="面向对象总结"><a href="#面向对象总结" class="headerlink" title="面向对象总结"></a>面向对象总结</h2><p>封装可以隐藏实现细节，使得代码模块化；继承可以扩展已存在的代码模块（类）；它们的目的都是为了<strong>代码重用</strong>。而多态则是为了实现另一个目的：<strong>接口重用</strong>！多态的作用，就是为了类在继承和派生的时候，保证使用“家谱”中任一类的实例的某一属性时的正确调用。</p><h3 id="面向对象开发"><a href="#面向对象开发" class="headerlink" title="面向对象开发"></a>面向对象开发</h3><p>就是不断的创建对象，使用对象，指挥对象做事情。</p><h3 id="面向对象设计"><a href="#面向对象设计" class="headerlink" title="面向对象设计"></a>面向对象设计</h3><p>更好的管理和维护对象之间的关系。</p><h3 id="面向对象优点"><a href="#面向对象优点" class="headerlink" title="面向对象优点"></a>面向对象优点</h3><ul><li>更符合我们思想习惯的思想</li><li>将复杂的事情简单化</li><li>将我们从执行者变成了指挥者</li></ul>]]></content>
      
      
      <categories>
          
          <category> 编程之道 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 面向对象编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之建造者模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-jian-zao-zhe-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-jian-zao-zhe-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、模式动机"><a href="#一、模式动机" class="headerlink" title="一、模式动机"></a>一、模式动机</h2><p>无论是在现实世界中还是在软件系统中，都存在一些复杂的对象，它们拥有多个组成部分，如汽车，它包括车轮、方向盘、发动机等各种部件。而对于大多数用户而言，无须知道这些部件的装配细节，也几乎不会使用单独某个部件，而是使用一辆完整的汽车，可以通过建造者模式对其进行设计与描述，建造者模式可以将部件和其组装过程分开，一步一步创建一个复杂的对象。用户只需要指定复杂对象的类型就可以得到该对象，而无须知道其内部的具体构造细节。</p><p>在软件开发中，也存在大量类似汽车一样的复杂对象，它们拥有一系列成员属性，这些成员属性中有些是引用类型的成员对象。而且在这些复杂对象中，还可能存在一些限制条件，如某些属性没有赋值则复杂对象不能作为一个完整的产品使用；有些属性的赋值必须按照某个顺序，一个属性没有赋值之前，另一个属性可能无法赋值等。</p><p>复杂对象相当于一辆有待建造的汽车，而对象的属性相当于汽车的部件，建造产品的过程就相当于组合部件的过程。由于组合部件的过程很复杂，因此，这些部件的组合过程往往被“外部化”到一个称作建造者的对象里，建造者返还给客户端的是一个已经建造完毕的完整产品对象，而用户无须关心该对象所包含的属性以及它们的组装方式，这就是建造者模式的模式动机。</p><h2 id="二、模式定义"><a href="#二、模式定义" class="headerlink" title="二、模式定义"></a>二、模式定义</h2><blockquote><p>造者模式(<code>Builder Pattern</code>)：将一个复杂对象的构建与它的表示分离，使得同样的构建过程可以创建不同的表示。建造者模式属于<strong>对象创建型模式</strong>。建造者模式又可以称为<strong>生成器模式</strong>。</p></blockquote><p>建造者模式是一步一步创建一个复杂的对象，它允许用户只通过指定复杂对象的类型和内容就可以构建它们，用户不需要知道内部的具体构建细节。</p><h2 id="三、模式结构"><a href="#三、模式结构" class="headerlink" title="三、模式结构"></a>三、模式结构</h2><h3 id="1-角色组成"><a href="#1-角色组成" class="headerlink" title="1. 角色组成"></a>1. 角色组成</h3><p>建造者模式包含如下角色：</p><ul><li><code>Builder</code>：抽象建造者</li><li><code>ConcreteBuilder</code>：具体建造者</li><li><code>Director</code>：导演者</li><li><code>Product</code>：产品角色</li></ul><h3 id="2-结构图"><a href="#2-结构图" class="headerlink" title="2. 结构图"></a>2. 结构图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/10/20/builder-structure.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/10/20/builder-structure.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="建造者模式结构图"></p><h2 id="四、示例代码"><a href="#四、示例代码" class="headerlink" title="四、示例代码"></a>四、示例代码</h2><p>首先，是产品类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 产品类. * * Created by blinkfox on 2016/10/8. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> part1<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> part2<span class="token punctuation">;</span>    <span class="token comment">/* getter 和 setter方法. */</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPart1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> part1<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPart1</span><span class="token punctuation">(</span><span class="token class-name">String</span> part1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>part1 <span class="token operator">=</span> part1<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPart2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> part2<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPart2</span><span class="token punctuation">(</span><span class="token class-name">String</span> part2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>part2 <span class="token operator">=</span> part2<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其实，是抽象的建造者<code>Builder</code>接口和具体的建造者<code>ConcreteBuilder</code>类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 抽象的建造者. * * Created by blinkfox on 2016/10/8. */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Builder</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 产品建造部分1.     */</span>    <span class="token keyword">void</span> <span class="token function">buildPart1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 产品建造部分2.     */</span>    <span class="token keyword">void</span> <span class="token function">buildPart2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 得到建造的产品.     *     * @return 产品     */</span>    <span class="token class-name">Product</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的建造者实现类. * * Created by blinkfox on 2016/10/8. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteBuilder</span> <span class="token keyword">implements</span> <span class="token class-name">Builder</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** 产品. */</span>    <span class="token keyword">private</span> <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 产品建造部分1.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">buildPart1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        product<span class="token punctuation">.</span><span class="token function">setPart1</span><span class="token punctuation">(</span><span class="token string">"编号：95757"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 产品建造部分2.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">buildPart2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        product<span class="token punctuation">.</span><span class="token function">setPart2</span><span class="token punctuation">(</span><span class="token string">"名称：小机器人"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 得到建造的产品.     *     * @return 产品     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> product<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后，导演者<code>Director</code>类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 导演者类. * * Created by blinkfox on 2016/10/8. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Director</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** 当前需要的建造者对象. */</span>    <span class="token keyword">private</span> <span class="token class-name">Builder</span> builder<span class="token punctuation">;</span>    <span class="token comment">/**     * 构造方法.     *     * @param builder     */</span>    <span class="token keyword">public</span> <span class="token class-name">Director</span><span class="token punctuation">(</span><span class="token class-name">Builder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>builder <span class="token operator">=</span> builder<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 产品构造方法，负责调用各个零件建造方法.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        builder<span class="token punctuation">.</span><span class="token function">buildPart1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        builder<span class="token punctuation">.</span><span class="token function">buildPart2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以下是建造者模式的客户端场景类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 建造者模式的客户端场景类. * * Created by blinkfox on 2016/10/8. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BuilderClient</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 主入口方法.     *     * @param args 数组参数     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Builder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Director</span> director <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Director</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>        director<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Product</span> product <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>product<span class="token punctuation">.</span><span class="token function">getPart1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>product<span class="token punctuation">.</span><span class="token function">getPart2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="五、模式分析"><a href="#五、模式分析" class="headerlink" title="五、模式分析"></a>五、模式分析</h2><p>抽象建造者类中定义了产品的创建方法和返回方法;</p><p>建造者模式的结构中还引入了一个导演者类<code>Director</code>，该类的作用主要有两个：一方面它隔离了客户与生产过程；另一方面它负责控制产品的生成过程。导演者针对抽象建造者编程，客户端只需要知道具体建造者的类型，即可通过导演者类调用建造者的相关方法，返回一个完整的产品对象</p><p>在客户端代码中，无须关心产品对象的具体组装过程，只需确定具体建造者的类型即可，建造者模式将复杂对象的构建与对象的表现分离开来，这样使得同样的构建过程可以创建出不同的表现。</p><h3 id="1-优点"><a href="#1-优点" class="headerlink" title="1. 优点"></a>1. 优点</h3><p>建造者模式的优点：</p><ul><li>在建造者模式中， 客户端不必知道产品内部组成的细节，将产品本身与产品的创建过程解耦，使得相同的创建过程可以创建不同的产品对象。</li><li>每一个具体建造者都相对独立，而与其他的具体建造者无关，因此可以很方便地替换具体建造者或增加新的具体建造者， 用户使用不同的具体建造者即可得到不同的产品对象 。</li><li>可以更加精细地控制产品的创建过程 。将复杂产品的创建步骤分解在不同的方法中，使得创建过程更加清晰，也更方便使用程序来控制创建过程。</li><li>增加新的具体建造者无须修改原有类库的代码，指挥者类针对抽象建造者类编程，系统扩展方便，符合“开闭原则”。</li></ul><h3 id="2-缺点"><a href="#2-缺点" class="headerlink" title="2. 缺点"></a>2. 缺点</h3><p>建造者模式的缺点：</p><ul><li>建造者模式所创建的产品一般具有较多的共同点，其组成部分相似，如果产品之间的差异性很大，则不适合使用建造者模式，因此其使用范围受到一定的限制。</li><li>如果产品的内部变化复杂，可能会导致需要定义很多具体建造者类来实现这种变化，导致系统变得很庞大。</li></ul><h3 id="3-适用环境"><a href="#3-适用环境" class="headerlink" title="3. 适用环境"></a>3. 适用环境</h3><p>在以下情况下可以使用建造者模式：</p><ul><li>需要生成的产品对象有复杂的内部结构，这些产品对象通常包含多个成员属性。</li><li>需要生成的产品对象的属性相互依赖，需要指定其生成顺序。</li><li>对象的创建过程独立于创建该对象的类。在建造者模式中引入了指挥者类，将创建过程封装在指挥者类中，而不在建造者类中。</li><li>隔离复杂对象的创建和使用，并使得相同的创建过程可以创建不同的产品。</li></ul><h3 id="4-建造者模式与抽象工厂模式的比较"><a href="#4-建造者模式与抽象工厂模式的比较" class="headerlink" title="4. 建造者模式与抽象工厂模式的比较"></a>4. 建造者模式与抽象工厂模式的比较</h3><ul><li>与抽象工厂模式相比，建造者模式返回一个组装好的完整产品，而抽象工厂模式返回一系列相关的产品，这些产品位于不同的产品等级结构，构成了一个产品族。</li><li>在抽象工厂模式中，客户端实例化工厂类，然后调用工厂方法获取所需产品对象，而在建造者模式中，客户端可以不直接调用建造者的相关方法，而是通过指挥者类来指导如何生成对象，包括对象的组装过程和建造步骤，它侧重于一步步构造一个复杂对象，返回一个完整的对象。</li><li>如果将抽象工厂模式看成汽车配件生产工厂，生产一个产品族的产品，那么建造者模式就是一个汽车组装工厂，通过对部件的组装可以返回一辆完整的汽车。</li></ul><h2 id="六、模式总结"><a href="#六、模式总结" class="headerlink" title="六、模式总结"></a>六、模式总结</h2><ul><li>建造者模式将一个复杂对象的构建与它的表示分离，使得同样的构建过程可以创建不同的表示。建造者模式是一步一步创建一个复杂的对象，它允许用户只通过指定复杂对象的类型和内容就可以构建它们，用户不需要知道内部的具体构建细节。建造者模式属于对象创建型模式。</li><li>建造者模式包含如下四个角色：抽象建造者为创建一个产品对象的各个部件指定抽象接口；具体建造者实现了抽象建造者接口，实现各个部件的构造和装配方法，定义并明确它所创建的复杂对象，也可以提供一个方法返回创建好的复杂产品对象；产品角色是被构建的复杂对象，包含多个组成部件；指挥者负责安排复杂对象的建造次序，指挥者与抽象建造者之间存在关联关系，可以在其<code>construct()</code>建造方法中调用建造者对象的部件构造与装配方法，完成复杂对象的建造</li><li>在建造者模式的结构中引入了一个导演者类，该类的作用主要有两个：一方面它隔离了客户与生产过程；另一方面它负责控制产品的生成过程。指挥者针对抽象建造者编程，客户端只需要知道具体建造者的类型，即可通过指挥者类调用建造者的相关方法，返回一个完整的产品对象。</li><li>建造者模式的主要优点在于客户端不必知道产品内部组成的细节，将产品本身与产品的创建过程解耦，使得相同的创建过程可以创建不同的产品对象，每一个具体建造者都相对独立，而与其他的具体建造者无关，因此可以很方便地替换具体建造者或增加新的具体建造者，符合“开闭原则”，还可以更加精细地控制产品的创建过程；其主要缺点在于由于建造者模式所创建的产品一般具有较多的共同点，其组成部分相似，因此其使用范围受到一定的限制，如果产品的内部变化复杂，可能会导致需要定义很多具体建造者类来实现这种变化，导致系统变得很庞大。</li><li>建造者模式适用情况包括：需要生成的产品对象有复杂的内部结构，这些产品对象通常包含多个成员属性；需要生成的产品对象的属性相互依赖，需要指定其生成顺序；对象的创建过程独立于创建该对象的类；隔离复杂对象的创建和使用，并使得相同的创建过程可以创建不同类型的产品。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之外观模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-wai-guan-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-wai-guan-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、模式定义"><a href="#一、模式定义" class="headerlink" title="一、模式定义"></a>一、模式定义</h2><blockquote><p><strong>外观模式</strong>(<code>Facade Pattern</code>)：外部与一个子系统的通信必须通过一个统一的外观对象进行，为子系统中的一组接口提供一个一致的界面，外观模式定义了一个高层接口，这个接口使得这一子系统更加容易使用。外观模式又称为<strong>门面模式</strong>，它是一种对象结构型模式。</p></blockquote><h2 id="二、模式结构"><a href="#二、模式结构" class="headerlink" title="二、模式结构"></a>二、模式结构</h2><h3 id="1-角色组成"><a href="#1-角色组成" class="headerlink" title="1. 角色组成"></a>1. 角色组成</h3><p>外观模式包含如下角色：</p><ul><li><code>Facade</code>: 外观角色</li><li><code>SubSystem</code>: 子系统角色</li></ul><h3 id="2-结构图"><a href="#2-结构图" class="headerlink" title="2. 结构图"></a>2. 结构图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/10/18/facade-structure.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/10/18/facade-structure.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="命令模式结构图"></p><h2 id="三、示例代码"><a href="#三、示例代码" class="headerlink" title="三、示例代码"></a>三、示例代码</h2><p>首先，是各个子系统角色类，分别如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 子系统类A. * * Created by blinkfox on 16/8/25. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassA</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomethingA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----业务方法A..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 子系统类B. * * Created by blinkfox on 16/8/25. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassB</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomethingB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----业务方法B..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 子系统类C. * * Created by blinkfox on 16/8/25. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassC</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomethingC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----业务方法C..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以下是外观模式的外观类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 外观门面类. * * Created by blinkfox on 16/8/25. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Facade</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">ClassA</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">ClassB</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">ClassC</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 以下是提供给外部访问的方法.</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">.</span><span class="token function">doSomethingA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>b<span class="token punctuation">.</span><span class="token function">doSomethingB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token function">doSomethingC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="四、模式分析"><a href="#四、模式分析" class="headerlink" title="四、模式分析"></a>四、模式分析</h2><p>根据“单一职责原则”，在软件中将一个系统划分为若干个子系统有利于降低整个系统的复杂性，一个常见的设计目标是使子系统间的通信和相互依赖关系达到最小，而达到该目标的途径之一就是引入一个外观对象，它为子系统的访问提供了一个简单而单一的入口。 外观模式也是“<strong>迪米特法则</strong>”的体现，通过引入一个新的外观类可以降低原有系统的复杂度，同时降低客户类与子系统类的耦合度。</p><ul><li>外观模式要求一个子系统的外部与其内部的通信通过一个统一的外观对象进行，外观类将客户端与子系统的内部复杂性分隔开，使得客户端只需要与外观对象打交道，而不需要与子系统内部的很多对象打交道。</li><li>外观模式的目的在于降低系统的复杂程度。</li><li>外观模式从很大程度上提高了客户端使用的便捷性，使得客户端无须关心子系统的工作细节，通过外观角色即可调用相关功能。</li></ul><h3 id="1-优点"><a href="#1-优点" class="headerlink" title="1. 优点"></a>1. 优点</h3><p>外观模式的优点k：</p><ul><li>对客户屏蔽子系统组件，减少了客户处理的对象数目并使得子系统使用起来更加容易。通过引入外观模式，客户代码将变得很简单，与之关联的对象也很少。</li><li>实现了子系统与客户之间的松耦合关系，这使得子系统的组件变化不会影响到调用它的客户类，只需要调整外观类即可。</li><li>降低了大型软件系统中的编译依赖性，并简化了系统在不同平台之间的移植过程，因为编译一个子系统一般不需要编译所有其他的子系统。一个子系统的修改对其他子系统没有任何影响，而且子系统内部变化也不会影响到外观对象。</li><li>只是提供了一个访问子系统的统一入口，并不影响用户直接使用子系统类。</li></ul><h3 id="2-缺点"><a href="#2-缺点" class="headerlink" title="2. 缺点"></a>2. 缺点</h3><p>外观模式的缺点：</p><ul><li>不能很好地限制客户使用子系统类，如果对客户访问子系统类做太多的限制则减少了可变性和灵活性。</li><li>在不引入抽象外观类的情况下，增加新的子系统可能需要修改外观类或客户端的源代码，违背了“<strong>开闭原则</strong>”。</li></ul><h3 id="3-适用环境"><a href="#3-适用环境" class="headerlink" title="3. 适用环境"></a>3. 适用环境</h3><p>在以下情况下可以使用外观模式：</p><ul><li>当要为一个复杂子系统提供一个简单接口时可以使用外观模式。该接口可以满足大多数用户的需求，而且用户也可以越过外观类直接访问子系统。</li><li>客户程序与多个子系统之间存在很大的依赖性。引入外观类将子系统与客户以及其他子系统解耦，可以提高子系统的独立性和可移植性。</li><li>在层次化结构中，可以使用外观模式定义系统中每一层的入口，层与层之间不直接产生联系，而通过外观类建立联系，降低层之间的耦合度。</li></ul><h2 id="五、模式总结"><a href="#五、模式总结" class="headerlink" title="五、模式总结"></a>五、模式总结</h2><ul><li>在外观模式中，外部与一个子系统的通信必须通过一个统一的外观对象进行，为子系统中的一组接口提供一个一致的界面，外观模式定义了一个高层接口，这个接口使得这一子系统更加容易使用。外观模式又称为门面模式，它是一种对象结构型模式。</li><li>外观模式包含两个角色：外观角色是在客户端直接调用的角色，在外观角色中可以知道相关的(一个或者多个)子系统的功能和责任，它将所有从客户端发来的请求委派到相应的子系统去，传递给相应的子系统对象处理；在软件系统中可以同时有一个或者多个子系统角色，每一个子系统可以不是一个单独的类，而是一个类的集合，它实现子系统的功能。</li><li>外观模式要求一个子系统的外部与其内部的通信通过一个统一的外观对象进行，外观类将客户端与子系统的内部复杂性分隔开，使得客户端只需要与外观对象打交道，而不需要与子系统内部的很多对象打交道。</li><li>外观模式主要优点在于对客户屏蔽子系统组件，减少了客户处理的对象数目并使得子系统使用起来更加容易，它实现了子系统与客户之间的松耦合关系，并降低了大型软件系统中的编译依赖性，简化了系统在不同平台之间的移植过程；其缺点在于不能很好地限制客户使用子系统类，而且在不引入抽象外观类的情况下，增加新的子系统可能需要修改外观类或客户端的源代码，违背了“开闭原则”。</li><li>外观模式适用情况包括：要为一个复杂子系统提供一个简单接口；客户程序与多个子系统之间存在很大的依赖性；在层次化结构中，需要定义系统中每一层的入口，使得层与层之间不直接产生联系。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之中介者模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-zhong-jie-zhe-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-zhong-jie-zhe-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、模式动机"><a href="#一、模式动机" class="headerlink" title="一、模式动机"></a>一、模式动机</h2><p>在用户与用户直接聊天的设计方案中，用户对象之间存在很强的关联性，将导致系统出现如下问题：</p><ul><li>系统结构复杂：对象之间存在大量的相互关联和调用，若有一个对象发生变化，则需要跟踪和该对象关联的其他所有对象，并进行适当处理。</li><li>对象可重用性差：由于一个对象和其他对象具有很强的关联，若没有其他对象的支持，一个对象很难被另一个系统或模块重用，这些对象表现出来更像一个不可分割的整体，职责较为混乱。</li><li>系统扩展性低：增加一个新的对象需要在原有相关对象上增加引用，增加新的引用关系也需要调整原有对象，系统耦合度很高，对象操作很不灵活，扩展性差。</li><li>在面向对象的软件设计与开发过程中，根据“单一职责原则”，我们应该尽量将对象细化，使其只负责或呈现单一的职责。</li><li>对于一个模块，可能由很多对象构成，而且这些对象之间可能存在相互的引用，为了减少对象两两之间复杂的引用关系，使之成为一个松耦合的系统，我们需要使用中介者模式，这就是中介者模式的模式动机。</li></ul><h2 id="二、模式定义"><a href="#二、模式定义" class="headerlink" title="二、模式定义"></a>二、模式定义</h2><blockquote><p><strong>中介者模式(<code>Mediator Pattern</code>)<strong>：用一个中介对象来封装一系列的对象交互，中介者使各对象不需要显式地相互引用，从而使其耦合松散，而且可以独立地改变它们之间的交互。中介者模式又称为</strong>调停者模式</strong>，它是一种对象行为型模式。</p></blockquote><h2 id="三、模式结构"><a href="#三、模式结构" class="headerlink" title="三、模式结构"></a>三、模式结构</h2><h3 id="1-角色组成"><a href="#1-角色组成" class="headerlink" title="1. 角色组成"></a>1. 角色组成</h3><p>中介者模式包含如下角色：</p><ul><li><code>Mediator</code>: 抽象中介者</li><li><code>ConcreteMediator</code>: 具体中介者</li><li><code>Colleague</code>: 抽象同事类</li><li><code>ConcreteColleague</code>: 具体同事类</li></ul><h3 id="2-结构图"><a href="#2-结构图" class="headerlink" title="2. 结构图"></a>2. 结构图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/10/17/mediator.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/10/17/mediator.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="命令模式结构图"></p><h2 id="四、示例代码"><a href="#四、示例代码" class="headerlink" title="四、示例代码"></a>四、示例代码</h2><p>首先，是抽象的<code>Mediator</code>类和具体的<code>ConcreteMediator</code>类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 通用抽象中介者类. * * Created by blinkfox on 16/8/21. */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Mediator</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** 定义同事类1. */</span>    <span class="token keyword">protected</span> <span class="token class-name">ConcreteColleague1</span> colleague1<span class="token punctuation">;</span>    <span class="token comment">/** 定义同事类2. */</span>    <span class="token keyword">protected</span> <span class="token class-name">ConcreteColleague2</span> colleague2<span class="token punctuation">;</span>    <span class="token comment">/* getter 和 setter 方法 */</span>    <span class="token keyword">public</span> <span class="token class-name">ConcreteColleague1</span> <span class="token function">getColleague1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> colleague1<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setColleague1</span><span class="token punctuation">(</span><span class="token class-name">ConcreteColleague1</span> colleague1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>colleague1 <span class="token operator">=</span> colleague1<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">ConcreteColleague2</span> <span class="token function">getColleague2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> colleague2<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setColleague2</span><span class="token punctuation">(</span><span class="token class-name">ConcreteColleague2</span> colleague2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>colleague2 <span class="token operator">=</span> colleague2<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 中介者模式的抽象业务逻辑1.     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">doSomething1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 中介者模式的抽象业务逻辑2.     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">doSomething2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的通用中介者类. * * Created by blinkfox on 16/8/21. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteMediator</span> <span class="token keyword">extends</span> <span class="token class-name">Mediator</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 中介者模式的具体业务逻辑1.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span>colleague1<span class="token punctuation">.</span><span class="token function">selfMethod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span>colleague2<span class="token punctuation">.</span><span class="token function">selfMethod2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 中介者模式的具体业务逻辑2.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span>colleague1<span class="token punctuation">.</span><span class="token function">selfMethod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span>colleague2<span class="token punctuation">.</span><span class="token function">selfMethod2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其实，是抽象的<code>Colleague</code>类和具体的<code>ConcreteColleague</code>类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 抽象的同事类. * * Created by blinkfox on 16/8/21. */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Colleague</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** 中介者. */</span>    <span class="token keyword">protected</span> <span class="token class-name">Mediator</span> mediator<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Colleague</span><span class="token punctuation">(</span><span class="token class-name">Mediator</span> mediator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>mediator <span class="token operator">=</span> mediator<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的同事类1. * * Created by blinkfox on 16/8/21. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteColleague1</span> <span class="token keyword">extends</span> <span class="token class-name">Colleague</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">ConcreteColleague1</span><span class="token punctuation">(</span><span class="token class-name">Mediator</span> mediator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>mediator<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 自有方法.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selfMethod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------ConcreteColleague1-处理自己的业务逻辑1--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 依赖方法.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">depMethod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------ConcreteColleague1-委托给中介者的业务逻辑1--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span>mediator<span class="token punctuation">.</span><span class="token function">doSomething1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的同事类2. * * Created by blinkfox on 16/8/21. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteColleague2</span> <span class="token keyword">extends</span> <span class="token class-name">Colleague</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">ConcreteColleague2</span><span class="token punctuation">(</span><span class="token class-name">Mediator</span> mediator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>mediator<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 自有方法2.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selfMethod2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------ConcreteColleague2-处理自己的业务逻辑2--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 依赖方法2.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">depMethod2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------ConcreteColleague2-委托给中介者的业务逻辑2--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span>mediator<span class="token punctuation">.</span><span class="token function">doSomething2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以下是中介者模式的客户端场景类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 中介者模式的场景类 * Created by blinkfox on 16/8/21. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediatorClient</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Mediator</span> mediator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteMediator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ConcreteColleague1</span> colleague1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteColleague1</span><span class="token punctuation">(</span>mediator<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ConcreteColleague2</span> colleague2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteColleague2</span><span class="token punctuation">(</span>mediator<span class="token punctuation">)</span><span class="token punctuation">;</span>        mediator<span class="token punctuation">.</span><span class="token function">setColleague1</span><span class="token punctuation">(</span>colleague1<span class="token punctuation">)</span><span class="token punctuation">;</span>        mediator<span class="token punctuation">.</span><span class="token function">setColleague2</span><span class="token punctuation">(</span>colleague2<span class="token punctuation">)</span><span class="token punctuation">;</span>        colleague1<span class="token punctuation">.</span><span class="token function">depMethod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        colleague2<span class="token punctuation">.</span><span class="token function">depMethod2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mediator<span class="token punctuation">.</span><span class="token function">doSomething1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mediator<span class="token punctuation">.</span><span class="token function">doSomething2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="五、模式分析"><a href="#五、模式分析" class="headerlink" title="五、模式分析"></a>五、模式分析</h2><p>中介者模式可以使对象之间的关系数量急剧减少。</p><p>中介者承担两方面的职责：</p><ul><li><strong>中转作用（结构性）</strong>：通过中介者提供的中转作用，各个同事对象就不再需要显式引用其他同事，当需要和其他同事进行通信时，通过中介者即可。该中转作用属于中介者在结构上的支持。</li><li><strong>协调作用（行为性）</strong>：中介者可以更进一步的对同事之间的关系进行封装，同事可以一致地和中介者进行交互，而不需要指明中介者需要具体怎么做，中介者根据封装在自身内部的协调逻辑，对同事的请求进行进一步处理，将同事成员之间的关系行为进行分离和封装。该协调作用属于中介者在行为上的支持。</li></ul><h3 id="1-优点"><a href="#1-优点" class="headerlink" title="1. 优点"></a>1. 优点</h3><p>中介者模式的优点：</p><ul><li>简化了对象之间的交互。</li><li>将各同事解耦。</li><li>减少子类生成。</li><li>可以简化各同事类的设计和实现。</li></ul><h3 id="2-缺点"><a href="#2-缺点" class="headerlink" title="2. 缺点"></a>2. 缺点</h3><p>中介者模式的缺点：</p><ul><li>在具体中介者类中包含了同事之间的交互细节，<strong>可能会导致具体中介者类非常复杂，使得系统难以维护</strong>。</li></ul><h3 id="3-适用环境"><a href="#3-适用环境" class="headerlink" title="3. 适用环境"></a>3. 适用环境</h3><p>在以下情况下可以使用中介者模式：</p><ul><li>系统中对象之间存在复杂的引用关系，产生的相互依赖关系结构混乱且难以理解。</li><li>一个对象由于引用了其他很多对象并且直接和这些对象通信，导致难以复用该对象。</li><li>想通过一个中间类来封装多个类中的行为，而又不想生成太多的子类。可以通过引入中介者类来实现，在中介者中定义对象。</li><li>交互的公共行为，如果需要改变行为则可以增加新的中介者类。</li></ul><h2 id="六、模式总结"><a href="#六、模式总结" class="headerlink" title="六、模式总结"></a>六、模式总结</h2><ul><li>中介者模式用一个中介对象来封装一系列的对象交互，中介者使各对象不需要显式地相互引用，从而使其耦合松散，而且可以独立地改变它们之间的交互。中介者模式又称为调停者模式，它是一种对象行为型模式。</li><li>中介者模式包含四个角色：抽象中介者用于定义一个接口，该接口用于与各同事对象之间的通信；具体中介者是抽象中介者的子类，通过协调各个同事对象来实现协作行为，了解并维护它的各个同事对象的引用；抽象同事类定义各同事的公有方法；具体同事类是抽象同事类的子类，每一个同事对象都引用一个中介者对象；每一个同事对象在需要和其他同事对象通信时，先与中介者通信，通过中介者来间接完成与其他同事类的通信；在具体同事类中实现了在抽象同事类中定义的方法。</li><li>通过引入中介者对象，可以将系统的网状结构变成以中介者为中心的星形结构，中介者承担了中转作用和协调作用。中介者类是中介者模式的核心，它对整个系统进行控制和协调，简化了对象之间的交互，还可以对对象间的交互进行进一步的控制。</li><li>中介者模式的主要优点在于简化了对象之间的交互，将各同事解耦，还可以减少子类生成，对于复杂的对象之间的交互，通过引入中介者，可以简化各同事类的设计和实现；中介者模式主要缺点在于具体中介者类中包含了同事之间的交互细节，可能会导致具体中介者类非常复杂，使得系统难以维护。</li><li>中介者模式适用情况包括：系统中对象之间存在复杂的引用关系，产生的相互依赖关系结构混乱且难以理解；一个对象由于引用了其他很多对象并且直接和这些对象通信，导致难以复用该对象；想通过一个中间类来封装多个类中的行为，而又不想生成太多的子类。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之命令模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-ming-ling-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-ming-ling-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、模式动机"><a href="#一、模式动机" class="headerlink" title="一、模式动机"></a>一、模式动机</h2><p>在软件设计中，我们经常需要向某些对象发送请求，但是并不知道请求的接收者是谁，也不知道被请求的操作是哪个，我们只需在程序运行时指定具体的请求接收者即可，此时，可以使用命令模式来进行设计，使得请求发送者与请求接收者消除彼此之间的耦合，让对象之间的调用关系更加灵活。</p><p>命令模式可以对发送者和接收者完全解耦，发送者与接收者之间没有直接引用关系，发送请求的对象只需要知道如何发送请求，而不必知道如何完成请求。这就是命令模式的模式动机。</p><h2 id="二、模式定义"><a href="#二、模式定义" class="headerlink" title="二、模式定义"></a>二、模式定义</h2><blockquote><p>**命令模式(<code>Command Pattern</code>)**：将一个请求封装为一个对象，从而使我们可用不同的请求对客户进行参数化；对请求排队或者记录请求日志，以及支持可撤销的操作。命令模式是一种对象行为型模式，其别名为动作(<code>Action</code>)模式或事务(<code>Transaction</code>)模式。</p></blockquote><h2 id="三、模式结构"><a href="#三、模式结构" class="headerlink" title="三、模式结构"></a>三、模式结构</h2><h3 id="1-角色组成"><a href="#1-角色组成" class="headerlink" title="1. 角色组成"></a>1. 角色组成</h3><p>命令模式包含如下角色：</p><ul><li><code>Command</code>: 抽象命令类</li><li><code>ConcreteCommand</code>: 具体命令类</li><li><code>Invoker</code>: 调用者</li><li><code>Receiver</code>: 接收者</li><li><code>Client</code>: 客户类</li></ul><h3 id="2-结构图"><a href="#2-结构图" class="headerlink" title="2. 结构图"></a>2. 结构图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/10/16/command-structure.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/10/16/command-structure.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="命令模式结构图"></p><h2 id="四、示例代码"><a href="#四、示例代码" class="headerlink" title="四、示例代码"></a>四、示例代码</h2><p>首先，是抽象的<code>Receiver</code>类和具体的<code>Receiver</code>类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 通用的抽象 Receiver 接收者. * * Created by blinkfox on 16/8/17. */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Receiver</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 定义每个接收者都必须完成的业务.     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的 Receiver 类1. * * Created by blinkfox on 16/8/17. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteReceiver1</span> <span class="token keyword">extends</span> <span class="token class-name">Receiver</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ConcreteReceiver1 处理的业务逻辑..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的 Receiver 类2. * * Created by blinkfox on 16/8/17. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteReceiver2</span> <span class="token keyword">extends</span> <span class="token class-name">Receiver</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ConcreteReceiver2 处理的业务逻辑..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其实，是抽象的<code>Command</code>类和具体的<code>Command</code>类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 抽象的 Command 类. * * Created by blinkfox on 16/8/17. */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Command</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 命令的抽象执行命令的方法.     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的 Command 命令类1. * * Created by blinkfox on 16/8/17. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteCommand1</span> <span class="token keyword">extends</span> <span class="token class-name">Command</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** 对哪个receiver类进行处理. */</span>    <span class="token keyword">private</span> <span class="token class-name">Receiver</span> receiver<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">ConcreteCommand1</span><span class="token punctuation">(</span><span class="token class-name">Receiver</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>receiver <span class="token operator">=</span> receiver<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 必须实现的一个命令.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的 Command 命令类2. * * Created by blinkfox on 16/8/17. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteCommand2</span> <span class="token keyword">extends</span> <span class="token class-name">Command</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** 对哪个receiver类进行处理. */</span>    <span class="token keyword">private</span> <span class="token class-name">Receiver</span> receiver<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">ConcreteCommand2</span><span class="token punctuation">(</span><span class="token class-name">Receiver</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>receiver <span class="token operator">=</span> receiver<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 必须实现的命令.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后，调用者<code>Invoker</code>类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 调用者 Invoker 类. * * Created by blinkfox on 16/8/17. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Invoker</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">Command</span> command<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCommand</span><span class="token punctuation">(</span><span class="token class-name">Command</span> command<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>command <span class="token operator">=</span> command<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 执行命令.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以下是命令模式的客户端场景类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 命令模式的场景类. * * Created by blinkfox on 16/8/17. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommandClient</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Invoker</span> invoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Invoker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Receiver</span> receiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteReceiver1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Command</span> command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteCommand1</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 把命令交给调用者执行</span>        invoker<span class="token punctuation">.</span><span class="token function">setCommand</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>        invoker<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="五、模式分析"><a href="#五、模式分析" class="headerlink" title="五、模式分析"></a>五、模式分析</h2><p><strong>命令模式的本质是对命令进行封装，将发出命令的责任和执行命令的责任分割开</strong>。</p><ul><li>每一个命令都是一个操作：请求的一方发出请求，要求执行一个操作；接收的一方收到请求，并执行操作。</li><li>命令模式允许请求的一方和接收的一方独立开来，使得请求的一方不必知道接收请求的一方的接口，更不必知道请求是怎么被接收，以及操作是否被执行、何时被执行，以及是怎么被执行的。</li><li>命令模式使请求本身成为一个对象，这个对象和其他对象一样可以被存储和传递。</li><li>命令模式的关键在于引入了抽象命令接口，且发送者针对抽象命令接口编程，只有实现了抽象命令接口的具体命令才能与接收者相关联。</li></ul><h3 id="1-优点"><a href="#1-优点" class="headerlink" title="1. 优点"></a>1. 优点</h3><p>命令模式的优点：</p><ul><li>降低系统的耦合度。</li><li>新的命令可以很容易地加入到系统中。</li><li>可以比较容易地设计一个命令队列和宏命令（组合命令）。</li><li>可以方便地实现对请求的<code>Undo</code>和<code>Redo</code>。</li></ul><h3 id="2-缺点"><a href="#2-缺点" class="headerlink" title="2. 缺点"></a>2. 缺点</h3><p>命令模式的缺点：</p><ul><li>使用命令模式可能会导致某些系统有过多的具体命令类。因为针对每一个命令都需要设计一个具体命令类，因此某些系统可能需要大量具体命令类，这将影响命令模式的使用。</li></ul><h3 id="3-适用环境"><a href="#3-适用环境" class="headerlink" title="3. 适用环境"></a>3. 适用环境</h3><p>在以下情况下可以使用命令模式：</p><ul><li>系统需要将请求调用者和请求接收者解耦，使得调用者和接收者不直接交互。</li><li>系统需要在不同的时间指定请求、将请求排队和执行请求。</li><li>系统需要支持命令的撤销(Undo)操作和恢复(Redo)操作。</li><li>系统需要将一组操作组合在一起，即支持宏命令</li></ul><h2 id="六、模式总结"><a href="#六、模式总结" class="headerlink" title="六、模式总结"></a>六、模式总结</h2><ul><li>在命令模式中，将一个请求封装为一个对象，从而使我们可用不同的请求对客户进行参数化；对请求排队或者记录请求日志，以及支持可撤销的操作。命令模式是一种对象行为型模式，其别名为动作模式或事务模式。</li><li>命令模式包含四个角色：抽象命令类中声明了用于执行请求的<code>execute()</code>等方法，通过这些方法可以调用请求接收者的相关操作；具体命令类是抽象命令类的子类，实现了在抽象命令类中声明的方法，它对应具体的接收者对象，将接收者对象的动作绑定其中；调用者即请求的发送者，又称为请求者，它通过命令对象来执行请求；接收者执行与请求相关的操作，它具体实现对请求的业务处理。</li><li>命令模式的本质是对命令进行封装，将发出命令的责任和执行命令的责任分割开。命令模式使请求本身成为一个对象，这个对象和其他对象一样可以被存储和传递。</li><li>命令模式的主要优点在于降低系统的耦合度，增加新的命令很方便，而且可以比较容易地设计一个命令队列和宏命令，并方便地实现对请求的撤销和恢复；其主要缺点在于可能会导致某些系统有过多的具体命令类。</li><li>命令模式适用情况包括：需要将请求调用者和请求接收者解耦，使得调用者和接收者不直接交互；需要在不同的时间指定请求、将请求排队和执行请求；需要支持命令的撤销操作和恢复操作，需要将一组操作组合在一起，即支持宏命令。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>代码整洁之道内容概要</title>
      <link href="/post/bian-cheng-zhi-dao/dai-ma-zheng-ji-zhi-dao-nei-rong-gai-yao/"/>
      <url>/post/bian-cheng-zhi-dao/dai-ma-zheng-ji-zhi-dao-nei-rong-gai-yao/</url>
      
        <content type="html"><![CDATA[<p>读了代码整洁之道，觉得这本书写的很好，所以就将里面自己觉得很经典的内容记录下来，作为自己以后写代码的标准和准则。同时也为那些曾经困惑过的人一点参考吧！</p><h2 id="一、在正式开始之前，我们先思考几个几个问题："><a href="#一、在正式开始之前，我们先思考几个几个问题：" class="headerlink" title="一、在正式开始之前，我们先思考几个几个问题："></a>一、在正式开始之前，我们先思考几个几个问题：</h2><h3 id="1-需求与代码哪个重要？"><a href="#1-需求与代码哪个重要？" class="headerlink" title="1.需求与代码哪个重要？"></a>1.需求与代码哪个重要？</h3><p>答：并不是所有的产品都能提出合理的需求，当你面对一个提出不合理需求的产品的时候，你需要坚持自己的原则，不能妥协。</p><h3 id="2-易读和易懂是一回事吗？"><a href="#2-易读和易懂是一回事吗？" class="headerlink" title="2.易读和易懂是一回事吗？"></a>2.易读和易懂是一回事吗？</h3><p>答：易读的代码和易懂的代码是有区别的，不是易读的代码就是易懂的代码。</p><h3 id="3-什么是测试驱动代码？"><a href="#3-什么是测试驱动代码？" class="headerlink" title="3.什么是测试驱动代码？"></a>3.什么是测试驱动代码？</h3><p>答：测试驱动代码，你写的代码要可以执行单元测试。如果你发现你的代码很难写单元测试，那么你就要思考你的代码是不是已经不整洁了，或者说已经乱成一团了。</p><h3 id="4-什么是简单的代码？"><a href="#4-什么是简单的代码？" class="headerlink" title="4.什么是简单的代码？"></a>4.什么是简单的代码？</h3><p>答：<br>1.能通过所有测试<br>2.没有重复代码<br>3.体现系统中全部设计理念<br>4.包含尽量少的实体，包括，类，函数，方法等</p><p>如果某段代码在程序设计中反复出现，就证明想法在代码中没有很好的体现出来。总之，不要重复代码，只做一件事，表达力，小规模抽象。</p><h2 id="二、第二章-有意义的命名"><a href="#二、第二章-有意义的命名" class="headerlink" title="二、第二章 有意义的命名"></a>二、第二章 有意义的命名</h2><h3 id="1-名副其实"><a href="#1-名副其实" class="headerlink" title="1.名副其实"></a>1.名副其实</h3><p>变量，函数或类的名称应该已经答复了所有的大问题。它应该告诉你，它为什么会存在，它做什么事情，应该怎么用。如果名称需要注释来补充，那么就不算名副其实。</p><h3 id="2-避免误导"><a href="#2-避免误导" class="headerlink" title="2.避免误导"></a>2.避免误导</h3><p>必须避免留下掩藏代码本意的错误线索。</p><h3 id="3-做有意义的区分"><a href="#3-做有意义的区分" class="headerlink" title="3.做有意义的区分"></a>3.做有意义的区分</h3><p>只要体现出有意义的区分，使用a和the这样的前缀就没有错。废话就是冗余。</p><h3 id="4-使用读得出来的名称"><a href="#4-使用读得出来的名称" class="headerlink" title="4.使用读得出来的名称"></a>4.使用读得出来的名称</h3><p>不要用傻乎乎的自造词，而不是恰当的英语词。</p><h3 id="5-使用可搜索的名称"><a href="#5-使用可搜索的名称" class="headerlink" title="5.使用可搜索的名称"></a>5.使用可搜索的名称</h3><p>使用便于搜索的名字。</p><h3 id="6-避免使用编码"><a href="#6-避免使用编码" class="headerlink" title="6.避免使用编码"></a>6.避免使用编码</h3><p>把类型或者作用域编进名称里面，徒然增加了解码的负担。没理由要求每位新人都在弄清要应付的代码之外，还要再搞懂另一种编码”语言”。</p><h3 id="7-避免思维映射"><a href="#7-避免思维映射" class="headerlink" title="7.避免思维映射"></a>7.避免思维映射</h3><p>不应当让读者在脑中把你的名称翻译为他们熟知的名称，尤其是在经常出现在选择是使用问题领域术语还是解决方案领域术语的时候。</p><h3 id="8-类名或对象名最好使用名词或者名词短语"><a href="#8-类名或对象名最好使用名词或者名词短语" class="headerlink" title="8.类名或对象名最好使用名词或者名词短语"></a>8.类名或对象名最好使用名词或者名词短语</h3><h3 id="9-方法名最好使用动词或者动词短语"><a href="#9-方法名最好使用动词或者动词短语" class="headerlink" title="9.方法名最好使用动词或者动词短语"></a>9.方法名最好使用动词或者动词短语</h3><h3 id="10-别扮可爱"><a href="#10-别扮可爱" class="headerlink" title="10.别扮可爱"></a>10.别扮可爱</h3><p>命名一定要通俗易懂。</p><h3 id="11-每一个概念对应一个词"><a href="#11-每一个概念对应一个词" class="headerlink" title="11.每一个概念对应一个词"></a>11.每一个概念对应一个词</h3><p>给每个抽象概念选择一个词，并一以贯之</p><h3 id="12-别用双关语词"><a href="#12-别用双关语词" class="headerlink" title="12.别用双关语词"></a>12.别用双关语词</h3><p>避免将同一个词用于不同目的，遵循一词一义的原则</p><h3 id="13-使用解决方案领域名"><a href="#13-使用解决方案领域名" class="headerlink" title="13.使用解决方案领域名"></a>13.使用解决方案领域名</h3><h3 id="14-使用源自所涉领域名"><a href="#14-使用源自所涉领域名" class="headerlink" title="14.使用源自所涉领域名"></a>14.使用源自所涉领域名</h3><h3 id="15-添加有意义的语境"><a href="#15-添加有意义的语境" class="headerlink" title="15.添加有意义的语境"></a>15.添加有意义的语境</h3><p>在一个bean中定义变量名的时候，变量名一定是基于实际使用场景。</p><h3 id="16-不要添加没用的语境"><a href="#16-不要添加没用的语境" class="headerlink" title="16.不要添加没用的语境"></a>16.不要添加没用的语境</h3><h2 id="三、第三章-函数"><a href="#三、第三章-函数" class="headerlink" title="三、第三章 函数"></a>三、第三章 函数</h2><h3 id="1-短小"><a href="#1-短小" class="headerlink" title="1.短小"></a>1.短小</h3><p>函数第一规则是要短小。第二条规则是还要更短小。</p><h3 id="2-只做一件事"><a href="#2-只做一件事" class="headerlink" title="2.只做一件事"></a>2.只做一件事</h3><ul><li>函数应该做一件事。做好这件事。只做一件事。如果可以从你的函数中还能拆分出一个函数，该函数不仅只是单纯地重新诠释其实现，那么你设计的函数就不是一个好的函数。</li><li>函数中的区段，如果函数被切分了多个区段，这就证明该函数做的事情太多了。</li></ul><h3 id="3-每个函数一个抽象层级"><a href="#3-每个函数一个抽象层级" class="headerlink" title="3.每个函数一个抽象层级"></a>3.每个函数一个抽象层级</h3><h3 id="4-switch语句"><a href="#4-switch语句" class="headerlink" title="4.switch语句"></a>4.switch语句</h3><p>确保每个switch都埋藏在较低的抽象层级，而且永远不重复。</p><h3 id="5-使用描述性的名称"><a href="#5-使用描述性的名称" class="headerlink" title="5.使用描述性的名称"></a>5.使用描述性的名称</h3><p>命名方式要保持一致。使用与模块名一脉相承的短语、名词和动词给函数命名。例如：includeSetupPages。</p><h3 id="6-函数参数"><a href="#6-函数参数" class="headerlink" title="6.函数参数"></a>6.函数参数</h3><ul><li>最理想的函数参数的数量是零个，其次是一，再次是二，应尽量避免三。有足够的理由才能用上三个以上的参数。</li><li>如果函数看来需要两个，三个或者三个以上参数，就说明其中一些参数应该封装为类了。</li><li>函数和函数的参数命名一般是动名词比较好。</li></ul><h3 id="7-无副作用"><a href="#7-无副作用" class="headerlink" title="7.无副作用"></a>7.无副作用</h3><h3 id="8-分割指令与查询"><a href="#8-分割指令与查询" class="headerlink" title="8.分割指令与查询"></a>8.分割指令与查询</h3><p>函数要么做什么事，要么回答什么事，但二者不可兼得</p><h3 id="9-使用异常替代返回错误码"><a href="#9-使用异常替代返回错误码" class="headerlink" title="9.使用异常替代返回错误码"></a>9.使用异常替代返回错误码</h3><ul><li>返回错误码的时候，就是在要求调用者立刻处理错误。</li><li>如果使用异常替代返回错误码，错误处理代码就能从住路径代码中分离出来，得到简化。</li><li>抽离try/catch代码块</li></ul><h3 id="10-别重复自己"><a href="#10-别重复自己" class="headerlink" title="10.别重复自己"></a>10.别重复自己</h3><h3 id="11-结构化编程"><a href="#11-结构化编程" class="headerlink" title="11.结构化编程"></a>11.结构化编程</h3><h2 id="四、第四章-注释"><a href="#四、第四章-注释" class="headerlink" title="四、第四章 注释"></a>四、第四章 注释</h2><h3 id="1-如果你代码写的足够好的话，可以让人一看就懂，那么你就不需要再写注释。如果你的代码需要注释，那么你就需要想想是不是你的表达水平有问题。"><a href="#1-如果你代码写的足够好的话，可以让人一看就懂，那么你就不需要再写注释。如果你的代码需要注释，那么你就需要想想是不是你的表达水平有问题。" class="headerlink" title="1.如果你代码写的足够好的话，可以让人一看就懂，那么你就不需要再写注释。如果你的代码需要注释，那么你就需要想想是不是你的表达水平有问题。"></a>1.如果你代码写的足够好的话，可以让人一看就懂，那么你就不需要再写注释。如果你的代码需要注释，那么你就需要想想是不是你的表达水平有问题。</h3><h3 id="2-真正好的注释是想办法不用写注释，那么什么样的注释需要写呢？"><a href="#2-真正好的注释是想办法不用写注释，那么什么样的注释需要写呢？" class="headerlink" title="2.真正好的注释是想办法不用写注释，那么什么样的注释需要写呢？"></a>2.真正好的注释是想办法不用写注释，那么什么样的注释需要写呢？</h3><ul><li>法律信息</li><li>提供信息的注释</li><li>提供意图的解释</li><li>阐释</li><li>警告</li><li>TODO注释</li><li>TODO是一种程序要认为应该要做的，但是由于某种原因没有做的</li><li>放大,放大某些看似不合理的地方</li></ul><h2 id="五、第六章-对象和数据结构"><a href="#五、第六章-对象和数据结构" class="headerlink" title="五、第六章 对象和数据结构"></a>五、第六章 对象和数据结构</h2><h3 id="1-得墨忒定律"><a href="#1-得墨忒定律" class="headerlink" title="1.得墨忒定律"></a>1.得墨忒定律</h3><p>模块不应该了解他所操作对象的内部情形。对象隐藏数据曝露操作，这就意味着对象不应该通过存取器曝露其内部结构。</p><h2 id="六、第七章-错误处理"><a href="#六、第七章-错误处理" class="headerlink" title="六、第七章 错误处理"></a>六、第七章 错误处理</h2><h3 id="1-将业务逻辑和出错处理一定要隔离开，但是并不是所有的情况都试用，在不适用的情况下我们可以创建一个配置对象将特殊情况给予返回。"><a href="#1-将业务逻辑和出错处理一定要隔离开，但是并不是所有的情况都试用，在不适用的情况下我们可以创建一个配置对象将特殊情况给予返回。" class="headerlink" title="1.将业务逻辑和出错处理一定要隔离开，但是并不是所有的情况都试用，在不适用的情况下我们可以创建一个配置对象将特殊情况给予返回。"></a>1.将业务逻辑和出错处理一定要隔离开，但是并不是所有的情况都试用，在不适用的情况下我们可以创建一个配置对象将特殊情况给予返回。</h3><h3 id="2-异常处理不能过多的曝露实现细节，主要提现在异常抛出的栈信息上。"><a href="#2-异常处理不能过多的曝露实现细节，主要提现在异常抛出的栈信息上。" class="headerlink" title="2.异常处理不能过多的曝露实现细节，主要提现在异常抛出的栈信息上。"></a>2.异常处理不能过多的曝露实现细节，主要提现在异常抛出的栈信息上。</h3><h2 id="七、第八章-边界"><a href="#七、第八章-边界" class="headerlink" title="七、第八章 边界"></a>七、第八章 边界</h2><h3 id="1-整洁的边界，边界上的代码要清晰的分割和定义了期望的测试。应该避免我们的代码过多地了解第三方代码中的特定信息。"><a href="#1-整洁的边界，边界上的代码要清晰的分割和定义了期望的测试。应该避免我们的代码过多地了解第三方代码中的特定信息。" class="headerlink" title="1.整洁的边界，边界上的代码要清晰的分割和定义了期望的测试。应该避免我们的代码过多地了解第三方代码中的特定信息。"></a>1.整洁的边界，边界上的代码要清晰的分割和定义了期望的测试。应该避免我们的代码过多地了解第三方代码中的特定信息。</h3><h2 id="八、第九章-单元测试"><a href="#八、第九章-单元测试" class="headerlink" title="八、第九章 单元测试"></a>八、第九章 单元测试</h2><h3 id="1-TDD三定律"><a href="#1-TDD三定律" class="headerlink" title="1.TDD三定律"></a>1.TDD三定律</h3><ul><li>在编写不能通过的单元测试前，不可编写生产代码。</li><li>只可编写刚好无法通过的单元测试，不能编译也算不通过</li><li>只可编写刚好足以通过当前失败测试的生产代码</li></ul><h3 id="2-整洁测试三要素"><a href="#2-整洁测试三要素" class="headerlink" title="2.整洁测试三要素"></a>2.整洁测试三要素</h3><ul><li>可读性</li><li>可读性</li><li>可读性</li></ul><h3 id="3-整洁测试的五条原则："><a href="#3-整洁测试的五条原则：" class="headerlink" title="3.整洁测试的五条原则："></a>3.整洁测试的五条原则：</h3><ul><li>快速，测试应该够快</li><li>独立，测试应该相互独立</li><li>可重复，测试应当可在任何环境中重复通过。</li><li>自足验证，测试应该有布尔值输出，无论测试是成功还是失败，不应该人工通过log来确认测试是否成功或者失败。</li><li>及时，测试应及时编写。单元测试应该恰好在使其通过的生产代码之前编写。如果在编写生产代码之后编写测试，你会发现生产代码难以测试。你可能会认为某些生产代码本身难以测试。你可能不会去设计可测试的代码。</li></ul><h2 id="九、第十章-类"><a href="#九、第十章-类" class="headerlink" title="九、第十章 类"></a>九、第十章 类</h2><h3 id="1-单一权责原则，类或者模块应有且只有一条加以修改的理由。"><a href="#1-单一权责原则，类或者模块应有且只有一条加以修改的理由。" class="headerlink" title="1.单一权责原则，类或者模块应有且只有一条加以修改的理由。"></a>1.单一权责原则，类或者模块应有且只有一条加以修改的理由。</h3><h3 id="2-内聚，如果一个类中的每个变量都被每个方法所使用，则该类具有最大的内聚性。内聚性高，意味着类中的方法和变量相互依赖，相互结合成一个逻辑整体。"><a href="#2-内聚，如果一个类中的每个变量都被每个方法所使用，则该类具有最大的内聚性。内聚性高，意味着类中的方法和变量相互依赖，相互结合成一个逻辑整体。" class="headerlink" title="2.内聚，如果一个类中的每个变量都被每个方法所使用，则该类具有最大的内聚性。内聚性高，意味着类中的方法和变量相互依赖，相互结合成一个逻辑整体。"></a>2.内聚，如果一个类中的每个变量都被每个方法所使用，则该类具有最大的内聚性。内聚性高，意味着类中的方法和变量相互依赖，相互结合成一个逻辑整体。</h3><h2 id="十、第十一章-系统"><a href="#十、第十一章-系统" class="headerlink" title="十、第十一章 系统"></a>十、第十一章 系统</h2><h3 id="1-将系统的构造与使用分开"><a href="#1-将系统的构造与使用分开" class="headerlink" title="1.将系统的构造与使用分开"></a>1.将系统的构造与使用分开</h3><p>软件系统应将起始过程和启始过程之后的运行时逻辑分离开，在起始过程中构建应用对象，也会存在相互缠结的依赖关系。（延迟初始化可以加快程序运行速度）</p><h4 id="1-1分解main"><a href="#1-1分解main" class="headerlink" title="1.1分解main"></a>1.1分解main</h4><p>将程序的构造放到main，并使其与运行时逻辑分开，main只管构造并将构造后的数据对象发送给各个应用，或者被各个应用使用。但是，不参与运行时的任何逻辑控制。</p><h4 id="1-2工厂模式"><a href="#1-2工厂模式" class="headerlink" title="1.2工厂模式"></a>1.2工厂模式</h4><p>使用该模式可以将系统构造和系统运行时逻辑分开。</p><h4 id="1-3依赖注入（需要强化理解）"><a href="#1-3依赖注入（需要强化理解）" class="headerlink" title="1.3依赖注入（需要强化理解）"></a>1.3依赖注入（需要强化理解）</h4><h4 id="1-4扩容"><a href="#1-4扩容" class="headerlink" title="1.4扩容"></a>1.4扩容</h4><p>“一开始就做对系统”纯属神话。反之，我们应该只去实现今天的用户故事，然后重构，明天再扩展系统，实现新用户的故事。这就是迭代和增量敏捷的精髓所在。测试驱动开发，重构以及他们打造出的整洁的代码。</p><h4 id="1-5测试驱动系统架构"><a href="#1-5测试驱动系统架构" class="headerlink" title="1.5测试驱动系统架构"></a>1.5测试驱动系统架构</h4><p>最佳的系统架构由模块化的关注面领域组成，每个关注面均用纯编程语言对象实现。不同的领域之间用最不具有侵害性的方面或类方面工具结合起来。这种架构就能测试驱动，就像代码一样。(需要关注面向切片编程(POJO))</p><h4 id="1-6优化决策"><a href="#1-6优化决策" class="headerlink" title="1.6优化决策"></a>1.6优化决策</h4><p>模块化和关注面切分成就了分散化管理和决策。在巨大的系统中，不管是一座城市或是一个软件项目，无人能做所有的决策。最好是授权给最有资格的人。拥有模块化关注面的POJO系统提供的敏捷能力，允许我们基于最新的知识做出优化的，时机刚好的决策。决策的复杂性降低了。</p><h2 id="十一、第十二章-迭进"><a href="#十一、第十二章-迭进" class="headerlink" title="十一、第十二章 迭进"></a>十一、第十二章 迭进</h2><h3 id="1-通过迭进设计达到代码整洁的目的："><a href="#1-通过迭进设计达到代码整洁的目的：" class="headerlink" title="1. 通过迭进设计达到代码整洁的目的："></a>1. 通过迭进设计达到代码整洁的目的：</h3><p>通过这几个原则可以让你的设计变简单（DIP，SRP）</p><ul><li>运行所有测试</li><li>不可重复，</li><li>表达了程序员的意图</li><li>尽可能减少类和方法的数量</li><li>以上规则按其重要程度排序</li></ul><h3 id="2-简单设计规则1-运行所有测试"><a href="#2-简单设计规则1-运行所有测试" class="headerlink" title="2. 简单设计规则1:运行所有测试"></a>2. 简单设计规则1:运行所有测试</h3><p>编写的测试越多就越能持续走向编写较易测试的代码，紧耦合的代码很难编写测试。遵循有关编写测试并持续运行测试的简单，明确的规则，系统就会更贴近OO低耦合度，高内聚度的目标。编写测试引致更好的设计。</p><h3 id="3-简单设计规则2-4：重构"><a href="#3-简单设计规则2-4：重构" class="headerlink" title="3. 简单设计规则2-4：重构"></a>3. 简单设计规则2-4：重构</h3><p>在重构过程中，可以应用有关优秀软件设计的一切知识。提升内聚性，降低耦合度，切分关注面，模块化系统性关注面，缩小函数和类的尺寸，选用更好的名称，如此等等。这也是简单设计原则后三条规则的地方:消除重复，保证表达力，尽可能减少类和方法的数量。</p><h3 id="4-不可重复"><a href="#4-不可重复" class="headerlink" title="4. 不可重复"></a>4. 不可重复</h3><h3 id="5-表达力"><a href="#5-表达力" class="headerlink" title="5. 表达力"></a>5. 表达力</h3><h3 id="6-尽可能少的类和方法"><a href="#6-尽可能少的类和方法" class="headerlink" title="6. 尽可能少的类和方法"></a>6. 尽可能少的类和方法</h3><h2 id="十二、第十三章-并发编程"><a href="#十二、第十三章-并发编程" class="headerlink" title="十二、第十三章 并发编程"></a>十二、第十三章 并发编程</h2><h3 id="1-为什么要并发"><a href="#1-为什么要并发" class="headerlink" title="1. 为什么要并发"></a>1. 为什么要并发</h3><p>并发是一种解耦策略。它帮我们把做什么和何时做分解开。</p><h3 id="2-并发的防御原则"><a href="#2-并发的防御原则" class="headerlink" title="2. 并发的防御原则"></a>2. 并发的防御原则</h3><h3 id="13-1-单一权责原则（SRP）"><a href="#13-1-单一权责原则（SRP）" class="headerlink" title="13.1 单一权责原则（SRP）"></a>13.1 单一权责原则（SRP）</h3><p>并发代码应该从其他代码中分离出来，因为，并发代码相比于其他的代码是很复杂的存在。但是，并发实现细节常常直接嵌入到其他生产代码中。那么下面几个问题需要考虑，</p><ul><li>并发相关代码由自己的开发，修改和调优生命周期</li><li>开发相关代码由自己要对付的挑战，和非并发相关代码不同，而且往往更为困难</li><li>即便没有周边应用程序增加负担，写得不好的并发代码可能的出错方式数量已经足具挑战性。</li></ul><blockquote><p>建议：分离并发相关代码与其他代码。</p></blockquote><h3 id="13-2-限制数据作用域"><a href="#13-2-限制数据作用域" class="headerlink" title="13.2 限制数据作用域"></a>13.2 限制数据作用域</h3><p>两个线程修改共享对象的同一字段时，可能相互干扰，导致未预期的行为。解决方案之一是采用<code>synchronized</code>关键字在代码中保护一块使用共享对象的临界区。限制临界区的数量很重要。更新共享数据的地方越多，就越可能出错。</p><blockquote><p>建议：谨记数据封装，严格限制对可能被共享的数据的访问。</p></blockquote><h3 id="13-3-使用数据副本"><a href="#13-3-使用数据副本" class="headerlink" title="13.3 使用数据副本"></a>13.3 使用数据副本</h3><p>避免共享数据的好方法之一就是一开始就避免共享数据。在某些情况下，有可能复制对象并以只读方式对待。在另外一种情况下，有可能复制对象，从多个线程收集所有副本的结果，并在单个线程中合并这些结果。</p><h3 id="13-4-线程尽可能地独立"><a href="#13-4-线程尽可能地独立" class="headerlink" title="13.4　线程尽可能地独立"></a>13.4　线程尽可能地独立</h3><p>让每个线程在自己的世界中存在，不与其他线程共享数据。每个线程处理一个客户端请求，从不共享的源头接纳所有请求数据，存储为本地变量。</p><p>建议：尝试将数据分解到可被独立线程操作的独立子集。</p><h3 id="13-5-了解执行模型"><a href="#13-5-了解执行模型" class="headerlink" title="13.5 了解执行模型"></a>13.5 了解执行模型</h3><h4 id="13-5-1-生产者－－－消费者模型"><a href="#13-5-1-生产者－－－消费者模型" class="headerlink" title="13.5.1 生产者－－－消费者模型"></a>13.5.1 生产者－－－消费者模型</h4><p>一个或多个生产者线程创建某些工作，并置于缓存或队列中。一个或多个消费者线程从队列中获取并完成这些工作。生产者和消费者之间的队列是一种限定资源。</p><h4 id="13-5-2-读者－－－作者模型"><a href="#13-5-2-读者－－－作者模型" class="headerlink" title="13.5.2 读者－－－作者模型"></a>13.5.2 读者－－－作者模型</h4><p>当存在一个主要为读者线程提供信息源，但只偶尔被作者线程更新的共享资源，吞吐量就会是个问题。增加吞吐量，会导致线程饥饿和过时信息的积累。更新会影响吞吐量。协调读者线程，不去读作者线程正在更新的消息，这是一种辛苦的平衡工作。作者线程倾向于长期锁定许多读者线程，从而导致吞吐量问题。</p><p>挑战之处在于平衡读者线程和作者线程的需求，实现正确的操作，提供合理的吞吐量，避免线程饥饿。</p><h4 id="13-5-3哲学家问题（故事内容不在这里描述）"><a href="#13-5-3哲学家问题（故事内容不在这里描述）" class="headerlink" title="13.5.3哲学家问题（故事内容不在这里描述）"></a>13.5.3哲学家问题（故事内容不在这里描述）</h4><p>从哲学家问题可以反映出编写并发经常遇到的问题，死锁，活锁，吞吐量和效率降低等问题。那么学习这些基础问题的解决算法可以帮助你解决大多数的并发问题，因为大多的并发问题都是上述问题的变种。</p><h3 id="13-6-警惕同步方法之间的依赖"><a href="#13-6-警惕同步方法之间的依赖" class="headerlink" title="13.6 警惕同步方法之间的依赖"></a>13.6 警惕同步方法之间的依赖</h3><p>同步方法之间的依赖会导致并发代码中的狡猾缺陷。Java语言有synchronized概念，可以用来保护单个方法。然而，如果在同一共享类中由多个同步方法，系统就可能写得不太正确了。</p><blockquote><p>建议：避免使用一个共享对象的多个方法。如果有时必须使用一个共享对象的多个方法。这种情况发生时，有３中写对代码的手段：</p></blockquote><ul><li>基于客户端的锁定－－客户端代码在调用第一个方法前锁定服务端，确保锁的范围覆盖了调用最后一个方法的代码。</li><li>基于服务端的锁定－－在服务端内创建锁定服务端的方法，调用所有方法，然后解锁。让客户端代码调用新的方法。</li><li>适配服务端－－创建执行锁定的中间层。这是一种基于服务端的锁定例子，但不修改原始服务端代码。</li></ul><h3 id="13-7保持同步区域微小"><a href="#13-7保持同步区域微小" class="headerlink" title="13.7保持同步区域微小"></a>13.7保持同步区域微小</h3><p>应该尽可能少地设计临界区，如果有请尽可能减小同步区域。</p><h3 id="13-8-编写线程需要注意的几点："><a href="#13-8-编写线程需要注意的几点：" class="headerlink" title="13.8　编写线程需要注意的几点："></a>13.8　编写线程需要注意的几点：</h3><h4 id="1-将伪失败看作可能的线程问题。线程代码中的缺陷可能在一千或者一百万次执行中才会显现一次。所以，不要将系统错误归咎于偶发事件。"><a href="#1-将伪失败看作可能的线程问题。线程代码中的缺陷可能在一千或者一百万次执行中才会显现一次。所以，不要将系统错误归咎于偶发事件。" class="headerlink" title="(1). 将伪失败看作可能的线程问题。线程代码中的缺陷可能在一千或者一百万次执行中才会显现一次。所以，不要将系统错误归咎于偶发事件。"></a>(1). 将伪失败看作可能的线程问题。线程代码中的缺陷可能在一千或者一百万次执行中才会显现一次。所以，不要将系统错误归咎于偶发事件。</h4><h4 id="2-先使非线程代码可工作。确保线程之外的代码可以工作。不要同时追踪非线程缺陷和线程缺陷。确保代码在线程之外可以工作。"><a href="#2-先使非线程代码可工作。确保线程之外的代码可以工作。不要同时追踪非线程缺陷和线程缺陷。确保代码在线程之外可以工作。" class="headerlink" title="(2). 先使非线程代码可工作。确保线程之外的代码可以工作。不要同时追踪非线程缺陷和线程缺陷。确保代码在线程之外可以工作。"></a>(2). 先使非线程代码可工作。确保线程之外的代码可以工作。不要同时追踪非线程缺陷和线程缺陷。确保代码在线程之外可以工作。</h4><h4 id="3-编写可插拔的线程代码。编写在数个环境下运行的线程代码"><a href="#3-编写可插拔的线程代码。编写在数个环境下运行的线程代码" class="headerlink" title="(3). 编写可插拔的线程代码。编写在数个环境下运行的线程代码"></a>(3). 编写可插拔的线程代码。编写在数个环境下运行的线程代码</h4><ul><li>1.单线程与多线程在执行时不同的情况</li><li>2.线程代码与实物或测试替身互动</li><li>3.用运行速度,缓慢和有变动的测试替身执行</li><li>4.将测试配置为能运行一定数量的迭代</li></ul><blockquote><p>建议：编写可插拔的线程代码，这样就能在不同的配置环境下运行。</p></blockquote><h4 id="4-编写可调整的线程代码"><a href="#4-编写可调整的线程代码" class="headerlink" title="(4). 编写可调整的线程代码"></a>(4). 编写可调整的线程代码</h4><p>在系统运行时允许线程发生变动。允许线程依据吞吐量和使用率自我调整。</p><h4 id="5-运行多余处理器数量的线程"><a href="#5-运行多余处理器数量的线程" class="headerlink" title="(5). 运行多余处理器数量的线程"></a>(5). 运行多余处理器数量的线程</h4><p>任务交换越频繁，越有可能找到错过临界区或导致死锁的代码。</p><h4 id="6-在不同平台上运行"><a href="#6-在不同平台上运行" class="headerlink" title="(6). 在不同平台上运行"></a>(6). 在不同平台上运行</h4><h4 id="7-调整代码并强迫错误发生"><a href="#7-调整代码并强迫错误发生" class="headerlink" title="(7). 调整代码并强迫错误发生"></a>(7). 调整代码并强迫错误发生</h4><h2 id="十三、第14章-逐步改进"><a href="#十三、第14章-逐步改进" class="headerlink" title="十三、第14章 逐步改进"></a>十三、第14章 逐步改进</h2><p>代码并不是一次就能写的很干净的，需要我们不断的迭代和优化。</p><h2 id="十四、第17章-味道与启发"><a href="#十四、第17章-味道与启发" class="headerlink" title="十四、第17章 味道与启发"></a>十四、第17章 味道与启发</h2><h3 id="1-注释"><a href="#1-注释" class="headerlink" title="1. 注释"></a>1. 注释</h3><h4 id="1-不恰当的注释信息"><a href="#1-不恰当的注释信息" class="headerlink" title="(1). 不恰当的注释信息"></a>(1). 不恰当的注释信息</h4><p>让注释传达本该更好地在源代码控制系统，问题追踪系统或任何其他记录系统中保存的信息，是不恰当的。例如，修改历史记录只会用大量过时而无趣的文本搞乱源代码文件。注释只应该描述有关代码和设计的技术性信息。</p><h4 id="2-废弃的注释"><a href="#2-废弃的注释" class="headerlink" title="(2). 废弃的注释"></a>(2). 废弃的注释</h4><p>过时，无关或不正确的注释就是废弃的注释。</p><h4 id="3-冗余注释"><a href="#3-冗余注释" class="headerlink" title="(3). 冗余注释"></a>(3). 冗余注释</h4><p>如果注释描述的是某种充分自我描述了的东西，那么注释就是多余的。注释应该谈及代码自身没有提到的东西。</p><h4 id="4-注释要写就要写最好的注释，别画蛇添足"><a href="#4-注释要写就要写最好的注释，别画蛇添足" class="headerlink" title="(4). 注释要写就要写最好的注释，别画蛇添足"></a>(4). 注释要写就要写最好的注释，别画蛇添足</h4><h4 id="5-注释掉的代码，看到注释掉的代码就删。"><a href="#5-注释掉的代码，看到注释掉的代码就删。" class="headerlink" title="(5). 注释掉的代码，看到注释掉的代码就删。"></a>(5). 注释掉的代码，看到注释掉的代码就删。</h4><h3 id="2-环境"><a href="#2-环境" class="headerlink" title="2. 环境"></a>2. 环境</h3><h4 id="1-需要多步才能实现的构建"><a href="#1-需要多步才能实现的构建" class="headerlink" title="(1). 需要多步才能实现的构建"></a>(1). 需要多步才能实现的构建</h4><p>构建系统应该是单步的小操作。不应该从源代码控制系统中一小点一小点签出代码。不应该需要一系列神秘指令或环境依赖脚本来构建单个元素。不应该四出寻找额外的小jar,xml文件和其他系统所需的杂物。你应该能够用单个命令签出系统，并单个指令构建它。</p><h4 id="2-需要多步才能做到测试"><a href="#2-需要多步才能做到测试" class="headerlink" title="(2). 需要多步才能做到测试"></a>(2). 需要多步才能做到测试</h4><p>你应该能够用单个指令就可以运行全部单元测试。能够运行全部测试是如此基础和重要，应该快速，轻易和直接了当地做到。</p><h3 id="3-函数"><a href="#3-函数" class="headerlink" title="3. 函数"></a>3. 函数</h3><ul><li>函数的参数应该少。</li><li>输出参数违反直觉。如果非要修改，那就修改函数所在对象好了。</li><li>标示参数，布尔值参数宣告函数做了不止一件事，应该消灭掉，即函数只做一件事。</li><li>永不被调用的方法应该丢弃。</li></ul><h3 id="4-一般性问题"><a href="#4-一般性问题" class="headerlink" title="4. 一般性问题"></a>4. 一般性问题</h3><p>(1). 如果代码需要有多种语言，那么应该尽力减少源文件中额外语言的数量和范围。</p><p>(2). 明显的行为未被实现，如果明显的行为未被实现，读者和用户就不能再依靠他们对函数名称的直觉。他们不再信任原作者，不得不阅读代码细节。</p><p>(3). 不正确的边界行为，追索每种边界条件，编写测试。</p><p>(4). 忽视安全</p><p>(5). 重复，尽可能找到并消除重复。</p><p>(6). 在错误的抽象层级上的代码，创建分离较高层级一般性概念与较低层级细节概念的抽象模型，这很重要。</p><p>(7). 基类不可多度依赖于派生类，基类应该对派生类一无所知。</p><p>(8). 信息过多，设计良好的模块有着非常小的接口，让你事半功倍。设计良好的接口并不提供许多需要依靠的函数，所以耦合度比较低。</p><p>优秀的软件开发人员学会限制类或模块中暴露的接口数量。类中的方法越少越好。函数知道的变量越少越好。类拥有的实体变量越少越好。隐藏你的数据。隐藏你的工具函数。隐藏你的常量和你的临时变量。不要创建拥有大量方法或大量实体变量的类。不要为子类创建大量受保护变量和函数。尽力保持接口紧凑。通过限制信息来控制耦合度。</p><p>(9). 死代码一定要删除。</p><p>(10). 垂直分隔，变量和函数应该在靠近被使用的地方定义。私有函数应该刚好在其首次被使用的位置下面定义。</p><p>(11). 前后不一致，从一而终即一旦选中，就小心持续遵循。如果在特定函数中用了response的变量来持有HttpServletResponse对象，则在其他用到HttpServletResponse对象的函数中也用同样的变量名。这样会让你的代码更易阅读。</p><p>(12). 混淆视听，没用的变量或者函数直接删掉，以免造成不必要的干扰。</p><p>(13). 人为耦合，不互相依赖的东西不该耦合。一般来说，人为耦合是指两个没有直接目的之间的模块的耦合。其根源是将变量，常量或函数不恰当地放在临时方便的位置。</p><p>(14). 特性依恋，类的方法只应对其所属类中的变量和函数感兴趣，不该垂青其他类中的变量和函数。当方法通过某个其他对象的访问器和修改器来操作该对象内部数据，则它就依恋于该对象所属类的范围。</p><p>(15). 选择算子参数，尽量不要把boolean作为函数参数</p><p>(16). 晦涩意图，代码要尽可能具有表达力。</p><p>(17). 位置错误的权责，我们可以采用最小惊异原则来帮助我们即代码应该放在读者自然而然期待它所在的地方。</p><p>(18). 不恰当的静态方法，对于没有机会打算让它有多态行为的函数可以作为动态函数，否则可选用静态函数。</p><p>(19). 使用解释性变量，命名要有意义。</p><p>(20). 函数名称应该表达其行为</p><p>(21). 理解算法</p><p>(22). 把逻辑依赖改为物理依赖：</p><ul><li>1.逻辑依赖：原始数据和业务逻辑之间的依赖关系。例如：定义的常量和业务逻辑存在着依赖关系或者说被捆绑在了一起，即当业务逻辑发生变化或者存在其他可能性的时候且定义的常量无法满足导致常量需要修改。</li><li>2.物理依赖：函数方法和业务逻辑之间的依赖关系。例如：为了解决逻辑依赖的问题，我们可以通过构造一个方法将数据和业务隔离。</li></ul><p>(23). 用多态替代<code>if/else</code> 或 <code>switch/case</code></p><p>(24). 遵循标准约定</p><p>(25). 用命名常量替代魔术数，魔术数不仅仅指的是数字，也泛指任何不能自我描述的符号。</p><p>(26). 准确，在可以用List的时候，非要把变量声明为ArrayList就过分拘束了。在代码中做决定时，确认自己足够准确。明确自己为何要这么做，如果遇到异常情况如何处理。别懒得理会决定的准确性。代码中的含糊和不准确性要么是意见不同的结果，要么源于懒惰。无论原因是什么，都要消除。</p><p>(27). 结构甚于约定，坚守结构甚于约定的设计决策。</p><p>(28). 封装条件，如果没有if或while语句的上下文，布尔逻辑就难以理解。应该把解释了条件意图的函数抽离出来。</p><p>例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldBeDeleted</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>要好于</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token punctuation">.</span><span class="token function">hasExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>timer<span class="token punctuation">.</span><span class="token function">isRecurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>(29). 避免否定性条件，尽可能将条件表示为肯定形式。</p><p>(30). 函数只该做一件事</p><p>(31). 掩蔽时序耦合，排列函数参数，好让它们被调用的次序显而易见。</p><p>(32). 别随意，构建代码需要理由，而且理由应于代码结构相契合。</p><p>(33). 封装边界条件，把处理边界条件的代码集中到一处，不要散落于代码中。</p><p>(34). 函数应该只在一个抽象层级上，函数中的语句应该在同意抽象级上，该层级应该是函数名所示操作的下一层。</p><p>(35). 在较高层级放置可配置数据，如果你有个已知并在较高抽象层级的默认常量或配置值，不要将它埋藏到较低层级的函数中。把它作为较高层级函数调用较低层级函数时的一个参数。位于较高层级的配置性常量易于修改。它们向下贯穿应用程序。应用程序的较低层级并不拥有这些常量的值。</p><p>(36). 避免传递浏览，编写害羞代码。</p><p>(37). 不要继承常量</p><h3 id="17-5-测试"><a href="#17-5-测试" class="headerlink" title="17.5 测试"></a>17.5 测试</h3><ol><li>使用覆盖率工具，覆盖率工具能汇报你测试策略中的缺口。使用测试覆盖率工具能更容易地找到不足的模块，类和函数。</li><li>别略过小测试</li><li>被忽略的测试就是对不确定事物的疑问。</li><li>测试边界条件</li><li>全面测试相近的缺陷，缺陷趋向于扎堆。</li><li>测试失败的模式有启发性。</li><li>测试覆盖率的模式有启发性，查看被或未被以通过的测试执行的代码，往往能发现失败的测试为何失败的线索。</li><li>测试应该快速。</li></ol><p>来自：<a href="http://www.uml.org.cn/codeNorms/201701162.asp">代码整洁之道内容概要</a></p>]]></content>
      
      
      <categories>
          
          <category> 编程之道 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 整洁代码 </tag>
            
            <tag> 重构 </tag>
            
            <tag> 测试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之观察者模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-guan-cha-zhe-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-guan-cha-zhe-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、模式动机"><a href="#一、模式动机" class="headerlink" title="一、模式动机"></a>一、模式动机</h2><p>建立一种对象与对象之间的依赖关系，一个对象发生改变时将自动通知其他对象，其他对象将相应做出反应。在此，发生改变的对象称为观察目标，而被通知的对象称为观察者，一个观察目标可以对应多个观察者，而且这些观察者之间没有相互联系，可以根据需要增加和删除观察者，使得系统更易于扩展，这就是观察者模式的模式动机。</p><h2 id="二、模式定义"><a href="#二、模式定义" class="headerlink" title="二、模式定义"></a>二、模式定义</h2><blockquote><p>观察者模式(<code>Observer Pattern</code>)：定义对象间的一种一对多依赖关系，使得每当一个对象状态发生改变时，其相关依赖对象皆得到通知并被自动更新。观察者模式又叫做发布-订阅（<code>Publish</code>/<code>Subscribe</code>）模式、模型-视图（<code>Model</code>/<code>View</code>）模式、源-监听器（<code>Source</code>/<code>Listener</code>）模式或从属者（<code>Dependents</code>）模式。</p></blockquote><p>观察者模式是一种<strong>对象行为型模式</strong>。</p><h2 id="三、模式结构"><a href="#三、模式结构" class="headerlink" title="三、模式结构"></a>三、模式结构</h2><h3 id="1-角色组成："><a href="#1-角色组成：" class="headerlink" title="1. 角色组成："></a>1. 角色组成：</h3><p>观察者模式包含如下角色：</p><ul><li><code>Subject</code>: 目标（抽象的被观察着）</li><li><code>ConcreteSubject</code>: 具体目标（具体的被观察者）</li><li><code>Observer</code>: 观察者</li><li><code>ConcreteObserver</code>: 具体观察者</li></ul><h3 id="2-结构图："><a href="#2-结构图：" class="headerlink" title="2. 结构图："></a>2. 结构图：</h3><p><img src="https://statics.sh1a.qingstor.com/2018/10/14/obeserver-structure.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/10/14/obeserver-structure.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="观察者模式结构图"></p><h3 id="3-时序图："><a href="#3-时序图：" class="headerlink" title="3. 时序图："></a>3. 时序图：</h3><p><img src="https://statics.sh1a.qingstor.com/2018/10/14/obeserver-seq.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/10/14/obeserver-seq.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="观察者模式时序图"></p><h2 id="四、示例代码"><a href="#四、示例代码" class="headerlink" title="四、示例代码"></a>四、示例代码</h2><p>首先，是观察者接口：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 观察者接口 * Created by blinkfox on 16/7/14. */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Observer</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 更新的方法</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来，是具体的观察者类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的观察者. * * Created by blinkfox on 16/7/15. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteObserver</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 实现更新方法.     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到信息,并进行处理..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后，是被观察者的抽象类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 被观察者的抽象类. * * Created by blinkfox on 16/7/14. */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Subject</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/** 定义一个观察者的集合. */</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Observer</span><span class="token punctuation">></span></span> observers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Observer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 增加一个观察者.     *     * @param o     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token class-name">Observer</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 删除一个观察者.     *     * @param o     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delObserver</span><span class="token punctuation">(</span><span class="token class-name">Observer</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 通知所有观察者.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Observer</span> o<span class="token operator">:</span> observers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            o<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>具体的被观察者：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的被观察者. * * Created by blinkfox on 16/7/15. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteSubject</span> <span class="token keyword">extends</span> <span class="token class-name">Subject</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 具体的业务.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后，是用于测试观察者模式的客户端场景类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 观察者模式客户端场景类. * * Created by blinkfox on 16/7/15. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObserverClient</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 创建一个被观察者和观察者.</span>        <span class="token class-name">ConcreteSubject</span> sub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Observer</span> obs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 观察者观察被观察者.</span>        sub<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span>obs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 观察者开始活动了.</span>        sub<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="五、模式分析"><a href="#五、模式分析" class="headerlink" title="五、模式分析"></a>五、模式分析</h2><ul><li>观察者模式描述了如何建立对象与对象之间的依赖关系，如何构造满足这种需求的系统。</li><li>这一模式中的关键对象是观察目标和观察者，一个目标可以有任意数目的与之相依赖的观察者，一旦目标的状态发生改变，所有的观察者都将得到通知。</li><li>作为对这个通知的响应，每个观察者都将即时更新自己的状态，以与目标状态同步，这种交互也称为<strong>发布-订阅</strong>(<code>publish-subscribe</code>)。目标是通知的发布者，它发出通知时并不需要知道谁是它的观察者，可以有任意数目的观察者订阅它并接收通。</li></ul><h3 id="1-优点"><a href="#1-优点" class="headerlink" title="1. 优点"></a>1. 优点</h3><p>观察者模式的优点：</p><ul><li>观察者模式可以实现表示层和数据逻辑层的分离，并定义了稳定的消息更新传递机制，抽象了更新接口，使得可以有各种各样不同的表示层作为具体观察者角色。</li><li>观察者模式在观察目标和观察者之间建立一个抽象的耦合。</li><li>观察者模式支持广播通信。</li><li>观察者模式符合“开闭原则”的要求。</li></ul><h3 id="2-缺点"><a href="#2-缺点" class="headerlink" title="2. 缺点"></a>2. 缺点</h3><p>观察者模式的缺点：</p><ul><li>如果一个观察目标对象有很多直接和间接的观察者的话，将所有的观察者都通知到会花费很多时间。</li><li>如果在观察者和观察目标之间有循环依赖的话，观察目标会触发它们之间进行循环调用，可能导致系统崩溃。</li><li>观察者模式没有相应的机制让观察者知道所观察的目标对象是怎么发生变化的，而仅仅只是知道观察目标发生了变化。</li></ul><h3 id="3-适用环境"><a href="#3-适用环境" class="headerlink" title="3.适用环境"></a>3.适用环境</h3><p>在以下情况下可以使用观察者模式：</p><ul><li>一个抽象模型有两个方面，其中一个方面依赖于另一个方面。将这些方面封装在独立的对象中使它们可以各自独立地改变和复用。</li><li>一个对象的改变将导致其他一个或多个对象也发生改变，而不知道具体有多少对象将发生改变，可以降低对象之间的耦合度。</li><li>一个对象必须通知其他对象，而并不知道这些对象是谁。</li><li>需要在系统中创建一个触发链，A对象的行为将影响B对象，B对象的行为将影响C对象……，可以使用观察者模式创建一种链式触发机制。</li></ul><blockquote><p>观察者模式在软件开发中应用非常广泛，如某电子商务网站可以在执行发送操作后给用户多个发送商品打折信息，某团队战斗游戏中某队友牺牲将给所有成员提示等等，凡是涉及到一对一或者一对多的对象交互场景都可以使用观察者模式。</p></blockquote><h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><ul><li>观察者模式定义对象间的一种一对多依赖关系，使得每当一个对象状态发生改变时，其相关依赖对象皆得到通知并被自动更新。观察者模式又叫做发布-订阅模式、模型-视图模式、源-监听器模式或从属者模式。观察者模式是一种对象行为型模式。</li><li>观察者模式包含四个角色：目标又称为主题，它是指被观察的对象；具体目标是目标类的子类，通常它包含有经常发生改变的数据，当它的状态发生改变时，向它的各个观察者发出通知；观察者将对观察目标的改变做出反应；在具体观察者中维护一个指向具体目标对象的引用，它存储具体观察者的有关状态，这些状态需要和具体目标的状态保持一致。</li><li>观察者模式定义了一种一对多的依赖关系，让多个观察者对象同时监听某一个目标对象，当这个目标对象的状态发生变化时，会通知所有观察者对象，使它们能够自动更新。</li><li>观察者模式的主要优点在于可以实现表示层和数据逻辑层的分离，并在观察目标和观察者之间建立一个抽象的耦合，支持广播通信；其主要缺点在于如果一个观察目标对象有很多直接和间接的观察者的话，将所有的观察者都通知到会花费很多时间，而且如果在观察者和观察目标之间有循环依赖的话，观察目标会触发它们之间进行循环调用，可能导致系统崩溃。</li><li>观察者模式适用情况包括：一个抽象模型有两个方面，其中一个方面依赖于另一个方面；一个对象的改变将导致其他一个或多个对象也发生改变，而不知道具体有多少对象将发生改变；一个对象必须通知其他对象，而并不知道这些对象是谁；需要在系统中创建一个触发链。</li><li>在JDK的<code>java.util</code>包中，提供了<code>Observable</code>类以及<code>Observer</code>接口，它们构成了Java语言对观察者模式的支持。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常用Bash命令整理之其他常用命令</title>
      <link href="/post/ruan-jian-gong-ju/linux/chang-yong-bash-ming-ling-zheng-li-zhi-qi-ta-chang-yong-ming-ling/"/>
      <url>/post/ruan-jian-gong-ju/linux/chang-yong-bash-ming-ling-zheng-li-zhi-qi-ta-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<h2 id="1-hostname-查看主机名"><a href="#1-hostname-查看主机名" class="headerlink" title="1. hostname - 查看主机名"></a>1. hostname - 查看主机名</h2><p><code>hostname</code>命令用于查看系统的主机名，或是修改系统的主机名。</p><p><code>hostname</code>的常用命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 显示系统的当前主机名</span><span class="token function">hostname</span><span class="token comment"># 修改你系统的主机名</span><span class="token function">hostname</span> blinkfox-system<span class="token comment"># 使用 -F 选项，从指定的文件中读取主机名</span><span class="token function">hostname</span> -F /root/hostname.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-uptime-查看系统运行时间"><a href="#2-uptime-查看系统运行时间" class="headerlink" title="2. uptime - 查看系统运行时间"></a>2. uptime - 查看系统运行时间</h2><p><code>uptime</code>命令用于打印系统的运行时间等信息。使用如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">uptime</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="3-w、who-列出登录的用户"><a href="#3-w、who-列出登录的用户" class="headerlink" title="3. w、who - 列出登录的用户"></a>3. w、who - 列出登录的用户</h2><p><code>w</code>命令用于显示登录用户及他们当前运行的进程。输入的内容格式如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">w<span class="token comment"># 打印如下</span><span class="token number">22</span>:42  up <span class="token number">18</span> days, <span class="token number">1</span> hr, <span class="token number">2</span> users, load averages: <span class="token number">1.23</span> <span class="token number">1.79</span> <span class="token number">1.75</span><span class="token environment constant">USER</span>     TTY      FROM              LOGIN@  IDLE WHATblinkfox console  -                日19   6days -blinkfox s000     -                五23       - w<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>who</code>命令有与<code>w</code>命令类似的用途，但它的功能比<code>w</code>命令更强大一些。语法格式如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">who</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>FILE <span class="token operator">|</span> ARG1 ARG2<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>who</code>常用命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 显示当前登录的所有用户信息</span><span class="token function">who</span><span class="token comment"># 显示系统的启动时间</span><span class="token function">who</span> -b<span class="token comment"># 显示系统登录进程</span><span class="token function">who</span> -l<span class="token comment"># 显示与当前标准输入关联的用户信息</span><span class="token function">who</span> -m<span class="token comment"># 显示系统的运行级别</span><span class="token function">who</span> -r<span class="token comment"># 显示所有登录用户的用户名和登录用户数</span><span class="token function">who</span> -q<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-uname-查看系统信息"><a href="#4-uname-查看系统信息" class="headerlink" title="4. uname - 查看系统信息"></a>4. uname - 查看系统信息</h2><p><code>uname</code>命令用于打印内核名称和版本、主机名等系统信息。命令的语法如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">uname</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>常用使用方式如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 只打印内核的名称</span><span class="token function">uname</span><span class="token comment"># 使用 -n 选项，只打印系统的主机名</span><span class="token function">uname</span> -n<span class="token comment"># 使用 -r 选项，打印内核版本信息</span><span class="token function">uname</span> -r<span class="token comment"># 使用 -m 选项，打印系统的硬件名称</span><span class="token function">uname</span> -m<span class="token comment"># 使用 -p 选项，打印系统的处理器类型信息</span><span class="token function">uname</span> -p<span class="token comment"># 使用 -i 选项，打印系统的硬件平台信息</span><span class="token function">uname</span> -i<span class="token comment"># 使用 -a 选项，打印上述所有示例中的信息</span><span class="token function">uname</span> -a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-date-显示和设置系统日期和时间"><a href="#5-date-显示和设置系统日期和时间" class="headerlink" title="5. date - 显示和设置系统日期和时间"></a>5. date - 显示和设置系统日期和时间</h2><p><code>date</code>命令用于以多种格式显示日期和时间，或设置系统的日期和时间。<code>date</code>命令的语法如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">date</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>+FORMAT<span class="token punctuation">]</span><span class="token function">date</span> <span class="token punctuation">[</span>-u<span class="token operator">|</span>--utc<span class="token operator">|</span>--universal<span class="token punctuation">]</span> <span class="token punctuation">[</span>MMDDhhmm<span class="token punctuation">[</span><span class="token punctuation">[</span>CC<span class="token punctuation">]</span>YY<span class="token punctuation">]</span><span class="token punctuation">[</span>.ss<span class="token punctuation">]</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>常用使用命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 以默认格式显示系统的当前日期时间</span><span class="token function">date</span><span class="token comment"># 格式化当前日期</span><span class="token function">date</span> +<span class="token string">"%Y-%m-%d"</span><span class="token comment"># 格式化输出昨天的日期</span><span class="token function">date</span> -d <span class="token string">"1 day ago"</span> +<span class="token string">"%Y-%m-%d"</span><span class="token comment"># 2秒后格式化输出</span><span class="token function">date</span> -d <span class="token string">"2 second"</span> +<span class="token string">"%Y-%m-%d %H:%M.%S"</span><span class="token comment"># 普通格式化转出</span><span class="token function">date</span> -d <span class="token string">"2009-12-12"</span> +<span class="token string">"%Y/%m/%d %H:%M.%S"</span><span class="token comment"># apache格式转换</span><span class="token function">date</span> -d <span class="token string">"Dec 5, 2009 12:00:37 AM"</span> +<span class="token string">"%Y-%m-%d %H:%M.%S"</span><span class="token comment"># 日期加减操作</span><span class="token function">date</span> +%Y%m%d <span class="token comment">#显示前天年月日</span><span class="token function">date</span> -d <span class="token string">"+1 day"</span> +%Y%m%d <span class="token comment">#显示前一天的日期</span><span class="token function">date</span> -d <span class="token string">"-1 day"</span> +%Y%m%d <span class="token comment">#显示后一天的日期</span><span class="token function">date</span> -d <span class="token string">"-1 month"</span> +%Y%m%d <span class="token comment">#显示上一月的日期</span><span class="token function">date</span> -d <span class="token string">"+1 month"</span> +%Y%m%d <span class="token comment">#显示下一月的日期</span><span class="token function">date</span> -d <span class="token string">"-1 year"</span> +%Y%m%d <span class="token comment">#显示前一年的日期</span><span class="token function">date</span> -d <span class="token string">"+1 year"</span> +%Y%m%d <span class="token comment">#显示下一年的日期</span><span class="token comment"># 设定时间</span><span class="token function">date</span> -s <span class="token comment"># 设置当前时间，只有root权限才能设置，其他只能查看</span><span class="token function">date</span> -s <span class="token number">20160816</span> <span class="token comment"># 设置成20160816，这样会把具体时间设置成空00:00:00</span><span class="token function">date</span> -s 01:01:01 <span class="token comment"># 设置具体时间，不会对日期做更改</span><span class="token function">date</span> -s <span class="token string">"01:01:01 2012-05-23"</span> <span class="token comment"># 这样可以设置全部时间 </span><span class="token function">date</span> -s <span class="token string">"01:01:01 20120523"</span> <span class="token comment"># 这样可以设置全部时间</span><span class="token function">date</span> -s <span class="token string">"2012-05-23 01:01:01"</span> <span class="token comment"># 这样可以设置全部时间 </span><span class="token function">date</span> -s <span class="token string">"20120523 01:01:01"</span> <span class="token comment"># 这样可以设置全部时间</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-id-显示用户属性"><a href="#6-id-显示用户属性" class="headerlink" title="6. id - 显示用户属性"></a>6. id - 显示用户属性</h2><p><code>id</code>命令用于打印输出用户<code>uid</code>、<code>gid</code>、用户名和组名等用户身份信息。<code>id</code>命令的语法如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">id</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>USERNAME<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>常见使用命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 输出当前用户的uid、用户名、gid、组名及用户属于的群组信息</span><span class="token function">id</span><span class="token comment"># 使用 -u 选项，输出用户的 uid</span><span class="token function">id</span> -u<span class="token comment">#-u 选项和 -n 选项结合使用，输出账户的用户名</span><span class="token function">id</span> -un<span class="token comment"># 使用 -g 选项，输出帐号当前起作用的gid</span><span class="token function">id</span> -g<span class="token comment"># -g 与 -n 选项结合使用，输出帐号当前起作用的用户组名</span><span class="token function">id</span> -gn<span class="token comment"># 使用 -G 选项，输出帐号所属的所有群组id</span><span class="token function">id</span> -G root<span class="token comment"># -G 与 -n 选项结合使用，输出账号所属的所有群组的名称</span><span class="token function">id</span> -Gn root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 软件工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常用Bash命令整理之文本处理</title>
      <link href="/post/ruan-jian-gong-ju/linux/chang-yong-bash-ming-ling-zheng-li-zhi-wen-ben-chu-li/"/>
      <url>/post/ruan-jian-gong-ju/linux/chang-yong-bash-ming-ling-zheng-li-zhi-wen-ben-chu-li/</url>
      
        <content type="html"><![CDATA[<h2 id="1-sort-文本排序"><a href="#1-sort-文本排序" class="headerlink" title="1. sort - 文本排序"></a>1. sort - 文本排序</h2><p><code>sort</code>命令用于将文本文件的行排序。默认情况下，<code>sort</code>命令是按照字符串的字母顺序排序。</p><p>sort 的常用命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将文本内容按字母顺序排序</span><span class="token function">sort</span> example.txt<span class="token comment"># 使用 -u 选项，移除所有重复行后排序</span><span class="token function">sort</span> -u example.txt<span class="token comment"># 使用 -n 选项，将令数字按数值的大小排序</span><span class="token function">sort</span> -n example.txt<span class="token comment"># 使用 -r 选项，以倒序方式排序</span><span class="token function">sort</span> -n -r example.txt<span class="token comment"># 同时将 file1、file2 的内容排序</span><span class="token function">sort</span> file1 file2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-uniq-文本去重"><a href="#2-uniq-文本去重" class="headerlink" title="2.uniq - 文本去重"></a>2.uniq - 文本去重</h2><p><code>uniq</code>命令用于移除或发现文件中重复的条目。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 它将移除文件中重复的行并显示单一行</span><span class="token function">uniq</span> example.txt<span class="token comment"># 可以统计重复行出现的次数</span><span class="token function">uniq</span> -c example.txt<span class="token comment"># 使用 -d 选项，只显示文件中有重复的行并只显示一次</span><span class="token function">uniq</span> -d example.txt<span class="token comment"># 使用 -D 选项，显示文件中所有重复的行</span><span class="token function">uniq</span> -D example.txt<span class="token comment"># 使用 -u 选项，只显示文件中不重复的行</span><span class="token function">uniq</span> -u example.txt<span class="token comment"># 使用 -w 选项，限制 uniq 命令只比较每行的前 3 个字符是否重复</span><span class="token function">uniq</span> -w <span class="token number">3</span> example.txt<span class="token comment"># 使用 -s 选项，避免 uniq 命令比较每行的前 3 个字符，只比较后面的字符是否重复</span><span class="token function">uniq</span> -s <span class="token number">3</span> example.txt<span class="token comment"># 使用 -f 选项，避免 uniq 命令比较第一列的内容，只比较后面的字符是否重复</span><span class="token function">uniq</span> -f <span class="token number">1</span> example.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-tr-替换或删除字符"><a href="#3-tr-替换或删除字符" class="headerlink" title="3.tr - 替换或删除字符"></a>3.tr - 替换或删除字符</h2><p><code>tr</code>命令主要用于删除文件中控制字符或进行字符转换。使用<code>tr</code>时要转换两个字符串：字符串 1 用于查询，字符串 2 用于处理各种转换。<code>tr</code>刚执行时，字符串 1 中的字符被映射到字符串 2 中的字符，然后转换操作开始。</p><p><code>tr</code>命令的语法如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tr</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. SET1 <span class="token punctuation">[</span>SET2<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>常用命令示例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 若要将大括号转换为小括号</span><span class="token function">tr</span> <span class="token string">'&#123;&#125;'</span> <span class="token string">'()'</span> <span class="token operator">&lt;</span> textfile <span class="token operator">></span> newfile<span class="token comment"># 若要将大括号转换成方括号</span><span class="token function">tr</span> <span class="token string">'&#123;&#125;'</span> <span class="token string">'\[]'</span> <span class="token operator">&lt;</span> textfile <span class="token operator">></span> newfile<span class="token comment"># 若要将小写字符转换成大写，请输入：</span><span class="token function">tr</span> <span class="token string">'a-z'</span> <span class="token string">'A-Z'</span> <span class="token operator">&lt;</span> textfile <span class="token operator">></span> newfile<span class="token comment"># 若要创建一个文件中的单词列表</span><span class="token function">tr</span> -cs <span class="token string">'[:lower:][:upper:]'</span> <span class="token string">'[\n*]'</span> <span class="token operator">&lt;</span> textfile <span class="token operator">></span> newfile<span class="token comment"># 若要从某个文件中删除所有空字符</span><span class="token function">tr</span> -d <span class="token string">'\0'</span> <span class="token operator">&lt;</span> textfile <span class="token operator">></span> newfile<span class="token comment"># 若要用单独的换行替换每一序列的一个或多个换行，请输入：</span><span class="token function">tr</span> -s <span class="token string">'\n'</span> <span class="token operator">&lt;</span> textfile <span class="token operator">></span> newfile<span class="token comment"># 要以单个“#”字符替换 &lt;space> 字符类中的每个字符序列</span><span class="token function">tr</span> -s <span class="token string">'[:space:]'</span> <span class="token string">'[#*]'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-grep-查找字符串"><a href="#4-grep-查找字符串" class="headerlink" title="4.grep - 查找字符串"></a>4.grep - 查找字符串</h2><p><code>grep</code>命令用于搜索文本或指定的文件中与指定的字符串或模式相匹配的行。默认情况下，<code>grep</code>命令只显示匹配的行。</p><p><code>grep</code>命令的语法如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">grep</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. PATTERN <span class="token punctuation">[</span>FILE<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span class="token function">grep</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>-e PATTERN <span class="token operator">|</span> -f FILE<span class="token punctuation">]</span> <span class="token punctuation">[</span>FILE<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># `grep`命令查找文件/etc/passwd 中帐号 blinkfox 的信息</span><span class="token function">grep</span> blinkfox /etc/passwd<span class="token comment"># 使用 -i 选项，强制 grep 命令忽略搜索关键字的大小写</span><span class="token function">grep</span> -i blinkfox /etc/passwd<span class="token comment"># 使用 -r 选项，可以递归搜索指定目录下的所有文件</span><span class="token function">grep</span> -r blinkfox /etc/<span class="token comment"># 使用 -w 选项，只匹配包含指定单词的行</span><span class="token function">grep</span> -w blinkfox /etc/<span class="token comment"># 使用 -c 选项，报告文件或文本中模式被匹配的次数</span><span class="token function">grep</span> -c blinkfox /etc/passwd<span class="token comment"># 使用 -n 选项，显示每一个匹配的行的行号</span><span class="token function">grep</span> -n blinkfox /etc/passwd<span class="token comment"># 使用 -v 选项，可以输出除匹配指定模式的行以外的其他所有行</span><span class="token function">grep</span> -v blinkfox /etc/passwd<span class="token comment"># 使用 --color 选项，在输出中将匹配的字符串以彩色的形式标出</span><span class="token function">grep</span> --color blinkfox /etc/passwd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-diff-比较两个文件"><a href="#5-diff-比较两个文件" class="headerlink" title="5.diff - 比较两个文件"></a>5.diff - 比较两个文件</h2><p><code>diff</code>命令用于比较两个文件，并找出它们之间的不同。<code>diff</code>命令的语法如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">diff</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. from-file to-file<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>常用使用方式如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 比较两个文件</span><span class="token function">diff</span> nsswitch.conf nsswitch.conf.org<span class="token comment"># 使用 -w 选项，比较时忽略空格</span><span class="token function">diff</span> -w nsswitch.conf nsswitch.conf.org<span class="token comment"># 使用 -y 选项，以并排的格式输出两个文件的比较结果</span><span class="token function">diff</span> -y nsswitch.conf nsswitch.conf.org使用 -c 选项，以上下对比的格式输出两个文件的比较结果<span class="token function">diff</span> -c nsswitch.conf nsswitch.conf.org<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 软件工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常用Bash命令整理之操作文件和目录</title>
      <link href="/post/ruan-jian-gong-ju/linux/chang-yong-bash-ming-ling-zheng-li-zhi-cao-zuo-wen-jian-he-mu-lu/"/>
      <url>/post/ruan-jian-gong-ju/linux/chang-yong-bash-ming-ling-zheng-li-zhi-cao-zuo-wen-jian-he-mu-lu/</url>
      
        <content type="html"><![CDATA[<h2 id="1-touch-创建文件"><a href="#1-touch-创建文件" class="headerlink" title="1. touch - 创建文件"></a>1. touch - 创建文件</h2><p><code>touch</code>命令就可用于创建、变更和修改文件的时间戳。它是 Linux 操作系统的标准程序。<code>touch</code>命令又如下选项：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-a: 只改变访问时间 -c: 不创建任何文件-m: 只改变修改时间-r: 使用指定文件的时间替代当前时间-t: 使用 <span class="token punctuation">[</span><span class="token punctuation">[</span>CC<span class="token punctuation">]</span>YY<span class="token punctuation">]</span>MMDDhhmm<span class="token punctuation">[</span>.ss<span class="token punctuation">]</span> 替代当前时间<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>touch 命令的常见用法如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建一个名为 effyl 的新空文件</span><span class="token function">touch</span> effyl<span class="token comment"># 同时创建名称分别为 effyl myeffyl lueffyl 的三个文件</span><span class="token function">touch</span> effyl myeffyl lueffyl<span class="token comment"># 使用 -a 选项，可以改变或更新文件的最新访问时间，如果文件 effyl 不存在，则新创建一个</span><span class="token function">touch</span> -a effyl<span class="token comment"># 使用 -c 选项，可以避免创建一个新文件，并用当前时间更新文件的时间戳</span><span class="token function">touch</span> -c effyl<span class="token comment"># 使用 -m 选项，可以只改变文件的修改时间，而访问时间不变</span><span class="token function">touch</span> -m effyl<span class="token comment"># 使用 -c 和 -t 选项，来明确设置文件的时间</span><span class="token function">touch</span> -c -t YYMMDDHHMM filename<span class="token comment"># 如果想使用文件 myeffyl 的时间戳更新文件 effyl 的时间戳，可以使用 -r 选项</span><span class="token function">touch</span> -r myeffyl effyl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-mkdir-创建目录"><a href="#2-mkdir-创建目录" class="headerlink" title="2.mkdir - 创建目录"></a>2.mkdir - 创建目录</h2><p><code>mkdir</code>命令用于创建一个新目录。最基本的<code>mkdir</code>命令的使用方法如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在当前目录下创建一个给定的目录名</span><span class="token function">mkdir</span> <span class="token operator">&lt;</span>dirname<span class="token operator">></span><span class="token comment"># 在 backup 中的相对路径创建一个名为 old 的目录</span><span class="token function">mkdir</span> backup/old<span class="token comment"># 在 backup 中的绝对路径中创建一个名为 old 的目录</span><span class="token function">mkdir</span> /home/blinkfox/backup/old<span class="token comment"># 使用 -p 选项，会自动创建所有还不存在的父目录</span><span class="token function">mkdir</span> -p backup/old<span class="token comment"># 使用 -m 选项，可以设置将要创建目录的权限</span><span class="token comment"># 如：创建一个任何人都有读写访问权限的目录</span><span class="token function">mkdir</span> -p -m <span class="token number">777</span> backup/old<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-cp-复制文件或目录"><a href="#3-cp-复制文件或目录" class="headerlink" title="3.cp - 复制文件或目录"></a>3.cp - 复制文件或目录</h2><p><code>cp</code>命令用于将文件从一个地方复制到另一个地方。原来的文件保持不变，新文件可能保持原名或用一个不同的名字。</p><p>使用 cp 命令复制文件和目录的语法有以下几种：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 复制源文件到目标文件</span><span class="token function">cp</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span> SOURCE DEST<span class="token comment"># 复制一个或多个源文件到一个目录</span><span class="token function">cp</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span> SOURCE<span class="token punctuation">..</span>. DIRECTORY<span class="token comment"># 同上</span><span class="token function">cp</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span> -t DIRECTORY SOURCE<span class="token punctuation">..</span>. <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>常用使用示例如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在当前目录下，创建一个文件 file.txt 的副本，取名为 newfile.txt</span><span class="token function">cp</span> file.txt newfile.txt<span class="token comment"># 复制当前目录下的 file.txt 文件到 /tmp 目录下</span><span class="token function">cp</span> file.txt /tmp<span class="token comment"># 复制当前目录下的所有文件到 /tmp 目录下</span><span class="token function">cp</span> * /tmp<span class="token comment"># 使用 -p 选项，可以使复制一个文件到新文件时，保留源文件的所有者、权限等信息</span><span class="token function">cp</span> -p filename /path/to/new/location/myfile<span class="token comment"># 使用 -R 或 -r 选项，恶意递归地复制一个目录</span><span class="token comment"># 即将一个目录及其下的所有文件和子目录都复制到另一个目录</span><span class="token function">cp</span> -R * /home/blinkfox/backup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-ln-链接文件或目录"><a href="#4-ln-链接文件或目录" class="headerlink" title="4.ln - 链接文件或目录"></a>4.ln - 链接文件或目录</h2><p><code>ln</code>命令用于创建软链接或硬链接。使用 -s 选项，可以创建一个软链接：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在目录 lib 下创建一个软链接 library.so，链接到 /home/blinkfox/src/library.so</span><span class="token function">ln</span> -s /home/blinkfox/src/library.so /home/blinkfox/lib<span class="token comment"># 创建目录的软链接</span><span class="token function">ln</span> -s /home/blinkfox/src <span class="token builtin class-name">source</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-mv-移动文件或目录"><a href="#5-mv-移动文件或目录" class="headerlink" title="5. mv - 移动文件或目录"></a>5. mv - 移动文件或目录</h2><p><code>mv</code>命令用于将文件和目录从一个位置移到另外一个位置。除了移动文件，<code>mv</code>命令还可用于修改文件或目录的名字。</p><p>mv 命令的基本语法如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mv</span> SOURCE<span class="token punctuation">..</span>. DIRECTORY<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>常用命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将当前目录下的文件 source.txt 移到目录 /tmp 下</span><span class="token function">mv</span> source.txt /tmp<span class="token comment"># 将目录 dir1、dir2 移到目录 dir_dist 下</span><span class="token function">mv</span> dir1 dir2 dir_dist<span class="token comment"># 将当前目录下的 old.txt 文件更名为 new.txt</span><span class="token function">mv</span> old.txt new.txt<span class="token comment"># 使用 -i 选项，在重写覆盖目标文件或目录之前给出提示信息</span><span class="token function">mv</span> -i old.txt new.txt<span class="token comment"># 将当前目录下的所有文件移动到目录 /tmp 下</span><span class="token function">mv</span> * /tmp/<span class="token comment"># 使用 -i 选项，从 dir1 中移动那些在目标目录中不存在的文件到目标目录</span><span class="token function">mv</span> -u dir1/* dir2/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-rm-删除文件或目录"><a href="#6-rm-删除文件或目录" class="headerlink" title="6.rm - 删除文件或目录"></a>6.rm - 删除文件或目录</h2><p><code>rm</code>命令用于删除指定的文件和目录。其语法如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rm</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span><span class="token punctuation">..</span>. FILE<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>rm</code>的常用命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 删除当前目录下的文件 file1.txt、file2.txt、file3.txt</span><span class="token function">rm</span> file1.txt file2.txt file3.txt<span class="token comment"># 删除当前目录下的所有文件</span><span class="token function">rm</span> *<span class="token comment"># 删除你当前帐号主目录下的 temp 目录中的所有文件</span><span class="token function">rm</span> ~/temp/*<span class="token comment"># 使用 -i 选项，可以在删除每个文件或目录前提示用户确认</span><span class="token function">rm</span> -i *<span class="token comment"># 删除当前目录下所有以".doc"结尾的文件</span><span class="token function">rm</span> *.doc<span class="token comment"># 删除当前目录下所有文件名中包含"movie"字符串的文件</span><span class="token function">rm</span> *movie*<span class="token comment"># 删除当前目录下所有以"a"开头的文件</span><span class="token function">rm</span> a*<span class="token comment"># 删除当前目录下整个文件名（包括扩展名）只有 3 个字符的所有文件</span><span class="token function">rm</span> ???<span class="token comment"># 删除当前目录下文件扩展名有两个字符的所有文件</span><span class="token function">rm</span> *.??<span class="token comment"># 删除当前目录下文件名中含有字母 a 或 b 或 c 的所有文件</span><span class="token function">rm</span> *<span class="token punctuation">[</span>abc<span class="token punctuation">]</span>*<span class="token comment"># 删除当前目录下文件名中包含 0~9 的所有文件</span><span class="token function">rm</span> *<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>*<span class="token comment"># 删除当前目录下文件扩展名是字母 c 或 h 的所有文件</span><span class="token function">rm</span> *.<span class="token punctuation">[</span>ch<span class="token punctuation">]</span><span class="token comment"># 删除 /tmp 目录下的所有文件及其子目录</span><span class="token function">rm</span> -rf /tmp/*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>-f 删除前不提示用户确认，并忽略不存在的文件</p></blockquote><blockquote><p>-r 递归地删除目录及其下的内容</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 软件工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常用Bash命令整理之查看文件和目录</title>
      <link href="/post/ruan-jian-gong-ju/linux/chang-yong-bash-ming-ling-zheng-li-zhi-cha-kan-wen-jian-he-mu-lu/"/>
      <url>/post/ruan-jian-gong-ju/linux/chang-yong-bash-ming-ling-zheng-li-zhi-cha-kan-wen-jian-he-mu-lu/</url>
      
        <content type="html"><![CDATA[<h2 id="1-ls-列出文件名和目录"><a href="#1-ls-列出文件名和目录" class="headerlink" title="1. ls - 列出文件名和目录"></a>1. ls - 列出文件名和目录</h2><p><code>ls</code>命令是<code>Linux</code>中最常用的命令之一，其作用就是列出文件名和目录。在命令行提示符下，直接输入<code>ls</code>命令，不带任何选项，将列出当前目录下所有文件和目录，但不会显示详细的信息，比如，文件类型、大小、修改日期和时间、权限等。</p><p>以下便是<code>ls</code>命令及其选项的作用说明：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 仅列出当前目录下所有文件和目录</span><span class="token function">ls</span><span class="token comment"># 每行显示一条记录，每条记录包括文件类型、大小、修改日期和时间、权限等</span><span class="token function">ls</span> -l<span class="token comment"># 将文件大小显示符合人类阅读习惯的格式</span><span class="token function">ls</span> -lh<span class="token comment"># 将使用不同的特殊字符归类不同的文件类型</span><span class="token function">ls</span> -F<span class="token comment"># 以长列表格式列出某个目录的信息</span><span class="token function">ls</span> -ld /var/log<span class="token comment"># 将递归地列出子目录的内容</span><span class="token function">ls</span> -R /etc/sysconfig/<span class="token comment"># 以长列表格式按文件或目录的修改时间倒序地列出文件和目录</span><span class="token function">ls</span> -ltr<span class="token comment"># 以长列表格式按文件大小顺序列出文件和目录</span><span class="token function">ls</span> -ls<span class="token comment"># 列出包括隐藏文件或目录在内的所有文件和目录，包括“.”（当前目录）和“..”（父目录）</span><span class="token function">ls</span> -a<span class="token comment"># 列出包括隐藏文件或目录在内的所有文件和目录，不包括“.”（当前目录）和“..”（父目录）</span><span class="token function">ls</span> -A输出的内容类似于-l选项，指示显示uid和gid，替代显示所有者和用户组<span class="token function">ls</span> -n<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-cat-连接显示文件内容"><a href="#2-cat-连接显示文件内容" class="headerlink" title="2. cat - 连接显示文件内容"></a>2. cat - 连接显示文件内容</h2><p><code>cat</code> 命令也是Linux系统中最常用的命令之一。<code>cat</code>命令让我们可以看看文件的内容、连接文件、创建一个或多个文件和重定向输出到终端或文件。</p><p><code>cat</code>命令的语法如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span> <span class="token punctuation">[</span>FILE<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>cat</code>常用命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用 cat 命令查看文件 /etc/group 的内容</span><span class="token function">cat</span> /etc/group<span class="token comment"># 显示多个文件的内容</span><span class="token function">cat</span> /etc/redhat-release /etc/issue<span class="token comment"># -n 选项，可以显示文件内容的行号</span><span class="token function">cat</span> -n /etc/fstab<span class="token comment"># -b 选项和 -n 选项类似，但只标识非空白行的行号</span><span class="token function">cat</span> -b /etc/fstab<span class="token comment"># -e 选项，将在每一行的结尾显示“$”字符</span><span class="token function">cat</span> -e /etc/fstab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>当你只输入 cat 命令，而没有任何参数时，它只是接收标准输入的内容并在标准输出中显示。所以你在输入一行内容并回车后，会在接下来的一行显示相同的内容。你也可以重定向标准输出到一个新文件。</p></blockquote><h2 id="3-less、more-分屏显示文件"><a href="#3-less、more-分屏显示文件" class="headerlink" title="3.less、more - 分屏显示文件"></a>3.less、more - 分屏显示文件</h2><p><code>more</code>命令在你使用小的xterm窗口时，或是想不使用文本编辑器而只是简单地阅读一个文件时是很有用的。more命令是一个用于一次翻阅一整屏文件的过滤器。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看一个文件，自动清空屏幕并显示文件开头部分</span><span class="token function">more</span> /etc/inittab<span class="token comment"># 指定一次显示num行</span><span class="token function">more</span> -num /etc/inittab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>与<code>more</code>命令相比，我个人更喜欢<code>less</code>命令来查看文件。<code>less</code>命令与<code>more</code>命令类似，但<code>less</code>命令向前和向后翻页都支持，而且<code>less</code>命令不需要在查看前加载整个文件，即<code>less</code>命令查看文件更快速。</p><p><code>less</code>常用命令参数如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-b  <span class="token operator">&lt;</span>缓冲区大小<span class="token operator">></span> 设置缓冲区的大小-e  当文件显示结束后，自动离开-f  强迫打开特殊文件，例如外围设备代号、目录和二进制文件-g  只标志最后搜索的关键词-i  忽略搜索时的大小写-m  显示类似more命令的百分比-N  显示每行的行号-o  <span class="token operator">&lt;</span>文件名<span class="token operator">></span> 将less 输出的内容在指定文件中保存起来-Q  不使用警告音-s  显示连续空行为一行-S  行过长时间将超出部分舍弃-x  <span class="token operator">&lt;</span>数字<span class="token operator">></span> 将“tab”键显示为规定的数字空格/字符串：向下搜索“字符串”的功能?字符串：向上搜索“字符串”的功能n： 重复前一个搜索（与 / 或 ? 有关）N： 反向重复前一个搜索（与 / 或 ? 有关）b  向后翻一页d  向后翻半页h  显示帮助界面Q  退出less 命令u  向前滚动半页y  向前滚动一行空格键 滚动一行回车键 滚动一页<span class="token punctuation">[</span>pagedown<span class="token punctuation">]</span>： 向下翻动一页<span class="token punctuation">[</span>pageup<span class="token punctuation">]</span>：   向上翻动一页<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-head-显示文件头部"><a href="#4-head-显示文件头部" class="headerlink" title="4.head - 显示文件头部"></a>4.head - 显示文件头部</h2><p><code>head</code>命令用于打印指定输入的开头部分内容。默认情况下，打印每个指定输入的前10行内容。</p><p>使用<code>-n</code>选项可以指定打印文件的前N行：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 指定打印文件的前5行</span><span class="token function">head</span> -n <span class="token number">5</span> /etc/inittab（或）head -5 /etc/inittab<span class="token comment"># 打印文件的前N个字节的数据</span><span class="token function">head</span> -c <span class="token number">10</span> /etc/inittab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-tail-显示文件尾部"><a href="#5-tail-显示文件尾部" class="headerlink" title="5.tail - 显示文件尾部"></a>5.tail - 显示文件尾部</h2><p><code>tail</code>命令和<code>head</code>命令相反，它打印指定输入的结尾部分的内容。默认情况下，它打印指定输入的最后10行内容。</p><p>使用<code>-n</code>选项可以指定打印文件的最后N行：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 指定打印文件的后10行</span><span class="token function">tail</span> -n <span class="token number">10</span> /etc/inittab<span class="token function">tail</span> -10 /etc/inittab<span class="token comment"># 即时打印文件中新写入的行</span><span class="token function">tail</span> -f /var/log/messages<span class="token comment"># --retry选项表示持续尝试打开某个文件，当你想打开一个稍后才会创建或即使不可用的文件</span><span class="token function">tail</span> -f /tmp/debug.log --retry<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-file-查看文件类型"><a href="#6-file-查看文件类型" class="headerlink" title="6.file - 查看文件类型"></a>6.file - 查看文件类型</h2><p><code>file</code>命令用于接收一个文件作为参数并执行某些测试，已确定正确的文件类型。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看文件类型</span><span class="token function">file</span> /etc/inittab<span class="token comment"># 可以MIME类型的格式显示文件类型的信息</span><span class="token function">file</span> -i  /etc/inittab<span class="token comment"># 使用-N 选项，输出的队列可以以在文件名之后无空白填充的形式显示</span><span class="token function">file</span> -N *<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7-wc-查看文件统计信息"><a href="#7-wc-查看文件统计信息" class="headerlink" title="7.wc - 查看文件统计信息"></a>7.wc - 查看文件统计信息</h2><p><code>wc</code>命令用于查看文件的行数、单词数和字符数等信息。语法类似如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wc</span> filenameX Y Z /etc/inittab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>其中X表示行数，Y表示单词数，Z表示字节数，filename表示文件名。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># -l选项，可以只统计文件的行数信息</span><span class="token function">wc</span> -l /etc/inittab<span class="token comment"># -w选项，可以只统计文件的单词数信息</span><span class="token function">wc</span> -w /etc/inittab<span class="token comment"># -c选项，可以只统计文件的字节数信息</span><span class="token function">wc</span> -c /etc/inittab<span class="token comment"># -L选项，可以只统计文件中最长的行的长度</span><span class="token function">wc</span> -L /etc/inittab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8-find-查找文件或目录"><a href="#8-find-查找文件或目录" class="headerlink" title="8.find - 查找文件或目录"></a>8.find - 查找文件或目录</h2><p><code>find</code>命令用于根据你指定的参数搜索和定位文件和目录的列表。<code>find</code>命令可以在多种情况下使用，比如你可以通过权限、用户、用户组、文件类型、日期、大小和其他可能的条件来查找文件。</p><p><code>find</code>命令常用使用和说明如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查找指定目录下的某个文件</span><span class="token function">find</span> /etc/ -name inittab<span class="token comment"># 在当前目录下查找名称为 inittab 的文件</span><span class="token function">find</span> <span class="token builtin class-name">.</span> -name inittab<span class="token comment"># 在当前目录下，文件不区分大小写是example的所有文件</span><span class="token function">find</span> <span class="token builtin class-name">.</span> -iname example<span class="token comment"># 找出当前目录下所有以 sh 结尾的文件</span><span class="token function">find</span> <span class="token builtin class-name">.</span> -type f -name <span class="token string">"*.sh"</span><span class="token comment"># 找出当前目录下，文件权限是 777 的所有文件</span><span class="token function">find</span> <span class="token builtin class-name">.</span> -type f -perm <span class="token number">777</span><span class="token comment"># 找出当前目录下，文件权限不是 777 的所有文件</span><span class="token function">find</span> <span class="token builtin class-name">.</span> -type f <span class="token operator">!</span> -perm <span class="token number">777</span><span class="token comment"># 找出当前目录下所有只读文件</span><span class="token function">find</span> <span class="token builtin class-name">.</span> -type f <span class="token operator">!</span> -perm /a+w<span class="token comment"># 找出你帐号主目录下的所有可执行文件</span><span class="token function">find</span> ~ -type f -perm /a+w<span class="token comment"># 找出 /tmp 目录下的.log文件并将其删除：</span><span class="token function">find</span> /tmp/ -type f -name <span class="token string">"*.log"</span> -exec <span class="token function">rm</span> -f <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">\</span><span class="token punctuation">;</span><span class="token comment"># 找出当前目录下的所有空文件</span><span class="token function">find</span> <span class="token builtin class-name">.</span> -type f -empty<span class="token comment"># 找出当前目录下的所有空目录</span><span class="token function">find</span> <span class="token builtin class-name">.</span> -type d -empty<span class="token comment"># 找出 /tmp 目录下的所有隐藏文件</span><span class="token function">find</span> /tmp/ -type f -name <span class="token string">".*"</span><span class="token comment"># 找出 /tmp 目录下，所有者是 root 的文件和目录</span><span class="token function">find</span> /tmp/ -user root<span class="token comment"># 找出 /tmp 目录下，用户组是 developer 的文件和目录</span><span class="token function">find</span> /tmp/ -group root<span class="token comment"># 找出你账号的主目录下，3 天前修改的文件</span><span class="token function">find</span> ~ -type f -mtime <span class="token number">3</span><span class="token comment"># 找出你账号的主目录下，30 天以前修改的所有文件</span><span class="token function">find</span> ~ -type f -mtime +30<span class="token comment"># 找出你账号的主目录下，3 天以内修改的所有文件</span><span class="token function">find</span> ~ -type f -mtime -3<span class="token comment"># 找出你账号的主目录下，30 天以前，60 天以内修改的所有文件</span><span class="token function">find</span> ~ -type f -mtime +30 -mtime -60<span class="token comment"># 找出 /etc 目录下，一小时以内变更过的文件</span><span class="token function">find</span> /etc -type f -cmin -60<span class="token comment"># 找出 /etc 目录下，一小时以内访问过的文件</span><span class="token function">find</span> /etc -type f -amin -60<span class="token comment"># 找出你账号主目录下，大小是50MB的所有文件</span><span class="token function">find</span> ~ -type f -size 50MB<span class="token comment"># 找出你账号主目录下，大于50MB小于100MB的所有文件</span><span class="token function">find</span> ~ -type f -size +50MB -size -100MB<span class="token comment"># 找出你账号主目录下，大于100MB的文件并将其删除</span><span class="token function">find</span> ~ -type f -size +100MB -exec <span class="token function">rm</span> -rf <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">\</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 软件工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>轻量级滚动动画JavaScript库aos.js</title>
      <link href="/post/qian-duan/qing-liang-ji-gun-dong-dong-hua-javascript-ku-aos.js/"/>
      <url>/post/qian-duan/qing-liang-ji-gun-dong-dong-hua-javascript-ku-aos.js/</url>
      
        <content type="html"><![CDATA[<h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p><a href="http://michalsnik.github.io/aos/">aos.js</a>是一款效果超赞的页面滚动的 JavaScript 动画库插件。该动画库可以在页面滚动时提供28种不同的元素动画效果，以及多种<code>easing</code>效果。在页面往回滚动时，元素会恢复到原来的状态。</p><p><img src="https://statics.sh1a.qingstor.com/2018/10/08/aos.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/10/08/aos.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="AOS"></p><blockquote><p>注：从<code>2.0.0</code>版本之后,只支持使用<code>data-aos</code>属性，不再支持使用<code>aos</code>属性。</p></blockquote><h2 id="二、安装"><a href="#二、安装" class="headerlink" title="二、安装"></a>二、安装</h2><h3 id="1-Bower-安装"><a href="#1-Bower-安装" class="headerlink" title="1. Bower 安装"></a>1. Bower 安装</h3><p>你可以使用 <a href="https://bower.io/">Bower</a> 包管理工具安装<code>aos</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bower <span class="token function">install</span> aos --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-npm"><a href="#2-npm" class="headerlink" title="2. npm"></a>2. npm</h3><p>你也能在 <a href="https://www.npmjs.com/">npm</a> 上找到 <code>aos</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> aos --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-Github-下载"><a href="#3-Github-下载" class="headerlink" title="3. Github 下载"></a>3. Github 下载</h3><p>Github 下载点击<a href="https://github.com/michalsnik/aos/archive/master.zip">此处</a></p><h2 id="三、使用示例"><a href="#三、使用示例" class="headerlink" title="三、使用示例"></a>三、使用示例</h2><h3 id="1-使用方法"><a href="#1-使用方法" class="headerlink" title="1. 使用方法"></a>1. 使用方法</h3><p>引入<code>CSS</code>样式文件：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bower_components/aos/dist/aos.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>添加<code>JavaScript</code>脚本文件：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bower_components/aos/dist/aos.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>初始化载入<code>AOS</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token constant">AOS</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="2-简单示例"><a href="#2-简单示例" class="headerlink" title="2. 简单示例"></a>2. 简单示例</h3><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">&#123;</span>    <span class="token property">font-family</span><span class="token punctuation">:</span> Helvetica<span class="token punctuation">,</span>Tahoma<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">*,*:before,*:after</span> <span class="token punctuation">&#123;</span>    <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.aos-all</span> <span class="token punctuation">&#123;</span>    <span class="token property">width</span><span class="token punctuation">:</span> 1000px<span class="token punctuation">;</span>    <span class="token property">max-width</span><span class="token punctuation">:</span> 98%<span class="token punctuation">;</span>    <span class="token property">margin</span><span class="token punctuation">:</span> 10vh auto 0 auto<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.aos-item</span> <span class="token punctuation">&#123;</span>    <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>    <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>    <span class="token property">width</span><span class="token punctuation">:</span> 33.3333%<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>    <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.aos-item__inner</span> <span class="token punctuation">&#123;</span>    <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>    <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>    <span class="token property">background</span><span class="token punctuation">:</span> #1da4e2<span class="token punctuation">;</span>    <span class="token property">line-height</span><span class="token punctuation">:</span> 260px<span class="token punctuation">;</span>    <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>    <span class="token property">color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token atrule"><span class="token rule">@media</span> screen <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 800px<span class="token punctuation">)</span></span> <span class="token punctuation">&#123;</span>    <span class="token selector">.aos-item</span> <span class="token punctuation">&#123;</span>        <span class="token property">width</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>AOS的简单示例<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos/aos.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos_test.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">initLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>transcroller<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-all<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-up<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-down<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zoom-out-down<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>flip-down<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>flip-up<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-down<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-down<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-down<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-up<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-down<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>13<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-up<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>14<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>15<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-up<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>16<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-down<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-up<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>18<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zoom-out<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>19<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-up<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zoom-out<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>21<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zoom-out-up<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>23<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zoom-out-down<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>24<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>26<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>27<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>28<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>29<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>31<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>32<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>33<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>34<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>35<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>36<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>37<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>38<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>39<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>40<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>41<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item<span class="token punctuation">"</span></span> <span class="token attr-name">data-aos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fade-in<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-item__inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>42<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos/aos.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token keyword">function</span> <span class="token function">initLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token constant">AOS</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-异步示例"><a href="#3-异步示例" class="headerlink" title="3. 异步示例"></a>3. 异步示例</h3><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>AOS 异步使用的示例<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos_test.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">initLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos_async<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos-all<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aos.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token keyword">function</span> <span class="token function">initLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token constant">AOS</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 0.5秒执行一次</span>    <span class="token function">setInterval</span><span class="token punctuation">(</span>addItem<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> itemsCounter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'aos_async'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 动态生成的div元素     */</span>    <span class="token keyword">function</span> <span class="token function">addItem</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>itemsCounter <span class="token operator">></span> <span class="token number">42</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> item <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        item<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'aos-item'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        item<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'data-aos'</span><span class="token punctuation">,</span> <span class="token string">'fade-up'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        item<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;div class="aos-item__inner">&lt;h3>'</span> <span class="token operator">+</span> itemsCounter <span class="token operator">+</span> <span class="token string">'&lt;/h3>&lt;/div>'</span><span class="token punctuation">;</span>        container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>        itemsCounter<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="四、动画样式"><a href="#四、动画样式" class="headerlink" title="四、动画样式"></a>四、动画样式</h2><p>以下是<code>AOS</code>已经提供了的多种动画：</p><h3 id="1-Fade-animations"><a href="#1-Fade-animations" class="headerlink" title="1. Fade animations"></a>1. Fade animations</h3><ul><li>fade-up</li><li>fade-down</li><li>fade-left</li><li>fade-right</li><li>fade-up-right</li><li>fade-up-left</li><li>fade-down-right</li><li>fade-down-left</li></ul><h3 id="2-Flip-animations"><a href="#2-Flip-animations" class="headerlink" title="2. Flip animations"></a>2. Flip animations</h3><ul><li>flip-up</li><li>flip-down</li><li>flip-left</li><li>flip-right</li></ul><h3 id="3-Slide-animations"><a href="#3-Slide-animations" class="headerlink" title="3. Slide animations"></a>3. Slide animations</h3><ul><li>slide-up</li><li>slide-down</li><li>slide-left</li><li>slide-right</li></ul><h3 id="4-Zoom-animations"><a href="#4-Zoom-animations" class="headerlink" title="4. Zoom animations"></a>4. Zoom animations</h3><ul><li>zoom-in</li><li>zoom-in-up</li><li>zoom-in-down</li><li>zoom-in-left</li><li>zoom-in-right</li><li>zoom-out</li><li>zoom-out-up</li><li>zoom-out-down</li><li>zoom-out-left</li><li>zoom-out-right</li></ul><h3 id="5-Anchor-placement"><a href="#5-Anchor-placement" class="headerlink" title="5. Anchor placement"></a>5. Anchor placement</h3><ul><li>top-bottom</li><li>top-center</li><li>top-top</li><li>center-bottom</li><li>center-center</li><li>center-top</li><li>bottom-bottom</li><li>bottom-center</li><li>bottom-top</li></ul><h2 id="五、Easing-函数"><a href="#五、Easing-函数" class="headerlink" title="五、Easing 函数"></a>五、Easing 函数</h2><p>你可以选择以下任意一个时间函数来做出很好的做动画元素：</p><ul><li>linear</li><li>ease</li><li>ease-in</li><li>ease-out</li><li>ease-in-out</li><li>ease-in-back</li><li>ease-out-back</li><li>ease-in-out-back</li><li>ease-in-sine</li><li>ease-out-sine</li><li>ease-in-out-sine</li><li>ease-in-quad</li><li>ease-out-quad</li><li>ease-in-out-quad</li><li>ease-in-cubic</li><li>ease-out-cubic</li><li>ease-in-out-cubic</li><li>ease-in-quart</li><li>ease-out-quart</li><li>ease-in-out-quart</li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>全功能JavaScript灯箱画廊插件lightgallery.js</title>
      <link href="/post/qian-duan/quan-gong-neng-javascript-deng-xiang-hua-lang-cha-jian-lightgallery.js/"/>
      <url>/post/qian-duan/quan-gong-neng-javascript-deng-xiang-hua-lang-cha-jian-lightgallery.js/</url>
      
        <content type="html"><![CDATA[<h3 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h3><blockquote><p><a href="https://sachinchoolur.github.io/lightgallery.js/">lightgallery.js</a> 是一个全功能、轻量级、无依赖的灯箱画廊显示库。</p></blockquote><p><img src="https://statics.sh1a.qingstor.com/2018/10/06/lg.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/10/06/lg.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="lightgallery"></p><h3 id="二、主要特性"><a href="#二、主要特性" class="headerlink" title="二、主要特性"></a>二、主要特性</h3><ul><li>全响应式兼容</li><li>模块化的架构和内置插件</li><li>移动设备和触摸支持</li><li>桌面设备拖拽支持</li><li>双击查看图像的实际大小</li><li>动画缩略图</li><li>社交媒体分享</li><li>YouTube，Vimeo，DailyMotion，VK和 HTML5 视频支持</li><li>20+ 硬件加速CSS3过渡</li><li>全屏支持</li><li>支持缩放</li><li>浏览器历史记录</li><li>响应式图像</li><li>HTML iframe 支持</li><li>支持iFrame框架</li><li>单页多实例</li><li>可能过CSS(SCSS)定制样式</li><li>智能图像预加载与代码优化</li><li>桌面键盘导航</li><li>字体图标支持</li><li>还有更多</li></ul><h3 id="三、浏览器支持"><a href="#三、浏览器支持" class="headerlink" title="三、浏览器支持"></a>三、浏览器支持</h3><p>lightgallery 支持所有主要的浏览器包括IE 9及以上。</p><h3 id="四、安装下载"><a href="#四、安装下载" class="headerlink" title="四、安装下载"></a>四、安装下载</h3><h4 id="1-Bower-安装"><a href="#1-Bower-安装" class="headerlink" title="1. Bower 安装"></a>1. Bower 安装</h4><p>你可以使用 <a href="https://bower.io/">Bower</a> 包管理工具安装<code>lightgallery</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bower <span class="token function">install</span> lightgallery.js --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="2-npm"><a href="#2-npm" class="headerlink" title="2. npm"></a>2. npm</h4><p>你也能在 <a href="https://www.npmjs.com/">npm</a> 上找到 <code>lightgallery</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> lightgallery.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="3-Github-下载"><a href="#3-Github-下载" class="headerlink" title="3. Github 下载"></a>3. Github 下载</h4><p>你也可以直接从 GitHub 下载<a href="https://github.com/sachinchoolur/lightgallery.js">lightgallery</a></p><h3 id="五、基础示例"><a href="#五、基础示例" class="headerlink" title="五、基础示例"></a>五、基础示例</h3><h4 id="1-使用方法"><a href="#1-使用方法" class="headerlink" title="1. 使用方法"></a>1. 使用方法</h4><p>首先，在 html 头文件<code>&lt;head&gt;</code>中引入<code>lightgallery.css</code>：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>css/lightgallery.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后，在<code>&lt;body&gt;</code>标签结尾引入<code>lightgallery.min.js</code>，如果你想引入其他 lightgallery 的功能插件，你可以将这些插件引入到<code>lightgallery.min.js</code>之后，如下：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>js/lightgallery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- lightgallery plugins --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>js/lg-thumbnail.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>js/lg-fullscreen.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以下是页面标记的图片示例：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lightgallery<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>img/img1.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>img/thumb1.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>img/img2.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>img/thumb2.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后，是 JavaScript 调用插件的方式：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>    <span class="token function">lightGallery</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'lightgallery'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="2-完整示例"><a href="#2-完整示例" class="headerlink" title="2. 完整示例"></a>2. 完整示例</h4><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>lightgallery.js的使用示例<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/lightGallery/css/lightgallery.min.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">        <span class="token selector">ul</span> <span class="token punctuation">&#123;</span>            <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>            <span class="token property">list-style-type</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">ul li</span> <span class="token punctuation">&#123;</span>            <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>            <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>            <span class="token property">margin</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token selector">.lgallery</span> <span class="token punctuation">&#123;</span>            <span class="token property">width</span><span class="token punctuation">:</span> 213px<span class="token punctuation">;</span>            <span class="token property">height</span><span class="token punctuation">:</span> 137px<span class="token punctuation">;</span>            <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">initLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lightGallery<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/a.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lgallery<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/a.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/b.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lgallery<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/b.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/c.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lgallery<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/c.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/d.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lgallery<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/d.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/e.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lgallery<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/e.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/f.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lgallery<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/f.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/g.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lgallery<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/assets/images/g.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/lightGallery/js/lightgallery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/lightGallery/js/plugins/lg-fullscreen.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/lightGallery/js/plugins/lg-thumbnail.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/lightGallery/js/plugins/lg-autoplay.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/lightGallery/js/plugins/lg-hash.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/lightGallery/js/plugins/lg-pager.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/lightGallery/js/plugins/lg-share.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/lightGallery/js/plugins/lg-zoom.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token keyword">function</span> <span class="token function">initLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> lg <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'lightGallery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">lightGallery</span><span class="token punctuation">(</span>lg<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        mode<span class="token operator">:</span> <span class="token string">'lg-slide'</span><span class="token punctuation">,</span>        cssEasing<span class="token operator">:</span> <span class="token string">'ease'</span><span class="token punctuation">,</span>        speed<span class="token operator">:</span> <span class="token number">500</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="六、学习和参考资源"><a href="#六、学习和参考资源" class="headerlink" title="六、学习和参考资源"></a>六、学习和参考资源</h3><ul><li><a href="https://sachinchoolur.github.io/lightgallery.js/docs/api.html">API Reference</a></li><li><a href="https://sachinchoolur.github.io/lightgallery.js/docs/api.html#events">Events</a></li><li><a href="https://sachinchoolur.github.io/lightgallery.js/docs/api.html#methods">Methods</a></li><li><a href="https://sachinchoolur.github.io/lightgallery.js/docs/api.html#attributes">Data Attributes</a></li><li><a href="https://sachinchoolur.github.io/lightgallery.js/docs/api.html#dynamic">Dynamic variables</a></li><li><a href="https://sachinchoolur.github.io/lightgallery.js/docs/api.html#sass">Sass variables</a></li><li><a href="https://sachinchoolur.github.io/lightgallery.js/docs/plugin-api.html">Module API</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Google Java编程风格指南</title>
      <link href="/post/bian-cheng-zhi-dao/google-java-bian-cheng-feng-ge-zhi-nan/"/>
      <url>/post/bian-cheng-zhi-dao/google-java-bian-cheng-feng-ge-zhi-nan/</url>
      
        <content type="html"><![CDATA[<h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1 前言"></a>1 前言</h2><p>这份文档是<code>Google Java</code>编程风格规范的完整定义。当且仅当一个<code>Java</code>源文件符合此文档中的规则，我们才认为它符合<code>Google</code>的<code>Java</code>编程风格。</p><p>与其它的编程风格指南一样，这里所讨论的不仅仅是编码格式美不美观的问题，同时也讨论一些约定及编码标准。然而，这份文档主要侧重于我们所普遍遵循的规则，对于那些不是明确强制要求的，我们尽量避免提供意见。</p><h3 id="1-1-术语说明"><a href="#1-1-术语说明" class="headerlink" title="1.1 术语说明"></a>1.1 术语说明</h3><p>本文档中除非特殊说明，否则：</p><ul><li>术语<code>class</code>可表示一个普通类、枚举类、接口或者注解。</li><li>术语<code>comment</code>只用来指代实现的注释(<code>implementation comments</code>)，我们不使用文档注释(<code>documentation comments</code>)一词，而是用<code>Javadoc</code>。</li></ul><p>其他术语说明，将在文档中需要说明的地方单独说明。</p><h3 id="1-2-指南说明"><a href="#1-2-指南说明" class="headerlink" title="1.2 指南说明"></a>1.2 指南说明</h3><p>本文档中的示例代码并不作为规范。也就是说，虽然示例代码是遵循Google编程风格，但并不意味着这是展现这些代码的唯一方式。示例中的格式选择不应该被强制定为规则。</p><h2 id="2-源文件基础"><a href="#2-源文件基础" class="headerlink" title="2 源文件基础"></a>2 源文件基础</h2><h3 id="2-1-文件名"><a href="#2-1-文件名" class="headerlink" title="2.1 文件名"></a>2.1 文件名</h3><p>源文件以其最顶层的类名（其中只有一个）来命名，大小写敏感，文件扩展名为<code>.java</code>。</p><h3 id="2-2-文件编码：UTF-8"><a href="#2-2-文件编码：UTF-8" class="headerlink" title="2.2 文件编码：UTF-8"></a>2.2 文件编码：UTF-8</h3><p>源文件编码格式使用<code>UTF-8</code>。</p><h3 id="2-3-特殊字符"><a href="#2-3-特殊字符" class="headerlink" title="2.3 特殊字符"></a>2.3 特殊字符</h3><h4 id="2-3-1-空格字符"><a href="#2-3-1-空格字符" class="headerlink" title="2.3.1 空格字符"></a>2.3.1 空格字符</h4><p>除了换行符外，<code>ASCII</code>水平空白字符（0x20）是源码文件中唯一支持的空格字符。这意味着：</p><ul><li>所有其他空白字符将被转义。</li><li><code>Tab</code>字符不被用作缩进控制。</li></ul><h4 id="2-3-2-特殊转义字符串"><a href="#2-3-2-特殊转义字符串" class="headerlink" title="2.3.2 特殊转义字符串"></a>2.3.2 特殊转义字符串</h4><p>任何需要转义字符串表示的字符（例如：<code>\b</code>, <code>\t</code>, <code>\n</code>, <code>\f</code>, <code>\r</code>, <code>\&#39;</code>, <code>\\</code>等），采用这种转义字符串的方式表示，而不采用对应字符的八进制数（例如 <code>\012</code>）或<code>Unicode</code>码（例如：<code>\u000a</code>）表示。</p><h4 id="2-3-3-非ASCII字符"><a href="#2-3-3-非ASCII字符" class="headerlink" title="2.3.3 非ASCII字符"></a>2.3.3 非ASCII字符</h4><p>对于其余非<code>ASCII</code>字符，直接使用<code>Unicode</code>字符（例如 <code>∞</code>），或者使用对应的<code>Unicode</code>码（例如：<code>\u221e</code>）转义，都是允许的。<strong>唯一需要考虑的是，何种方式更能使代码容易阅读和理解</strong>。</p><blockquote><p><strong>注意</strong>：在使用<code>Unicode</code>码转义，或者甚至是有时直接使用<code>Unicode</code>字符的时候，建议多添加一些注释说明，将对别人读懂代码很有帮助。</p></blockquote><p>例子：</p><table><thead><tr><th>示例</th><th>结论</th></tr></thead><tbody><tr><td>String unitAbbrev = “μs”;</td><td>赞：即使没有注释也非常清晰。</td></tr><tr><td>String unitAbbrev = “\u03bcs”; // “μs”</td><td>允许，但没有理由要这样做。</td></tr><tr><td>String unitAbbrev = “\u03bcs”; // Greek letter mu, “s”</td><td>允许，但这样做显得笨拙还容易出错。</td></tr><tr><td>String unitAbbrev = “\u03bcs”;</td><td>很糟：读者根本看不出这是什么。</td></tr><tr><td>return ‘\ufeff’ + content; // byte order mark</td><td>很好：对于非打印字符，使用转义，并在必要时写上注释。</td></tr></tbody></table><blockquote><p><strong>注意</strong>：永远不要由于害怕某些程序可能无法正确处理非<code>ASCII</code>字符而让你的代码可读性变差。当程序无法正确处理非<code>ASCII</code>字符时，它自然无法正确运行，你就会去<code>fix</code>这些问题的了。(言下之意就是大胆去用非<code>ASCII</code>字符，如果真的有需要的话)</p></blockquote><h2 id="3-源文件结构"><a href="#3-源文件结构" class="headerlink" title="3 源文件结构"></a>3 源文件结构</h2><p>源文件按照先后顺序，由以下几部分组成：</p><ul><li>许可证(<code>License</code>)或版权信息(<code>copyright</code>)（如果需要）</li><li><code>package</code>语句</li><li><code>import</code>语句</li><li><code>class</code>类声明（每个源码文件只能有唯一一个顶级<code>class</code>）。</li></ul><blockquote><p><strong>注意</strong>：以上每个部分之间应该只有<strong>一个空行</strong>作为间隔。</p></blockquote><h3 id="3-1-许可证或版权信息"><a href="#3-1-许可证或版权信息" class="headerlink" title="3.1 许可证或版权信息"></a>3.1 许可证或版权信息</h3><p>如果一个文件包含许可证或版权信息，那么它应当被放在文件最前面。</p><h3 id="3-2-package语句"><a href="#3-2-package语句" class="headerlink" title="3.2 package语句"></a>3.2 package语句</h3><p><code>package</code>语句不换行，单行长度限制(4.4节)不适用于package语句。(即package语句写在一行里)</p><h3 id="3-3-import语句"><a href="#3-3-import语句" class="headerlink" title="3.3 import语句"></a>3.3 import语句</h3><h4 id="3-3-1-import不使用通配符"><a href="#3-3-1-import不使用通配符" class="headerlink" title="3.3.1 import不使用通配符"></a>3.3.1 import不使用通配符</h4><p><code>import</code>语句中不应该使用通配符，不管是否是静态导入。</p><h4 id="3-3-2-import不换行"><a href="#3-3-2-import不换行" class="headerlink" title="3.3.2 import不换行"></a>3.3.2 import不换行</h4><p><code>import</code>语句不换行，列限制(4.4节)并不适用于<code>import</code>语句。(每个<code>import</code>语句独立成行)</p><h4 id="3-3-3-顺序和间距"><a href="#3-3-3-顺序和间距" class="headerlink" title="3.3.3 顺序和间距"></a>3.3.3 顺序和间距</h4><p><code>import</code>语句可分为以下几组，按照顺序，每组由<strong>一个空行</strong>分隔：</p><ul><li>所有的静态导入(static import)归为一组</li><li><code>com.google</code>包的<code>import</code>归为一组</li><li>使用的第三方包的导入，每个顶级按字典顺序归为一组。例如：<code>android</code>, <code>com</code>, <code>junit</code>, <code>org</code>, <code>sun</code></li><li><code>java</code>包归为一组</li><li><code>javax</code>包归为一组</li></ul><blockquote><p><strong>注意</strong>：同一组内的<code>import</code>语句之间不应用空行隔开，同一组中的<code>import</code>语句按字典序排列。</p></blockquote><h3 id="3-4-类声明"><a href="#3-4-类声明" class="headerlink" title="3.4 类声明"></a>3.4 类声明</h3><h4 id="3-4-1-只声明唯一一个顶级class"><a href="#3-4-1-只声明唯一一个顶级class" class="headerlink" title="3.4.1 只声明唯一一个顶级class"></a>3.4.1 只声明唯一一个顶级class</h4><p>每个源文件中只能有一个顶级class。</p><h4 id="3-4-2-类成员顺序"><a href="#3-4-2-类成员顺序" class="headerlink" title="3.4.2 类成员顺序"></a>3.4.2 类成员顺序</h4><p>类成员的顺序对代码的易读性有很大影响，但是没有一个统一正确的标准。不同的类可能有不同的排序方式。</p><p>最重要的一点，<strong>每个类应该以某种逻辑去排序它的成员，维护者应该要能解释这种排序逻辑</strong>。比如，新的方法不能总是习惯性地添加到类的结尾，因为这样就是按时间顺序而非某种逻辑来排序的。</p><h5 id="3-4-2-1-重载：永不分离"><a href="#3-4-2-1-重载：永不分离" class="headerlink" title="3.4.2.1 重载：永不分离"></a>3.4.2.1 重载：永不分离</h5><p>当一个类有多个构造函数，或是多个同名方法，这些方法应该按顺序出现在一起，中间不要放进其它方法。</p><h2 id="4-格式"><a href="#4-格式" class="headerlink" title="4 格式"></a>4 格式</h2><blockquote><p><strong>术语说明</strong>：块状结构(<code>block-­like construct</code>)指的是一个类，方法或构造函数的主体。需要注意的是，数组初始化中的初始值可被选择性地视为块状结构(4.8.3.1节)。</p></blockquote><h3 id="4-1-大括号"><a href="#4-1-大括号" class="headerlink" title="4.1 大括号"></a>4.1 大括号</h3><h4 id="4-1-1-使用大括号-即使是可选的"><a href="#4-1-1-使用大括号-即使是可选的" class="headerlink" title="4.1.1 使用大括号(即使是可选的)"></a>4.1.1 使用大括号(即使是可选的)</h4><p>大括号一般用在<code>if</code>, <code>else</code>, <code>for</code>, <code>do</code>, <code>while</code>等语句，即使只有一条语句(或是空)，也应该把大括号写上。</p><h4 id="4-1-2-非空语句块采用K-amp-R风格"><a href="#4-1-2-非空语句块采用K-amp-R风格" class="headerlink" title="4.1.2 非空语句块采用K&amp;R风格"></a>4.1.2 非空语句块采用<code>K&amp;R</code>风格</h4><p>对于非空语句块，大括号遵循<code>Kernighan</code>和<code>Ritchie</code>风格 (<a href="https://blog.codinghorror.com/new-programming-jargon/">Egyptian brackets</a>):</p><ul><li>左大括号前不换行</li><li>左大括号后换行</li><li>右大括号前换行</li><li>如果右大括号结束是一个<code>语句块</code>或者<code>方法体</code>、<code>构造函数体</code>或者<code>有命名的类体</code>，则需要换行。当右括号后面接<code>else</code>或者<code>逗号</code>时，不应该换行。</li></ul><p>示例：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">condition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">condition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token function">something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProblemException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">otherCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">somethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token function">lastThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一些例外的情况，将在<code>4.8.1</code>节讲<code>枚举类型</code>的时候讲到。</p><h4 id="4-1-3-空语句块：使代码更简洁"><a href="#4-1-3-空语句块：使代码更简洁" class="headerlink" title="4.1.3 空语句块：使代码更简洁"></a>4.1.3 空语句块：使代码更简洁</h4><p>一个空的语句块，可以在左大括号之后直接接右大括号，中间不需要空格或换行。但是当一个由几个语句块联合组成的语句块时，则需要换行。（例如：<code>if/else</code> 或者<code>try/catch/finally</code>）.</p><p>示例：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 这是可接受的</span><span class="token keyword">void</span> <span class="token function">doNothing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">// 这同样是可接受的</span><span class="token keyword">void</span> <span class="token function">doNothingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 这是不可接受的：多块语句中没有简洁的空语句块</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-2块缩进：2个空格"><a href="#4-2块缩进：2个空格" class="headerlink" title="4.2块缩进：2个空格"></a>4.2块缩进：2个空格</h3><p>每当一个新的语句块产生，缩进就增加两个空格。当这个语句块结束时，缩进恢复到上一层级的缩进格数。缩进要求对整个语句块中的代码和注释都适用。（例子可参考之前4.1.2节中的例子）。</p><blockquote><p><strong>注意</strong>：根据实际的编程经验，<code>2</code>个空格缩进的代码在当前大屏的计算机上会显得十分拥挤，反而使得代码<code>臃肿</code>不够美观。所以，我这里建议使用<code>4</code>个空格来缩进，会使得更加美观，而且能侧面督促开发人员减少代码的嵌套层数。</p></blockquote><h3 id="4-3-一行一个语句"><a href="#4-3-一行一个语句" class="headerlink" title="4.3 一行一个语句"></a>4.3 一行一个语句</h3><p>每条语句结束都需要换行。</p><h3 id="4-4-列长度限制：100"><a href="#4-4-列长度限制：100" class="headerlink" title="4.4 列长度限制：100"></a>4.4 列长度限制：100</h3><p>Java代码的列长度限制为<code>100个</code>字符。 除了如下所述，任何超过此限制的行都必须跳行。这在4.5节会有详细解释。</p><p>例外：</p><ul><li>不可能满足行长度限制的行(例如，Javadoc中的一个长URL，或是一个长的JSNI方法参考)</li><li><code>package</code>和<code>import</code>语句(见3.2节和3.3节)</li><li>注释中那些可能被剪切并粘贴到shell中的命令行</li></ul><blockquote><p><strong>注意</strong>：当前的计算机屏幕都已经比很宽了，而且变量及方法命名都较长，<code>100</code>个字符的长度反而会出现很多不必要的跳行，已经不适应当今的情况了，根据实际编程经验，我这里建议使用<code>120</code>个字符的宽度更为合适。</p></blockquote><h3 id="4-5-换行"><a href="#4-5-换行" class="headerlink" title="4.5 换行"></a>4.5 换行</h3><p><strong>术语说明</strong>：一般情况下，一行长代码为了避免超出列限制(<code>100</code>个字符)而被分为多行，我们称之为断行(<code>line­-wrapping</code>)。</p><p>我们并没有全面，确定性的准则来决定在每一种情况下如何断行。很多时候，对于同一段代码会有好几种有效的换断行方式。</p><blockquote><p><strong>注意</strong>: 提取<code>方法</code>或<code>局部变量</code>可以解决问题，而不不需要进行断行。</p></blockquote><h4 id="4-5-1-在何处断行"><a href="#4-5-1-在何处断行" class="headerlink" title="4.5.1 在何处断行"></a>4.5.1 在何处断行</h4><p>断行的主要原则是：<strong>选择在更高级的语法逻辑处断行</strong>。其他一些原则如下：</p><ul><li>当一个非赋值运算的语句断行时，在运算符号之前断行。（这与Google的C++规范和JavaScrip规范等其他规范不同）。</li><li>如果要在非赋值运算符处断行，那么在该符号前断开(比如<code>+</code>操作符，它将位于下一行)。以下的<code>类运算符</code>也可作为参考：<ul><li>点操作符<code>.</code></li><li>类型界限中的<code>&amp;</code>、<code>||</code>等（例如：<code>&lt;T extends Foo &amp; Bar&gt;</code>)</li></ul></li><li>当要在一个赋值运算语句处断行时，一般在赋值符号之后断行。但是也可以在之前断行。(例如：<code>=</code>，它与前面的内容留在同一行)。<ul><li>这条规则也适用于<code>foreach</code>语句中的冒号。</li></ul></li><li>方法名或构造函数名与左括号留在同一行。</li><li>逗号(<code>,</code>)与其前面的内容留在同一行。也就是在逗号之后断行。</li><li><code>Lambda</code>表达式在箭头符号(<code>-&gt;</code>)后断行。</li></ul><p>示例：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">MyLambda</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> lambda <span class="token operator">=</span>    <span class="token punctuation">(</span><span class="token class-name">String</span> label<span class="token punctuation">,</span> <span class="token class-name">Long</span> value<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> predicate <span class="token operator">=</span> str <span class="token operator">-></span>    <span class="token function">longExpressionInvolving</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注意</strong>：换行的主要目标是使代码更清晰易读。</p></blockquote><h4 id="4-5-2-断行的缩进：至少-4个空格"><a href="#4-5-2-断行的缩进：至少-4个空格" class="headerlink" title="4.5.2 断行的缩进：至少+4个空格"></a>4.5.2 断行的缩进：至少+4个空格</h4><p>自动换行时，第一行后的每一行至少比第一行多缩进<code>4</code>个空格(注意：制表符不用于缩进。见2.3.1节)。</p><p>当存在连续自动换行时，缩进可能会多缩进不只<code>4</code>个空格(语法元素存在多级时)。一般而言，两个连续行使用相同的缩进当且仅当它们开始于同级语法元素。</p><p>第4.6.3水平对齐一节中指出，不鼓励使用可变数目的空格来对齐前面行的符号。</p><h3 id="4-6-空白"><a href="#4-6-空白" class="headerlink" title="4.6 空白"></a>4.6 空白</h3><h4 id="4-6-1-垂直空白"><a href="#4-6-1-垂直空白" class="headerlink" title="4.6.1 垂直空白"></a>4.6.1 垂直空白</h4><p>以下情况需要使用单行空行：</p><ul><li>类成员之间需要单个空行隔开：例如：<code>字段</code>，<code>构造函数</code>，<code>方法</code>，<code>嵌套类</code>，<code>静态初始化块</code>，<code>实例初始化块</code>。但也有以下两种例外情况：<ul><li>两个连续字段之间的空行是可选的，根据需要使用空行来创建字段间的逻辑分组。</li><li>枚举常量之间的的空行也是可选的，根据需要使用空行来创建枚举常量间的逻辑分组。</li></ul></li><li>在方法体内，根据代码的逻辑分组的需要，设置空白行作为间隔。</li><li>类的第一个成员之前或最后一个成员之后，使用空行(可选)。</li><li>本文档所介绍的其他章节的空行要求(比如3.3节：<code>import</code>语句)。</li></ul><h4 id="4-6-2-水平空白"><a href="#4-6-2-水平空白" class="headerlink" title="4.6.2 水平空白"></a>4.6.2 水平空白</h4><p>除了语法、其他规则、词语分隔、注释和javadoc外，水平的ASCII空格只在以下情况出现：</p><ul><li>所有保留的关键字与紧接它之后的位于同一行的左大括号之间需要用空格隔开。(例如：<code>if</code>, <code>for</code> <code>catch</code>等)</li><li>所有保留的关键字与在它之前的右大括号之间需要空格隔开。（例如：<code>else</code>、<code>catch</code>）</li><li>在左大括号之前都需要空格隔开。只有两种例外：<ul><li><code>@SomeAnnotation(&#123;a, b&#125;)</code></li><li><code>String[][] x = &#123;&#123;"foo"&#125;&#125;;</code></li></ul></li><li>所有的二元运算符和三元运算符的两边，都需要空格隔开。(例如：<code>a + b</code>、<code>b = a &lt; 0 ? 0 : a</code>)</li><li>逗号(<code>,</code>)、冒号(<code>:</code>)、分号(<code>;</code>)和右小括号(<code>)</code>)、Lambda箭头符号(<code>-&gt;</code>)之后，需要空格隔开。</li><li><code>//</code>双斜线开始一行注释时，双斜线两边都应该用空格隔开。并且可使用多个空格。（可选，例如：<code>a = 0; // 赋值为0</code>）</li><li>变量声明时，变量类型和变量名之间需要用空格隔开。（例如：<code>List&lt;String&gt; list</code>）</li><li>初始化一个数组时，花括号之间可以用空格隔开，也可以不使用。（可选，例如：<code>new int[] &#123;5, 6&#125;</code>和<code>new int[] &#123; 5, 6 &#125;</code>）</li></ul><blockquote><p><strong>注意</strong>：这个规则并不要求或禁止一行的开关或结尾需要额外的空格，只对内部空格做要求。</p></blockquote><h4 id="4-6-3-水平对齐：不做要求"><a href="#4-6-3-水平对齐：不做要求" class="headerlink" title="4.6.3 水平对齐：不做要求"></a>4.6.3 水平对齐：不做要求</h4><blockquote><p><strong>术语说明</strong>：水平对齐，是指通过添加多个空格，使本行的某一符号与上一行的某一符号上下对齐。</p></blockquote><p>这种对齐是被允许的，但是不会做强制要求。</p><p>以下是没有水平对齐和水平对齐的例子：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>   <span class="token comment">// 这种挺好</span><span class="token keyword">private</span> <span class="token class-name">Color</span> color<span class="token punctuation">;</span>   <span class="token comment">// 同上</span><span class="token keyword">private</span> <span class="token keyword">int</span>   x<span class="token punctuation">;</span>      <span class="token comment">// 允许，但是未来会继续编辑</span><span class="token keyword">private</span> <span class="token class-name">Color</span> color<span class="token punctuation">;</span>  <span class="token comment">// 可能会使它对不齐</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注意</strong>：水平对齐能够增加代码的可读性，但是增加了未来维护代码的难度。考虑到维护时只需要改变一行代码，之前的对齐可以不需要改动。为了对齐，你更有可能改了一行代码，同时需要更改附近的好几行代码，而这几行代码的改动，可能又会引起一些为了保持对齐的代码改动。那原本这行改动，我们称之为<strong>爆炸半径</strong>。这种改动，在最坏的情况下可能会导致大量的无意义的工作，即使在最好的情况下，也会影响版本历史信息，减慢代码<code>review</code>的速度，引起更多<code>merge</code>代码冲突的情况。</p></blockquote><h3 id="4-7-分组小括号：推荐使用"><a href="#4-7-分组小括号：推荐使用" class="headerlink" title="4.7 分组小括号：推荐使用"></a>4.7 分组小括号：推荐使用</h3><p>除非作者和<code>reviewer</code>都认为去掉小括号也不会使代码被误解，或是去掉小括号能让代码更易于阅读，否则我们不应该去掉小括号。我们没有理由假设读者能记住整个Java运算符优先级表。</p><h3 id="4-8-特殊结构"><a href="#4-8-特殊结构" class="headerlink" title="4.8 特殊结构"></a>4.8 特殊结构</h3><h4 id="4-8-1-枚举类型"><a href="#4-8-1-枚举类型" class="headerlink" title="4.8.1 枚举类型"></a>4.8.1 枚举类型</h4><p>枚举常量间用逗号隔开，换行是可选的。而且还允许附加的空行（通常只有一个）。以下就是一种可能性的示例：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">Answer</span> <span class="token punctuation">&#123;</span>    YES <span class="token punctuation">&#123;</span>        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token string">"yes"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    NO<span class="token punctuation">,</span>    MAYBE<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>没有方法和Javadoc的枚举类可写成数组初始化的格式：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">Suit</span> <span class="token punctuation">&#123;</span> CLUBS<span class="token punctuation">,</span> HEARTS<span class="token punctuation">,</span> SPADES<span class="token punctuation">,</span> DIAMONDS <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>由于枚举类也是一个类，因此所有适用于其它类的格式规则也适用于枚举类。</p><h4 id="4-8-2-变量声明"><a href="#4-8-2-变量声明" class="headerlink" title="4.8.2 变量声明"></a>4.8.2 变量声明</h4><h5 id="4-8-2-1-每次声明一个变量"><a href="#4-8-2-1-每次声明一个变量" class="headerlink" title="4.8.2.1 每次声明一个变量"></a>4.8.2.1 每次声明一个变量</h5><p>不要使用组合声明。例如：<code>int a, b;</code>是不允许的。</p><h5 id="4-8-2-2-需要时才声明，尽快进行初始化"><a href="#4-8-2-2-需要时才声明，尽快进行初始化" class="headerlink" title="4.8.2.2 需要时才声明，尽快进行初始化"></a>4.8.2.2 需要时才声明，尽快进行初始化</h5><p>不要在一个代码块的开头把局部变量一次性都声明了(这是c语言的做法)，而是在第一次需要使用它时才声明。局部变量在声明时最好就进行初始化，或者声明后尽快进行初始化。</p><h4 id="4-8-3-数组"><a href="#4-8-3-数组" class="headerlink" title="4.8.3 数组"></a>4.8.3 数组</h4><h5 id="4-8-3-1-数组初始化：可写成块状结构"><a href="#4-8-3-1-数组初始化：可写成块状结构" class="headerlink" title="4.8.3.1 数组初始化：可写成块状结构"></a>4.8.3.1 数组初始化：可写成块状结构</h5><p>数组初始化可以写成块状结构，例如以下格式的写法都是允许的：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>           <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span>            <span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>                       <span class="token number">1</span><span class="token punctuation">,</span>                        <span class="token number">2</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>             <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>               <span class="token punctuation">&#125;</span>  <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span>                     <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span>                          <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="4-8-3-2-非C风格的数组声明"><a href="#4-8-3-2-非C风格的数组声明" class="headerlink" title="4.8.3.2 非C风格的数组声明"></a>4.8.3.2 非C风格的数组声明</h5><p>中括号是类型的一部分：<code>String[] args</code>， 而非<code>String args[]</code>。</p><h4 id="4-8-4-switch语句"><a href="#4-8-4-switch语句" class="headerlink" title="4.8.4 switch语句"></a>4.8.4 switch语句</h4><p><strong>术语说明</strong>：<code>switch</code>块的大括号内是一个或多个语句组。每个语句组包含一个或多个<code>switch</code>标签(<code>case FOO: </code>或<code>default:</code>)，后面跟着一条或多条语句。</p><h5 id="4-8-4-1-缩进"><a href="#4-8-4-1-缩进" class="headerlink" title="4.8.4.1 缩进"></a>4.8.4.1 缩进</h5><p>和其他语句块一样，<code>switch</code>大括号之后缩进两个字符。每个<code>switch</code>标签之后，后面紧接的非标签的新行，按照大括号相同的处理方式缩进两个字符。在标签结束后，恢复到之前的缩进，类似大括号结束。</p><h5 id="4-8-4-2-继续向下执行的注释"><a href="#4-8-4-2-继续向下执行的注释" class="headerlink" title="4.8.4.2 继续向下执行的注释"></a>4.8.4.2 继续向下执行的注释</h5><p>在一个<code>switch</code>块内，每个语句组要么通过<code>break</code>、<code>continue</code>、<code>return</code>或<code>抛出异常</code>来终止，要么通过一条注释来说明程序将继续执行到下一个语句组，任何能表达这个意思的注释都是可以的(典型的是用<code>// fall through</code>)。这个特殊的注释并不需要在最后一个语句组(一般是<code>default</code>)中出现。例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">switch</span> <span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>        <span class="token function">prepareOneOrTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// fall through</span>    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>        <span class="token function">handleOneTwoOrThree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>        <span class="token function">handleLargeNumber</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注意</strong>：在<code>case 1</code>之后不需要该注释，仅在语句组的末尾。</p></blockquote><h5 id="4-8-4-3-default标签需要显式声明"><a href="#4-8-4-3-default标签需要显式声明" class="headerlink" title="4.8.4.3 default标签需要显式声明"></a>4.8.4.3 default标签需要显式声明</h5><p>每个<code>switch</code>语句中，都需要显式声明<code>default</code>标签。即使没有任何代码也需要显示声明。</p><blockquote><p><strong>注意</strong>：枚举类型的<code>switch</code>语句可以省略<code>default</code>语句组，如果它包含覆盖该类型的所有可能值的显式情况。这使得IDE或其他静态分析工具能够在丢失任何情况时发出警告。</p></blockquote><h4 id="4-8-5-注解"><a href="#4-8-5-注解" class="headerlink" title="4.8.5 注解"></a>4.8.5 注解</h4><p>注解应用到类、方法或者构造方法时，应紧接<code>Javadoc</code>之后。每一行只有一个注解。注解所在行不受列长度限制，也不需要增加缩进。例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token annotation punctuation">@Nullable</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getNameIfPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>例外</strong>：如果注解只有一个，并且不带参数。则它可以和类或方法名放在同一行。例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>注解应用到成员变量时，也是紧接<code>Javadoc</code>之后。不同的是，多个注解可以放在同一行。例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Partial</span> <span class="token annotation punctuation">@Mock</span> <span class="token class-name">DataLoader</span> loader<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>对于参数或者局部变量使用注解的情况，没有特定的规范。</p><h4 id="4-8-6-注释"><a href="#4-8-6-注释" class="headerlink" title="4.8.6 注释"></a>4.8.6 注释</h4><h5 id="4-8-6-1-块注释风格"><a href="#4-8-6-1-块注释风格" class="headerlink" title="4.8.6.1 块注释风格"></a>4.8.6.1 块注释风格</h5><p>注释的缩进与它所注释的代码缩进相同。可以采用<code>/* */</code>进行注释，也可以用<code>//</code>进行注释。当使用<code>/* */</code>进行多行注释时，每一行都应该以<code>*</code>开始，并且<code>*</code>应该上下对齐。</p><p>例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* * This is * okay. */</span><span class="token comment">// And so</span><span class="token comment">// is this.</span><span class="token comment">/* Or you can * even do this. */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注意</strong>：多行注释时，如果你希望集成开发环境能自动对齐注释，你应该使用<code>/* */</code>，<code>//</code>一般不会自动对齐。</p></blockquote><h4 id="4-8-7-修饰符"><a href="#4-8-7-修饰符" class="headerlink" title="4.8.7 修饰符"></a>4.8.7 修饰符</h4><p>类和成员变量的修饰符，按<code>Java Lauguage Specification</code>中介绍的先后顺序排序。具体是：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">protected</span> <span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">default</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">synchronized</span> <span class="token keyword">native</span> <span class="token keyword">strictfp</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="4-8-8-数字字面量"><a href="#4-8-8-数字字面量" class="headerlink" title="4.8.8 数字字面量"></a>4.8.8 数字字面量</h4><p>长整型的数字字面量使用大写的<code>L</code>作为后缀，不得使用小写（以免与数字1混淆）。例如：使用<code>3000000000L</code>，而不是<code>3000000000l</code>。</p><h2 id="5-命名约定"><a href="#5-命名约定" class="headerlink" title="5 命名约定"></a>5 命名约定</h2><h3 id="5-1-对所有标识符都通用的规则"><a href="#5-1-对所有标识符都通用的规则" class="headerlink" title="5.1 对所有标识符都通用的规则"></a>5.1 对所有标识符都通用的规则</h3><p>标识符只能使用<code>ASCII</code>字母和数字，因此每个有效的标识符名称都能匹配正则表达式<code>\w+</code>。</p><p>在Google其它编程语言风格中使用的特殊前缀或后缀，如<code>name_</code>, <code>mName</code>, <code>s_name</code>和<code>kName</code>，在Java编程风格中都不再使用。</p><h3 id="5-2-标识符类型的规则"><a href="#5-2-标识符类型的规则" class="headerlink" title="5.2 标识符类型的规则"></a>5.2 标识符类型的规则</h3><h4 id="5-2-1-包名"><a href="#5-2-1-包名" class="headerlink" title="5.2.1 包名"></a>5.2.1 包名</h4><p>包名全部小写，连续的单词只是简单地连接起来，不使用下划线。例如：使用<code>com.example.deepspace</code>，而不是<code>com.example.deepSpace</code>或者<code>com.example.deep_space</code>。</p><h4 id="5-2-2-类名"><a href="#5-2-2-类名" class="headerlink" title="5.2.2 类名"></a>5.2.2 类名</h4><p>类名都以<code>UpperCamelCase</code>风格编写。</p><p>类名通常是名词或名词短语。例如：<code>Character</code>或者<code>ImmutableList</code>。接口名称也可以是名词或名词短语（例如：<code>List</code>），但有时可能是形容词或形容词短语（例如：<code>Readable</code>）。现在还没有特定的规则或行之有效的约定来命名注解类型。</p><p>测试类的命名以它要测试的类的名称开始，以<code>Test</code>结束。例如：<code>HashTest</code>或<code>HashIntegrationTest</code>。</p><h4 id="5-2-3-方法名"><a href="#5-2-3-方法名" class="headerlink" title="5.2.3 方法名"></a>5.2.3 方法名</h4><p>方法名都以<code>lowerCamelCase</code>风格编写。</p><p>方法名通常是动词或动词短语。例如：<code>sendMessage</code>或者<code>stop</code>。</p><p>下划线可能出现在JUnit测试方法名称中用以分隔名称的逻辑组件。一个典型的模式是：<code>test&lt;MethodUnderTest&gt;_&lt;state&gt;</code>，例如：<code>testPop_emptyStack</code>。 并不存在唯一正确的方式来命名测试方法。</p><h4 id="5-2-4-常量名"><a href="#5-2-4-常量名" class="headerlink" title="5.2.4 常量名"></a>5.2.4 常量名</h4><p>常量名命名模式为<code>CONSTANT_CASE</code>，全部字母大写，用下划线分隔单词。那到底什么算是一个常量呢？</p><p>每个常量都是一个静态<code>final</code>字段，其内容是不可变的，且没有可检测的副作用。这包括原始类型、字符串、不可变类型和不可变类型的不可变集合。如果任何一个实例的观测状态是可变的，则它肯定不会是一个常量。只是永远不打算改变对象也是不够的。例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 常量</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NUMBER <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ImmutableList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> NAMES <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Ed"</span><span class="token punctuation">,</span> <span class="token string">"Ann"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ImmutableMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> AGES <span class="token operator">=</span> <span class="token class-name">ImmutableMap</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Ed"</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token string">"Ann"</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Joiner</span> COMMA_JOINER <span class="token operator">=</span> <span class="token class-name">Joiner</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 因为Joiner是不可变的</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">SomeMutableType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> EMPTY_ARRAY <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">enum</span> <span class="token class-name">SomeEnum</span> <span class="token punctuation">&#123;</span> ENUM_CONSTANT <span class="token punctuation">&#125;</span><span class="token comment">// 非常量</span><span class="token keyword">static</span> <span class="token class-name">String</span> nonFinal <span class="token operator">=</span> <span class="token string">"non-final"</span><span class="token punctuation">;</span><span class="token keyword">final</span> <span class="token class-name">String</span> nonStatic <span class="token operator">=</span> <span class="token string">"non-static"</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> mutableCollection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ImmutableSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SomeMutableType</span><span class="token punctuation">></span></span> mutableElements <span class="token operator">=</span> <span class="token class-name">ImmutableSet</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>mutable<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ImmutableMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SomeMutableType</span><span class="token punctuation">></span></span> mutableValues <span class="token operator">=</span>    <span class="token class-name">ImmutableMap</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Ed"</span><span class="token punctuation">,</span> mutableInstance<span class="token punctuation">,</span> <span class="token string">"Ann"</span><span class="token punctuation">,</span> mutableInstance2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">MyClass</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nonEmptyArray <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"these"</span><span class="token punctuation">,</span> <span class="token string">"can"</span><span class="token punctuation">,</span> <span class="token string">"change"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这些常量的名字通常是名词或名词短语。</p><h4 id="5-2-5-非常量字段名"><a href="#5-2-5-非常量字段名" class="headerlink" title="5.2.5 非常量字段名"></a>5.2.5 非常量字段名</h4><p>非常量字段名以<code>lowerCamelCase</code>风格编写。</p><p>这些名字通常是名词或名词短语。例如：<code>computedValues</code>或者<code>index</code>。</p><h4 id="5-2-6-参数名"><a href="#5-2-6-参数名" class="headerlink" title="5.2.6 参数名"></a>5.2.6 参数名</h4><p>参数名以<code>lowerCamelCase</code>风格编写。</p><p>参数应该避免用单个字符命名。</p><h4 id="5-2-7-局部变量名"><a href="#5-2-7-局部变量名" class="headerlink" title="5.2.7 局部变量名"></a>5.2.7 局部变量名</h4><p>局部变量名以<code>lowerCamelCase</code>风格编写。</p><p>即使局部变量是<code>final</code>和<code>不可改变</code>的，也不应该把它示为常量，当然也就不能用常量的规则去命名它。</p><h4 id="5-2-8-类型变量名"><a href="#5-2-8-类型变量名" class="headerlink" title="5.2.8 类型变量名"></a>5.2.8 类型变量名</h4><p>类型变量可用以下两种风格之一进行命名：</p><ul><li>单个的大写字母，后面可以视具体情况跟一个数字(如：<code>E</code>, <code>T</code>, <code>X</code>, <code>T2</code>)。</li><li>以类命名方式(5.2.2节)，后面加个大写的T(如：<code>RequestT</code>, <code>FooBarT</code>)。</li></ul><h3 id="5-3-驼峰式命名法-CamelCase"><a href="#5-3-驼峰式命名法-CamelCase" class="headerlink" title="5.3 驼峰式命名法(CamelCase)"></a>5.3 驼峰式命名法(CamelCase)</h3><p><strong>驼峰式命名法</strong>分大驼峰式命名法(<code>UpperCamelCase</code>)和小驼峰式命名法(<code>lowerCamelCase</code>)。有时，我们有不只一种合理的方式将一个英语词组转换成驼峰形式，如缩略语或不寻常的结构(例如：<code>IPv6</code>或<code>iOS</code>)。Google指定了以下的转换方案。</p><p>名字从散文形式(prose form)开始:</p><ul><li>把短语转换为纯<code>ASCII</code>码，并且移除任何单引号。例如：<code>Müller’s algorithm</code>将变成<code>Muellers algorithm</code>。</li><li>把这个结果切分成单词，在空格或其它标点符号(通常是连字符)处分割开。<ul><li><strong>推荐</strong>：如果某个单词已经有了常用的驼峰表示形式，按它的组成将它分割开(如<code>AdWords</code>将分割成<code>ad words</code>)。 </li><li>需要注意的是iOS并不是一个真正的驼峰表示形式，因此该推荐对它并不适用。</li></ul></li><li>现在将所有字母都小写(包括缩写)，然后将单词的第一个字母大写：<ul><li>每个单词的第一个字母都大写，来得到大驼峰式命名。</li><li>除了第一个单词，每个单词的第一个字母都大写，来得到小驼峰式命名。</li></ul></li><li>最后将所有的单词连接起来得到一个标识符。</li></ul><p>示例：</p><table><thead><tr><th>散文形式</th><th>正确</th><th>不正确</th></tr></thead><tbody><tr><td>“XML HTTP request”</td><td>XmlHttpRequest</td><td>XMLHTTPRequest</td></tr><tr><td>“new customer ID”</td><td>newCustomerId</td><td>newCustomerID</td></tr><tr><td>“inner stopwatch”</td><td>innerStopwatch</td><td>innerStopWatch</td></tr><tr><td>“supports IPv6 on iOS?”</td><td>supportsIpv6OnIos</td><td>supportsIPv6OnIOS</td></tr><tr><td>“YouTube importer”</td><td>YouTubeImporter YoutubeImporter^</td><td>无</td></tr></tbody></table><p>加<code>^</code>号处表示可以，但不推荐。</p><blockquote><p><strong>注意</strong>：在英语中，某些带有连字符的单词形式不唯一。例如：<code>nonempty</code>和<code>non-empty</code>都是正确的，因此方法名<code>checkNonempty</code>和<code>checkNonEmpty</code>也都是正确的。</p></blockquote><h2 id="6-编程实践"><a href="#6-编程实践" class="headerlink" title="6 编程实践"></a>6 编程实践</h2><h3 id="6-1-Override：总是使用"><a href="#6-1-Override：总是使用" class="headerlink" title="6.1 @Override：总是使用"></a>6.1 <code>@Override</code>：总是使用</h3><p>只要是合法的方法，就把<code>@Override</code>注解加上。这包括覆盖超类方法的类方法，实现接口方法的类方法。</p><p><strong>例外</strong>：当父方法为<code>@Deprecated</code>时，可以省略<code>@Override</code>。</p><h3 id="6-2-捕获的异常：不能忽视"><a href="#6-2-捕获的异常：不能忽视" class="headerlink" title="6.2 捕获的异常：不能忽视"></a>6.2 捕获的异常：不能忽视</h3><p>除了下面的例子，对捕获的异常不做任何响应是极少的。(典型的响应方式是打印日志，或者如果它被认为是不可能的，则把它当作一个<code>AssertionError</code>重新抛出。)</p><p>如果它确实是不需要在<code>catch</code>块中做任何响应，需要做注释加以说明(如下面的例子)。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">handleNumericResponse</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> ok<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 它不是一个数字，不过没关系，继续</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token function">handleTextResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例外：在测试中，如果一个捕获的异常被命名为<code>expected</code>，则它可以被不加注释地忽略。下面是一种非常常见的情形，用以确保所测试的方法会抛出一个期望中的异常， 因此在这里就没有必要加注释。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    emptyStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> expected<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>6.3 静态成员：使用类来调用</p><p>使用类名调用静态的类成员，而不是具体某个对象或表达式。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Foo</span> aFoo <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span class="token class-name">Foo</span><span class="token punctuation">.</span><span class="token function">aStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 好</span>aFoo<span class="token punctuation">.</span><span class="token function">aStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 糟</span><span class="token function">somethingThatYieldsAFoo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 很糟</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>6.4 <code>Finalizers</code>: 禁用</p><p>极少会去重载<code>Object.finalize</code>。</p><blockquote><p><strong>注意</strong>：不要使用<code>finalize</code>。如果你非要使用它，请先仔细阅读和理解<code>Effective Java第7条款</code>：“Avoid Finalizers”，然后不要使用它。</p></blockquote><h2 id="7-Javadoc"><a href="#7-Javadoc" class="headerlink" title="7 Javadoc"></a>7 Javadoc</h2><h3 id="7-1-格式"><a href="#7-1-格式" class="headerlink" title="7.1 格式"></a>7.1 格式</h3><h4 id="7-1-1-一般形式"><a href="#7-1-1-一般形式" class="headerlink" title="7.1.1 一般形式"></a>7.1.1 一般形式</h4><p><code>Javadoc</code>块的基本格式如下所示：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Multiple lines of Javadoc text are written here, * wrapped normally... */</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">String</span> p1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>或者是以下单行形式：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** An especially short bit of Javadoc. */</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>基本格式总是可以接受的。当整个<code>Javadoc</code>块能容纳于一行时(且没有标记<code>@XXX</code>)，就可以使用单行形式。</p><h4 id="7-1-2-段落"><a href="#7-1-2-段落" class="headerlink" title="7.1.2 段落"></a>7.1.2 段落</h4><p>空行(只包含最左侧星号的行)会出现在段落之间和<code>Javadoc</code>标记(<code>@XXX</code>)之前(如果有的话)。 除了第一个段落，每个段落第一个单词前都有标签<code>&lt;p&gt;</code>，并且它和第一个单词间没有空格。</p><h4 id="7-1-3-Javadoc标记"><a href="#7-1-3-Javadoc标记" class="headerlink" title="7.1.3 Javadoc标记"></a>7.1.3 Javadoc标记</h4><p>标准的<code>Javadoc</code>标记按以下顺序出现：<code>@param</code>, <code>@return</code>, <code>@throws</code>, <code>@deprecated</code>, 前面这4种标记如果出现，描述都不能为空。 当描述无法在一行中容纳，连续行需要至少再缩进<code>4</code>个空格(<strong>注</strong>：如果你的缩进统一采用采用<code>4</code>个空格，那么这里就应该是<code>8</code>个空格)。</p><h4 id="7-2-摘要片段"><a href="#7-2-摘要片段" class="headerlink" title="7.2 摘要片段"></a>7.2 摘要片段</h4><p>每个类或成员的<code>Javadoc</code>以一个简短的摘要片段开始。这个片段是非常重要的，在某些情况下，它是唯一出现的文本，比如在类和方法索引中。</p><p>这只是一个小片段，可以是一个名词短语或动词短语，但不是一个完整的句子。它不会以<code>A &#123;@code Foo&#125; is a...</code>或者<code>This method returns...</code>开头, 它也不会是一个完整的祈使句，如<code>Save the record.</code>。然而，由于开头大写及被加了标点，它看起来就像是个完整的句子。</p><blockquote><p><strong>注意</strong>：一个常见的错误是把简单的Javadoc写成<code>/** @return the customer ID */</code>，这是不正确的。它应该写成<code>/** Returns the customer ID. */</code>。</p></blockquote><h3 id="7-3-在哪里使用Javadoc"><a href="#7-3-在哪里使用Javadoc" class="headerlink" title="7.3 在哪里使用Javadoc"></a>7.3 在哪里使用Javadoc</h3><p>至少在每个<code>public</code>类及它的每个<code>public</code>和<code>protected</code>成员处使用<code>Javadoc</code>，以下是一些例外：</p><h4 id="7-3-1-例外：不言自明的方法"><a href="#7-3-1-例外：不言自明的方法" class="headerlink" title="7.3.1 例外：不言自明的方法"></a>7.3.1 例外：不言自明的方法</h4><p>对于简单明显的方法如<code>getFoo</code>，<code>Javadoc</code>是可选的(可以不写)。这种情况下除了写<code>Returns the foo</code>，确实也没有什么值得写了。</p><p>单元测试类中的测试方法可能是不言自明的最常见例子了，我们通常可以从这些方法的描述性命名中知道它是干什么的，因此不需要额外的文档说明。</p><blockquote><p><strong>注意</strong>：如果有一些相关信息是需要读者了解的，那么以上的例外不应作为忽视这些信息的理由。例如，对于方法名<code>getCanonicalName</code>，就不应该忽视文档说明，因为读者很可能不知道词语<code>canonical name</code>指的是什么。</p></blockquote><h4 id="7-3-2-例外：重载"><a href="#7-3-2-例外：重载" class="headerlink" title="7.3.2 例外：重载"></a>7.3.2 例外：重载</h4><p>如果一个方法重载了超类中的方法，那么<code>Javadoc</code>并非必需的。</p><h4 id="7-3-3-可选的Javadoc"><a href="#7-3-3-可选的Javadoc" class="headerlink" title="7.3.3 可选的Javadoc"></a>7.3.3 可选的Javadoc</h4><p>对于包外不可见的类和方法，如有需要，也是要使用<code>Javadoc</code>的。如果一个注释是用来定义一个类，方法，字段的整体目的或行为， 那么这个注释应该写成<code>Javadoc</code>，这样更统一更友好。</p><p>原文地址: <a href="http://checkstyle.sourceforge.net/reports/google-java-style-20170228.html">Google Java Style Guide</a></p>]]></content>
      
      
      <categories>
          
          <category> 编程之道 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Google </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PostgreSQL基础知识整理</title>
      <link href="/post/shu-ju-ku/postgresql-ji-chu-zhi-shi-zheng-li/"/>
      <url>/post/shu-ju-ku/postgresql-ji-chu-zhi-shi-zheng-li/</url>
      
        <content type="html"><![CDATA[<h2 id="数据库操作DML"><a href="#数据库操作DML" class="headerlink" title="数据库操作DML"></a>数据库操作DML</h2><h3 id="CREATE-TABLE"><a href="#CREATE-TABLE" class="headerlink" title="CREATE TABLE"></a>CREATE TABLE</h3><p><code>CREATE TABLE</code>语句用于创建数据库中的表。语法是：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名称 <span class="token punctuation">(</span>列名<span class="token number">1</span> 数据类型<span class="token punctuation">,</span>列名<span class="token number">2</span> 数据类型<span class="token punctuation">,</span>列名<span class="token number">3</span> 数据类型<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>id <span class="token keyword">integer</span><span class="token punctuation">,</span>user_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>email <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>age <span class="token keyword">integer</span><span class="token punctuation">,</span>address <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意</strong>：字段类型<code>char</code>和<code>varchar</code>区别：</p><ul><li>容纳固定长度的字符串。</li><li>容纳可变长度的字符串。</li></ul><h3 id="CONSTRAINT"><a href="#CONSTRAINT" class="headerlink" title="CONSTRAINT"></a>CONSTRAINT</h3><p>约束、限制，常见的约束如下：</p><ul><li><code>CHECK</code>(检查约束)</li><li><code>NOT NULL</code>(非空约束)</li><li><code>UNIQUE</code>(唯一约束)</li><li><code>Primary Key</code>(主键)</li><li><code>Foreign Key</code>(外键)</li></ul><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 各种约束的使用示例</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>    id <span class="token keyword">integer</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>    corp_id <span class="token keyword">integer</span> <span class="token keyword">REFERENCES</span> corp <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>    user_name <span class="token keyword">text</span> <span class="token keyword">UNIQUE</span><span class="token punctuation">,</span>    age <span class="token keyword">numeric</span> <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>age <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ALTER-TABLE"><a href="#ALTER-TABLE" class="headerlink" title="ALTER TABLE"></a>ALTER TABLE</h3><p><code>ALTER TABLE</code>用来添加，删除或修改现有表中的列，也可以用来添加和删除现有表上的各种制约因素。语法如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 现有表中添加一个新的列</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token keyword">table</span> <span class="token keyword">ADD</span> <span class="token keyword">column</span> datatype<span class="token punctuation">;</span><span class="token comment">-- 现有表中删除一个新的列</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token keyword">table</span> <span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> <span class="token keyword">column</span><span class="token punctuation">;</span><span class="token comment">-- 现有表中更改数据类型的列</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token keyword">table</span> <span class="token keyword">MODIFY</span> <span class="token keyword">COLUMN</span> <span class="token keyword">column</span> datatype<span class="token punctuation">;</span><span class="token comment">-- 现有表中一列添加NOT NULL约束</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token keyword">table</span> <span class="token keyword">MODIFY</span> <span class="token keyword">column</span> datatype <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span class="token comment">-- 现有表中添加唯一约束</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token keyword">table</span> <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> MyUniqueConstraint <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>column1<span class="token punctuation">,</span> column2<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- 现有表中添加CHECK约束</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token keyword">table</span> <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> MyUniqueConstraint <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>CONDITION<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- 现有表中添加PRIMARY KEY约束</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token keyword">table</span> <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> MyPrimaryKey <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>column1<span class="token punctuation">,</span> column2<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- 现有表中删除约束</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token keyword">table</span> <span class="token keyword">DROP</span> <span class="token keyword">CONSTRAINT</span> MyUniqueConstraint<span class="token punctuation">;</span><span class="token comment">-- 现有表中删除主键</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token keyword">table</span> <span class="token keyword">DROP</span> <span class="token keyword">CONSTRAINT</span> MyPrimaryKey<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="DROP-TABLE"><a href="#DROP-TABLE" class="headerlink" title="DROP TABLE"></a>DROP TABLE</h3><p><code>DROP TABLE</code>语句是用来删除表定义及其所有相关的数据表的索引，规则，触发器和约束。语法如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">table</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="TRUNCATE-TABLE"><a href="#TRUNCATE-TABLE" class="headerlink" title="TRUNCATE TABLE"></a>TRUNCATE TABLE</h3><p><code>TRUNCATE TABLE</code>命令用于从现有的表删除完整的数据。在每个表上的DELETE（删除）具有相同的效果，但是，因为它没有实际扫描的表，它的速度快。语法如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">TRUNCATE</span> <span class="token keyword">TABLE</span>  <span class="token keyword">table</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="DELETE-FROM"><a href="#DELETE-FROM" class="headerlink" title="DELETE FROM"></a>DELETE FROM</h3><p><code>DELETE FROM</code>用来从一个表中删除现有的记录。可以使用WHERE子句DELETE查询删除所选行，否则所有的记录会被删除。语法如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> <span class="token punctuation">[</span>condition<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="INSERT-INTO"><a href="#INSERT-INTO" class="headerlink" title="INSERT INTO"></a>INSERT INTO</h3><p><code>INSERT INTO</code>语句允许一个到一个表中插入新行。一个可以作为一个查询的结果，在一个时间或几行插入一行。基本语法如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token punctuation">(</span>column1<span class="token punctuation">,</span> column2<span class="token punctuation">,</span> column3<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>columnN<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">VALUES</span> <span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">,</span> value3<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>valueN<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong>：<br>1.这里 column1, column2,…columnN是要插入数据的表中的列名。<br>2. 可以以任何顺序列出目标列名。 VALUES子句或查询的值都与显式或隐式的列列表从左到右。</p></blockquote><p>如果要添加表中的所有列的值，可能不需要在SQL查询中指定列（次）名称。但要确保表中是在相同的顺序的列值的顺序。INSERT INTO语法如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>value1<span class="token punctuation">,</span>value2<span class="token punctuation">,</span>value3<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>valueN<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="UPDATE"><a href="#UPDATE" class="headerlink" title="UPDATE"></a>UPDATE</h3><p><code>UPDATE</code>被用来修改现有的表中的记录。可以使用<code>UPDATE</code>查询的<code>WHERE</code>子句更新选定行，否则会被更新的所有行。基本语法如下：</p><pre class="line-numbers language-none"><code class="language-none">UPDATE table SET column1 &#x3D; value1, column2 &#x3D; value2...., columnN &#x3D; valueN WHERE [condition];<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="SQL基础"><a href="#SQL基础" class="headerlink" title="SQL基础"></a>SQL基础</h2><h3 id="SELECT"><a href="#SELECT" class="headerlink" title="SELECT"></a>SELECT</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">column</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="DISTINCT"><a href="#DISTINCT" class="headerlink" title="DISTINCT"></a>DISTINCT</h3><p>找出表内的不同值的情况。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">column</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> id<span class="token punctuation">,</span> email <span class="token keyword">FROM</span> <span class="token keyword">user</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="WHERE"><a href="#WHERE" class="headerlink" title="WHERE"></a>WHERE</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">column</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> <span class="token punctuation">[</span>condition<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="AND-OR"><a href="#AND-OR" class="headerlink" title="AND / OR"></a>AND / OR</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">column</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> <span class="token punctuation">[</span>condition1<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">AND</span><span class="token operator">|</span><span class="token operator">OR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>condition2<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="IN-NOT-IN"><a href="#IN-NOT-IN" class="headerlink" title="IN / NOT IN"></a>IN / NOT IN</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">column</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> <span class="token keyword">column</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'value1'</span><span class="token punctuation">,</span> <span class="token string">'value2'</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> user_name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token string">'李四'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="BETWEEN-…-AND-…"><a href="#BETWEEN-…-AND-…" class="headerlink" title="BETWEEN … AND …"></a>BETWEEN … AND …</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">column</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> <span class="token keyword">column</span> <span class="token operator">BETWEEN</span> <span class="token string">'value1'</span> <span class="token operator">AND</span> <span class="token string">'value2'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age <span class="token operator">BETWEEN</span> <span class="token number">18</span> <span class="token operator">AND</span> <span class="token number">25</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="LIKE"><a href="#LIKE" class="headerlink" title="LIKE"></a>LIKE</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">column</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> <span class="token keyword">column</span> <span class="token operator">LIKE</span> &#123;模式&#125;<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> user_name <span class="token operator">LIKE</span> <span class="token string">'%张%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="ORDER-BY"><a href="#ORDER-BY" class="headerlink" title="ORDER BY"></a>ORDER BY</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">column</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token punctuation">[</span><span class="token keyword">WHERE</span> condition<span class="token punctuation">]</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">column</span> <span class="token punctuation">[</span><span class="token keyword">ASC</span><span class="token punctuation">,</span> <span class="token keyword">DESC</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p><strong>注</strong>：ASC（默认）代表结果会以由小往大的顺序列出，而DESC代表结果会以由大往小的顺序列出。</p></blockquote><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> user_name<span class="token punctuation">,</span> email<span class="token punctuation">,</span> age <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="GROUP-BY"><a href="#GROUP-BY" class="headerlink" title="GROUP BY"></a>GROUP BY</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> column1<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>column2<span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> column1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> user_name<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_name<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="HAVING"><a href="#HAVING" class="headerlink" title="HAVING"></a>HAVING</h3><p>对函数产生的值来设定条件。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> column1<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>column2<span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> column1 <span class="token keyword">HAVING</span> <span class="token punctuation">[</span>condition<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> user_name<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>ages<span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_name <span class="token keyword">HAVING</span> <span class="token function">SUM</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1500</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="ALIAS"><a href="#ALIAS" class="headerlink" title="ALIAS"></a>ALIAS</h3><blockquote><p>SELECT ‘表别名’.’列名’ AS ‘列别名’ FROM table AS ‘表别名’;</p></blockquote><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>user_name <span class="token keyword">AS</span> name<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> ages <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">AS</span> u <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> u<span class="token punctuation">.</span>store_name<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><ul><li><code>AVG</code> (平均)</li><li><code>COUNT</code> (计数)</li><li><code>MAX</code> (最大值)</li><li><code>MIN</code> (最小值)</li><li><code>SUM</code> (总合)</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> fun_name<span class="token punctuation">(</span><span class="token keyword">column</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token function">count</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">AS</span> user_count <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">AS</span> u<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="表连接"><a href="#表连接" class="headerlink" title="表连接"></a>表连接</h3><p>INNER JOIN: 如果表中有至少一个匹配，则返回行；<br>LEFT JOIN: 即使右表中没有匹配，也从左表返回所有的行；<br>RIGHT JOIN: 即使左表中没有匹配，也从右表返回所有的行；<br>FULL JOIN: 只要其中一个表中存在匹配，就返回行。</p><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>uesr_name<span class="token punctuation">,</span> c<span class="token punctuation">.</span>corp_name <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">AS</span> u <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> corp <span class="token keyword">AS</span> c <span class="token keyword">ON</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> u<span class="token punctuation">.</span>corp_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="SQL进阶"><a href="#SQL进阶" class="headerlink" title="SQL进阶"></a>SQL进阶</h2><h3 id="UNION-UNION-ALL"><a href="#UNION-UNION-ALL" class="headerlink" title="UNION / UNION ALL"></a>UNION / UNION ALL</h3><p><code>UNION</code>用于合并两个或多个SELECT语句的结果，不返回任何重复的行。<code>UNION ALL</code>运算符语句，则包括重复行的结果。使用UNION，每个SELECT选择的列数必须具有相同的，相同数目的列表达式相同的数据类型，并让它们在相同的顺序，但它们不必是相同的长度。语法如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> column1 <span class="token punctuation">[</span><span class="token punctuation">,</span> column2 <span class="token punctuation">]</span><span class="token keyword">FROM</span> table1 <span class="token punctuation">[</span><span class="token punctuation">,</span> table2 <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token keyword">WHERE</span> condition<span class="token punctuation">]</span><span class="token keyword">UNION</span> <span class="token punctuation">[</span><span class="token keyword">UNION</span> <span class="token keyword">ALL</span><span class="token punctuation">]</span><span class="token keyword">SELECT</span> column1 <span class="token punctuation">[</span><span class="token punctuation">,</span> column2 <span class="token punctuation">]</span><span class="token keyword">FROM</span> table1 <span class="token punctuation">[</span><span class="token punctuation">,</span> table2 <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token keyword">WHERE</span> condition<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="INTERSECT-INTERSECT-ALL"><a href="#INTERSECT-INTERSECT-ALL" class="headerlink" title="INTERSECT / INTERSECT ALL"></a>INTERSECT / INTERSECT ALL</h3><p>和<code>UNION</code>指令类似，<code>INTERSECT</code>也是对两个SQL语句所产生的结果做处理的。不同的地方是，<code>UNION</code>基本上是一个<code>OR</code>(如果这个值存在于第一句或是第二句，它就会被选出)，而<code>INTERSECT</code>则比较像<code>AND</code>(这个值要存在于第一句和第二句才会被选出)。<code>UNION</code>是并集，而<code>INTERSECT</code>是交集。<code>INTERSECT ALL</code>则包含交集后的重复数据。语法如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> column1 <span class="token punctuation">[</span><span class="token punctuation">,</span> column2 <span class="token punctuation">]</span><span class="token keyword">FROM</span> table1 <span class="token punctuation">[</span><span class="token punctuation">,</span> table2 <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token keyword">WHERE</span> condition<span class="token punctuation">]</span><span class="token keyword">INTERSECT</span> <span class="token punctuation">[</span><span class="token keyword">INTERSECT</span> <span class="token keyword">ALL</span><span class="token punctuation">]</span><span class="token keyword">SELECT</span> column1 <span class="token punctuation">[</span><span class="token punctuation">,</span> column2 <span class="token punctuation">]</span><span class="token keyword">FROM</span> table1 <span class="token punctuation">[</span><span class="token punctuation">,</span> table2 <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token keyword">WHERE</span> condition<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="EXCEPT-EXCEPT-ALL"><a href="#EXCEPT-EXCEPT-ALL" class="headerlink" title="EXCEPT / EXCEPT ALL"></a>EXCEPT / EXCEPT ALL</h3><p><code>EXCEPT</code>用于求差集，其将查询在前一个结果集中但是不再后面一个结果集中的记录。<code>EXCEPT ALL</code>则包含交集后的重复数据。语法如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> column1 <span class="token punctuation">[</span><span class="token punctuation">,</span> column2 <span class="token punctuation">]</span><span class="token keyword">FROM</span> table1 <span class="token punctuation">[</span><span class="token punctuation">,</span> table2 <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token keyword">WHERE</span> condition<span class="token punctuation">]</span><span class="token keyword">EXCEPT</span> <span class="token punctuation">[</span><span class="token keyword">EXCEPT</span> <span class="token keyword">ALL</span><span class="token punctuation">]</span><span class="token keyword">SELECT</span> column1 <span class="token punctuation">[</span><span class="token punctuation">,</span> column2 <span class="token punctuation">]</span><span class="token keyword">FROM</span> table1 <span class="token punctuation">[</span><span class="token punctuation">,</span> table2 <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token keyword">WHERE</span> condition<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong>：在其他数据库求差集的关键字是：<code>MINUS</code>。</p></blockquote><h3 id="SUBQUERY"><a href="#SUBQUERY" class="headerlink" title="SUBQUERY"></a>SUBQUERY</h3><p><code>SUBQUERY</code>即子查询，子查询也是一个普通查询，目的是将用子查询返回的数据将被用来在主查询中作为条件，以进一步限制要检索的数据。可以使用子查询的有SELECT，INSERT，UPDATE和DELETE语句，与运算符如=，&lt;，&gt;，&gt;=，&lt;=，IN等一起使用。有几个子查询必须遵循的规则：</p><ul><li>必须用括号括起来的子查询。</li><li>子查询只能有一个在SELECT子句中的列，除非多列在主查询的查询来比较其选定的列。</li><li>ORDER BY不能使用在子查询中，虽然主查询就可以使用ORDER BY。GROUP BY可以用来执行相同的功能在子查询中的ORDER BY。</li><li>子查询返回多于一行只能用于使用多值的运算符，如为IN，EXISTS，IN，ANY / SOME，ALL运算符。</li></ul><p>使用示例如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- SELECT语句中的子查询</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> COMPANY <span class="token keyword">WHERE</span> ID <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> ID <span class="token keyword">FROM</span> COMPANY <span class="token keyword">WHERE</span> SALARY <span class="token operator">></span> <span class="token number">45000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- INSERT语句的子查询</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> COMPANY_BKP <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> COMPANY <span class="token keyword">WHERE</span> ID <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> ID <span class="token keyword">FROM</span> COMPANY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- UPDATE语句的子查询</span><span class="token keyword">UPDATE</span> COMPANY <span class="token keyword">SET</span> SALARY <span class="token operator">=</span> SALARY <span class="token operator">*</span> <span class="token number">0.50</span> <span class="token keyword">WHERE</span> AGE <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> AGE <span class="token keyword">FROM</span> COMPANY_BKP <span class="token keyword">WHERE</span> AGE <span class="token operator">>=</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- UPDATE语句的子查询</span><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> COMPANY <span class="token keyword">WHERE</span> AGE <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> AGE <span class="token keyword">FROM</span> COMPANY_BKP <span class="token keyword">WHERE</span> AGE <span class="token operator">></span> <span class="token number">27</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="EXISTS-NOT-EXISTS"><a href="#EXISTS-NOT-EXISTS" class="headerlink" title="EXISTS / NOT EXISTS"></a>EXISTS / NOT EXISTS</h3><p><code>EXISTS</code>用于检查子查询是否至少会返回一行数据，该子查询实际上并不返回任何数据，而是返回值True或False。EXISTS指定一个子查询，检测行的存在。<code>NOT EXISTS</code>的作用与<code>EXISTS</code>正好相反。如果子查询没有返回行，则满足了<code>NOT EXISTS</code>中的<code>WHERE</code>子句。语法如下： </p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXISTS</span> subquery<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>EXISTS 和 IN 的比较：</p><ul><li>EXISTS(包括 NOT EXISTS )子句的返回值是一个BOOLEAN值。EXISTS内部有一个子查询语句(SELECT … FROM…)，我将其称为EXIST的内查询语句。其内查询语句返回一个结果集。EXISTS子句根据其内查询语句的结果集空或者非空，返回一个布尔值。而IN引导的子查询只能返回一个字段</li><li>EXISTS : 强调的是是否返回结果集，不要求知道返回什么，IN则需要知道返回的字段值。</li><li>EXISTS与IN的使用效率的问题，通常情况下采用exists要比in效率高，因为IN不走索引，但要看实际情况具体使用：IN适合于外表大而内表小的情况；EXISTS适合于外表小而内表大的情况。</li></ul><h3 id="CONCATENATE"><a href="#CONCATENATE" class="headerlink" title="CONCATENATE"></a>CONCATENATE</h3><p>连接字符串。有的时候，我们有需要将由不同列获得的资料串连在一起。每一种数据库都有提供方法来达到这个目的。</p><ul><li>Oracle: CONCAT(), || </li><li>SQL Server: + </li><li>MySQL: CONCAT() </li><li>PostgreSQL: CONCAT(), || </li></ul><p>PostgreSQL的<code>CONCAT()</code>的语法如下：</p><blockquote><p>concat(str “any” [, str “any” [, …] ])</p></blockquote><p>PostgreSQL的<code>||</code>的语法如下：</p><blockquote><p>string || string<br>string || non-string 或 non-string || string</p></blockquote><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>user_name <span class="token operator">||</span> <span class="token string">' '</span> <span class="token operator">||</span> u<span class="token punctuation">.</span>age <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">AS</span> u<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="SUBSTRING"><a href="#SUBSTRING" class="headerlink" title="SUBSTRING"></a>SUBSTRING</h3><p>截取字符串。</p><ul><li>Oracle: SUBSTR()</li><li>SQL Server: SUBSTRING()</li><li>MySQL: SUBSTR(), SUBSTRING()</li><li>PostgreSQL: SUBSTRING()</li></ul><p>PostgreSQL的SUBSTRING()语法如下：</p><ul><li>substring(string [from int] [for int]) 截取子字符串。</li><li>substring(string from pattern) 截取匹配POSIX正则表达式的子字符串。</li><li>substring(string from pattern for escape) 截取匹配SQL正则表达式的子字符串。</li></ul><p>例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 得到hom</span>substring<span class="token punctuation">(</span><span class="token string">'Thomas'</span> <span class="token keyword">from</span> <span class="token number">2</span> <span class="token keyword">for</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- 得到mas</span>substring<span class="token punctuation">(</span><span class="token string">'Thomas'</span> <span class="token keyword">from</span> <span class="token string">'...$'</span><span class="token punctuation">)</span><span class="token comment">-- 得到oma</span>substring<span class="token punctuation">(</span><span class="token string">'Thomas'</span> <span class="token keyword">from</span> <span class="token string">'%#"o_a#"_'</span> <span class="token keyword">for</span> <span class="token string">'#'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="TRIM"><a href="#TRIM" class="headerlink" title="TRIM"></a>TRIM</h3><p>SQL中的<code>TRIM</code>函数是用来移除掉一个字符串中的字头或字尾。最常见的用途是移除字首或字尾的空白。这个函数在不同的数据库中有不同的名称： </p><ul><li>Oracle: LTRIM(), RTRIM()</li><li>SQL Server: LTRIM(), RTRIM()</li><li>MySQL: TRIM(), LTRIM(), RTRIM()</li><li>PostgreSQL: TRIM(), BTRIM(), LTRIM(), RTRIM()</li></ul><p>PostgreSQL的TRIM()语法如下：</p><ul><li>trim([leading | trailing | both] [characters] from string) 从字符串string的开头/结尾/两边删除只包含characters中字符(缺省是空白)的最长的字符串。</li><li>btrim(string text [, characters text]) 从string开头和结尾删除只包含 characters中字符(缺省是空白)的最长字符串。</li><li>ltrim(string text [, characters text]) 从字符串string的开头删除只包含characters 中字符(缺省是一个空白)的最长的字符串。</li><li>rtrim(string text [, characters text]) 从字符串string的结尾删除只包含characters中字符(缺省是个空白)的最长的字符串。</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 得到Tom</span>trim<span class="token punctuation">(</span>both <span class="token string">'x'</span> <span class="token keyword">from</span> <span class="token string">'xTomxx'</span><span class="token punctuation">)</span><span class="token comment">-- 得到trim</span>btrim<span class="token punctuation">(</span><span class="token string">'xyxtrimyyx'</span><span class="token punctuation">,</span> <span class="token string">'xy'</span><span class="token punctuation">)</span><span class="token comment">-- 得到trim</span>ltrim<span class="token punctuation">(</span><span class="token string">'zzzytrim'</span><span class="token punctuation">,</span> <span class="token string">'xyz'</span><span class="token punctuation">)</span><span class="token comment">-- 得到trim</span>rtrim<span class="token punctuation">(</span><span class="token string">'trimxxxx'</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="CASE"><a href="#CASE" class="headerlink" title="CASE"></a>CASE</h3><p><code>CASE</code>表达式是一种通用的条件表达式，类似于其它编程语言中的<code>if/else</code>语句。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token punctuation">[</span>condition<span class="token punctuation">]</span> <span class="token keyword">THEN</span> result     <span class="token punctuation">[</span><span class="token keyword">WHEN</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>     <span class="token punctuation">[</span><span class="token keyword">ELSE</span> result<span class="token punctuation">]</span><span class="token keyword">END</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>示例如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> sex<span class="token punctuation">,</span>     <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> sex <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token string">'女'</span>          <span class="token keyword">WHEN</span> sex <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'男'</span>          <span class="token keyword">ELSE</span> <span class="token string">'未知'</span>     <span class="token keyword">END</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="COALESCE"><a href="#COALESCE" class="headerlink" title="COALESCE"></a>COALESCE</h3><p><code>COALESCE</code>返回它的第一个非<code>NULL</code>的参数值。如果所有参数都是NULL那么返回NULL。它常用于在显示数据时用缺省值替换NULL。语法如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">COALESCE</span><span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用示例：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">COALESCE</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="NULLIF"><a href="#NULLIF" class="headerlink" title="NULLIF"></a>NULLIF</h3><p>当且仅当value1等于value2时，<code>NULLIF</code>才返回null。否则它返回value1。这些可以用于执行上面给出的<code>COALESCE</code>例子的反例。语法如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">NULLIF</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="GREATEST-LEAST"><a href="#GREATEST-LEAST" class="headerlink" title="GREATEST / LEAST"></a>GREATEST / LEAST</h3><p>GREATEST和LEAST函数从一个任意数字表达式的列表里选取最大或者最小的数值。 这些表达式必须都可以转换成一个普通的数据类型，它将会是结果类型。列表中的NULL值将被忽略。只有所有表达式的结果都是 NULL 的时候，结果才会是 NULL。语法如下：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">GREATEST<span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span>LEAST<span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p><strong>注意</strong>：GREATEST和LEAST都不是 SQL 标准，但却是很常见的扩展。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PostgreSQL </tag>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git知识点整理</title>
      <link href="/post/ruan-jian-gong-ju/git/git-zhi-shi-dian-zheng-li/"/>
      <url>/post/ruan-jian-gong-ju/git/git-zhi-shi-dian-zheng-li/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Git基本概念。"><a href="#1-Git基本概念。" class="headerlink" title="1. Git基本概念。"></a>1. Git基本概念。</h2><ul><li><code>repository</code></li><li><code>config</code></li><li><code>init</code></li><li><code>clone</code></li><li><code>fetch</code></li><li><code>pull</code></li><li><code>commit</code></li><li><code>push</code></li><li><code>branch</code></li><li><code>head</code></li><li><code>tag</code></li><li><code>merge</code></li><li><code>conflict</code></li><li><code>diff</code></li><li><code>log</code></li><li><code>show</code></li><li><code>status</code></li></ul><h2 id="2-Git工作空间和文件状态"><a href="#2-Git工作空间和文件状态" class="headerlink" title="2. Git工作空间和文件状态"></a>2. Git工作空间和文件状态</h2><h3 id="1-工作空间"><a href="#1-工作空间" class="headerlink" title="(1).工作空间"></a>(1).工作空间</h3><p><img src="http://blog.chinaunix.net/attachment/201402/19/10415985_139279770639pM.jpg" class="lazyload placeholder" data-srcset="http://blog.chinaunix.net/attachment/201402/19/10415985_139279770639pM.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="Git工作空间"></p><p>左侧为工作区，右侧为版本库。</p><ul><li>工作区（<code>Working Directory</code>） 就是在电脑里能看到的目录，比如learngit文件夹就是一个工作区。</li><li>版本库（<code>Repository</code>）工作区有一个隐藏目录<code>.git</code>，是Git的版本库。</li></ul><p>在版本库中标记为<code>index</code>的区域为暂存区，标记为<code>master</code>的是Git为我们自动创建的第一个分支，代表的是目录树。此时<code>HEAD</code>实际是指向<code>master</code>分支的一个“游标”，所以图示的命令中出现HEAD的地方可以用<code>master</code>来替换。图中的objects标识的区域为git的对象库，实际位于<code>.git/objects</code>目录下。</p><ul><li>当对工作区修改（或新增）的文件执行<code>git add</code>命令时，暂存区的目录树会被更新，同时工作区修改（或新增）的文件内容会被写入到对象库中的一个新的对象中，而该对象的id被记录在暂存区的文件索引中。</li><li>当执行提交操作<code>git commit</code>时，暂存区的目录树会写到版本库（对象库）中，master分支会做相应的更新，即master最新指向的目录树就是提交时原暂存区的目录树。</li><li>当执行<code>git reset HEAD</code>命令时，暂存区的目录树会被重写，会被master分支指向的目录树所替换，但是工作区不受影响。</li><li>当执行<code>git rm --cached</code>命令时，会直接从暂存区删除文件，工作区则不做出改变。</li><li>当执行<code>git checkout .</code>或<code>git checkout --</code> 命令时，会用暂存区全部的文件或指定的文件替换工作区的文件。这个操作很危险，会清楚工作区中未添加到暂存区的改动。</li><li>当执行<code>git checkout HEAD .</code>或<code>git checkout HEAD</code>命令时，会用HEAD指向的master分支中的全部或部分文件替换暂存区和工作区中的文件。这个命令也是极度危险的。因为不但会清楚工作区中未提交的改动，也会清楚暂存区中未提交的改动。</li></ul><h3 id="1-文件状态"><a href="#1-文件状态" class="headerlink" title="(1).文件状态"></a>(1).文件状态</h3><p>Git 有三种状态，你的文件可能处于其中之一：**已提交(<code>committed</code>)<strong>、</strong>已修改(<code>modified</code>)<strong>和</strong>已暂存(<code>staged</code>)**。</p><h2 id="3-Git配置系统级、全局、当前仓库用户名、邮箱的命令"><a href="#3-Git配置系统级、全局、当前仓库用户名、邮箱的命令" class="headerlink" title="3. Git配置系统级、全局、当前仓库用户名、邮箱的命令"></a>3. Git配置系统级、全局、当前仓库用户名、邮箱的命令</h2><p>系统级、全局、当前仓库选项分别是:仓库-system、-global、-local(或默认不填)</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config --global user.name <span class="token string">"Jerry Mouse"</span><span class="token function">git</span> config --global user.email <span class="token string">"jerry@yiibai.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>列出Git设置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config --list<span class="token function">git</span> config -l<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="4-Git-fetch和pull的区别"><a href="#4-Git-fetch和pull的区别" class="headerlink" title="4. Git fetch和pull的区别"></a>4. Git fetch和pull的区别</h2><ul><li><code>git fetch</code>：相当于是从远程获取最新版本到本地，不会自动merge.</li><li><code>git pull</code>：相当于是从远程获取最新版本并merge到本地.</li></ul><h3 id="1-git-fetch示例："><a href="#1-git-fetch示例：" class="headerlink" title="(1). git fetch示例："></a>(1). git fetch示例：</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Git fetch origin master<span class="token function">git</span> log -p master<span class="token punctuation">..</span>origin/master<span class="token function">git</span> merge origin/master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>以上命令的含义：</p><ul><li>首先从远程的<code>origin</code>的<code>master</code>主分支下载最新的版本到<code>origin/master</code>分支上</li><li>然后比较本地的<code>master</code>分支和<code>origin/master</code>分支的差别</li><li>最后进行合并</li><li>上述过程其实可以用以下更清晰的方式来进行：</li></ul><h3 id="1-git-pull示例："><a href="#1-git-pull示例：" class="headerlink" title="(1). git pull示例："></a>(1). git pull示例：</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> pull origin master<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上述命令其实相当于<code>git fetch</code>和<code>git merge</code>。在实际使用中，<code>git fetch</code>更安全一些，因为在merge前，我们可以查看更新情况，然后再决定是否合并。</p><h2 id="5-Git-reset和revert的却别"><a href="#5-Git-reset和revert的却别" class="headerlink" title="5. Git reset和revert的却别"></a>5. Git reset和revert的却别</h2><ul><li><code>git revert</code>是用一次新的commit来回滚之前的commit，<code>git reset</code>是直接删除指定的commit。 </li><li>在回滚这一操作上看，效果差不多。但是在日后继续merge以前的老版本时有区别。因为<code>git revert</code>是用一次逆向的commit“中和”之前的提交，因此日后合并老的branch时，导致这部分改变不会再次出现，但是<code>git reset</code>是之间把某些commit在某个branch上删除，因而和老的branch再次merge时，这些被回滚的commit应该还会被引入。</li><li><code>git reset</code>是把HEAD向后移动了一下，而<code>git revert</code>是HEAD继续前进，只是新的commit的内容和要revert的内容正好相反，能够抵消要被revert的内容。</li><li>git revert与git reset最大的不同是，git revert 仅仅是撤销某次提交。</li></ul><p>另外，说一下<code>git revert</code>， <code>git reset –hard</code>和 <code>–soft</code>的区别</p><ul><li><code>git reset –mixed id</code>: 是将git的HEAD变了（也就是提交记录变了），但文件并没有改变，（也就是working tree并没有改变）。</li><li><code>git reset –soft id</code>: 实际上，是<code>git reset –mixed id</code>后，又做了一次<code>git add</code>。</li><li><code>git reset –herd id</code>: 是将git的HEAD变了，文件也变了。</li></ul><h2 id="6-Git-merge和reabse的相同点和不同点"><a href="#6-Git-merge和reabse的相同点和不同点" class="headerlink" title="6. Git merge和reabse的相同点和不同点"></a>6. Git merge和reabse的相同点和不同点</h2><p><code>merge</code>是合并的意思，<code>rebase</code>是复位基底的意思，相同点都是用来合并分支的。</p><p><img src="http://images2015.cnblogs.com/blog/759200/201608/759200-20160806092734215-279978821.png" class="lazyload placeholder" data-srcset="http://images2015.cnblogs.com/blog/759200/201608/759200-20160806092734215-279978821.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="merge和rebase"></p><p>不同点:</p><ul><li><code>merge</code>操作会生成一个新的节点，之前的提交分开显示。而<code>rebase</code>操作不会生成新的节点，是将两个分支融合成一个线性的提交。</li><li>解决冲突时。merge操作遇到冲突的时候，当前merge不能继续进行下去。手动修改冲突内容后，add 修改，commit就可以了。而<code>rebase</code>操作的话，会中断rebase,同时会提示去解决冲突。解决冲突后,将修改add后执行<code>git rebase –continue</code>继续操作，或者<code>git rebase –skip</code>忽略冲突。</li><li><code>git pull</code>和<code>git pull --rebase</code>区别：<code>git pull</code>做了两个操作分别是”获取”和”合并”。所以加了rebase就是以rebase的方式进行合并分支，默认为merge。</li></ul><p><strong>总结</strong>：选择 merge 还是 rebase？</p><ul><li>merge 是一个合并操作，会将两个分支的修改合并在一起，默认操作的情况下会提交合并中修改的内容</li><li>merge 的提交历史忠实地记录了实际发生过什么，关注点在真实的提交历史上面</li><li>rebase 并没有进行合并操作，只是提取了当前分支的修改，将其复制在了目标分支的最新提交后面</li><li>rebase 的提交历史反映了项目过程中发生了什么，关注点在开发过程上面</li><li>merge 与 rebase 都是非常强大的分支整合命令，没有优劣之分，使用哪一个应由项目和团队的开发需求决定</li><li>merge 和 rebase 还有很多强大的选项，可以使用 git help <command> 查看</li></ul><h2 id="7-Git-stash是什么？它的相关使用方式命令"><a href="#7-Git-stash是什么？它的相关使用方式命令" class="headerlink" title="7. Git stash是什么？它的相关使用方式命令"></a>7. Git stash是什么？它的相关使用方式命令</h2><ul><li>git stash: 备份当前的工作区的内容，从最近的一次提交中读取相关内容，让工作区保证和上次提交的内容一致。同时，将当前的工作区内容保存到Git栈中。</li><li>git stash pop: 从Git栈中读取最近一次保存的内容，恢复工作区的相关内容。由于可能存在多个Stash的内容，所以用栈来管理，pop会从最近的一个stash中读取内容并恢复。</li><li>git stash pop –index stash@{0}: 恢复编号为0的进度的工作区和暂存区。</li><li>git stash apply stash@{1} 以将你指定版本号为stash@{1}的工作取出来</li><li>git stash drop[<stash>] 删除某一个进度，默认删除最新进度</li><li>git stash list: 显示Git栈内的所有备份，可以利用这个列表来决定从那个地方恢复。</li><li>git stash clear: 清空Git栈。此时使用gitg等图形化工具会发现，原来stash的哪些节点都消失了</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 恢复工作进度</span><span class="token function">git</span> stash pop <span class="token punctuation">[</span>--index<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>stash<span class="token operator">></span><span class="token punctuation">]</span>--index 参数：不仅恢复工作区，还恢复暂存区<span class="token operator">&lt;</span>stash<span class="token operator">></span> 指定恢复某一个具体进度。如果没有这个参数，默认恢复最新进度<span class="token comment"># 这是git stash保存进度的完整命令形式</span><span class="token function">git</span> stash <span class="token punctuation">[</span>save message<span class="token punctuation">]</span> <span class="token punctuation">[</span>-k<span class="token operator">|</span>--no-keep-index<span class="token punctuation">]</span> <span class="token punctuation">[</span>--patch<span class="token punctuation">]</span>-k和--no-keep-index指定保存进度后，是否重置暂存区--patch 会显示工作区和HEAD的差异,通过编辑差异文件，排除不需要保存的内容。和git <span class="token function">add</span> -p命令类似使用save可以对进度添加备注<span class="token comment"># git stash save "这是保存的进度"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8-Git只从暂存区删除，从工作空间删除的命令分别是什么"><a href="#8-Git只从暂存区删除，从工作空间删除的命令分别是什么" class="headerlink" title="8. Git只从暂存区删除，从工作空间删除的命令分别是什么?"></a>8. Git只从暂存区删除，从工作空间删除的命令分别是什么?</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> <span class="token function">rm</span> --cached<span class="token function">git</span> <span class="token function">rm</span><span class="token function">git</span> commit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="9-Git标签的使用"><a href="#9-Git标签的使用" class="headerlink" title="9. Git标签的使用"></a>9. Git标签的使用</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 列出现有的标签</span><span class="token function">git</span> tag<span class="token comment"># 打标签</span><span class="token function">git</span> tag -a v1.01 -m <span class="token string">"Relase version 1.01"</span><span class="token comment"># 查看相应标签的版本信息</span><span class="token function">git</span> show v1.4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>-a 选项,创建一个含附注类型的标签</li><li>-m 选项,指定了对应的标签说明</li></ul><h2 id="9-Git分支的使用"><a href="#9-Git分支的使用" class="headerlink" title="9. Git分支的使用"></a>9. Git分支的使用</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看本地分支</span><span class="token function">git</span> branch<span class="token comment"># 查看远程分支</span><span class="token function">git</span> branch -r<span class="token comment"># 创建本地分支(注意新分支创建后不会自动切换为当前分支)</span><span class="token function">git</span> branch <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token comment"># 切换分支</span><span class="token function">git</span> checkout <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token comment"># 创建新分支并立即切换到新分支</span><span class="token function">git</span> checkout -b <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token comment"># 强制删除一个分支</span><span class="token function">git</span> branch -D <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token comment"># 合并分支(将名称为[name]的分支与当前分支合并)</span><span class="token function">git</span> merge <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token comment"># 查看各个分支最后提交信息</span><span class="token function">git</span> br -v<span class="token comment"># 查看已经被合并到当前分支的分支</span><span class="token function">git</span> br --merged<span class="token comment"># 查看尚未被合并到当前分支的分支</span><span class="token function">git</span> br --no-merged<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="10-介绍Git冲突处理经验，以及merge和rebase中的ours和theirs的差别。"><a href="#10-介绍Git冲突处理经验，以及merge和rebase中的ours和theirs的差别。" class="headerlink" title="10. 介绍Git冲突处理经验，以及merge和rebase中的ours和theirs的差别。"></a>10. 介绍Git冲突处理经验，以及merge和rebase中的ours和theirs的差别。</h2><p>merge和rebase对于ours和theirs的定义是完全相反的。在merge时，ours指代的是当前分支，theirs代表需要被合并的分支。而在rebase过程中，ours指向了修改参考分支，theirs却是当前分支。因为rebase 隐含了一个<code>git checkout upstream</code>的过程，将<code>HEAD</code>从local分支变成了upstream分支。git会在rebase结束后撤销这个改变，但它已经不可避免地影响了冲突的状态，使rebase中ours和theirs的定义与merge 截然相反。因此，在使用ours与theirs时请格外小心。</p><h2 id="11-Git远程操作相关"><a href="#11-Git远程操作相关" class="headerlink" title="11. Git远程操作相关"></a>11. Git远程操作相关</h2><h3 id="1-clone"><a href="#1-clone" class="headerlink" title="(1). clone"></a>(1). clone</h3><blockquote><p>git clone &lt;版本库的网址&gt;<br>git clone &lt;版本库的网址&gt; &lt;本地目录名&gt;</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 克隆jQuery的版本库</span> <span class="token function">git</span> clone https://github.com/jquery/jquery.git  <span class="token function">git</span> clone -o jQuery https://github.com/jquery/jquery.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-remote"><a href="#2-remote" class="headerlink" title="(2). remote"></a>(2). remote</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 列出所有远程主机</span><span class="token function">git</span> remote<span class="token comment"># 使用-v选项，可以参看远程主机的网址</span><span class="token function">git</span> remote -v <span class="token comment"># 可以查看该主机的详细信息</span><span class="token function">git</span> remote show <span class="token operator">&lt;</span>主机名<span class="token operator">></span> <span class="token comment"># 添加远程主机</span><span class="token function">git</span> remote <span class="token function">add</span> <span class="token operator">&lt;</span>主机名<span class="token operator">></span> <span class="token operator">&lt;</span>网址<span class="token operator">></span><span class="token comment"># 删除远程主机</span><span class="token function">git</span> remote <span class="token function">rm</span> <span class="token operator">&lt;</span>主机名<span class="token operator">></span><span class="token comment"># 修改远程主机名称</span><span class="token function">git</span> remote <span class="token function">rename</span> <span class="token operator">&lt;</span>原主机名<span class="token operator">></span> <span class="token operator">&lt;</span>新主机名<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-fetch"><a href="#3-fetch" class="headerlink" title="(3). fetch"></a>(3). fetch</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 取回所有分支(branch)的更新到本地</span><span class="token function">git</span> fetch <span class="token operator">&lt;</span>远程主机名<span class="token operator">></span><span class="token comment"># 取回某的特定分支的更新</span><span class="token function">git</span> fetch <span class="token operator">&lt;</span>远程主机名<span class="token operator">></span> <span class="token operator">&lt;</span>分支名<span class="token operator">></span><span class="token comment"># 取回origin主机的master分支的更新</span><span class="token function">git</span> fetch origin master<span class="token comment"># 所取回的更新，在本地主机上要用”远程主机名/分支名”的形式读取。比如origin主机的master，就要用origin/master读取。可以使用git merge命令或者git rebase命令，在本地分支上合并远程分支</span><span class="token function">git</span> merge origin/master<span class="token function">git</span> rebase origin/master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-pull"><a href="#4-pull" class="headerlink" title="(4). pull"></a>(4). pull</h3><blockquote><p>git pull &lt;远程主机名&gt; &lt;远程分支名&gt;:&lt;本地分支名&gt;</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 取回origin主机的next分支，与本地的master分支合并</span><span class="token function">git</span> pull origin next:master<span class="token comment"># 如果远程分支是与当前分支合并，则冒号后面的部分可以省略。</span><span class="token function">git</span> pull origin next<span class="token comment"># 上面的命令实质上等同于先做git fetch，再做git merge。</span><span class="token function">git</span> fetch origin<span class="token function">git</span> merge origin/next<span class="token comment"># 合并需要采用rebase模式</span><span class="token function">git</span> pull --rebase <span class="token operator">&lt;</span>远程主机名<span class="token operator">></span> <span class="token operator">&lt;</span>远程分支名<span class="token operator">></span>:<span class="token operator">&lt;</span>本地分支名<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-push"><a href="#5-push" class="headerlink" title="(5). push"></a>(5). push</h3><blockquote><p>git push &lt;远程主机名&gt; &lt;本地分支名&gt;:&lt;远程分支名&gt;</p></blockquote><p><strong>注意</strong>:分支推送顺序的写法是”&lt;来源地&gt;:&lt;目的地&gt;”，所以git pull是”&lt;远程分支&gt;:&lt;本地分支&gt;”，而git push是”&lt;本地分支&gt;:&lt;远程分支&gt;”。</p><ul><li>如果省略远程分支名，则表示将本地分支推送与之存在”追踪关系”的远程分支(通常两者同名)，如果该远程分支不存在，则会被新建。</li><li>如果省略本地分支名，则表示删除指定的远程分支，因为这等同于推送一个空的本地分支到远程分支。</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将本地的master分支推送到origin主机的master分支。如果后者不存在，则会被新建</span><span class="token function">git</span> push origin master<span class="token comment"># 省略了本地分支，以下等同，删除origin主机的master分支</span><span class="token function">git</span> push origin :master<span class="token function">git</span> push origin --delete master<span class="token comment"># 如果当前分支与远程分支之间存在追踪关系，则本地分支和远程分支都可以省略</span><span class="token function">git</span> push origin<span class="token comment"># 如果当前分支只有一个追踪分支，那么主机名都可以省略。</span><span class="token function">git</span> push<span class="token comment"># 如果当前分支与多个主机存在追踪关系，则可以使用-u选项指定一个默认主机，这样后面就可以不加任何参数使用git push</span><span class="token function">git</span> push -u origin master<span class="token comment"># 不管是否存在对应的远程分支，将本地的所有分支都推送到远程主机</span><span class="token function">git</span> push --all origin<span class="token comment"># 强制推送</span><span class="token function">git</span> push --force origin<span class="token comment"># git push不会推送标签(tag)，除非使用–tags选项</span><span class="token function">git</span> push origin --tags<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="12-Git-Flow使用简介"><a href="#12-Git-Flow使用简介" class="headerlink" title="12. Git Flow使用简介"></a>12. Git Flow使用简介</h2><p>就像代码需要代码规范一样，代码管理同样需要一个清晰的流程和规范。三种广泛使用的工作流程：</p><ul><li>Git flow</li><li>Github flow</li><li>Gitlab flow</li></ul><p>三种工作流程，有一个共同点：都采用”功能驱动式开发”（Feature-driven development，简称FDD）。它指的是，需求是开发的起点，先有需求再有功能分支（feature branch）或者补丁分支（hotfix branch）。完成开发后，该分支就合并到主分支，然后被删除。最早诞生、并得到广泛采用的一种工作流程，就是<a href="http://nvie.com/posts/a-successful-git-branching-model/">Git flow</a>。</p><p>它最主要的特点有两个。首先，项目存在两个长期分支，分别是：主分支master、开发分支develop。其次，项目存在三种短期分支，分别是：功能分支（feature branch）、补丁分支（hotfix branch）、预发分支（release branch），一旦完成开发，它们就会被合并进develop或master，然后被删除。</p><h3 id="1-Git-Flow流程图"><a href="#1-Git-Flow流程图" class="headerlink" title="(1). Git Flow流程图"></a>(1). Git Flow流程图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/09/24/imagegit-flow.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/09/24/imagegit-flow.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="Git Flow流程图"></p><h3 id="2-Git-Flow常用的分支"><a href="#2-Git-Flow常用的分支" class="headerlink" title="(2). Git Flow常用的分支"></a>(2). Git Flow常用的分支</h3><ul><li><code>Production</code>分支。也就是我们经常使用的Master分支，这个分支最近发布到生产环境的代码，最近发布的Release， 这个分支只能从其他分支合并，不能在这个分支直接修改。</li><li><code>Develop</code>分支。这个分支是我们是我们的主开发分支，包含所有要发布到下一个Release的代码，这个主要合并与其他分支，比如Feature分支。</li><li><code>Feature</code>分支。这个分支主要是用来开发一个新的功能，一旦开发完成，我们合并回Develop分支进入下一个Release。</li><li><code>Release</code>分支。当你需要一个发布一个新Release的时候，我们基于Develop分支创建一个Release分支，完成Release后，我们合并到Master和Develop分支。</li><li><code>Hotfix</code>分支。当我们在Production发现新的Bug时候，我们需要创建一个Hotfix, 完成Hotfix后，我们合并回Master和Develop分支，所以Hotfix的改动会进入下一个Release。</li></ul><h3 id="3-Git-Flow代码示例"><a href="#3-Git-Flow代码示例" class="headerlink" title="(3). Git Flow代码示例"></a>(3). Git Flow代码示例</h3><h4 id="a-创建develop分支"><a href="#a-创建develop分支" class="headerlink" title="a. 创建develop分支"></a>a. 创建develop分支</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> branch develop<span class="token function">git</span> push -u origin develop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="b-开始新Feature开发"><a href="#b-开始新Feature开发" class="headerlink" title="b. 开始新Feature开发"></a>b. 开始新Feature开发</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> checkout -b some-feature develop<span class="token comment"># Optionally, push branch to origin:</span><span class="token function">git</span> push -u origin some-feature<span class="token comment"># 做一些改动</span><span class="token function">git</span> status<span class="token function">git</span> <span class="token function">add</span> some-file<span class="token function">git</span> commit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="c-完成Feature"><a href="#c-完成Feature" class="headerlink" title="c. 完成Feature"></a>c. 完成Feature</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> pull origin develop<span class="token function">git</span> checkout develop<span class="token function">git</span> merge --no-ff some-feature<span class="token function">git</span> push origin develop<span class="token function">git</span> branch -d some-feature<span class="token comment"># If you pushed branch to origin:</span><span class="token function">git</span> push origin --delete some-feature<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="d-开始Relase"><a href="#d-开始Relase" class="headerlink" title="d. 开始Relase"></a>d. 开始Relase</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> checkout -b release-0.1.0 develop<span class="token comment"># Optional: Bump version number, commit</span><span class="token comment"># Prepare release, commit</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="e-完成Release"><a href="#e-完成Release" class="headerlink" title="e. 完成Release"></a>e. 完成Release</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> checkout master<span class="token function">git</span> merge --no-ff release-0.1.0<span class="token function">git</span> push<span class="token function">git</span> checkout develop<span class="token function">git</span> merge --no-ff release-0.1.0<span class="token function">git</span> push<span class="token function">git</span> branch -d release-0.1.0<span class="token comment"># If you pushed branch to origin:</span><span class="token function">git</span> push origin --delete release-0.1.0   <span class="token function">git</span> tag -a v0.1.0 master<span class="token function">git</span> push --tags<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="f-开始Hotfix"><a href="#f-开始Hotfix" class="headerlink" title="f. 开始Hotfix"></a>f. 开始Hotfix</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> checkout -b hotfix-0.1.1 master<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="g-完成Hotfix"><a href="#g-完成Hotfix" class="headerlink" title="g. 完成Hotfix"></a>g. 完成Hotfix</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> checkout master<span class="token function">git</span> merge --no-ff hotfix-0.1.1<span class="token function">git</span> push<span class="token function">git</span> checkout develop<span class="token function">git</span> merge --no-ff hotfix-0.1.1<span class="token function">git</span> push<span class="token function">git</span> branch -d hotfix-0.1.1<span class="token function">git</span> tag -a v0.1.1 master<span class="token function">git</span> push --tags<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 软件工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之状态模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-zhuang-tai-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-zhuang-tai-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、模式动机"><a href="#一、模式动机" class="headerlink" title="一、模式动机"></a>一、模式动机</h2><p>在很多情况下，一个对象的行为取决于一个或多个动态变化的属性，这样的属性叫做状态，这样的对象叫做有状态的(<code>stateful</code>)对象，这样的对象状态是从事先定义好的一系列值中取出的。当一个这样的对象与外部事件产生互动时，其内部状态就会改变，从而使得系统的行为也随之发生变化。</p><h2 id="二、模式定义"><a href="#二、模式定义" class="headerlink" title="二、模式定义"></a>二、模式定义</h2><blockquote><p>**状态模式(<code>State Pattern</code>)**：允许一个对象在其内部状态改变时改变它的行为，对象看起来似乎修改了它的类。其别名为状态对象(<code>Objects for States</code>)，状态模式是一种对象行为型模式。</p></blockquote><h2 id="三、模式结构"><a href="#三、模式结构" class="headerlink" title="三、模式结构"></a>三、模式结构</h2><h3 id="1-角色组成："><a href="#1-角色组成：" class="headerlink" title="1. 角色组成："></a>1. 角色组成：</h3><p>状态模式包含如下角色：</p><ul><li><code>Context</code>: 环境类</li><li><code>State</code>: 抽象状态角色</li><li><code>ConcreteState</code>: 具体状态角色类</li></ul><h3 id="2-结构图："><a href="#2-结构图：" class="headerlink" title="2. 结构图："></a>2. 结构图：</h3><p><img src="https://statics.sh1a.qingstor.com/2018/09/21/state-structure.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/09/21/state-structure.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="状态模式结构图"></p><h3 id="3-时序图："><a href="#3-时序图：" class="headerlink" title="3. 时序图："></a>3. 时序图：</h3><p><img src="https://statics.sh1a.qingstor.com/2018/09/21/state-seq.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/09/21/state-seq.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="状态模式时序图"></p><h2 id="四、示例代码"><a href="#四、示例代码" class="headerlink" title="四、示例代码"></a>四、示例代码</h2><p>首先，是抽象的状态角色接口：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 抽象状态角色 * Created by blinkfox on 16/7/12. */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IState</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 抽象方法1     */</span>    <span class="token keyword">void</span> <span class="token function">handle1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 抽象方法2     */</span>    <span class="token keyword">void</span> <span class="token function">handle2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来，是多个具体的状态角色类，分别如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体状态角色类1 * Created by blinkfox on 16/7/12. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteState1</span> <span class="token keyword">implements</span> <span class="token class-name">IState</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 具体状态角色类1中的方法1     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行了具体状态角色类1中的方法1..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 具体状态角色类1中的方法2     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行了具体状态角色类1中的方法2..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体状态角色类2 * Created by blinkfox on 16/7/12. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteState2</span> <span class="token keyword">implements</span> <span class="token class-name">IState</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 具体状态角色类2中的方法1     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行了具体状态角色类2中的方法1..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 具体状态角色类2中的方法2     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行了具体状态角色类2中的方法2..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后，是环境类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 环境角色类 * Created by blinkfox on 16/7/12. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 当前状态</span>    <span class="token keyword">private</span> <span class="token class-name">IState</span> state<span class="token punctuation">;</span>    <span class="token comment">/**     * 构造方法     * @param state     */</span>    <span class="token keyword">public</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token class-name">IState</span> state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 方法1     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">handle1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 方法2     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">handle2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后，是用于测试状态模式的客户端场景类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 状态模式的客户端场景累 * Created by blinkfox on 16/7/12. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StateClient</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcreteState1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">handle1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">handle2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="五、模式分析"><a href="#五、模式分析" class="headerlink" title="五、模式分析"></a>五、模式分析</h2><ul><li>状态模式描述了对象状态的变化以及对象如何在每一种状态下表现出不同的行为。</li><li>状态模式的关键是引入了一个抽象接口来专门表示对象的状态，这个类我们叫做抽象状态接口，而对象的每一种具体状态类都实现了该类，并在不同具体状态类中实现了不同状态的行为，包括各种状态之间的转换。</li></ul><p>在状态模式结构中需要理解环境类与抽象状态类的作用：</p><ul><li>环境类实际上就是拥有状态的对象，环境类有时候可以充当状态管理器(State Manager)的角色，可以在环境类中对状态进行切换操作。</li><li>抽象状态类可以是抽象类，也可以是接口，不同状态类就是继承这个父类的不同子类，状态类的产生是由于环境类存在多个状态，同时还满足两个条件： 这些状态经常需要切换，在不同的状态下对象的行为不同。因此可以将不同对象下的行为单独提取出来封装在具体的状态类中，使得环境类对象在其内部状态改变时可以改变它的行为，对象看起来似乎修改了它的类，而实际上是由于切换到不同的具体状态类实现的。由于环境类可以设置为任一具体状态类，因此它针对抽象状态类进行编程，在程序运行时可以将任一具体状态类的对象设置到环境类中，从而使得环境类可以改变内部状态，并且改变行为。</li></ul><h3 id="1-优点"><a href="#1-优点" class="headerlink" title="1. 优点"></a>1. 优点</h3><p>状态模式的优点：</p><ul><li>封装了转换规则。</li><li>枚举可能的状态，在枚举状态之前需要确定状态种类。</li><li>将所有与某个状态有关的行为放到一个类中，并且可以方便地增加新的状态，只需要改变对象状态即可改变对象的行为。</li><li>允许状态转换逻辑与状态对象合成一体，而不是某一个巨大的条件语句块。</li><li>可以让多个环境对象共享一个状态对象，从而减少系统中对象的个数。</li></ul><h3 id="2-缺点"><a href="#2-缺点" class="headerlink" title="2. 缺点"></a>2. 缺点</h3><p>状态模式的缺点：</p><ul><li>状态模式的使用必然会增加系统类和对象的个数。</li><li>状态模式的结构与实现都较为复杂，如果使用不当将导致程序结构和代码的混乱。</li><li>状态模式对“开闭原则”的支持并不太好，对于可以切换状态的状态模式，增加新的状态类需要修改那些负责状态转换的源代码，否则无法切换到新增状态；而且修改某个状态类的行为也需修改对应类的源代码。</li></ul><h3 id="3-适用环境"><a href="#3-适用环境" class="headerlink" title="3.适用环境"></a>3.适用环境</h3><p>在以下情况下可以使用状态模式：</p><ul><li>对象的行为依赖于它的状态（属性）并且可以根据它的状态改变而改变它的相关行为。</li><li>代码中包含大量与对象状态有关的条件语句，这些条件语句的出现，会导致代码的可维护性和灵活性变差，不能方便地增加和删除状态，使客户类与类库之间的耦合增强。在这些条件语句中包含了对象的行为，而且这些条件对应于对象的各种状态。</li></ul><blockquote><p>状态模式在工作流或游戏等类型的软件中得以广泛使用，甚至可以用于这些系统的核心功能设计，如在政府OA办公系统中，一个批文的状态有多种：尚未办理；正在办理；正在批示；正在审核；已经完成等各种状态，而且批文状态不同时对批文的操作也有所差异。使用状态模式可以描述工作流对象（如批文）的状态转换以及不同状态下它所具有的行为。</p></blockquote><h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><ul><li>状态模式允许一个对象在其内部状态改变时改变它的行为，对象看起来似乎修改了它的类。其别名为状态对象，状态模式是一种对象行为型模式。</li><li>状态模式包含三个角色：环境类又称为上下文类，它是拥有状态的对象，在环境类中维护一个抽象状态类State的实例，这个实例定义当前状态，在具体实现时，它是一个State子类的对象，可以定义初始状态；抽象状态类用于定义一个接口以封装与环境类的一个特定状态相关的行为；具体状态类是抽象状态类的子类，每一个子类实现一个与环境类的一个状态相关的行为，每一个具体状态类对应环境的一个具体状态，不同的具体状态类其行为有所不同。</li><li>状态模式描述了对象状态的变化以及对象如何在每一种状态下表现出不同的行为。</li><li>状态模式的主要优点在于封装了转换规则，并枚举可能的状态，它将所有与某个状态有关的行为放到一个类中，并且可以方便地增加新的状态，只需要改变对象状态即可改变对象的行为，还可以让多个环境对象共享一个状态对象，从而减少系统中对象的个数；其缺点在于使用状态模式会增加系统类和对象的个数，且状态模式的结构与实现都较为复杂，如果使用不当将导致程序结构和代码的混乱，对于可以切换状态的状态模式不满足“开闭原则”的要求。</li><li>状态模式适用情况包括：对象的行为依赖于它的状态（属性）并且可以根据它的状态改变而改变它的相关行为；代码中包含大量与对象状态有关的条件语句，这些条件语句的出现，会导致代码的可维护性和灵活性变差，不能方便地增加和删除状态，使客户类与类库之间的耦合增强。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之代理模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-dai-li-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-dai-li-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、模式动机"><a href="#一、模式动机" class="headerlink" title="一、模式动机"></a>一、模式动机</h2><p>在某些情况下，一个客户不想或者不能直接引用一个对象，此时可以通过一个称之为“代理”的第三者来实现间接引用。代理对象可以在客户端和目标对象之间起到中介的作用，并且可以通过代理对象去掉客户不能看到 的内容和服务或者添加客户需要的额外服务。</p><p>通过引入一个新的对象来实现对真实对象的操作或者将新的对象作为真实对象的一个替身，这种实现机制即为代理模式，通过引入代理对象来间接访问一个对象，这就是代理模式的模式动机。</p><h2 id="二、模式定义"><a href="#二、模式定义" class="headerlink" title="二、模式定义"></a>二、模式定义</h2><blockquote><p>**代理模式(<code>Proxy Pattern</code>)**：给某一个对象提供一个代理，并由代理对象控制对原对象的引用。代理模式的英文叫做<code>Proxy</code>或<code>Surrogate</code>，它是一种对象结构型模式。</p></blockquote><h2 id="三、模式结构"><a href="#三、模式结构" class="headerlink" title="三、模式结构"></a>三、模式结构</h2><h3 id="1-角色组成"><a href="#1-角色组成" class="headerlink" title="1. 角色组成"></a>1. 角色组成</h3><p>代理模式包含如下角色：</p><ul><li><code>Subject</code>: 抽象主题角色</li><li><code>RealSubject</code>: 真实主题角色</li><li><code>Proxy</code>: 代理主题角色</li></ul><h3 id="2-结构图"><a href="#2-结构图" class="headerlink" title="2. 结构图"></a>2. 结构图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/09/20/proxy-structure.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/09/20/proxy-structure.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="代理模式结构图"></p><h2 id="四、示例代码"><a href="#四、示例代码" class="headerlink" title="四、示例代码"></a>四、示例代码</h2><p>首先，是抽象的主题接口和真实主题类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>blinkfox<span class="token punctuation">.</span>patterns<span class="token punctuation">.</span>proxy</span><span class="token punctuation">;</span><span class="token comment">/** * 抽象主题类 * Created by blinkfox on 2017/1/1. */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ISubject</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 定义一个方法     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>blinkfox<span class="token punctuation">.</span>patterns<span class="token punctuation">.</span>proxy</span><span class="token punctuation">;</span><span class="token comment">/** * 真实主题类 * Created by blinkfox on 2017/1/1. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RealSubject</span> <span class="token keyword">implements</span> <span class="token class-name">ISubject</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 实现方法     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"真实主题类请求方法..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后，是代理类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>blinkfox<span class="token punctuation">.</span>patterns<span class="token punctuation">.</span>proxy</span><span class="token punctuation">;</span><span class="token comment">/** * 代理类 * Created by blinkfox on 2017/1/1. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token keyword">implements</span> <span class="token class-name">ISubject</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">ISubject</span> subject<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token class-name">ISubject</span> subject<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>subject <span class="token operator">=</span> subject<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>subject<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 预处理     */</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行前(before)的处理..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 善后处理     */</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行后(after)的处理..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后，是客户端场景测试类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>blinkfox<span class="token punctuation">.</span>patterns<span class="token punctuation">.</span>proxy</span><span class="token punctuation">;</span><span class="token comment">/** * 代理模式客户端场景类 * Created by blinkfox on 2017/1/1. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProxyClient</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ISubject</span> subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Proxy</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>        proxy<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="五、模式分析"><a href="#五、模式分析" class="headerlink" title="五、模式分析"></a>五、模式分析</h2><h3 id="1-优点"><a href="#1-优点" class="headerlink" title="1. 优点"></a>1. 优点</h3><p>代理模式的优点：</p><ul><li>代理模式能够协调调用者和被调用者，在一定程度上降低了系 统的耦合度。</li><li>远程代理使得客户端可以访问在远程机器上的对象，远程机器可能具有更好的计算性能与处理速度，可以快速响应并处理客户端请求。</li><li>虚拟代理通过使用一个小对象来代表一个大对象，可以减少系统资源的消耗，对系统进行优化并提高运行速度。</li><li>保护代理可以控制对真实对象的使用权限。</li></ul><h3 id="2-缺点"><a href="#2-缺点" class="headerlink" title="2. 缺点"></a>2. 缺点</h3><p>代理模式的缺点：</p><ul><li>由于在客户端和真实主题之间增加了代理对象，因此有些类型的代理模式可能会造成请求的处理速度变慢。</li><li>实现代理模式需要额外的工作，有些代理模式的实现非常复杂。</li></ul><h3 id="3-适用环境"><a href="#3-适用环境" class="headerlink" title="3. 适用环境"></a>3. 适用环境</h3><p>根据代理模式的使用目的，常见的代理模式有以下几种类型：</p><ul><li><strong>远程(Remote)代理</strong>：为一个位于不同的地址空间的对象提供一个本地的代理对象，这个不同的地址空间可以是在同一台主机中，也可是在另一台主机中，远程代理又叫做大使(Ambassador)。</li><li><strong>虚拟(Virtual)代理</strong>：如果需要创建一个资源消耗较大的对象，先创建一个消耗相对较小的对象来表示，真实对象只在需要时才会被真正创建。</li><li><strong>Copy-on-Write代理</strong>：它是虚拟代理的一种，把复制（克隆）操作延迟 到只有在客户端真正需要时才执行。一般来说，对象的深克隆是一个开销较大的操作，Copy-on-Write代理可以让这个操作延迟，只有对象被用到的时候才被克隆。</li><li><strong>保护(Protect or Access)代理</strong>：控制对一个对象的访问，可以给不同的用户提供不同级别的使用权限。</li><li><strong>缓冲(Cache)代理</strong>：为某一个目标操作的结果提供临时的存储空间，以便多个客户端可以共享这些结果。</li><li><strong>防火墙(Firewall)代理</strong>：保护目标不让恶意用户接近。</li><li><strong>同步化(Synchronization)代理</strong>：使几个用户能够同时使用一个对象而没有冲突。</li><li><strong>智能引用(Smart Reference)代理</strong>：当一个对象被引用时，提供一些额外的操作，如将此对象被调用的次数记录下来等。</li></ul><h2 id="模式总结"><a href="#模式总结" class="headerlink" title="模式总结"></a>模式总结</h2><ul><li>在代理模式中，要求给某一个对象提供一个代理，并由代理对象控制对原对象的引用。代理模式的英文叫做Proxy或Surrogate，它是一种对象结构型模式。</li><li>代理模式包含三个角色：抽象主题角色声明了真实主题和代理主题的共同接口；代理主题角色内部包含对真实主题的引用，从而可以在任何时候操作真实主题对象；真实主题角色定义了代理角色所代表的真实对象，在真实主题角色中实现了真实的业务操作，客户端可以通过代理主题角色间接调用真实主题角色中定义的方法。</li><li>代理模式的优点在于能够协调调用者和被调用者，在一定程度上降低了系统的耦合度；其缺点在于由于在客户端和真实主题之间增加了代理对象，因此有些类型的代理模式可能会造成请求的处理速度变慢，并且实现代理模式需要额外的工作，有些代理模式的实现非常复杂。远程代理为一个位于不同的地址空间的对象提供一个本地的代表对象，它使得客户端可以访问在远程机器上的对象，远程机器可能具有更好的计算性能与处理速度，可以快速响应并处理客户端请求。</li><li>如果需要创建一个资源消耗较大的对象，先创建一个消耗相对较小的对象来表示，真实对象只在需要时才会被真正创建，这个小对象称为虚拟代理。虚拟代理通过使用一个小对象来代表一个大对象，可以减少系统资源的消耗，对系统进行优化并提高运行速度。</li><li>保护代理可以控制对一个对象的访问，可以给不同的用户提供不同级别的使用权限。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之工厂方法模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-gong-han-fang-fa-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-gong-han-fang-fa-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、模式定义"><a href="#一、模式定义" class="headerlink" title="一、模式定义"></a>一、模式定义</h2><p>工厂方法模式(<code>Factory Method Pattern</code>)又称为工厂模式，也叫虚拟构造器(Virtual Constructor)模式或者多态工厂(Polymorphic Factory)模式，它属于类创建型模式。在工厂方法模式中，工厂父类负责定义创建产品对象的公共接口，而工厂子类则负责生成具体的产品对象，这样做的目的是将产品类的实例化操作延迟到工厂子类中完成，即通过工厂子类来确定究竟应该实例化哪一个具体产品类。</p><h2 id="二、模式结构"><a href="#二、模式结构" class="headerlink" title="二、模式结构"></a>二、模式结构</h2><h3 id="1-角色组成"><a href="#1-角色组成" class="headerlink" title="1. 角色组成"></a>1. 角色组成</h3><p>工厂方法模式包含如下角色：</p><ul><li><code>Product</code>：抽象产品</li><li><code>ConcreteProduct</code>：具体产品</li><li><code>Factory</code>：抽象工厂</li><li><code>ConcreteFactory</code>：具体工厂</li></ul><h3 id="2-结构图"><a href="#2-结构图" class="headerlink" title="2. 结构图"></a>2. 结构图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/09/14/factory-method.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/09/14/factory-method.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="工厂方法模式结构图"></p><h3 id="3-时序图"><a href="#3-时序图" class="headerlink" title="3. 时序图"></a>3. 时序图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/09/14/seq-factory-method.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/09/14/seq-factory-method.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="工厂方法模式时序图"></p><h2 id="三、示例代码"><a href="#三、示例代码" class="headerlink" title="三、示例代码"></a>三、示例代码</h2><p>首先，是抽象的产品类和具体的产品类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 抽象产品类 * Created by blinkfox on 16-6-29. */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 产品类的公共方法     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"这是产品类的公共方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 抽象方法     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体产品类1 * Created by blinkfox on 16-6-29. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteProduct1</span> <span class="token keyword">extends</span> <span class="token class-name">Product</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ConcreteProduct1的method2方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体产品类2 * Created by blinkfox on 16-6-29. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteProduct2</span> <span class="token keyword">extends</span> <span class="token class-name">Product</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ConcreteProduct2的method2方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后，是抽象的工厂类和具体的工厂类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 抽象的工厂类 * Created by blinkfox on 16-6-29. */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Factory</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 运用了Java中的泛型和反射技术,生成某种具体的产品     * 其输入类型可以自行设置     * @param c     * @param &lt;T>     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Product</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体生产产品的工厂类 * Created by blinkfox on 16-6-29. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteFactory</span> <span class="token keyword">extends</span> <span class="token class-name">Factory</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 运用了Java中的泛型和反射技术,生成某种具体的产品     * 其输入类型可以自行设置     * @param c     * @param &lt;T>     * @return     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Product</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            product <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Product</span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"生产产品出错"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> product<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后，是客户端场景类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 工厂方法模式客户端场景类 * Created by blinkfox on 16-6-29. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Factory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Product</span> product1 <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token class-name">ConcreteProduct1</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        product1<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        product1<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Product</span> product2 <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token class-name">ConcreteProduct2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        product2<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        product2<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="四、模式分析"><a href="#四、模式分析" class="headerlink" title="四、模式分析"></a>四、模式分析</h2><p>在工厂方法模式中，核心的工厂类不再负责所有产品的创建，而是将具体创建工作交给子类去做。这个核心类仅仅负责给出具体工厂必须实现的接口，而不负责哪一个产品类被实例化这种细节，这使得工厂方法模式可以允许系统在不修改工厂角色的情况下引进新产品。</p><h3 id="1-优点"><a href="#1-优点" class="headerlink" title="1. 优点"></a>1. 优点</h3><p>工厂方法模式的优点：</p><ul><li>在工厂方法模式中，工厂方法用来创建客户所需要的产品，同时还向客户隐藏了哪种具体产品类将被实例化这一细节，用户只需要关心所需产品对应的工厂，无须关心创建细节，甚至无须知道具体产品类的类名。</li><li>基于工厂角色和产品角色的多态性设计是工厂方法模式的关键。它能够使工厂可以自主确定创建何种产品对象，而如何创建这个对象的细节则完全封装在具体工厂内部。工厂方法模式之所以又被称为多态工厂模式，是因为所有的具体工厂类都具有同一抽象父类。</li><li>使用工厂方法模式的另一个优点是在系统中加入新产品时，无须修改抽象工厂和抽象产品提供的接口，无须修改客户端，也无须修改其他的具体工厂和具体产品，而只要添加一个具体工厂和具体产品就可以了。这样，系统的可扩展性也就变得非常好，完全符合“开闭原则”。</li></ul><h3 id="2-缺点"><a href="#2-缺点" class="headerlink" title="2. 缺点"></a>2. 缺点</h3><p>工厂方法模式的缺点：</p><ul><li>在添加新产品时，需要编写新的具体产品类，而且还要提供与之对应的具体工厂类，系统中类的个数将成对增加，在一定程度上增加了系统的复杂度，有更多的类需要编译和运行，会给系统带来一些额外的开销。</li><li>由于考虑到系统的可扩展性，需要引入抽象层，在客户端代码中均使用抽象层进行定义，增加了系统的抽象性和理解难度，且在实现时可能需要用到DOM、反射等技术，增加了系统的实现难度。</li></ul><h3 id="3-适用环境"><a href="#3-适用环境" class="headerlink" title="3. 适用环境"></a>3. 适用环境</h3><p>在以下情况下可以使用工厂方法模式：</p><ul><li>一个类不知道它所需要的对象的类：在工厂方法模式中，客户端不需要知道具体产品类的类名，只需要知道所对应的工厂即可，具体的产品对象由具体工厂类创建；客户端需要知道创建具体产品的工厂类。</li><li>一个类通过其子类来指定创建哪个对象：在工厂方法模式中，对于抽象工厂类只需要提供一个创建产品的接口，而由其子类来确定具体要创建的对象，利用面向对象的多态性和里氏代换原则，在程序运行时，子类对象将覆盖父类对象，从而使得系统更容易扩展。</li><li>将创建对象的任务委托给多个工厂子类中的某一个，客户端在使用时可以无须关心是哪一个工厂子类创建产品子类，需要时再动态指定，可将具体工厂类的类名存储在配置文件或数据库中。</li></ul><h2 id="五、模式扩展"><a href="#五、模式扩展" class="headerlink" title="五、模式扩展"></a>五、模式扩展</h2><p>工厂方法模式有很多扩展，而且与其他模式结合使用威力更大，下面介绍4种常用扩展。</p><h3 id="1-简单工厂模式"><a href="#1-简单工厂模式" class="headerlink" title="1. 简单工厂模式"></a>1. 简单工厂模式</h3><p>我们这样考虑一个问题：一个模块仅需要一个工厂类，没有必要把它产生出来，使用静态的方法就可以了。因此去掉工厂类中继承的抽象类，把方法改成静态即可。通用代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 简单工厂模式中的工厂类 * Created by blinkfox on 16-6-29. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleFactory</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 运用了Java中的泛型和反射技术,生成某种具体的产品     * 其输入类型可以自行设置     * @param c     * @param &lt;T>     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span>  <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Product</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            product <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Product</span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"生产产品出错"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> product<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 简单工厂模式客户端场景类 * Created by blinkfox on 16-6-29. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleClient</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Product</span> product1 <span class="token operator">=</span> <span class="token class-name">SimpleFactory</span><span class="token punctuation">.</span><span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token class-name">ConcreteProduct1</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        product1<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        product1<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Product</span> product2 <span class="token operator">=</span> <span class="token class-name">SimpleFactory</span><span class="token punctuation">.</span><span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token class-name">ConcreteProduct2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        product2<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        product2<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果没有发生变化，但是类图简单了，调用者也比较简单，简单工厂模式是工厂方法模式的弱化，也叫做静态工厂模式。其缺点是工厂类的扩展比较困难，不符合“开闭原则”，但它仍然是一个非常实用的设计模式。</p><h3 id="2-多工厂类工厂方法模式"><a href="#2-多工厂类工厂方法模式" class="headerlink" title="2. 多工厂类工厂方法模式"></a>2. 多工厂类工厂方法模式</h3><p>当我们在一个比较复杂的项目时，经常会遇到初始化一个对象很耗费精力的情况，所有的产品类都放到一个工厂方法中进行初始化会使代码结构不清晰。为了让结构清晰，我们就为每类产品定义一个创造者，然后由调用者自己去选择与哪个工厂方法关联。多工厂模式的通用代码如下：</p><p>多工厂模式的抽象工厂类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 生成多个产品的抽象工厂类 * Created by blinkfox on 16-7-2. */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MultiFactory</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 生成某种产品的方法     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Product</span> <span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第一种产品的创建工厂实现：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 生成产品1的具体工厂类1 * Created by blinkfox on 16-7-2. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteFactory1</span> <span class="token keyword">extends</span> <span class="token class-name">MultiFactory</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 生成产品1的方法     * @return     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteProduct1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第二种产品的创建工厂实现：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 生成产品2的具体工厂类2 * Created by blinkfox on 16-7-2. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteFactory2</span> <span class="token keyword">extends</span> <span class="token class-name">MultiFactory</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 生成产品2的方法     * @return     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteProduct2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>多工厂模式的客户端场景类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 多工厂方法模式客户端场景类 * Created by blinkfox on 16-7-2. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultiClient</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Product</span> concreteProduct1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcreteFactory1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        concreteProduct1<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        concreteProduct1<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Product</span> concreteProduct2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcreteFactory2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        concreteProduct1<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        concreteProduct1<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-工厂方法的单例模式"><a href="#3-工厂方法的单例模式" class="headerlink" title="3. 工厂方法的单例模式"></a>3. 工厂方法的单例模式</h3><p>单例模式的核心要求就是在内存中只有一个对象，通过工厂方法模式也可以只在内存中生成一个对象，从而实现单例的功能。</p><p>下面是单例类，其中定义了一个private的无参构造函数，目的是不允许通过new的方式创建对象，代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 工厂方法模式中的单例类 * Created by blinkfox on 16-7-4. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 私有化构造方法，不允许new产生一个对象     */</span>    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 工厂方法模式中的单例模式业务方法     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"工厂方法模式中的单例模式方法。。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上单例类中不能通过正常的渠道建立一个对象，那单例的工厂类中如何建立一个单例对象呢？答案是通过反射方式创建，单例工厂类的代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 生成单例的工厂类 * Created by blinkfox on 16-7-4. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SingletonFactory</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> singleton<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Class</span> c <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 获得无参构造</span>            <span class="token class-name">Constructor</span> constructor <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 设置无参构造是可访问的</span>            constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 产生一个实例对象</span>            singleton <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"生成单例的工厂类方法中生成单例出错"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>zuihou        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后是工厂方法单例模式的客户端场景类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 工厂方法单例模式客户端场景类 * Created by blinkfox on 16-7-4. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SingleClient</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Singleton</span> singleton <span class="token operator">=</span> <span class="token class-name">SingletonFactory</span><span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        singleton<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-工厂方法的延迟初始化"><a href="#4-工厂方法的延迟初始化" class="headerlink" title="4. 工厂方法的延迟初始化"></a>4. 工厂方法的延迟初始化</h3><p>何为延迟初始化？一个对象被消费完毕后，并不立即释放，工厂类保持其初始状态，等待再次使用。延迟初始化是工厂模式的一个扩展应用，其通用代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 延迟加载的工厂类 * Created by blinkfox on 16-7-4. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazyFactory</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">></span></span> lazyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token class-name">Product</span> <span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token comment">// 如果map中已经有这个对象，则直接取出该对象即可，否则创建并放在缓存容器中</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lazyMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> lazyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 根据类型创建具体的产品对象</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"product1"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteProduct1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteProduct2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 同时把对象放到缓存容器中</span>        lazyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> product<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面即为延迟加载的工厂类。代码比较简单，通过定义一个<code>map</code>容器来容纳所有产生的对象，如果在<code>map</code>容器中已经有的对象，则直接取出返回；如果没有，则根据需要的类型产生一个对象并放入到<code>map</code>容器中，以便下次调用。</p><p>延迟加载的工厂模式客户端场景类代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 延迟加载的工厂模式客户端场景类 * Created by blinkfox on 16-7-4. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazyClient</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Product</span> product1 <span class="token operator">=</span> <span class="token class-name">LazyFactory</span><span class="token punctuation">.</span><span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token string">"product1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Product</span> product11 <span class="token operator">=</span> <span class="token class-name">LazyFactory</span><span class="token punctuation">.</span><span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token string">"product1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><ul><li>工厂方法模式又称为工厂模式，它属于类创建型模式。在工厂方法模式中，工厂父类负责定义创建产品对象的公共接口，而工厂子类则负责生成具体的产品对象，这样做的目的是将产品类的实例化操作延迟到工厂子类中完成，即通过工厂子类来确定究竟应该实例化哪一个具体产品类。</li><li>工厂方法模式包含四个角色：抽象产品是定义产品的接口，是工厂方法模式所创建对象的超类型，即产品对象的共同父类或接口；具体产品实现了抽象产品接口，某种类型的具体产品由专门的具体工厂创建，它们之间往往一一对应；抽象工厂中声明了工厂方法，用于返回一个产品，它是工厂方法模式的核心，任何在模式中创建对象的工厂类都必须实现该接口；具体工厂是抽象工厂类的子类，实现了抽象工厂中定义的工厂方法，并可由客户调用，返回一个具体产品类的实例。</li><li>工厂方法模式是简单工厂模式的进一步抽象和推广。由于使用了面向对象的多态性，工厂方法模式保持了简单工厂模式的优点，而且克服了它的缺点。在工厂方法模式中，核心的工厂类不再负责所有产品的创建，而是将具体创建工作交给子类去做。这个核心类仅仅负责给出具体工厂必须实现的接口，而不负责产品类被实例化这种细节，这使得工厂方法模式可以允许系统在不修改工厂角色的情况下引进新产品。</li><li>工厂方法模式的主要优点是增加新的产品类时无须修改现有系统，并封装了产品对象的创建细节，系统具有良好的灵活性和可扩展性；其缺点在于增加新产品的同时需要增加新的工厂，导致系统类的个数成对增加，在一定程度上增加了系统的复杂性。</li><li>工厂方法模式适用情况包括：一个类不知道它所需要的对象的类；一个类通过其子类来指定创建哪个对象；将创建对象的任务委托给多个工厂子类中的某一个，客户端在使用时可以无须关心是哪一个工厂子类创建产品子类，需要时再动态指定。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之装饰模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-zhuang-shi-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-zhuang-shi-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、模式动机"><a href="#一、模式动机" class="headerlink" title="一、模式动机"></a>一、模式动机</h2><p>一般有两种方式可以实现给一个类或对象增加行为：</p><ul><li><strong>继承机制</strong>，使用继承机制是给现有类添加功能的一种有效途径，通过继承一个现有类可以使得子类在拥有自身方法的同时还拥有父类的方法。但是这种方法是静态的，用户不能控制增加行为的方式和时机。</li><li><strong>关联机制</strong>，即将一个类的对象嵌入另一个对象中，由另一个对象来决定是否调用嵌入对象的行为以便扩展自己的行为，我们称这个嵌入的对象为装饰器(Decorator)</li></ul><p><strong>装饰模式以对客户透明的方式动态地给一个对象附加上更多的责任</strong>，换言之，客户端并不会觉得对象在装饰前和装饰后有什么不同。<strong>装饰模式可以在不需要创造更多子类的情况下，将对象的功能加以扩展</strong>。这就是装饰模式的模式动机。</p><h2 id="二、模式定义"><a href="#二、模式定义" class="headerlink" title="二、模式定义"></a>二、模式定义</h2><blockquote><p>**装饰模式(Decorator Pattern) ：动态地给一个对象增加一些额外的职责(Responsibility)**，就增加对象功能来说，装饰模式比生成子类实现更为灵活。其别名也可以称为包装器(Wrapper)，与适配器模式的别名相同，但它们适用于不同的场合。根据翻译的不同，装饰模式也有人称之为“油漆工模式”。</p></blockquote><p>策略模式是一种<strong>对象结构型</strong>模式。</p><h2 id="三、-模式结构"><a href="#三、-模式结构" class="headerlink" title="三、 模式结构"></a>三、 模式结构</h2><p>装饰模式包含如下角色：</p><ul><li><code>Component</code>: 抽象构件</li><li><code>ConcreteComponent</code>: 具体构件</li><li><code>Decorator</code>: 抽象装饰类</li><li><code>ConcreteDecorator</code>: 具体装饰类</li></ul><h3 id="结构图"><a href="#结构图" class="headerlink" title="结构图"></a>结构图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/09/14/decorator-structure.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/09/14/decorator-structure.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="装饰模式结构图"></p><h3 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/09/14/decorator-seq.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/09/14/decorator-seq.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="装饰模式时序图"></p><h2 id="四、示例代码"><a href="#四、示例代码" class="headerlink" title="四、示例代码"></a>四、示例代码</h2><p>首先定义一个抽象构件接口：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 抽象构件 * Created by blinkfox on 16-6-26. */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Component</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 接口方法</span>    <span class="token keyword">void</span> <span class="token function">operate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后是具体构件实现类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体构件 * Created by blinkfox on 16-6-26. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteComponent</span> <span class="token keyword">implements</span> <span class="token class-name">Component</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 具体实现方法     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"do Something..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接着是装饰角色：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 装饰角色 * 维持一个指向Component对象的引用，并定义一个与 Component接口一致的接口。 * Created by blinkfox on 16-6-26. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Decorator</span> <span class="token keyword">implements</span> <span class="token class-name">Component</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">Component</span> component<span class="token punctuation">;</span>    <span class="token comment">/**     * 通过构造函数传递被修饰者     * @param component     */</span>    <span class="token keyword">public</span> <span class="token class-name">Decorator</span><span class="token punctuation">(</span><span class="token class-name">Component</span> component<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>component <span class="token operator">=</span> component<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 委托给被修饰者执行     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>component<span class="token punctuation">.</span><span class="token function">operate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面是具体的装饰类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的装饰类1 * Created by blinkfox on 16-6-26. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteDecorator1</span> <span class="token keyword">extends</span> <span class="token class-name">Decorator</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 通过构造函数传递被修饰者     * @param component     */</span>    <span class="token keyword">public</span> <span class="token class-name">ConcreteDecorator1</span><span class="token punctuation">(</span><span class="token class-name">Component</span> component<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 定义自己的修饰方法1     */</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"method1修饰..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 重写父类的operate方法     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">operate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 具体的装饰类2 * Created by blinkfox on 16-6-26. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteDecorator2</span> <span class="token keyword">extends</span> <span class="token class-name">Decorator</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 通过构造函数传递被修饰者     * @param component     */</span>    <span class="token keyword">public</span> <span class="token class-name">ConcreteDecorator2</span><span class="token punctuation">(</span><span class="token class-name">Component</span> component<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 定义自己的修饰方法2     */</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"method2修饰..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 重写父类的operate方法     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">operate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后是客户端的场景类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 装饰模式的客户端场景类 * Created by blinkfox on 16-6-26. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Component</span> component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 第一修饰</span>        component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteDecorator1</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 第二修饰</span>        component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteDecorator2</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 修饰后运行</span>        component<span class="token punctuation">.</span><span class="token function">operate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="五、模式分析"><a href="#五、模式分析" class="headerlink" title="五、模式分析"></a>五、模式分析</h2><h3 id="总体分析"><a href="#总体分析" class="headerlink" title="总体分析"></a>总体分析</h3><ul><li><strong>与继承关系相比，关联关系的主要优势在于不会破坏类的封装性，而且继承是一种耦合度较大的静态关系，无法在程序运行时动态扩展</strong>。在软件开发阶段，关联关系虽然不会比继承关系减少编码量，但是到了软件维护阶段，由于关联关系使系统具有较好的松耦合性，因此使得系统更加容易维护。当然，<em>关联关系的缺点是比继承关系要创建更多的对象</em>。</li><li><strong>使用装饰模式来实现扩展比继承更加灵活，它以对客户透明的方式动态地给一个对象附加更多的责任</strong>。装饰模式可以在不需要创造更多子类的情况下，将对象的功能加以扩展。</li></ul><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>装饰模式的优点：</p><ul><li>装饰模式与继承关系的目的都是要扩展对象的功能，但是装饰模式可以提供比继承更多的灵活性。</li><li>可以通过一种动态的方式来扩展一个对象的功能，通过配置文件可以在运行时选择不同的装饰器，从而实现不同的行为。</li><li>通过使用不同的具体装饰类以及这些装饰类的排列组合，可以创造出很多不同行为的组合。可以使用多个具体装饰类来装饰同一对象，得到功能更为强大的对象。</li><li>具体构件类与具体装饰类可以独立变化，用户可以根据需要增加新的具体构件类和具体装饰类，在使用时再对其进行组合，原有代码无须改变，符合“开闭原则”。</li></ul><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>装饰模式的缺点：</p><ul><li>使用装饰模式进行系统设计时将产生很多小对象，这些对象的区别在于它们之间相互连接的方式有所不同，而不是它们的类或者属性值有所不同，同时还将产生很多具体装饰类。这些装饰类和小对象的产生将增加系统的复杂度，加大学习与理解的难度。</li><li>这种比继承更加灵活机动的特性，也同时意味着装饰模式比继承更加易于出错，排错也很困难，对于多次装饰的对象，调试时寻找错误可能需要逐级排查，较为烦琐。</li></ul><h3 id="适用环境"><a href="#适用环境" class="headerlink" title="适用环境"></a>适用环境</h3><p>在以下情况下可以使用装饰模式：</p><ul><li>在不影响其他对象的情况下，以动态、透明的方式给单个对象添加职责。</li><li>需要动态地给一个对象增加功能，这些功能也可以动态地被撤销。</li><li>当不能采用继承的方式对系统进行扩充或者采用继承不利于系统扩展和维护时。不能采用继承的情况主要有两类：第一类是系统中存在大量独立的扩展，为支持每一种组合将产生大量的子类，使得子类数目呈爆炸性增长；第二类是因为类定义不能继承（如final类）。</li></ul><h3 id="模式扩展"><a href="#模式扩展" class="headerlink" title="模式扩展"></a>模式扩展</h3><p>装饰模式的简化-需要注意的问题:</p><ul><li>一个装饰类的接口必须与被装饰类的接口保持相同，对于客户端来说无论是装饰之前的对象还是装饰之后的对象都可以一致对待。</li><li>尽量保持具体构件类Component作为一个“轻”类，也就是说不要把太多的逻辑和状态放在具体构件类中，可以通过装饰类。</li><li>如果只有一个具体构件类而没有抽象构件类，那么抽象装饰类可以作为具体构件类的直接子类。</li></ul><h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><ul><li>装饰模式用于动态地给一个对象增加一些额外的职责，就增加对象功 能来说，装饰模式比生成子类实现更为灵活。它是一种对象结构型模式。</li><li>装饰模式包含四个角色：抽象构件定义了对象的接口，可以给这些对 象动态增加职责（方法）；具体构件定义了具体的构件对象，实现了 在抽象构件中声明的方法，装饰器可以给它增加额外的职责（方法）； 抽象装饰类是抽象构件类的子类，用于给具体构件增加职责，但是具 体职责在其子类中实现；具体装饰类是抽象装饰类的子类，负责向构 件添加新的职责。</li><li>使用装饰模式来实现扩展比继承更加灵活，它以对客户透明的方式动 态地给一个对象附加更多的责任。装饰模式可以在不需要创造更多子 类的情况下，将对象的功能加以扩展。</li><li>装饰模式的主要优点在于可以提供比继承更多的灵活性，可以通过一种动态的方式来扩展一个对象的功能，并通过使用不同的具体装饰类以及这些装饰类的排列组合，可以创造出很多不同行为的组合，而且具体构件类与具体装饰类可以独立变化，用户可以根据需要增加新的具体构件类和具体装饰类；其主要缺点在于使用装饰模式进行系统设计时将产生很多小对象，而且装饰模式比继承更加易于出错，排错也很困难，对于多次装饰的对象，调试时寻找错误可能需要逐级排查，较为烦琐。</li><li>装饰模式适用情况包括：在不影响其他对象的情况下，以动态、透明的方式给单个对象添加职责；需要动态地给一个对象增加功能，这些功能也可以动态地被撤销；当不能采用继承的方式对系统进行扩充或者采用继承不利于系统扩展 和维护时。</li><li>装饰模式可分为透明装饰模式和半透明装饰模式：在透明装饰模式中，要求客户端完全针对抽象编程，装饰模式的透明性要求客户端程序不应该声明具体构件类型和具体装饰类型，而应该全部声明为抽象构件类型；半透明装饰模式允许用户在客户端声明具体装饰者类型的对象，调用在具体装饰者中新增的方法。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象设计之策略模式</title>
      <link href="/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-ce-lue-mo-shi/"/>
      <url>/post/ruan-jian-she-ji/she-ji-mo-shi/java-mian-xiang-dui-xiang-she-ji-zhi-ce-lue-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、模式动机"><a href="#一、模式动机" class="headerlink" title="一、模式动机"></a>一、模式动机</h2><p>完成一项任务，往往可以有多种不同的方式，每一种方式称为一个策略，我们可以根据环境或者条件的不同选择不同的策略来完成该项任务。在软件开发中也常常遇到类似的情况，实现某一个功能有多个途径，此时可以使用一种设计模式来使得系统可以灵活地选择解决途径，也能够方便地增加新的解决途径。</p><p>在软件系统中，有许多算法可以实现某一功能，如查找、排序等，一种常用的方法是硬编码(<code>Hard Coding</code>)在一个类中，如需要提供多种查找算法，可以将这些算法写到一个类中，在该类中提供多个方法，每一个方法对应一个具体的查找算法；当然也可以将这些查找算法封装在一个统一的方法中，通过if…else…等条件判断语句来进行选择。这两种实现方法我们都可以称之为硬编码，如果需要增加一种新的查找算法，需要修改封装算法类的源代码；更换查找算法，也需要修改客户端调用代码。在这个算法类中封装了大量查找算法，该类代码将较复杂，维护较为困难。</p><p>除了提供专门的查找算法类之外，还可以在客户端程序中直接包含算法代码，这种做法更不可取，将导致客户端程序庞大而且难以维护，如果存在大量可供选择的算法时问题将变得更加严重。</p><p>为了解决这些问题，可以<strong>定义一些独立的类来封装不同的算法，每一个类封装一个具体的算法，在这里，每一个封装算法的类我们都可以称之为策略(Strategy)，为了保证这些策略的一致性，一般会用一个抽象的策略类来做算法的定义，而具体每种算法则对应于一个具体策略类</strong>。</p><h2 id="二、模式定义"><a href="#二、模式定义" class="headerlink" title="二、模式定义"></a>二、模式定义</h2><blockquote><p>**策略模式(Strategy Pattern)：定义一系列算法，将每一个算法封装起来，并让它们可以相互替换。策略模式让算法独立于使用它的客户而变化，也称为政策模式(Policy)**。</p></blockquote><p>策略模式是一种对象行为型模式。</p><h2 id="三、-模式结构"><a href="#三、-模式结构" class="headerlink" title="三、 模式结构"></a>三、 模式结构</h2><p>策略模式包含如下角色：</p><ul><li>Context: 环境类</li><li>Strategy: 抽象策略类</li><li>ConcreteStrategy: 具体策略类</li></ul><h3 id="结构图"><a href="#结构图" class="headerlink" title="结构图"></a>结构图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/09/14/strategy-structure.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/09/14/strategy-structure.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="策略模式结构图"></p><h3 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h3><p><img src="https://statics.sh1a.qingstor.com/2018/09/14/strategy-seq.jpg" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2018/09/14/strategy-seq.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="策略模式时序图"></p><h2 id="四、示例代码"><a href="#四、示例代码" class="headerlink" title="四、示例代码"></a>四、示例代码</h2><p>首先定义一个策略接口：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IStrategy</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 策略模式的运算法则     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后是具体的策略实现类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteStrategy1</span> <span class="token keyword">implements</span> <span class="token class-name">IStrategy</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"具体策略的策略方法1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteStrategy2</span> <span class="token keyword">implements</span> <span class="token class-name">IStrategy</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"具体策略的策略方法2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接着是封装角色的类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 抽象策略</span>    <span class="token keyword">private</span> <span class="token class-name">IStrategy</span> strategy<span class="token punctuation">;</span>    <span class="token comment">/**     * 构造函数设置具体策略     * @param strategy     */</span>    <span class="token keyword">public</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token class-name">IStrategy</span> strategy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>strategy <span class="token operator">=</span> strategy<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 封装后的策略方法     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAnything</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>strategy<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后是客户端的调用策略类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 声明一个具体的策略</span>        <span class="token class-name">IStrategy</span> strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteStrategy1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 声明上下文对象</span>        <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 执行封装后的方法</span>        context<span class="token punctuation">.</span><span class="token function">doAnything</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="五、模式分析"><a href="#五、模式分析" class="headerlink" title="五、模式分析"></a>五、模式分析</h2><h3 id="总体分析"><a href="#总体分析" class="headerlink" title="总体分析"></a>总体分析</h3><ul><li>策略模式是一个比较容易理解和使用的设计模式，策略模式是对算法的封装，它把算法的责任和算法本身分割开，委派给不同的对象管理。策略模式通常把一个系列的算法封装到一系列的策略类里面，作为一个抽象策略类的子类。用一句话来说，就是“<strong>准备一组算法，并将每一个算法封装起来，使得它们可以互换</strong>”。</li><li>在策略模式中，应当由客户端自己决定在什么情况下使用什么具体策略角色。</li><li>策略模式仅仅封装算法，提供新算法插入到已有系统中，以及老算法从系统中“退休”的方便，策略模式并不决定在何时使用何种算法，算法的选择由客户端来决定。这在一定程度上提高了系统的灵活性，但是客户端需要理解所有具体策略类之间的区别，以便选择合适的算法，这也是策略模式的缺点之一，在一定程度上增加了客户端的使用难度。</li></ul><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>策略模式的优点：</p><ul><li>策略模式提供了对“开闭原则”的完美支持，用户可以在不修改原有系统的基- 础上选择算法或行为，也可以灵活地增加新的算法或行为。</li><li>策略模式提供了管理相关的算法族的办法。</li><li>策略模式提供了可以替换继承关系的办法。</li><li>使用策略模式可以避免使用多重条件转移语句。</li></ul><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>策略模式的缺点：</p><ul><li>客户端必须知道所有的策略类，并自行决定使用哪一个策略类。</li><li>策略模式将造成产生很多策略类，可以通过使用享元模式在一定程度上减少对象的数量。</li></ul><h3 id="适用环境"><a href="#适用环境" class="headerlink" title="适用环境"></a>适用环境</h3><p>在以下情况下可以使用策略模式：</p><ul><li>如果在一个系统里面有许多类，它们之间的区别仅在于它们的行为，那么使用策略模式可以动态地让一个对象在许多行为中选择一种行为。</li><li>一个系统需要动态地在几种算法中选择一种。</li><li>如果一个对象有很多的行为，如果不用恰当的模式，这些行为就只好使用多重的条件选择语句来实现。</li><li>不希望客户端知道复杂的、与算法相关的数据结构，在具体策略类中封装算法和相关的数据结构，提高算法的保密性与安全性。</li></ul><h3 id="模式扩展"><a href="#模式扩展" class="headerlink" title="模式扩展"></a>模式扩展</h3><p>策略模式与状态模式：</p><ul><li>可以通过环境类状态的个数来决定是使用策略模式还是状态模式。</li><li>策略模式的环境类自己选择一个具体策略类，具体策略类无须关心环境类；而状态模式的环境类由于外在因素需要放进一个具体状态中，以便通过其方法实现状态的切换，因此环境类和状态类之间存在一种双向的关联关系。</li><li>使用策略模式时，客户端需要知道所选的具体策略是哪一个，而使用状态模式时，客户端无须关心具体状态，环境类的状态会根据用户的操作自动转换。</li><li>如果系统中某个类的对象存在多种状态，不同状态下行为有差异，而且这些状态之间可以发生转换时使用状态模式；如果系统中某个类的某一行为存在多种实现方式，而且这些实现方式可以互换时使用策略模式。</li></ul><h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><ul><li>在策略模式中定义了一系列算法，将每一个算法封装起来，并让它们可以相互替换。策略模式让算法独立于使用它的客户而变化，也称为政策模式。策略模式是一种对象行为型模式。</li><li>策略模式包含三个角色：环境类在解决某个问题时可以采用多种策略，在环境类中维护一个对抽象策略类的引用实例；抽象策略类为所支持的算法声明了抽象方法，是所有策略类的父类；具体策略类实现了在抽象策略类中定义的算法。</li><li>策略模式是对算法的封装，它把算法的责任和算法本身分割开，委派给不同的对象管理。策略模式通常把一个系列的算法封装到一系列的策略类里面，作为一个抽象策略类的子类。</li><li>策略模式主要优点在于对“开闭原则”的完美支持，在不修改原有系统的基础上可以更换算法或者增加新的算法，它很好地管理算法族，提高了代码的复用性，是一种替换继承，避免多重条件转移语句的实现方式；其缺点在于客户端必须知道所有的策略类，并理解其区别，同时在一定程度上增加了系统中类的个数，可能会存在很多策略类。</li><li>策略模式适用情况包括：在一个系统里面有许多类，它们之间的区别仅在于它们的行为，使用策略模式可以动态地让一个对象在许多行为中选择一种行为；一个系统需要动态地在几种算法中选择一种；避免使用难以维护的多重条件选择语句；希望在具体策略类中封装算法和与相关的数据结构。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 软件设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript基础教程</title>
      <link href="/post/qian-duan/javascript-ji-chu-jiao-cheng/"/>
      <url>/post/qian-duan/javascript-ji-chu-jiao-cheng/</url>
      
        <content type="html"><![CDATA[<h2 id="一、JavaScript介绍"><a href="#一、JavaScript介绍" class="headerlink" title="一、JavaScript介绍"></a>一、JavaScript介绍</h2><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript">JavaScript</a>是目前所有主流浏览器上唯一支持的脚本语言，这也是早期<code>JavaScript</code>的唯一用途。其主要作用是在不与服务器交互的情况下修改<code>HTML</code>页面内容，因此其最关键的部分是<code>DOM</code>（文档对象模型），也就是<code>HTML</code>元素的结构。通过<code>Ajax</code>可以使<code>HTML</code>页面通过<code>JavaScript</code>，在不重新加载页面的情况下从服务器上获取数据并显示，大幅提高用户体验。通过<code>JavaScript</code>，使<code>Web</code>页面发展成胖客户端成为可能。</p><h3 id="语言的性质"><a href="#语言的性质" class="headerlink" title="语言的性质"></a>语言的性质</h3><p>本节对<code>JavaScript</code>的性质做简要介绍，以帮你理解一些疑问。</p><p><code>JavaScript</code>和<code>ECMAScript</code>（JavaScript versus ECMAScript）<br>编程语言称为<code>JavaScript</code>，语言标准被称为<code>ECMAScript</code>。他们有不同名字的原因是因为“Java”已经被注册为商标（属于Oracle）。目前，只有<code>Mozilla</code>被正式允许使用“JavaScript”名称，因为很久以前他们得到一份许可。因此，开放的语言标准拥有不同的名字。当前的<code>JavaScript</code>版本是<code>ECMAScript 6</code>，<code>ECMAScript 7</code>当前是开发版。</p><p><code>JavaScript</code>之父，<code>Brendan Eich</code><a href="http://yanhaijing.com/javascript/2013/06/22/javascript-designing-a-language-in-10-days/">迅速了创建一门编程语言</a>。（否则，Netscape将使用其他技术）。他借鉴了几门其他语言的一些特性：</p><ul><li>JavaScript借鉴了Java的语法和如何区分原始值和对象。</li><li>JavaScript的函数设计受Scheme和AWK的启发——他们（的函数）都是第一类（first-class）对象，并且在语言中广泛使用。闭包使他们（函数）变成强大的工具。</li><li>Self影响了JavaScript独一无二的面向对象编程(OOP)风格。它的核心思想（在这里我们没有提到）非常优雅，基于此创建的语言非常少。但后面会提到一个简单的模式照顾大部分用例。JavaScript面向对象编程的杀手级特性是你可以直接创建对象。不需要先创建类或其他类似的东西。</li><li>Perl和Python影响了JavaScript字符串，数组和正则表达式的操作。</li></ul><p><code>JavaScript</code>在最初的时候并不是一个完善的语言，因此也导致<code>JavaScript</code>遗留了很多令人诟病的问题。在开发稍大规模的应用时会显得力不从心，但是由于<code>JavaScript</code>本身是一种非常灵活的语言，因此在它的基础上开发程序库比较容易，因此出现了一大批非常优秀的第三方库，如<a href="http://jquery.com/">jQuery</a>，<a href="http://extjs.org.cn/">ExtJS</a>，<a href="http://underscorejs.org/">underscorejs</a>，<a href="http://backbonejs.org/">backbone</a>等等，由于这些第三方库，<code>JavaScript</code>变得非常简单。其中<code>jQuery</code>的使用非常广泛，它大幅简化了<code>DOM</code>和<code>Ajax</code>，已经成为了很多网站的标配。<code>jQuery</code>虽然基于<code>JavaScript</code>，但它提供了另外一种编程范式，也就是逻辑式编程，与<code>SQL</code>和正则表达式类似。</p><h3 id="JavaScript能做什么"><a href="#JavaScript能做什么" class="headerlink" title="JavaScript能做什么"></a>JavaScript能做什么</h3><p><img src="https://statics.sh1a.qingstor.com/2020/11/29/js.png" class="lazyload placeholder" data-srcset="https://statics.sh1a.qingstor.com/2020/11/29/js.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="JavaScript项目在Github所占比例"></p><p>如上图，<code>JavaScript</code>作为<a href="https://github.com/">Github</a>上最流行、最火的编程语言，几乎无所不能。这里是<a href="https://segmentfault.com/u/puyart">PuYart</a>的关于<a href="https://segmentfault.com/a/1190000003767058"><code>JavaScript</code>就要统治世界了</a>的文章，可以让我们了解<code>JavaScript</code>到底能做什么的一些介绍。</p><ol><li>Web前端(各种前端工具类库、前端框架、动画效果、数据可视化等)</li><li>服务端开发(<a href="https://nodejs.org/">Node.js</a>)</li><li>移动应用或者<code>Hybrid App</code>(Cordova)</li><li>桌面应用(<a href="http://nwjs.io/">NW.js</a>、<a href="http://electron.atom.io/">Electron</a>)</li><li>游戏(<a href="http://unity3d.com/cn/">Unity3D</a>、<a href="http://www.cocos.com/doc/article/index?type=cocos2d-x&url=/doc/cocos-docs-master/manual/framework/cocos2d-js/catalog/../1-about-cocos2d-js/1-1-a-brief-history/zh.md">Cocos2d-js</a>、<a href="http://pomelo.netease.com/">Pomelo</a>)</li><li>VR(<a href="https://www.phodal.com/blog/why-javascript-will-use-vr-world/">JavaScript在VR世界的应用</a>)</li><li>硬件、嵌入式物联网等(<a href="http://blog.jobbole.com/46055/">Tessel：用JavaScript做嵌入式开发</a>)</li><li>操作系统(<a href="http://node-os.com/">NodeOS</a>)</li></ol><blockquote><p>Atwood’s Law: any application that can be written in JavaScript, will eventually be written in JavaScript.(Atwood定律：凡是能用JavaScript写出来的，最终都会用JavaScript写出来。)</p></blockquote><h2 id="二、-JavaScript语法"><a href="#二、-JavaScript语法" class="headerlink" title="二、 JavaScript语法"></a>二、 JavaScript语法</h2><h3 id="语句和表达式"><a href="#语句和表达式" class="headerlink" title="语句和表达式"></a>语句和表达式</h3><p>了解<code>JavaScript</code>的语法，先来了解两个主要的语法类型：语句和表达式。</p><ul><li>语句通常是“做某些事情”。程序是一组语句的序列。举个例子，下面声明（创建）一个变量 <code>foo</code>： </li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> foo<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>表达式是产生“值”。他们通常位于赋值操作的右边、函数参数等。举个例子： </li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token number">3</span> <span class="token operator">*</span> <span class="token number">7</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>语句和表达式之间的区别最好通过实例说明，<code>JavaScript</code>（像Java）有两种不同的方式实现<code>if-then-else</code>。一种是用语句：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> x<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    x <span class="token operator">=</span> y<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    x <span class="token operator">=</span> <span class="token operator">-</span>y<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>另一种是表达式：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> x <span class="token operator">=</span> y <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> y <span class="token operator">:</span> <span class="token operator">-</span>y<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>你可以将后者作为函数参数（但前者不行）：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">myFunction</span><span class="token punctuation">(</span>y <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> y <span class="token operator">:</span> <span class="token operator">-</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>最后，每当<code>JavaScript</code>期待一个语句，你也可以用一个表达式代替。例如：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">foo</span><span class="token punctuation">(</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>foo(...);</code>是一个语句（也叫做表达式语句），<code>bar(7, 1)</code>则是一个表达式。他们都实现函数调用。</p><h3 id="流程控制语句和语句块"><a href="#流程控制语句和语句块" class="headerlink" title="流程控制语句和语句块"></a>流程控制语句和语句块</h3><p>流程控制语句，其语句体可以是单条语句。举两个例子：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> x<span class="token operator">--</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然而，任何语句总能被语句块代替，花括号包含零或多条语句。因此，你也可以这样写：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    x<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为便于程序的阅读和维护，推荐使用后一种方式，即语句块方式。</p><h3 id="分号"><a href="#分号" class="headerlink" title="分号"></a>分号</h3><p><code>JavaScript</code>中的分号是<a href="http://www.2ality.com/2011/05/semicolon-insertion.html">可选的</a>。但省略（分号）可能会带来意想不到的结果，所以我建议还是写上分号。</p><p>正如上面所看到的，分号作为语句的结尾，但语句块不需要。仅有一种情况下你能看到语句块后面有分号——<strong>函数表达式后面的函数体块</strong>。<strong>表达式作为语句的结尾，后面是分号</strong>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">;</span><span class="token keyword">var</span> <span class="token function-variable function">f</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p><code>JavaScript</code>的注释有两种形式：单行注释和多行注释。单行注释以<code>//</code>开头，以换行符结尾：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">x<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 单行（single-line）注释</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>多行注释用<code>/**/</code>包裹</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/*  这是多行注释 多行哦 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="三、变量和赋值"><a href="#三、变量和赋值" class="headerlink" title="三、变量和赋值"></a>三、变量和赋值</h2><p><code>JavaScript</code>中的变量在使用前必须先声明，否则会报错引用错误（Reference Error）：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> foo<span class="token punctuation">;</span>  <span class="token comment">// 声明变量“foo”</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="赋值"><a href="#赋值" class="headerlink" title="赋值"></a>赋值</h3><p>你可以在声明变量的同时为其赋值：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>你也可以给已经存在的变量重新赋值：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">foo <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 更改变量的值</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="复合赋值操作符"><a href="#复合赋值操作符" class="headerlink" title="复合赋值操作符"></a>复合赋值操作符</h3><p>有很多复合赋值操作符，例如+=。下面的两个赋值操作等价：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>x <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="标识符和变量名"><a href="#标识符和变量名" class="headerlink" title="标识符和变量名"></a>标识符和变量名</h3><p>标识符就是事物的名字，在<code>JavaScript</code>中他们扮演不同的语法角色。例如，变量的名称是一个标识符。</p><p>大体上，标识符的第一个字符可以是任何<code>Unicode</code>字符、美元标志符（$）或下划线（_）。后面可以是任意字符和数字。因此，下面全是合法的标识符：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">arg0_tmp$elemπ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注意</strong>：首字符不能是数字，如果是数字的话，该如何区分是数字还是变量呢？</p></blockquote><p>一些标识符是“保留关键字”——他们是语法的一部分，不能用作变量名。从技术上讲，下面三个标识符不是保留字，但也不应该作为变量名：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token number">Infinity</span> <span class="token number">NaN</span> <span class="token keyword">undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="四、值"><a href="#四、值" class="headerlink" title="四、值"></a>四、值</h2><p><code>JavaScript</code>有所有我们期待的编程语言值类型：布尔，数字，字符串，数组等。<code>JavaScript</code>中的所有值都有属性。每个属性有一个键（或名字）和一个值。你可以使用点（.）操作符读取属性：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">value<span class="token punctuation">.</span>propKey<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>举个例子：字符串<code>abc</code>有属性<code>lenght</code>（长度）</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 得到3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>上面的代码也可以写成下面这样：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'abc'</span><span class="token punctuation">.</span>length <span class="token comment">// 得到3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>点操作符也可以用来给属性赋值：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// 空对象</span>obj<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment">// 创建属性“foo”，设置它为123</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 得到123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>你也可以通过它（.）调用方法：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'hello'</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 得到HELLO</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面，我们在值<code>hello</code>上面调用方法<code>toUpperCase()</code>。</p><h3 id="原始类型值和对象"><a href="#原始类型值和对象" class="headerlink" title="原始类型值和对象"></a>原始类型值和对象</h3><p>JavaScript定义了不同值之间的区别：</p><ul><li>原始值包括：<code>boolean</code>，<code>number</code>，<code>string</code>，<code>null</code>和<code>undefined</code>。</li><li>所有其他的值都是对象。实际上对象被定义为——所有不为原始值的值。</li></ul><p>两者之间的主要区别在于他们是如何被比较的：每一个对象有一个独一无二的标志，并且仅和自己相等：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// 一个空对象</span><span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// 另一个空对象</span>obj1 <span class="token operator">===</span> obj2   <span class="token comment">// false</span>obj1 <span class="token operator">===</span> obj1   <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>相反，所有原始值只要编码值相同就被认为是相同的：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> prim1 <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span><span class="token keyword">var</span> prim2 <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>prim1 <span class="token operator">===</span> prim2 <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="原始类型值"><a href="#原始类型值" class="headerlink" title="原始类型值"></a>原始类型值</h3><p>下面全是原始类型值（简称：原始值）：</p><ul><li><p>布尔类型：true，false</p></li><li><p>数字类型：1736，1.351</p></li><li><p>字符串类型: ‘abc’，”abc”</p></li><li><p>两个“无值（non-values）”：undefined，null<br>原始值的特征：</p></li><li><p><strong>值做比较时,“内容”做比较</strong>。</p></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token number">3</span> <span class="token operator">===</span> <span class="token number">3</span> <span class="token comment">// true</span><span class="token string">'abc'</span> <span class="token operator">===</span> <span class="token string">'abc'</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><strong>无法更改</strong>：值的属性无法更改，无法添加和移除属性，获取未知属性总返回undefined。</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span>str<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// try to create property `foo` ⇒ no effect</span>str<span class="token punctuation">.</span>foo  <span class="token comment">// unknown property ⇒  undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h3><h4 id="对象的类型"><a href="#对象的类型" class="headerlink" title="对象的类型"></a>对象的类型</h4><p>所有非原始值的值都是对象。最常见的几种对象类型是：</p><ul><li>简单对象（类型是<code>Object</code>）能通过对象字面量创建：</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>    firstName<span class="token operator">:</span> ‘Jane’<span class="token punctuation">,</span>     lastName<span class="token operator">:</span> ‘Doe’<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>上面的对象有两个属性：<code>firstName</code>属性的值是“Jane”，<code>lastName</code>属性的值是“Doe”。</p><ul><li>数组（类型是<code>Array</code>）能通过数组字面量创建：</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span> ‘apple’<span class="token punctuation">,</span> ‘banana’<span class="token punctuation">,</span> ‘cherry’ <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面的数组有三个元素，可以通过数字索引访问。例如“apple”的索引是0。</p><ul><li>正则表达式对象（类型是<code>RegExp</code>）能通过正则表达式字面量创建。</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^a+b+$</span><span class="token regex-delimiter">/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="对象的特征"><a href="#对象的特征" class="headerlink" title="对象的特征"></a>对象的特征</h4><ul><li><strong>比较的是引用</strong>：比较的是标识符，每个值有自己的标识符。</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token operator">===</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token comment">// 两个不同的空对象, false</span><span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">var</span> obj2 <span class="token operator">=</span> obj1<span class="token punctuation">;</span>obj1 <span class="token operator">===</span> obj2   <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li><strong>默认可以更改</strong>。</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>obj<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>obj<span class="token punctuation">.</span>foo <span class="token comment">//123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>所有的数据结构（如数组）都是对象，但并不是所有的对象都是数据结构。例如：正则表达式是对象，但不是数据结构。</p><h3 id="undefined-和-null"><a href="#undefined-和-null" class="headerlink" title="undefined 和 null"></a>undefined 和 null</h3><p><code>JavaScript</code>有两个“无值）”：<code>undefined</code>和<code>null</code>。</p><p><code>undefined</code>的意思是“没有值”。未初始化的变量是<code>undefined</code>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> foo<span class="token punctuation">;</span>foo <span class="token comment">// undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>读取不存在的属性时，将返回<code>undefined</code>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">></span> <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 空对象</span><span class="token operator">></span> obj<span class="token punctuation">.</span>foo <span class="token comment">// undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>缺省的参数也是<code>undefined</code>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> x<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>null</code>的意思是“没有对象”。它被用来表示对象的无值（参数，链上的对象等）。</p><p>通常情况下你应该把<code>undefined</code>和<code>null</code>看成是等价的，如果他们代表相同意义的无值的话。检查他们的一种方式是通过严格比较：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> x <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>另一种在实际中使用的方法是认为undefined 和 null 都是false：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>警告</strong>：false，0，NaN 和 “” 都被当作false。</p></blockquote><h3 id="包装类型"><a href="#包装类型" class="headerlink" title="包装类型"></a>包装类型</h3><p>对象类型的实例<code>Foo</code>（包括内建类型，例如Array和其他自定义类型）从对象<code>Foo.prototype</code>上获取方法。你可以通过读取这个方法的方式（不是调用）验证这点：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>push <span class="token operator">===</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>push  <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>相反，<strong>原始类型是没有类型的，所以每个原始类型有一个关联类型，称之为包装类型</strong>：</p><ul><li>布尔值的包装类型是 Boolean。布尔值从Boolean.prototype上获取方法：</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">></span> <span class="token boolean">true</span><span class="token punctuation">.</span>toString <span class="token operator">===</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString    <span class="token comment">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>注意：包装类型名字的首字母是大写的B。如果在JavaScript中布尔值的类型可以访问，那么它可能会被转换为布尔对象。</p></blockquote><ul><li>数字值的包装类型是<code>Number</code>。</li><li>字符串值的包装类型是<code>String</code>。</li></ul><p>包装类型也有实例（他们的实例是对象），但不常用。相反，包装类型有其他用处：<strong>如果你将他们作为函数调用，他们可以将值转换为原始类型</strong>。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">Number</span><span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span> <span class="token comment">//123</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token comment">//'true'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="通过typeof和instanceof将值分类"><a href="#通过typeof和instanceof将值分类" class="headerlink" title="通过typeof和instanceof将值分类"></a>通过typeof和instanceof将值分类</h3><p>有两个操作符可以用来将值分类：<code>typeof</code>主要用于原始值，<code>instanceof</code>主要用于对象。</p><h4 id="typeof-使用方法如下："><a href="#typeof-使用方法如下：" class="headerlink" title="typeof 使用方法如下："></a>typeof 使用方法如下：</h4><p><code>typeof «value»</code></p><p><code>typeof</code>返回描述<code>value</code>“类型”的一个字符串。例如：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">typeof</span> <span class="token boolean">true</span> <span class="token comment">//'boolean'</span><span class="token keyword">typeof</span> <span class="token string">'abc'</span> <span class="token comment">//'string'</span><span class="token keyword">typeof</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// 空对象字面量,'object'</span><span class="token keyword">typeof</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 空数组字面量,'object'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>下面列出了<code>typeof</code>操作的所有结果：</p><pre class="line-numbers language-none"><code class="language-none">操作数 结果undefined&#39;undefined&#39;null&#39;object&#39;Boolean value&#39;boolean&#39;Number value&#39;number&#39;String value&#39;string&#39;Function&#39;function&#39;All other values&#39;object&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>有两个结果和我们上面说的的原始值与对象是矛盾的：</p><ul><li>函数的类型是<code>function</code>而不是<code>object</code>。因为函数（类型为“function”）是对象（类型是对象）的子类型，这不是一个错误。</li><li><code>null</code>的类型是<code>object</code>。这是一个bug，但从没被修复，因为修复后会破坏现有的代码。</li></ul><h4 id="instanceof使用方法如下："><a href="#instanceof使用方法如下：" class="headerlink" title="instanceof使用方法如下："></a>instanceof使用方法如下：</h4><p><code>«value» instanceof «Constr»</code></p><p>如果<code>value</code>是一个对象，并且<code>value</code> 是由构造函数<code>Constr</code>创建的（参考：类）。例如：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 通过构造函数Bar创建对象</span>b <span class="token keyword">instanceof</span> <span class="token class-name">Bar</span>    <span class="token comment">//true</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token keyword">instanceof</span> <span class="token class-name">Object</span>    <span class="token comment">//true</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Array</span> <span class="token comment">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="深入阅读"><a href="#深入阅读" class="headerlink" title="深入阅读"></a>深入阅读</h3><ul><li><a href="http://yanhaijing.com/javascript/2014/01/05/exploring-the-abyss-of-null-and-undefined-in-javascript/">探索JavaScript中Null和Undefined的深渊</a></li></ul><h2 id="五、布尔"><a href="#五、布尔" class="headerlink" title="五、布尔"></a>五、布尔</h2><p>布尔类型原始值包括<code>true</code>和<code>false</code>。下面的操作符会得到布尔值：</p><ul><li>二元逻辑运算符：&amp;&amp;（与），||（或）</li><li>前缀逻辑运算符：!（非）</li><li>等值运算符：=== !== == !=</li><li>比较运算符（字符串或数字）：&gt; &gt;= &lt; &lt;=</li></ul><h3 id="真值和假值"><a href="#真值和假值" class="headerlink" title="真值和假值"></a>真值和假值</h3><p>每当<code>JavaScript</code>希望一个布尔值时（例如：if语句的条件），可以使用任何值。它将被理解（转换）为<code>true</code>或<code>false</code>。下面的值被理解为<code>false</code>：</p><ul><li>undefined, null</li><li>布尔: false</li><li>数字: 0, NaN</li><li>字符串: ‘’</li></ul><p>所有其他值被认为<code>true</code>。被理解为<code>false</code>的值称为假值，被理解为<code>true</code>的值称为真值。可以使用<code>Boolean</code>作为函数，测试值被理解为什么。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">Boolean</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>  <span class="token comment">//false</span><span class="token function">Boolean</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">//false</span><span class="token function">Boolean</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>    <span class="token comment">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="二元逻辑运算符"><a href="#二元逻辑运算符" class="headerlink" title="二元逻辑运算符"></a>二元逻辑运算符</h3><p><code>JavaScript</code>中的<strong>二元逻辑运算符是短路运算</strong>——如果第一个操作数可以确定结果，第二个操作数将不被验证（运算）。例如，在下面的代码中，函数<code>foo()</code>永远不会被调用。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token boolean">true</span> <span class="token operator">||</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>此外，<strong>二元逻辑运算符会返回操作数中的一个</strong>，可能是一个布尔值，也可能不是。</p><ul><li><strong>与</strong>：如果第一个操作数是假值，返回第一个。否则返回第二个操作数。</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token number">NaN</span> <span class="token operator">&amp;&amp;</span> <span class="token string">'abc'</span>    <span class="token comment">//NaN</span><span class="token number">123</span> <span class="token operator">&amp;&amp;</span> <span class="token string">'abc'</span>    <span class="token comment">//'abc'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><strong>或</strong>：如果第一个操作数是真值，返回第一个。否则，返回第二个操作数。</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'abc'</span> <span class="token operator">||</span> <span class="token number">123</span>    <span class="token comment">//'abc'</span><span class="token string">''</span> <span class="token operator">||</span> <span class="token number">123</span>   <span class="token comment">//123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="等值运算符"><a href="#等值运算符" class="headerlink" title="等值运算符"></a>等值运算符</h3><p>在<code>JavaScript</code>中检测相等，你可以使用严格相等（<code>===</code>）和严格不等（<code>!==</code>）。或者你也可以使用非严格相等（<code>==</code>）和非严格不等（<code>!=</code>）。</p><blockquote><p><strong>经验规则：总是用严格运算符，假装非严格运算符不存在。严格相等更安全。</strong></p></blockquote><h3 id="深入阅读-1"><a href="#深入阅读-1" class="headerlink" title="深入阅读"></a>深入阅读</h3><ul><li><a href="http://yanhaijing.com/javascript/2014/04/25/strict-equality-exemptions/">在JavaScript中什么时候使用==是正确的？</a></li></ul><h2 id="六、数字"><a href="#六、数字" class="headerlink" title="六、数字"></a>六、数字</h2><p><code>JavaScript</code>中的<strong>所有数字都是浮点型</strong>（虽然大部分的JavaScript引擎内部也使用整数）。至于为什么这样设计，查看这里（<a href="http://yanhaijing.com/javascript/2014/03/14/what-every-javascript-developer-should-know-about-floating-points">每一个JavaScript开发者应该了解的浮点知识</a>）。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token number">1</span> <span class="token operator">===</span> <span class="token number">1.0</span>   <span class="token comment">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>特殊数字：</p><ul><li><code>NaN</code> (“不是一个数字 not a number”): 错误值。</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">Number</span><span class="token punctuation">(</span><span class="token string">'xyz'</span><span class="token punctuation">)</span>  <span class="token comment">// 'xyz' 不能被转换为数字得到:NaN</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><code>Infinity</code>：也是最大错误值（无穷大）</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token number">3</span> <span class="token operator">/</span> <span class="token number">0</span>   <span class="token comment">//Infinity</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token comment">// 数字太大了,得到Infinity</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>Infinity</code>有时很有用，因为它比任何其他数字都大。同样，<code>-Infinity</code> 比其他任何数字都小。</p><ul><li><code>JavaScript</code>有两个零，<code>+0</code>和<code>-0</code>。它（js引擎）通常不让你看到，并简单将两个零都显示为0：</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">+</span><span class="token number">0</span>  <span class="token comment">//0</span><span class="token operator">-</span><span class="token number">0</span>  <span class="token comment">//0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>因此最好假装只有一个零（正如我们看到假值时所做的那样：**-0 和 +0 都是假值**）。</p><h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><p><code>JavaScript</code>中有下列算数运算符：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">加<span class="token operator">:</span> number1 <span class="token operator">+</span> number2减<span class="token operator">:</span> number1 <span class="token operator">-</span> number2乘<span class="token operator">:</span> number1 <span class="token operator">*</span> number2除<span class="token operator">:</span> number1 <span class="token operator">/</span> number2模<span class="token operator">:</span> number1 <span class="token operator">%</span> number2自增<span class="token operator">:</span> <span class="token operator">++</span>variable<span class="token punctuation">,</span> variable<span class="token operator">++</span>自减<span class="token operator">:</span> –variable<span class="token punctuation">,</span> variable–负值<span class="token operator">:</span> <span class="token operator">-</span>value正值（转换为数字）<span class="token operator">:</span> <span class="token operator">+</span>value<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>全局对象<code>Math</code>通过函数提供更多算数运算操作。</p><p><code>JavaScript</code>中也有位运算符（例如：&amp;）。</p><h2 id="七、字符串"><a href="#七、字符串" class="headerlink" title="七、字符串"></a>七、字符串</h2><p>字符串可以直接通过字符串字面量创建。这些字面量被单引号或双引号包裹。反斜线（\）转义字符并且产生一些控制字符。例如：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'abc'</span><span class="token string">"abc"</span><span class="token string">'Did she say "Hello"?'</span><span class="token string">"Did she say \"Hello\"?"</span><span class="token string">'That\'s nice!'</span><span class="token string">"That's nice!"</span><span class="token string">'Line 1\nLine 2'</span>  <span class="token comment">// 换行</span><span class="token string">'Backlash: \\'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以通过方括号访问单个字符：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span>str<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    <span class="token comment">//'b'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>length</code>属性是字符串的字符数量。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'abc'</span><span class="token punctuation">.</span>length  <span class="token comment">//3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p><strong>提醒</strong>：字符串是不可变的，如果你想改变现有字符串，你需要创建一个新的字符串。</p></blockquote><h3 id="字符串运算符"><a href="#字符串运算符" class="headerlink" title="字符串运算符"></a>字符串运算符</h3><p>字符串可以通过加号操作符（+）拼接，如果其中一个操作数为字符串，会将另一个操作数也转换为字符串。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> msgCount <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token string">'You have '</span><span class="token operator">+</span> msgCount <span class="token operator">+</span> <span class="token string">' messages'</span> <span class="token comment">//'You have 3 messages'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>连续执行拼接操作可以使用<code>+=</code>操作符：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>str <span class="token operator">+=</span> <span class="token string">'Multiple '</span><span class="token punctuation">;</span>str <span class="token operator">+=</span> <span class="token string">'pieces '</span><span class="token punctuation">;</span>str <span class="token operator">+=</span> <span class="token string">'are concatenated.'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//'Multiple pieces are concatenated.'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="字符串方法"><a href="#字符串方法" class="headerlink" title="字符串方法"></a>字符串方法</h3><p>字符串有许多有用的方法。例如：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'abc'</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// 复制子字符串,得到索引1及其之后的字符串，即：'bc'</span><span class="token string">'abc'</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment">//得到索引1和2之间的字符串，即：'b'</span><span class="token string">'\t xyz  '</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 移除空白字符，即：'xyz'</span><span class="token string">'mjölnir'</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//转成大写，即：'MJÖLNIR'</span><span class="token string">'abc'</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>  <span class="token comment">// 查找第一个b的索引，即：1</span><span class="token string">'abc'</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span>    <span class="token comment">//没有返回-1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="八、语句"><a href="#八、语句" class="headerlink" title="八、语句"></a>八、语句</h2><h3 id="条件（Conditionals）"><a href="#条件（Conditionals）" class="headerlink" title="条件（Conditionals）"></a>条件（Conditionals）</h3><p><code>if</code>语句通过布尔条件决定执行那个分支：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>myvar <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// then</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>myvar <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// then</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// else</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>myvar <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// then</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>myvar <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// else-if</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>myvar <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// else-if</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// else</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面的<code>switch</code>语句，furit的值决定那个分支被执行。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">switch</span> <span class="token punctuation">(</span>fruit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> <span class="token string">'banana'</span><span class="token operator">:</span>        <span class="token comment">// ...</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token string">'apple'</span><span class="token operator">:</span>        <span class="token comment">// ...</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>  <span class="token comment">// 所有其他情况</span>        <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="循环（Loops）"><a href="#循环（Loops）" class="headerlink" title="循环（Loops）"></a>循环（Loops）</h3><p>for 循环的格式如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">for</span><span class="token punctuation">(</span>初始化<span class="token punctuation">;</span> 当条件成立时循环<span class="token punctuation">;</span> 下一步操作<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例子：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>当条件成立时<code>while</code>循环继续循环它的循环体。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 和上面的for循环相等</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当条件成立时，<code>do-while</code>循环继续循环。由于条件位于循环体之后，所以循环体总是被至少至少执行一次。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span> <span class="token keyword">while</span><span class="token punctuation">(</span>条件<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在所有的循环中：</p><ul><li>break中断循环</li><li>continue开始一个新的循环迭代</li></ul><h2 id="九、函数"><a href="#九、函数" class="headerlink" title="九、函数"></a>九、函数</h2><p>定义函数的一种方法是通过函数声明：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">param1<span class="token punctuation">,</span> param2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> param1 <span class="token operator">+</span> param2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>上面的代码定义一个名称叫做<code>add</code>的函数，有两个参数<code>param1</code>和<code>param2</code>，并且返回参数的和。下面是如何调用这个函数：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment">//7</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span>   <span class="token comment">//'ab'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>另一种定义<code>add()</code>函数的方法是通过函数表达式：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param1<span class="token punctuation">,</span> param2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> param1 <span class="token operator">+</span> param2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>函数表达式产生一个值，因此可以直接将函数作为参数传递给其他函数：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">someOtherFunction</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="函数声明提升"><a href="#函数声明提升" class="headerlink" title="函数声明提升"></a>函数声明提升</h3><p>函数声明会被提升，他们全被移动到当前作用域开始之处。这允许你在函数声明之前调用它们：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 没问题，bar被提升</span>    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token operator">...</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注意</strong>：虽然变量声明也会被提升，但赋值的过程不会被提升：</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 有问题，bar是undefined</span>    <span class="token keyword">var</span> <span class="token function-variable function">bar</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// ...</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="特殊变量参数"><a href="#特殊变量参数" class="headerlink" title="特殊变量参数"></a>特殊变量参数</h3><p><strong>在<code>JavaScript</code>中你可以调用任意函数并传递任意数量的参数</strong>——语言绝不会“抱怨”（参数检测）。都可以正常工作，然而，使所有参数可访问需要通过特殊变量<code>arguments</code>。<code>arguments</code>看起来像数组，但它没有数组的方法（称为类数组 array-like）。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> arguments <span class="token punctuation">&#125;</span><span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>args<span class="token punctuation">.</span>length <span class="token comment">//3</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment">// 获取索引为0的元素,'a'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="太多或太少参数"><a href="#太多或太少参数" class="headerlink" title="太多或太少参数"></a>太多或太少参数</h3><p>让我们通过下面的函数探索<code>JavaScript</code>中传递太多或太少参数时如何处理</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>多出的参数将被忽略（可以通过<code>arguments</code>访问）：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">f</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span>    <span class="token comment">//a b</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>缺少的参数将会是<code>undefined</code>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">f</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>    <span class="token comment">//a undefined</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//undefined undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="可选参数"><a href="#可选参数" class="headerlink" title="可选参数"></a>可选参数</h3><p>下面是一个常见模式，给参数设置默认值：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">pair</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    x <span class="token operator">=</span> x <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// (*)</span>    y <span class="token operator">=</span> y <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span> x<span class="token punctuation">,</span> y <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在<code>（*）</code>这行，如果x是真值（除了：<code>null</code>，<code>undefined</code> 等），         操作符返回x。否则，它返回第二个操作数。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">pair</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//[ 0, 0 ]</span><span class="token function">pair</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//[ 3, 0 ]</span><span class="token function">pair</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment">//[ 3, 5 ]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="强制数量"><a href="#强制数量" class="headerlink" title="强制数量"></a>强制数量</h3><p>如果你想强制参数的数量，你可以检测<code>arguments.length</code>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">pair</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Need exactly 2 arguments'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="将arguments-转换为数组"><a href="#将arguments-转换为数组" class="headerlink" title="将arguments 转换为数组"></a>将arguments 转换为数组</h3><p><code>arguments</code>不是一个数组，它仅仅是类数组（array-like）：它有一个<code>length</code>属性，并且你可以通过方括号索引方式访问它的元素。然而，你不能移除元素，或在它上面调用任何数组方法。因此，有时你需要将其转换为数组。这就是下面函数的作用。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">toArray</span><span class="token punctuation">(</span><span class="token parameter">arrayLikeObject</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arrayLikeObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="十、异常处理"><a href="#十、异常处理" class="headerlink" title="十、异常处理"></a>十、异常处理</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/try...catch">异常处理</a>最常见的方式像下面这样：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">throwException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Problem!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token function">throwException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 错误：信息</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 非标准，但大部分浏览器支持</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>try分支包裹易出错的代码，如果try分支内部抛出异常，catch分支将会执行。</p><h2 id="十一、严格模式"><a href="#十一、严格模式" class="headerlink" title="十一、严格模式"></a>十一、严格模式</h2><p>严格模式开启检测和一些其他措施，使<code>JavaScript</code>变成更整洁的语言。推荐使用严格模式。为了开启严格模式，只需在<code>JavaScript</code>文件或<code>script</code>标签第一行添加如下语句：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>你也可以在每个函数上选择性开启严格模式，只需将上面的代码放在函数的开头：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">functionInStrictMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token string">'use strict'</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>下面的两小节看下严格模式的三大好处。</p><h3 id="明确错误"><a href="#明确错误" class="headerlink" title="明确错误"></a>明确错误</h3><p>让我们看一个例子，严格模式给我们明确的错误，否则<code>JavaScript</code>总是静默失败：下面的函数<code>f()</code> 执行一些非法操作，它试图更改所有字符串都有的只读属性——<code>length</code>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token string">'abc'</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>当你调用上面的函数，它静默失败，赋值操作被简单忽略。让我们将<code>f()</code>在严格模式下运行：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f_strict</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token string">'use strict'</span><span class="token punctuation">;</span>    <span class="token string">'abc'</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>现在浏览器报给我们一些错误：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">f_strict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// TypeError: Cannot assign to read only property 'length' of abc</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="不是方法的函数中的this"><a href="#不是方法的函数中的this" class="headerlink" title="不是方法的函数中的this"></a>不是方法的函数中的this</h3><p>在严格模式下，不作为方法的函数中的<code>this</code>值是<code>undefined</code>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f_strict</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token string">'use strict'</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">f_strict</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在非严格模式下，<code>this</code>的值是被称作全局对象（<code>global object</code>）（在浏览器里是<code>window</code>）：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="不再自动创建全局变量"><a href="#不再自动创建全局变量" class="headerlink" title="不再自动创建全局变量"></a>不再自动创建全局变量</h3><p>在非严格模式下，如果你给不存在的变量赋值，<code>JavaScript</code>会自动创建一个全局变量：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> foo <span class="token operator">=</span> <span class="token number">5</span> <span class="token punctuation">&#125;</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 不会报错</span>foo <span class="token comment">// 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在严格模式下，这会产生一个错误：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f_strict</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token string">'use strict'</span><span class="token punctuation">;</span> foo2 <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token function">f_strict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// ReferenceError: foo2 is not defined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="深入阅读-2"><a href="#深入阅读-2" class="headerlink" title="深入阅读"></a>深入阅读</h3><ul><li><a href="http://yanhaijing.com/javascript/2013/12/28/demystifying-this-in-javascript">揭秘javascript中谜一样的this</a></li><li><a href="http://yanhaijing.com/javascript/2014/04/30/javascript-this-keyword">JavaScript中的this关键字</a></li></ul><h2 id="十二、变量作用域和闭包"><a href="#十二、变量作用域和闭包" class="headerlink" title="十二、变量作用域和闭包"></a>十二、变量作用域和闭包</h2><p>在<code>JavaScript</code>中，你必须使用变量之前，通过<code>var</code>声明变量：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> x<span class="token punctuation">;</span>x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>y <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// ReferenceError: y is not defined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>你可以用一条<code>var</code>语句声明和初始化多个变量：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> z <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但我建议每个变量使用一条语句。因此，我将上面的语句重写为：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">var</span> z <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>由于提升（见下文），最好在函数顶部声明变量。</p><h3 id="变量和函数作用域"><a href="#变量和函数作用域" class="headerlink" title="变量和函数作用域"></a>变量和函数作用域</h3><p>变量的作用域总是整个函数（没有块级作用域）。例如：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// (*)</span>        <span class="token keyword">var</span> tmp <span class="token operator">=</span> <span class="token operator">-</span>x<span class="token punctuation">;</span>        <span class="token operator">...</span>    <span class="token punctuation">&#125;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们可以看到tmp变量不仅在（*）所在行的语句块存在，它在整个函数内都存在。</p><h3 id="变量提升"><a href="#变量提升" class="headerlink" title="变量提升"></a>变量提升</h3><p>变量声明会被提升：声明会被移到函数的顶部，但赋值过程不会。举个例子，在下面的函数中<code>（*）</code>行位置声明了一个变量。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">var</span> tmp <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// (*)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在内部，上面的函数被执行像下面这样：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> tmp<span class="token punctuation">;</span>  <span class="token comment">// declaration is hoisted</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        tmp <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// assignment stays put</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><p>每个函数保持和函数体内部变量的连接，甚至离开创建它的作用域之后。例如：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createIncrementor</span><span class="token punctuation">(</span><span class="token parameter">start</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// (*)</span>        <span class="token keyword">return</span> start<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在<code>（*）</code>行开始的函数在它创建时保留上下文，并在内部保存一个<code>start</code>活动值：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> inc <span class="token operator">=</span> <span class="token function">createIncrementor</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// 5</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 6</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// 7</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>闭包是一个函数加上和其作用域链的链接。因此，<code>createIncrementor()</code>返回的是一个闭包。</p><h3 id="IIFE：模拟块级作用域"><a href="#IIFE：模拟块级作用域" class="headerlink" title="IIFE：模拟块级作用域"></a>IIFE：模拟块级作用域</h3><p>有时你想模拟一个块，例如你想将变量从全局作用域隔离。完成这个工作的模式叫做 <code>IIFE</code>(立即执行函数表达式(<code>Immediately Invoked Function Expression</code>))：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 块开始</span>    <span class="token keyword">var</span> tmp <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>  <span class="token comment">// 非全局变量</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 块结束</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>上面你会看到函数表达式被立即执行。外面的括号用来阻止它被解析成函数声明；只有函数表达式能被立即调用。函数体产生一个新的作用域并使<code>tmp</code>变为局部变量。</p><h3 id="闭包实现变量共享"><a href="#闭包实现变量共享" class="headerlink" title="闭包实现变量共享"></a>闭包实现变量共享</h3><p>下面是个经典问题，如果你不知道，会让你费尽思量。因此，先浏览下，对问题有个大概的了解。</p><p>闭包保持和外部变量的连接，有时可能和你想像的行为不一致：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> i <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// (*)</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5 (不是 1)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5 (不是 3)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>(*)</code>行的返回值总是当前的i值，而不是当函数被创建时的i值。当循环结束后，i的值是5，这是为什么数组中的所有函数的返回值总是一样的。如果你想捕获当前变量的快照，你可以使用<code>IIFE</code>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">i2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> i2 <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 复制当前的i</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>深入阅读</p><ul><li><a href="http://yanhaijing.com/javascript/2013/08/30/understanding-scope-and-context-in-javascript">认识javascript中的作用域和上下文</a></li><li><a href="http://yanhaijing.com/javascript/2014/04/30/JavaScript-Scoping-and-Hoisting">JavaScript的作用域和提升机制</a></li><li><a href="http://yanhaijing.com/javascript/2014/04/29/what-is-the-execution-context-in-javascript">了解JavaScript的执行上下文</a></li></ul><h2 id="十三、对象和继承"><a href="#十三、对象和继承" class="headerlink" title="十三、对象和继承"></a>十三、对象和继承</h2><p>和所有的值类型一样，对象有属性。事实上，你可以将对象当作一组属性的集合，每个属性都是一对（键和值）。键是字符串，值可以是任意<code>JavaScript</code>值。到目前为止，我们仅仅见过键是标识符的属性，因为点操作符处理的键必须为标识符。在这节，你讲见到另一种访问属性的方法，能将任意字符串作为键。</p><h3 id="单个对象"><a href="#单个对象" class="headerlink" title="单个对象"></a>单个对象</h3><p>在<code>JavaScript</code>中，你可以直接创建对象，通过对象字面量：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> jane <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    name<span class="token operator">:</span> <span class="token string">'Jane'</span><span class="token punctuation">,</span>    <span class="token function-variable function">describe</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token string">'use strict'</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">'Person named '</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的对象有两个属性：<code>name</code>和<code>describe</code>。你能读（“get”）和 写（“set”）属性：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">jane<span class="token punctuation">.</span>name  <span class="token comment">// get，'Jane'</span>jane<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'John'</span><span class="token punctuation">;</span>  <span class="token comment">// set</span>jane<span class="token punctuation">.</span>newProperty <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span>  <span class="token comment">// 自动创建</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>属性是函数如<code>describe</code>可以被当作方法调用。当调用他们时可以在它们内部通过this引用对象。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">jane<span class="token punctuation">.</span><span class="token function">describe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 调用方法,'Person named John'</span>jane<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Jane'</span><span class="token punctuation">;</span>jane<span class="token punctuation">.</span><span class="token function">describe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'Person named Jane'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><code>in</code>操作符用来检测一个属性是否存在：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'newProperty'</span> <span class="token keyword">in</span> jane   <span class="token comment">// true</span><span class="token string">'foo'</span> <span class="token keyword">in</span> jane   <span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>若读取一个不存在的属性，将会得到<code>undefined</code>值。因此上面的两个检查也可以像下面这样：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">jane<span class="token punctuation">.</span>newProperty <span class="token operator">!==</span> <span class="token keyword">undefined</span>  <span class="token comment">// true</span>jane<span class="token punctuation">.</span>foo <span class="token operator">!==</span> <span class="token keyword">undefined</span>  <span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>delete</code>操作符用来删除一个属性：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">delete</span> jane<span class="token punctuation">.</span>newProperty <span class="token comment">//true</span><span class="token string">'newProperty'</span> <span class="token keyword">in</span> jane   <span class="token comment">//false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="任意键属性"><a href="#任意键属性" class="headerlink" title="任意键属性"></a>任意键属性</h3><p>属性的键可以是任意字符串。到目前为止，我们看到的对象字面量中的和点操作符后的属性关键字。按这种方法你只能使用标识符。如果你想用其他任意字符串作为键名，你必须在对象字面量里加上引号，并使用方括号获取和设置属性。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'not an identifier'</span><span class="token operator">:</span> <span class="token number">123</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>obj<span class="token punctuation">[</span><span class="token string">'not an identifier'</span><span class="token punctuation">]</span>    <span class="token comment">//123</span>obj<span class="token punctuation">[</span><span class="token string">'not an identifier'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">456</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>方括号允许你动态计算属性关键字：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token string">'name'</span><span class="token punctuation">;</span>jane<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 'Jane'</span>jane<span class="token punctuation">[</span><span class="token string">'na'</span><span class="token operator">+</span><span class="token string">'me'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 'Jane'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="引用方法"><a href="#引用方法" class="headerlink" title="引用方法"></a>引用方法</h3><p>如果你引用一个方法，它将失去和对象的连接。就其本身而言，函数不是方法，其中的<code>this</code>值为<code>undefined</code>（严格模式下）。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> func <span class="token operator">=</span> jane<span class="token punctuation">.</span>describe<span class="token punctuation">;</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// TypeError: Cannot read property 'name' of undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>解决办法是使用函数内置的<code>bind()</code>方法。它创建一个新函数，其<code>this</code>值固定为给定的值。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> func2 <span class="token operator">=</span> jane<span class="token punctuation">.</span><span class="token function">describe</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>jane<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'Person named Jane'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="方法内部的函数"><a href="#方法内部的函数" class="headerlink" title="方法内部的函数"></a>方法内部的函数</h3><p>每个函数都有一个特殊变量<code>this</code>。如果你在方法内部嵌入函数是很不方便的，因为你不能从函数中访问方法的<code>this</code>。下面是一个例子，我们调用<code>forEach</code>循环一个数组：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> jane <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    name<span class="token operator">:</span> <span class="token string">'Jane'</span><span class="token punctuation">,</span>    friends<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'Tarzan'</span><span class="token punctuation">,</span> <span class="token string">'Cheeta'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token function-variable function">logHiToFriends</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token string">'use strict'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">friend</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 这里的“this”是undefined</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' says hi to '</span> <span class="token operator">+</span> friend<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用<code>logHiToFriends</code>会产生错误：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">jane<span class="token punctuation">.</span><span class="token function">logHiToFriends</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// TypeError: Cannot read property 'name' of undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>有两种方法修复这问题。</p><ul><li>将<code>this</code>存储在不同的变量。</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">logHiToFriends</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token string">'use strict'</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">friend</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' says hi to '</span> <span class="token operator">+</span> friend<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>forEach的第二个参数允许提供<code>this</code>值。</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">logHiToFriends</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token string">'use strict'</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">friend</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' says hi to '</span> <span class="token operator">+</span> friend<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在<code>JavaScript</code>中函数表达式经常被用作函数参数。时刻小心函数表达式中的<code>this</code>。</p><h3 id="构造函数：对象工厂"><a href="#构造函数：对象工厂" class="headerlink" title="构造函数：对象工厂"></a>构造函数：对象工厂</h3><p>除了作为“真正”的函数和方法，函数还在JavaScript中扮演第三种角色：<strong>如果通过new操作符调用，他们会变为构造函数，对象的工厂</strong>。构造函数是对其他语言中的类的粗略模拟。约定俗成，构造函数的第一个字母大写。例如：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 设置实例数据</span><span class="token keyword">function</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 方法</span><span class="token class-name">Point</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">dist</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们看到构造函数分为两部分：首先，<code>Point</code>函数设置实例数据。其次，<code>Point.prototype</code>属性包含对象的方法。前者的数据是每个实例私有的，后面的数据是所有实例共享的。</p><p>我们通过new操作符调用<code>Point</code>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span>x <span class="token comment">//3</span>p<span class="token punctuation">.</span><span class="token function">dist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//5.830951894845301</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>p是<code>Point</code>的一个实例：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">p <span class="token keyword">instanceof</span> <span class="token class-name">Point</span>  <span class="token comment">//true</span><span class="token keyword">typeof</span> p    <span class="token comment">//'object'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="深入阅读-3"><a href="#深入阅读-3" class="headerlink" title="深入阅读"></a>深入阅读</h3><ul><li><a href="http://yanhaijing.com/javascript/2013/08/23/javascript-inheritance-how-to-shoot-yourself-in-the-foot-with-prototypes">Javascript继承 原型的陷阱</a></li><li><a href="http://yanhaijing.com/javascript/2013/08/30/encapsulation-of-javascript">Javascript 封装问题</a></li></ul><h2 id="十四、数组"><a href="#十四、数组" class="headerlink" title="十四、数组"></a>十四、数组</h2><p>数组是数组元素的序列，能通过整数索引方法数组元素，数组索引从0开始。</p><h3 id="数组字面量"><a href="#数组字面量" class="headerlink" title="数组字面量"></a>数组字面量</h3><p>数组字面量创建数组很方便：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">></span> <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面的数组有三个元素：分别是字符串“a”，“b”， “c”。你可以通过整数索引访问它们：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment">//'a'</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'x'</span><span class="token punctuation">;</span>arr<span class="token comment">// [ 'x', 'b', 'c' ]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>length</code>属性总表示一个数组有多少项元素。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">arr<span class="token punctuation">.</span>length    <span class="token comment">//3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>除此之外它也可以用来从数组上移除尾部元素：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">arr<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> arr <span class="token comment">// [ 'x', 'b' ]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>in</code>操作符也可以在数组上工作。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token number">1</span> <span class="token keyword">in</span> arr <span class="token comment">// arr在索引为1处是否有元素？,true</span><span class="token number">5</span> <span class="token keyword">in</span> arr <span class="token comment">// arr在索引为5处是否有元素？false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>值得注意的是数组是对象，因此可以有对象属性：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">arr<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>arr<span class="token punctuation">.</span>foo   <span class="token comment">// 123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="数组方法"><a href="#数组方法" class="headerlink" title="数组方法"></a>数组方法</h3><p>数组有许多方法。举些例子：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">// 复制元素，[ 'b' ]</span>arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment">// [ 'b', 'c' ]</span>arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span>  <span class="token comment">// 在末尾添加一个元素，4</span>arr <span class="token comment">// [ 'a', 'b', 'c', 'x' ]</span>arr<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 移除最后一个元素，'x'</span>arr   <span class="token comment">// [ 'a', 'b', 'c' ]</span>arr<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 移除第一个元素，'a'</span>arr <span class="token comment">// [ 'b', 'c' ]</span>arr<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span>  <span class="token comment">// 在前面添加一个元素，3</span>arr <span class="token comment">// [ 'x', 'b', 'c' ]</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>  <span class="token comment">// 查找给定项在数组中的索引，若不存在返回-1，</span><span class="token comment">// 1</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span>  <span class="token comment">// -1</span>arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>  <span class="token comment">// 将元素拼接为一个字符串，'x-b-c'</span>arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>    <span class="token comment">// 'xbc'</span>arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 'x,b,c'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="遍历数组"><a href="#遍历数组" class="headerlink" title="遍历数组"></a>遍历数组</h3><p>有几种方法可以遍历数组元素。其中两个最重要的是<code>forEach</code>和<code>map</code>。</p><p><code>forEach</code>遍历整个数组，并将当前元素和它的索引传递给一个函数：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span> <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// (*)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token string">'. '</span> <span class="token operator">+</span> elem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>上面代码的输出</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token number">0.</span> a<span class="token number">1.</span> b<span class="token number">2.</span> c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>注意<code>（*）</code>行的函数参数是可省略的。例如：它可以只有一个参数<code>elem</code>。</p><p><code>map</code>创建一个新数组，通过给每个存在数组元素应用一个函数：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">return</span> x<span class="token operator">*</span>x <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// [ 1, 4, 9 ]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="深入阅读-4"><a href="#深入阅读-4" class="headerlink" title="深入阅读"></a>深入阅读</h3><ul><li><a href="http://yanhaijing.com/javascript/2014/01/17/fun-with-javascript-native-array-functions">有趣的javascript原生数组函数</a></li></ul><h2 id="十五、正则表达式"><a href="#十五、正则表达式" class="headerlink" title="十五、正则表达式"></a>十五、正则表达式</h2><p><code>JavaScript</code>内建支持正则表达式。他们被双斜线分隔：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^abc$</span><span class="token regex-delimiter">/</span></span><span class="token operator">/</span><span class="token punctuation">[</span><span class="token constant">A</span><span class="token operator">-</span>Za<span class="token operator">-</span>z0<span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="方法-test-：测试是否匹配"><a href="#方法-test-：测试是否匹配" class="headerlink" title="方法 test()：测试是否匹配"></a>方法 test()：测试是否匹配</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^a+b+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'aaab'</span><span class="token punctuation">)</span>   <span class="token comment">// true</span><span class="token operator">/</span><span class="token operator">^</span>a<span class="token operator">+</span>b<span class="token operator">+</span>$<span class="token operator">/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">)</span>    <span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="方法-exec-：匹配和捕获组"><a href="#方法-exec-：匹配和捕获组" class="headerlink" title="方法 exec()：匹配和捕获组"></a>方法 exec()：匹配和捕获组</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">a(b+)a</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'_abbba_aba_'</span><span class="token punctuation">)</span>    <span class="token comment">// [ 'abbba', 'bbb' ]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>返回的数组第一项（索引为0）是完整匹配，捕获的第一个分组在第二项（索引为1），等。有一种方法可以反复调用获取所有匹配。</p><h3 id="方法-replace-：搜索并替换"><a href="#方法-replace-：搜索并替换" class="headerlink" title="方法 replace()：搜索并替换"></a>方法 replace()：搜索并替换</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'&lt;a> &lt;bbb>'</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;(.*?)></span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'[$1]'</span><span class="token punctuation">)</span> <span class="token comment">// '[a] [bbb]'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>replace</code>的第一个参数必须是正则表达式，并且开启全局搜索（<code>/g</code>标记），否则仅第一个匹配项会被替换。有一种方法使用一个函数来计算替换项。</p><h2 id="十六、数学"><a href="#十六、数学" class="headerlink" title="十六、数学"></a>十六、数学</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math">Math</a>是一个有算数功能的对象。例如：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 3^2 = 9</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">//5</span>Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">1.9</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span>  <span class="token comment">// 预定义常量π，-1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="十七、标准库的其他功能"><a href="#十七、标准库的其他功能" class="headerlink" title="十七、标准库的其他功能"></a>十七、标准库的其他功能</h2><p><code>JavaScript</code>标准库相对简单，但有很多其他东西你可以使用：</p><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date">Date</a>：日期构造函数，主要功能有转换和创建日期字符串，访问日期组成部分（年，小时等）。<br><a href="http://www.2ality.com/2011/08/json-api.html">JSON</a>：一个对象，功能是转换和生成<code>JSON</code>数据。<br><a href="https://developer.mozilla.org/en-US/docs/Web/API/console">console.*</a>方法：浏览器的具体方法，不是语言成分的部分，但他们也可以在<a href="https://nodejs.org/">Node.js</a>中工作。</p><h2 id="十八、下一步学什么？"><a href="#十八、下一步学什么？" class="headerlink" title="十八、下一步学什么？"></a>十八、下一步学什么？</h2><p>在你学会了这篇文章的基础教程后，你可以转到大部分章节末尾提到的高级教程。此外，我建议你看下面的资源：</p><ul><li>Style guides: I have written <a href="http://www.2ality.com/2013/07/meta-style-guide.html">a guide to style guides</a></li><li><a href="http://underscorejs.org/">Underscore.js</a>: 一个弥补JavaScript标准库缺少的功能的库</li><li><a href="http://jsbooks.revolunet.com/">JSbooks – free JavaScript books</a></li><li><a href="http://uptodate.frontendrescue.org/">Frontend rescue: how to keep up to date on frontend technologies</a></li><li><a href="http://yanhaijing.com/">http://yanhaijing.com</a> 当然还有我的博客也非常不错哦</li><li><a href="http://yanhaijing.com/es5">http://yanhaijing.com/es5</a> 如果你想成为高手，我建议阅读<code>ecmascript</code>规范</li><li><a href="http://yanhaijing.com/javascript/2013/12/11/24-JavaScript-best-practices-for-beginners">给javascript初学者的24条最佳实践</a></li><li><a href="http://yanhaijing.com/javascript/2014/04/23/seven-javascript-quirks-i-wish-id-known-about">我希望我知道的七个JavaScript技巧</a></li></ul><p>参考自原文：<a href="http://www.2ality.com/2013/06/basic-javascript.html">http://www.2ality.com/2013/06/basic-javascript.html</a><br>参考自译文：<a href="http://yanhaijing.com/basejs/">http://yanhaijing.com/basejs/</a></p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
