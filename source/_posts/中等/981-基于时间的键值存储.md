---
title: 981-åŸºäºæ—¶é—´çš„é”®å€¼å­˜å‚¨(Time Based Key-Value Store)
date: 2021-12-03 22:27:36
categories:
  - ä¸­ç­‰
tags:
  - è®¾è®¡
  - å“ˆå¸Œè¡¨
  - å­—ç¬¦ä¸²
  - äºŒåˆ†æŸ¥æ‰¾
---

> åŸæ–‡é“¾æ¥: https://leetcode-cn.com/problems/time-based-key-value-store


## è‹±æ–‡åŸæ–‡
<div><p>Design a time-based key-value data structure that can store multiple values for the same key at different time stamps and retrieve the key&#39;s value at a certain timestamp.</p>

<p>Implement the <code>TimeMap</code> class:</p>

<ul>
	<li><code>TimeMap()</code> Initializes the object of the data structure.</li>
	<li><code>void set(String key, String value, int timestamp)</code> Stores the key <code>key</code> with the value <code>value </code>at the given time <code>timestamp</code>.</li>
	<li><code>String get(String key, int timestamp)</code> Returns a value such that <code>set</code> was called previously, with <code>timestamp_prev &lt;= timestamp</code>. If there are multiple such values, it returns the value associated with the largest <code>timestamp_prev</code>. If there are no values, it returns <code>&quot;&quot;</code>.</li>
</ul>

<p>&nbsp;</p>
<p><strong>Example 1:</strong></p>

<pre>
<strong>Input</strong>
[&quot;TimeMap&quot;, &quot;set&quot;, &quot;get&quot;, &quot;get&quot;, &quot;set&quot;, &quot;get&quot;, &quot;get&quot;]
[[], [&quot;foo&quot;, &quot;bar&quot;, 1], [&quot;foo&quot;, 1], [&quot;foo&quot;, 3], [&quot;foo&quot;, &quot;bar2&quot;, 4], [&quot;foo&quot;, 4], [&quot;foo&quot;, 5]]
<strong>Output</strong>
[null, null, &quot;bar&quot;, &quot;bar&quot;, null, &quot;bar2&quot;, &quot;bar2&quot;]

<strong>Explanation</strong>
TimeMap timeMap = new TimeMap();
timeMap.set(&quot;foo&quot;, &quot;bar&quot;, 1);  // store the key &quot;foo&quot; and value &quot;bar&quot; along with timestamp = 1.
timeMap.get(&quot;foo&quot;, 1);         // return &quot;bar&quot;
timeMap.get(&quot;foo&quot;, 3);         // return &quot;bar&quot;, since there is no value corresponding to foo at timestamp 3 and timestamp 2, then the only value is at timestamp 1 is &quot;bar&quot;.
timeMap.set(&quot;foo&quot;, &quot;bar2&quot;, 4); // store the key &quot;foo&quot; and value &quot;bar2&quot; along with timestamp = 4.
timeMap.get(&quot;foo&quot;, 4);         // return &quot;bar2&quot;
timeMap.get(&quot;foo&quot;, 5);         // return &quot;bar2&quot;
</pre>

<p>&nbsp;</p>
<p><strong>Constraints:</strong></p>

<ul>
	<li><code>1 &lt;= key.length, value.length &lt;= 100</code></li>
	<li><code>key</code> and <code>value</code> consist of lowercase English letters and digits.</li>
	<li><code>1 &lt;= timestamp &lt;= 10<sup>7</sup></code></li>
	<li>All the timestamps <code>timestamp</code> of <code>set</code> are strictly increasing.</li>
	<li>At most <code>2 * 10<sup>5</sup></code> calls will be made to <code>set</code> and <code>get</code>.</li>
</ul>
</div>

## ä¸­æ–‡é¢˜ç›®
<div><p>è®¾è®¡ä¸€ä¸ªåŸºäºæ—¶é—´çš„é”®å€¼æ•°æ®ç»“æ„ï¼Œè¯¥ç»“æ„å¯ä»¥åœ¨ä¸åŒæ—¶é—´æˆ³å­˜å‚¨å¯¹åº”åŒä¸€ä¸ªé”®çš„å¤šä¸ªå€¼ï¼Œå¹¶é’ˆå¯¹ç‰¹å®šæ—¶é—´æˆ³æ£€ç´¢é”®å¯¹åº”çš„å€¼ã€‚</p>

<p>å®ç° <code>TimeMap</code> ç±»ï¼š</p>

<ul>
	<li><code>TimeMap()</code> åˆå§‹åŒ–æ•°æ®ç»“æ„å¯¹è±¡</li>
	<li><code>void set(String key, String value, int timestamp)</code> å­˜å‚¨é”®Â <code>key</code>ã€å€¼Â <code>value</code>ï¼Œä»¥åŠç»™å®šçš„æ—¶é—´æˆ³Â <code>timestamp</code>ã€‚</li>
	<li><code>String get(String key, int timestamp)</code>
	<ul>
		<li>è¿”å›å…ˆå‰è°ƒç”¨Â <code>set(key, value, timestamp_prev)</code>Â æ‰€å­˜å‚¨çš„å€¼ï¼Œå…¶ä¸­Â <code>timestamp_prev <= timestamp</code> ã€‚</li>
		<li>å¦‚æœæœ‰å¤šä¸ªè¿™æ ·çš„å€¼ï¼Œåˆ™è¿”å›å¯¹åº”æœ€å¤§çš„Â Â <code>timestamp_prev</code>Â çš„é‚£ä¸ªå€¼ã€‚</li>
		<li>å¦‚æœæ²¡æœ‰å€¼ï¼Œåˆ™è¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆ<code>""</code>ï¼‰ã€‚</li>
	</ul>
	</li>
</ul>
Â 

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<pre>
<strong>è¾“å…¥ï¼š</strong>
["TimeMap", "set", "get", "get", "set", "get", "get"]
[[], ["foo", "bar", 1], ["foo", 1], ["foo", 3], ["foo", "bar2", 4], ["foo", 4], ["foo", 5]]
<strong>è¾“å‡ºï¼š</strong>
[null, null, "bar", "bar", null, "bar2", "bar2"]

<strong>è§£é‡Šï¼š</strong>
TimeMap timeMap = new TimeMap();
timeMap.set("foo", "bar", 1);  // å­˜å‚¨é”® "foo" å’Œå€¼ "bar" ï¼Œæ—¶é—´æˆ³ timestamp = 1 Â  
timeMap.get("foo", 1);         // è¿”å› "bar"
timeMap.get("foo", 3);         // è¿”å› "bar", å› ä¸ºåœ¨æ—¶é—´æˆ³ 3 å’Œæ—¶é—´æˆ³ 2 å¤„æ²¡æœ‰å¯¹åº” "foo" çš„å€¼ï¼Œæ‰€ä»¥å”¯ä¸€çš„å€¼ä½äºæ—¶é—´æˆ³ 1 å¤„ï¼ˆå³ "bar"ï¼‰ ã€‚
timeMap.set("foo", "bar2", 4); // å­˜å‚¨é”® "foo" å’Œå€¼ "bar2" ï¼Œæ—¶é—´æˆ³ timestamp = 4Â  
timeMap.get("foo", 4);         // è¿”å› "bar2"
timeMap.get("foo", 5);         // è¿”å› "bar2"
</pre>

<p>Â </p>

<p><strong>æç¤ºï¼š</strong></p>

<ul>
	<li><code>1 <= key.length, value.length <= 100</code></li>
	<li><code>key</code> å’Œ <code>value</code> ç”±å°å†™è‹±æ–‡å­—æ¯å’Œæ•°å­—ç»„æˆ</li>
	<li><code>1 <= timestamp <= 10<sup>7</sup></code></li>
	<li><code>set</code> æ“ä½œä¸­çš„æ—¶é—´æˆ³ <code>timestamp</code> éƒ½æ˜¯ä¸¥æ ¼é€’å¢çš„</li>
	<li>æœ€å¤šè°ƒç”¨Â <code>set</code> å’Œ <code>get</code> æ“ä½œ <code>2 * 10<sup>5</sup></code> æ¬¡</li>
</ul>
</div>

## é€šè¿‡ä»£ç 
<RecoDemo>
</RecoDemo>


## é«˜èµé¢˜è§£
## å“ˆå¸Œè¡¨å¥—æ•°ç»„

ç”±äº `timestamp` æ˜¯ä¸¥æ ¼é€’å¢ï¼Œä¸”æ²¡æœ‰åˆ é™¤ KV çš„æ“ä½œã€‚

**æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å“ˆå¸Œè¡¨å¥—æ•°ç»„çš„æ–¹å¼è¿›è¡Œå®ç°ï¼Œä»è€Œè¾¾åˆ°å‡æ‘Š $O(1)$ çš„æ’å…¥æ“ä½œå’Œ $O(\log{n})$ çš„æŸ¥è¯¢æ“ä½œã€‚**

å…·ä½“çš„ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå»ºä¸€ä¸ª `Node` ç±»ï¼Œç±»ä¸­åŒ…å«é”®å€¼å¯¹å’Œæ—¶é—´æˆ³ä¿¡æ¯ã€‚

ç„¶åä½¿ç”¨ä¸€ä¸ªå…¨å±€å“ˆå¸Œè¡¨ `map` è®°å½•æŸä¸ª `key` å¯¹åº”äº†å“ªäº› `Node`ã€‚å…¶ä¸­å¤šä¸ª `Node` æ˜¯ä»¥åŠ¨æ€æ•°ç»„çš„å½¢å¼è¿›è¡Œã€Œä»¥ `timestamp` å‡åºã€å­˜å‚¨ï¼š

* `set` æ“ä½œï¼šä»¥ $O(1)$ çš„å¤æ‚åº¦æ‰¾åˆ°æŸä¸ª `key` å¯¹åº”çš„æ•°ç»„ï¼Œåˆ©ç”¨ `timestamp` ä¸¥æ ¼é€’å¢çš„ç‰¹æ€§ï¼Œä»¥ $O(1)$ å¤æ‚åº¦å°†æ–° `Node` åŠ å…¥å½“å‰æ•°ç»„å°¾éƒ¨ï¼›
* `get` æ“ä½œï¼šä»¥ $O(1)$ çš„å¤æ‚åº¦æ‰¾åˆ°æŸä¸ª `key` å¯¹åº”çš„æ•°ç»„ï¼Œåˆ©ç”¨ `timestamp` ä¸¥æ ¼é€’å¢çš„ç‰¹æ€§ï¼Œé€šè¿‡äºŒåˆ†ä»¥ $O(\log{n})$ å¤æ‚åº¦æ‰¾åˆ°å¯èƒ½ç¬¦åˆæ¡ä»¶çš„ `Node`ã€‚

ä»£ç ï¼š
```Java []
class TimeMap {
    class Node {
        String k, v; 
        int t;
        Node (String _k, String _v, int _t) {
            k = _k; v = _v; t = _t;
        }
    }
    
    Map<String, List<Node>> map = new HashMap<>();
    public void set(String k, String v, int t) {
        List<Node> list = map.getOrDefault(k, new ArrayList<>());
        list.add(new Node(k, v, t));
        map.put(k, list);
    }
    
    public String get(String k, int t) {
        List<Node> list = map.getOrDefault(k, new ArrayList<>());
        if (list.isEmpty()) return "";
        int n = list.size();
        int l = 0, r = n - 1;
        while (l < r) {
            int mid = l + r + 1 >> 1;
            if (list.get(mid).t <= t) {
                l = mid;
            } else {
                r = mid - 1;
            }
        }
        return list.get(r).t <= t ? list.get(r).v : "";
    }
}
```
* æ—¶é—´å¤æ‚åº¦ï¼š`set` æ“ä½œçš„å¤æ‚åº¦ä¸º $O(1)$ï¼›`get` æ“ä½œçš„å¤æ‚åº¦ä¸º $O(\log{n})$
* ç©ºé—´å¤æ‚åº¦ï¼š$O(n)$

---

## å“ˆå¸Œè¡¨å¥—æ ‘

å¦‚æœå¢åŠ  `del` æ“ä½œå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦åšå‡ºä½•ç§è°ƒæ•´ï¼Ÿ

è€ƒè™‘åœ¨åŸé¢˜çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ª `String del(String k, int t)` çš„åŠŸèƒ½ï¼šå°†ä¸¥æ ¼ç­‰äºé”®å’Œæ—¶é—´æˆ³çš„ KV å¯¹åˆ æ‰ã€‚

**ç”±äºå­˜åœ¨åˆ é™¤ KV çš„åŠ¨ä½œï¼Œæˆ‘ä»¬éœ€è¦å°†å®ç°ä»ã€Œå“ˆå¸Œè¡¨å¥—æ•°ç»„ã€æ”¹æˆã€Œå“ˆå¸Œè¡¨å¥—æ ‘ã€ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨åŸºäºçº¢é»‘æ ‘å®ç°çš„ `TreeMap` å³å¯ã€‚**

åŒæ—¶ä¸ºäº†éªŒè¯åˆ é™¤é€»è¾‘çš„æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬åœ¨ `get` åŠ¨ä½œå‘ç”Ÿå‰ï¼Œå…ˆäº§ç”Ÿä¸€æ¬¡éšæœºæ€§çš„åˆ é™¤ï¼Œåˆ é™¤ååˆé‡æ–°æ’å…¥ã€‚


ä»£ç ï¼š
```Java []
class TimeMap {
    class Node {
        String k, v;
        int t;
        Node (String _k, String _v, int _t) {
            k = _k; v = _v; t = _t;
        }
    }

    Map<String, TreeMap<Integer, Node>> map = new HashMap<>();
    public void set(String k, String v, int t) {
        update(k, t);
        TreeMap<Integer, Node> ts = map.getOrDefault(k, new TreeMap<Integer, Node>());
        ts.put(t, new Node(k, v, t));
        map.put(k, ts);
    }

    Node _get(String k, int t) {
        TreeMap<Integer, Node> ts = map.get(k);
        if (ts == null) return null;
        Map.Entry<Integer, Node> entry = ts.floorEntry(t);
        if (entry == null) return null;
        Node node = entry.getValue();
        return node;
    }

    public String get(String k, int t) {
        randomDel();
        Node node = _get(k, t);
        return node != null && node.t <= t ? node.v : "";
    }

    public String del(String k, int t) {
        TreeMap<Integer, Node> ts = map.get(k);
        if (ts == null) return null;
        Map.Entry<Integer, Node> entry = ts.floorEntry(t);
        if (entry == null) return null;
        Node node = entry.getValue();
        if (node != null && node.t == t) {
            ts.remove(t);
            return node.v;
        }
        return "";
    }

    List<String> allInfo = new ArrayList<>(); 
    Random random = new Random();
    // ä¿å­˜æ‰€æœ‰çš„ kt ä¿¡æ¯
    void update(String k, int t) {
        String nk = k + "_" + t;
        allInfo.add(nk);
    } 
    // éšæœºåˆ é™¤ï¼Œå†é‡æ–°æ’å…¥ï¼ŒéªŒè¯ä»£ç æ­£ç¡®æ€§
    void randomDel() {
        int idx = random.nextInt(allInfo.size());
        String[] ss = allInfo.get(idx).split("_");
        String k = ss[0];
        int t = Integer.parseInt(ss[1]);
        Node node = _get(k, t);
        del(node.k, node.t);
        set(node.k, node.v, node.t);
    }
}
```
* æ—¶é—´å¤æ‚åº¦ï¼š`set` æ“ä½œçš„å¤æ‚åº¦ä¸º $O(\log{n})$ï¼›`get` æ“ä½œä¼šå®Œæˆéšæœºåˆ é™¤/é‡æ–°æ’å…¥/æŸ¥è¯¢çš„åŠ¨ä½œï¼Œå¤æ‚åº¦å‡ä¸ºä¸º $O(\log{n})$ï¼Œæ•´ä¸ª `get` çš„å¤æ‚åº¦ä»æ˜¯ $O(\log{n})$ï¼ˆåªæ˜¯å¸¸æ•°å˜å¤§äº†ï¼‰
* ç©ºé—´å¤æ‚åº¦ï¼š$O(n)$

---

## æœ€å

å¦‚æœæŠŠè§£æ³•äºŒä¸­çš„ `randomDel` å»æ‰ï¼Œåœ¨è°ƒç”¨æ¬¡æ•°ä¸º `120000` çš„æ•°é‡çº§ä¸‹ï¼Œä¸¤ç§å®ç°æ•ˆç‡ç›¸å·®ä¸å¤§ï¼Œè€Œè§£æ³•äºŒè¿˜æ”¯æŒäº†åˆ é™¤æ“ä½œã€‚

åƒè¿™æ ·çš„ **æ¶‰åŠæ•°æ®ç»“æ„è¿ç”¨** çš„ **è®¾è®¡ç±»** é¢˜ç›®æ˜¯ä¸æ˜¯å¾ˆæœ‰æ„æ€ï¼Ÿ

æ­¤ç±»é¢˜ç›®æœ¬èº«ä¸è€ƒå¯Ÿå®é™…çš„ç®—æ³•ï¼Œæ›´å¤šçš„è€ƒå¯Ÿé€‰æ‰‹çš„ã€Œå¯¹å„ç§æ•°æ®ç»“æ„å¯¹åº”æ“ä½œçš„å¤æ‚åº¦è®¤è¯†ã€ã€ã€Œè®¾è®¡èƒ½åŠ›ã€å’Œã€Œç¼–ç èƒ½åŠ›ã€ã€‚

**æ›´å¤šä¸æ­¤ç±»é¢˜ç›®ç›¸å…³çš„è®²è§£ä¼šåœ¨ LeetBook [ã€Šè®¾è®¡æ•°æ®ç»“æ„ã€‹](https://leetcode-cn.com/leetbook/detail/designing-data-structures/) å‘ˆç°ï¼Œæœ¬ LeetBook å°†ä¼šå’Œå¤§å®¶å°† LC ä¸Šæ‰€æœ‰ä¸ã€Œè®¾è®¡ã€ç›¸å…³çš„é¢˜ç›®éƒ½å®ç°ä¸€éï¼Œç”±æµ…å…¥æ·±ï¼Œä»çƒ­é—¨åˆ°å¸¸è§„ã€‚æ¬¢è¿è·å–å‘€ ~ ğŸ­ğŸ­ğŸ­**

## ç»Ÿè®¡ä¿¡æ¯
| é€šè¿‡æ¬¡æ•° | æäº¤æ¬¡æ•° | ACæ¯”ç‡ |
| :------: | :------: | :------: |
|    21863    |    41206    |   53.1%   |

## æäº¤å†å²
| æäº¤æ—¶é—´ | æäº¤ç»“æœ | æ‰§è¡Œæ—¶é—´ |  å†…å­˜æ¶ˆè€—  | è¯­è¨€ |
| :------: | :------: | :------: | :--------: | :--------: |
